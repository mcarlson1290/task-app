# Replit Instructions: Fix Task Generation and Storage

**IMPORTANT: Do not delete any existing tasks, recurring tasks, or user data. Only update the code functionality while preserving all existing data.**

## Core Issue
Tasks are only appearing on their due date because they're not being generated and saved to the database when they should be visible. We need to generate and store tasks at the right time.

## Solution: Generate and Store Tasks Properly

### 1. Create a Task Generation Service

```javascript
// This should run daily or when recurring tasks are created/edited
const generateUpcomingTasks = async () => {
  const recurringTasks = await getRecurringTasks();
  const today = new Date();
  today.setHours(0, 0, 0, 0); // Start of today
  
  for (const recurringTask of recurringTasks) {
    if (recurringTask.frequency === 'monthly') {
      await generateMonthlyTask(recurringTask, today);
    } else if (recurringTask.frequency === 'bi-weekly') {
      await generateBiWeeklyTasks(recurringTask, today);
    } else if (recurringTask.frequency === 'daily') {
      await generateDailyTasks(recurringTask, today);
    }
  }
};

// Generate monthly task if we're on the 1st
const generateMonthlyTask = async (recurringTask, today) => {
  const dayOfMonth = today.getDate();
  
  // Only generate on the 1st of the month
  if (dayOfMonth === 1) {
    const existingTask = await findTaskByRecurringId(
      recurringTask.id, 
      today.getFullYear(), 
      today.getMonth()
    );
    
    // Don't create duplicate
    if (!existingTask) {
      const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
      
      const newTask = {
        title: recurringTask.title,
        description: recurringTask.description,
        type: recurringTask.type,
        priority: recurringTask.priority,
        estimatedMinutes: recurringTask.estimatedMinutes,
        checklist: recurringTask.checklist,
        
        // Key dates
        createdDate: today,
        visibleFromDate: today, // Visible starting today (the 1st)
        dueDate: lastDay,       // Due on last day of month
        
        // Recurring info
        recurringTaskId: recurringTask.id,
        frequency: 'monthly',
        
        // Status
        status: 'pending',
        
        // Unique ID including year/month
        id: `${recurringTask.id}-${today.getFullYear()}-${today.getMonth()}`
      };
      
      await saveTask(newTask);
      console.log(`Generated monthly task: ${newTask.title} - Due: ${lastDay.toDateString()}`);
    }
  }
};

// Generate bi-weekly tasks if we're on the 1st or 15th
const generateBiWeeklyTasks = async (recurringTask, today) => {
  const dayOfMonth = today.getDate();
  const year = today.getFullYear();
  const month = today.getMonth();
  
  // First half - generate on the 1st
  if (dayOfMonth === 1) {
    const existingTask = await findTaskByRecurringId(
      recurringTask.id, 
      year, 
      month,
      'first-half'
    );
    
    if (!existingTask) {
      const newTask = {
        title: recurringTask.title,
        description: recurringTask.description,
        type: recurringTask.type,
        priority: recurringTask.priority,
        estimatedMinutes: recurringTask.estimatedMinutes,
        checklist: recurringTask.checklist,
        
        // Key dates
        createdDate: today,
        visibleFromDate: today,                    // Visible from 1st
        dueDate: new Date(year, month, 14),       // Due on 14th
        
        // Recurring info
        recurringTaskId: recurringTask.id,
        frequency: 'bi-weekly',
        period: 'first-half',
        
        // Status
        status: 'pending',
        
        // Unique ID
        id: `${recurringTask.id}-${year}-${month}-1`
      };
      
      await saveTask(newTask);
      console.log(`Generated bi-weekly task (1st half): ${newTask.title}`);
    }
  }
  
  // Second half - generate on the 15th
  if (dayOfMonth === 15) {
    const existingTask = await findTaskByRecurringId(
      recurringTask.id, 
      year, 
      month,
      'second-half'
    );
    
    if (!existingTask) {
      const lastDay = new Date(year, month + 1, 0);
      
      const newTask = {
        title: recurringTask.title,
        description: recurringTask.description,
        type: recurringTask.type,
        priority: recurringTask.priority,
        estimatedMinutes: recurringTask.estimatedMinutes,
        checklist: recurringTask.checklist,
        
        // Key dates
        createdDate: today,
        visibleFromDate: today,           // Visible from 15th
        dueDate: lastDay,                 // Due on last day
        
        // Recurring info
        recurringTaskId: recurringTask.id,
        frequency: 'bi-weekly',
        period: 'second-half',
        
        // Status
        status: 'pending',
        
        // Unique ID
        id: `${recurringTask.id}-${year}-${month}-2`
      };
      
      await saveTask(newTask);
      console.log(`Generated bi-weekly task (2nd half): ${newTask.title}`);
    }
  }
};
```

### 2. Update Task Display to Use visibleFromDate

```javascript
// In the task manager, filter tasks based on visibility
const TaskManager = () => {
  const [tasks, setTasks] = useState([]);
  const [viewDate, setViewDate] = useState(new Date());
  
  // Load all tasks, then filter by visibility
  useEffect(() => {
    const loadTasks = async () => {
      const allTasks = await getTasks();
      
      // Filter tasks that should be visible on the view date
      const visibleTasks = allTasks.filter(task => {
        // If task has visibleFromDate, use it
        if (task.visibleFromDate) {
          const visibleFrom = new Date(task.visibleFromDate);
          return viewDate >= visibleFrom;
        }
        
        // Otherwise, task is always visible
        return true;
      });
      
      setTasks(visibleTasks);
    };
    
    loadTasks();
  }, [viewDate]);
  
  return (
    <div>
      {/* Date picker for testing */}
      <input 
        type="date" 
        value={viewDate.toISOString().split('T')[0]}
        onChange={(e) => setViewDate(new Date(e.target.value))}
      />
      
      {/* Show tasks */}
      {tasks.map(task => (
        <TaskCard key={task.id} task={task} />
      ))}
    </div>
  );
};
```

### 3. Set Up Daily Task Generation

```javascript
// Run this on app startup and daily
const initializeTaskGeneration = () => {
  // Generate tasks for today immediately
  generateUpcomingTasks();
  
  // Set up daily generation at midnight
  const scheduleNextGeneration = () => {
    const now = new Date();
    const tomorrow = new Date(now);
    tomorrow.setDate(tomorrow.getDate() + 1);
    tomorrow.setHours(0, 0, 1, 0); // 1 second after midnight
    
    const msUntilMidnight = tomorrow - now;
    
    setTimeout(() => {
      generateUpcomingTasks();
      // Schedule next day
      setInterval(generateUpcomingTasks, 24 * 60 * 60 * 1000);
    }, msUntilMidnight);
  };
  
  scheduleNextGeneration();
};

// Call this when app starts
initializeTaskGeneration();
```

### 4. Manual Trigger for Testing

Add a button to manually trigger task generation for testing:

```javascript
const AdminPanel = () => {
  const handleGenerateTasks = async () => {
    await generateUpcomingTasks();
    alert('Task generation complete! Refresh to see new tasks.');
  };
  
  return (
    <button onClick={handleGenerateTasks}>
      Generate Today's Tasks (Testing)
    </button>
  );
};
```

### 5. Update Task Data Structure

Ensure your task model includes these fields:

```javascript
const taskSchema = {
  id: String,
  title: String,
  description: String,
  
  // Dates
  createdDate: Date,      // When task was generated
  visibleFromDate: Date,  // When task becomes visible
  dueDate: Date,          // When task is due
  completedDate: Date,    // When task was completed (if applicable)
  
  // Recurring info
  recurringTaskId: String,
  frequency: String,      // 'daily', 'weekly', 'bi-weekly', 'monthly'
  period: String,         // For bi-weekly: 'first-half' or 'second-half'
  
  // Other fields...
};
```

## Testing Steps:

1. Create a monthly recurring task
2. Click "Generate Today's Tasks" button
3. If today is the 1st, a task should be created with:
   - visibleFromDate: today
   - dueDate: last day of month
4. Change the view date to any day in the month - task should be visible
5. The task should remain visible until completed or past due

## Key Points:
- Tasks are GENERATED and SAVED on specific days (1st, 15th)
- Tasks have a `visibleFromDate` that controls when they appear
- The task manager filters tasks based on the current/selected date
- Monthly tasks: generated on 1st, visible 1st-31st
- Bi-weekly: generated on 1st/15th, visible for their respective periods