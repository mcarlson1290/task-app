# ðŸ“‹ Add Assignment Feature to Recurring Tasks

## 1. UPDATE RECURRING TASK DATA STRUCTURE

First, update your recurring task model to include assignment field:

```javascript
// In your backend where recurring tasks are created/stored
const recurringTaskSchema = {
  id: Number,
  title: String,
  description: String,
  taskType: String,
  frequency: String,
  assignTo: String, // NEW FIELD - stores assignment like "role_Microgreens Seeder" or "user_123"
  // ... other existing fields
};
```

## 2. UPDATE THE EDIT RECURRING TASK MODAL

Find your Edit Recurring Task modal and add the assignment dropdown:

```javascript
// In your EditRecurringTaskModal component
// Add this right after the imports
import { useState, useEffect } from 'react';

// Inside the EditRecurringTaskModal component, add these state variables
const [assignmentOptions, setAssignmentOptions] = useState({
  roles: [],
  users: [],
  special: []
});

const [loadingAssignments, setLoadingAssignments] = useState(false);

// Add this useEffect to load assignment options when modal opens
useEffect(() => {
  loadAssignmentOptions();
}, []);

// Add this function to load staff and build assignment options
const loadAssignmentOptions = async () => {
  setLoadingAssignments(true);
  
  try {
    // Fetch staff data
    const response = await fetch('/api/staff');
    const staff = await response.json();
    
    // Filter active staff only
    const activeStaff = staff.filter(s => s.activeStatus === 'active');
    
    // Build roles with staff counts
    const rolesMap = {};
    activeStaff.forEach(member => {
      (member.rolesAssigned || []).forEach(role => {
        if (!rolesMap[role]) {
          rolesMap[role] = [];
        }
        rolesMap[role].push(member);
      });
    });
    
    // Format options
    const options = {
      special: [{
        value: 'all_staff',
        label: 'ðŸ‘¥ All Staff',
        staffCount: activeStaff.length
      }],
      roles: Object.entries(rolesMap).map(([role, members]) => ({
        value: `role_${role}`,
        label: `ðŸ‘¤ ${role}`,
        staffCount: members.length
      })),
      users: activeStaff.map(member => ({
        value: `user_${member.id}`,
        label: member.fullName,
        roles: member.rolesAssigned
      }))
    };
    
    setAssignmentOptions(options);
  } catch (error) {
    console.error('Error loading assignment options:', error);
  }
  
  setLoadingAssignments(false);
};
```

## 3. ADD THE ASSIGNMENT DROPDOWN TO THE FORM

In the same modal, find where the form fields are (after Description, before the buttons) and add:

```javascript
// Add this new form field in the Edit Recurring Task modal
<div className="form-group">
  <label>Default Assignment</label>
  <select
    value={formData.assignTo || ''}
    onChange={(e) => setFormData({ ...formData, assignTo: e.target.value })}
    disabled={loadingAssignments}
    className="form-select"
  >
    <option value="">No default assignment</option>
    
    {/* All Staff Option */}
    {assignmentOptions.special.map(option => (
      <option key={option.value} value={option.value}>
        {option.label} ({option.staffCount} people)
      </option>
    ))}
    
    {/* Roles Section */}
    {assignmentOptions.roles.length > 0 && (
      <>
        <option disabled>â”€â”€â”€â”€â”€â”€â”€â”€ Roles â”€â”€â”€â”€â”€â”€â”€â”€</option>
        {assignmentOptions.roles.map(role => (
          <option key={role.value} value={role.value}>
            {role.label} ({role.staffCount} {role.staffCount === 1 ? 'person' : 'people'})
          </option>
        ))}
      </>
    )}
    
    {/* Individual Users Section */}
    {assignmentOptions.users.length > 0 && (
      <>
        <option disabled>â”€â”€â”€â”€â”€â”€â”€â”€ People â”€â”€â”€â”€â”€â”€â”€â”€</option>
        {assignmentOptions.users.map(user => (
          <option key={user.value} value={user.value}>
            {user.label} {user.roles.length > 0 && `- ${user.roles.join(', ')}`}
          </option>
        ))}
      </>
    )}
  </select>
  
  <small className="help-text">
    When this recurring task generates daily tasks, they will be automatically assigned to this selection
  </small>
</div>
```

## 4. UPDATE THE RECURRING TASK LIST DISPLAY

In your recurring tasks list, show the assignment:

```javascript
// In the recurring task card/list item, add assignment display
const getAssignmentDisplay = (assignTo) => {
  if (!assignTo) return 'Unassigned';
  
  if (assignTo === 'all_staff') return 'ðŸ‘¥ All Staff';
  
  if (assignTo.startsWith('role_')) {
    const roleName = assignTo.replace('role_', '');
    return `ðŸ‘¤ ${roleName}`;
  }
  
  if (assignTo.startsWith('user_')) {
    // You'll need to look up the user name from your staff list
    const userId = assignTo.replace('user_', '');
    const user = staff.find(s => s.id == userId);
    return user ? user.fullName : 'Unknown User';
  }
  
  return assignTo;
};

// In your recurring task display component
<div className="recurring-task-card">
  <h3>{task.title}</h3>
  <div className="task-details">
    <span className="task-type">{task.taskType}</span>
    <span className="frequency">{task.frequency}</span>
    <span className="assignment">
      Assigned to: {getAssignmentDisplay(task.assignTo)}
    </span>
  </div>
  {/* Rest of your task display */}
</div>
```

## 5. UPDATE BACKEND TO SAVE ASSIGNMENT

Update your recurring task save endpoint:

```javascript
// In your backend API endpoint for updating recurring tasks
app.put('/api/recurring-tasks/:id', async (req, res) => {
  const taskId = req.params.id;
  const updates = req.body;
  
  // Load existing recurring tasks
  let recurringTasks = await readData('recurring-tasks.json');
  
  // Find and update the task
  const taskIndex = recurringTasks.findIndex(t => t.id == taskId);
  if (taskIndex === -1) {
    return res.status(404).json({ error: 'Task not found' });
  }
  
  // Update the task including the new assignTo field
  recurringTasks[taskIndex] = {
    ...recurringTasks[taskIndex],
    ...updates,
    assignTo: updates.assignTo || null, // Make sure to include assignTo
    updatedAt: new Date().toISOString()
  };
  
  // Save back to file
  await saveData('recurring-tasks.json', recurringTasks);
  
  res.json(recurringTasks[taskIndex]);
});
```

## 6. UPDATE TASK GENERATION TO USE ASSIGNMENT

When recurring tasks generate daily tasks, include the assignment:

```javascript
// In your task generation function
const generateTaskFromRecurring = (recurringTask) => {
  const newTask = {
    id: Date.now(),
    title: recurringTask.title,
    description: recurringTask.description,
    taskType: recurringTask.taskType,
    assignTo: recurringTask.assignTo || '', // Include the assignment
    dueDate: new Date().toISOString().split('T')[0],
    status: 'pending',
    createdFrom: recurringTask.id,
    // ... other task fields
  };
  
  return newTask;
};
```

## 7. ADD STYLES FOR ASSIGNMENT DISPLAY

Add these CSS styles:

```css
/* Assignment field in form */
.form-group label {
  display: block;
  margin-bottom: 8px;
  font-weight: 500;
  color: #374151;
}

.form-select {
  width: 100%;
  padding: 10px;
  border: 1px solid #e5e7eb;
  border-radius: 6px;
  font-size: 14px;
  background: white;
}

.form-select option:disabled {
  color: #9ca3af;
  font-size: 12px;
  text-align: center;
}

.help-text {
  display: block;
  margin-top: 6px;
  color: #6b7280;
  font-size: 12px;
  line-height: 1.5;
}

/* Assignment display in task list */
.assignment {
  display: inline-flex;
  align-items: center;
  padding: 4px 12px;
  background: #f3f4f6;
  border-radius: 12px;
  font-size: 12px;
  color: #4b5563;
  gap: 4px;
}

.recurring-task-card {
  background: white;
  padding: 16px;
  border-radius: 8px;
  margin-bottom: 12px;
  border: 1px solid #e5e7eb;
}

.task-details {
  display: flex;
  gap: 12px;
  margin-top: 8px;
  flex-wrap: wrap;
}

.task-details span {
  padding: 4px 8px;
  background: #f9fafb;
  border-radius: 4px;
  font-size: 12px;
}
```

## Testing Steps

1. **Open a recurring task for editing** - The assignment dropdown should appear
2. **Select an assignment** - Try "All Staff", a role, or a specific person
3. **Save the task** - The assignment should persist
4. **Check the list view** - Assignment should display on each recurring task
5. **Generate daily tasks** - Verify new tasks have the correct assignment

## Troubleshooting

If the dropdown is empty:
- Check console for errors when loading staff
- Verify `/api/staff` endpoint returns data
- Make sure staff have roles assigned

If assignments aren't saving:
- Check the recurring task update endpoint includes `assignTo` field
- Verify the form is sending the field in the request
- Check browser network tab for the API request payload