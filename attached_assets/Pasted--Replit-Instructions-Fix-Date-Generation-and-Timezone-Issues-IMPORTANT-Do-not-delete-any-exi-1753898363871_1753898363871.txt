# Replit Instructions: Fix Date Generation and Timezone Issues

**IMPORTANT: Do not delete any existing tasks, recurring tasks, or user data. Only update the code functionality while preserving all existing data.**

## Issues to Fix:
1. Monthly task on August 1st showing due date of July 31st (wrong month)
2. Dates need to respect local timezone (Chicago/device time)
3. Tasks not appearing on the 1st when they should

## Solution: Fix Date Calculations and Timezone Handling

### 1. Fix Month Calculation for Last Day

```javascript
// WRONG - This can give you the previous month's last day
const getLastDayOfMonth = (date) => {
  const nextMonth = new Date(date.getFullYear(), date.getMonth() + 1, 0);
  return nextMonth.getDate();
};

// CORRECT - Ensure we get the last day of the current month
const getLastDayOfMonth = (date) => {
  // Create a date for the 1st of next month, then subtract 1 day
  const year = date.getFullYear();
  const month = date.getMonth();
  const lastDay = new Date(year, month + 1, 0);
  return lastDay;
};

// When generating monthly tasks
const generateMonthlyTask = async (recurringTask, today) => {
  const dayOfMonth = today.getDate();
  
  if (dayOfMonth === 1) {
    // Use local date to ensure correct month
    const localToday = new Date(today.getTime() - (today.getTimezoneOffset() * 60000));
    const year = localToday.getFullYear();
    const month = localToday.getMonth();
    
    // Get last day of THIS month, not previous month
    const lastDayDate = new Date(year, month + 1, 0);
    
    const newTask = {
      title: recurringTask.title,
      description: recurringTask.description,
      type: recurringTask.type,
      priority: recurringTask.priority,
      estimatedMinutes: recurringTask.estimatedMinutes,
      checklist: recurringTask.checklist,
      
      // Use correct dates
      createdDate: today.toISOString(),
      visibleFromDate: today.toISOString(),
      dueDate: lastDayDate.toISOString(), // This should be Aug 31 when created on Aug 1
      
      // Recurring info
      recurringTaskId: recurringTask.id,
      frequency: 'monthly',
      
      status: 'pending',
      id: `${recurringTask.id}-${year}-${month}`
    };
    
    await saveTask(newTask);
    console.log(`Generated monthly task for ${months[month]}: Due ${lastDayDate.toLocaleDateString()}`);
  }
};
```

### 2. Use Local Timezone Throughout the App

```javascript
// Utility function to get local date at start of day
const getLocalDate = (date = new Date()) => {
  const localDate = new Date(date);
  localDate.setHours(0, 0, 0, 0);
  return localDate;
};

// When checking what day it is
const generateUpcomingTasks = async () => {
  const recurringTasks = await getRecurringTasks();
  
  // Use local date for all checks
  const today = getLocalDate();
  const dayOfMonth = today.getDate();
  
  console.log(`Checking tasks for: ${today.toLocaleDateString()} (Day ${dayOfMonth})`);
  
  for (const recurringTask of recurringTasks) {
    if (recurringTask.frequency === 'monthly' && dayOfMonth === 1) {
      await generateMonthlyTask(recurringTask, today);
    } else if (recurringTask.frequency === 'bi-weekly') {
      if (dayOfMonth === 1 || dayOfMonth === 15) {
        await generateBiWeeklyTasks(recurringTask, today);
      }
    }
  }
};
```

### 3. Fix Date Display in Task Cards

```javascript
const TaskCard = ({ task }) => {
  const formatDueDate = (dueDateString) => {
    if (!dueDateString) return 'No due date';
    
    const dueDate = new Date(dueDateString);
    const today = getLocalDate();
    
    // Calculate days until due
    const msPerDay = 24 * 60 * 60 * 1000;
    const daysUntilDue = Math.floor((dueDate - today) / msPerDay);
    
    // Format the date for display
    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 
                       'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    const month = monthNames[dueDate.getMonth()];
    const day = dueDate.getDate();
    
    if (daysUntilDue < 0) {
      return `Overdue (${month} ${day})`;
    } else if (daysUntilDue === 0) {
      return `Due today (${month} ${day})`;
    } else if (daysUntilDue === 1) {
      return `Due tomorrow (${month} ${day})`;
    } else {
      return `Due in ${daysUntilDue} days (${month} ${day})`;
    }
  };
  
  return (
    <div className="task-card">
      <h3>{task.title}</h3>
      <div className="due-date">
        ðŸ“… {formatDueDate(task.dueDate)}
      </div>
    </div>
  );
};
```

### 4. Add Timezone-Aware Date Picker

```javascript
const TaskManager = () => {
  const [viewDate, setViewDate] = useState(getLocalDate());
  
  const handleDateChange = (e) => {
    // Parse the date in local timezone
    const [year, month, day] = e.target.value.split('-').map(Number);
    const newDate = new Date(year, month - 1, day);
    setViewDate(newDate);
  };
  
  // Format date for input
  const formatDateForInput = (date) => {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
  };
  
  return (
    <div>
      <div className="date-selector">
        <label>Viewing tasks for:</label>
        <input 
          type="date" 
          value={formatDateForInput(viewDate)}
          onChange={handleDateChange}
        />
        <span className="timezone-info">
          ({Intl.DateTimeFormat().resolvedOptions().timeZone})
        </span>
      </div>
    </div>
  );
};
```

### 5. Debug Logging for Task Generation

```javascript
// Add detailed logging to track what's happening
const generateMonthlyTask = async (recurringTask, today) => {
  console.log('=== Generating Monthly Task ===');
  console.log('Today:', today.toLocaleDateString());
  console.log('Today (ISO):', today.toISOString());
  console.log('Month:', today.getMonth()); // 0-11
  console.log('Year:', today.getFullYear());
  
  const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
  console.log('Last day of month:', lastDay.toLocaleDateString());
  console.log('Last day (ISO):', lastDay.toISOString());
  
  // Continue with task generation...
};
```

### 6. Force Task Regeneration (for testing)

Add a button to clear and regenerate tasks:

```javascript
const AdminControls = () => {
  const handleRegenerate = async () => {
    if (confirm('This will delete and regenerate all recurring tasks. Continue?')) {
      // Clear existing generated tasks
      await clearGeneratedTasks();
      
      // Regenerate for current month
      await generateUpcomingTasks();
      
      alert('Tasks regenerated! Refresh the page.');
    }
  };
  
  return (
    <button onClick={handleRegenerate}>
      Regenerate Tasks (Admin)
    </button>
  );
};
```

## Expected Results:
1. Task created on August 1st should be due August 31st (not July 31st)
2. Dates should display correctly in user's local timezone
3. Monthly tasks should be visible starting on the 1st
4. Date calculations should handle month boundaries correctly

## Testing:
1. Set date to August 1st
2. Generate/view monthly task
3. Should show "Due in 30 days (Aug 31)"
4. NOT "Due in 2 days (Jul 31)"