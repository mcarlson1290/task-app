# ðŸ“‹ Replit Instructions: Fix Assignment System and Green Highlighting

## Problem Summary
1. "Assigned to Me" filter eliminates all tasks instead of stacking with other filters
2. Green highlighting for assigned tasks isn't showing
3. Current user might not be properly connected to staff data

## Implementation Instructions

### 1. Create a Proper User Context System

Create `src/contexts/UserContext.js`:

```javascript
import React, { createContext, useContext, useState, useEffect } from 'react';

const UserContext = createContext();

export const useCurrentUser = () => {
  const context = useContext(UserContext);
  if (!context) {
    throw new Error('useCurrentUser must be used within UserProvider');
  }
  return context;
};

export const UserProvider = ({ children }) => {
  const [currentUser, setCurrentUser] = useState(null);
  const [loading, setLoading] = useState(true);
  
  useEffect(() => {
    loadCurrentUser();
  }, []);
  
  const loadCurrentUser = async () => {
    try {
      // Get authenticated user email from your auth system
      const authEmail = await getAuthenticatedUserEmail(); // Your auth method
      
      // Load staff data
      const staffResponse = await fetch('/api/staff');
      const staffData = await staffResponse.json();
      
      // Find user in staff by email
      const staffMember = staffData.find(s => 
        s.email?.toLowerCase() === authEmail?.toLowerCase()
      );
      
      if (staffMember) {
        setCurrentUser({
          id: staffMember.id,
          email: staffMember.email,
          fullName: staffMember.fullName,
          rolesAssigned: staffMember.rolesAssigned || []
        });
      }
    } catch (error) {
      console.error('Error loading user:', error);
    } finally {
      setLoading(false);
    }
  };
  
  return (
    <UserContext.Provider value={{ currentUser, loading }}>
      {children}
    </UserContext.Provider>
  );
};
```

### 2. Wrap App with UserProvider

In `src/App.js`:

```javascript
import { UserProvider } from './contexts/UserContext';

function App() {
  return (
    <UserProvider>
      {/* Your existing app components */}
    </UserProvider>
  );
}
```

### 3. Create Centralized Assignment Checking

Create `src/utils/taskAssignment.js`:

```javascript
export const isTaskAssignedToUser = (task, currentUser) => {
  if (!currentUser || !task.assignTo) return false;
  
  // Direct user assignment
  if (task.assignTo === `user_${currentUser.id}`) return true;
  
  // All staff assignment
  if (task.assignTo === 'all_staff') return true;
  
  // Role-based assignment
  if (task.assignTo?.startsWith('role_')) {
    const roleName = task.assignTo.replace('role_', '');
    return currentUser.rolesAssigned?.includes(roleName) || false;
  }
  
  return false;
};
```

### 4. Update TaskCard Component

```javascript
import { isTaskAssignedToUser } from '../utils/taskAssignment';

const TaskCard = ({ task }) => {
  const { currentUser } = useCurrentUser();
  
  // Check if assigned to current user
  const isMyTask = isTaskAssignedToUser(task, currentUser);
  
  return (
    <div className={`task-card ${isMyTask ? 'assigned-to-me' : ''}`}>
      {/* Task badge row */}
      <div className="task-badges-row">
        <div className="left-badges">
          <span className="day-badge">THU</span>
          <span className={`priority-badge ${task.priority.toLowerCase()}`}>
            {task.priority}
          </span>
        </div>
        {isMyTask && (
          <div className="right-badges">
            <span className="your-task-badge">ðŸ“Œ Your Task</span>
          </div>
        )}
      </div>
      
      {/* Task content */}
      <div className="task-content">
        <h3>{task.title}</h3>
        <p className="task-type">{task.taskType}</p>
        <p className="task-assignee">{getAssignmentDisplay(task.assignTo)}</p>
      </div>
      
      <button className="start-task-btn">Start Task</button>
    </div>
  );
};
```

### 5. Fix Filter Logic in TasksPage

```javascript
import { useCurrentUser } from '../contexts/UserContext';
import { isTaskAssignedToUser } from '../utils/taskAssignment';

const TasksPage = () => {
  const { currentUser, loading: userLoading } = useCurrentUser();
  const [tasks, setTasks] = useState([]);
  const [filters, setFilters] = useState({
    category: 'All',
    status: 'All',
    priority: 'All',
    assignedToMe: false,
    searchQuery: '',
    date: new Date().toISOString().split('T')[0]
  });
  
  // Filter tasks with proper stacking
  const getFilteredTasks = () => {
    const today = new Date().toISOString().split('T')[0];
    
    return tasks.filter(task => {
      // Date filter
      if (task.status === 'completed' || task.status === 'skipped') {
        const actionDate = (task.completedAt || task.skippedAt || task.dueDate).split('T')[0];
        if (actionDate !== filters.date) return false;
      } else {
        const isOverdue = task.dueDate < today && task.status === 'pending';
        if (isOverdue && filters.date === today) {
          // Show overdue on today
        } else if (task.dueDate !== filters.date) {
          return false;
        }
      }
      
      // Category filter
      if (filters.category !== 'All' && task.taskType !== filters.category) {
        return false;
      }
      
      // Status filter
      if (filters.status !== 'All' && task.status !== filters.status) {
        return false;
      }
      
      // Priority filter
      if (filters.priority !== 'All' && task.priority !== filters.priority) {
        return false;
      }
      
      // Assigned to me filter - ADD to other filters
      if (filters.assignedToMe && currentUser) {
        if (!isTaskAssignedToUser(task, currentUser)) {
          return false;
        }
      }
      
      // Search filter
      if (filters.searchQuery) {
        const query = filters.searchQuery.toLowerCase();
        const matchesSearch = 
          task.title?.toLowerCase().includes(query) ||
          task.description?.toLowerCase().includes(query);
        if (!matchesSearch) return false;
      }
      
      return true;
    });
  };
  
  const filteredTasks = getFilteredTasks();
  
  if (userLoading) return <div>Loading...</div>;
  
  return (
    <div className="tasks-page">
      {/* Your filters */}
      <ResponsiveFilterBar filters={filters} onFilterChange={updateFilter} />
      
      {/* Progress bars */}
      <GamifiedProgressBars tasks={filteredTasks} />
      
      {/* Task grid */}
      <div className="task-grid">
        {filteredTasks.map(task => (
          <TaskCard key={task.id} task={task} />
        ))}
      </div>
    </div>
  );
};
```

### 6. CSS for Green Highlighting

```css
/* Always visible assignment indicator */
.task-card.assigned-to-me {
  border-left: 4px solid #2D8028;
  background: linear-gradient(to right, rgba(45, 128, 40, 0.03) 0%, transparent 100%);
  position: relative;
}

.task-badges-row {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 12px;
}

.your-task-badge {
  background: #2D8028;
  color: white;
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 600;
}

/* Helper function for assignment display */
.task-assignee {
  font-size: 13px;
  color: #6b7280;
}
```

### 7. Helper Function for Display

```javascript
const getAssignmentDisplay = (assignTo) => {
  if (!assignTo) return 'Unassigned';
  if (assignTo === 'all_staff') return 'All Staff';
  if (assignTo.startsWith('role_')) {
    return assignTo.replace('role_', '');
  }
  if (assignTo.startsWith('user_')) {
    // You'd need to look up the user name
    return 'Assigned User';
  }
  return assignTo;
};
```

## Key Points:
- UserContext properly connects auth to staff data
- Assignment checking is centralized
- Filters stack instead of replacing each other
- Green highlighting always shows for assigned tasks
- No temporary hacks or debug code