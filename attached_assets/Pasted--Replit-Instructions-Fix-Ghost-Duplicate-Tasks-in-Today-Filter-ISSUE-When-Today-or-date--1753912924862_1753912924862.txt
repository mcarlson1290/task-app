# Replit Instructions: Fix Ghost Duplicate Tasks in Today Filter

**ISSUE: When "Today" (or date) filter is applied, tasks appear twice. One is a "ghost" that disappears when filter is cleared.**

## The Problem

The filter is likely:
1. Showing the original task
2. Creating a duplicate in memory when applying the filter
3. Or showing the same task twice due to faulty filter logic

## Step 1: Find the Filter Logic

Look for where the "Today" filter is implemented:

```javascript
// Find code that looks like this - it's probably broken
const filterTasks = (tasks, filterType) => {
  if (filterType === 'today') {
    // BAD - This might be duplicating tasks
    return tasks.filter(task => isToday(task.dueDate))
      .concat(tasks.filter(task => isToday(task.visibleFromDate))); // CREATES DUPLICATES!
  }
};
```

## Step 2: Fix the Filter to Prevent Duplicates

Replace with proper filtering that doesn't create duplicates:

```javascript
const filterTasksByDate = (tasks, filterDate) => {
  const filtered = tasks.filter(task => {
    // Skip completed tasks unless specifically viewing completed
    if (task.status === 'completed') return false;
    
    // For date filtering, check if task should be visible on this date
    if (filterDate) {
      const filterDay = new Date(filterDate);
      filterDay.setHours(0, 0, 0, 0);
      
      // Task is visible if the filter date is between visible and due dates
      if (task.visibleFromDate && task.dueDate) {
        const visibleFrom = new Date(task.visibleFromDate);
        visibleFrom.setHours(0, 0, 0, 0);
        
        const dueDate = new Date(task.dueDate);
        dueDate.setHours(23, 59, 59, 999);
        
        return filterDay >= visibleFrom && filterDay <= dueDate;
      }
      
      // For tasks without visibility dates, check if due today
      if (task.dueDate) {
        const dueDate = new Date(task.dueDate);
        dueDate.setHours(0, 0, 0, 0);
        return filterDay.getTime() === dueDate.getTime();
      }
    }
    
    return true;
  });
  
  // Remove any duplicates based on task ID
  const uniqueTasks = filtered.filter((task, index, self) =>
    index === self.findIndex(t => t.id === task.id)
  );
  
  console.log(`Filtered ${tasks.length} tasks to ${uniqueTasks.length} for date: ${filterDate}`);
  
  return uniqueTasks;
};
```

## Step 3: Fix the Today Filter Specifically

```javascript
const applyFilters = (allTasks, activeFilters) => {
  let filteredTasks = [...allTasks]; // Copy array to avoid mutations
  
  // Apply date filter
  if (activeFilters.date === 'today') {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    filteredTasks = filteredTasks.filter(task => {
      // Task should appear today if:
      // 1. It's due today, OR
      // 2. Today is within its visible range
      
      if (task.dueDate) {
        const dueDate = new Date(task.dueDate);
        dueDate.setHours(0, 0, 0, 0);
        
        // Check if due today
        if (dueDate.getTime() === today.getTime()) {
          return true;
        }
      }
      
      // Check if today is in visible range
      if (task.visibleFromDate && task.dueDate) {
        return isDateInRange(today, task.visibleFromDate, task.dueDate);
      }
      
      return false;
    });
  }
  
  // Apply other filters (status, category, etc.)
  if (activeFilters.status && activeFilters.status !== 'all') {
    filteredTasks = filteredTasks.filter(task => task.status === activeFilters.status);
  }
  
  // IMPORTANT: Ensure no duplicates
  const taskIds = new Set();
  const uniqueTasks = filteredTasks.filter(task => {
    if (taskIds.has(task.id)) {
      console.warn(`Duplicate task found and removed: ${task.id} - ${task.title}`);
      return false;
    }
    taskIds.add(task.id);
    return true;
  });
  
  return uniqueTasks;
};
```

## Step 4: Debug the Issue

Add logging to see what's happening:

```javascript
// In the component that displays tasks
const TaskList = ({ tasks, filters }) => {
  // Log to debug
  useEffect(() => {
    console.log('=== TASK DISPLAY DEBUG ===');
    console.log('Total tasks before filter:', tasks.length);
    console.log('Active filters:', filters);
    
    // Check for duplicates in source
    const ids = tasks.map(t => t.id);
    const duplicateIds = ids.filter((id, index) => ids.indexOf(id) !== index);
    if (duplicateIds.length > 0) {
      console.error('DUPLICATE IDS IN SOURCE:', duplicateIds);
    }
  }, [tasks, filters]);
  
  const filteredTasks = applyFilters(tasks, filters);
  
  console.log('Tasks after filter:', filteredTasks.length);
  
  return (
    <div>
      {filteredTasks.map(task => (
        <TaskCard key={task.id} task={task} />
      ))}
    </div>
  );
};
```

## Step 5: Check for Multiple Filter Applications

The issue might be that filters are being applied multiple times:

```javascript
// BAD - Multiple filter passes creating duplicates
let tasks = getAllTasks();
tasks = filterByDate(tasks, 'today');  // First filter
tasks = filterByStatus(tasks);         // Second filter might re-add tasks

// GOOD - Single filter pass
const filterTasks = (allTasks, filters) => {
  return allTasks.filter(task => {
    // Apply ALL filter conditions in one pass
    if (filters.date === 'today' && !isTaskVisibleToday(task)) return false;
    if (filters.status && task.status !== filters.status) return false;
    if (filters.category && task.category !== filters.category) return false;
    
    return true;
  });
};
```

## Key Points for Replit:

1. **Never concatenate filtered arrays** - This creates duplicates
2. **Filter in one pass** - Don't apply multiple filters that might re-add tasks
3. **Always de-duplicate by ID** - Use Set or findIndex to ensure unique tasks
4. **Check the source** - Make sure the unfiltered task list doesn't already have duplicates
5. **Log everything** - Add console.logs to see where duplicates appear

The "ghost" tasks that disappear when clearing filters strongly suggest the filter logic is creating duplicates, not that there are actual duplicate tasks in the database.