# Implementing Microsoft SSO in Your Replit App

## Step 1: Install Required Packages

In your Replit shell, run:
```bash
npm install @azure/msal-browser @azure/msal-react
```

## Step 2: Create Auth Configuration

Create a new file `src/config/authConfig.ts`:

```typescript
export const msalConfig = {
  auth: {
    clientId: "0b4cf8e2-eda5-4fd9-8319-7ec72614f0f2", // Your Application ID
    authority: "https://login.microsoftonline.com/86f7db5f-eb1e-4ac8-b010-4a2964d7749c", // Your Directory ID
    redirectUri: window.location.origin, // Automatically uses current URL
  },
  cache: {
    cacheLocation: "sessionStorage",
    storeAuthStateInCookie: false,
  },
};

export const loginRequest = {
  scopes: ["User.Read", "email", "profile", "openid"]
};

// Email domain validation
export const isAuthorizedEmail = (email: string): boolean => {
  return email.toLowerCase().endsWith('@growspace.farm');
};
```

## Step 3: Create Microsoft Login Component

Create `src/components/auth/MicrosoftLogin.tsx`:

```tsx
import React, { useEffect } from 'react';
import { useMsal } from "@azure/msal-react";
import { loginRequest, isAuthorizedEmail } from '../../config/authConfig';

export const MicrosoftLogin = () => {
  const { instance, accounts, inProgress } = useMsal();

  const handleLogin = async () => {
    try {
      const response = await instance.loginPopup(loginRequest);
      console.log('Login successful:', response);
      
      // Check email domain
      if (!isAuthorizedEmail(response.account.username)) {
        alert('Access denied. Only Grow Space employees can access this app.');
        await instance.logoutPopup();
      }
    } catch (error) {
      console.error('Login failed:', error);
    }
  };

  return (
    <div className="login-page">
      <div className="login-container">
        <div className="logo-section">
          <h1>ðŸŒ± Grow Space</h1>
          <h2>Task Management System</h2>
        </div>
        
        <div className="login-section">
          <p>Sign in with your Grow Space Microsoft account</p>
          
          <button 
            onClick={handleLogin} 
            className="microsoft-signin-btn"
            disabled={inProgress === "login"}
          >
            <svg width="21" height="21" viewBox="0 0 21 21">
              <rect x="1" y="1" width="9" height="9" fill="#f25022"/>
              <rect x="1" y="11" width="9" height="9" fill="#00a4ef"/>
              <rect x="11" y="1" width="9" height="9" fill="#7fba00"/>
              <rect x="11" y="11" width="9" height="9" fill="#ffb900"/>
            </svg>
            Sign in with Microsoft
          </button>
        </div>
        
        <div className="login-footer">
          <p className="security-note">
            ðŸ”’ Secure login through Microsoft Azure AD
          </p>
        </div>
      </div>
    </div>
  );
};
```

## Step 4: Update Your Main App Component

Update `src/App.tsx`:

```tsx
import React, { useEffect, useState } from 'react';
import { MsalProvider, useIsAuthenticated, useMsal } from "@azure/msal-react";
import { PublicClientApplication } from "@azure/msal-browser";
import { BrowserRouter as Router } from 'react-router-dom';
import { msalConfig, isAuthorizedEmail } from './config/authConfig';
import { MicrosoftLogin } from './components/auth/MicrosoftLogin';
import { UserProvider } from './contexts/UserContext';
// ... your other imports

const msalInstance = new PublicClientApplication(msalConfig);

function AppContent() {
  const isAuthenticated = useIsAuthenticated();
  const { accounts, instance } = useMsal();
  const [isLoading, setIsLoading] = useState(true);
  const [currentUser, setCurrentUser] = useState(null);

  useEffect(() => {
    const initializeUser = async () => {
      if (isAuthenticated && accounts[0]) {
        const account = accounts[0];
        
        // Verify email domain
        if (!isAuthorizedEmail(account.username)) {
          alert('Access denied. Only @growspace.farm emails are allowed.');
          await instance.logoutPopup();
          setIsLoading(false);
          return;
        }

        // Create user object
        const user = {
          id: account.localAccountId || account.homeAccountId,
          name: account.name,
          email: account.username,
          role: 'Staff', // Default role for new users
          isManager: false,
          isCorporateManager: false,
          location: 'Kenosha'
        };

        // Check if user exists in your staff data
        // If they're a manager or corporate, update their role
        const existingUser = await checkExistingUser(account.username);
        if (existingUser) {
          user.role = existingUser.role;
          user.isManager = existingUser.role === 'Manager' || existingUser.role === 'Corporate';
          user.isCorporateManager = existingUser.role === 'Corporate';
        }

        setCurrentUser(user);
      }
      setIsLoading(false);
    };

    initializeUser();
  }, [isAuthenticated, accounts, instance]);

  if (isLoading) {
    return (
      <div className="loading-screen">
        <h2>ðŸŒ± Loading Grow Space...</h2>
      </div>
    );
  }

  if (!isAuthenticated) {
    return <MicrosoftLogin />;
  }

  if (!currentUser) {
    return <div>Setting up your account...</div>;
  }

  // Your existing app with UserProvider
  return (
    <UserProvider value={{ currentUser, setCurrentUser }}>
      <Router>
        {/* Your existing app components */}
      </Router>
    </UserProvider>
  );
}

// Helper function to check existing users
async function checkExistingUser(email) {
  // Get from your staff data/localStorage
  const staffData = JSON.parse(localStorage.getItem('staffData') || '[]');
  return staffData.find(staff => staff.email === email);
}

function App() {
  return (
    <MsalProvider instance={msalInstance}>
      <AppContent />
    </MsalProvider>
  );
}

export default App;
```

## Step 5: Add Styles

Add to your CSS:

```css
/* Login Page Styles */
.login-page {
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 100vh;
  background-color: #f5f5f5;
  padding: 20px;
}

.login-container {
  background: white;
  border-radius: 12px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
  padding: 48px;
  max-width: 400px;
  width: 100%;
  text-align: center;
}

.logo-section h1 {
  color: #203B17;
  font-size: 36px;
  margin: 0;
}

.logo-section h2 {
  color: #666;
  font-size: 18px;
  font-weight: normal;
  margin: 8px 0 32px;
}

.login-section p {
  color: #666;
  margin-bottom: 24px;
}

.microsoft-signin-btn {
  display: inline-flex;
  align-items: center;
  gap: 12px;
  background: white;
  border: 1px solid #8c8c8c;
  padding: 12px 24px;
  font-size: 16px;
  font-family: 'Segoe UI', system-ui, sans-serif;
  cursor: pointer;
  transition: all 0.2s;
  border-radius: 2px;
}

.microsoft-signin-btn:hover {
  border-color: #666;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
}

.microsoft-signin-btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.security-note {
  color: #666;
  font-size: 14px;
  margin-top: 32px;
}

.loading-screen {
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 100vh;
  color: #203B17;
}
```

## Step 6: Remove Old Auth Code

Remove or comment out:
- Mock login components
- User switching functionality  
- Any hardcoded test users
- localStorage user switching

## Step 7: Update User Context

Make sure your UserContext works with Microsoft auth:

```tsx
// In UserContext.tsx
export const UserProvider = ({ children, value }) => {
  const { currentUser, setCurrentUser } = value;
  
  // Remove mock user switching
  // Remove hardcoded users
  
  return (
    <UserContext.Provider value={{ currentUser, setCurrentUser }}>
      {children}
    </UserContext.Provider>
  );
};
```

## Testing:

1. Save all files
2. Refresh your Replit app
3. You should see the Microsoft login button
4. Click "Sign in with Microsoft"
5. Log in with a @growspace.farm account
6. First-time users get "Staff" role automatically

## Troubleshooting:

If you get redirect URI mismatch:
1. Copy the exact URL from the error message
2. Go to Azure Portal â†’ Your App â†’ Authentication
3. Add that exact URL as a redirect URI
4. Save and wait 2-3 minutes

Let me know if you hit any errors!