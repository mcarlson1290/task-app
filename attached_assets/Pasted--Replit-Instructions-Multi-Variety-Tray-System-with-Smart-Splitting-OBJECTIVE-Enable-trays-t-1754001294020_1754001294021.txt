# Replit Instructions: Multi-Variety Tray System with Smart Splitting

**OBJECTIVE: Enable trays to contain multiple crop varieties with quantities, and track splits accurately**

## Step 1: Update Create Tray Component for Multiple Varieties

Replace the single seed selection with a multi-variety input system:

```tsx
const CreateTrayStep = ({ 
  stepData, 
  onComplete,
  defaultTrayType = 'LG',
  defaultInstance = 1,
  defaultSeedsOz = '',
  defaultGrowingMedium = '',
  defaultVarieties = [] // Array of {seedId, quantity}
}) => {
  const [trayType, setTrayType] = useState(defaultTrayType);
  const [instanceNumber, setInstanceNumber] = useState(defaultInstance);
  const [growingMedium, setGrowingMedium] = useState(defaultGrowingMedium);
  const [totalSlots, setTotalSlots] = useState(0); // Manual input for total slots
  const [varieties, setVarieties] = useState(defaultVarieties.length > 0 ? defaultVarieties : [
    { id: Date.now(), seedId: '', quantity: 0, seedsOz: 0 }
  ]);
  const [notes, setNotes] = useState('');
  const [generatedId, setGeneratedId] = useState('');
  const [availableSeeds, setAvailableSeeds] = useState([]);

  // Calculate total plants
  const totalPlants = varieties.reduce((sum, v) => sum + (parseInt(v.quantity) || 0), 0);

  // Load seeds from inventory
  useEffect(() => {
    const inventory = JSON.parse(localStorage.getItem('inventory') || '[]');
    const seeds = inventory.filter(item => item.category === 'Seeds');
    setAvailableSeeds(seeds);
  }, []);

  // Generate tray ID - use MIX for mixed varieties
  useEffect(() => {
    const date = new Date();
    const dateStr = 
      (date.getMonth() + 1).toString().padStart(2, '0') +
      date.getDate().toString().padStart(2, '0') +
      date.getFullYear().toString().slice(2);
    
    // If multiple varieties, use MIX, otherwise use first seed's SKU
    let sku = 'MIX';
    if (varieties.length === 1 && varieties[0].seedId) {
      const seed = availableSeeds.find(s => s.id === varieties[0].seedId);
      if (seed) sku = seed.sku || seed.productCode || 'MIX';
    }
    
    const id = `${locationCode}${dateStr}-${trayType}-${sku}-${instanceNumber}`;
    setGeneratedId(id);
  }, [varieties, trayType, instanceNumber, availableSeeds]);

  const addVariety = () => {
    setVarieties([...varieties, { 
      id: Date.now(), 
      seedId: '', 
      quantity: 0, 
      seedsOz: 0 
    }]);
  };

  const removeVariety = (id) => {
    if (varieties.length > 1) {
      setVarieties(varieties.filter(v => v.id !== id));
    }
  };

  const updateVariety = (id, field, value) => {
    setVarieties(varieties.map(v => 
      v.id === id ? { ...v, [field]: value } : v
    ));
  };

  const handleCreate = () => {
    // Validate
    if (!growingMedium || totalSlots === 0) {
      alert('Please fill in growing medium and total slots');
      return;
    }

    if (totalPlants > totalSlots) {
      alert(`Total plants (${totalPlants}) exceeds available slots (${totalSlots})`);
      return;
    }

    // Build variety details
    const varietyDetails = varieties
      .filter(v => v.seedId && v.quantity > 0)
      .map(v => {
        const seed = availableSeeds.find(s => s.id === v.seedId);
        return {
          seedId: v.seedId,
          seedName: seed?.name || 'Unknown',
          sku: seed?.sku || seed?.productCode || '',
          quantity: parseInt(v.quantity),
          seedsOz: parseFloat(v.seedsOz) || 0
        };
      });

    if (varietyDetails.length === 0) {
      alert('Please add at least one variety with quantity');
      return;
    }

    // Create tray with multiple varieties
    const newTray = {
      id: generatedId,
      trayType,
      totalSlots,
      growingMedium,
      varieties: varietyDetails,
      totalPlants,
      plantedBy: currentUser.username || 'Unknown',
      plantedDate: new Date().toISOString(),
      location: currentUser.location,
      status: 'seeded',
      currentLocation: 'nursery-a',
      movements: [{
        location: 'nursery-a',
        movedBy: currentUser.username,
        timestamp: new Date().toISOString(),
        notes: 'Initial seeding'
      }],
      notes
    };

    // Save to production trays
    const existingTrays = JSON.parse(localStorage.getItem('productionTrays') || '[]');
    existingTrays.push(newTray);
    localStorage.setItem('productionTrays', JSON.stringify(existingTrays));

    // Update seed inventory
    varietyDetails.forEach(variety => {
      const inventory = JSON.parse(localStorage.getItem('inventory') || '[]');
      const seedIndex = inventory.findIndex(item => item.id === variety.seedId);
      if (seedIndex > -1) {
        inventory[seedIndex].quantity -= variety.seedsOz;
        localStorage.setItem('inventory', JSON.stringify(inventory));
      }
    });

    // Dispatch event
    window.dispatchEvent(new CustomEvent('trayCreated', { detail: newTray }));
    
    onComplete({
      trayId: generatedId,
      ...newTray
    });
  };

  return (
    <div className="create-tray-step">
      <h3>Create Multi-Variety Tray</h3>
      
      {generatedId && (
        <div className="tray-id-preview">
          <strong>Tray ID:</strong> {generatedId}
        </div>
      )}

      <div className="form-row">
        <div className="form-group">
          <label>Tray Type*</label>
          <select value={trayType} onChange={(e) => setTrayType(e.target.value)}>
            <option value="LG">LG - Leafy Greens</option>
            <option value="MG">MG - Microgreens</option>
            <option value="HB">HB - Herbs</option>
          </select>
        </div>

        <div className="form-group">
          <label>Instance #</label>
          <input
            type="number"
            value={instanceNumber}
            onChange={(e) => setInstanceNumber(parseInt(e.target.value) || 1)}
            min={1}
            max={99}
          />
        </div>
      </div>

      <div className="form-row">
        <div className="form-group">
          <label>Growing Medium*</label>
          <select value={growingMedium} onChange={(e) => setGrowingMedium(e.target.value)}>
            <option value="">Select...</option>
            <option value="Oasis Cubes">Oasis Cubes</option>
            <option value="Rockwool">Rockwool</option>
            <option value="Hemp Mat">Hemp Mat</option>
          </select>
        </div>

        <div className="form-group">
          <label>Total Slots Available*</label>
          <input
            type="number"
            value={totalSlots}
            onChange={(e) => setTotalSlots(parseInt(e.target.value) || 0)}
            placeholder="e.g., 200"
            min={1}
          />
          <small>Rockwool: typically 200, Oasis: varies</small>
        </div>
      </div>

      <div className="varieties-section">
        <h4>Crop Varieties</h4>
        <div className="summary-bar">
          <span>Total Plants: {totalPlants} / {totalSlots || '?'}</span>
          {totalSlots > 0 && totalPlants > totalSlots && (
            <span className="error">⚠️ Exceeds capacity!</span>
          )}
        </div>

        {varieties.map((variety, index) => (
          <div key={variety.id} className="variety-row">
            <select
              value={variety.seedId}
              onChange={(e) => updateVariety(variety.id, 'seedId', e.target.value)}
              className="seed-select"
            >
              <option value="">Select seed...</option>
              {availableSeeds.map(seed => (
                <option key={seed.id} value={seed.id}>
                  [{seed.sku || seed.productCode}] {seed.name}
                </option>
              ))}
            </select>
            
            <input
              type="number"
              value={variety.quantity}
              onChange={(e) => updateVariety(variety.id, 'quantity', e.target.value)}
              placeholder="Plants"
              min={0}
              className="quantity-input"
            />
            
            <input
              type="number"
              value={variety.seedsOz}
              onChange={(e) => updateVariety(variety.id, 'seedsOz', e.target.value)}
              placeholder="Seeds (oz)"
              step="0.1"
              min={0}
              className="seeds-input"
            />
            
            {varieties.length > 1 && (
              <button onClick={() => removeVariety(variety.id)} className="remove-btn">
                ✕
              </button>
            )}
          </div>
        ))}
        
        <button onClick={addVariety} className="add-variety-btn">
          + Add Another Variety
        </button>
      </div>

      <div className="form-group">
        <label>Notes</label>
        <textarea
          value={notes}
          onChange={(e) => setNotes(e.target.value)}
          placeholder="Optional notes..."
          rows={3}
        />
      </div>

      <button onClick={handleCreate} className="create-tray-btn">
        Create Multi-Variety Tray
      </button>
    </div>
  );
};
```

## Step 2: Update Tray Split to Handle Multiple Varieties

Update the split tray functionality to track variety distribution:

```tsx
const TraySpliStep = ({ stepData, onComplete, trayId }) => {
  const [selectedTray, setSelectedTray] = useState(null);
  const [splits, setSplits] = useState([]);
  const [availableSystems, setAvailableSystems] = useState([]);

  // Load tray data
  useEffect(() => {
    const trays = JSON.parse(localStorage.getItem('productionTrays') || '[]');
    const tray = trays.find(t => t.id === trayId);
    if (tray) {
      setSelectedTray(tray);
      
      // Initialize splits based on number of splits from step config
      const numSplits = stepData.numberOfSplits || 2;
      const initialSplits = [];
      
      for (let i = 0; i < numSplits; i++) {
        const split = {
          id: `${tray.id}-${i + 1}`,
          systemId: '',
          varieties: tray.varieties.map(v => ({
            ...v,
            quantity: 0 // User will input how many of each variety
          }))
        };
        initialSplits.push(split);
      }
      setSplits(initialSplits);
    }
  }, [trayId]);

  // Load available systems
  useEffect(() => {
    const equipment = JSON.parse(localStorage.getItem('productionEquipment') || '[]');
    const systems = equipment.filter(e => e.type === 'Growing System');
    setAvailableSystems(systems);
  }, []);

  const updateSplitVariety = (splitIndex, varietyIndex, quantity) => {
    const newSplits = [...splits];
    newSplits[splitIndex].varieties[varietyIndex].quantity = parseInt(quantity) || 0;
    setSplits(newSplits);
  };

  const updateSplitSystem = (splitIndex, systemId) => {
    const newSplits = [...splits];
    newSplits[splitIndex].systemId = systemId;
    setSplits(newSplits);
  };

  // Validate total quantities match original
  const validateSplits = () => {
    if (!selectedTray) return false;
    
    // Check each variety's total
    for (let v = 0; v < selectedTray.varieties.length; v++) {
      const originalQty = selectedTray.varieties[v].quantity;
      const splitTotal = splits.reduce((sum, split) => 
        sum + (split.varieties[v]?.quantity || 0), 0
      );
      
      if (splitTotal !== originalQty) {
        alert(`${selectedTray.varieties[v].seedName}: Split total (${splitTotal}) doesn't match original (${originalQty})`);
        return false;
      }
    }
    
    // Check all splits have systems
    if (splits.some(s => !s.systemId)) {
      alert('Please select a system for each split');
      return false;
    }
    
    return true;
  };

  const executeSplit = () => {
    if (!validateSplits()) return;
    
    const trays = JSON.parse(localStorage.getItem('productionTrays') || '[]');
    const trayIndex = trays.findIndex(t => t.id === selectedTray.id);
    
    // Mark original as split
    trays[trayIndex].status = 'split';
    trays[trayIndex].splitDate = new Date().toISOString();
    
    // Create new trays for each split
    splits.forEach((split, index) => {
      const newTray = {
        ...selectedTray,
        id: split.id,
        parentTrayId: selectedTray.id,
        varieties: split.varieties.filter(v => v.quantity > 0),
        totalPlants: split.varieties.reduce((sum, v) => sum + v.quantity, 0),
        currentLocation: split.systemId,
        status: 'growing',
        movements: [
          ...selectedTray.movements,
          {
            location: split.systemId,
            movedBy: currentUser.username,
            timestamp: new Date().toISOString(),
            notes: `Split from ${selectedTray.id}`
          }
        ]
      };
      
      trays.push(newTray);
    });
    
    localStorage.setItem('productionTrays', JSON.stringify(trays));
    window.dispatchEvent(new CustomEvent('traySplit', { detail: splits }));
    
    onComplete({ splits });
  };

  if (!selectedTray) return <div>Loading tray data...</div>;

  return (
    <div className="tray-split-step">
      <h3>Split Tray: {selectedTray.id}</h3>
      
      <div className="original-tray-info">
        <h4>Original Tray Contents:</h4>
        {selectedTray.varieties.map((v, i) => (
          <div key={i}>
            {v.seedName}: {v.quantity} plants
          </div>
        ))}
        <div className="total">Total: {selectedTray.totalPlants} plants</div>
      </div>

      <div className="splits-section">
        {splits.map((split, splitIndex) => (
          <div key={split.id} className="split-card">
            <h4>Split {splitIndex + 1}: {split.id}</h4>
            
            <div className="form-group">
              <label>Destination System:</label>
              <select
                value={split.systemId}
                onChange={(e) => updateSplitSystem(splitIndex, e.target.value)}
              >
                <option value="">Select system...</option>
                {availableSystems.map(sys => (
                  <option key={sys.id} value={sys.id}>
                    {sys.name} (Available: {sys.capacity - sys.occupied}/{sys.capacity})
                  </option>
                ))}
              </select>
            </div>

            <div className="variety-distribution">
              <label>Plant Distribution:</label>
              {split.varieties.map((variety, vIndex) => (
                <div key={vIndex} className="variety-split-row">
                  <span>{variety.seedName}:</span>
                  <input
                    type="number"
                    value={variety.quantity}
                    onChange={(e) => updateSplitVariety(splitIndex, vIndex, e.target.value)}
                    min={0}
                    max={selectedTray.varieties[vIndex].quantity}
                  />
                  <span>/ {selectedTray.varieties[vIndex].quantity}</span>
                </div>
              ))}
            </div>
          </div>
        ))}
      </div>

      <button onClick={executeSplit} className="execute-split-btn">
        Execute Split ({splits.length} new trays)
      </button>
    </div>
  );
};
```

## Step 3: Update Production Data Display

Update the tray tracking display to show multi-variety information:

```tsx
// In Tray Tracking component
const TrayCard = ({ tray }) => {
  return (
    <div className="tray-card">
      <h4>{tray.id}</h4>
      <div className="tray-details">
        <p>Type: {tray.trayType} | Medium: {tray.growingMedium}</p>
        <p>Location: {tray.currentLocation}</p>
        
        <div className="varieties-list">
          <h5>Contents:</h5>
          {tray.varieties.map((v, i) => (
            <div key={i} className="variety-item">
              [{v.sku}] {v.seedName}: {v.quantity} plants
            </div>
          ))}
          <div className="total">Total: {tray.totalPlants} / {tray.totalSlots} slots</div>
        </div>
        
        {tray.parentTrayId && (
          <p className="split-info">Split from: {tray.parentTrayId}</p>
        )}
      </div>
    </div>
  );
};
```

## Step 4: Add Default Varieties to Recurring Task Configuration

In the recurring task builder for Create Tray steps:

```tsx
{selectedStepType === 'Create Tray' && (
  <div className="create-tray-configuration">
    {/* ... existing fields ... */}
    
    <div className="default-varieties-section">
      <h4>Default Varieties</h4>
      {defaultVarieties.map((variety, index) => (
        <div key={index} className="default-variety-row">
          <select
            value={variety.seedId}
            onChange={(e) => updateDefaultVariety(index, 'seedId', e.target.value)}
          >
            <option value="">Select seed...</option>
            {availableSeeds.map(seed => (
              <option key={seed.id} value={seed.id}>
                [{seed.sku}] {seed.name}
              </option>
            ))}
          </select>
          
          <input
            type="number"
            value={variety.quantity}
            onChange={(e) => updateDefaultVariety(index, 'quantity', e.target.value)}
            placeholder="Default quantity"
          />
          
          <button onClick={() => removeDefaultVariety(index)}>Remove</button>
        </div>
      ))}
      
      <button onClick={addDefaultVariety}>+ Add Default Variety</button>
    </div>
  </div>
)}
```

## Step 5: Add Styles

```css
.varieties-section {
  margin: 1rem 0;
  padding: 1rem;
  background: #f5f5f5;
  border-radius: 8px;
}

.variety-row {
  display: grid;
  grid-template-columns: 2fr 100px 100px 40px;
  gap: 0.5rem;
  margin-bottom: 0.5rem;
  align-items: center;
}

.summary-bar {
  display: flex;
  justify-content: space-between;
  padding: 0.5rem;
  background: #e0e0e0;
  border-radius: 4px;
  margin-bottom: 1rem;
}

.split-card {
  border: 1px solid #ddd;
  padding: 1rem;
  margin-bottom: 1rem;
  border-radius: 8px;
}

.variety-distribution {
  margin-top: 1rem;
}

.variety-split-row {
  display: grid;
  grid-template-columns: 150px 80px 80px;
  gap: 0.5rem;
  margin-bottom: 0.5rem;
  align-items: center;
}

.error {
  color: #f44336;
  font-weight: bold;
}
```

## Summary

This implementation allows:
1. **Multi-variety trays** - e.g., 40 romaine + 30 arugula in one tray
2. **Manual slot input** - Specify total capacity (200 for Rockwool, etc.)
3. **Smart splitting** - Distribute specific quantities of each variety to different systems
4. **Full tracking** - Know exactly which varieties are in which systems
5. **Inventory deduction** - Seeds used are tracked per variety

The tray ID will show "MIX" for multi-variety trays, making them easy to identify.