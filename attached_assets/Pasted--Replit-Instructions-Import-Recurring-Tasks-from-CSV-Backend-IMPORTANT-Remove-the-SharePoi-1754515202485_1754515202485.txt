// Replit Instructions: Import Recurring Tasks from CSV Backend

// IMPORTANT: Remove the SharePoint import button from the UI first

// Step 1: Create a backend import script
// Create a new file: src/utils/importRecurringTasks.js

import Papa from 'papaparse';

// Categories mapping based on task titles
const getCategoryFromTitle = (title) => {
  const titleLower = title.toLowerCase();
  
  if (titleLower.includes('seed') && titleLower.includes('microgreen')) {
    return 'Seeding - Microgreens';
  } else if (titleLower.includes('seed') && (titleLower.includes('leafy') || titleLower.includes('lettuce'))) {
    return 'Seeding - Leafy Greens';
  } else if (titleLower.includes('harvest') && titleLower.includes('microgreen')) {
    return 'Harvest - Microgreens';
  } else if (titleLower.includes('harvest') && (titleLower.includes('leafy') || titleLower.includes('lettuce'))) {
    return 'Harvest - Leafy Greens';
  } else if (titleLower.includes('blackout') || titleLower.includes('bo')) {
    return 'Blackout Tasks';
  } else if (titleLower.includes('mov') || titleLower.includes('transfer')) {
    return 'Moving';
  } else if (titleLower.includes('clean') || titleLower.includes('sanitize')) {
    return 'Cleaning';
  } else if (titleLower.includes('water')) {
    return 'General Farm';
  } else if (titleLower.includes('maintenance') || titleLower.includes('equipment')) {
    return 'Equipment Maintenance';
  } else if (titleLower.includes('inventory')) {
    return 'Inventory';
  } else {
    return 'Other';
  }
};

// Parse the Week Day field which contains JSON array strings
const parseWeekDayField = (weekDayField) => {
  if (!weekDayField) return { frequency: 'daily', daysOfWeek: [] };
  
  try {
    // The field contains a JSON array string like ["Monday","Friday"]
    const days = JSON.parse(weekDayField);
    
    // Check for special cases
    if (days.includes('DISABLED')) {
      return { frequency: 'disabled', isActive: false };
    }
    
    if (days.includes('Bi-Weekly A')) {
      return { frequency: 'biweekly', weekPeriod: 'first' };
    }
    
    if (days.includes('Monthly')) {
      return { frequency: 'monthly', dayOfMonth: 1 };
    }
    
    // If it has all 7 days, it's daily
    if (days.length === 7) {
      return { frequency: 'daily' };
    }
    
    // Otherwise it's weekly with specific days
    return {
      frequency: 'weekly',
      daysOfWeek: days.map(day => day.toLowerCase())
    };
    
  } catch (e) {
    console.error('Error parsing week day:', weekDayField, e);
    return { frequency: 'daily' };
  }
};

// Map old roles to new system roles
const mapRole = (assignedTo) => {
  if (!assignedTo) return 'General Staff';
  
  const roleMap = {
    'microgreen seeder': 'Microgreen Seeder',
    'microgreen general maintainer': 'General Staff',
    'microgreen harvester': 'Harvester',
    'everyone': 'General Staff',
    'general': 'General Staff',
    'manager': 'Manager'
  };
  
  const assigned = assignedTo.toLowerCase();
  return roleMap[assigned] || 'General Staff';
};

// Main import function
export const importRecurringTasksFromCSV = async () => {
  try {
    // Read the CSV file
    const csvData = await window.fs.readFile('Reoccurring Tasks 1.csv', { encoding: 'utf8' });
    
    // Parse CSV
    const parsed = Papa.parse(csvData, {
      header: true,
      dynamicTyping: true,
      skipEmptyLines: true,
      delimitersToGuess: [',', '\t', '|', ';']
    });
    
    const tasks = [];
    const errors = [];
    let successCount = 0;
    let skippedCount = 0;
    
    // Process each task
    parsed.data.forEach((row, index) => {
      try {
        // Skip if no title
        if (!row.Title) {
          skippedCount++;
          return;
        }
        
        // Parse frequency information
        const frequencyInfo = parseWeekDayField(row['Week Day']);
        
        // Skip disabled tasks
        if (frequencyInfo.frequency === 'disabled') {
          skippedCount++;
          console.log(`Skipping disabled task: ${row.Title}`);
          return;
        }
        
        // Create the task object
        const task = {
          id: `imported-${Date.now()}-${index}`,
          title: row.Title,
          description: row.Description || row.QuickInfo || '',
          category: getCategoryFromTitle(row.Title),
          priority: row.Priority?.toLowerCase().includes('high') ? 'high' : 'medium',
          frequency: frequencyInfo.frequency,
          assignedRole: mapRole(row['Assigned To']),
          isActive: frequencyInfo.isActive !== false,
          
          // Add frequency-specific fields
          ...(frequencyInfo.daysOfWeek && { daysOfWeek: frequencyInfo.daysOfWeek }),
          ...(frequencyInfo.dayOfMonth && { dayOfMonth: frequencyInfo.dayOfMonth }),
          ...(frequencyInfo.weekPeriod && { weekPeriod: frequencyInfo.weekPeriod }),
          
          // Metadata
          importedFrom: 'SharePoint',
          originalTaskId: row['Task ID'],
          originalUniqueId: row.UniqueID,
          hasChecklist: row['Has A SP Checklist Been Created'] === true,
          processLink: row.ProcessLink || null,
          instances: row.Instances || 0,
          
          // Microgreen specific
          microgreensWeight: row['Microgreen Weight'] || null,
          
          // System fields
          createdAt: new Date().toISOString(),
          lastModified: new Date().toISOString()
        };
        
        tasks.push(task);
        successCount++;
        
      } catch (error) {
        errors.push({
          row: index + 2, // +2 for header and 0-index
          title: row.Title || 'Unknown',
          error: error.message
        });
      }
    });
    
    // Log results
    console.log('=== IMPORT SUMMARY ===');
    console.log(`Total rows processed: ${parsed.data.length}`);
    console.log(`Successfully imported: ${successCount}`);
    console.log(`Skipped (disabled/empty): ${skippedCount}`);
    console.log(`Errors: ${errors.length}`);
    
    if (errors.length > 0) {
      console.log('\nERRORS:');
      errors.forEach(err => {
        console.log(`Row ${err.row} (${err.title}): ${err.error}`);
      });
    }
    
    return { tasks, errors, successCount, skippedCount };
    
  } catch (error) {
    console.error('Failed to import CSV:', error);
    throw error;
  }
};

// Step 2: Add to your main App initialization
// In App.jsx or wherever you initialize data:

import { importRecurringTasksFromCSV } from './utils/importRecurringTasks';

// Add this to your app initialization or a useEffect
const initializeRecurringTasks = async () => {
  // Check if tasks have already been imported
  const existingTasks = getRecurringTasks(); // Your existing function
  
  if (existingTasks.length === 0) {
    console.log('No recurring tasks found, importing from CSV...');
    
    try {
      const { tasks, successCount } = await importRecurringTasksFromCSV();
      
      // Save each task using your existing function
      tasks.forEach(task => {
        addRecurringTask(task); // Your existing function
      });
      
      console.log(`Successfully imported ${successCount} recurring tasks`);
      
      // Show success notification
      alert(`Imported ${successCount} recurring tasks from SharePoint`);
      
    } catch (error) {
      console.error('Failed to import tasks:', error);
    }
  }
};

// Call on app load
useEffect(() => {
  initializeRecurringTasks();
}, []);

// Step 3: Remove the import button from UI
// In your RecurringTasks component, remove or comment out:
// <ImportRecurringTasks />
// or any SharePoint import button

// Step 4: Add a manual trigger (optional - for testing)
// Add this to your admin/settings page if you want manual import:

const ManualImportButton = () => {
  const handleManualImport = async () => {
    if (confirm('This will import all tasks from the CSV. Continue?')) {
      try {
        const { tasks, successCount } = await importRecurringTasksFromCSV();
        
        tasks.forEach(task => {
          addRecurringTask(task);
        });
        
        alert(`Imported ${successCount} tasks successfully`);
        window.location.reload(); // Refresh to show new tasks
        
      } catch (error) {
        alert('Import failed: ' + error.message);
      }
    }
  };
  
  return (
    <button 
      onClick={handleManualImport}
      style={{
        backgroundColor: '#2e7d32',
        color: 'white',
        padding: '10px 20px',
        border: 'none',
        borderRadius: '4px',
        cursor: 'pointer'
      }}
    >
      Import Tasks from CSV (Admin Only)
    </button>
  );
};