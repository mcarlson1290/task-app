# Replit Instructions: Continuous Task Verification System

## The Problem
Tasks aren't generating on the correct days, and there's no system to continuously verify and heal missing/incorrect tasks.

## Solution: Build a Self-Healing Task System

### 1. Continuous Verification Function

Create a function that checks and fixes tasks for the entire 31-day window:

```javascript
const verifyAndHealTasks = async () => {
  console.log('=== TASK VERIFICATION STARTING ===');
  
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  
  const endDate = new Date(today);
  endDate.setDate(today.getDate() + 31);
  
  const templates = await getAllRecurringTemplates();
  const existingTasks = await getAllTasks();
  
  let created = 0;
  let updated = 0;
  
  // Check each day in our window
  for (let dayOffset = 0; dayOffset <= 31; dayOffset++) {
    const checkDate = new Date(today);
    checkDate.setDate(today.getDate() + dayOffset);
    
    for (const template of templates) {
      const expectedTasks = getExpectedTasksForDate(template, checkDate);
      
      for (const expected of expectedTasks) {
        const existingTask = existingTasks.find(t => t.id === expected.id);
        
        if (!existingTask) {
          // Task is missing - create it
          await saveTask(expected);
          created++;
          console.log(`Created missing task: ${expected.id}`);
        } else if (existingTask.status === 'pending') {
          // Task exists but might be outdated - verify it matches template
          if (taskNeedsUpdate(existingTask, template)) {
            await updateTask({
              ...existingTask,
              ...extractTemplateFields(template)
            });
            updated++;
            console.log(`Updated outdated task: ${existingTask.id}`);
          }
        }
      }
    }
  }
  
  console.log(`Verification complete: Created ${created}, Updated ${updated}`);
  return { created, updated };
};
```

### 2. Expected Task Calculator

Determine what tasks SHOULD exist for any given date:

```javascript
const getExpectedTasksForDate = (template, checkDate) => {
  const tasks = [];
  const dayOfMonth = checkDate.getDate();
  const month = checkDate.getMonth();
  const year = checkDate.getFullYear();
  const dayName = checkDate.toLocaleDateString('en-US', { weekday: 'long' });
  
  // Monthly: Should exist from 1st through end of month
  if (template.frequency === 'monthly') {
    // If we're anywhere in the month, the monthly task should exist
    if (dayOfMonth >= 1) {
      const firstOfMonth = new Date(year, month, 1);
      const lastOfMonth = new Date(year, month + 1, 0);
      
      tasks.push({
        ...template,
        id: `${template.id}-${year}-${String(month + 1).padStart(2, '0')}`,
        visibleFromDate: formatDate(firstOfMonth),
        dueDate: formatDate(lastOfMonth),
        recurringTaskId: template.id,
        frequency: 'monthly',
        status: 'pending'
      });
    }
  }
  
  // Bi-Weekly: Two tasks per month
  else if (template.frequency === 'biweekly') {
    // First half task exists from 1st-14th
    if (dayOfMonth >= 1 && dayOfMonth <= 14) {
      tasks.push({
        ...template,
        id: `${template.id}-${year}-${String(month + 1).padStart(2, '0')}-01`,
        visibleFromDate: formatDate(new Date(year, month, 1)),
        dueDate: formatDate(new Date(year, month, 14)),
        recurringTaskId: template.id,
        frequency: 'biweekly',
        status: 'pending'
      });
    }
    
    // Second half task exists from 15th-end
    if (dayOfMonth >= 15) {
      const lastDay = new Date(year, month + 1, 0);
      tasks.push({
        ...template,
        id: `${template.id}-${year}-${String(month + 1).padStart(2, '0')}-15`,
        visibleFromDate: formatDate(new Date(year, month, 15)),
        dueDate: formatDate(lastDay),
        recurringTaskId: template.id,
        frequency: 'biweekly',
        status: 'pending'
      });
    }
  }
  
  // Weekly: Only on specific days
  else if (template.frequency === 'daily' && template.selectedDays?.includes(dayName)) {
    tasks.push({
      ...template,
      id: `${template.id}-${formatDate(checkDate)}`,
      visibleFromDate: formatDate(checkDate),
      dueDate: formatDate(checkDate),
      recurringTaskId: template.id,
      frequency: 'daily',
      status: 'pending'
    });
  }
  
  // Quarterly: Entire quarter
  else if (template.frequency === 'quarterly') {
    const quarterStarts = [
      { month: 0, quarter: 1 },  // Jan
      { month: 3, quarter: 2 },  // Apr
      { month: 6, quarter: 3 },  // Jul
      { month: 9, quarter: 4 }   // Oct
    ];
    
    // Find which quarter we're in
    const currentQuarter = Math.floor(month / 3);
    const quarterStart = new Date(year, currentQuarter * 3, 1);
    const quarterEnd = new Date(year, (currentQuarter + 1) * 3, 0);
    
    // If we're in this quarter, task should exist
    if (checkDate >= quarterStart && checkDate <= quarterEnd) {
      tasks.push({
        ...template,
        id: `${template.id}-${year}-Q${currentQuarter + 1}`,
        visibleFromDate: formatDate(quarterStart),
        dueDate: formatDate(quarterEnd),
        recurringTaskId: template.id,
        frequency: 'quarterly',
        status: 'pending'
      });
    }
  }
  
  return tasks;
};
```

### 3. Run Verification Frequently

Set up multiple triggers to ensure tasks are always correct:

```javascript
// Run on app startup
useEffect(() => {
  verifyAndHealTasks();
}, []);

// Run every hour
useEffect(() => {
  const interval = setInterval(() => {
    verifyAndHealTasks();
  }, 60 * 60 * 1000); // Every hour
  
  return () => clearInterval(interval);
}, []);

// Run when returning to the app (visibility change)
useEffect(() => {
  const handleVisibilityChange = () => {
    if (document.visibilityState === 'visible') {
      verifyAndHealTasks();
    }
  };
  
  document.addEventListener('visibilitychange', handleVisibilityChange);
  return () => document.removeEventListener('visibilitychange', handleVisibilityChange);
}, []);

// Run when date changes
useEffect(() => {
  verifyAndHealTasks();
}, [selectedDate]);
```

### 4. Manual Verification Button

Add a button for immediate verification:

```javascript
<button
  onClick={async () => {
    const result = await verifyAndHealTasks();
    alert(`Verification complete:\nCreated: ${result.created} tasks\nUpdated: ${result.updated} tasks`);
    window.location.reload();
  }}
  className="px-4 py-2 bg-blue-600 text-white rounded"
>
  üîç Verify All Tasks
</button>
```

### 5. Debug Mode for Visibility

Add a debug view to see what's expected vs actual:

```javascript
const debugTaskGeneration = async () => {
  const today = new Date();
  const templates = await getAllRecurringTemplates();
  const existingTasks = await getAllTasks();
  
  console.log('=== TASK GENERATION DEBUG ===');
  console.log(`Today: ${today.toDateString()}`);
  console.log(`Templates: ${templates.length}`);
  console.log(`Existing tasks: ${existingTasks.length}`);
  
  // Check next 7 days as example
  for (let day = 0; day < 7; day++) {
    const checkDate = new Date(today);
    checkDate.setDate(today.getDate() + day);
    
    console.log(`\n--- ${checkDate.toDateString()} ---`);
    
    for (const template of templates) {
      const expected = getExpectedTasksForDate(template, checkDate);
      
      if (expected.length > 0) {
        expected.forEach(exp => {
          const exists = existingTasks.find(t => t.id === exp.id);
          console.log(`${template.title}:`);
          console.log(`  Expected: ${exp.id}`);
          console.log(`  Exists: ${exists ? 'YES' : 'NO - MISSING!'}`);
        });
      }
    }
  }
};
```

## Key Improvements

1. **Self-Healing**: System automatically creates missing tasks
2. **Continuous Checking**: Runs hourly and on various triggers
3. **Mid-Period Handling**: Correctly handles tasks created mid-month
4. **Update Detection**: Updates pending tasks if template changed
5. **Debug Visibility**: Can see exactly what's expected vs actual

## Expected Behavior

- Create a monthly task on Oct 15th ‚Üí October task appears immediately
- Create a bi-weekly task on Oct 20th ‚Üí Second half task appears
- Template changes ‚Üí All pending tasks update within an hour
- Missing tasks ‚Üí Automatically created on next check

This creates a robust system that constantly ensures all tasks exist and are up-to-date.