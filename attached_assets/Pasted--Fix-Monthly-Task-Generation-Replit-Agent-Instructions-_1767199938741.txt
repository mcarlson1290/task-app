# Fix Monthly Task Generation - Replit Agent Instructions

**Date:** December 31, 2025  
**File to Edit:** `/server/routes.ts`  
**Bug:** Monthly tasks only generate once on the 1st, not visible throughout the month  
**Desired Behavior:** Monthly tasks should be visible from the 1st and completable anytime during the month (due on last day)

---

## IMPORTANT: Do not delete any existing tasks, recurring tasks, or user data

---

## Problem Explanation

Currently, monthly tasks:
- ‚úÖ Generate on the 1st of each month (CORRECT)
- ‚ùå Are only visible on the 1st (WRONG - should be visible all month)
- ‚ùå Due date is set to last day of month, but visibleFromDate is also the 1st, causing visibility issues

The fix ensures:
- Tasks generate on the 1st
- Tasks are visible from the 1st through the end of the month
- Tasks are due on the last day of the month
- Users can complete them anytime during the month

---

## Step 1: Locate the Monthly Case

**File:** `/server/routes.ts`

**Find this code block (lines 2446-2451):**

```typescript
case 'monthly':
  if (currentDate.getDate() === 1) {
    shouldGenerate = true;
    dueDate.setMonth(dueDate.getMonth() + 1, 0); // Due on last day of month
  }
  break;
```

---

## Step 2: Replace with Fixed Code

**Replace the above code with:**

```typescript
case 'monthly':
  if (currentDate.getDate() === 1) {
    shouldGenerate = true;
    // Monthly tasks are visible from 1st of the month
    const visibleFromDate = new Date(currentDate);
    visibleFromDate.setHours(0, 0, 0, 0);
    
    // Due on last day of current month
    dueDate.setMonth(dueDate.getMonth() + 1, 0); // Last day of next month
    dueDate.setHours(23, 59, 59, 999); // End of day
    
    console.log(`üìÖ MONTHLY task generation for ${recurringTask.title}:`, {
      visibleFrom: visibleFromDate.toISOString().split('T')[0],
      dueDate: dueDate.toISOString().split('T')[0],
      currentMonth: currentDate.toLocaleString('default', { month: 'long', year: 'numeric' })
    });
  }
  break;
```

---

## Step 3: Verify the Fix

After making this change, you should see monthly tasks:

1. **Generate once per month** on the 1st
2. **Visible from the 1st** through the end of the month
3. **Due on the last day** of the month at 11:59 PM
4. **Not regenerate** until the 1st of the next month

---

## Expected Console Output

When tasks generate, you should see logs like:

```
üìÖ MONTHLY task generation for Check the Inventory of Microgreens Stock: {
  visibleFrom: '2025-01-01',
  dueDate: '2025-01-31',
  currentMonth: 'January 2025'
}
```

---

## Testing Checklist

After applying the fix:

1. **Trigger task generation:**
   - Method 1: Wait for automatic daily generation (runs at midnight)
   - Method 2: Manually trigger via API: `POST /api/admin/generate-tasks`

2. **Check the Tasks page:**
   - Navigate to the Tasks page
   - Filter by date: January 1st
   - Verify monthly tasks appear

3. **Check visibility throughout month:**
   - Change date picker to different days in January
   - Monthly tasks should still be visible

4. **Check due date:**
   - Click on a monthly task
   - Verify it shows "Due: January 31st" (or last day of current month)

5. **Complete a task:**
   - Complete one monthly task mid-month (e.g., on the 15th)
   - Verify it marks as completed
   - Verify it doesn't regenerate until February 1st

---

## What This Fix Does

### Before Fix:
- `visibleFromDate`: January 1st
- `dueDate`: January 31st
- **Problem:** Task only showed on January 1st due to date filtering logic

### After Fix:
- `visibleFromDate`: January 1st at 00:00:00
- `dueDate`: January 31st at 23:59:59
- **Result:** Task shows from Jan 1 - Jan 31, due at end of month

---

## Common Questions

**Q: Will this affect existing monthly tasks?**
A: No, this only affects NEW tasks generated after the fix. Existing tasks remain unchanged.

**Q: What if I want to regenerate all monthly tasks?**
A: Delete the existing monthly tasks, then trigger generation again.

**Q: How do I know if a monthly task already exists?**
A: The generation logic checks for duplicates using `visibleFromDate` and `dueDate` matching.

**Q: Can users complete the task on any day of the month?**
A: Yes! The task is visible from the 1st through the last day, so users can complete it anytime.

---

## Rollback Instructions (If Needed)

If you need to revert this change:

**Replace the new code with the original:**

```typescript
case 'monthly':
  if (currentDate.getDate() === 1) {
    shouldGenerate = true;
    dueDate.setMonth(dueDate.getMonth() + 1, 0); // Due on last day of month
  }
  break;
```

---

## Related Files (For Reference - DO NOT EDIT)

These files interact with monthly tasks but DO NOT need changes:

- `/client/src/pages/Tasks.tsx` - Displays tasks (date filtering logic)
- `/client/src/utils/dateUtils.ts` - Date comparison utilities
- `/client/src/pages/RecurringTasks.tsx` - UI for creating recurring tasks

---

## Success Criteria

‚úÖ Monthly tasks generate on the 1st of each month  
‚úÖ Monthly tasks are visible throughout the entire month  
‚úÖ Monthly tasks are due on the last day of the month  
‚úÖ Users can complete monthly tasks on any day of the month  
‚úÖ Tasks don't regenerate until the 1st of the next month  
‚úÖ No duplicate tasks are created  

---

## Additional Notes

- The `visibleFromDate` is set to midnight of the 1st
- The `dueDate` is set to 23:59:59 of the last day of the month
- Console logs will help debug if tasks aren't generating correctly
- The generation loop runs from today to +31 days, so it will catch the 1st even if run mid-month

---

**After applying this fix, proceed to test thoroughly before moving to the next feature (inventory categories).**