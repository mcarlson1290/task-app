# Replit Instructions: Fix Date Display and Duplicate Task Generation

**CRITICAL ISSUES TO FIX:**
1. Always show the actual date, not just "Due Tomorrow"
2. Fix the date calculation that shows "Due Tomorrow" incorrectly
3. Stop generating duplicate tasks for the same period

## Issue 1: Fix Date Display - ALWAYS Show Actual Date

Find where due dates are displayed and update it:

```javascript
// WRONG - This is confusing and often incorrect
const formatDueDate = (dueDate) => {
  if (diffDays === 1) return "Due Tomorrow";
  // etc...
}

// CORRECT - Always show the actual date
const formatDueDate = (dueDateString) => {
  if (!dueDateString) return 'No due date';
  
  const dueDate = new Date(dueDateString);
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  dueDate.setHours(0, 0, 0, 0);
  
  const diffTime = dueDate - today;
  const diffDays = Math.round(diffTime / (1000 * 60 * 60 * 24));
  
  // Format the actual date
  const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
  const month = monthNames[dueDate.getMonth()];
  const day = dueDate.getDate();
  const actualDate = `${month} ${day}`;
  
  // ALWAYS include the actual date
  if (diffDays < 0) {
    return `ðŸ”´ Overdue (${actualDate})`;
  } else if (diffDays === 0) {
    return `ðŸ“… Due today (${actualDate})`;
  } else if (diffDays === 1) {
    return `ðŸ“… Due tomorrow (${actualDate})`; // INCLUDE THE DATE
  } else {
    return `ðŸ“… Due in ${diffDays} days (${actualDate})`;
  }
};
```

## Issue 2: Fix "Due Tomorrow" Calculation Error

The date math is wrong. Fix it properly:

```javascript
// Create a proper date comparison function
const calculateDaysUntilDue = (dueDateString) => {
  // Parse the due date
  const dueDate = new Date(dueDateString);
  
  // Get today at midnight
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  
  // Get due date at midnight
  const dueDateMidnight = new Date(dueDate);
  dueDateMidnight.setHours(0, 0, 0, 0);
  
  // Calculate difference in days
  const msPerDay = 24 * 60 * 60 * 1000;
  const diffDays = Math.floor((dueDateMidnight - today) / msPerDay);
  
  console.log('Date calculation debug:');
  console.log('  Today:', today.toDateString());
  console.log('  Due date:', dueDateMidnight.toDateString());
  console.log('  Difference in days:', diffDays);
  
  return diffDays;
};

// Use in the display function
const formatDueDate = (dueDateString) => {
  const dueDate = new Date(dueDateString);
  const diffDays = calculateDaysUntilDue(dueDateString);
  
  // Get the actual date string
  const options = { month: 'short', day: 'numeric' };
  const dateStr = dueDate.toLocaleDateString('en-US', options);
  
  if (diffDays < 0) {
    return `ðŸ”´ Overdue (${dateStr})`;
  } else if (diffDays === 0) {
    return `ðŸ“… Due today (${dateStr})`;
  } else if (diffDays === 1) {
    return `ðŸ“… Due in 1 day (${dateStr})`; // More clear than "tomorrow"
  } else {
    return `ðŸ“… Due in ${diffDays} days (${dateStr})`;
  }
};
```

## Issue 3: Fix Duplicate Task Generation

Find where tasks are being generated and add proper duplicate checking:

```javascript
// Add a function to check if task already exists for this period
const taskExistsForPeriod = async (recurringTaskId, year, month, period) => {
  const allTasks = await getTasks();
  
  return allTasks.some(task => {
    if (task.recurringTaskId !== recurringTaskId) return false;
    
    const taskDate = new Date(task.visibleFromDate || task.createdDate);
    const taskYear = taskDate.getFullYear();
    const taskMonth = taskDate.getMonth();
    
    // For monthly tasks
    if (task.frequency === 'monthly') {
      return taskYear === year && taskMonth === month;
    }
    
    // For bi-weekly tasks
    if (task.frequency === 'bi-weekly') {
      return taskYear === year && taskMonth === month && task.period === period;
    }
    
    return false;
  });
};

// Update the generation logic to check for duplicates
const generateRecurringTasks = async () => {
  const today = new Date();
  const year = today.getFullYear();
  const month = today.getMonth();
  const dayOfMonth = today.getDate();
  
  const recurringTasks = await getRecurringTasks();
  
  for (const recurringTask of recurringTasks) {
    console.log(`Checking recurring task: ${recurringTask.title} (${recurringTask.frequency})`);
    
    switch (recurringTask.frequency) {
      case 'monthly':
        // Check if task already exists for this month
        if (await taskExistsForPeriod(recurringTask.id, year, month, 'monthly')) {
          console.log('  Monthly task already exists for this month, skipping');
          continue;
        }
        
        // Only generate if we're on or after the 1st
        if (dayOfMonth >= 1) {
          const lastDay = new Date(year, month + 1, 0).getDate();
          await createTask({
            ...recurringTask,
            id: `${recurringTask.id}-${year}-${month}-monthly`,
            recurringTaskId: recurringTask.id,
            visibleFromDate: new Date(year, month, 1, 12, 0, 0).toISOString(),
            dueDate: new Date(year, month, lastDay, 12, 0, 0).toISOString(),
            frequency: 'monthly',
            status: 'pending'
          });
          console.log('  Created monthly task');
        }
        break;
        
      case 'bi-weekly':
        // First half
        if (dayOfMonth >= 1 && dayOfMonth <= 14) {
          if (!(await taskExistsForPeriod(recurringTask.id, year, month, 'first-half'))) {
            await createTask({
              ...recurringTask,
              id: `${recurringTask.id}-${year}-${month}-biweekly-1`,
              recurringTaskId: recurringTask.id,
              visibleFromDate: new Date(year, month, 1, 12, 0, 0).toISOString(),
              dueDate: new Date(year, month, 14, 12, 0, 0).toISOString(),
              frequency: 'bi-weekly',
              period: 'first-half',
              status: 'pending'
            });
            console.log('  Created bi-weekly first half task');
          } else {
            console.log('  Bi-weekly first half already exists, skipping');
          }
        }
        
        // Second half
        if (dayOfMonth >= 15) {
          if (!(await taskExistsForPeriod(recurringTask.id, year, month, 'second-half'))) {
            const lastDay = new Date(year, month + 1, 0).getDate();
            await createTask({
              ...recurringTask,
              id: `${recurringTask.id}-${year}-${month}-biweekly-2`,
              recurringTaskId: recurringTask.id,
              visibleFromDate: new Date(year, month, 15, 12, 0, 0).toISOString(),
              dueDate: new Date(year, month, lastDay, 12, 0, 0).toISOString(),
              frequency: 'bi-weekly',
              period: 'second-half',
              status: 'pending'
            });
            console.log('  Created bi-weekly second half task');
          } else {
            console.log('  Bi-weekly second half already exists, skipping');
          }
        }
        break;
    }
  }
};
```

## Summary for Replit:

**TELL REPLIT EXPLICITLY:**
1. **ALWAYS show the actual date** (Aug 31, Jul 30, etc.) not just "Due Tomorrow"
2. **Fix the date math** - "Due Tomorrow" should only show when it's actually due the next day
3. **Check for existing tasks** before creating new ones - use recurringTaskId + year + month + period to identify duplicates
4. **Add console.log statements** to debug what's happening with dates and task generation

**The user wants to see:** "ðŸ“… Due in 30 days (Aug 31)" not just "Due Tomorrow"