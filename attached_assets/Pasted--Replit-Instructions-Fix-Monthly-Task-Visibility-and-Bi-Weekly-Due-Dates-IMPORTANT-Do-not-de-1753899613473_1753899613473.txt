# Replit Instructions: Fix Monthly Task Visibility and Bi-Weekly Due Dates

**IMPORTANT: Do not delete any existing tasks, recurring tasks, or user data. Only update the code functionality while preserving all existing data.**

## Issues to Fix:
1. Monthly task not showing on August 1st
2. Bi-weekly task showing wrong due date (should be Aug 14, not Aug 2)

## Fix 1: Bi-Weekly Due Date Calculation

```javascript
// Fix bi-weekly task generation
const generateBiWeeklyFirstHalf = async (recurringTask) => {
  const today = new Date();
  const year = today.getFullYear();
  const month = today.getMonth();
  
  const newTask = {
    title: recurringTask.title,
    description: recurringTask.description,
    type: recurringTask.type,
    priority: recurringTask.priority,
    estimatedMinutes: recurringTask.estimatedMinutes,
    checklist: recurringTask.checklist,
    
    // FIXED: Due on the 14th, not tomorrow
    createdDate: today.toISOString(),
    visibleFromDate: new Date(year, month, 1).toISOString(), // Visible from 1st
    dueDate: new Date(year, month, 14).toISOString(),        // Due on 14th
    
    recurringTaskId: recurringTask.id,
    frequency: 'bi-weekly',
    period: 'first-half',
    status: 'pending',
    
    id: `${recurringTask.id}-${year}-${month}-1`
  };
  
  await saveTask(newTask);
  console.log(`Created bi-weekly first half: visible from Aug 1, due Aug 14`);
};

const generateBiWeeklySecondHalf = async (recurringTask) => {
  const today = new Date();
  const year = today.getFullYear();
  const month = today.getMonth();
  const lastDay = new Date(year, month + 1, 0).getDate();
  
  const newTask = {
    title: recurringTask.title,
    description: recurringTask.description,
    type: recurringTask.type,
    priority: recurringTask.priority,
    estimatedMinutes: recurringTask.estimatedMinutes,
    checklist: recurringTask.checklist,
    
    createdDate: today.toISOString(),
    visibleFromDate: new Date(year, month, 15).toISOString(),  // Visible from 15th
    dueDate: new Date(year, month, lastDay).toISOString(),     // Due on last day
    
    recurringTaskId: recurringTask.id,
    frequency: 'bi-weekly',
    period: 'second-half',
    status: 'pending',
    
    id: `${recurringTask.id}-${year}-${month}-2`
  };
  
  await saveTask(newTask);
};
```

## Fix 2: Monthly Task Generation and Visibility

```javascript
// Ensure monthly tasks are generated and visible
const generateMonthlyTask = async (recurringTask) => {
  const today = new Date();
  const year = today.getFullYear();
  const month = today.getMonth();
  const lastDay = new Date(year, month + 1, 0).getDate();
  
  // Check if task already exists
  const taskId = `${recurringTask.id}-${year}-${month}`;
  const existingTask = await getTaskById(taskId);
  
  if (!existingTask) {
    const newTask = {
      title: recurringTask.title,
      description: recurringTask.description,
      type: recurringTask.type,
      priority: recurringTask.priority,
      estimatedMinutes: recurringTask.estimatedMinutes,
      checklist: recurringTask.checklist,
      
      // Dates for monthly task
      createdDate: today.toISOString(),
      visibleFromDate: new Date(year, month, 1).toISOString(),   // Visible from 1st
      dueDate: new Date(year, month, lastDay).toISOString(),     // Due on last day (30th/31st)
      
      recurringTaskId: recurringTask.id,
      frequency: 'monthly',
      status: 'pending',
      
      id: taskId
    };
    
    await saveTask(newTask);
    console.log(`Created monthly task: visible from ${month+1}/1, due ${month+1}/${lastDay}`);
  }
};
```

## Fix 3: Task Filtering to Include All Active Tasks

```javascript
// Update the task loading/filtering logic
const loadTasksForDate = async (viewDate) => {
  const allTasks = await getAllTasks();
  
  // Log for debugging
  console.log(`Loading tasks for ${viewDate.toLocaleDateString()}`);
  console.log(`Total tasks in database: ${allTasks.length}`);
  
  const visibleTasks = allTasks.filter(task => {
    // Skip completed tasks unless showing history
    if (task.status === 'completed') return false;
    
    // Parse dates
    const taskVisibleFrom = task.visibleFromDate ? new Date(task.visibleFromDate) : null;
    const taskDueDate = new Date(task.dueDate);
    
    // For debugging
    if (task.frequency === 'monthly' || task.frequency === 'bi-weekly') {
      console.log(`${task.title}:`);
      console.log(`  - Visible from: ${taskVisibleFrom?.toLocaleDateString()}`);
      console.log(`  - Due: ${taskDueDate.toLocaleDateString()}`);
      console.log(`  - Current view: ${viewDate.toLocaleDateString()}`);
    }
    
    // Check if task should be visible on viewDate
    if (taskVisibleFrom) {
      // Task is visible if viewDate is between visibleFrom and dueDate
      const isVisible = viewDate >= taskVisibleFrom && viewDate <= taskDueDate;
      console.log(`  - Is visible: ${isVisible}`);
      return isVisible;
    }
    
    // Tasks without visibleFromDate are always visible
    return true;
  });
  
  console.log(`Visible tasks: ${visibleTasks.length}`);
  return visibleTasks;
};
```

## Fix 4: Force Generation of Missing Tasks

Add a utility to ensure all tasks for the current month exist:

```javascript
// Run this on app startup or when viewing August 1st
const ensureCurrentMonthTasks = async () => {
  const today = new Date();
  const recurringTasks = await getRecurringTasks();
  
  for (const rt of recurringTasks) {
    if (rt.frequency === 'monthly') {
      // Generate for current month if we're on or after the 1st
      if (today.getDate() >= 1) {
        await generateMonthlyTask(rt);
      }
    }
    
    if (rt.frequency === 'bi-weekly') {
      // Generate first half if we're between 1st and 14th
      if (today.getDate() >= 1 && today.getDate() <= 14) {
        await generateBiWeeklyFirstHalf(rt);
      }
      
      // Generate second half if we're on or after 15th
      if (today.getDate() >= 15) {
        await generateBiWeeklySecondHalf(rt);
      }
    }
  }
  
  // Reload tasks after generation
  await loadTasksForDate(today);
};

// Add button for manual testing
const DebugControls = () => {
  return (
    <button onClick={ensureCurrentMonthTasks}>
      Ensure Current Month Tasks Exist
    </button>
  );
};
```

## Fix 5: Correct Due Date Display

```javascript
const formatDueDate = (dueDateString) => {
  const dueDate = new Date(dueDateString);
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  dueDate.setHours(0, 0, 0, 0);
  
  const diffTime = dueDate - today;
  const diffDays = Math.round(diffTime / (1000 * 60 * 60 * 24));
  
  if (diffDays < 0) {
    return `Overdue by ${Math.abs(diffDays)} days`;
  } else if (diffDays === 0) {
    return 'Due today';
  } else if (diffDays === 1) {
    return 'Due tomorrow';
  } else {
    const month = dueDate.toLocaleString('default', { month: 'short' });
    const day = dueDate.getDate();
    return `Due in ${diffDays} days (${month} ${day})`;
  }
};
```

## Expected Results:
1. **August 1st view should show:**
   - Monthly Safety Inspection - "Due in 29 days (Aug 30)"
   - Bi-Weekly Equipment Check - "Due in 13 days (Aug 14)"

2. **August 15th view should show:**
   - Monthly Safety Inspection - "Due in 15 days (Aug 30)"
   - Bi-Weekly Equipment Check (2nd) - "Due in 15 days (Aug 30)"

## Testing:
1. Click "Ensure Current Month Tasks Exist" button
2. Set date to August 1st
3. Both tasks should appear with correct due dates
4. Check console logs to see what's being filtered