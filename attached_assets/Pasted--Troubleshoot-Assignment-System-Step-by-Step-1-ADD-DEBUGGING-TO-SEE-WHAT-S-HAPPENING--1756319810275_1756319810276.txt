# üîç Troubleshoot Assignment System - Step by Step

## 1. ADD DEBUGGING TO SEE WHAT'S HAPPENING

First, let's add extensive logging to identify where the breakdown is:

```javascript
// In your TaskCard component, add this debug section
const TaskCard = ({ task, currentUser, staff }) => {
  
  // Debug function with detailed logging
  const isAssignedToMe = () => {
    console.group(`Checking assignment for task: ${task.title}`);
    console.log('Task assignTo:', task.assignTo);
    console.log('Current user:', currentUser);
    console.log('Current user ID:', currentUser?.id);
    console.log('Current user roles:', currentUser?.rolesAssigned);
    
    if (!currentUser || !task.assignTo) {
      console.log('No current user or no assignment');
      console.groupEnd();
      return false;
    }
    
    // Direct user assignment
    if (task.assignTo.startsWith('user_')) {
      const assignedId = parseInt(task.assignTo.replace('user_', ''));
      const isMatch = assignedId === currentUser.id;
      console.log(`Direct assignment check: ${assignedId} === ${currentUser.id} = ${isMatch}`);
      console.groupEnd();
      return isMatch;
    }
    
    // All staff
    if (task.assignTo === 'all_staff') {
      const isStaff = currentUser.id !== null && currentUser.id !== undefined;
      console.log(`All staff check: user has ID = ${isStaff}`);
      console.groupEnd();
      return isStaff;
    }
    
    // Role assignment
    if (task.assignTo.startsWith('role_')) {
      const roleName = task.assignTo.replace('role_', '');
      const hasRole = currentUser.rolesAssigned?.includes(roleName);
      console.log(`Role check: looking for "${roleName}" in`, currentUser.rolesAssigned);
      console.log(`Has role: ${hasRole}`);
      console.groupEnd();
      return hasRole || false;
    }
    
    console.log('Unknown assignment format');
    console.groupEnd();
    return false;
  };
  
  const assignedToMe = isAssignedToMe();
  
  // Temporary: Show assignment info on card
  return (
    <div className={`task-card ${assignedToMe ? 'assigned-to-me' : ''}`}>
      {/* Debug info - remove after fixing */}
      <div style={{ 
        fontSize: '10px', 
        background: '#f3f4f6', 
        padding: '4px', 
        marginBottom: '8px' 
      }}>
        Assigned to: {task.assignTo} | 
        You: {currentUser?.email} (ID: {currentUser?.id}) | 
        Match: {assignedToMe ? '‚úÖ' : '‚ùå'}
      </div>
      
      {/* Rest of card */}
    </div>
  );
};
```

## 2. VERIFY CURRENT USER IS LOADING CORRECTLY

Add debugging to the CurrentUserProvider:

```javascript
export const CurrentUserProvider = ({ children }) => {
  const [currentUser, setCurrentUser] = useState(null);
  const [loading, setLoading] = useState(true);
  
  const loadCurrentUser = async () => {
    try {
      console.log('=== LOADING CURRENT USER ===');
      
      // Get auth user email - UPDATE THIS BASED ON YOUR AUTH
      // Option A: Microsoft Auth
      // const authUser = await getUserFromMicrosoftAuth();
      // const userEmail = authUser.email;
      
      // Option B: Mock for testing
      const userEmail = localStorage.getItem('mockUserEmail') || 'robert@growspace.farm';
      console.log('Auth email:', userEmail);
      
      // Load staff data
      const staffResponse = await fetch('/api/staff');
      const staffData = await staffResponse.json();
      console.log('All staff:', staffData);
      
      // Find user in staff
      const staffMember = staffData.find(s => 
        s.email?.toLowerCase() === userEmail?.toLowerCase()
      );
      
      if (staffMember) {
        console.log('Found staff member:', staffMember);
        setCurrentUser({
          id: staffMember.id,
          email: staffMember.email,
          fullName: staffMember.fullName,
          rolesAssigned: staffMember.rolesAssigned || []
        });
      } else {
        console.error('Staff member not found for email:', userEmail);
        console.log('Available emails:', staffData.map(s => s.email));
      }
    } catch (error) {
      console.error('Error loading current user:', error);
    } finally {
      setLoading(false);
    }
  };
  
  useEffect(() => {
    loadCurrentUser();
  }, []);
  
  return (
    <CurrentUserContext.Provider value={{ currentUser, loading, refresh: loadCurrentUser }}>
      {children}
    </CurrentUserContext.Provider>
  );
};
```

## 3. CREATE A DEBUG PANEL

Add this temporary debug panel to your Tasks page:

```javascript
// Add this component to your Tasks page
const DebugPanel = ({ currentUser, filters, tasks, filteredTasks, staff }) => {
  const [showDebug, setShowDebug] = useState(true);
  
  if (!showDebug) {
    return (
      <button 
        onClick={() => setShowDebug(true)}
        style={{ 
          position: 'fixed', 
          bottom: 10, 
          right: 10,
          padding: '10px',
          background: '#2D8028',
          color: 'white',
          borderRadius: '4px',
          border: 'none',
          cursor: 'pointer'
        }}
      >
        Show Debug
      </button>
    );
  }
  
  return (
    <div style={{
      position: 'fixed',
      bottom: 10,
      right: 10,
      width: '400px',
      maxHeight: '300px',
      overflow: 'auto',
      background: 'white',
      border: '2px solid #e5e7eb',
      borderRadius: '8px',
      padding: '12px',
      fontSize: '12px',
      boxShadow: '0 2px 8px rgba(0,0,0,0.1)',
      zIndex: 1000
    }}>
      <button 
        onClick={() => setShowDebug(false)}
        style={{ float: 'right', cursor: 'pointer' }}
      >
        ‚úï
      </button>
      
      <h4>Debug Info</h4>
      
      <div style={{ marginTop: '10px' }}>
        <strong>Current User:</strong>
        <pre style={{ background: '#f3f4f6', padding: '4px', fontSize: '10px' }}>
          {JSON.stringify(currentUser, null, 2)}
        </pre>
      </div>
      
      <div style={{ marginTop: '10px' }}>
        <strong>Active Filters:</strong>
        <pre style={{ background: '#f3f4f6', padding: '4px', fontSize: '10px' }}>
          {JSON.stringify(filters, null, 2)}
        </pre>
      </div>
      
      <div style={{ marginTop: '10px' }}>
        <strong>Task Count:</strong> {filteredTasks.length} / {tasks.length}
      </div>
      
      <div style={{ marginTop: '10px' }}>
        <strong>Sample Task Assignments:</strong>
        {tasks.slice(0, 3).map(task => (
          <div key={task.id} style={{ marginTop: '4px' }}>
            {task.title}: {task.assignTo}
          </div>
        ))}
      </div>
      
      <div style={{ marginTop: '10px' }}>
        <button 
          onClick={() => {
            console.log('All tasks:', tasks);
            console.log('All staff:', staff);
            console.log('Current user:', currentUser);
          }}
          style={{
            padding: '4px 8px',
            background: '#2D8028',
            color: 'white',
            border: 'none',
            borderRadius: '4px',
            cursor: 'pointer'
          }}
        >
          Log All Data to Console
        </button>
      </div>
    </div>
  );
};

// Use it in TasksPage
return (
  <div className="tasks-page">
    {/* Your existing UI */}
    
    <DebugPanel 
      currentUser={currentUser}
      filters={filters}
      tasks={tasks}
      filteredTasks={filteredTasks}
      staff={staff}
    />
  </div>
);
```

## 4. CHECK FOR COMMON ISSUES

Run these checks in your browser console:

```javascript
// Check 1: Verify staff data structure
fetch('/api/staff').then(r => r.json()).then(staff => {
  console.log('=== STAFF DATA CHECK ===');
  staff.forEach(s => {
    console.log(`${s.fullName}: ID=${s.id} (type: ${typeof s.id}), Email=${s.email}, Roles=${s.rolesAssigned}`);
  });
});

// Check 2: Verify task assignments
fetch('/api/tasks').then(r => r.json()).then(tasks => {
  console.log('=== TASK ASSIGNMENTS ===');
  const assignments = {};
  tasks.forEach(t => {
    assignments[t.assignTo] = (assignments[t.assignTo] || 0) + 1;
  });
  console.table(assignments);
});

// Check 3: Test the matching logic manually
const testMatch = (assignTo, userId, userRoles) => {
  console.log(`Testing: ${assignTo} for user ${userId} with roles ${userRoles}`);
  
  if (assignTo === `user_${userId}`) {
    console.log('‚úÖ Direct match');
    return true;
  }
  
  if (assignTo === 'all_staff') {
    console.log('‚úÖ All staff match');
    return true;
  }
  
  if (assignTo.startsWith('role_')) {
    const role = assignTo.replace('role_', '');
    if (userRoles.includes(role)) {
      console.log('‚úÖ Role match');
      return true;
    }
  }
  
  console.log('‚ùå No match');
  return false;
};

// Example test
testMatch('role_Equipment Tech', 1, ['Equipment Tech', 'Manager']);
```

## 5. FIX AUTHENTICATION INTEGRATION

If you're using Microsoft auth, make sure to properly get the user:

```javascript
// For Microsoft Auth integration
const getUserFromMicrosoftAuth = async () => {
  // If using MSAL
  const accounts = msalInstance.getAllAccounts();
  if (accounts.length > 0) {
    return {
      email: accounts[0].username, // or accounts[0].mail
      displayName: accounts[0].name
    };
  }
  
  // If user not found, might need to acquire token
  try {
    const response = await msalInstance.acquireTokenSilent({
      scopes: ["User.Read"],
      account: accounts[0]
    });
    
    // Use Microsoft Graph to get user details
    const userResponse = await fetch('https://graph.microsoft.com/v1.0/me', {
      headers: {
        'Authorization': `Bearer ${response.accessToken}`
      }
    });
    
    const userData = await userResponse.json();
    return {
      email: userData.mail || userData.userPrincipalName,
      displayName: userData.displayName
    };
  } catch (error) {
    console.error('Auth error:', error);
  }
};
```

## Common Issues to Check:

1. **ID Type Mismatch**: Staff IDs might be strings but compared as numbers
   - Fix: Use `parseInt()` consistently or store as same type

2. **Email Case Sensitivity**: Emails might not match due to case
   - Fix: Always use `.toLowerCase()` when comparing

3. **Missing Roles**: Staff might not have roles assigned
   - Fix: Ensure roles are saved when editing staff

4. **Auth User Not in Staff**: Logged in user might not exist in staff data
   - Fix: Add all users to staff or handle gracefully

The debug panel and console logs should reveal exactly where the breakdown is occurring.