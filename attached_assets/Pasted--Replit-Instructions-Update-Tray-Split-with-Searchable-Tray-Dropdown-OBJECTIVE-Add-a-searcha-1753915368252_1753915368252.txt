# Replit Instructions: Update Tray Split with Searchable Tray Dropdown

**OBJECTIVE: Add a searchable dropdown to select which active tray to split.**

## Step 1: Create Tray Management Functions

First, we need functions to get all active trays:

```javascript
// src/services/trayService.js
export const TrayService = {
  // Get all active trays (not split, not harvested)
  getActiveTrays() {
    const trays = JSON.parse(localStorage.getItem('productionTrays') || '[]');
    
    // Filter for active trays only
    return trays.filter(tray => 
      tray.status === 'active' || 
      tray.status === 'growing' ||
      !tray.status // Default to active if no status
    ).filter(tray => 
      !tray.harvestedAt && 
      !tray.splitFrom // Don't show trays that are already splits
    );
  },
  
  // Search trays by ID or crop type
  searchTrays(searchTerm) {
    const activeTrays = this.getActiveTrays();
    const term = searchTerm.toLowerCase();
    
    return activeTrays.filter(tray => 
      tray.id.toLowerCase().includes(term) ||
      tray.cropType?.toLowerCase().includes(term) ||
      tray.cropName?.toLowerCase().includes(term)
    );
  },
  
  // Split a tray into multiple
  splitTray(originalTrayId, splitCount) {
    const trays = JSON.parse(localStorage.getItem('productionTrays') || '[]');
    const originalTray = trays.find(t => t.id === originalTrayId);
    
    if (!originalTray) return null;
    
    // Create split trays
    const splitTrays = [];
    for (let i = 1; i <= splitCount; i++) {
      splitTrays.push({
        ...originalTray,
        id: `${originalTrayId}-${i}`,
        splitFrom: originalTrayId,
        splitNumber: i,
        splitTotal: splitCount,
        createdAt: new Date().toISOString(),
        // Reset location as splits need to be assigned
        location: null,
        systemId: null
      });
    }
    
    // Mark original tray as split
    originalTray.status = 'split';
    originalTray.splitInto = splitTrays.map(t => t.id);
    originalTray.splitAt = new Date().toISOString();
    
    // Save all changes
    localStorage.setItem('productionTrays', JSON.stringify(trays));
    
    // Add new split trays
    const updatedTrays = [...trays, ...splitTrays];
    localStorage.setItem('productionTrays', JSON.stringify(updatedTrays));
    
    return splitTrays;
  }
};
```

## Step 2: Create Searchable Dropdown Component

```javascript
// src/components/common/SearchableDropdown.jsx
import React, { useState, useEffect, useRef } from 'react';

const SearchableDropdown = ({ 
  options, 
  value, 
  onChange, 
  placeholder = "Search...",
  displayField = "label",
  valueField = "value",
  renderOption = null 
}) => {
  const [isOpen, setIsOpen] = useState(false);
  const [searchTerm, setSearchTerm] = useState('');
  const [filteredOptions, setFilteredOptions] = useState(options);
  const dropdownRef = useRef(null);
  
  useEffect(() => {
    // Filter options based on search
    const filtered = options.filter(option => {
      const searchFields = [
        option[displayField],
        option[valueField],
        option.id,
        option.cropType,
        option.cropName
      ].filter(Boolean);
      
      return searchFields.some(field => 
        field.toString().toLowerCase().includes(searchTerm.toLowerCase())
      );
    });
    
    setFilteredOptions(filtered);
  }, [searchTerm, options, displayField, valueField]);
  
  // Close dropdown when clicking outside
  useEffect(() => {
    const handleClickOutside = (event) => {
      if (dropdownRef.current && !dropdownRef.current.contains(event.target)) {
        setIsOpen(false);
      }
    };
    
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, []);
  
  const selectedOption = options.find(opt => opt[valueField] === value);
  
  return (
    <div className="searchable-dropdown" ref={dropdownRef}>
      <div 
        className="dropdown-header"
        onClick={() => setIsOpen(!isOpen)}
      >
        <span className="selected-value">
          {selectedOption ? selectedOption[displayField] : placeholder}
        </span>
        <span className="dropdown-arrow">{isOpen ? '▲' : '▼'}</span>
      </div>
      
      {isOpen && (
        <div className="dropdown-content">
          <input
            type="text"
            className="dropdown-search"
            placeholder="Search trays..."
            value={searchTerm}
            onChange={(e) => setSearchTerm(e.target.value)}
            onClick={(e) => e.stopPropagation()}
            autoFocus
          />
          
          <div className="dropdown-options">
            {filteredOptions.length === 0 ? (
              <div className="no-options">No trays found</div>
            ) : (
              filteredOptions.map((option) => (
                <div
                  key={option[valueField]}
                  className={`dropdown-option ${value === option[valueField] ? 'selected' : ''}`}
                  onClick={() => {
                    onChange(option[valueField]);
                    setIsOpen(false);
                    setSearchTerm('');
                  }}
                >
                  {renderOption ? renderOption(option) : option[displayField]}
                </div>
              ))
            )}
          </div>
        </div>
      )}
    </div>
  );
};

export default SearchableDropdown;
```

## Step 3: Update Tray Split Component

```javascript
// src/components/checklist/TraySplitStep.jsx
import React, { useState, useEffect } from 'react';
import SearchableDropdown from '../common/SearchableDropdown';
import { TrayService } from '../../services/trayService';

const TraySplitStep = ({ step, value, onChange }) => {
  const [activeTrays, setActiveTrays] = useState([]);
  const [selectedTray, setSelectedTray] = useState(value?.trayId || '');
  const [splitCount, setSplitCount] = useState(value?.count || 3);
  
  useEffect(() => {
    // Load active trays
    const trays = TrayService.getActiveTrays();
    setActiveTrays(trays);
  }, []);
  
  const handleTraySelect = (trayId) => {
    setSelectedTray(trayId);
    updateValue(trayId, splitCount);
  };
  
  const handleSplitCountChange = (count) => {
    const newCount = parseInt(count) || 2;
    setSplitCount(newCount);
    updateValue(selectedTray, newCount);
  };
  
  const updateValue = (trayId, count) => {
    if (!trayId) return;
    
    const tray = activeTrays.find(t => t.id === trayId);
    if (!tray) return;
    
    // Generate split preview
    const splits = [];
    for (let i = 1; i <= count; i++) {
      splits.push({
        id: `${trayId}-${i}`,
        label: `Split ${i}`,
        parentId: trayId,
        cropType: tray.cropType,
        cropName: tray.cropName
      });
    }
    
    onChange({
      trayId: trayId,
      count: count,
      splits: splits,
      originalTray: tray
    });
  };
  
  // Custom render for tray options
  const renderTrayOption = (tray) => (
    <div className="tray-option">
      <span className="tray-id">{tray.id}</span>
      <span className="tray-details">
        {tray.cropName || tray.cropType} 
        {tray.datePlanted && ` - Planted: ${new Date(tray.datePlanted).toLocaleDateString()}`}
      </span>
    </div>
  );
  
  return (
    <div className="tray-split-step">
      <div className="step-description">
        {step.label || 'Select a tray to split into multiple portions'}
      </div>
      
      <div className="tray-selection">
        <label>Select Tray:</label>
        <SearchableDropdown
          options={activeTrays}
          value={selectedTray}
          onChange={handleTraySelect}
          placeholder="Search by tray ID or crop..."
          displayField="id"
          valueField="id"
          renderOption={renderTrayOption}
        />
      </div>
      
      {selectedTray && (
        <>
          <div className="split-controls">
            <label>Number of splits:</label>
            <input
              type="number"
              min="2"
              max="10"
              value={splitCount}
              onChange={(e) => handleSplitCountChange(e.target.value)}
              className="split-count-input"
            />
            <span className="split-hint">(2-10 splits allowed)</span>
          </div>
          
          <div className="split-preview">
            <h4>This will create {splitCount} new trays from {selectedTray}:</h4>
            <div className="split-list">
              {Array.from({ length: splitCount }, (_, i) => (
                <div key={i} className="split-item">
                  <span className="split-id">{selectedTray}-{i + 1}</span>
                  <span className="split-label">Split {i + 1}</span>
                </div>
              ))}
            </div>
            <p className="split-note">
              Original tray {selectedTray} will be marked as split and archived.
            </p>
          </div>
        </>
      )}
    </div>
  );
};

export default TraySplitStep;
```

## Step 4: Add Styling

```css
/* Searchable Dropdown Styles */
.searchable-dropdown {
  position: relative;
  width: 100%;
}

.dropdown-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 12px;
  border: 1px solid #d1d5db;
  border-radius: 6px;
  background: white;
  cursor: pointer;
  min-height: 42px;
}

.dropdown-header:hover {
  border-color: #9ca3af;
}

.selected-value {
  flex: 1;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.dropdown-arrow {
  margin-left: 8px;
  color: #6b7280;
  font-size: 12px;
}

.dropdown-content {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  margin-top: 4px;
  background: white;
  border: 1px solid #d1d5db;
  border-radius: 6px;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  z-index: 1000;
  max-height: 300px;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

.dropdown-search {
  padding: 10px 12px;
  border: none;
  border-bottom: 1px solid #e5e7eb;
  outline: none;
  font-size: 14px;
}

.dropdown-options {
  flex: 1;
  overflow-y: auto;
}

.dropdown-option {
  padding: 10px 12px;
  cursor: pointer;
  transition: background 0.2s;
}

.dropdown-option:hover {
  background: #f3f4f6;
}

.dropdown-option.selected {
  background: #e0f2fe;
  font-weight: 500;
}

.no-options {
  padding: 20px;
  text-align: center;
  color: #6b7280;
}

/* Tray Option Display */
.tray-option {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.tray-id {
  font-weight: 500;
  font-family: monospace;
  font-size: 14px;
}

.tray-details {
  font-size: 12px;
  color: #6b7280;
}

/* Tray Split Specific */
.tray-selection {
  margin: 16px 0;
}

.split-preview {
  background: #f9fafb;
  border: 1px solid #e5e7eb;
  border-radius: 6px;
  padding: 16px;
  margin-top: 16px;
}

.split-list {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 8px;
  margin: 12px 0;
}

.split-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 12px;
  background: white;
  border: 1px solid #e5e7eb;
  border-radius: 4px;
}

.split-id {
  font-family: monospace;
  font-weight: 500;
  color: #1f2937;
}

.split-note {
  margin-top: 12px;
  font-size: 13px;
  color: #6b7280;
  font-style: italic;
}
```

## Expected Result:

1. **Searchable Dropdown** shows all active trays
2. **Search works** on tray ID, crop type, and crop name
3. **Preview shows** the split tray IDs that will be created
4. **Hundreds of trays** are manageable with the search feature
5. **Selected tray info** is passed to the next step (System Assignment)

The searchable dropdown makes it easy to find the right tray among hundreds, and the preview clearly shows what will happen when the split is executed!