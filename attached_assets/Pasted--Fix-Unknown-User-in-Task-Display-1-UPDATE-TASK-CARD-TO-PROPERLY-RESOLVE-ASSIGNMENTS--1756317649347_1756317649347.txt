# ðŸ”§ Fix "Unknown User" in Task Display

## 1. UPDATE TASK CARD TO PROPERLY RESOLVE ASSIGNMENTS

In your Task Card component, update the assignment display logic:

```javascript
// In your TaskCard component
const TaskCard = ({ task, currentUser, staff = [] }) => {
  
  // Function to get assignment display text
  const getAssignmentDisplay = () => {
    if (!task.assignTo) return 'Unassigned';
    
    // Handle "all_staff" assignment
    if (task.assignTo === 'all_staff') {
      return 'ðŸ‘¥ All Staff';
    }
    
    // Handle role assignment
    if (task.assignTo.startsWith('role_')) {
      const roleName = task.assignTo.replace('role_', '');
      return `ðŸ‘¤ ${roleName}`;
    }
    
    // Handle user assignment
    if (task.assignTo.startsWith('user_')) {
      const userId = parseInt(task.assignTo.replace('user_', ''));
      const user = staff.find(s => s.id === userId);
      return user ? user.fullName : 'Unknown User';
    }
    
    // Legacy format - if it's just a name or ID
    const user = staff.find(s => 
      s.fullName === task.assignTo || 
      s.id === parseInt(task.assignTo)
    );
    
    return user ? user.fullName : task.assignTo;
  };
  
  return (
    <div className="task-card">
      {/* Other task content */}
      
      <div className="task-assignment">
        <span className="assigned-to-label">Assigned to:</span>
        <span className="assigned-to-value">{getAssignmentDisplay()}</span>
      </div>
      
      {/* Rest of card */}
    </div>
  );
};
```

## 2. ENSURE TASKS PAGE LOADS STAFF DATA

In your main Tasks page, make sure staff data is loaded:

```javascript
const TasksPage = ({ currentUser }) => {
  const [tasks, setTasks] = useState([]);
  const [staff, setStaff] = useState([]);
  const [loading, setLoading] = useState(true);
  
  useEffect(() => {
    // Load both tasks and staff data
    Promise.all([
      loadTasks(),
      loadStaff()
    ]).then(() => {
      setLoading(false);
    });
  }, []);
  
  const loadTasks = async () => {
    try {
      const response = await fetch('/api/tasks');
      const data = await response.json();
      setTasks(data);
    } catch (error) {
      console.error('Error loading tasks:', error);
    }
  };
  
  const loadStaff = async () => {
    try {
      const response = await fetch('/api/staff');
      const data = await response.json();
      setStaff(data);
    } catch (error) {
      console.error('Error loading staff:', error);
    }
  };
  
  if (loading) {
    return <div>Loading...</div>;
  }
  
  return (
    <div className="tasks-page">
      {/* Filters, etc */}
      
      <div className="task-grid">
        {filteredTasks.map(task => (
          <TaskCard 
            key={task.id} 
            task={task}
            currentUser={currentUser}
            staff={staff} // Pass staff data to each card
          />
        ))}
      </div>
    </div>
  );
};
```

## 3. FIX TASK GENERATION FROM RECURRING TASKS

Update how recurring tasks create daily tasks to ensure proper assignment format:

```javascript
// In your task generation function (backend or wherever tasks are created from recurring)
const generateDailyTasksFromRecurring = async () => {
  const recurringTasks = await readData('recurring-tasks.json');
  const today = new Date().toISOString().split('T')[0];
  const newTasks = [];
  
  recurringTasks.forEach(recurring => {
    // Check if this task should run today based on frequency
    if (shouldRunToday(recurring.frequency)) {
      const newTask = {
        id: Date.now() + Math.random(), // Ensure unique ID
        title: recurring.title,
        description: recurring.description,
        taskType: recurring.taskType,
        priority: recurring.priority || 'Medium',
        assignTo: recurring.assignTo || '', // Pass the assignment exactly as stored
        dueDate: today,
        status: 'pending',
        createdFrom: recurring.id,
        createdAt: new Date().toISOString(),
        // Copy any other needed fields
      };
      
      newTasks.push(newTask);
    }
  });
  
  // Save all new tasks
  if (newTasks.length > 0) {
    const existingTasks = await readData('tasks.json');
    await saveData('tasks.json', [...existingTasks, ...newTasks]);
  }
  
  return newTasks;
};
```

## 4. ADD DEBUGGING TO FIND THE ISSUE

Add temporary debugging to see what's happening:

```javascript
// In your TaskCard component, add logging
const getAssignmentDisplay = () => {
  console.log('Task assignment:', task.assignTo);
  console.log('Available staff:', staff);
  
  if (!task.assignTo) return 'Unassigned';
  
  // ... rest of the function
};

// In your browser console, check:
// 1. What format is task.assignTo in?
// 2. Is staff data loaded?
// 3. Do the IDs match?
```

## 5. QUICK FIX - ADD FALLBACK DISPLAY

As a temporary fix while debugging, improve the unknown user display:

```javascript
const getAssignmentDisplay = () => {
  if (!task.assignTo) return 'Unassigned';
  
  // All your existing logic...
  
  // Better fallback
  if (task.assignTo.startsWith('user_')) {
    const userId = task.assignTo.replace('user_', '');
    return `User #${userId} (Not Found)`;
  }
  
  if (task.assignTo.startsWith('role_')) {
    const roleName = task.assignTo.replace('role_', '');
    return `ðŸ‘¤ ${roleName}`;
  }
  
  // Final fallback
  return task.assignTo || 'Unknown Assignment';
};
```

## 6. VERIFY DATA CONSISTENCY

Run these checks in your browser console:

```javascript
// Check a specific task
const task = // get a task showing "Unknown User"
console.log('Task assignTo:', task.assignTo);

// Check staff data
fetch('/api/staff').then(r => r.json()).then(staff => {
  console.log('Staff IDs:', staff.map(s => ({ id: s.id, name: s.fullName })));
});

// Check recurring task assignments
fetch('/api/recurring-tasks').then(r => r.json()).then(recurring => {
  console.log('Recurring assignments:', recurring.map(r => ({ 
    title: r.title, 
    assignTo: r.assignTo 
  })));
});
```

## Common Issues and Solutions:

1. **ID Type Mismatch**: Staff ID might be stored as number but compared as string
   - Solution: Use `parseInt()` when comparing IDs

2. mysterious **Missing Staff Data**: Staff not loaded when tasks display
   - Solution: Ensure staff loads before rendering tasks

3. **Wrong Assignment Format**: Recurring task saving in different format
   - Solution: Standardize to `user_123` or `role_RoleName` format

4. **Stale Data**: Old tasks have different assignment format
   - Solution: Add migration to update old task assignments

The most likely issue is that staff data isn't being passed to the TaskCard component or there's a mismatch in the ID format. Check the console logs to see exactly what's stored in `task.assignTo` for the affected tasks.