# Fix Inventory Step Saving + Add Multi-Item Tracking

## Problem 1: Task Won't Save with Inventory Step

The recurring task won't save when an inventory step is added. This is likely due to validation errors or missing required fields.

## Problem 2: Need Multiple Items in One Step

Instead of creating 100 separate inventory steps, users should be able to add multiple items within a single step (e.g., "Seeds: 2oz, pH Down: 50ml, Rockwool: 10 cubes").

---

## Fix 1: Allow Task to Save with Inventory Step

**File:** Find where recurring task validation happens (likely in RecurringTaskModal.tsx or similar)

### Find the validation code that's blocking save:

**Look for code like this:**
```typescript
const isValid = () => {
  // Check if all required fields are filled
  if (!title || !frequency) return false;
  
  // Check checklist steps
  if (checklist.some(step => !step.itemName || !step.quantity)) {
    return false; // THIS IS BLOCKING THE SAVE
  }
  
  return true;
};
```

### Fix the validation:

**REPLACE WITH:**
```typescript
const isValid = () => {
  // Check if all required fields are filled
  if (!title || !frequency) return false;
  
  // Check checklist steps - but allow inventory steps to be partially configured
  const invalidSteps = checklist.filter(step => {
    // Inventory steps can be saved even if not fully configured
    if (step.type === 'inventory-usage') {
      // Only require that at least ONE item is selected
      return !step.items || step.items.length === 0;
    }
    
    // Other step types need their required fields
    return false; // Adjust based on your other step types
  });
  
  if (invalidSteps.length > 0) return false;
  
  return true;
};
```

---

## Fix 2: Add Multi-Item Tracking to Inventory Step

Update the inventory step to support multiple items in a single step.

### Change the Data Structure

**CURRENT (single item):**
```typescript
{
  type: "inventory-usage",
  inventoryItemId: 12,
  itemName: "Broccoli Seeds",
  unit: "oz",
  quantity: 2
}
```

**NEW (multiple items):**
```typescript
{
  type: "inventory-usage",
  stepLabel: "Track materials used", // Optional custom label
  items: [
    { inventoryItemId: 12, itemName: "Broccoli Seeds", unit: "oz", quantity: 2 },
    { inventoryItemId: 5, itemName: "pH Down", unit: "ml", quantity: 50 },
    { inventoryItemId: 8, itemName: "Rockwool Cubes", unit: "cubes", quantity: 10 }
  ]
}
```

---

## Fix 3: Update the UI for Multi-Item Selection

**File:** ChecklistBuilder.tsx or RecurringTaskModal.tsx (wherever the inventory step config is)

### Replace the single item selection with a multi-item list:

```tsx
{/* Inventory Selection Step */}
<div className="space-y-4">
  <h4 className="font-semibold">Inventory Usage Step Configuration</h4>
  
  {/* Custom Step Label */}
  <div className="space-y-2">
    <Label>Step Label (Optional)</Label>
    <Input
      placeholder="e.g., Record materials used for seeding"
      value={step.stepLabel || ''}
      onChange={(e) => updateStep({
        ...step,
        stepLabel: e.target.value
      })}
    />
    <p className="text-xs text-gray-500">
      This is what the user will see when completing the task
    </p>
  </div>
  
  {/* List of Items Being Tracked */}
  <div className="space-y-2">
    <Label>Items to Track</Label>
    
    {/* Show current items */}
    {step.items && step.items.length > 0 && (
      <div className="space-y-2">
        {step.items.map((item, idx) => (
          <div key={idx} className="flex items-center gap-2 p-3 bg-gray-50 rounded-lg">
            <div className="flex-1">
              <div className="font-medium">{item.itemName}</div>
              <div className="text-sm text-gray-500">
                Default: {item.quantity} {item.unit}
              </div>
            </div>
            <Button
              type="button"
              variant="ghost"
              size="sm"
              onClick={() => {
                const newItems = step.items.filter((_, i) => i !== idx);
                updateStep({ ...step, items: newItems });
              }}
            >
              üóëÔ∏è Remove
            </Button>
          </div>
        ))}
      </div>
    )}
    
    {/* Add New Item Section */}
    <div className="border-2 border-dashed border-gray-300 rounded-lg p-4 space-y-3">
      <h5 className="font-medium text-sm">Add Item to Track</h5>
      
      {/* Select Inventory Item */}
      <div className="space-y-2">
        <Label>Select Item</Label>
        <Select
          value={newItem.inventoryItemId?.toString() || ''}
          onValueChange={(value) => {
            const item = inventoryOptions.find(opt => opt.id.toString() === value);
            setNewItem({
              inventoryItemId: parseInt(value),
              itemName: item?.name || '',
              unit: item?.unit || '',
              quantity: 0
            });
          }}
        >
          <SelectTrigger>
            <SelectValue placeholder="Search inventory items..." />
          </SelectTrigger>
          <SelectContent>
            {inventoryOptions.map((item) => (
              <SelectItem key={item.id} value={item.id.toString()}>
                <div className="flex justify-between items-center w-full">
                  <span>{item.name}</span>
                  <span className="text-xs text-gray-500 ml-2">
                    ({item.currentStock} {item.unit})
                  </span>
                </div>
              </SelectItem>
            ))}
          </SelectContent>
        </Select>
      </div>
      
      {/* Enter Default Quantity */}
      <div className="space-y-2">
        <Label>
          Default Quantity (Optional)
          {newItem.unit && (
            <span className="text-gray-500 text-sm ml-2">({newItem.unit})</span>
          )}
        </Label>
        <Input
          type="number"
          min="0"
          step="0.1"
          placeholder="User will enter during task if left blank"
          value={newItem.quantity || ''}
          onChange={(e) => setNewItem({
            ...newItem,
            quantity: parseFloat(e.target.value) || 0
          })}
        />
        <p className="text-xs text-gray-500">
          Pre-fill this if the amount is always the same. Leave blank if it varies.
        </p>
      </div>
      
      {/* Add Item Button */}
      <Button
        type="button"
        variant="outline"
        className="w-full"
        onClick={() => {
          if (!newItem.inventoryItemId) {
            alert('Please select an inventory item first');
            return;
          }
          
          // Add item to the list
          const updatedItems = [...(step.items || []), newItem];
          updateStep({ ...step, items: updatedItems });
          
          // Reset the form
          setNewItem({
            inventoryItemId: null,
            itemName: '',
            unit: '',
            quantity: 0
          });
        }}
        disabled={!newItem.inventoryItemId}
      >
        ‚ûï Add Item to List
      </Button>
    </div>
    
    {/* Help Text */}
    {(!step.items || step.items.length === 0) && (
      <p className="text-sm text-gray-500">
        Add all inventory items that will be tracked in this step. Users will enter actual quantities when completing the task.
      </p>
    )}
  </div>
</div>
```

---

## Fix 4: Add State for New Item Form

**Add this state at the top of the component:**

```typescript
// State for adding new inventory item
const [newItem, setNewItem] = useState({
  inventoryItemId: null,
  itemName: '',
  unit: '',
  quantity: 0
});
```

---

## Fix 5: Update Task Execution (When User Completes Task)

When a user completes a task with this inventory step, show ALL items at once:

```tsx
{/* During Task Execution - ChecklistExecution.tsx */}
{step.type === 'inventory-usage' && (
  <div className="space-y-4">
    <h4 className="font-semibold">
      {step.stepLabel || 'Record Inventory Used'}
    </h4>
    
    {/* Show all items */}
    {step.items.map((item, idx) => (
      <div key={idx} className="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
        <div className="flex-1">
          <div className="font-medium">{item.itemName}</div>
          <div className="text-sm text-gray-500">Current: {item.currentStock} {item.unit}</div>
        </div>
        
        <div className="w-32">
          <Input
            type="number"
            min="0"
            step="0.1"
            placeholder={item.quantity ? item.quantity.toString() : "0"}
            defaultValue={item.quantity || ''}
            onChange={(e) => {
              // Update the quantity for this item
              updateInventoryUsage(item.inventoryItemId, parseFloat(e.target.value) || 0);
            }}
          />
        </div>
        
        <span className="text-sm text-gray-500 w-12">{item.unit}</span>
      </div>
    ))}
  </div>
)}
```

---

## Fix 6: Save Multiple Items When Task Completes

When the task is marked complete, deduct ALL items from inventory:

```typescript
const handleTaskComplete = async () => {
  // ... other completion logic
  
  // Process inventory step
  const inventoryStep = checklist.find(step => step.type === 'inventory-usage');
  
  if (inventoryStep && inventoryStep.items) {
    // Deduct each item from inventory
    for (const item of inventoryStep.items) {
      if (item.actualQuantityUsed > 0) {
        await apiRequest('POST', '/api/inventory/deduct', {
          inventoryItemId: item.inventoryItemId,
          quantity: item.actualQuantityUsed,
          taskId: task.id,
          taskTitle: task.title
        });
      }
    }
  }
};
```

---

## Testing After Fix

1. **Create a recurring task**
2. **Go to Checklist tab**
3. **Add Inventory Selection step**
4. **Add multiple items:**
   - Broccoli Seeds: 2 oz
   - pH Down: 50 ml
   - Rockwool: 10 cubes
5. **Save the task** ‚úÖ Should work now
6. **Execute the task** 
7. **See all 3 items in one step** instead of 3 separate steps

---

## Summary of Changes

**Fix 1: Validation**
- ‚úÖ Allow task to save with inventory step
- ‚úÖ Only require at least one item selected

**Fix 2: Data Structure**
- ‚úÖ Changed from single item to `items: []` array
- ‚úÖ Added `stepLabel` for custom naming

**Fix 3: UI Updates**
- ‚úÖ Show list of tracked items
- ‚úÖ Add "Add Item to List" button
- ‚úÖ Remove individual items
- ‚úÖ Set default quantities per item

**Fix 4: Execution**
- ‚úÖ Show all items in one step during task completion
- ‚úÖ Users enter quantities for each item
- ‚úÖ Deduct all items from inventory when complete

**Result:** 
- One inventory step can track 10+ items
- Much cleaner than 10 separate steps
- Easier for users to complete tasks