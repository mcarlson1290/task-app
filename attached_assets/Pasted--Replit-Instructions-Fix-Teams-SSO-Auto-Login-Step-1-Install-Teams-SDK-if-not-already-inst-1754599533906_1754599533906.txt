// Replit Instructions: Fix Teams SSO Auto-Login

// Step 1: Install Teams SDK if not already installed
// npm install @microsoft/teams-js

// Step 2: Update your App.jsx or main authentication component

import * as microsoftTeams from "@microsoft/teams-js";
import { PublicClientApplication } from "@azure/msal-browser";

// Step 3: Create Teams-aware authentication handler

const TeamsAuthHandler = () => {
  const [isInTeams, setIsInTeams] = useState(false);
  const [teamsContext, setTeamsContext] = useState(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    // Check if we're running in Teams
    checkTeamsContext();
  }, []);

  const checkTeamsContext = async () => {
    try {
      // Initialize Teams SDK
      await microsoftTeams.app.initialize();
      
      // Get Teams context
      const context = await microsoftTeams.app.getContext();
      console.log("Teams context:", context);
      
      setIsInTeams(true);
      setTeamsContext(context);
      
      // Auto-login with Teams user info
      await handleTeamsLogin(context);
      
    } catch (error) {
      console.log("Not in Teams or Teams SDK error:", error);
      setIsInTeams(false);
      setLoading(false);
    }
  };

  const handleTeamsLogin = async (context) => {
    try {
      // Get the user's email and name from Teams context
      const userEmail = context.user?.userPrincipalName;
      const userName = context.user?.displayName;
      
      if (userEmail && userName) {
        // Check if user exists in staff data
        const existingStaff = getStaffByEmail(userEmail);
        
        if (!existingStaff) {
          // Create new staff member on first login
          const newStaff = {
            id: generateId(),
            name: userName,
            email: userEmail,
            role: determineRoleFromEmail(userEmail), // Your logic here
            hireDate: new Date().toISOString(),
            payRate: 0,
            training: 0,
            status: 'Active',
            lastActive: new Date().toISOString(),
            source: 'Teams'
          };
          
          addStaffMember(newStaff);
          console.log('Created new staff member from Teams:', userName);
        } else {
          // Update last active
          updateStaffMember(existingStaff.id, {
            ...existingStaff,
            lastActive: new Date().toISOString()
          });
        }
        
        // Set the current user
        setCurrentUser({
          name: userName,
          email: userEmail,
          role: existingStaff?.role || 'Staff',
          isAuthenticated: true,
          authMethod: 'teams'
        });
        
        setLoading(false);
      }
    } catch (error) {
      console.error('Teams login error:', error);
      setLoading(false);
    }
  };

  return { isInTeams, teamsContext, loading };
};

// Step 4: Update your main App component

const App = () => {
  const [currentUser, setCurrentUser] = useState(null);
  const { isInTeams, loading } = TeamsAuthHandler();
  
  // Your existing MSAL config
  const msalConfig = {
    auth: {
      clientId: "0b4cf8e2-eda5-4fd9-8319-7ec72614f0f2",
      authority: "https://login.microsoftonline.com/86f7db5f-eb1e-4ac8-b010-4a2964d7749d",
      redirectUri: window.location.origin
    }
  };
  
  const pca = new PublicClientApplication(msalConfig);

  // Modified login function
  const handleLogin = async () => {
    // If in Teams, we should already be logged in
    if (isInTeams) {
      console.log("Already authenticated via Teams");
      return;
    }
    
    // Otherwise, use regular MSAL login
    try {
      const loginResponse = await pca.loginPopup({
        scopes: ["user.read"]
      });
      
      // Handle regular login...
      handleUserLogin(loginResponse);
    } catch (error) {
      console.error("Login failed:", error);
    }
  };

  // Show loading while checking Teams context
  if (loading) {
    return (
      <div style={{ 
        display: 'flex', 
        justifyContent: 'center', 
        alignItems: 'center', 
        height: '100vh' 
      }}>
        <div>Loading...</div>
      </div>
    );
  }

  // If not authenticated and not in Teams, show login
  if (!currentUser && !isInTeams) {
    return <LoginPage onLogin={handleLogin} />;
  }

  // Otherwise show the app
  return <YourMainApp user={currentUser} />;
};

// Step 5: Add Teams-specific authentication token acquisition
// This allows the app to get tokens silently when in Teams

const getTokenSilentlyInTeams = async () => {
  try {
    const authTokenRequest = {
      successCallback: (token) => {
        console.log("Got token from Teams:", token);
        return token;
      },
      failureCallback: (error) => {
        console.error("Failed to get token from Teams:", error);
        // Fallback to interactive login if needed
      }
    };
    
    await microsoftTeams.authentication.getAuthToken(authTokenRequest);
  } catch (error) {
    console.error("Teams auth error:", error);
  }
};

// Step 6: Update your authentication check on app load

useEffect(() => {
  const initAuth = async () => {
    try {
      // First check if we're in Teams
      if (window.parent !== window.self) {
        // Likely in an iframe (Teams)
        await microsoftTeams.app.initialize();
        const context = await microsoftTeams.app.getContext();
        
        if (context.user) {
          // Auto-login with Teams user
          await handleTeamsLogin(context);
          return;
        }
      }
      
      // Not in Teams, check for existing MSAL session
      const accounts = pca.getAllAccounts();
      if (accounts.length > 0) {
        // User already logged in via MSAL
        handleUserLogin({ account: accounts[0] });
      }
      
    } catch (error) {
      console.log("Auth init error:", error);
    }
  };
  
  initAuth();
}, []);

// Step 7: Helper function to determine role from email
const determineRoleFromEmail = (email) => {
  // Add your logic here
  if (email === 'robert@growspace.farm') {
    return 'Corporate Manager';
  }
  // Default role for new users
  return 'Staff';
};

// Step 8: Add Teams-specific styles for better display
// Teams has a narrower display, so adjust your CSS:

.teams-container {
  max-width: 100%;
  padding: 10px;
}

/* Detect Teams and apply styles */
@media (max-width: 800px) {
  .sidebar {
    width: 180px; /* Narrower in Teams */
  }
  
  .main-content {
    margin-left: 180px;
  }
}

// IMPORTANT NOTES:
// 1. When in Teams, users will never see a login screen
// 2. Their Teams/Microsoft identity is automatically used
// 3. First-time users are automatically added to staff data
// 4. The app detects Teams vs regular browser access
// 5. Regular browser users still get the normal login flow