# Fix Inventory Selection in Checklist Builder

## Problem

The "Inventory Selection" checklist step shows hardcoded items (RO Water, pH Down, etc.) instead of pulling live inventory from the database.

## Solution

Update the checklist builder to fetch and display actual inventory items from the user's location.

---

## File to Edit: `/client/src/components/ChecklistBuilder.tsx` or similar

(If this file doesn't exist, it might be in RecurringTaskModal.tsx or wherever checklist steps are configured)

---

## Fix 1: Add Inventory Query at Top of Component

**Add this near the top of the component (after other imports and state declarations):**

```typescript
import { useQuery } from "@tanstack/react-query";
import { apiRequest } from "@/lib/queryClient";
import { useLocation } from "@/contexts/LocationContext";

// Inside the component:
const { currentLocation } = useLocation();

// Fetch live inventory
const { data: inventoryItems = [] } = useQuery({
  queryKey: ["/api/inventory"],
  queryFn: async () => {
    const result = await apiRequest("GET", "/api/inventory");
    return Array.isArray(result) ? result : [];
  },
});
```

---

## Fix 2: Replace Hardcoded Inventory List

**Find the hardcoded inventory dropdown (the code showing RO Water, pH Down, etc.):**

**CURRENT CODE (remove this):**
```typescript
const inventoryOptions = [
  "RO Water (gallons)",
  "pH Down (ml)",
  "pH Up (ml)",
  "Nutrients Part A (ml)",
  "Nutrients Part B (ml)",
  "Rockwool Cubes (cubes)",
  "Romaine Seeds (seeds)",
  "Buttercrunch Seeds (seeds)",
  "Arugula Seeds (seeds)",
  "Basil Seeds (seeds)"
];
```

**REPLACE WITH (use live inventory):**
```typescript
// Build inventory options from live data
const inventoryOptions = inventoryItems.map(item => ({
  id: item.id,
  label: `${item.name} (${item.unit})`,
  name: item.name,
  unit: item.unit,
  currentStock: item.currentStock,
  sku: item.sku
}));
```

---

## Fix 3: Update the Dropdown Rendering

**Find the inventory dropdown JSX:**

**CURRENT CODE:**
```tsx
<Select>
  <SelectTrigger>
    <SelectValue placeholder="Select inventory item..." />
  </SelectTrigger>
  <SelectContent>
    {inventoryOptions.map((item, idx) => (
      <SelectItem key={idx} value={item}>
        {item}
      </SelectItem>
    ))}
  </SelectContent>
</Select>
```

**REPLACE WITH (searchable with live data):**
```tsx
<Select
  value={selectedInventoryItem}
  onValueChange={(value) => {
    // Find the full item object
    const item = inventoryOptions.find(opt => opt.id.toString() === value);
    setSelectedInventoryItem(value);
    setSelectedInventoryUnit(item?.unit || '');
  }}
>
  <SelectTrigger>
    <SelectValue placeholder="Search inventory items..." />
  </SelectTrigger>
  <SelectContent>
    {/* Show message if no inventory */}
    {inventoryOptions.length === 0 && (
      <div className="p-4 text-sm text-gray-500">
        No inventory items found. Add items in the Inventory page first.
      </div>
    )}
    
    {/* Show live inventory items */}
    {inventoryOptions.map((item) => (
      <SelectItem key={item.id} value={item.id.toString()}>
        <div className="flex justify-between items-center w-full">
          <span>{item.name}</span>
          <span className="text-xs text-gray-500 ml-2">
            ({item.currentStock} {item.unit})
          </span>
        </div>
      </SelectItem>
    ))}
  </SelectContent>
</Select>
```

**This shows:**
- Item name on the left
- Current stock and unit on the right
- Example: "Broccoli Seeds          (2 oz)"

---

## Fix 4: Update the Label Text

**Find the label "1. What inventory item will be used?"**

**CURRENT:**
```tsx
<label>1. What inventory item will be used?</label>
```

**CHANGE TO:**
```tsx
<label>1. What inventory item will be used?</label>
```

**Then find the second question/label (probably asking about quantity):**

**CURRENT:**
```tsx
<label>2. How much RO Water will be used?</label>
```

**REPLACE WITH:**
```tsx
<label>2. How much will this task use?</label>
```

**Make it dynamic based on selected item:**
```tsx
<label>
  2. How much will this task use?
  {selectedInventoryItem && (
    <span className="text-gray-500 text-sm ml-2">
      ({selectedInventoryUnit})
    </span>
  )}
</label>
```

**This shows:**
- "2. How much will this task use? (oz)" - if seeds selected
- "2. How much will this task use? (ml)" - if pH Down selected

---

## Fix 5: Add Search Functionality (Optional Enhancement)

**If you want a searchable dropdown, add this:**

```tsx
const [searchTerm, setSearchTerm] = useState('');

// Filter inventory based on search
const filteredInventory = inventoryOptions.filter(item =>
  item.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
  item.sku.toLowerCase().includes(searchTerm.toLowerCase())
);
```

**Then in the SelectContent:**
```tsx
<SelectContent>
  {/* Search input */}
  <div className="p-2 border-b">
    <Input
      placeholder="Search items..."
      value={searchTerm}
      onChange={(e) => setSearchTerm(e.target.value)}
      className="h-8"
    />
  </div>
  
  {/* Filtered items */}
  {filteredInventory.map((item) => (
    <SelectItem key={item.id} value={item.id.toString()}>
      {item.name} ({item.currentStock} {item.unit})
    </SelectItem>
  ))}
</SelectContent>
```

---

## Fix 6: Show "Out of Stock" Warning

**Add a visual indicator for low/out of stock items:**

```tsx
{inventoryOptions.map((item) => (
  <SelectItem 
    key={item.id} 
    value={item.id.toString()}
    disabled={item.currentStock === 0}
  >
    <div className="flex justify-between items-center w-full">
      <span className={item.currentStock === 0 ? 'text-gray-400' : ''}>
        {item.name}
      </span>
      <span className={`text-xs ml-2 ${
        item.currentStock === 0 ? 'text-red-500' : 
        item.currentStock <= item.minimumStock ? 'text-yellow-500' : 
        'text-gray-500'
      }`}>
        ({item.currentStock} {item.unit})
        {item.currentStock === 0 && ' - Out of stock'}
        {item.currentStock > 0 && item.currentStock <= item.minimumStock && ' - Low'}
      </span>
    </div>
  </SelectItem>
))}
```

**This:**
- Disables items with 0 stock
- Shows "Out of stock" in red
- Shows "Low" in yellow for items below minimum

---

## Fix 7: Save Item ID Instead of Name

**When saving the checklist step, save the inventory item ID:**

**CURRENT (probably saving name as string):**
```typescript
{
  type: "inventory-usage",
  itemName: "RO Water (gallons)",
  quantity: 5
}
```

**CHANGE TO (save ID and metadata):**
```typescript
{
  type: "inventory-usage",
  inventoryItemId: 12,
  itemName: "RO Water",
  unit: "gallons",
  quantity: 5
}
```

**This allows you to:**
- Look up current stock when task is executed
- Handle item renames without breaking tasks
- Track which specific item was used

---

## Complete Example

Here's what the full inventory selection section should look like:

```tsx
{/* Inventory Selection Step */}
<div className="space-y-4">
  <h4 className="font-semibold">Inventory Usage Step Configuration</h4>
  
  {/* Question 1: Which item? */}
  <div className="space-y-2">
    <Label>1. What inventory item will be used?</Label>
    <Select
      value={step.inventoryItemId?.toString()}
      onValueChange={(value) => {
        const item = inventoryOptions.find(opt => opt.id.toString() === value);
        updateStep({
          ...step,
          inventoryItemId: parseInt(value),
          itemName: item?.name,
          unit: item?.unit
        });
      }}
    >
      <SelectTrigger>
        <SelectValue placeholder="Search inventory items..." />
      </SelectTrigger>
      <SelectContent>
        {inventoryOptions.length === 0 && (
          <div className="p-4 text-sm text-gray-500">
            No inventory items found. Add items first.
          </div>
        )}
        
        {inventoryOptions.map((item) => (
          <SelectItem key={item.id} value={item.id.toString()}>
            <div className="flex justify-between items-center w-full">
              <span>{item.name}</span>
              <span className="text-xs text-gray-500 ml-2">
                ({item.currentStock} {item.unit})
              </span>
            </div>
          </SelectItem>
        ))}
      </SelectContent>
    </Select>
  </div>
  
  {/* Question 2: How much? */}
  <div className="space-y-2">
    <Label>
      2. How much will this task use?
      {step.unit && (
        <span className="text-gray-500 text-sm ml-2">({step.unit})</span>
      )}
    </Label>
    <Input
      type="number"
      min="0"
      step="0.1"
      placeholder="Enter quantity"
      value={step.quantity || ''}
      onChange={(e) => updateStep({
        ...step,
        quantity: parseFloat(e.target.value) || 0
      })}
    />
  </div>
  
  {/* Optional: Show current stock warning */}
  {step.inventoryItemId && (
    <div className="text-sm text-gray-600">
      Current stock: {
        inventoryOptions.find(i => i.id === step.inventoryItemId)?.currentStock
      } {step.unit}
    </div>
  )}
</div>
```

---

## Testing After Fix

1. **Go to Recurring Tasks**
2. **Create new task or edit existing**
3. **Go to Checklist tab**
4. **Add "Inventory Selection" step**
5. **Click dropdown**

**Should see:**
- ✅ All your actual inventory items
- ✅ Current stock levels shown
- ✅ Items searchable
- ✅ Label says "How much will this task use?"

---

## Summary

**Changes Made:**
1. ✅ Fetch live inventory with React Query
2. ✅ Replace hardcoded list with live data
3. ✅ Show current stock in dropdown
4. ✅ Change label to "How much will this task use?"
5. ✅ Save inventory item ID (not just name)
6. ✅ Show out of stock warnings
7. ✅ Make dropdown searchable (optional)

**Result:** Inventory selection pulls from actual inventory and updates in real-time!