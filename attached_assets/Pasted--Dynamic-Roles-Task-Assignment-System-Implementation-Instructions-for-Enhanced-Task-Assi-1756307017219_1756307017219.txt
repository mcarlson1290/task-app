# ğŸ­ Dynamic Roles & Task Assignment System

## Implementation Instructions for Enhanced Task Assignment

### 1. CREATE ROLE-TO-TASK-TYPE MAPPING

Create a new file `src/data/roleTaskMapping.ts`:

```typescript
// Maps roles to their typical task types
export const roleTaskTypeMapping = {
  'Seeding Tech': [
    'Seeding - Microgreens',
    'Seeding - Leafy Greens'
  ],
  'Harvest Team': [
    'Harvest - Microgreens',
    'Harvest - Leafy Greens'
  ],
  'Cleaning Crew': [
    'Cleaning'
  ],
  'Equipment Tech': [
    'Equipment Maintenance'
  ],
  'Packing': [
    'Packing'
  ],
  'Manager': [
    // Managers can handle all task types
    'All'
  ],
  'General Staff': [
    'Moving',
    'Inventory',
    'Blackout Tasks',
    'Other'
  ]
};

// Get suggested roles for a task type
export const getSuggestedRoles = (taskType: string): string[] => {
  const suggestedRoles: string[] = [];
  
  for (const [role, types] of Object.entries(roleTaskTypeMapping)) {
    if (types.includes(taskType) || types.includes('All')) {
      suggestedRoles.push(role);
    }
  }
  
  return suggestedRoles;
};
```

### 2. UPDATE TASK SERVICE - Add Dynamic Assignment Data

Update your task service to fetch staff and build assignment options:

```javascript
// Get dynamic assignment options
export const getAssignmentOptions = async (currentUser, taskType) => {
  try {
    // Fetch all staff
    const response = await fetch('/api/staff');
    const staff = await response.json();
    
    // Filter active staff only
    const activeStaff = staff.filter(s => s.activeStatus === 'active');
    
    // Get suggested roles for this task type
    const suggestedRoles = getSuggestedRoles(taskType);
    
    // Build roles list with staff counts
    const rolesWithStaff = {};
    activeStaff.forEach(member => {
      member.rolesAssigned.forEach(role => {
        if (!rolesWithStaff[role]) {
          rolesWithStaff[role] = [];
        }
        rolesWithStaff[role].push(member);
      });
    });
    
    // Sort roles: suggested first, then alphabetical
    const sortedRoles = Object.keys(rolesWithStaff).sort((a, b) => {
      const aIsSuggested = suggestedRoles.includes(a);
      const bIsSuggested = suggestedRoles.includes(b);
      
      if (aIsSuggested && !bIsSuggested) return -1;
      if (!aIsSuggested && bIsSuggested) return 1;
      return a.localeCompare(b);
    });
    
    // Build final assignment options
    const assignmentOptions = {
      roles: [],
      users: [],
      special: []
    };
    
    // Add "All Staff" option
    assignmentOptions.special.push({
      value: 'all_staff',
      label: 'ğŸ‘¥ All Staff',
      type: 'special',
      staffCount: activeStaff.length
    });
    
    // Add roles with staff counts
    sortedRoles.forEach(role => {
      const staffInRole = rolesWithStaff[role];
      assignmentOptions.roles.push({
        value: `role_${role}`,
        label: `ğŸ‘¤ ${role}`,
        type: 'role',
        staffCount: staffInRole.length,
        staffIds: staffInRole.map(s => s.id),
        isSuggested: suggestedRoles.includes(role)
      });
    });
    
    // Add individual users (sorted by name)
    const sortedStaff = [...activeStaff].sort((a, b) => 
      a.fullName.localeCompare(b.fullName)
    );
    
    sortedStaff.forEach(member => {
      assignmentOptions.users.push({
        value: `user_${member.id}`,
        label: member.fullName,
        type: 'user',
        userId: member.id,
        roles: member.rolesAssigned,
        isCurrentUser: member.id === currentUser?.id
      });
    });
    
    return assignmentOptions;
    
  } catch (error) {
    console.error('Error fetching assignment options:', error);
    return { roles: [], users: [], special: [] };
  }
};
```

### 3. UPDATE ADD TASK MODAL - Dynamic Assign To Dropdown

Update your Add Task modal component:

```javascript
const AddTaskModal = ({ onSave, onClose, currentUser }) => {
  const [formData, setFormData] = useState({
    title: '',
    description: '',
    taskType: '',
    priority: 'Medium',
    assignTo: '',
    dueDate: new Date().toISOString().split('T')[0]
  });
  
  const [assignmentOptions, setAssignmentOptions] = useState({
    roles: [],
    users: [],
    special: []
  });
  
  // Fetch assignment options when task type changes
  useEffect(() => {
    const loadAssignmentOptions = async () => {
      if (formData.taskType) {
        const options = await getAssignmentOptions(currentUser, formData.taskType);
        setAssignmentOptions(options);
      }
    };
    
    loadAssignmentOptions();
  }, [formData.taskType, currentUser]);
  
  // Render assignment dropdown with groups
  const renderAssignmentDropdown = () => {
    return (
      <div className="form-group">
        <label>Assign To *</label>
        <select
          value={formData.assignTo}
          onChange={(e) => setFormData({ ...formData, assignTo: e.target.value })}
          required
          className="assignment-select"
        >
          <option value="">Select Assignee</option>
          
          {/* Special Options */}
          {assignmentOptions.special.map(option => (
            <option key={option.value} value={option.value}>
              {option.label} ({option.staffCount} people)
            </option>
          ))}
          
          {/* Separator */}
          <option disabled>â”€â”€â”€â”€â”€â”€â”€â”€ Roles â”€â”€â”€â”€â”€â”€â”€â”€</option>
          
          {/* Roles (with suggested indicator) */}
          {assignmentOptions.roles.map(role => (
            <option 
              key={role.value} 
              value={role.value}
              className={role.isSuggested ? 'suggested-role' : ''}
            >
              {role.label} ({role.staffCount} {role.staffCount === 1 ? 'person' : 'people'})
              {role.isSuggested && ' â­'}
            </option>
          ))}
          
          {/* Separator */}
          <option disabled>â”€â”€â”€â”€â”€â”€â”€â”€ People â”€â”€â”€â”€â”€â”€â”€â”€</option>
          
          {/* Individual Users */}
          {assignmentOptions.users.map(user => (
            <option 
              key={user.value} 
              value={user.value}
              className={user.isCurrentUser ? 'current-user' : ''}
            >
              {user.label} 
              {user.isCurrentUser && ' (You)'}
              {user.roles.length > 0 && ` - ${user.roles.join(', ')}`}
            </option>
          ))}
        </select>
        
        {/* Show who this will assign to */}
        {formData.assignTo && formData.assignTo.startsWith('role_') && (
          <div className="assignment-preview">
            <small>
              This will assign to: {
                assignmentOptions.roles
                  .find(r => r.value === formData.assignTo)
                  ?.staffIds
                  .map(id => assignmentOptions.users.find(u => u.userId === id)?.label)
                  .join(', ')
              }
            </small>
          </div>
        )}
      </div>
    );
  };
  
  // ... rest of modal code
};
```

### 4. UPDATE TASK DISPLAY - Show Assignment Indicator

Update your task card component to show if assigned to current user:

```javascript
const TaskCard = ({ task, currentUser, staff }) => {
  // Determine if task is assigned to current user
  const isAssignedToMe = () => {
    if (!currentUser) return false;
    
    // Direct user assignment
    if (task.assignTo === `user_${currentUser.id}`) return true;
    
    // All staff assignment
    if (task.assignTo === 'all_staff') return true;
    
    // Role assignment - check if user has the role
    if (task.assignTo?.startsWith('role_')) {
      const roleName = task.assignTo.replace('role_', '');
      const currentStaff = staff.find(s => s.id === currentUser.id);
      return currentStaff?.rolesAssigned.includes(roleName);
    }
    
    return false;
  };
  
  // Get assignment display text
  const getAssignmentText = () => {
    if (task.assignTo?.startsWith('user_')) {
      const userId = parseInt(task.assignTo.replace('user_', ''));
      const assignedUser = staff.find(s => s.id === userId);
      return assignedUser?.fullName || 'Unknown User';
    }
    
    if (task.assignTo?.startsWith('role_')) {
      const roleName = task.assignTo.replace('role_', '');
      return `ğŸ‘¤ ${roleName}`;
    }
    
    if (task.assignTo === 'all_staff') {
      return 'ğŸ‘¥ All Staff';
    }
    
    return 'Unassigned';
  };
  
  return (
    <div className={`task-card ${isAssignedToMe() ? 'assigned-to-me' : ''}`}>
      {isAssignedToMe() && (
        <div className="assigned-indicator">
          <span className="assigned-badge">ğŸ“Œ Assigned to You</span>
        </div>
      )}
      
      <div className="task-header">
        <h3>{task.title}</h3>
        <span className="task-category">{task.taskType}</span>
      </div>
      
      <div className="task-assignment">
        <span className="assignment-label">Assigned to:</span>
        <span className="assignment-value">{getAssignmentText()}</span>
      </div>
      
      {/* Rest of task card content */}
    </div>
  );
};
```

### 5. ADD "ASSIGNED TO ME" FILTER

Update your Tasks page filters:

```javascript
const TasksPage = ({ currentUser }) => {
  const [filters, setFilters] = useState({
    category: 'all',
    status: 'all',
    priority: 'all',
    assignedToMe: false,
    date: new Date().toISOString().split('T')[0]
  });
  
  // Filter tasks
  const filterTasks = (tasks) => {
    return tasks.filter(task => {
      // Category filter
      if (filters.category !== 'all' && task.taskType !== filters.category) {
        return false;
      }
      
      // Status filter
      if (filters.status !== 'all' && task.status !== filters.status) {
        return false;
      }
      
      // Priority filter
      if (filters.priority !== 'all' && task.priority !== filters.priority) {
        return false;
      }
      
      // Assigned to me filter
      if (filters.assignedToMe) {
        if (!isTaskAssignedToUser(task, currentUser, staff)) {
          return false;
        }
      }
      
      // Date filter
      if (task.dueDate !== filters.date) {
        return false;
      }
      
      return true;
    });
  };
  
  // Helper function to check assignment
  const isTaskAssignedToUser = (task, user, allStaff) => {
    if (!user) return false;
    
    if (task.assignTo === `user_${user.id}`) return true;
    if (task.assignTo === 'all_staff') return true;
    
    if (task.assignTo?.startsWith('role_')) {
      const roleName = task.assignTo.replace('role_', '');
      const userStaff = allStaff.find(s => s.id === user.id);
      return userStaff?.rolesAssigned.includes(roleName);
    }
    
    return false;
  };
  
  return (
    <div className="tasks-page">
      <div className="filters-bar">
        {/* Other filters... */}
        
        {/* Assigned to Me Toggle */}
        <div className="filter-toggle">
          <label className="toggle-label">
            <input
              type="checkbox"
              checked={filters.assignedToMe}
              onChange={(e) => setFilters({
                ...filters,
                assignedToMe: e.target.checked
              })}
            />
            <span className="toggle-slider"></span>
            <span className="toggle-text">ğŸ“Œ Assigned to Me</span>
          </label>
        </div>
        
        {/* Clear Filters button */}
        <button 
          className="clear-filters"
          onClick={() => setFilters({
            category: 'all',
            status: 'all',
            priority: 'all',
            assignedToMe: false,
            date: new Date().toISOString().split('T')[0]
          })}
        >
          Ã— Clear Filters
        </button>
      </div>
      
      {/* Task list */}
      <div className="task-list">
        {filteredTasks.map(task => (
          <TaskCard 
            key={task.id} 
            task={task} 
            currentUser={currentUser}
            staff={staff}
          />
        ))}
      </div>
    </div>
  );
};
```

### 6. ADD STYLES FOR NEW FEATURES

Add these CSS styles:

```css
/* Assignment Dropdown Styling */
.assignment-select option.suggested-role {
  background: #fef3c7;
  font-weight: 600;
}

.assignment-select option.current-user {
  background: #dbeafe;
  font-weight: 600;
}

.assignment-select option:disabled {
  color: #9ca3af;
  font-size: 12px;
  text-align: center;
}

.assignment-preview {
  margin-top: 8px;
  padding: 8px;
  background: #f3f4f6;
  border-radius: 4px;
  font-size: 12px;
  color: #6b7280;
}

/* Task Card Assignment Indicator */
.task-card.assigned-to-me {
  border-left: 4px solid #2D8028;
  background: linear-gradient(to right, rgba(45, 128, 40, 0.05), transparent);
}

.assigned-indicator {
  position: absolute;
  top: 8px;
  right: 8px;
}

.assigned-badge {
  background: #2D8028;
  color: white;
  padding: 4px 12px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 600;
  display: inline-flex;
  align-items: center;
  gap: 4px;
}

.task-assignment {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-top: 8px;
  font-size: 14px;
}

.assignment-label {
  color: #6b7280;
}

.assignment-value {
  color: #374151;
  font-weight: 500;
}

/* Filter Toggle */
.filter-toggle {
  display: inline-flex;
  align-items: center;
}

.toggle-label {
  display: flex;
  align-items: center;
  cursor: pointer;
  gap: 8px;
}

.toggle-label input[type="checkbox"] {
  display: none;
}

.toggle-slider {
  width: 44px;
  height: 24px;
  background: #e5e7eb;
  border-radius: 12px;
  position: relative;
  transition: background 0.2s;
}

.toggle-slider::after {
  content: '';
  position: absolute;
  width: 18px;
  height: 18px;
  background: white;
  border-radius: 50%;
  top: 3px;
  left: 3px;
  transition: transform 0.2s;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.toggle-label input:checked + .toggle-slider {
  background: #2D8028;
}

.toggle-label input:checked + .toggle-slider::after {
  transform: translateX(20px);
}

.toggle-text {
  font-weight: 500;
  color: #374151;
}
```

### 7. UPDATE BACKEND TO HANDLE NEW ASSIGNMENT FORMAT

Update your task creation endpoint to handle the new assignment format:

```javascript
// In your task creation/update endpoint
app.post('/api/tasks', async (req, res) => {
  const taskData = req.body;
  
  // Parse assignment to determine actual assignees
  let assignedUsers = [];
  
  if (taskData.assignTo.startsWith('user_')) {
    // Single user assignment
    const userId = parseInt(taskData.assignTo.replace('user_', ''));
    assignedUsers = [userId];
    
  } else if (taskData.assignTo.startsWith('role_')) {
    // Role assignment - find all users with this role
    const roleName = taskData.assignTo.replace('role_', '');
    const staff = await readData('staff.json');
    assignedUsers = staff
      .filter(s => s.activeStatus === 'active' && s.rolesAssigned.includes(roleName))
      .map(s => s.id);
      
  } else if (taskData.assignTo === 'all_staff') {
    // All staff assignment
    const staff = await readData('staff.json');
    assignedUsers = staff
      .filter(s => s.activeStatus === 'active')
      .map(s => s.id);
  }
  
  // Store both the assignment type and the resolved users
  const task = {
    ...taskData,
    assignTo: taskData.assignTo, // Keep original assignment format
    assignedUsers: assignedUsers, // Store resolved user IDs for filtering
    id: Date.now(),
    createdAt: new Date().toISOString(),
    status: 'pending'
  };
  
  // Save task
  const tasks = await readData('tasks.json');
  tasks.push(task);
  await saveData('tasks.json', tasks);
  
  res.json(task);
});
```

## Testing Instructions

1. **Test Role Assignment**:
   - Create a task with "Seeding - Microgreens" type
   - Verify "Seeding Tech" role appears with â­ indicator
   - Select the role and verify preview shows correct staff

2. **Test "Assigned to Me" Filter**:
   - Create tasks assigned to your user, your role, and "All Staff"
   - Toggle "Assigned to Me" filter
   - Verify all three types appear when filtered

3. **Test Visual Indicators**:
   - Verify tasks assigned to you have green border
   - Verify "Assigned to You" badge appears
   - Test on mobile for responsive layout

4. **Test Assignment Dropdown**:
   - Verify roles appear first, then users
   - Check staff counts are accurate
   - Verify current user shows "(You)" indicator

## Next Steps

- Consider adding bulk assignment changes
- Add assignment history tracking
- Create assignment analytics (workload per person/role)
- Add email/notification when assigned a task