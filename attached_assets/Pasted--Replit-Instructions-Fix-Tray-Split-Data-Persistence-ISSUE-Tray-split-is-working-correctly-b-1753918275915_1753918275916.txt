# Replit Instructions: Fix Tray Split Data Persistence

**ISSUE: Tray split is working correctly but the data isn't being saved/displayed properly.**

## The Problem
- Split creates new trays (original-1, original-2) ✓
- Marks original as "split" ✓  
- But the changes don't appear in Tray Tracking ✗

This means the logic is correct but the data isn't persisting to the right place.

## Step 1: Debug Where Data is Being Saved

Add logging to see what's happening:

```javascript
// In the splitTray function
const splitTray = (originalTrayId, splitCount) => {
  console.log('=== TRAY SPLIT DEBUG ===');
  console.log('Splitting tray:', originalTrayId, 'into', splitCount, 'parts');
  
  // Get current data
  const currentData = // however trays are currently loaded
  console.log('Current tray data before split:', currentData);
  
  // Find original tray
  const originalTray = // find the tray
  console.log('Found original tray:', originalTray);
  
  // Create splits
  const splitTrays = [];
  for (let i = 1; i <= splitCount; i++) {
    const newTray = {
      ...originalTray,
      id: `${originalTrayId}-${i}`,
      parentId: originalTrayId,
      status: 'active',
      splitNumber: i,
      splitTotal: splitCount
    };
    splitTrays.push(newTray);
    console.log('Created split tray:', newTray);
  }
  
  // Mark original as split
  originalTray.status = 'split';
  originalTray.splitInto = splitTrays.map(t => t.id);
  console.log('Updated original tray:', originalTray);
  
  // Save everything
  // THIS IS WHERE THE ISSUE LIKELY IS
  console.log('Saving data...');
  // save logic here
  
  // Verify save
  console.log('Data after save:', // load and check);
  
  // Trigger update events
  window.dispatchEvent(new Event('trayUpdated'));
  console.log('Dispatched trayUpdated event');
  
  return splitTrays;
};
```

## Step 2: Ensure Data Saves to the Correct Location

The split function needs to save to the SAME place that Tray Tracking reads from:

```javascript
// Find how Tray Tracking loads data
// In the Tray Tracking component, look for something like:
const loadTrays = () => {
  // This is how it loads - use the SAME method
  const trays = // however it loads
  setTrays(trays);
};

// Make sure splitTray saves to the SAME location
const splitTray = (originalTrayId, splitCount) => {
  // Load from SAME source as Tray Tracking
  const allTrays = // same as loadTrays
  
  // Find and update
  const index = allTrays.findIndex(t => t.id === originalTrayId);
  if (index === -1) {
    console.error('Tray not found!');
    return null;
  }
  
  // Create splits
  const originalTray = allTrays[index];
  const splitTrays = [];
  
  for (let i = 1; i <= splitCount; i++) {
    splitTrays.push({
      ...originalTray,
      id: `${originalTrayId}-${i}`,
      parentId: originalTrayId,
      status: 'active',
      splitNumber: i
    });
  }
  
  // Update original
  allTrays[index] = {
    ...originalTray,
    status: 'split',
    splitInto: splitTrays.map(t => t.id)
  };
  
  // Add new split trays
  allTrays.push(...splitTrays);
  
  // Save to SAME location that Tray Tracking uses
  // This is the critical part - must match how Tray Tracking saves
  
  return splitTrays;
};
```

## Step 3: Force Tray Tracking to Refresh

Make sure Tray Tracking reloads after a split:

```javascript
// In Tray Tracking component
useEffect(() => {
  const handleTrayUpdate = () => {
    console.log('Tray update event received, reloading...');
    loadTrays(); // Reload the tray data
  };
  
  // Listen for updates
  window.addEventListener('trayUpdated', handleTrayUpdate);
  
  // Also listen for storage changes if using localStorage
  window.addEventListener('storage', handleTrayUpdate);
  
  return () => {
    window.removeEventListener('trayUpdated', handleTrayUpdate);
    window.removeEventListener('storage', handleTrayUpdate);
  };
}, []);
```

## Step 4: Verify the Complete Flow

Add a test button to verify the split is working:

```javascript
// Temporary test in Tray Tracking
<button onClick={() => {
  console.log('Testing split...');
  const testTrayId = 'K071725-MG-BROC-01A'; // Use a real tray ID
  
  // Before split
  console.log('Trays before split:', getAllTrays());
  
  // Do split
  const result = splitTray(testTrayId, 2);
  console.log('Split result:', result);
  
  // After split
  console.log('Trays after split:', getAllTrays());
  
  // Force refresh
  loadTrays();
}}>
  Test Split (Check Console)
</button>
```

## Step 5: Common Issues to Check

1. **Data not saving to right place**
   - Split saves to localStorage but Tray Tracking reads from API
   - Different storage keys being used
   - Data structure mismatch

2. **Events not triggering**
   - Event name mismatch ('trayUpdated' vs 'traysUpdated')
   - Event not being listened to
   - Component not re-rendering

3. **Data structure issues**
   - Split trays have different structure than expected
   - Missing required fields
   - Status field not recognized

## The Fix Pattern:
1. Find how Tray Tracking LOADS data
2. Find how Tray Tracking SAVES data  
3. Make split use the EXACT SAME methods
4. Ensure refresh happens after split

The functionality is working - we just need to make sure the data goes to the right place and the UI refreshes!