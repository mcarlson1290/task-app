# Replit Instructions: Implement Create Tray Functionality Properly

**CRITICAL: This is to complete the Create Tray checklist step functionality. DO NOT create fake data. Connect to the REAL Production Data > Tray Tracking system.**

## Overview
The Create Tray step allows users to create new trays during task execution with a partially auto-generated ID and essential data capture.

## Tray ID Format
Example: `K073024-MG-BROC-1`
- **K** = Location code (auto from current user location)
- **073024** = Date MMDDYY (auto from today)
- **MG** = Type (user selects: MG for Microgreens, LG for Leafy Greens, HB for Herbs)
- **BROC** = SKU from inventory item (selected from dropdown)
- **1** = Instance number (default from recurring task, editable by user)
- Note: When split, trays become K073024-MG-BROC-1-1, K073024-MG-BROC-1-2, etc.

## Step 1: Create the Create Tray Component

Create `src/components/checklist/CreateTrayStep.tsx`:

```tsx
import React, { useState, useEffect } from 'react';
import { Plus, Minus } from 'lucide-react';

interface CreateTrayStepProps {
  stepData: any;
  onComplete: (data: any) => void;
  defaultInstance?: number;
}

interface Variety {
  id: string;
  name: string;
  percentage: number;
}

interface InventoryItem {
  id: string;
  name: string;
  sku: string;
  category: string;
  quantity: number;
  unit: string;
}

const CreateTrayStep: React.FC<CreateTrayStepProps> = ({ 
  stepData, 
  onComplete,
  defaultInstance = 1 
}) => {
  const [selectedSeed, setSelectedSeed] = useState<InventoryItem | null>(null);
  const [trayType, setTrayType] = useState<'MG' | 'LG' | 'HB'>('LG');
  const [instanceNumber, setInstanceNumber] = useState(defaultInstance);
  const [seedsOz, setSeedsOz] = useState('');
  const [growingMedium, setGrowingMedium] = useState('');
  const [varieties, setVarieties] = useState<Variety[]>([
    { id: '1', name: '', percentage: 100 }
  ]);
  const [notes, setNotes] = useState('');
  const [generatedId, setGeneratedId] = useState('');
  const [availableSeeds, setAvailableSeeds] = useState<InventoryItem[]>([]);

  // Get current user and location from localStorage
  const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
  const locationCode = currentUser.location === 'kenosha' ? 'K' : 'L';

  // Load seed inventory on mount
  useEffect(() => {
    // Get seeds from the SAME inventory that the Inventory page uses
    const inventory = JSON.parse(localStorage.getItem('inventory') || '[]');
    // Filter to only show seeds
    const seeds = inventory.filter((item: InventoryItem) => 
      item.category === 'Seeds' || item.category === 'seeds'
    );
    setAvailableSeeds(seeds);
  }, []);

  // Generate tray ID whenever inputs change
  useEffect(() => {
    if (selectedSeed && selectedSeed.sku) {
      const date = new Date();
      const dateStr = 
        (date.getMonth() + 1).toString().padStart(2, '0') +
        date.getDate().toString().padStart(2, '0') +
        date.getFullYear().toString().slice(2);
      
      const id = `${locationCode}${dateStr}-${trayType}-${selectedSeed.sku}-${instanceNumber}`;
      setGeneratedId(id);
    } else {
      setGeneratedId('');
    }
  }, [locationCode, trayType, selectedSeed, instanceNumber]);

  const addVariety = () => {
    setVarieties([...varieties, { id: Date.now().toString(), name: '', percentage: 0 }]);
  };

  const removeVariety = (id: string) => {
    setVarieties(varieties.filter(v => v.id !== id));
  };

  const updateVariety = (id: string, field: 'name' | 'percentage', value: any) => {
    setVarieties(varieties.map(v => 
      v.id === id ? { ...v, [field]: value } : v
    ));
  };

  const handleCreate = () => {
    // Validate inputs
    if (!selectedSeed || !seedsOz || !growingMedium) {
      alert('Please select a seed type and fill in all required fields.');
      return;
    }

    // Check if we have enough seeds in inventory
    if (parseFloat(seedsOz) > selectedSeed.quantity) {
      alert(`Not enough ${selectedSeed.name} in inventory. Available: ${selectedSeed.quantity} oz`);
      return;
    }

    // Get existing trays from the SAME place Production Data > Tray Tracking reads from
    const existingTrays = JSON.parse(localStorage.getItem('productionTrays') || '[]');
    
    // Create new tray object
    const newTray = {
      id: generatedId,
      cropName: selectedSeed.name,
      cropType: trayType,
      sku: selectedSeed.sku,
      seedInventoryId: selectedSeed.id,
      varieties: varieties.filter(v => v.name),
      seedsPlanted: parseFloat(seedsOz),
      growingMedium,
      plantedBy: currentUser.username || 'Unknown',
      plantedDate: new Date().toISOString(),
      location: currentUser.location,
      status: 'seeded',
      currentLocation: trayType === 'MG' ? 'Nursery' : 'Staging',
      movements: [{
        location: trayType === 'MG' ? 'Nursery' : 'Staging',
        movedBy: currentUser.username,
        timestamp: new Date().toISOString(),
        notes: 'Initial seeding'
      }],
      notes
    };

    // Add to existing trays
    existingTrays.push(newTray);
    
    // Save back to localStorage - SAME key that Tray Tracking uses
    localStorage.setItem('productionTrays', JSON.stringify(existingTrays));

    // Update inventory to deduct seeds used
    const inventory = JSON.parse(localStorage.getItem('inventory') || '[]');
    const updatedInventory = inventory.map((item: InventoryItem) => {
      if (item.id === selectedSeed.id) {
        return { ...item, quantity: item.quantity - parseFloat(seedsOz) };
      }
      return item;
    });
    localStorage.setItem('inventory', JSON.stringify(updatedInventory));
    
    // Dispatch events so pages update
    window.dispatchEvent(new CustomEvent('trayCreated', { detail: newTray }));
    window.dispatchEvent(new CustomEvent('inventoryUpdated'));
    
    // Complete the step
    onComplete({
      trayId: generatedId,
      seedsUsed: parseFloat(seedsOz),
      ...newTray
    });
  };

  return (
    <div className="create-tray-step">
      <h3>Create New Tray</h3>
      
      {generatedId && (
        <div className="tray-id-preview">
          <strong>Tray ID:</strong> {generatedId}
        </div>
      )}

      <div className="form-group">
        <label>Select Seed Type*</label>
        <select 
          value={selectedSeed?.id || ''} 
          onChange={(e) => {
            const seed = availableSeeds.find(s => s.id === e.target.value);
            setSelectedSeed(seed || null);
          }}
        >
          <option value="">Select seed...</option>
          {availableSeeds.map(seed => (
            <option key={seed.id} value={seed.id}>
              {seed.name} - {seed.sku} ({seed.quantity} {seed.unit} available)
            </option>
          ))}
        </select>
      </div>

      <div className="form-row">
        <div className="form-group">
          <label>Type*</label>
          <select value={trayType} onChange={(e) => setTrayType(e.target.value as any)}>
            <option value="MG">MG - Microgreens</option>
            <option value="LG">LG - Leafy Greens</option>
            <option value="HB">HB - Herbs</option>
          </select>
        </div>

        <div className="form-group">
          <label>Instance #</label>
          <input
            type="number"
            value={instanceNumber}
            onChange={(e) => setInstanceNumber(parseInt(e.target.value) || 1)}
            min={1}
            max={99}
          />
        </div>
      </div>

      <div className="form-group">
        <label>Seeds Planted (oz)*</label>
        <input
          type="number"
          value={seedsOz}
          onChange={(e) => setSeedsOz(e.target.value)}
          placeholder="0.5"
          step="0.1"
        />
      </div>

      <div className="form-group">
        <label>Growing Medium*</label>
        <select value={growingMedium} onChange={(e) => setGrowingMedium(e.target.value)}>
          <option value="">Select Medium</option>
          {trayType === 'MG' ? (
            <>
              <option value="Coco Mat">Coco Mat</option>
              <option value="Hemp Mat">Hemp Mat</option>
              <option value="Burlap">Burlap</option>
            </>
          ) : (
            <>
              <option value="Rockwool">Rockwool</option>
              <option value="Oasis Cubes">Oasis Cubes</option>
              <option value="Coco Coir">Coco Coir</option>
            </>
          )}
        </select>
      </div>

      <div className="varieties-section">
        <label>Varieties</label>
        {varieties.map((variety, index) => (
          <div key={variety.id} className="variety-row">
            <input
              type="text"
              value={variety.name}
              onChange={(e) => updateVariety(variety.id, 'name', e.target.value)}
              placeholder="Variety name"
            />
            <input
              type="number"
              value={variety.percentage}
              onChange={(e) => updateVariety(variety.id, 'percentage', parseInt(e.target.value) || 0)}
              placeholder="%"
              min={0}
              max={100}
            />
            {varieties.length > 1 && (
              <button onClick={() => removeVariety(variety.id)} className="remove-btn">
                <Minus size={16} />
              </button>
            )}
          </div>
        ))}
        <button onClick={addVariety} className="add-variety-btn">
          <Plus size={16} /> Add Variety
        </button>
      </div>

      <div className="form-group">
        <label>Notes</label>
        <textarea
          value={notes}
          onChange={(e) => setNotes(e.target.value)}
          placeholder="Optional notes..."
          rows={3}
        />
      </div>

      <button onClick={handleCreate} className="create-tray-btn">
        Create Tray
      </button>
    </div>
  );
};

export default CreateTrayStep;
```

## Step 2: Add Styles for Create Tray

Add to your styles:

```css
.create-tray-step {
  padding: 1rem;
  background: #f5f5f5;
  border-radius: 8px;
}

.tray-id-preview {
  padding: 0.75rem;
  background: #e8f5e9;
  border: 1px solid #4caf50;
  border-radius: 4px;
  margin-bottom: 1rem;
  font-family: monospace;
  font-size: 1.1rem;
  text-align: center;
}

.form-group {
  margin-bottom: 1rem;
}

.form-group label {
  display: block;
  margin-bottom: 0.25rem;
  font-weight: 600;
}

.form-group input,
.form-group select,
.form-group textarea {
  width: 100%;
  padding: 0.5rem;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.form-row {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 1rem;
}

.varieties-section {
  margin-bottom: 1rem;
}

.variety-row {
  display: grid;
  grid-template-columns: 2fr 80px 40px;
  gap: 0.5rem;
  margin-bottom: 0.5rem;
}

.add-variety-btn {
  display: flex;
  align-items: center;
  gap: 0.25rem;
  padding: 0.5rem 1rem;
  background: #f0f0f0;
  border: 1px solid #ddd;
  border-radius: 4px;
  cursor: pointer;
}

.create-tray-btn {
  width: 100%;
  padding: 0.75rem;
  background: #4caf50;
  color: white;
  border: none;
  border-radius: 4px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
}

.create-tray-btn:hover {
  background: #45a049;
}
```

## Step 3: Integrate with Checklist System

Update the checklist rendering to use CreateTrayStep when step type is 'Create Tray':

```tsx
// In your checklist component where steps are rendered
{step.type === 'Create Tray' && !step.completed && currentStepIndex === index && (
  <CreateTrayStep
    stepData={step}
    onComplete={(data) => {
      // Update step as completed with the tray data
      updateStepCompletion(index, true, data);
      
      // Move to next step
      setCurrentStepIndex(index + 1);
    }}
    defaultInstance={step.defaultInstance || 1}
  />
)}
```

## Step 4: Initialize Seed Inventory (if not already present)

Add this to your initialization or admin setup:

```tsx
// Initialize seed inventory if it doesn't exist
const initializeSeedInventory = () => {
  const existingInventory = localStorage.getItem('inventory');
  if (!existingInventory) {
    const defaultSeeds = [
      { id: 'seed-1', name: 'Broccoli Microgreens', sku: 'BROC', category: 'Seeds', quantity: 50, unit: 'oz' },
      { id: 'seed-2', name: 'Romaine Lettuce', sku: 'ROMN', category: 'Seeds', quantity: 30, unit: 'oz' },
      { id: 'seed-3', name: 'Genovese Basil', sku: 'BASIL', category: 'Seeds', quantity: 25, unit: 'oz' },
      { id: 'seed-4', name: 'Arugula', sku: 'ARUG', category: 'Seeds', quantity: 40, unit: 'oz' },
      { id: 'seed-5', name: 'Kale Mix', sku: 'KALE', category: 'Seeds', quantity: 35, unit: 'oz' },
      { id: 'seed-6', name: 'Radish Microgreens', sku: 'RADI', category: 'Seeds', quantity: 45, unit: 'oz' },
      { id: 'seed-7', name: 'Sunflower Microgreens', sku: 'SUNF', category: 'Seeds', quantity: 60, unit: 'oz' },
      { id: 'seed-8', name: 'Pea Shoots', sku: 'PEAS', category: 'Seeds', quantity: 55, unit: 'oz' }
    ];
    localStorage.setItem('inventory', JSON.stringify(defaultSeeds));
  }
};
```

## Step 5: Add to Recurring Task Configuration

In the recurring task creation/edit form, when step type is 'Create Tray', add option for default instance:

```tsx
{selectedStepType === 'Create Tray' && (
  <div className="form-group">
    <label>Default Instance Number</label>
    <input
      type="number"
      value={defaultInstance}
      onChange={(e) => setDefaultInstance(parseInt(e.target.value) || 1)}
      min={1}
      max={26}
      placeholder="1"
    />
    <small>This can be changed during task execution</small>
  </div>
)}
```

## Step 5: Update Production Data Page to Listen for New Trays

In Production Data > Tray Tracking component:

```tsx
useEffect(() => {
  const handleTrayCreated = (event: CustomEvent) => {
    // Refresh tray list from localStorage
    const trays = JSON.parse(localStorage.getItem('productionTrays') || '[]');
    setTrays(trays);
  };

  window.addEventListener('trayCreated', handleTrayCreated);
  
  return () => {
    window.removeEventListener('trayCreated', handleTrayCreated);
  };
}, []);
```

## CRITICAL NOTES:

1. **NO FAKE DATA** - The component reads and writes to the SAME localStorage key that Production Data uses
2. **Real IDs** - Uses the actual format K073024-MG-BROC-1A, not TRAY-001
3. **Data Persistence** - Created trays immediately appear in Production Data > Tray Tracking
4. **User Context** - Automatically captures who created it and when
5. **Movement Tracking** - Microgreens start in Nursery, others in Staging

## Testing:
1. Create a recurring task with a Create Tray step
2. Execute the task and create a tray
3. Go to Production Data > Tray Tracking
4. The new tray should appear with all the correct data
5. No fake test trays should exist