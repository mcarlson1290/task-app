# Debug and Fix Staff Auto-Creation Issue

## Step 1: Add Debug Logging

First, let's add logging to see what's happening when Matt logs in:

```tsx
// In your App.tsx or authentication handler
const initializeUser = async () => {
  if (isAuthenticated && accounts[0]) {
    const account = accounts[0];
    console.log('User logged in:', account.username, account.name);
    
    // Check existing staff data
    let staffData = JSON.parse(localStorage.getItem('staffData') || '[]');
    console.log('Current staff data:', staffData);
    
    let existingUser = staffData.find(staff => staff.email === account.username);
    console.log('Existing user found?', existingUser);
    
    if (!existingUser) {
      console.log('Creating new staff member...');
      
      // Create new staff entry
      const newStaffMember = {
        id: `staff-${Date.now()}`, // Unique ID
        name: account.name || account.username.split('@')[0],
        email: account.username,
        phone: '',
        roles: ['General Staff'],
        hireDate: new Date().toISOString().split('T')[0],
        payRate: 0,
        trainingCompleted: [],
        status: 'Active',
        lastActive: new Date().toISOString(),
        microsoftId: account.localAccountId || account.homeAccountId,
        location: 'Kenosha',
        department: '',
        notes: 'Auto-created on first login'
      };
      
      // Special handling for known corporate users
      if (account.username === 'matt@growspace.farm' || 
          account.username === 'matt.carlson@growspace.farm') {
        newStaffMember.roles = ['Corporate Manager'];
      }
      
      staffData.push(newStaffMember);
      localStorage.setItem('staffData', JSON.stringify(staffData));
      console.log('New staff member created:', newStaffMember);
      
      existingUser = newStaffMember;
    }
    
    // Rest of your user initialization...
  }
};
```

## Step 2: Ensure Staff Data Page Refreshes

In your Staff Data component, make sure it's loading the latest data:

```tsx
const StaffData = () => {
  const [staff, setStaff] = useState([]);
  const [refreshKey, setRefreshKey] = useState(0);

  useEffect(() => {
    // Load staff data
    const loadStaffData = () => {
      const staffData = JSON.parse(localStorage.getItem('staffData') || '[]');
      console.log('Staff Data page loaded:', staffData.length, 'members');
      setStaff(staffData);
    };
    
    loadStaffData();
    
    // Refresh every 5 seconds to catch new logins
    const interval = setInterval(() => {
      loadStaffData();
    }, 5000);
    
    return () => clearInterval(interval);
  }, [refreshKey]);

  // Add manual refresh button
  const handleRefresh = () => {
    setRefreshKey(prev => prev + 1);
  };

  return (
    <div>
      <div className="page-header">
        <h1>Staff Data</h1>
        <div>
          <button onClick={handleRefresh}>ðŸ”„ Refresh</button>
          <button>Export Staff Report</button>
        </div>
      </div>
      
      <p>Total Staff: {staff.length}</p>
      {/* Rest of your component */}
    </div>
  );
};
```

## Step 3: Check localStorage Sync Issues

The problem might be that localStorage doesn't sync between users/devices. Let's add a temporary check:

```tsx
// Add this temporary debug component to your app
const DebugPanel = () => {
  const [staffCount, setStaffCount] = useState(0);
  
  useEffect(() => {
    const checkStaff = () => {
      const staff = JSON.parse(localStorage.getItem('staffData') || '[]');
      setStaffCount(staff.length);
    };
    
    checkStaff();
    const interval = setInterval(checkStaff, 1000);
    return () => clearInterval(interval);
  }, []);
  
  return (
    <div style={{
      position: 'fixed',
      bottom: 10,
      right: 10,
      background: '#333',
      color: 'white',
      padding: '10px',
      borderRadius: '5px',
      fontSize: '12px'
    }}>
      Debug: {staffCount} staff in localStorage
    </div>
  );
};
```

## Step 4: Immediate Fix - Manual Addition

For now, you can manually add Matt:

```tsx
// Run this in the browser console while on the Staff Data page
const addMatt = () => {
  const staffData = JSON.parse(localStorage.getItem('staffData') || '[]');
  
  const matt = {
    id: 'matt-carlson',
    name: 'Matt Carlson',
    email: 'matt@growspace.farm', // or matt.carlson@growspace.farm
    phone: '',
    roles: ['Corporate Manager'],
    hireDate: '2023-01-01',
    payRate: 0,
    trainingCompleted: [],
    status: 'Active',
    lastActive: new Date().toISOString(),
    location: 'Kenosha',
    department: 'Management'
  };
  
  // Only add if not exists
  if (!staffData.find(s => s.email === matt.email)) {
    staffData.push(matt);
    localStorage.setItem('staffData', JSON.stringify(staffData));
    console.log('Matt added to staff data');
  }
  
  // Refresh the page
  window.location.reload();
};

addMatt();
```

## Step 5: Long-term Solution

The real issue is that localStorage is per-device. For production, you need:

1. **Central Database** (Phase 2)
2. **Temporary Workaround**: Use a shared initial staff list

```tsx
// In your app initialization
const initializeStaffData = () => {
  const existingStaff = localStorage.getItem('staffData');
  
  if (!existingStaff) {
    // Initialize with corporate users
    const initialStaff = [
      {
        id: 'robert-carlson',
        name: 'Robert Carlson',
        email: 'robert@growspace.farm',
        roles: ['Corporate Manager'],
        // ... other fields
      },
      {
        id: 'matt-carlson',
        name: 'Matt Carlson',
        email: 'matt@growspace.farm', // adjust if different
        roles: ['Corporate Manager'],
        // ... other fields
      }
    ];
    
    localStorage.setItem('staffData', JSON.stringify(initialStaff));
  }
};

// Call this on app load
initializeStaffData();
```

The core issue is that each browser has its own localStorage. When Matt logs in on his device, it creates the staff entry in HIS localStorage, not yours. This is why we need a central database for the production version!