{"file_contents":{"client/src/contexts/UserContext.tsx":{"content":"import React, { createContext, useContext, ReactNode } from 'react';\n\ninterface User {\n  id: string;\n  name: string;\n  email: string;\n  role: 'Staff' | 'Manager' | 'Corporate';\n  isManager: boolean;\n  isCorporateManager: boolean;\n  location: string;\n}\n\ninterface UserContextType {\n  currentUser: User | null;\n  setCurrentUser: (user: User | null) => void;\n}\n\nconst UserContext = createContext<UserContextType | undefined>(undefined);\n\nexport const useUser = (): UserContextType => {\n  const context = useContext(UserContext);\n  if (!context) {\n    throw new Error('useUser must be used within a UserProvider');\n  }\n  return context;\n};\n\ninterface UserProviderProps {\n  children: ReactNode;\n  value: UserContextType;\n}\n\nexport const UserProvider: React.FC<UserProviderProps> = ({ children, value }) => {\n  return (\n    <UserContext.Provider value={value}>\n      {children}\n    </UserContext.Provider>\n  );\n};","path":null,"size_bytes":907,"size_tokens":null},"client/src/components/UpdatePropagationWarningDialog.tsx":{"content":"import { AlertDialog, AlertDialogAction, AlertDialogCancel, AlertDialogContent, AlertDialogDescription, AlertDialogFooter, AlertDialogHeader, AlertDialogTitle } from \"@/components/ui/alert-dialog\";\nimport { Button } from \"@/components/ui/button\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { AlertTriangle, Clock, Users, CheckCircle } from \"lucide-react\";\nimport { useState, useEffect } from \"react\";\n\ninterface UpdatePropagationWarningDialogProps {\n  isOpen: boolean;\n  onClose: () => void;\n  onConfirm: (strategy: 'update_all' | 'new_only') => void;\n  changedFields: Array<{ field: string; oldValue: any; newValue: any; requiresNotification: boolean }>;\n  affectedInstanceCount: number;\n  conflictCount: number;\n  taskTitle: string;\n  isProcessing: boolean;\n  processingProgress?: {\n    current: number;\n    total: number;\n    stage: string;\n  };\n}\n\nconst UpdatePropagationWarningDialog: React.FC<UpdatePropagationWarningDialogProps> = ({\n  isOpen,\n  onClose,\n  onConfirm,\n  changedFields,\n  affectedInstanceCount,\n  conflictCount,\n  taskTitle,\n  isProcessing,\n  processingProgress\n}) => {\n  const [selectedStrategy, setSelectedStrategy] = useState<'update_all' | 'new_only'>('update_all');\n\n  // Calculate progress percentage\n  const progressPercentage = processingProgress\n    ? Math.round((processingProgress.current / processingProgress.total) * 100)\n    : 0;\n\n  // Categorize changes for better display\n  const criticalChanges = changedFields.filter(f => ['title', 'checklistTemplate', 'priority'].includes(f.field));\n  const minorChanges = changedFields.filter(f => !['title', 'checklistTemplate', 'priority'].includes(f.field));\n\n  if (!isOpen) return null;\n\n  // Processing/Progress View\n  if (isProcessing && processingProgress) {\n    return (\n      <AlertDialog open={isOpen} onOpenChange={onClose}>\n        <AlertDialogContent className=\"max-w-md\">\n          <AlertDialogHeader>\n            <AlertDialogTitle className=\"flex items-center gap-2\">\n              <Clock className=\"h-5 w-5 animate-spin text-blue-600\" />\n              Updating Task Instances\n            </AlertDialogTitle>\n            <AlertDialogDescription className=\"space-y-4\">\n              <div className=\"text-center\">\n                <div className=\"text-sm text-gray-600 mb-2\">\n                  {processingProgress.stage}\n                </div>\n                <Progress value={progressPercentage} className=\"h-3\" />\n                <div className=\"text-xs text-gray-500 mt-1\">\n                  {processingProgress.current} of {processingProgress.total} tasks ({progressPercentage}%)\n                </div>\n              </div>\n              \n              <div className=\"bg-blue-50 p-3 rounded-md\">\n                <p className=\"text-sm text-blue-800\">\n                  üìã Updating instances of \"{taskTitle}\"\n                </p>\n                <p className=\"text-xs text-blue-600 mt-1\">\n                  Please wait while we apply changes to all affected tasks...\n                </p>\n              </div>\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n        </AlertDialogContent>\n      </AlertDialog>\n    );\n  }\n\n  // Completion View\n  if (isProcessing && !processingProgress) {\n    return (\n      <AlertDialog open={isOpen} onOpenChange={onClose}>\n        <AlertDialogContent className=\"max-w-md\">\n          <AlertDialogHeader>\n            <AlertDialogTitle className=\"flex items-center gap-2 text-green-600\">\n              <CheckCircle className=\"h-5 w-5\" />\n              Update Complete\n            </AlertDialogTitle>\n            <AlertDialogDescription className=\"space-y-3\">\n              <div className=\"bg-green-50 p-3 rounded-md\">\n                <p className=\"text-sm text-green-800\">\n                  ‚úÖ Successfully updated {affectedInstanceCount} task instances\n                </p>\n                {conflictCount > 0 && (\n                  <p className=\"text-xs text-orange-600 mt-1\">\n                    ‚ö†Ô∏è {conflictCount} instances had conflicts (notifications sent to assignees)\n                  </p>\n                )}\n              </div>\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogAction onClick={onClose} data-testid=\"button-close-completion\">\n              Done\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n    );\n  }\n\n  // Warning/Confirmation View\n  return (\n    <AlertDialog open={isOpen} onOpenChange={onClose}>\n      <AlertDialogContent className=\"max-w-2xl\">\n        <AlertDialogHeader>\n          <AlertDialogTitle className=\"flex items-center gap-2 text-orange-600\">\n            <AlertTriangle className=\"h-5 w-5\" />\n            Update Recurring Task Template\n          </AlertDialogTitle>\n          <AlertDialogDescription className=\"space-y-4\">\n            <div className=\"bg-orange-50 border border-orange-200 p-4 rounded-md\">\n              <p className=\"text-sm text-orange-800 font-medium\">\n                This change will affect {affectedInstanceCount} future instances of \"{taskTitle}\"\n              </p>\n              {conflictCount > 0 && (\n                <p className=\"text-xs text-red-600 mt-1\">\n                  ‚ö†Ô∏è {conflictCount} instances are in-progress and may have conflicts\n                </p>\n              )}\n            </div>\n\n            {/* Changes Summary */}\n            <div className=\"space-y-3\">\n              <h4 className=\"font-medium text-sm text-gray-700\">Changes being made:</h4>\n              \n              {criticalChanges.length > 0 && (\n                <div className=\"bg-red-50 p-3 rounded-md\">\n                  <p className=\"text-xs font-medium text-red-700 mb-2\">Critical Changes:</p>\n                  {criticalChanges.map((change, index) => (\n                    <div key={index} className=\"text-xs text-red-600\">\n                      ‚Ä¢ <span className=\"font-medium\">{change.field}:</span> \"{String(change.oldValue)}\" ‚Üí \"{String(change.newValue)}\"\n                    </div>\n                  ))}\n                </div>\n              )}\n\n              {minorChanges.length > 0 && (\n                <div className=\"bg-blue-50 p-3 rounded-md\">\n                  <p className=\"text-xs font-medium text-blue-700 mb-2\">Other Changes:</p>\n                  {minorChanges.map((change, index) => (\n                    <div key={index} className=\"text-xs text-blue-600\">\n                      ‚Ä¢ <span className=\"font-medium\">{change.field}:</span> \"{String(change.oldValue)}\" ‚Üí \"{String(change.newValue)}\"\n                    </div>\n                  ))}\n                </div>\n              )}\n            </div>\n\n            {/* Strategy Selection */}\n            <div className=\"space-y-3\">\n              <h4 className=\"font-medium text-sm text-gray-700\">What should we do?</h4>\n              \n              <div className=\"space-y-2\">\n                <label className=\"flex items-start gap-3 p-3 border rounded-md cursor-pointer hover:bg-gray-50\">\n                  <input\n                    type=\"radio\"\n                    name=\"strategy\"\n                    value=\"update_all\"\n                    checked={selectedStrategy === 'update_all'}\n                    onChange={(e) => setSelectedStrategy(e.target.value as 'update_all')}\n                    className=\"mt-1\"\n                    data-testid=\"radio-update-all\"\n                  />\n                  <div>\n                    <div className=\"font-medium text-sm text-green-700\">\n                      Update all future instances (Recommended)\n                    </div>\n                    <div className=\"text-xs text-gray-600\">\n                      Apply changes to all {affectedInstanceCount} future tasks. Completed tasks won't be affected.\n                    </div>\n                  </div>\n                </label>\n\n                <label className=\"flex items-start gap-3 p-3 border rounded-md cursor-pointer hover:bg-gray-50\">\n                  <input\n                    type=\"radio\"\n                    name=\"strategy\"\n                    value=\"new_only\"\n                    checked={selectedStrategy === 'new_only'}\n                    onChange={(e) => setSelectedStrategy(e.target.value as 'new_only')}\n                    className=\"mt-1\"\n                    data-testid=\"radio-new-only\"\n                  />\n                  <div>\n                    <div className=\"font-medium text-sm text-blue-700\">\n                      Only apply to newly created tasks\n                    </div>\n                    <div className=\"text-xs text-gray-600\">\n                      Keep existing instances unchanged. Only future instances will use the new template.\n                    </div>\n                  </div>\n                </label>\n              </div>\n            </div>\n\n            <div className=\"bg-gray-50 p-3 rounded-md text-xs text-gray-600\">\n              <p><strong>Note:</strong> Completed tasks will never be affected. In-progress tasks will preserve user data and show update notifications.</p>\n            </div>\n          </AlertDialogDescription>\n        </AlertDialogHeader>\n        \n        <AlertDialogFooter>\n          <AlertDialogCancel onClick={onClose} data-testid=\"button-cancel-update\">\n            Cancel Changes\n          </AlertDialogCancel>\n          <AlertDialogAction\n            onClick={() => onConfirm(selectedStrategy)}\n            className=\"bg-orange-600 hover:bg-orange-700\"\n            data-testid=\"button-confirm-update\"\n          >\n            <Users className=\"h-4 w-4 mr-2\" />\n            Update {selectedStrategy === 'update_all' ? affectedInstanceCount : 'New'} Tasks\n          </AlertDialogAction>\n        </AlertDialogFooter>\n      </AlertDialogContent>\n    </AlertDialog>\n  );\n};\n\nexport default UpdatePropagationWarningDialog;","path":null,"size_bytes":9834,"size_tokens":null},"client/src/components/InventoryModal.tsx":{"content":"import React, { useState, useEffect } from \"react\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription } from \"@/components/ui/dialog\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Trash2 } from \"lucide-react\";\nimport { InventoryItem } from \"@shared/schema\";\nimport { useLocation } from \"@/contexts/LocationContext\";\nimport { locations } from \"@/data/locationsData\";\n\ninterface InventoryModalProps {\n  item: InventoryItem | null;\n  mode: 'add' | 'edit';\n  isOpen: boolean;\n  onSave: (itemData: any) => void;\n  onDelete?: (itemId: number) => void;\n  onClose: () => void;\n}\n\nconst InventoryModal: React.FC<InventoryModalProps> = ({\n  item,\n  mode,\n  isOpen,\n  onSave,\n  onDelete,\n  onClose\n}) => {\n  const { currentLocation } = useLocation();\n  const [formData, setFormData] = useState(() => {\n    if (mode === 'edit' && item) {\n      // Handle null values properly - convert null to number or use 0 as fallback\n      const currentStock = typeof item.currentStock === 'number' ? item.currentStock : (item.currentStock || 0);\n      const minimumStock = typeof item.minimumStock === 'number' ? item.minimumStock : (item.minimumStock || 0);\n      \n      return {\n        name: item.name,\n        sku: item.sku || (item as any).productCode || '',\n        currentStock: currentStock,\n        unit: item.unit,\n        minimumStock: minimumStock,\n        category: item.category,\n        supplier: item.supplier || '',\n        location: item.location || currentLocation.code,\n        estimatedTotalValue: item?.totalValue?.toString() || '' // Not shown for edit mode\n      };\n    }\n    return {\n      name: '',\n      sku: '',\n      currentStock: 0,\n      unit: 'units',\n      minimumStock: 0,\n      category: 'other-supplies',\n      supplier: '',\n      location: currentLocation.code,\n      estimatedTotalValue: ''\n    };\n  });\n\n  // Update form data when item changes OR when modal opens\n  useEffect(() => {\n    if (mode === 'edit' && item) {\n      console.log('Edit form - item data:', item); // Debug log\n      console.log('Available fields:', Object.keys(item)); // Debug log\n      \n      // Handle null values properly - convert null to number or use 0 as fallback\n      const currentStock = typeof item.currentStock === 'number' ? item.currentStock : (item.currentStock || 0);\n      const minimumStock = typeof item.minimumStock === 'number' ? item.minimumStock : (item.minimumStock || 0);\n      \n      console.log('Current stock value:', currentStock, 'Minimum stock value:', minimumStock); // Debug log\n      \n      const newFormData = {\n        name: item.name,\n        sku: item.sku || (item as any).productCode || '',\n        currentStock: currentStock,\n        unit: item.unit,\n        minimumStock: minimumStock,\n        category: item.category,\n        supplier: item.supplier || '',\n        location: item.location || currentLocation.code,\n        estimatedTotalValue: '' // Not used in edit mode\n      };\n      \n      console.log('Setting form data:', newFormData); // Debug log\n      setFormData(newFormData);\n    } else if (mode === 'add') {\n      setFormData({\n        name: '',\n        sku: '',\n        currentStock: 0,\n        unit: 'units',\n        minimumStock: 0,\n        category: 'other-supplies',\n        supplier: '',\n        estimatedTotalValue: ''\n      });\n    }\n  }, [item, mode, isOpen]);\n\n  const handleSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    \n    if (!formData.name.trim()) {\n      alert('Please enter an item name');\n      return;\n    }\n    \n    if (!formData.sku.trim()) {\n      alert('Please enter a SKU');\n      return;\n    }\n    \n    if (formData.sku.length > 4) {\n      alert('SKU must be 4 characters or less');\n      return;\n    }\n    \n    if ((formData.currentStock || 0) < 0 || (formData.minimumStock || 0) < 0) {\n      alert('Stock quantities cannot be negative');\n      return;\n    }\n\n    // Validation for add mode with cost tracking\n    if (mode === 'add') {\n      const stock = parseInt(formData.currentStock.toString()) || 0;\n      const totalValue = parseFloat(formData.estimatedTotalValue) || 0;\n      \n      if (totalValue > 0 && stock === 0) {\n        alert('Cannot have a value without any stock quantity');\n        return;\n      }\n      \n      if (stock > 0 && totalValue === 0) {\n        if (!confirm('Are you sure the total value is $0.00? This will set cost per unit to $0.00')) {\n          return;\n        }\n      }\n    }\n\n    // Calculate cost data for new items\n    const stock = parseInt((formData.currentStock || 0).toString()) || 0;\n    const totalValue = parseFloat(formData.estimatedTotalValue) || 0;\n    const costPerUnit = stock > 0 ? totalValue / stock : 0;\n\n    const itemData = {\n      ...formData,\n      currentStock: stock,\n      minimumStock: parseInt(formData.minimumStock.toString()),\n      id: item?.id,\n      // Add cost tracking fields for new items\n      ...(mode === 'add' && {\n        avgCostPerUnit: costPerUnit,\n        totalValue: totalValue\n      })\n    };\n    \n    onSave(itemData);\n  };\n\n  const handleDelete = () => {\n    if (item && onDelete) {\n      if (confirm(`Are you sure you want to delete \"${item.name}\"? This action cannot be undone.`)) {\n        onDelete(item.id);\n      }\n    }\n  };\n\n  const categories = [\n    { value: 'seeds', label: 'Seeds' },\n    { value: 'nutrients', label: 'Nutrients' },\n    { value: 'farm-supplies', label: 'Farm Supplies' },\n    { value: 'other-supplies', label: 'Other Supplies' },\n    { value: 'equipment', label: 'Equipment' }\n  ];\n\n  const units = [\n    { value: 'units', label: 'Units' },\n    { value: 'kg', label: 'Kilograms' },\n    { value: 'lbs', label: 'Pounds' },\n    { value: 'oz', label: 'Ounces' },\n    { value: 'liters', label: 'Liters' },\n    { value: 'packets', label: 'Packets' },\n    { value: 'bags', label: 'Bags' },\n    { value: 'pieces', label: 'Pieces' }\n  ];\n\n  // Calculate cost per unit for display\n  const calculateCostPerUnit = () => {\n    const stock = parseFloat(formData.currentStock.toString()) || 0;\n    const totalValue = parseFloat(formData.estimatedTotalValue) || 0;\n    \n    if (stock > 0 && totalValue > 0) {\n      return (totalValue / stock).toFixed(2);\n    }\n    return '0.00';\n  };\n\n  return (\n    <Dialog open={isOpen} onOpenChange={onClose}>\n      <DialogContent className=\"max-w-md\">\n        <DialogHeader>\n          <DialogTitle className=\"text-[#203B17]\">\n            {mode === 'edit' ? 'Edit Inventory Item' : 'Add New Item'}\n          </DialogTitle>\n          <DialogDescription>\n            {mode === 'edit' ? 'Update the inventory item details below.' : 'Enter the details for the new inventory item.'}\n          </DialogDescription>\n\n        </DialogHeader>\n        \n        <form onSubmit={handleSubmit} className=\"space-y-4\">\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"name\">Item Name *</Label>\n            <Input\n              id=\"name\"\n              type=\"text\"\n              value={formData.name}\n              onChange={(e) => setFormData({...formData, name: e.target.value})}\n              placeholder=\"e.g., Arugula Seeds\"\n              required\n            />\n          </div>\n\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"sku\">SKU (4 characters max) *</Label>\n            <Input\n              id=\"sku\"\n              type=\"text\"\n              value={formData.sku}\n              onChange={(e) => setFormData({...formData, sku: e.target.value.toUpperCase().slice(0, 4)})}\n              placeholder=\"ARUG\"\n              maxLength={4}\n              required\n            />\n            <p className=\"text-sm text-gray-600\">4-character code for tray IDs (e.g., ARUG, ROM2, BASL)</p>\n          </div>\n\n          <div className=\"grid grid-cols-2 gap-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"currentStock\">Current Stock *</Label>\n              <Input\n                id=\"currentStock\"\n                type=\"number\"\n                value={formData.currentStock?.toString() || ''}\n                onChange={(e) => setFormData({...formData, currentStock: parseInt(e.target.value) || 0})}\n                min=\"0\"\n                required\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"unit\">Unit</Label>\n              <Select value={formData.unit} onValueChange={(value) => setFormData({...formData, unit: value})}>\n                <SelectTrigger>\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  {units.map((unit) => (\n                    <SelectItem key={unit.value} value={unit.value}>\n                      {unit.label}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n          </div>\n\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"minimumStock\">Minimum Stock *</Label>\n            <Input\n              id=\"minimumStock\"\n              type=\"number\"\n              value={formData.minimumStock?.toString() || ''}\n              onChange={(e) => setFormData({...formData, minimumStock: parseInt(e.target.value) || 0})}\n              min=\"0\"\n              required\n            />\n            <p className=\"text-sm text-gray-600\">Alert threshold for low stock</p>\n          </div>\n\n          {/* Estimated Total Value field - only for add mode */}\n          {mode === 'add' && (\n            <>\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"estimatedTotalValue\">Estimated Total Value ($)</Label>\n                <Input\n                  id=\"estimatedTotalValue\"\n                  type=\"number\"\n                  min=\"0\"\n                  step=\"0.01\"\n                  value={formData.estimatedTotalValue}\n                  onChange={(e) => setFormData({...formData, estimatedTotalValue: e.target.value})}\n                  placeholder=\"e.g., 50.00\"\n                />\n                <p className=\"text-sm text-gray-600\">\n                  Enter the estimated total value of your current stock (not per unit)\n                </p>\n              </div>\n\n              {/* Show calculated cost per unit if both values are entered */}\n              {(formData.currentStock || 0) > 0 && formData.estimatedTotalValue && (\n                <div className=\"bg-gray-50 p-3 rounded-lg border\">\n                  <p className=\"text-sm font-medium text-gray-700\">\n                    Calculated Cost Per {formData.unit}: <span className=\"text-[#203B17] font-bold\">${calculateCostPerUnit()}</span>\n                  </p>\n                </div>\n              )}\n            </>\n          )}\n\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"category\">Category</Label>\n            <Select value={formData.category} onValueChange={(value) => setFormData({...formData, category: value})}>\n              <SelectTrigger>\n                <SelectValue />\n              </SelectTrigger>\n              <SelectContent>\n                {categories.map((category) => (\n                  <SelectItem key={category.value} value={category.value}>\n                    {category.label}\n                  </SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n          </div>\n\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"supplier\">Supplier</Label>\n            <Input\n              id=\"supplier\"\n              type=\"text\"\n              value={formData.supplier}\n              onChange={(e) => setFormData({...formData, supplier: e.target.value})}\n              placeholder=\"e.g., Green Thumb Seeds\"\n            />\n          </div>\n\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"location\">Location</Label>\n            <Select value={formData.location} onValueChange={(value) => setFormData({...formData, location: value})}>\n              <SelectTrigger>\n                <SelectValue />\n              </SelectTrigger>\n              <SelectContent>\n                {locations.map((location) => (\n                  <SelectItem key={location.code} value={location.code}>\n                    {location.name} ({location.code})\n                  </SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n          </div>\n\n          <div className=\"flex justify-between pt-4\">\n            <div>\n              {mode === 'edit' && item && onDelete && (\n                <Button\n                  type=\"button\"\n                  variant=\"destructive\"\n                  onClick={handleDelete}\n                  className=\"flex items-center gap-2\"\n                >\n                  <Trash2 className=\"h-4 w-4\" />\n                  Delete\n                </Button>\n              )}\n            </div>\n            <div className=\"flex gap-2\">\n              <Button type=\"button\" variant=\"outline\" onClick={onClose}>\n                Cancel\n              </Button>\n              <Button type=\"submit\" className=\"bg-[#2D8028] hover:bg-[#203B17]\">\n                {mode === 'edit' ? 'Save Changes' : 'Add Item'}\n              </Button>\n            </div>\n          </div>\n        </form>\n      </DialogContent>\n    </Dialog>\n  );\n};\n\nexport default InventoryModal;","path":null,"size_bytes":13390,"size_tokens":null},"client/src/contexts/LocationContext.tsx":{"content":"import React, { createContext, useContext, useState, useEffect } from 'react';\nimport { Location, locations } from '../data/locationsData';\nimport { getStoredAuth } from '../lib/auth';\n\ninterface LocationContextType {\n  currentLocation: Location;\n  availableLocations: Location[];\n  switchLocation: (locationId: string) => void;\n  viewMode: 'single' | 'all'; // For corporate managers\n  setViewMode: (mode: 'single' | 'all') => void;\n  canSwitchLocations: boolean;\n  isViewingAllLocations: boolean;\n}\n\nconst LocationContext = createContext<LocationContextType | undefined>(undefined);\n\nexport const LocationProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {\n  const auth = getStoredAuth();\n  const isCorporate = auth.user?.role === 'corporate';\n  \n  // Get initial location\n  const getInitialLocation = () => {\n    if (isCorporate) {\n      // Corporate users default to first location but can switch\n      const saved = localStorage.getItem('selectedLocation');\n      return locations.find(l => l.id === saved) || locations[0];\n    } else {\n      // Non-corporate users are locked to their assigned location\n      // For now, default to Kenosha since our test users don't have assigned locations\n      return locations.find(l => l.id === 'kenosha') || locations[0];\n    }\n  };\n  \n  const [currentLocation, setCurrentLocation] = useState<Location>(getInitialLocation());\n  const [viewMode, setViewMode] = useState<'single' | 'all'>('single');\n  \n  const switchLocation = (locationId: string) => {\n    if (!isCorporate) {\n      console.warn('Non-corporate users cannot switch locations');\n      return;\n    }\n    \n    const newLocation = locations.find(l => l.id === locationId);\n    if (newLocation) {\n      setCurrentLocation(newLocation);\n      localStorage.setItem('selectedLocation', locationId);\n      setViewMode('single'); // Reset to single view when switching\n    }\n  };\n  \n  const handleViewModeChange = (mode: 'single' | 'all') => {\n    if (!isCorporate) return;\n    setViewMode(mode);\n  };\n  \n  const contextValue: LocationContextType = {\n    currentLocation,\n    availableLocations: isCorporate ? locations : locations.filter(l => l.id === currentLocation.id),\n    switchLocation,\n    viewMode,\n    setViewMode: handleViewModeChange,\n    canSwitchLocations: isCorporate,\n    isViewingAllLocations: isCorporate && viewMode === 'all'\n  };\n  \n  return (\n    <LocationContext.Provider value={contextValue}>\n      {children}\n    </LocationContext.Provider>\n  );\n};\n\nexport const useLocation = () => {\n  const context = useContext(LocationContext);\n  if (!context) {\n    throw new Error('useLocation must be used within LocationProvider');\n  }\n  return context;\n};","path":null,"size_bytes":2691,"size_tokens":null},"client/src/components/ui/progress.tsx":{"content":"import * as React from \"react\"\nimport * as ProgressPrimitive from \"@radix-ui/react-progress\"\nimport { cn } from \"@/lib/utils\"\n\nconst Progress = React.forwardRef<\n  React.ElementRef<typeof ProgressPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ProgressPrimitive.Root>\n>(({ className, value, ...props }, ref) => (\n  <ProgressPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative h-2 w-full overflow-hidden rounded-full bg-secondary\",\n      className\n    )}\n    {...props}\n  >\n    <ProgressPrimitive.Indicator\n      className=\"h-full w-full flex-1 bg-primary transition-all\"\n      style={{ transform: `translateX(-${100 - (value || 0)}%)` }}\n    />\n  </ProgressPrimitive.Root>\n))\nProgress.displayName = ProgressPrimitive.Root.displayName\n\nexport { Progress }","path":null,"size_bytes":775,"size_tokens":null},"client/src/services/taskCompletionService.ts":{"content":"// Service for handling task completion and tray creation integration\nimport { TrayService } from './trayService';\nimport { calculateHarvestDate } from '../data/initialData';\n\ninterface TaskCompletionData {\n  taskId: number;\n  title: string;\n  type: string;\n  checklistData?: any[];\n  completedBy?: number;\n}\n\nexport const TaskCompletionService = {\n  // Handle task completion and create trays for seeding tasks\n  handleTaskCompletion(task: TaskCompletionData): void {\n    console.log('Processing task completion:', task.title, task.type);\n    \n    // Check if this is a seeding task\n    if (this.isSeedingTask(task.type, task.title)) {\n      this.createTraysFromSeedingTask(task);\n    }\n    \n    // Handle other task types that might affect trays\n    if (this.isHarvestTask(task.type, task.title)) {\n      this.handleHarvestCompletion(task);\n    }\n    \n    if (this.isMovementTask(task.type, task.title)) {\n      this.handleMovementCompletion(task);\n    }\n  },\n\n  // Check if task is a seeding task\n  isSeedingTask(taskType: string, taskTitle: string): boolean {\n    const seedingTypes = ['seeding', 'seeding - microgreens', 'seeding - leafy greens'];\n    const seedingKeywords = ['seed', 'plant', 'sow'];\n    \n    return (\n      seedingTypes.some(type => taskType.toLowerCase().includes(type.toLowerCase())) ||\n      seedingKeywords.some(keyword => taskTitle.toLowerCase().includes(keyword))\n    );\n  },\n\n  // Check if task is a harvest task\n  isHarvestTask(taskType: string, taskTitle: string): boolean {\n    const harvestTypes = ['harvest', 'harvesting'];\n    const harvestKeywords = ['harvest', 'pick', 'collect'];\n    \n    return (\n      harvestTypes.some(type => taskType.toLowerCase().includes(type.toLowerCase())) ||\n      harvestKeywords.some(keyword => taskTitle.toLowerCase().includes(keyword))\n    );\n  },\n\n  // Check if task is a movement task\n  isMovementTask(taskType: string, taskTitle: string): boolean {\n    const movementTypes = ['moving', 'movement', 'transfer'];\n    const movementKeywords = ['move', 'transfer', 'relocate'];\n    \n    return (\n      movementTypes.some(type => taskType.toLowerCase().includes(type.toLowerCase())) ||\n      movementKeywords.some(keyword => taskTitle.toLowerCase().includes(keyword))\n    );\n  },\n\n  // Create trays from seeding task completion\n  createTraysFromSeedingTask(task: TaskCompletionData): void {\n    try {\n      // Extract crop information from task\n      const cropType = this.extractCropType(task.title, task.type);\n      const cropName = this.extractCropName(task.title);\n      const trayCount = this.extractTrayCount(task.checklistData) || 1;\n      \n      console.log(`Creating ${trayCount} trays for ${cropName} (${cropType})`);\n      \n      // Create trays\n      const createdTrays = [];\n      for (let i = 0; i < trayCount; i++) {\n        const tray = TrayService.createTrayFromSeedingTask({\n          taskId: task.taskId,\n          cropType: cropType,\n          cropName: cropName,\n          location: 'Nursery', // Default starting location\n          checklistData: task.checklistData\n        });\n        createdTrays.push(tray);\n      }\n      \n      console.log(`Successfully created ${createdTrays.length} trays from seeding task`);\n    } catch (error) {\n      console.error('Error creating trays from seeding task:', error);\n    }\n  },\n\n  // Extract crop type from task information\n  extractCropType(title: string, type: string): string {\n    const title_lower = title.toLowerCase();\n    const type_lower = type.toLowerCase();\n    \n    // Check for microgreens\n    if (type_lower.includes('microgreen') || title_lower.includes('microgreen')) {\n      return 'microgreen';\n    }\n    \n    // Check for leafy greens\n    if (type_lower.includes('leafy') || \n        title_lower.includes('lettuce') || \n        title_lower.includes('spinach') || \n        title_lower.includes('arugula') || \n        title_lower.includes('kale')) {\n      return 'leafy-green';\n    }\n    \n    // Check for herbs\n    if (title_lower.includes('basil') || \n        title_lower.includes('cilantro') || \n        title_lower.includes('parsley')) {\n      return 'leafy-green'; // Herbs are treated as leafy greens in our system\n    }\n    \n    // Default to leafy-green\n    return 'leafy-green';\n  },\n\n  // Extract crop name from task title\n  extractCropName(title: string): string {\n    // Remove common task prefixes\n    let cropName = title\n      .replace(/^(seed|plant|sow)\\s+/i, '')\n      .replace(/\\s+(seeds?|seedlings?|plants?)$/i, '')\n      .trim();\n    \n    // Capitalize first letter\n    return cropName.charAt(0).toUpperCase() + cropName.slice(1);\n  },\n\n  // Extract tray count from checklist data\n  extractTrayCount(checklistData?: any[]): number {\n    if (!checklistData) return 1;\n    \n    // Look for number inputs that might indicate tray count\n    const trayCountItem = checklistData.find(item => \n      item.label?.toLowerCase().includes('tray') ||\n      item.label?.toLowerCase().includes('number') ||\n      item.type === 'number-input'\n    );\n    \n    return trayCountItem?.value || 1;\n  },\n\n  // Handle harvest task completion\n  handleHarvestCompletion(task: TaskCompletionData): void {\n    // Implementation for harvest tasks - mark trays as harvested\n    console.log('Processing harvest task completion:', task.title);\n    // This would be implemented based on checklist data indicating which trays were harvested\n  },\n\n  // Handle movement task completion\n  handleMovementCompletion(task: TaskCompletionData): void {\n    // Implementation for movement tasks - update tray locations\n    console.log('Processing movement task completion:', task.title);\n    // This would be implemented based on checklist data indicating tray movements\n  }\n};","path":null,"size_bytes":5707,"size_tokens":null},"client/src/hooks/useActivityTracking.ts":{"content":"import { useEffect } from 'react';\nimport { apiRequest } from '@/lib/queryClient';\n\n// Helper function to update user activity\nexport const updateUserActivity = async (userId: string) => {\n  try {\n    await apiRequest('POST', `/api/users/${userId}/activity`);\n  } catch (error) {\n    console.error('Failed to update user activity:', error);\n  }\n};\n\n// Format the Last Active display\nexport const formatLastActive = (lastActive: string | null) => {\n  if (!lastActive) return 'Never';\n  \n  const date = new Date(lastActive);\n  const now = new Date();\n  const diffMs = now.getTime() - date.getTime();\n  const diffMins = Math.floor(diffMs / 60000);\n  const diffHours = Math.floor(diffMs / 3600000);\n  const diffDays = Math.floor(diffMs / 86400000);\n  \n  if (diffMins < 1) return 'Just now';\n  if (diffMins < 60) return `${diffMins} mins ago`;\n  if (diffHours < 24) return `${diffHours} hours ago`;\n  if (diffDays < 7) return `${diffDays} days ago`;\n  \n  // For older dates, show the actual date\n  return date.toLocaleDateString('en-US', {\n    month: 'short',\n    day: 'numeric',\n    year: date.getFullYear() !== now.getFullYear() ? 'numeric' : undefined\n  });\n};\n\n// Activity tracking hook\nexport const useActivityTracking = (userId: string | null) => {\n  useEffect(() => {\n    if (!userId) return;\n    \n    // Update immediately on mount\n    updateUserActivity(userId);\n    \n    // Update every 5 minutes\n    const interval = setInterval(() => {\n      updateUserActivity(userId);\n    }, 5 * 60 * 1000);\n    \n    // Update on user interaction\n    const handleUserActivity = () => {\n      updateUserActivity(userId);\n    };\n    \n    // Listen for clicks or key presses\n    document.addEventListener('click', handleUserActivity);\n    document.addEventListener('keypress', handleUserActivity);\n    \n    return () => {\n      clearInterval(interval);\n      document.removeEventListener('click', handleUserActivity);\n      document.removeEventListener('keypress', handleUserActivity);\n    };\n  }, [userId]);\n};","path":null,"size_bytes":2000,"size_tokens":null},"client/src/components/NotificationDropdown.tsx":{"content":"import React from \"react\";\nimport { useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { \n  Bell, \n  CheckCircle, \n  AlertTriangle, \n  BookOpen, \n  Clock, \n  Package, \n  User,\n  Check\n} from \"lucide-react\";\nimport { Notification } from \"@shared/schema\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { formatDistanceToNow } from \"date-fns\";\n\ninterface NotificationDropdownProps {\n  notifications: Notification[];\n  onClose: () => void;\n}\n\nconst getNotificationIcon = (type: string) => {\n  switch (type) {\n    case 'task_overdue':\n      return <AlertTriangle className=\"h-4 w-4 text-red-500\" />;\n    case 'task_assigned':\n      return <User className=\"h-4 w-4 text-blue-500\" />;\n    case 'course_assigned':\n      return <BookOpen className=\"h-4 w-4 text-green-600\" />;\n    case 'task_acknowledged':\n      return <CheckCircle className=\"h-4 w-4 text-green-500\" />;\n    case 'urgent_task':\n      return <AlertTriangle className=\"h-4 w-4 text-orange-500\" />;\n    case 'course_due_soon':\n      return <Clock className=\"h-4 w-4 text-yellow-500\" />;\n    case 'inventory_low':\n      return <Package className=\"h-4 w-4 text-purple-500\" />;\n    default:\n      return <Bell className=\"h-4 w-4 text-gray-500\" />;\n  }\n};\n\nconst getNotificationColor = (type: string) => {\n  switch (type) {\n    case 'task_overdue':\n    case 'urgent_task':\n      return 'border-l-red-500';\n    case 'task_assigned':\n      return 'border-l-blue-500';\n    case 'course_assigned':\n      return 'border-l-green-600';\n    case 'task_acknowledged':\n      return 'border-l-green-500';\n    case 'course_due_soon':\n      return 'border-l-yellow-500';\n    case 'inventory_low':\n      return 'border-l-purple-500';\n    default:\n      return 'border-l-gray-300';\n  }\n};\n\nconst NotificationDropdown: React.FC<NotificationDropdownProps> = ({\n  notifications,\n  onClose\n}) => {\n  const queryClient = useQueryClient();\n\n  const markAsReadMutation = useMutation({\n    mutationFn: (notificationId: number) =>\n      apiRequest('PATCH', `/api/notifications/${notificationId}`, { isRead: true }),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/notifications'] });\n    }\n  });\n\n  const markAllAsReadMutation = useMutation({\n    mutationFn: () =>\n      apiRequest('PATCH', '/api/notifications/mark-all-read', {}),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/notifications'] });\n    }\n  });\n\n  const handleNotificationClick = (notification: Notification) => {\n    if (!notification.isRead) {\n      markAsReadMutation.mutate(notification.id);\n    }\n    onClose();\n  };\n\n  const handleMarkAllAsRead = () => {\n    markAllAsReadMutation.mutate();\n  };\n\n  const unreadCount = notifications.filter(n => !n.isRead).length;\n\n  return (\n    <div className=\"absolute top-12 right-0 w-96 bg-white border border-gray-200 rounded-lg shadow-lg z-50\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between p-4 border-b border-gray-100\">\n        <div className=\"flex items-center gap-2\">\n          <Bell className=\"h-5 w-5 text-gray-600\" />\n          <h3 className=\"font-semibold text-gray-900\">Notifications</h3>\n          {unreadCount > 0 && (\n            <Badge variant=\"secondary\" className=\"ml-1\">\n              {unreadCount}\n            </Badge>\n          )}\n        </div>\n        {unreadCount > 0 && (\n          <Button\n            variant=\"ghost\"\n            size=\"sm\"\n            onClick={handleMarkAllAsRead}\n            disabled={markAllAsReadMutation.isPending}\n            className=\"text-xs\"\n          >\n            <Check className=\"h-3 w-3 mr-1\" />\n            Mark all read\n          </Button>\n        )}\n      </div>\n\n      {/* Notification List */}\n      <ScrollArea className=\"max-h-96\">\n        {notifications.length === 0 ? (\n          <div className=\"p-8 text-center text-gray-500\">\n            <Bell className=\"h-12 w-12 mx-auto mb-3 text-gray-300\" />\n            <p className=\"text-sm\">No notifications yet</p>\n          </div>\n        ) : (\n          <div className=\"divide-y divide-gray-100\">\n            {notifications.map((notification) => (\n              <div\n                key={notification.id}\n                onClick={() => handleNotificationClick(notification)}\n                className={`p-4 cursor-pointer hover:bg-gray-50 transition-colors border-l-4 ${getNotificationColor(notification.type)} ${\n                  !notification.isRead ? 'bg-blue-50' : ''\n                }`}\n              >\n                <div className=\"flex items-start gap-3\">\n                  <div className=\"flex-shrink-0 mt-0.5\">\n                    {getNotificationIcon(notification.type)}\n                  </div>\n                  <div className=\"flex-1 min-w-0\">\n                    <div className=\"flex items-center justify-between mb-1\">\n                      <p className={`text-sm font-medium truncate ${\n                        !notification.isRead ? 'text-gray-900' : 'text-gray-700'\n                      }`}>\n                        {notification.title}\n                      </p>\n                      {!notification.isRead && (\n                        <div className=\"w-2 h-2 bg-blue-500 rounded-full flex-shrink-0 ml-2\" />\n                      )}\n                    </div>\n                    <p className=\"text-sm text-gray-600 leading-relaxed mb-2\">\n                      {notification.message}\n                    </p>\n                    <p className=\"text-xs text-gray-400\">\n                      {formatDistanceToNow(new Date(notification.createdAt!), { addSuffix: true })}\n                    </p>\n                  </div>\n                </div>\n              </div>\n            ))}\n          </div>\n        )}\n      </ScrollArea>\n\n      {/* Footer */}\n      {notifications.length > 0 && (\n        <>\n          <Separator />\n          <div className=\"p-3 text-center\">\n            <Button\n              variant=\"ghost\"\n              size=\"sm\"\n              onClick={onClose}\n              className=\"text-xs text-gray-600 hover:text-gray-900\"\n            >\n              Close notifications\n            </Button>\n          </div>\n        </>\n      )}\n    </div>\n  );\n};\n\nexport default NotificationDropdown;","path":null,"size_bytes":6398,"size_tokens":null},"client/src/lib/utils.ts":{"content":"import { clsx, type ClassValue } from \"clsx\"\nimport { twMerge } from \"tailwind-merge\"\n\nexport function cn(...inputs: ClassValue[]) {\n  return twMerge(clsx(inputs))\n}\n","path":null,"size_bytes":166,"size_tokens":null},"client/src/components/TaskCostAnalysis.tsx":{"content":"import React, { useState, useMemo } from 'react';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Badge } from '@/components/ui/badge';\nimport { Button } from '@/components/ui/button';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { \n  BarChart, Bar, LineChart, Line, PieChart, Pie, Cell, \n  XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Legend \n} from 'recharts';\nimport { \n  DollarSign, TrendingUp, TrendingDown, Package, Clock, \n  Target, AlertTriangle, Lightbulb, ShoppingCart \n} from 'lucide-react';\nimport { useLocation } from '@/contexts/LocationContext';\n\ninterface TaskCostData {\n  taskType: string;\n  instances: number;\n  avgLaborCost: number;\n  avgMaterialCost: number;\n  totalAvgCost: number;\n  trend: number;\n}\n\ninterface CropCostData {\n  crop: string;\n  unitsProduced: number;\n  totalLaborCost: number;\n  totalMaterialCost: number;\n  totalCost: number;\n  costPerUnit: number;\n  marketPrice: number;\n  profitMargin: number;\n}\n\nexport const TaskCostAnalysis: React.FC = () => {\n  const { currentLocation, isViewingAllLocations } = useLocation();\n  const [viewType, setViewType] = useState<'task' | 'crop' | 'location'>('task');\n  const [dateRange, setDateRange] = useState('30d');\n\n  // Mock cost data - replace with real API data\n  const taskCostData: TaskCostData[] = useMemo(() => [\n    {\n      taskType: 'Seed Romaine Lettuce',\n      instances: 45,\n      avgLaborCost: 8.75,\n      avgMaterialCost: 2.50,\n      totalAvgCost: 11.25,\n      trend: -0.5\n    },\n    {\n      taskType: 'Harvest Microgreens',\n      instances: 120,\n      avgLaborCost: 15.20,\n      avgMaterialCost: 0.25,\n      totalAvgCost: 15.45,\n      trend: 1.2\n    },\n    {\n      taskType: 'pH Testing',\n      instances: 24,\n      avgLaborCost: 12.50,\n      avgMaterialCost: 3.75,\n      totalAvgCost: 16.25,\n      trend: 0\n    },\n    {\n      taskType: 'System Cleaning',\n      instances: 30,\n      avgLaborCost: 22.30,\n      avgMaterialCost: 5.20,\n      totalAvgCost: 27.50,\n      trend: -2.1\n    }\n  ], []);\n\n  const cropCostData: CropCostData[] = useMemo(() => [\n    {\n      crop: 'Romaine Lettuce',\n      unitsProduced: 1250,\n      totalLaborCost: 1875,\n      totalMaterialCost: 625,\n      totalCost: 2500,\n      costPerUnit: 2.00,\n      marketPrice: 4.50,\n      profitMargin: 55.6\n    },\n    {\n      crop: 'Broccoli Microgreens',\n      unitsProduced: 800,\n      totalLaborCost: 960,\n      totalMaterialCost: 320,\n      totalCost: 1280,\n      costPerUnit: 1.60,\n      marketPrice: 6.00,\n      profitMargin: 73.3\n    },\n    {\n      crop: 'Arugula',\n      unitsProduced: 950,\n      totalLaborCost: 1425,\n      totalMaterialCost: 475,\n      totalCost: 1900,\n      costPerUnit: 2.00,\n      marketPrice: 5.00,\n      profitMargin: 60.0\n    },\n    {\n      crop: 'Basil',\n      unitsProduced: 600,\n      totalLaborCost: 1200,\n      totalMaterialCost: 480,\n      totalCost: 1680,\n      costPerUnit: 2.80,\n      marketPrice: 7.50,\n      profitMargin: 62.7\n    }\n  ], []);\n\n  const costTrendData = useMemo(() => [\n    { month: 'Jan', laborCost: 8500, materialCost: 2800, totalCost: 11300 },\n    { month: 'Feb', laborCost: 8200, materialCost: 2600, totalCost: 10800 },\n    { month: 'Mar', laborCost: 8900, materialCost: 2900, totalCost: 11800 },\n    { month: 'Apr', laborCost: 8600, materialCost: 2750, totalCost: 11350 },\n    { month: 'May', laborCost: 8750, materialCost: 2850, totalCost: 11600 },\n    { month: 'Jun', laborCost: 8400, materialCost: 2700, totalCost: 11100 },\n  ], []);\n\n  const costBreakdown = useMemo(() => [\n    { name: 'Labor', value: 68, color: '#3b82f6' },\n    { name: 'Seeds', value: 12, color: '#10b981' },\n    { name: 'Growing Media', value: 8, color: '#f59e0b' },\n    { name: 'Utilities', value: 7, color: '#8b5cf6' },\n    { name: 'Other Supplies', value: 5, color: '#6b7280' }\n  ], []);\n\n  const getTrendIcon = (trend: number) => {\n    if (trend > 0) return <TrendingUp className=\"w-4 h-4 text-red-500\" />;\n    if (trend < 0) return <TrendingDown className=\"w-4 h-4 text-green-500\" />;\n    return <div className=\"w-4 h-4 bg-gray-300 rounded-full\" />;\n  };\n\n  const getTrendColor = (trend: number) => {\n    if (trend > 0) return 'text-red-600';\n    if (trend < 0) return 'text-green-600';\n    return 'text-gray-600';\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Header and Controls */}\n      <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between\">\n        <div>\n          <h2 className=\"text-xl font-bold text-[#203B17] mb-2\">Cost Analysis</h2>\n          <p className=\"text-gray-600\">Track and analyze task costs, materials, and profitability</p>\n        </div>\n        <div className=\"flex gap-2 mt-4 sm:mt-0\">\n          <Select value={dateRange} onValueChange={setDateRange}>\n            <SelectTrigger className=\"w-32\">\n              <SelectValue />\n            </SelectTrigger>\n            <SelectContent>\n              <SelectItem value=\"7d\">Last 7 days</SelectItem>\n              <SelectItem value=\"30d\">Last 30 days</SelectItem>\n              <SelectItem value=\"90d\">Last 90 days</SelectItem>\n              <SelectItem value=\"year\">This year</SelectItem>\n            </SelectContent>\n          </Select>\n        </div>\n      </div>\n\n      {/* View Type Selector */}\n      <div className=\"flex flex-wrap gap-2 border-b border-gray-200 pb-4\">\n        <Button\n          variant={viewType === 'task' ? 'default' : 'outline'}\n          onClick={() => setViewType('task')}\n          className=\"flex items-center gap-2\"\n        >\n          <Clock className=\"w-4 h-4\" />\n          By Task\n        </Button>\n        <Button\n          variant={viewType === 'crop' ? 'default' : 'outline'}\n          onClick={() => setViewType('crop')}\n          className=\"flex items-center gap-2\"\n        >\n          <Package className=\"w-4 h-4\" />\n          By Crop\n        </Button>\n        <Button\n          variant={viewType === 'location' ? 'default' : 'outline'}\n          onClick={() => setViewType('location')}\n          className=\"flex items-center gap-2\"\n        >\n          <Target className=\"w-4 h-4\" />\n          By Location\n        </Button>\n      </div>\n\n      {/* Summary Cards */}\n      <div className=\"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6\">\n        <Card className=\"p-6\">\n          <div className=\"flex items-center justify-between\">\n            <div>\n              <p className=\"text-sm font-medium text-gray-600\">Average Task Cost</p>\n              <p className=\"text-2xl font-bold text-gray-900\">$14.85</p>\n              <div className=\"text-sm text-gray-500 mt-1\">\n                <span>Labor: $10.95</span> ‚Ä¢ <span>Materials: $3.90</span>\n              </div>\n            </div>\n            <div className=\"p-3 bg-blue-50 rounded-full\">\n              <DollarSign className=\"w-6 h-6 text-blue-600\" />\n            </div>\n          </div>\n        </Card>\n\n        <Card className=\"p-6 border-green-200 bg-green-50\">\n          <div className=\"flex items-center justify-between\">\n            <div>\n              <p className=\"text-sm font-medium text-gray-600\">Cost per Head (Lettuce)</p>\n              <p className=\"text-2xl font-bold text-green-700\">$2.00</p>\n              <div className=\"text-sm text-gray-600 mt-1\">\n                <span>Sells for: $4.50</span>\n                <span className=\"text-green-600 font-medium block\">+125% ROI</span>\n              </div>\n            </div>\n            <div className=\"p-3 bg-green-100 rounded-full\">\n              <TrendingUp className=\"w-6 h-6 text-green-600\" />\n            </div>\n          </div>\n        </Card>\n\n        <Card className=\"p-6\">\n          <div className=\"flex items-center justify-between\">\n            <div>\n              <p className=\"text-sm font-medium text-gray-600\">Monthly Labor Cost</p>\n              <p className=\"text-2xl font-bold text-gray-900\">$8,600</p>\n              <div className=\"text-sm text-red-600 mt-1\">\n                +3.2% vs last month\n              </div>\n            </div>\n            <div className=\"p-3 bg-amber-50 rounded-full\">\n              <Clock className=\"w-6 h-6 text-amber-600\" />\n            </div>\n          </div>\n        </Card>\n\n        <Card className=\"p-6\">\n          <div className=\"flex items-center justify-between\">\n            <div>\n              <p className=\"text-sm font-medium text-gray-600\">Cost Efficiency</p>\n              <p className=\"text-2xl font-bold text-gray-900\">92%</p>\n              <div className=\"text-sm text-green-600 mt-1\">\n                +2.1% improvement\n              </div>\n            </div>\n            <div className=\"p-3 bg-purple-50 rounded-full\">\n              <Target className=\"w-6 h-6 text-purple-600\" />\n            </div>\n          </div>\n        </Card>\n      </div>\n\n      {/* Task View */}\n      {viewType === 'task' && (\n        <div className=\"space-y-6\">\n          {/* Task Cost Table */}\n          <Card className=\"p-6\">\n            <CardHeader>\n              <CardTitle>Cost Analysis by Task Type</CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"overflow-x-auto\">\n                <table className=\"w-full border-collapse\">\n                  <thead>\n                    <tr className=\"border-b\">\n                      <th className=\"text-left p-3 font-medium\">Task Type</th>\n                      <th className=\"text-left p-3 font-medium\">Instances</th>\n                      <th className=\"text-left p-3 font-medium\">Avg Labor Cost</th>\n                      <th className=\"text-left p-3 font-medium\">Avg Material Cost</th>\n                      <th className=\"text-left p-3 font-medium\">Total Avg Cost</th>\n                      <th className=\"text-left p-3 font-medium\">Trend</th>\n                    </tr>\n                  </thead>\n                  <tbody>\n                    {taskCostData.map((task, index) => (\n                      <tr key={index} className=\"border-b hover:bg-gray-50\">\n                        <td className=\"p-3 font-medium\">{task.taskType}</td>\n                        <td className=\"p-3\">{task.instances}</td>\n                        <td className=\"p-3\">${task.avgLaborCost.toFixed(2)}</td>\n                        <td className=\"p-3\">${task.avgMaterialCost.toFixed(2)}</td>\n                        <td className=\"p-3 font-semibold\">${task.totalAvgCost.toFixed(2)}</td>\n                        <td className=\"p-3\">\n                          <div className=\"flex items-center gap-1\">\n                            {getTrendIcon(task.trend)}\n                            <span className={getTrendColor(task.trend)}>\n                              {task.trend > 0 ? '+' : ''}{task.trend.toFixed(1)}%\n                            </span>\n                          </div>\n                        </td>\n                      </tr>\n                    ))}\n                  </tbody>\n                </table>\n              </div>\n            </CardContent>\n          </Card>\n\n          {/* Cost Breakdown Pie Chart */}\n          <Card className=\"p-6\">\n            <CardHeader>\n              <CardTitle>Overall Cost Distribution</CardTitle>\n            </CardHeader>\n            <CardContent>\n              <ResponsiveContainer width=\"100%\" height={300}>\n                <PieChart>\n                  <Pie\n                    data={costBreakdown}\n                    cx=\"50%\"\n                    cy=\"50%\"\n                    labelLine={false}\n                    label={({ name, value }) => `${name}: ${value}%`}\n                    outerRadius={100}\n                    fill=\"#8884d8\"\n                    dataKey=\"value\"\n                  >\n                    {costBreakdown.map((entry, index) => (\n                      <Cell key={`cell-${index}`} fill={entry.color} />\n                    ))}\n                  </Pie>\n                  <Tooltip />\n                </PieChart>\n              </ResponsiveContainer>\n            </CardContent>\n          </Card>\n        </div>\n      )}\n\n      {/* Crop View */}\n      {viewType === 'crop' && (\n        <div className=\"space-y-6\">\n          {/* Crop Cost Table */}\n          <Card className=\"p-6\">\n            <CardHeader>\n              <CardTitle>Full Cycle Cost per Crop</CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"overflow-x-auto\">\n                <table className=\"w-full border-collapse\">\n                  <thead>\n                    <tr className=\"border-b\">\n                      <th className=\"text-left p-3 font-medium\">Crop</th>\n                      <th className=\"text-left p-3 font-medium\">Units Produced</th>\n                      <th className=\"text-left p-3 font-medium\">Total Labor</th>\n                      <th className=\"text-left p-3 font-medium\">Total Materials</th>\n                      <th className=\"text-left p-3 font-medium\">Cost per Unit</th>\n                      <th className=\"text-left p-3 font-medium\">Market Price</th>\n                      <th className=\"text-left p-3 font-medium\">Profit Margin</th>\n                    </tr>\n                  </thead>\n                  <tbody>\n                    {cropCostData.map((crop, index) => (\n                      <tr key={index} className=\"border-b hover:bg-gray-50\">\n                        <td className=\"p-3 font-medium\">{crop.crop}</td>\n                        <td className=\"p-3\">{crop.unitsProduced}</td>\n                        <td className=\"p-3\">${crop.totalLaborCost}</td>\n                        <td className=\"p-3\">${crop.totalMaterialCost}</td>\n                        <td className=\"p-3 font-semibold\">${crop.costPerUnit.toFixed(2)}</td>\n                        <td className=\"p-3\">${crop.marketPrice.toFixed(2)}</td>\n                        <td className=\"p-3\">\n                          <div className=\"flex items-center gap-2\">\n                            <div className=\"w-16 h-2 bg-gray-200 rounded-full overflow-hidden\">\n                              <div \n                                className=\"h-full bg-green-500 rounded-full transition-all duration-300\"\n                                style={{ width: `${Math.min(crop.profitMargin, 100)}%` }}\n                              />\n                            </div>\n                            <span className=\"font-medium text-green-600\">{crop.profitMargin.toFixed(1)}%</span>\n                          </div>\n                        </td>\n                      </tr>\n                    ))}\n                  </tbody>\n                </table>\n              </div>\n            </CardContent>\n          </Card>\n\n          {/* Profitability Chart */}\n          <Card className=\"p-6\">\n            <CardHeader>\n              <CardTitle>Crop Profitability Comparison</CardTitle>\n            </CardHeader>\n            <CardContent>\n              <ResponsiveContainer width=\"100%\" height={300}>\n                <BarChart data={cropCostData}>\n                  <CartesianGrid strokeDasharray=\"3 3\" />\n                  <XAxis dataKey=\"crop\" />\n                  <YAxis />\n                  <Tooltip />\n                  <Legend />\n                  <Bar dataKey=\"costPerUnit\" fill=\"#ef4444\" name=\"Cost per Unit\" />\n                  <Bar dataKey=\"marketPrice\" fill=\"#10b981\" name=\"Market Price\" />\n                </BarChart>\n              </ResponsiveContainer>\n            </CardContent>\n          </Card>\n        </div>\n      )}\n\n      {/* Location View */}\n      {viewType === 'location' && (\n        <div className=\"space-y-6\">\n          <Card className=\"p-6\">\n            <CardHeader>\n              <CardTitle>Cost Comparison by Location</CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"grid grid-cols-1 md:grid-cols-3 gap-6\">\n                <div className=\"p-4 bg-gray-50 rounded-lg\">\n                  <h4 className=\"font-semibold text-lg mb-2\">Kenosha</h4>\n                  <div className=\"space-y-2\">\n                    <div className=\"flex justify-between\">\n                      <span>Labor Cost/hr:</span>\n                      <span className=\"font-medium\">$18.50</span>\n                    </div>\n                    <div className=\"flex justify-between\">\n                      <span>Avg Task Cost:</span>\n                      <span className=\"font-medium\">$14.25</span>\n                    </div>\n                    <div className=\"flex justify-between\">\n                      <span>Efficiency:</span>\n                      <span className=\"font-medium text-green-600\">94.2%</span>\n                    </div>\n                  </div>\n                </div>\n                <div className=\"p-4 bg-gray-50 rounded-lg\">\n                  <h4 className=\"font-semibold text-lg mb-2\">Racine (Dev)</h4>\n                  <div className=\"space-y-2\">\n                    <div className=\"flex justify-between\">\n                      <span>Labor Cost/hr:</span>\n                      <span className=\"font-medium\">$17.75</span>\n                    </div>\n                    <div className=\"flex justify-between\">\n                      <span>Avg Task Cost:</span>\n                      <span className=\"font-medium\">$15.80</span>\n                    </div>\n                    <div className=\"flex justify-between\">\n                      <span>Efficiency:</span>\n                      <span className=\"font-medium text-yellow-600\">91.8%</span>\n                    </div>\n                  </div>\n                </div>\n                <div className=\"p-4 bg-gray-50 rounded-lg\">\n                  <h4 className=\"font-semibold text-lg mb-2\">Milwaukee</h4>\n                  <div className=\"space-y-2\">\n                    <div className=\"flex justify-between\">\n                      <span>Labor Cost/hr:</span>\n                      <span className=\"font-medium\">$19.25</span>\n                    </div>\n                    <div className=\"flex justify-between\">\n                      <span>Avg Task Cost:</span>\n                      <span className=\"font-medium\">$16.45</span>\n                    </div>\n                    <div className=\"flex justify-between\">\n                      <span>Efficiency:</span>\n                      <span className=\"font-medium text-red-600\">89.5%</span>\n                    </div>\n                  </div>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n      )}\n\n      {/* Cost Trend Chart */}\n      <Card className=\"p-6\">\n        <CardHeader>\n          <CardTitle>Cost Trend Analysis</CardTitle>\n        </CardHeader>\n        <CardContent>\n          <ResponsiveContainer width=\"100%\" height={300}>\n            <LineChart data={costTrendData}>\n              <CartesianGrid strokeDasharray=\"3 3\" />\n              <XAxis dataKey=\"month\" />\n              <YAxis />\n              <Tooltip />\n              <Legend />\n              <Line type=\"monotone\" dataKey=\"laborCost\" stroke=\"#3b82f6\" name=\"Labor Cost\" strokeWidth={2} />\n              <Line type=\"monotone\" dataKey=\"materialCost\" stroke=\"#10b981\" name=\"Material Cost\" strokeWidth={2} />\n              <Line type=\"monotone\" dataKey=\"totalCost\" stroke=\"#f59e0b\" strokeWidth={3} name=\"Total Cost\" />\n            </LineChart>\n          </ResponsiveContainer>\n        </CardContent>\n      </Card>\n\n      {/* Cost Optimization Insights */}\n      <Card className=\"p-6\">\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <Lightbulb className=\"w-5 h-5\" />\n            Cost Optimization Opportunities\n          </CardTitle>\n        </CardHeader>\n        <CardContent>\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n            <div className=\"p-4 bg-yellow-50 border border-yellow-200 rounded-lg\">\n              <h4 className=\"font-semibold text-yellow-800 mb-2 flex items-center gap-2\">\n                <Lightbulb className=\"w-4 h-4\" />\n                Reduce Seeding Labor\n              </h4>\n              <p className=\"text-sm text-yellow-700 mb-2\">\n                Batch seeding on Tuesdays could save $45/week in labor costs\n              </p>\n              <span className=\"text-sm font-medium text-yellow-800\">\n                Potential savings: $2,340/year\n              </span>\n            </div>\n            <div className=\"p-4 bg-blue-50 border border-blue-200 rounded-lg\">\n              <h4 className=\"font-semibold text-blue-800 mb-2 flex items-center gap-2\">\n                <ShoppingCart className=\"w-4 h-4\" />\n                Bulk Material Ordering\n              </h4>\n              <p className=\"text-sm text-blue-700 mb-2\">\n                Ordering growing medium in bulk could reduce cost by 15%\n              </p>\n              <span className=\"text-sm font-medium text-blue-800\">\n                Potential savings: $1,800/year\n              </span>\n            </div>\n            <div className=\"p-4 bg-green-50 border border-green-200 rounded-lg\">\n              <h4 className=\"font-semibold text-green-800 mb-2 flex items-center gap-2\">\n                <Clock className=\"w-4 h-4\" />\n                Optimize Harvest Times\n              </h4>\n              <p className=\"text-sm text-green-700 mb-2\">\n                Scheduling harvests during peak efficiency hours reduces overtime\n              </p>\n              <span className=\"text-sm font-medium text-green-800\">\n                Potential savings: $1,200/year\n              </span>\n            </div>\n            <div className=\"p-4 bg-purple-50 border border-purple-200 rounded-lg\">\n              <h4 className=\"font-semibold text-purple-800 mb-2 flex items-center gap-2\">\n                <Target className=\"w-4 h-4\" />\n                Cross-training Staff\n              </h4>\n              <p className=\"text-sm text-purple-700 mb-2\">\n                Multi-skilled staff reduce task switching time and increase efficiency\n              </p>\n              <span className=\"text-sm font-medium text-purple-800\">\n                Potential savings: $3,600/year\n              </span>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n};","path":null,"size_bytes":22044,"size_tokens":null},"client/src/services/staffService.ts":{"content":"// Staff Management Service - Dynamic staff generation from Microsoft logins\nexport interface StaffMember {\n  id: string;\n  fullName: string;\n  email: string;\n  phone: string;\n  location: string;\n  rolesAssigned: string[];\n  dateHired: string;\n  payRate: number;\n  trainingCompleted: string[];\n  trainingInProgress: string[];\n  preferredHours: string;\n  activeStatus: 'active' | 'inactive' | 'on-leave';\n  lastTaskCompleted: string | null;\n  managerNotes: string;\n  tasksCompleted: number;\n  avgTaskDuration: string;\n  onTimeRate: number;\n  microsoftId: string;\n  lastActive: string;\n}\n\nconst API_BASE = '/api';\n\n// Get all staff members from API\nexport const getAllStaff = async (): Promise<StaffMember[]> => {\n  try {\n    const response = await fetch(`${API_BASE}/staff`);\n    if (!response.ok) {\n      throw new Error('Failed to fetch staff data');\n    }\n    const staff = await response.json();\n    return staff;\n  } catch (error) {\n    console.error('Error loading staff data:', error);\n    return [];\n  }\n};\n\n// Save staff member to API\nconst saveStaffToAPI = async (staffMember: StaffMember): Promise<StaffMember> => {\n  try {\n    // Always use POST for new staff members (let backend handle ID creation)\n    // For updates, find existing by email since Microsoft ID may not match backend ID\n    const url = `${API_BASE}/staff`;\n    const method = 'POST';\n    \n    const response = await fetch(url, {\n      method,\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify(staffMember)\n    });\n    \n    if (!response.ok) {\n      const errorText = await response.text();\n      console.error('API Error:', response.status, errorText);\n      throw new Error(`Failed to save staff member: ${response.status}`);\n    }\n    \n    return await response.json();\n  } catch (error) {\n    console.error('Error saving staff member:', error);\n    throw error;\n  }\n};\n\n// Get staff member by email\nexport const getStaffByEmail = async (email: string): Promise<StaffMember | undefined> => {\n  const staff = await getAllStaff();\n  return staff.find(member => member.email === email);\n};\n\n// Get staff member by Microsoft ID\nexport const getStaffByMicrosoftId = async (microsoftId: string): Promise<StaffMember | undefined> => {\n  const staff = await getAllStaff();\n  return staff.find(member => member.microsoftId === microsoftId);\n};\n\n// Create new staff member from Microsoft login\nexport const createStaffFromMicrosoftLogin = async (\n  microsoftId: string,\n  name: string,\n  email: string\n): Promise<StaffMember> => {\n  // Check if already exists by email (more reliable than checking staff array)\n  const existing = await getStaffByEmail(email);\n  if (existing) {\n    console.log('Found existing staff member:', existing.fullName, existing.email);\n    // Update last active and return existing\n    existing.lastActive = new Date().toISOString();\n    return existing; // Don't call update to avoid API call loops\n  }\n\n  // Determine role based on email\n  let defaultRoles = ['General Staff'];\n  let defaultLocation = 'K'; // Default to Kenosha\n  \n  // Corporate managers\n  if (email === 'robert@growspace.farm' || email === 'matt@growspace.farm' || email === 'matt.carlson@growspace.farm' || email === 'dan@growspace.farm') {\n    defaultRoles = ['Corporate Manager'];\n  }\n\n  const newStaff: StaffMember = {\n    id: '', // Will be set by the backend when user is created\n    fullName: name,\n    email: email,\n    phone: '', // To be filled by manager\n    location: defaultLocation,\n    rolesAssigned: defaultRoles,\n    dateHired: new Date().toISOString().split('T')[0],\n    payRate: 0, // To be set by manager\n    trainingCompleted: [],\n    trainingInProgress: [],\n    preferredHours: 'Flexible',\n    activeStatus: 'active',\n    lastTaskCompleted: null,\n    managerNotes: 'Auto-created from Microsoft login',\n    tasksCompleted: 0,\n    avgTaskDuration: '0m',\n    onTimeRate: 100,\n    microsoftId: microsoftId,\n    lastActive: new Date().toISOString()\n  };\n\n  // Add to staff list\n  const savedMember = await saveStaffToAPI(newStaff);\n  \n  console.log('Created new staff member:', savedMember.fullName, savedMember.email);\n  return savedMember;\n};\n\n// Update existing staff member\nexport const updateStaffMember = async (updatedStaff: StaffMember): Promise<void> => {\n  try {\n    const response = await fetch(`${API_BASE}/staff/${updatedStaff.id}`, {\n      method: 'PUT',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify(updatedStaff)\n    });\n    \n    if (!response.ok) {\n      const errorText = await response.text();\n      console.error('Update API Error:', response.status, errorText);\n      throw new Error(`Failed to update staff member: ${response.status}`);\n    }\n  } catch (error) {\n    console.error('Error updating staff member:', error);\n    throw error;\n  }\n};\n\n// Update last active time for staff member\nexport const updateLastActive = async (microsoftId: string): Promise<void> => {\n  const member = await getStaffByMicrosoftId(microsoftId);\n  \n  if (member) {\n    member.lastActive = new Date().toISOString();\n    await updateStaffMember(member);\n  }\n};\n\n// Get available role options based on current user's role\nexport const getAvailableRoles = (currentUserRole: string): string[] => {\n  const baseRoles = [\n    'General Staff',\n    'Seeding Tech',\n    'Harvest Tech',\n    'Packing',\n    'Cleaning Crew',\n    'Equipment Tech'\n  ];\n  \n  if (currentUserRole === 'Manager' || currentUserRole === 'Corporate') {\n    baseRoles.push('Manager');\n  }\n  \n  if (currentUserRole === 'Corporate') {\n    baseRoles.push('Corporate Manager');\n  }\n  \n  return baseRoles;\n};\n\n// Check if user can assign a specific role\nexport const canAssignRole = (currentUserRole: string, roleToAssign: string): boolean => {\n  // Corporate can assign any role\n  if (currentUserRole === 'Corporate') return true;\n  \n  // Managers can assign all except Corporate Manager\n  if (currentUserRole === 'Manager' && roleToAssign !== 'Corporate Manager') return true;\n  \n  // Staff can't assign roles\n  return false;\n};\n\n// Clear all staff data (for testing/reset purposes) - Now handled by API\nexport const clearAllStaffData = async (): Promise<void> => {\n  console.log('Staff data clearing is now handled by the backend API');\n  // This would require a backend endpoint to clear all staff data\n};\n\n// Add new staff member manually\nexport const addStaffMember = async (staffData: Omit<StaffMember, 'id'>): Promise<StaffMember> => {\n  const newStaff: StaffMember = {\n    ...staffData,\n    id: Date.now().toString(), // Generate simple ID for manual entries\n  };\n  \n  return await saveStaffToAPI(newStaff);\n};\n\n// Delete staff member\nexport const deleteStaffMember = async (staffId: string): Promise<void> => {\n  try {\n    const response = await fetch(`${API_BASE}/staff/${staffId}`, {\n      method: 'DELETE'\n    });\n    if (!response.ok) {\n      throw new Error('Failed to delete staff member');\n    }\n  } catch (error) {\n    console.error('Error deleting staff member:', error);\n    throw error;\n  }\n};\n\n// Initialize expected staff members who should have access\nexport const initializeExpectedStaff = async (): Promise<void> => {\n  console.log('Expected staff will be created when they log in via Microsoft SSO');\n  // Removed pre-creation of Jane and Matt - they will appear when they actually log in\n};","path":null,"size_bytes":7332,"size_tokens":null},"client/src/components/AddStockModal.tsx":{"content":"import React, { useState } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle } from \"@/components/ui/dialog\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { InventoryItem } from \"@shared/schema\";\n\ninterface AddStockModalProps {\n  isOpen: boolean;\n  onClose: () => void;\n  onSave: (data: { itemId: number; quantity: number; unitCost: number; supplier: string; notes: string }) => Promise<void>;\n}\n\nexport interface AddStockData {\n  itemId: number;\n  quantity: number;\n  unitCost: number;\n  supplier: string;\n  notes: string;\n}\n\nconst AddStockModal: React.FC<AddStockModalProps> = ({\n  isOpen,\n  onClose,\n  onSave\n}) => {\n  const [selectedItemId, setSelectedItemId] = useState<number | null>(null);\n  const [quantity, setQuantity] = useState<number>(0);\n  const [totalCost, setTotalCost] = useState<number>(0);\n  const [supplier, setSupplier] = useState<string>('');\n  const [notes, setNotes] = useState<string>('');\n  const [isSubmitting, setIsSubmitting] = useState(false);\n\n  const { data: inventory = [] } = useQuery<InventoryItem[]>({\n    queryKey: [\"/api/inventory\"],\n  });\n\n  const selectedItem = inventory.find(item => item.id === selectedItemId);\n  const unitCost = quantity > 0 && totalCost > 0 ? totalCost / quantity : 0;\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault();\n    \n    if (!selectedItemId || quantity <= 0 || totalCost <= 0) {\n      return;\n    }\n\n    setIsSubmitting(true);\n    try {\n      await onSave({\n        itemId: selectedItemId,\n        quantity: quantity,\n        unitCost: unitCost,\n        supplier: supplier,\n        notes: notes\n      });\n      \n      // Reset form\n      setSelectedItemId(null);\n      setQuantity(0);\n      setTotalCost(0);\n      setSupplier('');\n      setNotes('');\n      onClose();\n    } catch (error) {\n      console.error(\"Failed to add stock:\", error);\n    } finally {\n      setIsSubmitting(false);\n    }\n  };\n\n  return (\n    <Dialog open={isOpen} onOpenChange={onClose}>\n      <DialogContent className=\"max-w-md max-h-[90vh] overflow-y-auto\">\n        <DialogHeader>\n          <DialogTitle className=\"flex items-center gap-2\">\n            üì¶ Add Stock\n          </DialogTitle>\n        </DialogHeader>\n        \n        <form onSubmit={handleSubmit} className=\"space-y-4\">\n          {/* Item Selection */}\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"item\">Select Item *</Label>\n            <Select\n              value={selectedItemId?.toString() || ''}\n              onValueChange={(value) => setSelectedItemId(parseInt(value))}\n            >\n              <SelectTrigger>\n                <SelectValue placeholder=\"Select an item...\" />\n              </SelectTrigger>\n              <SelectContent>\n                {inventory.map(item => (\n                  <SelectItem key={item.id} value={item.id.toString()}>\n                    [{item.sku || item.productCode}] {item.name}\n                  </SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n          </div>\n\n          {/* Current Stock Display */}\n          {selectedItem && (\n            <div className=\"bg-blue-50 border border-blue-200 rounded-lg p-3\">\n              <div className=\"text-sm text-blue-800\">\n                <strong>Current Stock:</strong> {selectedItem.currentStock} {selectedItem.unit}\n              </div>\n              <div className=\"text-sm text-blue-600\">\n                <strong>Category:</strong> {selectedItem.category}\n              </div>\n            </div>\n          )}\n\n          {/* Quantity to Add */}\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"quantity\">Quantity to Add *</Label>\n            <Input\n              id=\"quantity\"\n              type=\"number\"\n              min=\"0.01\"\n              step=\"0.01\"\n              value={quantity || ''}\n              onChange={(e) => setQuantity(parseFloat(e.target.value) || 0)}\n              placeholder={selectedItem ? `Amount in ${selectedItem.unit}` : \"0\"}\n              required\n            />\n          </div>\n\n          {/* Supplier */}\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"supplier\">Supplier</Label>\n            <Input\n              id=\"supplier\"\n              type=\"text\"\n              value={supplier}\n              onChange={(e) => setSupplier(e.target.value)}\n              placeholder=\"e.g., Johnny Seeds\"\n            />\n          </div>\n\n          {/* Total Cost */}\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"total-cost\">Total Cost Paid ($) *</Label>\n            <Input\n              id=\"total-cost\"\n              type=\"number\"\n              min=\"0.01\"\n              step=\"0.01\"\n              value={totalCost || ''}\n              onChange={(e) => setTotalCost(parseFloat(e.target.value) || 0)}\n              placeholder=\"0.00\"\n              required\n            />\n            <div className=\"text-sm text-gray-500\">\n              Enter the total amount paid for this quantity\n            </div>\n          </div>\n\n          {/* Cost Per Unit (calculated) */}\n          {quantity > 0 && totalCost > 0 && selectedItem && (\n            <div className=\"bg-green-50 border border-green-200 rounded-lg p-3\">\n              <div className=\"text-sm text-green-800\">\n                <strong>Cost Per Unit:</strong> ${unitCost.toFixed(3)} / {selectedItem.unit}\n              </div>\n              <div className=\"text-sm text-green-600\">\n                <strong>New Total Stock:</strong> {(selectedItem.currentStock + quantity).toFixed(2)} {selectedItem.unit}\n              </div>\n            </div>\n          )}\n\n          {/* Notes */}\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"notes\">Notes</Label>\n            <Input\n              id=\"notes\"\n              type=\"text\"\n              value={notes}\n              onChange={(e) => setNotes(e.target.value)}\n              placeholder=\"Optional notes about this restock\"\n            />\n          </div>\n\n          {/* Action Buttons */}\n          <div className=\"flex gap-2 pt-4\">\n            <Button \n              type=\"button\" \n              variant=\"outline\" \n              onClick={onClose}\n              className=\"flex-1\"\n            >\n              Cancel\n            </Button>\n            <Button \n              type=\"submit\" \n              className=\"flex-1 bg-[#2D8028] hover:bg-[#203B17]\"\n              disabled={!selectedItemId || quantity <= 0 || totalCost <= 0 || isSubmitting}\n            >\n              {isSubmitting ? 'Adding...' : 'Add Stock'}\n            </Button>\n          </div>\n        </form>\n      </DialogContent>\n    </Dialog>\n  );\n};\n\nexport default AddStockModal;","path":null,"size_bytes":6902,"size_tokens":null},"client/src/main.tsx":{"content":"import { createRoot } from \"react-dom/client\";\nimport App from \"./App\";\nimport \"./index.css\";\n\ncreateRoot(document.getElementById(\"root\")!).render(<App />);\n","path":null,"size_bytes":157,"size_tokens":null},"client/src/pages/Tasks.tsx":{"content":"import React from \"react\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { Plus, Filter, Search, ChevronDown, X, Calendar } from \"lucide-react\";\nimport { format } from \"date-fns\";\nimport {\n  isSameDay,\n  formatDateForComparison,\n  shouldTaskAppearOnDate,\n  getTodayString,\n  debugDateComparison,\n  isTaskOverdue,\n  getDaysOverdue,\n  getOverdueSeverity,\n} from \"@/utils/dateUtils\";\nimport TaskCard from \"@/components/TaskCard\";\nimport TaskModal from \"@/components/TaskModal\";\nimport { AddTaskModal } from \"@/components/AddTaskModal\";\nimport TaskActionModal from \"@/components/TaskActionModal\";\nimport { Task } from \"@shared/schema\";\nimport { TaskFilters, TaskType } from \"@/types\";\nimport { getStoredAuth } from \"@/lib/auth\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport confetti from \"canvas-confetti\";\nimport { TrayService } from \"@/services/trayService\";\nimport { TaskCompletionService } from \"@/services/taskCompletionService\";\nimport { useLocation } from \"@/contexts/LocationContext\";\nimport { useCurrentUser } from \"@/contexts/CurrentUserContext\";\nimport { isMyTask } from \"../utils/taskHelpers\";\nimport GamifiedProgressBars from \"@/components/GamifiedProgressBars\";\nimport { GenerationStatusBadge } from \"@/components/GenerationStatusBadge\";\n\nconst Tasks: React.FC = () => {\n  const [selectedTask, setSelectedTask] = React.useState<Task | null>(null);\n  const [modalOpen, setModalOpen] = React.useState(false);\n  const [addTaskModalOpen, setAddTaskModalOpen] = React.useState(false);\n  const [taskActionModalOpen, setTaskActionModalOpen] = React.useState(false);\n  const [searchTerm, setSearchTerm] = React.useState(\"\");\n  const [filters, setFilters] = React.useState<TaskFilters>({});\n  const [activeFilter, setActiveFilter] = React.useState<string>(\"all\");\n  const [categoryDropdownOpen, setCategoryDropdownOpen] = React.useState(false);\n  const [statusDropdownOpen, setStatusDropdownOpen] = React.useState(false);\n  const [priorityDropdownOpen, setPriorityDropdownOpen] = React.useState(false);\n  const [statusFilter, setStatusFilter] = React.useState<string>(\"all\");\n  const [priorityFilter, setPriorityFilter] = React.useState<string>(\"all\");\n  const [assignedToMeFilter, setAssignedToMeFilter] =\n    React.useState<boolean>(false);\n  const [dateFilter, setDateFilter] = React.useState<string>(() => {\n    const todayString = getTodayString();\n    console.log(\"üóìÔ∏è Initial date filter set to:\", todayString, \"(Today)\");\n    return todayString;\n  });\n\n  const [dateDropdownOpen, setDateDropdownOpen] = React.useState(false);\n  const dropdownRef = React.useRef<HTMLDivElement>(null);\n  const statusDropdownRef = React.useRef<HTMLDivElement>(null);\n  const priorityDropdownRef = React.useRef<HTMLDivElement>(null);\n  const dateDropdownRef = React.useRef<HTMLDivElement>(null);\n  const filtersRef = React.useRef<HTMLDivElement>(null);\n  const [canScrollLeft, setCanScrollLeft] = React.useState(false);\n  const [canScrollRight, setCanScrollRight] = React.useState(false);\n\n  const auth = getStoredAuth();\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n  const { currentLocation, isViewingAllLocations } = useLocation();\n  const { currentUser, loading: userLoading } = useCurrentUser();\n\n  // Add refresh state for loading indicator\n  const [isRefreshing, setIsRefreshing] = React.useState(false);\n  const searchTimeoutRef = React.useRef<NodeJS.Timeout | null>(null);\n\n  // Close dropdown when clicking outside\n  React.useEffect(() => {\n    const handleClickOutside = (event: MouseEvent) => {\n      if (\n        dropdownRef.current &&\n        !dropdownRef.current.contains(event.target as Node)\n      ) {\n        setCategoryDropdownOpen(false);\n      }\n      if (\n        statusDropdownRef.current &&\n        !statusDropdownRef.current.contains(event.target as Node)\n      ) {\n        setStatusDropdownOpen(false);\n      }\n      if (\n        priorityDropdownRef.current &&\n        !priorityDropdownRef.current.contains(event.target as Node)\n      ) {\n        setPriorityDropdownOpen(false);\n      }\n      if (\n        dateDropdownRef.current &&\n        !dateDropdownRef.current.contains(event.target as Node)\n      ) {\n        setDateDropdownOpen(false);\n      }\n    };\n\n    document.addEventListener(\"mousedown\", handleClickOutside);\n    return () => document.removeEventListener(\"mousedown\", handleClickOutside);\n  }, []);\n\n  // Scroll indicators functionality\n  React.useEffect(() => {\n    const checkScroll = () => {\n      if (filtersRef.current) {\n        const { scrollLeft, scrollWidth, clientWidth } = filtersRef.current;\n        setCanScrollLeft(scrollLeft > 0);\n        setCanScrollRight(scrollLeft + clientWidth < scrollWidth - 5);\n      }\n    };\n\n    checkScroll();\n    const resizeObserver = new ResizeObserver(checkScroll);\n    if (filtersRef.current) {\n      resizeObserver.observe(filtersRef.current);\n    }\n\n    return () => resizeObserver.disconnect();\n  }, [activeFilter, statusFilter, priorityFilter, dateFilter]);\n\n  const {\n    data: tasks = [],\n    isLoading,\n    refetch,\n  } = useQuery<Task[]>({\n    queryKey: [\n      \"/api/tasks\",\n      { userId: auth.user?.id, location: currentLocation.code },\n    ],\n    queryFn: async () => {\n      const params = new URLSearchParams();\n      if (auth.user?.role === \"technician\") {\n        params.append(\"userId\", auth.user.id.toString());\n      }\n      if (!isViewingAllLocations) {\n        params.append(\"location\", currentLocation.code);\n      }\n      const url = `/api/tasks?${params.toString()}`;\n      const response = await fetch(url);\n      if (!response.ok) throw new Error(\"Failed to fetch tasks\");\n      const data = await response.json();\n\n      return data;\n    },\n    enabled: !!auth.user,\n  });\n\n  // Refresh function to update tasks immediately and remove duplicates\n  const refreshTasks = React.useCallback(async () => {\n    try {\n      setIsRefreshing(true);\n      console.log(\"=== STARTING REFRESH WITH DUPLICATE CHECK ===\");\n\n      // First, remove any duplicate tasks\n      const duplicateResponse = await fetch(\"/api/tasks/remove-duplicates\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n      });\n\n      if (!duplicateResponse.ok) {\n        throw new Error(\"Failed to remove duplicates\");\n      }\n\n      const duplicateResult = await duplicateResponse.json();\n      console.log(\"Duplicate removal result:\", duplicateResult);\n\n      // Force refetch to get latest data\n      await refetch();\n\n      // Also invalidate queries to ensure cache coherence\n      queryClient.invalidateQueries({ queryKey: [\"/api/tasks\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/analytics/dashboard\"] });\n\n      // Show user feedback about what was done\n      if (duplicateResult.duplicatesRemoved > 0) {\n        toast({\n          title: \"‚ú® Tasks Refreshed\",\n          description: `Removed ${duplicateResult.duplicatesRemoved} duplicate task${duplicateResult.duplicatesRemoved !== 1 ? \"s\" : \"\"}. ${duplicateResult.finalCount} unique tasks remaining.`,\n          duration: 4000,\n        });\n      } else {\n        toast({\n          title: \"‚úÖ Tasks Refreshed\",\n          description: \"No duplicates found. All tasks are up to date.\",\n          duration: 3000,\n        });\n      }\n\n      console.log(\"=== REFRESH COMPLETE ===\");\n      console.log(`- Started with: ${duplicateResult.totalTasks} tasks`);\n      console.log(`- Removed: ${duplicateResult.duplicatesRemoved} duplicates`);\n      console.log(`- Final count: ${duplicateResult.finalCount} unique tasks`);\n    } catch (error) {\n      console.error(\"Failed to refresh tasks:\", error);\n      toast({\n        title: \"‚ùå Refresh Failed\",\n        description: \"Could not refresh tasks. Please try again.\",\n        variant: \"destructive\",\n        duration: 3000,\n      });\n    } finally {\n      // Brief delay to show the refresh indicator\n      setTimeout(() => setIsRefreshing(false), 500);\n    }\n  }, [refetch, queryClient, toast]);\n\n  // HARD RESET: Master function to clear all task-related state\n  const performHardReset = React.useCallback(\n    async (actionName: string, shouldRefresh: boolean = true) => {\n      console.log(`=== HARD RESET: ${actionName} ===`);\n\n      // 1. Clear all UI state\n      setSelectedTask(null);\n      setModalOpen(false);\n      setTaskActionModalOpen(false);\n\n      // 2. If requested, refresh tasks from database (with duplicate check)\n      if (shouldRefresh) {\n        await refreshTasks();\n      }\n\n      // 3. Log completion\n      console.log(`=== ${actionName} COMPLETE - Clean State ===`);\n    },\n    [refreshTasks],\n  );\n\n  // Fetch staff data for assignment display\n  const { data: staffData = [] } = useQuery({\n    queryKey: [\"/api/staff\"],\n    queryFn: async () => {\n      const response = await fetch(\"/api/staff\");\n      if (!response.ok) throw new Error(\"Failed to fetch staff\");\n      return response.json();\n    },\n    enabled: !!auth.user,\n  });\n\n  // Periodic overdue status check (every minute)\n  React.useEffect(() => {\n    const checkOverdueStatus = () => {\n      refetch();\n    };\n\n    checkOverdueStatus();\n    const interval = setInterval(checkOverdueStatus, 60000);\n\n    return () => clearInterval(interval);\n  }, [refetch]);\n\n  // Task update mutation with optimistic updates for instant UI feedback\n  const updateTaskMutation = useMutation({\n    mutationFn: async ({\n      taskId,\n      updates,\n    }: {\n      taskId: number;\n      updates: Partial<Task>;\n    }) => {\n      return await apiRequest(\"PATCH\", `/api/tasks/${taskId}`, updates);\n    },\n    onMutate: async ({ taskId, updates }) => {\n      const queryKey = [\n        \"/api/tasks\",\n        { userId: auth.user?.id, location: currentLocation.code },\n      ];\n\n      await queryClient.cancelQueries({ queryKey });\n\n      const previousTasks = queryClient.getQueryData<Task[]>(queryKey);\n\n      queryClient.setQueryData<Task[]>(queryKey, (old) => {\n        if (!old) return old;\n        return old.map((task) =>\n          task.id === taskId ? { ...task, ...updates } : task,\n        );\n      });\n\n      return { previousTasks, queryKey };\n    },\n    onError: (error, variables, context) => {\n      if (context?.previousTasks && context?.queryKey) {\n        queryClient.setQueryData(context.queryKey, context.previousTasks);\n      }\n      toast({\n        title: \"Update failed\",\n        description: \"Failed to update task. Please try again.\",\n        variant: \"destructive\",\n      });\n    },\n    onSettled: (data, error, variables, context) => {\n      if (context?.queryKey) {\n        queryClient.invalidateQueries({ queryKey: context.queryKey });\n      }\n    },\n  });\n\n  const resetTasksMutation = useMutation({\n    mutationFn: async () => {\n      return await apiRequest(\"POST\", \"/api/tasks/reset\", {});\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/tasks\"] });\n      toast({\n        title: \"Tasks Reset\",\n        description: \"All tasks have been reset to their original state.\",\n      });\n    },\n    onError: (error) => {\n      console.error(\"Error resetting tasks:\", error);\n      toast({\n        title: \"Failed to reset tasks\",\n        description:\n          \"There was an error resetting the tasks. Please try again.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const taskTypes = [\n    { value: \"all\", label: \"All Tasks\", emoji: \"üìã\" },\n    {\n      value: \"seeding-microgreens\",\n      label: \"Seeding - Microgreens\",\n      emoji: \"üå±\",\n    },\n    {\n      value: \"seeding-leafy-greens\",\n      label: \"Seeding - Leafy Greens\",\n      emoji: \"üåø\",\n    },\n    {\n      value: \"harvest-microgreens\",\n      label: \"Harvest - Microgreens\",\n      emoji: \"üåæ\",\n    },\n    {\n      value: \"harvest-leafy-greens\",\n      label: \"Harvest - Leafy Greens\",\n      emoji: \"ü•¨\",\n    },\n    { value: \"blackout-tasks\", label: \"Blackout Tasks\", emoji: \"üåë\" },\n    { value: \"moving\", label: \"Moving\", emoji: \"üì¶\" },\n    { value: \"packing\", label: \"Packing\", emoji: \"üì¶\" },\n    { value: \"cleaning\", label: \"Cleaning\", emoji: \"üßπ\" },\n    { value: \"inventory\", label: \"Inventory\", emoji: \"üìä\" },\n    {\n      value: \"equipment-maintenance\",\n      label: \"Equipment Maintenance\",\n      emoji: \"üîß\",\n    },\n    { value: \"other\", label: \"Other\", emoji: \"üìù\" },\n  ];\n\n  const statusOptions = [\n    { value: \"all\", label: \"All Statuses\" },\n    { value: \"pending\", label: \"Assigned\" },\n    { value: \"in_progress\", label: \"In Progress\" },\n    { value: \"completed\", label: \"Completed\" },\n    { value: \"completed-late\", label: \"Completed Late\" },\n    { value: \"approved\", label: \"Approved\" },\n    { value: \"paused\", label: \"Paused\" },\n    { value: \"skipped\", label: \"Skipped\" },\n    { value: \"overdue\", label: \"Overdue\" },\n  ];\n\n  const priorityOptions = [\n    { value: \"all\", label: \"All Priorities\" },\n    { value: \"high\", label: \"High\" },\n    { value: \"medium\", label: \"Medium\" },\n    { value: \"low\", label: \"Low\" },\n  ];\n\n  // Calculate task counts\n  const taskCounts = React.useMemo(() => {\n    const counts: Record<string, number> = {};\n    taskTypes.forEach((type) => {\n      if (type.value === \"all\") {\n        counts[type.value] = tasks.length;\n      } else {\n        counts[type.value] = tasks.filter(\n          (task) => task.type === type.value,\n        ).length;\n      }\n    });\n    return counts;\n  }, [tasks]);\n\n  // Late task detection functions - moved here before filteredTasks to avoid initialization errors\n  const isOverdue = (task: Task): boolean => {\n    // Check if dev overdue protection is enabled\n    const overdueProtection =\n      localStorage.getItem(\"devOverdueProtection\") === \"true\";\n    if (overdueProtection) {\n      return false; // Never show as overdue in dev mode\n    }\n\n    // Can't be overdue if already completed\n    if (\n      !task.dueDate ||\n      task.status === \"completed\" ||\n      task.status === \"approved\"\n    ) {\n      return false;\n    }\n\n    const now = new Date();\n\n    // Handle both Date objects and strings\n    let dateString: string;\n    if (task.dueDate instanceof Date) {\n      const year = task.dueDate.getFullYear();\n      const month = String(task.dueDate.getMonth() + 1).padStart(2, \"0\");\n      const day = String(task.dueDate.getDate()).padStart(2, \"0\");\n      dateString = `${year}-${month}-${day}`;\n    } else {\n      dateString = (task.dueDate as string)?.split(\"T\")[0] || \"\";\n    }\n\n    const [year, month, day] = dateString.split(\"-\");\n    const dueDate = new Date(\n      parseInt(year),\n      parseInt(month) - 1,\n      parseInt(day),\n    );\n\n    // Set time to 8:30 PM Chicago time for due date\n    const chicagoTime = new Date(dueDate);\n    chicagoTime.setHours(20, 30, 0, 0); // 8:30 PM cutoff\n\n    // Task is overdue if current time is past 8:30 PM on due date\n    return now > chicagoTime;\n  };\n\n  const filteredTasks = React.useMemo(() => {\n    let filtered = tasks;\n\n    // Location filtering handled server-side to avoid double-filtering\n    // Server maps location codes (K ‚Üí Kenosha) and filters appropriately\n\n    // Search filter\n    if (searchTerm) {\n      filtered = filtered.filter(\n        (task) =>\n          task.title.toLowerCase().includes(searchTerm.toLowerCase()) ||\n          task.description?.toLowerCase().includes(searchTerm.toLowerCase()),\n      );\n    }\n\n    // Type filter\n    if (activeFilter !== \"all\") {\n      filtered = filtered.filter((task) => task.type === activeFilter);\n    }\n\n    // Status filter\n    if (statusFilter !== \"all\") {\n      switch (statusFilter) {\n        case \"completed-late\":\n          filtered = filtered.filter((task) => isTaskLate(task));\n          break;\n        case \"overdue\":\n          filtered = filtered.filter((task) => isTaskOverdue(task));\n          break;\n        default:\n          filtered = filtered.filter((task) => task.status === statusFilter);\n          break;\n      }\n    }\n\n    // Priority filter\n    if (priorityFilter !== \"all\") {\n      filtered = filtered.filter((task) => task.priority === priorityFilter);\n    }\n\n    // Only My Tasks filter\n    if (assignedToMeFilter && currentUser) {\n      console.log(\n        `üéØ ASSIGNED TO ME FILTER ACTIVE - Before: ${filtered.length} tasks`,\n      );\n      filtered = filtered.filter((task) => {\n        const isAssigned = isMyTask(task, currentUser);\n        return isAssigned;\n      });\n      console.log(\n        `üéØ ASSIGNED TO ME FILTER ACTIVE - After: ${filtered.length} tasks`,\n      );\n    }\n\n    // NEW DATE FILTER LOGIC - Show tasks based on visibility rules\n    if (dateFilter) {\n      const normalizeBiweekly = (freq?: string) =>\n        (freq || \"\").toLowerCase().replace(/[^a-z]/g, \"\");\n      const biweeklyTasks = filtered.filter(\n        (t) => normalizeBiweekly(t.frequency) === \"biweekly\",\n      );\n      console.log(\n        `üìÖ DATE FILTER ACTIVE: ${dateFilter} - Before: ${filtered.length} tasks (${biweeklyTasks.length} biweekly)`,\n      );\n\n      const today = new Date().toISOString().split(\"T\")[0];\n      const isViewingToday = dateFilter === today;\n\n      filtered = filtered.filter((task) => {\n        // Handle completed/skipped tasks - they ONLY show on their action date\n        if (task.status === \"completed\" || task.status === \"skipped\") {\n          const actionDate = task.completedAt || task.skippedAt || task.dueDate;\n          const actionDateStr = actionDate\n            ? new Date(actionDate).toISOString().split(\"T\")[0]\n            : null;\n          return actionDateStr === dateFilter;\n        }\n\n        // For pending/in-progress tasks\n        const taskDueDate = task.dueDate;\n        if (!taskDueDate) return false;\n\n        const taskDateStr = formatDateForComparison(taskDueDate);\n        const taskIsOverdue = isTaskOverdue(task);\n\n        if (taskIsOverdue) {\n          // Overdue tasks show ONLY on today\n          return dateFilter === today;\n        } else {\n          // Use shared date filtering logic from dateUtils\n          return shouldTaskAppearOnDate(task, dateFilter);\n        }\n      });\n\n      const biweeklyAfter = filtered.filter(\n        (t) => normalizeBiweekly(t.frequency) === \"biweekly\",\n      );\n      console.log(\n        `üìÖ Showing ${filtered.length} tasks for ${dateFilter} (${biweeklyAfter.length} biweekly after date filter)`,\n      );\n    }\n\n    // CRITICAL: Remove any duplicate tasks based on ID to prevent ghost duplicates\n    const taskIds = new Set<number>();\n    const uniqueFiltered = filtered.filter((task) => {\n      if (taskIds.has(task.id)) {\n        console.warn(\n          `Duplicate task detected and removed: ${task.id} - ${task.title}`,\n        );\n        return false;\n      }\n      taskIds.add(task.id);\n      return true;\n    });\n\n    // PRIORITY SORTING: Overdue first, then Weekly -> Bi-Weekly -> Monthly -> Quarterly -> Others\n    const getFrequencyPriority = (frequency: string): number => {\n      switch (frequency?.toLowerCase()) {\n        case \"weekly\":\n          return 1;\n        case \"biweekly\":\n        case \"bi-weekly\":\n          return 2;\n        case \"monthly\":\n          return 3;\n        case \"quarterly\":\n          return 4;\n        default:\n          return 5; // daily, one-time, and other tasks\n      }\n    };\n\n    const sortedFiltered = [...uniqueFiltered].sort((a, b) => {\n      // FIRST: Overdue tasks always appear at the top\n      const aOverdue = isTaskOverdue(a);\n      const bOverdue = isTaskOverdue(b);\n\n      if (aOverdue && !bOverdue) return -1;\n      if (!aOverdue && bOverdue) return 1;\n\n      // If both overdue, sort by most overdue first (more days = higher priority)\n      if (aOverdue && bOverdue) {\n        const aDaysOverdue = getDaysOverdue(a);\n        const bDaysOverdue = getDaysOverdue(b);\n        if (aDaysOverdue !== bDaysOverdue) {\n          return bDaysOverdue - aDaysOverdue; // Most overdue first\n        }\n      }\n\n      // Next, sort by frequency priority (weekly first, then bi-weekly, etc.)\n      const aPriority = getFrequencyPriority(a.frequency);\n      const bPriority = getFrequencyPriority(b.frequency);\n\n      if (aPriority !== bPriority) {\n        return aPriority - bPriority;\n      }\n\n      // Within the same frequency, sort by status (pending first, then in_progress)\n      const statusOrder: Record<string, number> = {\n        pending: 1,\n        in_progress: 2,\n        paused: 3,\n        completed: 4,\n        skipped: 5,\n      };\n      const aStatusOrder = statusOrder[a.status || \"\"] || 6;\n      const bStatusOrder = statusOrder[b.status || \"\"] || 6;\n\n      if (aStatusOrder !== bStatusOrder) {\n        return aStatusOrder - bStatusOrder;\n      }\n\n      // Finally, sort by title alphabetically\n      return a.title.localeCompare(b.title);\n    });\n\n    // Log summary for debugging\n    console.log(\n      `Filtered from ${tasks.length} to ${sortedFiltered.length} tasks (removed ${filtered.length - uniqueFiltered.length} duplicates)`,\n    );\n\n    return sortedFiltered;\n  }, [\n    tasks,\n    searchTerm,\n    activeFilter,\n    statusFilter,\n    priorityFilter,\n    assignedToMeFilter,\n    dateFilter,\n    currentLocation.code,\n    isViewingAllLocations,\n    staffData,\n  ]);\n\n  // Clear all filters function\n  const clearAllFilters = async () => {\n    setActiveFilter(\"all\");\n    setStatusFilter(\"all\");\n    setPriorityFilter(\"all\");\n    setAssignedToMeFilter(false);\n    setDateFilter(\"\"); // Clear date filter to show ALL tasks from ALL dates\n    setSearchTerm(\"\");\n    // Refresh tasks to ensure immediate UI update\n    await refreshTasks();\n  };\n\n  // DEBUG: Force regenerate all recurring tasks\n  const regenerateAllRecurringTasks = async () => {\n    try {\n      const response = await fetch(\"/api/admin/generate-todays-tasks\", {\n        method: \"POST\",\n      });\n      const result = await response.json();\n      toast({\n        title: \"Tasks Generated\",\n        description: `Generated ${result.generatedCount} new tasks`,\n      });\n      await refetch();\n    } catch (error) {\n      toast({\n        title: \"Generation Failed\",\n        description: \"Failed to generate tasks\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  // Late task detection functions - fixed to avoid false positives\n  // Check if task was completed AFTER becoming overdue (8:30 AM on due date)\n  const isTaskCompletedLate = (task: Task): boolean => {\n    // Must be completed to be late\n    if (task.status !== \"completed\" || !task.completedAt || !task.dueDate) {\n      return false;\n    }\n\n    // For TEST tasks or tasks without proper dates, return false\n    if (!task.dueDate) return false;\n\n    try {\n      const dueDate = new Date(task.dueDate);\n      const completedTime = new Date(task.completedAt);\n\n      // Check if dates are valid\n      if (isNaN(dueDate.getTime()) || isNaN(completedTime.getTime()))\n        return false;\n\n      // Create overdue cutoff time: 8:30 PM on due date\n      const overdueTime = new Date(dueDate);\n      overdueTime.setHours(20, 30, 0, 0);\n\n      // Task is late if completed AFTER the overdue time (8:30 PM on due date)\n      return completedTime > overdueTime;\n    } catch (error) {\n      // If any date parsing fails, task is not late\n      return false;\n    }\n  };\n\n  // Legacy function name for compatibility\n  const isTaskLate = isTaskCompletedLate;\n\n  // Task status update functions\n  const updateTaskStatus = (taskId: number, newStatus: string) => {\n    const updates: any = { status: newStatus };\n\n    if (newStatus === \"in_progress\") {\n      updates.startedAt = new Date().toISOString();\n    } else if (newStatus === \"completed\") {\n      updates.completedAt = new Date().toISOString();\n      updates.progress = 100;\n    }\n\n    updateTaskMutation.mutate({ taskId, updates });\n  };\n\n  const handleStartTask = async (taskId: number) => {\n    // Perform hard reset synchronously - no delays\n    console.log(\"üîÑ Starting task - performing hard reset\");\n    setSelectedTask(null);\n    setModalOpen(false);\n    setTaskActionModalOpen(false);\n\n    updateTaskStatus(taskId, \"in_progress\");\n    const task = tasks.find(\n      (t) => t.id === taskId || t.id.toString() === taskId.toString(),\n    );\n    if (task) {\n      // Set fresh task state - component will remount with new task.id\n      setSelectedTask({\n        ...task,\n        status: \"in_progress\",\n        startedAt: new Date().toISOString(),\n      });\n      // Open TaskModal (with checklist) instead of TaskActionModal\n      setModalOpen(true);\n    }\n  };\n\n  const handleCompleteTask = async (taskId: number) => {\n    updateTaskStatus(taskId, \"completed\");\n\n    const task = tasks.find(\n      (t) => t.id === taskId || t.id.toString() === taskId.toString(),\n    );\n\n    if (auth.user && task) {\n      TaskCompletionService.handleTaskCompletion({\n        taskId: task.id,\n        title: task.title,\n        type: task.type,\n        checklistData: task.checklist || [],\n        completedBy: auth.user.id,\n      });\n    }\n\n    // Perform hard reset after completing task\n    console.log(\"‚úÖ Task completed - performing hard reset\");\n    await performHardReset(\"COMPLETE TASK\");\n\n    toast({\n      title: \"üéâ Task completed!\",\n      description: \"Great job! The task has been marked as completed.\",\n    });\n\n    confetti({\n      particleCount: 100,\n      spread: 70,\n      origin: { y: 0.6 },\n    });\n  };\n\n  // Single task action handler\n\n  const handleTaskAction = async (\n    taskId: number,\n    action:\n      | \"start\"\n      | \"collaborate\"\n      | \"complete\"\n      | \"pause\"\n      | \"skip\"\n      | \"view\"\n      | \"resume\",\n    reason?: string,\n  ) => {\n    const task = tasks.find(\n      (t) => t.id === taskId || t.id.toString() === taskId.toString(),\n    );\n    if (!task) return;\n\n    switch (action) {\n      case \"start\":\n        await handleStartTask(taskId);\n        break;\n\n      case \"collaborate\":\n        // Hard reset synchronously before opening task\n        console.log(\"üîÑ Collaborating - performing hard reset\");\n        setSelectedTask(null);\n        setModalOpen(false);\n        setSelectedTask(task);\n        setModalOpen(true);\n        break;\n\n      case \"complete\":\n        await handleCompleteTask(taskId);\n        break;\n\n      case \"view\":\n        // Hard reset synchronously before opening task\n        console.log(\"üîÑ Viewing task - performing hard reset\");\n        setSelectedTask(null);\n        setModalOpen(false);\n        setSelectedTask(task);\n        setModalOpen(true);\n        break;\n\n      case \"pause\":\n        updateTaskMutation.mutate({\n          taskId,\n          updates: {\n            status: \"paused\",\n            pausedAt: new Date().toISOString(),\n          } as any,\n        });\n        // Hard reset after pausing\n        console.log(\"‚è∏Ô∏è Task paused - performing hard reset\");\n        await performHardReset(\"PAUSE TASK\");\n        toast({\n          title: \"Task Paused\",\n          description: \"The task has been paused and can be resumed later.\",\n        });\n        break;\n\n      case \"skip\":\n        updateTaskMutation.mutate({\n          taskId,\n          updates: {\n            status: \"skipped\",\n            skipReason: reason || \"No reason provided\",\n            skippedAt: new Date(),\n          } as any,\n        });\n        // Hard reset after skipping\n        console.log(\"‚è≠Ô∏è Task skipped - performing hard reset\");\n        await performHardReset(\"SKIP TASK\");\n        toast({\n          title: \"Task Skipped\",\n          description: reason\n            ? `Task skipped: ${reason}`\n            : \"Task has been skipped.\",\n        });\n        break;\n\n      case \"resume\":\n        // Hard reset synchronously before resuming task\n        console.log(\"üîÑ Resuming task - performing hard reset\");\n        setSelectedTask(null);\n        setModalOpen(false);\n        setTaskActionModalOpen(false);\n\n        updateTaskMutation.mutate({\n          taskId,\n          updates: {\n            status: \"in_progress\",\n            resumedAt: new Date().toISOString(),\n          } as any,\n        });\n        setSelectedTask({\n          ...task,\n          status: \"in_progress\",\n          resumedAt: new Date().toISOString(),\n        });\n        setTaskActionModalOpen(true);\n        toast({\n          title: \"Task Resumed\",\n          description:\n            \"The task has been resumed and you can continue working.\",\n        });\n        break;\n    }\n  };\n\n  // Create task mutation\n  const createTaskMutation = useMutation({\n    mutationFn: (taskData: any) => apiRequest(\"POST\", \"/api/tasks\", taskData),\n    onSuccess: async () => {\n      // Invalidate all task queries to ensure proper cache refresh\n      queryClient.invalidateQueries({ queryKey: [\"/api/tasks\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/analytics/dashboard\"] });\n\n      // Immediately refresh tasks for instant UI update\n      await refreshTasks();\n\n      setAddTaskModalOpen(false);\n      toast({\n        title: \"Task Created\",\n        description: \"New task has been added successfully\",\n      });\n    },\n    onError: (error) => {\n      console.error(\"Create task error:\", error);\n      toast({\n        title: \"Error\",\n        description: \"Failed to create task. Please try again.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleAddTask = async (taskData: any) => {\n    console.log(\"handleAddTask called with:\", taskData);\n\n    const newTask = {\n      ...taskData,\n      // Send date as string, server will handle conversion\n      dueDate: taskData.dueDate,\n      // Add location to the task\n      location: currentLocation.code,\n    };\n\n    console.log(\"Calling createTaskMutation with:\", newTask);\n    createTaskMutation.mutate(newTask);\n    // Additional refresh to ensure immediate UI update\n    await refreshTasks();\n  };\n\n  const handleNewTask = async () => {\n    setAddTaskModalOpen(true);\n    // Refresh tasks when opening modal to ensure latest data\n    await refreshTasks();\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"space-y-6\">\n        <div className=\"animate-pulse space-y-4\">\n          <div className=\"h-8 bg-gray-200 rounded w-1/4\"></div>\n          <div className=\"h-4 bg-gray-200 rounded w-1/2\"></div>\n          <div className=\"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6\">\n            {[1, 2, 3, 4, 5, 6].map((i) => (\n              <div key={i} className=\"h-64 bg-gray-200 rounded-xl\"></div>\n            ))}\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"page-content\">\n      <div className=\"task-manager\">\n        {/* Updated filter bar with responsive scroll */}\n        <div className=\"filters-container\">\n          <div className=\"filters-scroll-wrapper\">\n            {/* Left scroll indicator */}\n            {canScrollLeft && (\n              <div\n                className=\"scroll-indicator left\"\n                onClick={() => {\n                  if (filtersRef.current) {\n                    filtersRef.current.scrollBy({\n                      left: -200,\n                      behavior: \"smooth\",\n                    });\n                  }\n                }}\n              >\n                <svg viewBox=\"0 0 24 24\" fill=\"currentColor\">\n                  <path d=\"M15 18l-6-6 6-6v12z\" />\n                </svg>\n              </div>\n            )}\n\n            {/* Right scroll indicator */}\n            {canScrollRight && (\n              <div\n                className=\"scroll-indicator right\"\n                onClick={() => {\n                  if (filtersRef.current) {\n                    filtersRef.current.scrollBy({\n                      left: 200,\n                      behavior: \"smooth\",\n                    });\n                  }\n                }}\n              >\n                <svg viewBox=\"0 0 24 24\" fill=\"currentColor\">\n                  <path d=\"M9 18l6-6-6-6v12z\" />\n                </svg>\n              </div>\n            )}\n\n            <div\n              className=\"filters-scroll-content task-filters tasks-filter-container\"\n              ref={filtersRef}\n              onScroll={(e) => {\n                const target = e.target as HTMLDivElement;\n                setCanScrollLeft(target.scrollLeft > 0);\n                setCanScrollRight(\n                  target.scrollLeft + target.clientWidth <\n                    target.scrollWidth - 5,\n                );\n              }}\n            >\n              <select\n                data-testid=\"select-category\"\n                value={activeFilter}\n                onChange={async (e) => {\n                  setActiveFilter(e.target.value);\n                  await refreshTasks();\n                }}\n                className=\"filter-select\"\n              >\n                <option value=\"all\">Category</option>\n                {taskTypes\n                  .filter((type) => type.value !== \"all\")\n                  .map((type) => (\n                    <option key={type.value} value={type.value}>\n                      {type.label}\n                    </option>\n                  ))}\n              </select>\n\n              {/* Status Select */}\n              <select\n                value={statusFilter}\n                onChange={async (e) => {\n                  setStatusFilter(e.target.value);\n                  await refreshTasks();\n                }}\n                className=\"filter-select\"\n              >\n                <option value=\"all\">Status</option>\n                {statusOptions\n                  .filter((option) => option.value !== \"all\")\n                  .map((option) => (\n                    <option key={option.value} value={option.value}>\n                      {option.label}\n                    </option>\n                  ))}\n              </select>\n\n              {/* Priority Select */}\n              <select\n                value={priorityFilter}\n                onChange={async (e) => {\n                  setPriorityFilter(e.target.value);\n                  await refreshTasks();\n                }}\n                className=\"filter-select\"\n              >\n                <option value=\"all\">Priority</option>\n                {priorityOptions\n                  .filter((option) => option.value !== \"all\")\n                  .map((option) => (\n                    <option key={option.value} value={option.value}>\n                      {option.label}\n                    </option>\n                  ))}\n              </select>\n\n              {/* Assigned to Me Toggle */}\n              <label className=\"assigned-to-me-toggle flex items-center gap-2 px-3 py-2 border rounded-lg cursor-pointer hover:bg-gray-50 whitespace-nowrap\">\n                <input\n                  type=\"checkbox\"\n                  checked={assignedToMeFilter}\n                  onChange={async (e) => {\n                    setAssignedToMeFilter(e.target.checked);\n                    // Keep all existing filters active - \"Only My Tasks\" stacks with other filters\n                    await refreshTasks();\n                  }}\n                  className=\"h-4 w-4 text-[#2D8028] focus:ring-[#2D8028] border-gray-300 rounded\"\n                />\n                <span className=\"text-sm font-medium text-gray-700\">\n                  üìå Only My Tasks\n                </span>\n              </label>\n\n              {/* Date Input */}\n              <div className=\"flex items-center gap-2\">\n                <input\n                  type=\"date\"\n                  value={dateFilter}\n                  onChange={async (e) => {\n                    setDateFilter(e.target.value);\n                    await refreshTasks();\n                  }}\n                  className=\"date-input\"\n                />\n                <button\n                  onClick={async () => {\n                    const today = new Date();\n                    const year = today.getFullYear();\n                    const month = String(today.getMonth() + 1).padStart(2, \"0\");\n                    const day = String(today.getDate()).padStart(2, \"0\");\n                    const todayString = `${year}-${month}-${day}`;\n                    console.log(\n                      \"üóìÔ∏è Today button clicked, setting date to:\",\n                      todayString,\n                    );\n                    setDateFilter(todayString);\n                    await refreshTasks();\n                  }}\n                  className=\"btn-today\"\n                  title=\"Go to today\"\n                >\n                  Today\n                </button>\n              </div>\n\n              {/* Clear Filters Button */}\n              <button className=\"btn-clear-filters\" onClick={clearAllFilters}>\n                <X size={16} /> Clear Filters\n              </button>\n\n              {/* Search Box */}\n              <div className=\"search-box\">\n                <Search size={16} />\n                <input\n                  type=\"text\"\n                  placeholder=\"Search tasks...\"\n                  value={searchTerm}\n                  onChange={async (e) => {\n                    setSearchTerm(e.target.value);\n                    // Debounce search to avoid too many refreshes\n                    if (searchTimeoutRef.current) {\n                      clearTimeout(searchTimeoutRef.current);\n                    }\n                    searchTimeoutRef.current = setTimeout(async () => {\n                      await refreshTasks();\n                    }, 300);\n                  }}\n                  className=\"search-input\"\n                />\n              </div>\n\n              {/* New Task Button */}\n              <button className=\"btn-new-task\" onClick={handleNewTask}>\n                <Plus size={16} /> New Task\n              </button>\n\n              {/* Refresh Tasks Button */}\n              <button\n                className=\"btn-refresh\"\n                onClick={async () => {\n                  console.log(\"=== REFRESHING TASKS ===\");\n                  await refreshTasks();\n                  toast({\n                    title: \"Tasks Refreshed\",\n                    description: \"All tasks reloaded successfully\",\n                  });\n                }}\n                disabled={isRefreshing}\n                title=\"Refresh and reload all tasks\"\n              >\n                {isRefreshing ? \"‚è≥ Refreshing...\" : \"üîÑ Refresh Tasks\"}\n              </button>\n\n              {/* Generation Status Badge */}\n              <GenerationStatusBadge />\n            </div>\n          </div>\n        </div>\n\n        {/* Refresh Loading Indicator */}\n        {isRefreshing && (\n          <div\n            style={{\n              position: \"absolute\",\n              top: \"20px\",\n              right: \"20px\",\n              zIndex: 1000,\n              padding: \"8px 16px\",\n              background: \"#2D8028\",\n              color: \"white\",\n              borderRadius: \"6px\",\n              fontSize: \"14px\",\n              fontWeight: \"500\",\n              boxShadow: \"0 4px 12px rgba(0,0,0,0.15)\",\n              display: \"flex\",\n              alignItems: \"center\",\n              gap: \"8px\",\n            }}\n          >\n            <div\n              className=\"animate-spin\"\n              style={{\n                width: \"16px\",\n                height: \"16px\",\n                border: \"2px solid transparent\",\n                borderTop: \"2px solid white\",\n                borderRadius: \"50%\",\n              }}\n            ></div>\n            Updating tasks...\n          </div>\n        )}\n\n        {/* Gamified Progress Bars */}\n        <GamifiedProgressBars\n          tasks={filteredTasks as any}\n          currentUser={currentUser as any}\n          selectedDate={dateFilter}\n        />\n\n        {/* Overdue Tasks Summary */}\n        {(() => {\n          const overdueTasks = filteredTasks.filter((task) =>\n            isTaskOverdue(task),\n          );\n          if (overdueTasks.length === 0) return null;\n\n          const criticalCount = overdueTasks.filter(\n            (t) => getOverdueSeverity(t) === \"critical\",\n          ).length;\n          const warningCount = overdueTasks.filter(\n            (t) => getOverdueSeverity(t) === \"warning\",\n          ).length;\n          const mildCount = overdueTasks.filter(\n            (t) => getOverdueSeverity(t) === \"mild\",\n          ).length;\n\n          return (\n            <div className=\"overdue-summary\" data-testid=\"overdue-summary\">\n              <h3>\n                <span style={{ fontSize: \"18px\" }}>‚ö†Ô∏è</span>\n                Overdue Tasks: {overdueTasks.length}\n              </h3>\n              <div className=\"overdue-counts\">\n                {criticalCount > 0 && (\n                  <div\n                    className=\"count-item critical\"\n                    data-testid=\"overdue-critical-count\"\n                  >\n                    üî¥ {criticalCount} critical (7+ days)\n                  </div>\n                )}\n                {warningCount > 0 && (\n                  <div\n                    className=\"count-item warning\"\n                    data-testid=\"overdue-warning-count\"\n                  >\n                    üü† {warningCount} warning (3-6 days)\n                  </div>\n                )}\n                {mildCount > 0 && (\n                  <div\n                    className=\"count-item mild\"\n                    data-testid=\"overdue-mild-count\"\n                  >\n                    üü° {mildCount} mild (1-2 days)\n                  </div>\n                )}\n              </div>\n            </div>\n          );\n        })()}\n\n        {/* Task Content */}\n        <div className=\"task-content\">\n          {filteredTasks.length === 0 ? (\n            <div className=\"no-tasks\">\n              <div style={{ fontSize: \"48px\", marginBottom: \"16px\" }}>üå±</div>\n              <h3>No tasks found</h3>\n              <p>You're all caught up! No tasks available right now.</p>\n            </div>\n          ) : (\n            <div className=\"task-list\">\n              <div className=\"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6\">\n                {filteredTasks.map((task) => (\n                  <TaskCard\n                    key={task.id}\n                    task={task}\n                    onTaskAction={handleTaskAction}\n                    staff={staffData}\n                  />\n                ))}\n              </div>\n            </div>\n          )}\n        </div>\n\n        {/* Task Modal - Keyed by task ID to force remount when task changes */}\n        <TaskModal\n          key={`task-modal-${selectedTask?.id || \"none\"}`}\n          task={selectedTask}\n          isOpen={modalOpen}\n          onClose={() => {\n            // Clear selectedTask to prevent stale data\n            setSelectedTask(null);\n            setModalOpen(false);\n          }}\n          onTaskAction={handleTaskAction}\n        />\n\n        {/* Add Task Modal */}\n        <AddTaskModal\n          open={addTaskModalOpen}\n          onClose={() => setAddTaskModalOpen(false)}\n          onSave={handleAddTask}\n          currentUser={auth?.user}\n        />\n\n        {/* Task Action Modal - Keyed by task ID to force remount when task changes */}\n        <TaskActionModal\n          key={`task-action-modal-${selectedTask?.id || \"none\"}`}\n          task={selectedTask}\n          open={taskActionModalOpen}\n          onClose={() => {\n            // Clear selectedTask to prevent stale data\n            performHardReset(\"CLOSE TASK ACTION MODAL\", false);\n            setTaskActionModalOpen(false);\n          }}\n        />\n      </div>\n    </div>\n  );\n};\n\nexport default Tasks;\n","path":null,"size_bytes":43469,"size_tokens":null},"client/src/components/ui/label.tsx":{"content":"import * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst labelVariants = cva(\n  \"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70\"\n)\n\nconst Label = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root> &\n    VariantProps<typeof labelVariants>\n>(({ className, ...props }, ref) => (\n  <LabelPrimitive.Root\n    ref={ref}\n    className={cn(labelVariants(), className)}\n    {...props}\n  />\n))\nLabel.displayName = LabelPrimitive.Root.displayName\n\nexport { Label }\n","path":null,"size_bytes":710,"size_tokens":null},"client/src/components/checklist/CreateTrayStep.tsx":{"content":"import React, { useState, useEffect } from 'react';\nimport { Plus, Minus } from 'lucide-react';\nimport TrayDataService from '../../services/trayDataService';\nimport { Tray } from '../../data/trayTracking';\n\ninterface CreateTrayStepProps {\n  stepData: any;\n  onComplete: (data: any) => void;\n  defaultInstance?: number;\n  defaultTrayType?: 'MG' | 'LG' | 'HB';\n  defaultSeedsOz?: string;\n  defaultGrowingMedium?: string;\n  defaultTotalSlots?: number;\n  defaultVarieties?: any[];\n  instructions?: string;\n}\n\ninterface Variety {\n  id: string;\n  seedId: string;\n  seedName: string;\n  sku: string;\n  quantity: number;\n  seedsOz: number;\n}\n\ninterface InventoryItem {\n  id: string;\n  name: string;\n  sku: string;\n  category: string;\n  quantity: number;\n  unit: string;\n}\n\nconst CreateTrayStep: React.FC<CreateTrayStepProps> = ({ \n  stepData, \n  onComplete,\n  defaultInstance = 1,\n  defaultTrayType = 'LG',\n  defaultSeedsOz = '',\n  defaultGrowingMedium = '',\n  defaultTotalSlots = 0,\n  defaultVarieties = [],\n  instructions = ''\n}) => {\n  const [selectedSeed, setSelectedSeed] = useState<InventoryItem | null>(null);\n  const [trayType, setTrayType] = useState<'MG' | 'LG' | 'HB'>(\n    stepData?.defaultTrayType || defaultTrayType\n  );\n  const [instanceNumber, setInstanceNumber] = useState(\n    stepData?.defaultInstance || defaultInstance\n  );\n  const [seedsOz, setSeedsOz] = useState(\n    stepData?.defaultSeedsOz || defaultSeedsOz\n  );\n  const [growingMedium, setGrowingMedium] = useState(\n    stepData?.defaultGrowingMedium === 'user-selects' ? '' : \n    stepData?.defaultGrowingMedium || defaultGrowingMedium\n  );\n  const [varieties, setVarieties] = useState<Variety[]>(() => {\n    // Initialize with ALL default varieties from config if available\n    const configuredDefaults = stepData?.defaultVarieties || [];\n    console.log('üîß Initializing varieties with defaults:', configuredDefaults);\n    \n    if (configuredDefaults && configuredDefaults.length > 0) {\n      return configuredDefaults.map((defaultVar: any, index: number) => ({\n        id: (index + 1).toString(),\n        seedId: defaultVar.seedId || '',\n        seedName: defaultVar.seedName || '',\n        sku: defaultVar.sku || '',\n        quantity: parseInt(defaultVar.quantity) || 0,\n        seedsOz: parseFloat(defaultVar.seedsOz) || 0\n      }));\n    }\n    \n    // Fallback to single empty variety\n    return [{ id: '1', seedId: '', seedName: '', sku: '', quantity: 0, seedsOz: 0 }];\n  });\n  const [totalSlots, setTotalSlots] = useState(\n    stepData?.defaultTotalSlots || defaultTotalSlots || 0\n  );\n  const [notes, setNotes] = useState('');\n  const [generatedId, setGeneratedId] = useState('');\n  const [availableSeeds, setAvailableSeeds] = useState<InventoryItem[]>([]);\n  const [availableVarieties, setAvailableVarieties] = useState<string[]>(['Standard']);\n  \n  // Calculate total plants\n  const totalPlants = varieties.reduce((sum, v) => sum + (parseInt(v.quantity.toString()) || 0), 0);\n\n  // Get current user and location\n  const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');\n  const locationCode = currentUser.location === 'kenosha' ? 'K' : \n                      currentUser.location === 'racine' ? 'R' : \n                      currentUser.location === 'milwaukee' ? 'MKE' : 'K';\n\n  // Load seed inventory on mount (once)\n  useEffect(() => {\n    let isMounted = true;\n    \n    // Load from the same source as the Inventory page\n    fetch('/api/inventory')\n      .then(res => {\n        if (!res.ok) throw new Error(`HTTP ${res.status}`);\n        return res.json();\n      })\n      .then(inventory => {\n        if (!isMounted) return;\n        // Filter to only show seeds\n        const seeds = inventory.filter((item: InventoryItem) => \n          item.category.toLowerCase().includes('seed')\n        );\n        setAvailableSeeds(seeds);\n      })\n      .catch(err => {\n        if (!isMounted) return;\n        console.warn('API inventory load failed, using localStorage fallback:', err);\n        // Fallback: try to load from localStorage if API fails\n        try {\n          const localInventory = JSON.parse(localStorage.getItem('inventory') || '[]');\n          const seeds = localInventory.filter((item: InventoryItem) => \n            item.category.toLowerCase().includes('seed')\n          );\n          setAvailableSeeds(seeds);\n        } catch (parseError) {\n          console.error('Failed to parse localStorage inventory:', parseError);\n          setAvailableSeeds([]);\n        }\n      });\n\n    return () => {\n      isMounted = false;\n    };\n  }, []); // Empty dependency array - run only once\n\n  // Update seed names for varieties when available seeds are loaded\n  useEffect(() => {\n    if (availableSeeds.length > 0) {\n      setVarieties(currentVarieties => \n        currentVarieties.map(variety => {\n          if (variety.seedId && !variety.seedName) {\n            const foundSeed = availableSeeds.find(seed => seed.id.toString() === variety.seedId.toString());\n            console.log('üîç Updating variety seed name:', { seedId: variety.seedId, foundSeed });\n            if (foundSeed) {\n              return {\n                ...variety,\n                seedName: foundSeed.name,\n                sku: foundSeed.sku || foundSeed.SKU || foundSeed.productCode || ''\n              };\n            }\n          }\n          return variety;\n        })\n      );\n    }\n  }, [availableSeeds]); // Update seed names when seeds are loaded\n\n  // Update available varieties when seed type changes\n  useEffect(() => {\n    if (selectedSeed && selectedSeed.sku) {\n      const varietiesBySeed: Record<string, string[]> = {\n        'BROC': ['Calabrese', 'De Cicco', 'Waltham 29', 'Standard'],\n        'ARU': ['Astro', 'Roquette', 'Wild Rocket', 'Standard'],\n        'ROM': ['Parris Island', 'Little Gem', 'Vivian', 'Cos', 'Standard'],\n        'BASIL': ['Genovese', 'Sweet', 'Purple Ruffles', 'Lemon', 'Thai', 'Standard'],\n        'SPI': ['Space', 'Bloomsdale', 'Giant Winter', 'Standard'],\n        'KALE': ['Dwarf Blue Curled', 'Winterbor', 'Red Russian', 'Lacinato', 'Standard'],\n        'RADI': ['China Rose', 'Daikon', 'Red Arrow', 'Standard'],\n        'SUNF': ['Black Oil', 'Mammoth', 'Standard'],\n        'PEAS': ['Dwarf Grey Sugar', 'Oregon Sugar Pod', 'Standard']\n      };\n      \n      const seedVarieties = varietiesBySeed[selectedSeed.sku] || ['Standard'];\n      setAvailableVarieties(seedVarieties);\n      \n      // Reset varieties when seed changes\n      setVarieties([{ id: '1', seedId: '', seedName: '', sku: '', quantity: 0, seedsOz: 0 }]);\n    } else {\n      setAvailableVarieties(['Standard']);\n    }\n  }, [selectedSeed]);\n\n  // Generate tray ID whenever inputs change\n  useEffect(() => {\n    const date = new Date();\n    // TIMEZONE FIX: Use UTC methods to match database storage and consistent date handling\n    const dateStr = \n      (date.getUTCMonth() + 1).toString().padStart(2, '0') +\n      date.getUTCDate().toString().padStart(2, '0') +\n      date.getUTCFullYear().toString().slice(2);\n    \n    // Determine SKU based on varieties\n    let sku = 'MIX'; // Default for multiple varieties\n    \n    if (varieties.length === 1 && varieties[0].sku) {\n      // Single variety - use its SKU directly\n      sku = varieties[0].sku.toUpperCase();\n    } else if (varieties.length === 1 && varieties[0].seedId) {\n      // Fallback: find seed by ID and use its SKU\n      const seed = availableSeeds.find(s => s.id.toString() === varieties[0].seedId.toString());\n      if (seed) {\n        sku = (seed.sku || seed.SKU || seed.productCode || 'UNK').toUpperCase();\n      }\n    }\n    \n    const id = `${locationCode}${dateStr}-${trayType}-${sku}-${instanceNumber}`;\n    setGeneratedId(id);\n  }, [locationCode, trayType, varieties, instanceNumber, availableSeeds]);\n\n  const addVariety = () => {\n    setVarieties([...varieties, { \n      id: Date.now().toString(), \n      seedId: '', \n      seedName: '', \n      sku: '', \n      quantity: 0, \n      seedsOz: 0 \n    }]);\n  };\n\n  const removeVariety = (id: string) => {\n    if (varieties.length > 1) {\n      setVarieties(varieties.filter(v => v.id !== id));\n    }\n  };\n\n  const updateVariety = (id: string, field: keyof Variety, value: any) => {\n    setVarieties(varieties.map(v => \n      v.id === id ? { ...v, [field]: value } : v\n    ));\n  };\n\n  const handleCreate = async () => {\n    // Validate inputs\n    if (!growingMedium || totalSlots === 0) {\n      alert('Please fill in growing medium and total slots');\n      return;\n    }\n\n    if (totalPlants > totalSlots) {\n      alert(`Total plants (${totalPlants}) exceeds available slots (${totalSlots})`);\n      return;\n    }\n\n    // Build variety details\n    const varietyDetails = varieties\n      .filter(v => v.seedId && v.quantity > 0)\n      .map(v => {\n        const seed = availableSeeds.find(s => s.id === v.seedId);\n        console.log('üîç Seed lookup:', { seedId: v.seedId, availableSeeds: availableSeeds.length, foundSeed: seed });\n        return {\n          seedId: v.seedId,\n          seedName: seed?.name || v.seedName || 'Unknown',\n          sku: seed?.sku || v.sku || '',\n          quantity: parseInt(v.quantity.toString()),\n          seedsOz: parseFloat(v.seedsOz.toString()) || 0\n        };\n      });\n\n    if (varietyDetails.length === 0) {\n      alert('Please add at least one variety with quantity');\n      return;\n    }\n\n    // Check inventory for each variety\n    for (const variety of varietyDetails) {\n      const seed = availableSeeds.find(s => s.id === variety.seedId);\n      if (seed && variety.seedsOz > (seed as any).currentStock) {\n        alert(`Not enough ${seed.name} in inventory. Available: ${(seed as any).currentStock} ${seed.unit}`);\n        return;\n      }\n    }\n\n    try {\n      // Create new tray object with multiple varieties\n      const newTray: Tray = {\n        id: generatedId,\n        cropType: varietyDetails.length === 1 ? varietyDetails[0].seedName : 'Mixed Varieties',\n        cropCategory: trayType === 'MG' ? 'microgreens' : 'leafyGreens',\n        datePlanted: new Date(),\n        expectedHarvest: new Date(Date.now() + (trayType === 'MG' ? 7 : 30) * 24 * 60 * 60 * 1000),\n        status: 'seeded',\n        currentLocation: {\n          systemId: trayType === 'MG' ? 'nursery-A1' : 'staging-B1',\n          systemType: trayType === 'MG' ? 'Nursery' : 'Staging',\n          spotIds: ['1'],\n          movedDate: new Date()\n        },\n        locationHistory: [{\n          systemId: trayType === 'MG' ? 'nursery-A1' : 'staging-B1',\n          systemType: trayType === 'MG' ? 'Nursery' : 'Staging',\n          spotIds: ['1'],\n          movedDate: new Date(),\n          movedBy: currentUser.username || 'Unknown',\n          reason: 'Initial seeding'\n        }],\n        plantCount: totalPlants,\n        varieties: varietyDetails, // Store variety information\n        notes: notes || `Varieties: ${varietyDetails.map(v => `${v.quantity} ${v.seedName} (${v.seedsOz}oz)`).join(', ')}, Medium: ${growingMedium}`,\n        createdBy: currentUser.username || 'Unknown',\n        createdDate: new Date()\n      };\n\n      // Add to tray tracking system using the addTray method\n      TrayDataService.addTray(newTray);\n\n      // Deduct inventory for each variety\n      for (const variety of varietyDetails) {\n        try {\n          await fetch('/api/inventory/deduct', {\n            method: 'POST',\n            headers: { 'Content-Type': 'application/json' },\n            body: JSON.stringify({\n              itemId: variety.seedId,\n              quantity: variety.seedsOz,\n              reason: `Seeded tray ${generatedId}`\n            })\n          });\n          console.log(`Deducted ${variety.seedsOz} oz of ${variety.seedName} from inventory`);\n        } catch (err) {\n          console.warn('Failed to deduct from API, updating locally:', err);\n          // Fallback to local inventory update\n          const inventory = JSON.parse(localStorage.getItem('inventory') || '[]');\n          const updatedInventory = inventory.map((item: InventoryItem) => {\n            if (item.id === variety.seedId) {\n              return { ...item, currentStock: (item as any).currentStock - variety.seedsOz };\n            }\n            return item;\n          });\n          localStorage.setItem('inventory', JSON.stringify(updatedInventory));\n        }\n      }\n      \n      console.log('Created tray:', newTray);\n      \n      // Complete the step with tray data\n      onComplete({\n        trayId: generatedId,\n        varietiesUsed: varietyDetails,\n        trayCreated: true,\n        ...newTray\n      });\n\n    } catch (error) {\n      console.error('Failed to create tray:', error);\n      alert('Failed to create tray. Please try again.');\n    }\n  };\n\n  const displayInstructions = stepData?.config?.instructions || instructions;\n\n  return (\n    <div className=\"create-tray-step\">\n      <h3 className=\"text-lg font-semibold mb-4\">Create New Tray</h3>\n      \n      {displayInstructions && (\n        <div className=\"instructions bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4\">\n          <h4 className=\"text-sm font-medium text-blue-800 mb-1\">Instructions:</h4>\n          <p className=\"text-sm text-blue-700\">{displayInstructions}</p>\n        </div>\n      )}\n      \n      {generatedId && (\n        <div className=\"tray-id-preview bg-green-50 border border-green-200 rounded-lg p-3 mb-4\">\n          <strong className=\"text-green-800\">Tray ID:</strong> \n          <span className=\"font-mono text-lg ml-2\">{generatedId}</span>\n        </div>\n      )}\n\n      <div className=\"space-y-4\">\n        <div className=\"grid grid-cols-2 gap-4\">\n          <div className=\"form-group\">\n            <label className=\"block text-sm font-medium mb-2\">Type*</label>\n            <select \n              className=\"w-full p-2 border border-gray-300 rounded-md\"\n              value={trayType} \n              onChange={(e) => setTrayType(e.target.value as any)}\n            >\n              <option value=\"MG\">MG - Microgreens</option>\n              <option value=\"LG\">LG - Leafy Greens</option>\n              <option value=\"HB\">HB - Herbs</option>\n            </select>\n          </div>\n\n          <div className=\"form-group\">\n            <label className=\"block text-sm font-medium mb-2\">Instance #</label>\n            <input\n              className=\"w-full p-2 border border-gray-300 rounded-md\"\n              type=\"number\"\n              value={instanceNumber}\n              onChange={(e) => setInstanceNumber(parseInt(e.target.value) || 1)}\n              min={1}\n              max={99}\n            />\n          </div>\n        </div>\n\n        <div className=\"grid grid-cols-2 gap-4\">\n          <div className=\"form-group\">\n            <label className=\"block text-sm font-medium mb-2\">Growing Medium*</label>\n            <select \n              className=\"w-full p-2 border border-gray-300 rounded-md\"\n              value={growingMedium} \n              onChange={(e) => setGrowingMedium(e.target.value)}\n            >\n              <option value=\"\">Select Medium</option>\n              <option value=\"Oasis Cubes\">Oasis Cubes</option>\n              <option value=\"Rockwool\">Rockwool</option>\n              <option value=\"Hemp Mat\">Hemp Mat</option>\n            </select>\n          </div>\n\n          <div className=\"form-group\">\n            <label className=\"block text-sm font-medium mb-2\">Total Slots Available*</label>\n            <input\n              className=\"w-full p-2 border border-gray-300 rounded-md\"\n              type=\"number\"\n              value={totalSlots}\n              onChange={(e) => setTotalSlots(parseInt(e.target.value) || 0)}\n              placeholder=\"e.g., 200\"\n              min={1}\n            />\n            <small className=\"text-xs text-gray-500\">Rockwool: typically 200, Oasis: varies</small>\n          </div>\n        </div>\n\n        <div className=\"varieties-section\">\n          <div className=\"flex justify-between items-center mb-3\">\n            <h4 className=\"text-sm font-medium\">\n              {trayType === 'MG' ? \n                (varieties.length === 1 ? 'Microgreen Variety' : 'Microgreen Varieties') :\n                (varieties.length === 1 ? 'Crop Variety' : 'Crop Varieties')\n              }\n            </h4>\n            <div className=\"text-sm text-gray-600\">\n              Total Plants: <span className=\"font-medium\">{totalPlants}</span> / <span className=\"font-medium\">{totalSlots || '?'}</span>\n              {totalSlots > 0 && totalPlants > totalSlots && (\n                <span className=\"ml-2 text-red-600 font-medium\">‚ö†Ô∏è Exceeds capacity!</span>\n              )}\n            </div>\n          </div>\n\n          {varieties.map((variety, index) => (\n            <div key={variety.id} className=\"variety-row bg-gray-50 p-3 rounded-lg mb-3\">\n              <div className=\"grid grid-cols-4 gap-3\">\n                <select\n                  className=\"col-span-2 p-2 border border-gray-300 rounded-md\"\n                  value={variety.seedId}\n                  onChange={(e) => {\n                    const seed = availableSeeds.find(s => s.id === e.target.value);\n                    updateVariety(variety.id, 'seedId', e.target.value);\n                    updateVariety(variety.id, 'seedName', seed?.name || '');\n                    updateVariety(variety.id, 'sku', seed?.sku || '');\n                  }}\n                >\n                  <option value=\"\">Select seed...</option>\n                  {availableSeeds.map(seed => (\n                    <option key={seed.id} value={seed.id}>\n                      [{seed.sku}] {seed.name}\n                    </option>\n                  ))}\n                </select>\n                \n                <input\n                  type=\"number\"\n                  value={variety.quantity}\n                  onChange={(e) => updateVariety(variety.id, 'quantity', parseInt(e.target.value) || 0)}\n                  placeholder=\"Plants\"\n                  step=\"1\"\n                  min={0}\n                  className=\"p-2 border border-gray-300 rounded-md\"\n                />\n                \n                <input\n                  type=\"number\"\n                  value={variety.seedsOz}\n                  onChange={(e) => {\n                    // Round to 3 decimal places to avoid floating point precision issues\n                    const seedsOz = parseFloat(e.target.value) || 0;\n                    const rounded = Math.round(seedsOz * 1000) / 1000;\n                    updateVariety(variety.id, 'seedsOz', rounded);\n                  }}\n                  placeholder=\"0.000\"\n                  step=\"0.001\"\n                  min=\"0.001\"\n                  max=\"10\"\n                  className=\"p-2 border border-gray-300 rounded-md\"\n                />\n              </div>\n              \n              {varieties.length > 1 && (\n                <div className=\"mt-2 flex justify-end\">\n                  <button \n                    type=\"button\"\n                    onClick={() => removeVariety(variety.id)} \n                    className=\"px-3 py-1 text-sm text-red-600 hover:bg-red-50 rounded-md\"\n                  >\n                    ‚úï Remove\n                  </button>\n                </div>\n              )}\n            </div>\n          ))}\n          \n          <button \n            type=\"button\"\n            onClick={addVariety} \n            className=\"flex items-center gap-2 px-4 py-2 bg-green-100 hover:bg-green-200 text-green-800 border border-green-300 rounded-md\"\n          >\n            <Plus size={16} /> Add Another Variety\n          </button>\n        </div>\n\n        <div className=\"form-group\">\n          <label className=\"block text-sm font-medium mb-2\">Notes</label>\n          <textarea\n            className=\"w-full p-2 border border-gray-300 rounded-md\"\n            value={notes}\n            onChange={(e) => setNotes(e.target.value)}\n            placeholder=\"Optional notes...\"\n            rows={3}\n          />\n        </div>\n\n        <button \n          onClick={handleCreate} \n          className=\"w-full bg-green-600 text-white py-3 px-4 rounded-md font-semibold hover:bg-green-700 transition-colors disabled:bg-gray-400\"\n          disabled={!growingMedium || totalSlots === 0 || totalPlants === 0}\n        >\n          {varieties.length === 1 ? 'Create Tray' : 'Create Multi-Variety Tray'}\n        </button>\n      </div>\n    </div>\n  );\n};\n\nexport default CreateTrayStep;","path":null,"size_bytes":20283,"size_tokens":null},"client/src/utils/sharePointMigration.ts":{"content":"import { apiRequest } from '@/lib/queryClient';\n\n// Available Categories from the task system\nconst TASK_CATEGORIES = [\n  'Seeding - Microgreens',\n  'Seeding - Leafy Greens', \n  'Harvest - Microgreens',\n  'Harvest - Leafy Greens',\n  'Blackout Tasks',\n  'Moving',\n  'Cleaning',\n  'Equipment Maintenance',\n  'Inventory',\n  'Other'\n];\n\n// Parse frequency from the Week Day field\nconst parseFrequencyFromWeekDay = (weekDayField: string) => {\n  if (!weekDayField) return { frequency: 'daily' };\n  \n  const lower = weekDayField.toLowerCase();\n  \n  // Check for bi-weekly (combine a and b per your instruction)\n  if (lower.includes('bi-weekly') || lower.includes('biweekly') || \n      lower === 'a' || lower === 'b') {\n    return { \n      frequency: 'biweekly',\n      weekPeriod: 'first'\n    };\n  }\n  \n  // Check for monthly\n  if (lower.includes('month') || /\\d+/.test(weekDayField)) {\n    const dayMatch = weekDayField.match(/\\d+/);\n    return {\n      frequency: 'monthly',\n      dayOfMonth: dayMatch ? parseInt(dayMatch[0]) : 1\n    };\n  }\n  \n  // Check for daily\n  if (lower.includes('daily') || lower.includes('every day')) {\n    return { frequency: 'daily' };\n  }\n  \n  // Parse weekly with specific days\n  const days: string[] = [];\n  const dayMap: {[key: string]: string[]} = {\n    'monday': ['mon', 'monday'],\n    'tuesday': ['tue', 'tues', 'tuesday'],\n    'wednesday': ['wed', 'wednesday'],\n    'thursday': ['thu', 'thur', 'thursday'],\n    'friday': ['fri', 'friday'],\n    'saturday': ['sat', 'saturday'],\n    'sunday': ['sun', 'sunday']\n  };\n  \n  Object.entries(dayMap).forEach(([fullDay, patterns]) => {\n    patterns.forEach(pattern => {\n      if (lower.includes(pattern)) {\n        days.push(fullDay);\n      }\n    });\n  });\n  \n  if (days.length > 0) {\n    return {\n      frequency: 'weekly',\n      daysOfWeek: days\n    };\n  }\n  \n  // Default to daily if can't parse\n  return { frequency: 'daily' };\n};\n\n// Map old priority values\nconst mapPriority = (oldPriority: string) => {\n  if (!oldPriority) return 'medium';\n  \n  const priorityMap: {[key: string]: string} = {\n    'high priority': 'high',\n    'medium priority': 'medium',\n    'low priority': 'low',\n    'high': 'high',\n    'medium': 'medium',\n    'low': 'low',\n    'normal': 'medium',\n    '1': 'high',\n    '2': 'medium',\n    '3': 'low'\n  };\n  \n  return priorityMap[oldPriority.toLowerCase()] || 'medium';\n};\n\n// Determine category based on title/description\nconst determineCategory = (title: string, description: string) => {\n  const text = `${title} ${description}`.toLowerCase();\n  \n  // Check each category in order of specificity\n  if (text.includes('seed') && text.includes('microgreen')) {\n    return 'Seeding - Microgreens';\n  } else if (text.includes('seed') && (text.includes('leafy') || text.includes('lettuce'))) {\n    return 'Seeding - Leafy Greens';\n  } else if (text.includes('harvest') && text.includes('microgreen')) {\n    return 'Harvest - Microgreens';\n  } else if (text.includes('harvest') && (text.includes('leafy') || text.includes('lettuce'))) {\n    return 'Harvest - Leafy Greens';\n  } else if (text.includes('blackout') || text.includes('black out')) {\n    return 'Blackout Tasks';\n  } else if (text.includes('mov') || text.includes('transfer') || text.includes('rotate')) {\n    return 'Moving';\n  } else if (text.includes('clean') || text.includes('sanitize') || text.includes('wash')) {\n    return 'Cleaning';\n  } else if (text.includes('equipment') || text.includes('maintenance') || text.includes('repair')) {\n    return 'Equipment Maintenance';\n  } else if (text.includes('inventory') || text.includes('count') || text.includes('stock')) {\n    return 'Inventory';\n  } else {\n    return 'Other';\n  }\n};\n\n// Map to appropriate role based on assigned to and task title\nconst mapToRole = (assignedTo: string, taskTitle: string) => {\n  if (!assignedTo) return 'General Staff';\n  \n  const assigned = assignedTo.toLowerCase();\n  const title = taskTitle.toLowerCase();\n  \n  // Try to infer role from assignment and task\n  if (title.includes('seed') || assigned.includes('seed')) {\n    return 'Microgreen Seeder';\n  } else if (title.includes('harvest') || assigned.includes('harvest')) {\n    return 'Harvester';\n  } else if (title.includes('deliver') || assigned.includes('deliver')) {\n    return 'Delivery Driver';\n  } else if (assigned.includes('manager') || assigned.includes('lead')) {\n    return 'Manager';\n  } else if (assigned.includes('all') || assigned.includes('everyone')) {\n    return 'General Staff';\n  } else {\n    // Default to general staff\n    return 'General Staff';\n  }\n};\n\n// Parse CSV data using JavaScript built-in parsing\nconst parseCSV = (csvText: string) => {\n  const lines = csvText.split('\\n');\n  const headers = lines[0].split(',').map(h => h.replace(/\"/g, '').trim());\n  const data = [];\n  \n  for (let i = 1; i < lines.length; i++) {\n    if (lines[i].trim() === '') continue;\n    \n    const values = lines[i].split(',');\n    const row: {[key: string]: string} = {};\n    \n    headers.forEach((header, index) => {\n      row[header] = values[index] ? values[index].replace(/\"/g, '').trim() : '';\n    });\n    \n    data.push(row);\n  }\n  \n  return data;\n};\n\nexport const migrateSharePointTasks = async (csvText: string) => {\n  const oldTasks = parseCSV(csvText);\n  const newTasks: any[] = [];\n  const migrationReport = {\n    successful: 0,\n    failed: 0,\n    warnings: [] as string[],\n    errors: [] as {task: string, error: string}[],\n    rolesMapped: new Set<string>(),\n    categoriesUsed: new Set<string>()\n  };\n  \n  // Transform each task\n  oldTasks.forEach((oldTask, index) => {\n    try {\n      // Skip disabled tasks\n      if (oldTask['Week Day'] && oldTask['Week Day'].toLowerCase().includes('disabled')) {\n        return;\n      }\n      \n      // Parse frequency from Week Day field\n      const frequencyData = parseFrequencyFromWeekDay(oldTask['Week Day']);\n      \n      const newTask = {\n        title: oldTask.Title || 'Untitled Task',\n        description: oldTask.Description || oldTask.QuickInfo || '',\n        priority: mapPriority(oldTask.Priority),\n        \n        // Frequency from Week Day field\n        frequency: frequencyData.frequency,\n        \n        // Category - determine from title/description\n        category: determineCategory(oldTask.Title, oldTask.Description),\n        \n        // Add location field - default to 'K' (Kenosha) for imported SharePoint tasks\n        location: 'K',\n        \n        // Map to ROLE not user\n        assignedRole: mapToRole(oldTask['Assigned To'], oldTask.Title),\n        \n        // Leave blank per instructions\n        estimatedTime: null,\n        requiresPhotoProof: false,\n        \n        // Process link becomes part of description\n        processLink: oldTask.ProcessLink,\n        \n        // Microgreen specific data\n        microgreensData: oldTask['Microgreen Weight'] ? {\n          weight: oldTask['Microgreen Weight'],\n          seedAmount: oldTask.QuickInfo\n        } : null,\n        \n        // Status\n        isActive: true,\n        \n        // Metadata for tracking\n        oldTaskId: oldTask['Task ID'],\n        oldUniqueId: oldTask.UniqueID,\n        migratedFrom: 'SharePoint',\n        migrationDate: new Date().toISOString(),\n        instances: oldTask.Instances\n      };\n      \n      // Add frequency-specific fields\n      if (frequencyData.frequency === 'weekly' && (frequencyData as any).daysOfWeek) {\n        (newTask as any).daysOfWeek = (frequencyData as any).daysOfWeek;\n      } else if (frequencyData.frequency === 'monthly' && (frequencyData as any).dayOfMonth) {\n        (newTask as any).dayOfMonth = (frequencyData as any).dayOfMonth;\n      } else if (frequencyData.frequency === 'biweekly' && (frequencyData as any).weekPeriod) {\n        (newTask as any).weekPeriod = (frequencyData as any).weekPeriod;\n      }\n      \n      // Track what we're mapping\n      if (newTask.assignedRole) {\n        migrationReport.rolesMapped.add(newTask.assignedRole);\n      }\n      migrationReport.categoriesUsed.add(newTask.category);\n      \n      // Add checklist warning if needed\n      if (oldTask['Has A SP Checklist Been Created'] === 'True') {\n        (newTask as any).hasSharePointChecklist = true;\n        migrationReport.warnings.push(\n          `\"${oldTask.Title}\" has SharePoint checklist - needs manual checklist creation`\n        );\n      }\n      \n      newTasks.push(newTask);\n      migrationReport.successful++;\n      \n    } catch (error: any) {\n      migrationReport.errors.push({\n        task: oldTask.Title || `Row ${index + 1}`,\n        error: error.message\n      });\n      migrationReport.failed++;\n    }\n  });\n  \n  return { newTasks, migrationReport };\n};\n\nexport const importRecurringTasks = async (tasks: any[]) => {\n  const results = [];\n  for (const task of tasks) {\n    try {\n      const result = await apiRequest('POST', '/api/recurring-tasks', task);\n      results.push(result);\n    } catch (error: any) {\n      console.error('Failed to import task:', task.title, error);\n      throw error;\n    }\n  }\n  return results;\n};","path":null,"size_bytes":9027,"size_tokens":null},"client/src/components/CourseCard.tsx":{"content":"import React from \"react\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { CheckCircle, Clock, Users, Award, Edit3, Trash2, Target } from \"lucide-react\";\n\ninterface Course {\n  id: number;\n  title: string;\n  description: string;\n  roleAwarded: string;\n  sections: number;\n  estimatedTime: string;\n  status: 'not-started' | 'in-progress' | 'completed';\n  progress: number;\n  completedDate?: string;\n  icon: string;\n  requiresApproval?: boolean;\n  prerequisites?: {\n    courses: number[];\n    requirements: {\n      type: 'age' | 'tenure' | 'license' | 'certification';\n      value: number | string;\n      label: string;\n    }[];\n  };\n}\n\ninterface CourseCardProps {\n  course: Course;\n  onStart: (course: Course) => void;\n  onResume: (course: Course) => void;\n  onEdit?: (course: Course) => void;\n  onDelete?: (courseId: number) => void;\n  onAssign?: (course: Course) => void;\n  allCourses?: Course[];\n  isLocked?: boolean;\n  isCorporateManager?: boolean;\n}\n\nconst CourseCard: React.FC<CourseCardProps> = ({ course, onStart, onResume, onEdit, onDelete, onAssign, allCourses = [], isLocked = false, isCorporateManager = false }) => {\n  const checkPrerequisites = () => {\n    if (!course.prerequisites) {\n      return true;\n    }\n    \n    // Check course prerequisites\n    const coursePrereqsMet = course.prerequisites.courses.every(prereqId => {\n      const prereqCourse = allCourses.find(c => c.id === prereqId);\n      return prereqCourse?.status === 'completed';\n    });\n    \n    // Check additional requirements (mock implementation for demo)\n    const requirementsMet = course.prerequisites.requirements.every(req => {\n      switch (req.type) {\n        case 'age':\n          return true; // Mock: assume user meets age requirement\n        case 'tenure':\n          return true; // Mock: assume user has sufficient tenure\n        case 'license':\n        case 'certification':\n          return Math.random() > 0.3; // Mock: simulate some users having certifications\n        default:\n          return true;\n      }\n    });\n    \n    return coursePrereqsMet && requirementsMet;\n  };\n\n  const prerequisitesMet = checkPrerequisites();\n  const courseIsLocked = isLocked || !prerequisitesMet;\n\n  const getStatusColor = () => {\n    if (courseIsLocked) return 'bg-gray-50 border-gray-300';\n    switch (course.status) {\n      case 'completed': return 'bg-green-50 border-green-200';\n      case 'in-progress': return 'bg-yellow-50 border-yellow-200';\n      default: return 'bg-white border-gray-200';\n    }\n  };\n\n  const getStatusBadge = () => {\n    if (courseIsLocked) {\n      return <Badge className=\"bg-gray-100 text-gray-800\">üîí Locked</Badge>;\n    }\n    switch (course.status) {\n      case 'completed': \n        return <Badge className=\"bg-green-100 text-green-800\">Completed</Badge>;\n      case 'in-progress': \n        return <Badge className=\"bg-yellow-100 text-yellow-800\">In Progress</Badge>;\n      default: \n        return <Badge className=\"bg-gray-100 text-gray-800\">Not Started</Badge>;\n    }\n  };\n\n  const getActionButton = () => {\n    if (courseIsLocked) {\n      return (\n        <Button disabled className=\"w-full bg-gray-200 text-gray-500\">\n          üîí Locked\n        </Button>\n      );\n    }\n    \n    switch (course.status) {\n      case 'completed':\n        return (\n          <Button disabled className=\"w-full\">\n            <CheckCircle className=\"h-4 w-4 mr-2\" />\n            Completed\n          </Button>\n        );\n      case 'in-progress':\n        return (\n          <Button onClick={() => onResume(course)} className=\"w-full bg-[#2D8028] hover:bg-[#203B17]\">\n            Resume Course\n          </Button>\n        );\n      default:\n        return (\n          <Button onClick={() => onStart(course)} className=\"w-full bg-[#2D8028] hover:bg-[#203B17]\">\n            Start Course\n          </Button>\n        );\n    }\n  };\n\n  const getPrerequisiteNames = () => {\n    if (!course.prerequisites || course.prerequisites.courses.length === 0) {\n      return [];\n    }\n    return course.prerequisites.courses.map(prereqId => {\n      const prereq = allCourses.find(c => c.id === prereqId);\n      return prereq?.title || 'Unknown Course';\n    });\n  };\n\n  const progressPercentage = course.sections > 0 ? (course.progress / course.sections) * 100 : 0;\n\n  const handleQuickDelete = (e: React.MouseEvent) => {\n    e.stopPropagation();\n    \n    if (onDelete && confirm(`Delete \"${course.title}\"?`)) {\n      onDelete(course.id);\n    }\n  };\n\n  return (\n    <Card className={`h-full transition-all duration-200 hover:shadow-lg ${getStatusColor()} relative`}>\n      <CardHeader className=\"pb-3\">\n        <div className=\"flex items-start justify-between\">\n          <div className=\"text-4xl mb-2\">{course.icon}</div>\n          {isCorporateManager && (onEdit || onDelete) && (\n            <div className=\"flex gap-1\">\n              {onEdit && (\n                <Button\n                  variant=\"ghost\"\n                  size=\"sm\"\n                  onClick={(e) => {\n                    e.stopPropagation();\n                    onEdit(course);\n                  }}\n                  className=\"h-8 w-8 p-0 hover:bg-blue-100 bg-gray-50 border border-gray-200\"\n                  title=\"Edit Course\"\n                >\n                  <Edit3 className=\"h-4 w-4 text-blue-600\" />\n                </Button>\n              )}\n              {onDelete && (\n                <Button\n                  variant=\"ghost\"\n                  size=\"sm\"\n                  onClick={handleQuickDelete}\n                  className=\"h-8 w-8 p-0 hover:bg-red-100 bg-gray-50 border border-gray-200\"\n                  title=\"Delete Course\"\n                >\n                  <Trash2 className=\"h-4 w-4 text-red-600\" />\n                </Button>\n              )}\n            </div>\n          )}\n          <div className=\"flex items-center space-x-2\">\n            {getStatusBadge()}\n          </div>\n        </div>\n        <CardTitle className=\"text-lg text-[#203B17] leading-tight\">\n          {course.title}\n        </CardTitle>\n        {course.requiresApproval && (\n          <Badge variant=\"outline\" className=\"w-fit text-xs\">\n            <Users className=\"h-3 w-3 mr-1\" />\n            Manager Approval Required\n          </Badge>\n        )}\n      </CardHeader>\n      \n      <CardContent className=\"pt-0\">\n        <p className=\"text-gray-600 text-sm mb-4 line-clamp-2\">\n          {course.description}\n        </p>\n        \n        <div className=\"flex items-center gap-4 text-sm text-gray-500 mb-4\">\n          <span className=\"flex items-center\">\n            üìë {course.sections} sections\n          </span>\n          <span className=\"flex items-center\">\n            <Clock className=\"h-4 w-4 mr-1\" />\n            {course.estimatedTime}\n          </span>\n        </div>\n\n        {course.status === 'in-progress' && (\n          <div className=\"mb-4\">\n            <div className=\"flex justify-between text-sm mb-2\">\n              <span>Progress</span>\n              <span>{course.progress}/{course.sections} sections</span>\n            </div>\n            <Progress value={progressPercentage} className=\"h-2\" />\n          </div>\n        )}\n\n        {course.prerequisites && (course.prerequisites.courses.length > 0 || course.prerequisites.requirements.length > 0) && (\n          <div className={`p-3 rounded-lg mb-4 ${prerequisitesMet ? 'bg-green-50' : 'bg-red-50'}`}>\n            <div className=\"flex items-center text-sm mb-2\">\n              <span className=\"font-medium\">\n                {prerequisitesMet ? '‚úÖ All Requirements Met' : 'üîí Requirements:'}\n              </span>\n            </div>\n            {!prerequisitesMet && (\n              <div className=\"space-y-2\">\n                {course.prerequisites.courses.length > 0 && (\n                  <div>\n                    <div className=\"text-xs font-medium text-red-800 mb-1\">Required Courses:</div>\n                    <ul className=\"text-sm text-red-700 space-y-1\">\n                      {getPrerequisiteNames().map((name, idx) => (\n                        <li key={idx} className=\"flex items-center\">\n                          <span className=\"w-2 h-2 bg-red-400 rounded-full mr-2 flex-shrink-0\"></span>\n                          {name}\n                        </li>\n                      ))}\n                    </ul>\n                  </div>\n                )}\n                {course.prerequisites.requirements.length > 0 && (\n                  <div>\n                    <div className=\"text-xs font-medium text-red-800 mb-1\">Additional Requirements:</div>\n                    <ul className=\"text-sm text-red-700 space-y-1\">\n                      {course.prerequisites.requirements.map((req, idx) => (\n                        <li key={idx} className=\"flex items-center\">\n                          <span className=\"w-2 h-2 bg-red-400 rounded-full mr-2 flex-shrink-0\"></span>\n                          {req.label}\n                        </li>\n                      ))}\n                    </ul>\n                  </div>\n                )}\n              </div>\n            )}\n          </div>\n        )}\n\n        {course.roleAwarded && (\n          <div className=\"bg-blue-50 p-3 rounded-lg mb-4\">\n            <div className=\"flex items-center text-sm text-blue-800\">\n              <Award className=\"h-4 w-4 mr-2\" />\n              <span><strong>Awards:</strong> {course.roleAwarded} role</span>\n            </div>\n          </div>\n        )}\n\n        <div className=\"space-y-2\">\n          {getActionButton()}\n          {onAssign && (\n            <Button\n              variant=\"outline\"\n              size=\"sm\"\n              onClick={(e) => {\n                e.stopPropagation();\n                onAssign(course);\n              }}\n              className=\"w-full text-green-600 border-green-200 hover:bg-green-50\"\n            >\n              <Target className=\"h-4 w-4 mr-2\" />\n              Assign Course\n            </Button>\n          )}\n          {course.status === 'completed' && course.completedDate && (\n            <p className=\"text-xs text-gray-500 text-center\">\n              Completed on {new Date(course.completedDate).toLocaleDateString()}\n            </p>\n          )}\n        </div>\n      </CardContent>\n    </Card>\n  );\n};\n\nexport default CourseCard;","path":null,"size_bytes":10390,"size_tokens":null},"client/src/components/checklist/SystemAssignmentStep.tsx":{"content":"import React, { useState, useEffect } from 'react';\nimport { useQuery } from '@tanstack/react-query';\nimport { useLocation } from '../../contexts/LocationContext';\nimport type { GrowingSystem } from '@shared/schema';\n\ninterface SystemAssignmentStepProps {\n  step: {\n    id: string;\n    label: string;\n    type: 'system-assignment';\n    config?: {\n      systemType?: string;\n    };\n  };\n  value?: any;\n  onChange: (value: any) => void;\n  trayId?: string;\n  splitTrays?: Array<{\n    id: string;\n    parentId: string;\n    splitNumber: number;\n    label: string;\n  }>;\n}\n\nconst SystemAssignmentStep: React.FC<SystemAssignmentStepProps> = ({ \n  step, \n  value, \n  onChange, \n  trayId, \n  splitTrays \n}) => {\n  const [assignments, setAssignments] = useState<Record<string, string>>({});\n  const { currentLocation } = useLocation();\n  \n  // Fetch systems data from API\n  const { data: systemsData = [] } = useQuery<GrowingSystem[]>({\n    queryKey: ['/api/growing-systems', currentLocation.code],\n    queryFn: async () => {\n      const response = await fetch(`/api/growing-systems?location=${currentLocation.code}`);\n      if (!response.ok) throw new Error('Failed to fetch systems');\n      return response.json();\n    },\n  });\n\n  // Filter available systems based on step config and availability\n  const availableSystems = systemsData.filter(system => {\n    if (!system.isActive) return false;\n    if (step.config?.systemType && system.type !== step.config.systemType) return false;\n    // Only show systems with available capacity\n    const occupancyRate = system.capacity ? (system.currentOccupancy || 0) / system.capacity : 0;\n    return occupancyRate < 1; // Less than 100% occupied\n  });\n  \n  useEffect(() => {\n    // If we have split trays, initialize assignments for each\n    if (splitTrays && splitTrays.length > 0) {\n      const initialAssignments: Record<string, string> = {};\n      splitTrays.forEach(tray => {\n        initialAssignments[tray.id] = '';\n      });\n      setAssignments(initialAssignments);\n    }\n  }, [splitTrays]);\n  \n  const handleSingleAssignment = (systemId: number) => {\n    onChange({ trayId, systemId });\n  };\n  \n  const handleSplitAssignment = (trayId: string, systemId: number) => {\n    const newAssignments = { ...assignments, [trayId]: systemId.toString() };\n    setAssignments(newAssignments);\n    \n    // Check if all splits are assigned\n    const allAssigned = Object.values(newAssignments).every(id => id !== '');\n    if (allAssigned) {\n      onChange(newAssignments);\n    }\n  };\n\n  const getUtilizationRate = (system: GrowingSystem) => {\n    if (!system.capacity) return 0;\n    return ((system.currentOccupancy || 0) / system.capacity) * 100;\n  };\n\n  const getSystemStatusColor = (utilization: number) => {\n    if (utilization < 50) return 'text-green-600';\n    if (utilization < 80) return 'text-yellow-600';\n    return 'text-red-600';\n  };\n  \n  // If we have split trays from a previous step\n  if (splitTrays && splitTrays.length > 0) {\n    return (\n      <div className=\"system-assignment-step split-assignment\">\n        <h4 className=\"text-lg font-semibold mb-3\">\n          {step.label || 'Assign split trays to growing systems'}\n        </h4>\n        <div className=\"split-assignments space-y-3\">\n          {splitTrays.map((tray) => (\n            <div key={tray.id} className=\"split-assignment-row flex items-center gap-3\">\n              <span className=\"tray-label font-mono text-sm font-medium min-w-36\">\n                {tray.id}:\n              </span>\n              <select\n                value={assignments[tray.id] || ''}\n                onChange={(e) => handleSplitAssignment(tray.id, parseInt(e.target.value))}\n                className=\"system-select flex-1 p-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500\"\n              >\n                <option value=\"\">Select system...</option>\n                {availableSystems.map(system => {\n                  const utilization = getUtilizationRate(system);\n                  const available = (system.capacity || 0) - (system.currentOccupancy || 0);\n                  return (\n                    <option key={system.id} value={system.id}>\n                      {system.name} ({available} spots available - {utilization.toFixed(0)}% used)\n                    </option>\n                  );\n                })}\n              </select>\n            </div>\n          ))}\n        </div>\n        \n        {/* Assignment Summary */}\n        {Object.keys(assignments).length > 0 && (\n          <div className=\"mt-4 p-3 bg-blue-50 rounded-md\">\n            <p className=\"text-sm text-blue-800\">\n              Assignments: {Object.values(assignments).filter(v => v).length} of {splitTrays.length} complete\n            </p>\n          </div>\n        )}\n      </div>\n    );\n  }\n  \n  // Single tray assignment\n  return (\n    <div className=\"system-assignment-step\">\n      <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n        {step.label || 'Select growing system'}\n      </label>\n      <select\n        value={value?.systemId || ''}\n        onChange={(e) => handleSingleAssignment(parseInt(e.target.value))}\n        className=\"system-select w-full p-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500\"\n      >\n        <option value=\"\">Select system...</option>\n        {availableSystems.map(system => {\n          const utilization = getUtilizationRate(system);\n          const available = (system.capacity || 0) - (system.currentOccupancy || 0);\n          const statusColor = getSystemStatusColor(utilization);\n          return (\n            <option key={system.id} value={system.id}>\n              {system.name} - {available} spots available ({utilization.toFixed(0)}% used)\n            </option>\n          );\n        })}\n      </select>\n      \n      {/* System Type Filter Info */}\n      {step.config?.systemType && (\n        <p className=\"text-xs text-gray-500 mt-1\">\n          Showing only {step.config.systemType} systems\n        </p>\n      )}\n      \n      {/* Selection Summary */}\n      {value?.systemId && (\n        <div className=\"mt-2 p-2 bg-green-50 rounded-md\">\n          <p className=\"text-sm text-green-800\">\n            Selected: {availableSystems.find(s => s.id === value.systemId)?.name}\n          </p>\n        </div>\n      )}\n    </div>\n  );\n};\n\nexport default SystemAssignmentStep;","path":null,"size_bytes":6390,"size_tokens":null},"client/src/pages/not-found.tsx":{"content":"import { Card, CardContent } from \"@/components/ui/card\";\nimport { AlertCircle } from \"lucide-react\";\n\nexport default function NotFound() {\n  return (\n    <div className=\"min-h-screen w-full flex items-center justify-center bg-gray-50\">\n      <Card className=\"w-full max-w-md mx-4\">\n        <CardContent className=\"pt-6\">\n          <div className=\"flex mb-4 gap-2\">\n            <AlertCircle className=\"h-8 w-8 text-red-500\" />\n            <h1 className=\"text-2xl font-bold text-gray-900\">404 Page Not Found</h1>\n          </div>\n\n          <p className=\"mt-4 text-sm text-gray-600\">\n            Did you forget to add the page to the router?\n          </p>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":711,"size_tokens":null},"client/src/components/ui/alert.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst alertVariants = cva(\n  \"relative w-full rounded-lg border p-4 [&>svg~*]:pl-7 [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-background text-foreground\",\n        destructive:\n          \"border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nconst Alert = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement> & VariantProps<typeof alertVariants>\n>(({ className, variant, ...props }, ref) => (\n  <div\n    ref={ref}\n    role=\"alert\"\n    className={cn(alertVariants({ variant }), className)}\n    {...props}\n  />\n))\nAlert.displayName = \"Alert\"\n\nconst AlertTitle = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLHeadingElement>\n>(({ className, ...props }, ref) => (\n  <h5\n    ref={ref}\n    className={cn(\"mb-1 font-medium leading-none tracking-tight\", className)}\n    {...props}\n  />\n))\nAlertTitle.displayName = \"AlertTitle\"\n\nconst AlertDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm [&_p]:leading-relaxed\", className)}\n    {...props}\n  />\n))\nAlertDescription.displayName = \"AlertDescription\"\n\nexport { Alert, AlertTitle, AlertDescription }\n","path":null,"size_bytes":1584,"size_tokens":null},"client/src/components/ProductionDashboard.tsx":{"content":"import React, { useState, useMemo } from 'react';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Badge } from '@/components/ui/badge';\nimport { Button } from '@/components/ui/button';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { \n  LineChart, Line, AreaChart, Area, BarChart, Bar, PieChart, Pie, Cell,\n  XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer \n} from 'recharts';\nimport { \n  TrendingUp, Sprout, Package, BarChart3, AlertTriangle, \n  Lightbulb, Calendar, Target, Zap \n} from 'lucide-react';\nimport { useLocation } from '@/contexts/LocationContext';\n\nexport const ProductionDashboard: React.FC = () => {\n  const { currentLocation, isViewingAllLocations } = useLocation();\n  const [dateRange, setDateRange] = useState('30d');\n  const [selectedCrop, setSelectedCrop] = useState('all');\n  \n  // Production metrics\n  const productionMetrics = useMemo(() => ({\n    totalTraysActive: 342,\n    totalPlantsGrowing: 15648,\n    harvestReadyToday: 28,\n    projectedHarvestThisWeek: 156,\n    avgYieldPerTray: 2.3, // lbs\n    yieldEfficiency: 94.2 // % of expected yield\n  }), []);\n  \n  // Production trend data\n  const productionTrend = useMemo(() => [\n    { date: '3/1', planted: 45, harvested: 42, yield: 96.6 },\n    { date: '3/8', planted: 52, harvested: 48, yield: 115.2 },\n    { date: '3/15', planted: 48, harvested: 46, yield: 105.8 },\n    { date: '3/22', planted: 55, harvested: 51, yield: 122.4 },\n    { date: '3/29', planted: 50, harvested: 47, yield: 108.1 },\n  ], []);\n  \n  // Crop distribution\n  const cropDistribution = useMemo(() => [\n    { name: 'Romaine Lettuce', value: 35, trays: 120, color: '#10b981' },\n    { name: 'Arugula', value: 25, trays: 86, color: '#3b82f6' },\n    { name: 'Broccoli Microgreens', value: 20, trays: 68, color: '#f59e0b' },\n    { name: 'Basil', value: 15, trays: 51, color: '#8b5cf6' },\n    { name: 'Other', value: 5, trays: 17, color: '#6b7280' }\n  ], []);\n  \n  // Yield vs Expected\n  const yieldComparison = useMemo(() => [\n    { crop: 'Romaine', expected: 2.5, actual: 2.4, efficiency: 96 },\n    { crop: 'Arugula', expected: 1.8, actual: 1.9, efficiency: 105 },\n    { crop: 'Broccoli MG', expected: 0.75, actual: 0.72, efficiency: 96 },\n    { crop: 'Basil', expected: 1.2, actual: 1.1, efficiency: 92 },\n  ], []);\n  \n  // Waste metrics\n  const wasteData = useMemo(() => [\n    { week: 'W1', planted: 180, harvested: 172, wasted: 8, wasteRate: 4.4 },\n    { week: 'W2', planted: 195, harvested: 188, wasted: 7, wasteRate: 3.6 },\n    { week: 'W3', planted: 175, harvested: 165, wasted: 10, wasteRate: 5.7 },\n    { week: 'W4', planted: 190, harvested: 183, wasted: 7, wasteRate: 3.7 },\n  ], []);\n  \n  // Growth stage distribution\n  const growthStages = useMemo(() => [\n    { stage: 'Seeded', count: 45, percentage: 13, color: '#fbbf24' },\n    { stage: 'Germinating', count: 62, percentage: 18, color: '#a3e635' },\n    { stage: 'Growing', count: 185, percentage: 54, color: '#22c55e' },\n    { stage: 'Ready', count: 50, percentage: 15, color: '#3b82f6' }\n  ], []);\n\n  const upcomingHarvests = useMemo(() => [\n    { date: 'Today', crop: 'Romaine', trays: 12, yield: '30 lbs' },\n    { date: 'Tomorrow', crop: 'Arugula', trays: 8, yield: '14.4 lbs' },\n    { date: 'Mar 3', crop: 'Broccoli MG', trays: 15, yield: '11.25 lbs' },\n    { date: 'Mar 4', crop: 'Basil', trays: 6, yield: '7.2 lbs' },\n  ], []);\n\n  const insights = useMemo(() => [\n    {\n      icon: TrendingUp,\n      title: 'Yield Trending Up',\n      description: 'Arugula yields are 5% above expected for the past 2 weeks',\n      type: 'positive'\n    },\n    {\n      icon: AlertTriangle,\n      title: 'Basil Underperforming',\n      description: 'Basil yields are 8% below target. Check pH levels in towers B3-B6',\n      type: 'warning'\n    },\n    {\n      icon: Lightbulb,\n      title: 'Optimize Planting',\n      description: 'Increasing microgreens by 10% could improve weekly revenue by $180',\n      type: 'info'\n    },\n    {\n      icon: Target,\n      title: 'Waste Reduction',\n      description: 'Friday harvests show 2x higher waste. Consider Thursday harvest for lettuce',\n      type: 'info'\n    }\n  ], []);\n  \n  return (\n    <div className=\"space-y-6\">\n      {/* Header and Controls */}\n      <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between\">\n        <div>\n          <h2 className=\"text-xl font-bold text-[#203B17] mb-2\">Production Dashboard</h2>\n          <p className=\"text-gray-600\">Real-time production metrics and analytics</p>\n        </div>\n        <div className=\"flex gap-2 mt-4 sm:mt-0\">\n          <div className=\"flex gap-1\">\n            <Button \n              variant={dateRange === '7d' ? 'default' : 'outline'}\n              size=\"sm\"\n              onClick={() => setDateRange('7d')}\n            >\n              7 days\n            </Button>\n            <Button \n              variant={dateRange === '30d' ? 'default' : 'outline'}\n              size=\"sm\"\n              onClick={() => setDateRange('30d')}\n            >\n              30 days\n            </Button>\n            <Button \n              variant={dateRange === '90d' ? 'default' : 'outline'}\n              size=\"sm\"\n              onClick={() => setDateRange('90d')}\n            >\n              90 days\n            </Button>\n          </div>\n          <Select value={selectedCrop} onValueChange={setSelectedCrop}>\n            <SelectTrigger className=\"w-40\">\n              <SelectValue />\n            </SelectTrigger>\n            <SelectContent>\n              <SelectItem value=\"all\">All Crops</SelectItem>\n              <SelectItem value=\"romaine\">Romaine Lettuce</SelectItem>\n              <SelectItem value=\"arugula\">Arugula</SelectItem>\n              <SelectItem value=\"microgreens\">All Microgreens</SelectItem>\n              <SelectItem value=\"herbs\">All Herbs</SelectItem>\n            </SelectContent>\n          </Select>\n        </div>\n      </div>\n\n      {/* Key Metrics */}\n      <div className=\"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6\">\n        <Card className=\"p-6\">\n          <div className=\"flex items-center justify-between\">\n            <div>\n              <p className=\"text-sm font-medium text-gray-600\">Active Trays</p>\n              <p className=\"text-2xl font-bold text-gray-900\">{productionMetrics.totalTraysActive}</p>\n              <p className=\"text-sm text-gray-500 mt-1\">Growing across all systems</p>\n            </div>\n            <div className=\"p-3 bg-green-50 rounded-full\">\n              <Sprout className=\"w-6 h-6 text-green-600\" />\n            </div>\n          </div>\n        </Card>\n\n        <Card className=\"p-6\">\n          <div className=\"flex items-center justify-between\">\n            <div>\n              <p className=\"text-sm font-medium text-gray-600\">Plants Growing</p>\n              <p className=\"text-2xl font-bold text-gray-900\">{productionMetrics.totalPlantsGrowing.toLocaleString()}</p>\n              <p className=\"text-sm text-gray-500 mt-1\">Individual plants</p>\n            </div>\n            <div className=\"p-3 bg-blue-50 rounded-full\">\n              <Package className=\"w-6 h-6 text-blue-600\" />\n            </div>\n          </div>\n        </Card>\n\n        <Card className=\"p-6 border-orange-200 bg-orange-50\">\n          <div className=\"flex items-center justify-between\">\n            <div>\n              <p className=\"text-sm font-medium text-gray-600\">Ready Today</p>\n              <p className=\"text-2xl font-bold text-orange-700\">{productionMetrics.harvestReadyToday}</p>\n              <p className=\"text-sm text-gray-600 mt-1\">Trays ready for harvest</p>\n            </div>\n            <div className=\"p-3 bg-orange-100 rounded-full\">\n              <Calendar className=\"w-6 h-6 text-orange-600\" />\n            </div>\n          </div>\n        </Card>\n\n        <Card className=\"p-6\">\n          <div className=\"flex items-center justify-between\">\n            <div>\n              <p className=\"text-sm font-medium text-gray-600\">Yield Efficiency</p>\n              <p className=\"text-2xl font-bold text-gray-900\">{productionMetrics.yieldEfficiency}%</p>\n              <p className=\"text-sm text-green-600 mt-1\">+2.1% vs target</p>\n            </div>\n            <div className=\"p-3 bg-purple-50 rounded-full\">\n              <BarChart3 className=\"w-6 h-6 text-purple-600\" />\n            </div>\n          </div>\n        </Card>\n      </div>\n\n      {/* Charts Grid */}\n      <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n        {/* Production Trend */}\n        <Card className=\"lg:col-span-2 p-6\">\n          <CardHeader>\n            <CardTitle>Production Trend</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <ResponsiveContainer width=\"100%\" height={300}>\n              <AreaChart data={productionTrend}>\n                <CartesianGrid strokeDasharray=\"3 3\" />\n                <XAxis dataKey=\"date\" />\n                <YAxis />\n                <Tooltip />\n                <Legend />\n                <Area \n                  type=\"monotone\" \n                  dataKey=\"planted\" \n                  stackId=\"1\" \n                  stroke=\"#3b82f6\" \n                  fill=\"#3b82f6\" \n                  fillOpacity={0.6} \n                  name=\"Planted\" \n                />\n                <Area \n                  type=\"monotone\" \n                  dataKey=\"harvested\" \n                  stackId=\"2\" \n                  stroke=\"#10b981\" \n                  fill=\"#10b981\" \n                  fillOpacity={0.6} \n                  name=\"Harvested\" \n                />\n              </AreaChart>\n            </ResponsiveContainer>\n          </CardContent>\n        </Card>\n        \n        {/* Crop Distribution */}\n        <Card className=\"p-6\">\n          <CardHeader>\n            <CardTitle>Current Crop Distribution</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <ResponsiveContainer width=\"100%\" height={250}>\n              <PieChart>\n                <Pie\n                  data={cropDistribution}\n                  cx=\"50%\"\n                  cy=\"50%\"\n                  labelLine={false}\n                  label={({ name, value }) => `${name}: ${value}%`}\n                  outerRadius={80}\n                  fill=\"#8884d8\"\n                  dataKey=\"value\"\n                >\n                  {cropDistribution.map((entry, index) => (\n                    <Cell key={`cell-${index}`} fill={entry.color} />\n                  ))}\n                </Pie>\n                <Tooltip formatter={(value, name, props) => [`${props.payload.trays} trays`, name]} />\n              </PieChart>\n            </ResponsiveContainer>\n            <div className=\"mt-4 space-y-2\">\n              {cropDistribution.map((crop, index) => (\n                <div key={index} className=\"flex items-center justify-between text-sm\">\n                  <div className=\"flex items-center gap-2\">\n                    <span \n                      className=\"w-3 h-3 rounded-full\" \n                      style={{ backgroundColor: crop.color }} \n                    />\n                    <span>{crop.name}</span>\n                  </div>\n                  <span className=\"font-medium\">{crop.trays} trays</span>\n                </div>\n              ))}\n            </div>\n          </CardContent>\n        </Card>\n        \n        {/* Yield Comparison */}\n        <Card className=\"p-6\">\n          <CardHeader>\n            <CardTitle>Yield vs Expected (lbs/tray)</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <ResponsiveContainer width=\"100%\" height={250}>\n              <BarChart data={yieldComparison}>\n                <CartesianGrid strokeDasharray=\"3 3\" />\n                <XAxis dataKey=\"crop\" />\n                <YAxis />\n                <Tooltip />\n                <Legend />\n                <Bar dataKey=\"expected\" fill=\"#e5e7eb\" name=\"Expected\" />\n                <Bar dataKey=\"actual\" fill=\"#10b981\" name=\"Actual\" />\n              </BarChart>\n            </ResponsiveContainer>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Additional Charts */}\n      <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n        {/* Waste Analysis */}\n        <Card className=\"p-6\">\n          <CardHeader>\n            <CardTitle>Waste Analysis</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <ResponsiveContainer width=\"100%\" height={250}>\n              <LineChart data={wasteData}>\n                <CartesianGrid strokeDasharray=\"3 3\" />\n                <XAxis dataKey=\"week\" />\n                <YAxis />\n                <Tooltip />\n                <Legend />\n                <Bar dataKey=\"wasted\" fill=\"#ef4444\" name=\"Trays Wasted\" />\n                <Line type=\"monotone\" dataKey=\"wasteRate\" stroke=\"#dc2626\" name=\"Waste Rate %\" strokeWidth={2} />\n              </LineChart>\n            </ResponsiveContainer>\n            <div className=\"mt-4 space-y-2\">\n              <p className=\"text-sm text-gray-600\">\n                Average waste rate: <span className=\"font-medium text-gray-900\">4.4%</span>\n              </p>\n              <p className=\"text-sm text-gray-600\">\n                Total value lost: <span className=\"font-medium text-red-600\">$342</span> this month\n              </p>\n            </div>\n          </CardContent>\n        </Card>\n        \n        {/* Growth Stage Distribution */}\n        <Card className=\"p-6\">\n          <CardHeader>\n            <CardTitle>Growth Stage Distribution</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"space-y-4\">\n              {growthStages.map((stage, index) => (\n                <div key={index} className=\"space-y-2\">\n                  <div className=\"flex justify-between items-center\">\n                    <div className=\"flex items-center gap-2\">\n                      <span className=\"font-medium\">{stage.stage}</span>\n                      <span className=\"text-sm text-gray-600\">{stage.count} trays</span>\n                    </div>\n                    <span className=\"text-sm font-medium\">{stage.percentage}%</span>\n                  </div>\n                  <div className=\"w-full bg-gray-200 rounded-full h-2\">\n                    <div \n                      className=\"h-2 rounded-full transition-all duration-300\"\n                      style={{ \n                        width: `${stage.percentage}%`, \n                        backgroundColor: stage.color \n                      }}\n                    />\n                  </div>\n                </div>\n              ))}\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Harvest Schedule */}\n      <Card className=\"p-6\">\n        <CardHeader>\n          <CardTitle>Upcoming Harvests (Next 7 Days)</CardTitle>\n        </CardHeader>\n        <CardContent>\n          <div className=\"overflow-x-auto\">\n            <table className=\"w-full\">\n              <thead>\n                <tr className=\"border-b\">\n                  <th className=\"text-left py-2 px-4 font-medium\">Date</th>\n                  <th className=\"text-left py-2 px-4 font-medium\">Crop</th>\n                  <th className=\"text-left py-2 px-4 font-medium\">Trays</th>\n                  <th className=\"text-left py-2 px-4 font-medium\">Est. Yield</th>\n                </tr>\n              </thead>\n              <tbody>\n                {upcomingHarvests.map((harvest, index) => (\n                  <tr key={index} className=\"border-b hover:bg-gray-50\">\n                    <td className=\"py-2 px-4\">{harvest.date}</td>\n                    <td className=\"py-2 px-4\">{harvest.crop}</td>\n                    <td className=\"py-2 px-4\">{harvest.trays}</td>\n                    <td className=\"py-2 px-4 font-medium\">{harvest.yield}</td>\n                  </tr>\n                ))}\n              </tbody>\n            </table>\n          </div>\n        </CardContent>\n      </Card>\n      \n      {/* Production Insights */}\n      <Card className=\"p-6\">\n        <CardHeader>\n          <CardTitle>Production Insights</CardTitle>\n        </CardHeader>\n        <CardContent>\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n            {insights.map((insight, index) => {\n              const Icon = insight.icon;\n              const colorClasses = {\n                positive: 'bg-green-50 border-green-200',\n                warning: 'bg-yellow-50 border-yellow-200',\n                info: 'bg-blue-50 border-blue-200'\n              };\n              \n              return (\n                <div key={index} className={`p-4 rounded-lg border ${colorClasses[insight.type as keyof typeof colorClasses]}`}>\n                  <div className=\"flex items-start gap-3\">\n                    <Icon className=\"w-5 h-5 mt-0.5 text-gray-600\" />\n                    <div>\n                      <h4 className=\"font-medium text-gray-900 mb-1\">{insight.title}</h4>\n                      <p className=\"text-sm text-gray-600\">{insight.description}</p>\n                    </div>\n                  </div>\n                </div>\n              );\n            })}\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n};","path":null,"size_bytes":17131,"size_tokens":null},"client/src/data/growingSystems.ts":{"content":"// Growing Systems Configuration and Management\nexport interface GrowingSystem {\n  id: string;\n  name: string;\n  type: 'tower' | 'nft' | 'ebb-flow' | 'staging';\n  capacity: number;\n  currentLoad: number;\n  location?: string;\n}\n\nexport interface TrayAssignment {\n  systemId: string;\n  assignedAt: string;\n  assignedBy: number;\n}\n\nexport const defaultGrowingSystems: GrowingSystem[] = [\n  // Towers\n  { id: 'tower-1', name: 'Tower 1', type: 'tower', capacity: 50, currentLoad: 0 },\n  { id: 'tower-2', name: 'Tower 2', type: 'tower', capacity: 50, currentLoad: 0 },\n  { id: 'tower-3', name: 'Tower 3', type: 'tower', capacity: 50, currentLoad: 0 },\n  \n  // NFT Channels\n  { id: 'nft-1', name: 'NFT Channel 1', type: 'nft', capacity: 20, currentLoad: 0 },\n  { id: 'nft-2', name: 'NFT Channel 2', type: 'nft', capacity: 20, currentLoad: 0 },\n  { id: 'nft-3', name: 'NFT Channel 3', type: 'nft', capacity: 20, currentLoad: 0 },\n  { id: 'nft-4', name: 'NFT Channel 4', type: 'nft', capacity: 20, currentLoad: 0 },\n  { id: 'nft-5', name: 'NFT Channel 5', type: 'nft', capacity: 20, currentLoad: 0 },\n  \n  // Ebb & Flow\n  { id: 'ebb-flow-1', name: 'Ebb & Flow Section 1', type: 'ebb-flow', capacity: 100, currentLoad: 0 },\n  { id: 'ebb-flow-2', name: 'Ebb & Flow Section 2', type: 'ebb-flow', capacity: 100, currentLoad: 0 },\n  \n  // Staging Areas\n  { id: 'nursery', name: 'Nursery', type: 'staging', capacity: 200, currentLoad: 0 },\n  { id: 'blackout', name: 'Blackout Room', type: 'staging', capacity: 150, currentLoad: 0 }\n];\n\n// Helper functions\nexport const getAvailableSystems = (type?: string): GrowingSystem[] => {\n  const systems = JSON.parse(localStorage.getItem('growingSystems') || '[]');\n  const allSystems = systems.length > 0 ? systems : defaultGrowingSystems;\n  \n  if (type) {\n    return allSystems.filter((s: GrowingSystem) => s.type === type && s.currentLoad < s.capacity);\n  }\n  \n  return allSystems.filter((s: GrowingSystem) => s.currentLoad < s.capacity);\n};\n\nexport const getAllSystems = (): GrowingSystem[] => {\n  const systems = JSON.parse(localStorage.getItem('growingSystems') || '[]');\n  return systems.length > 0 ? systems : defaultGrowingSystems;\n};\n\nexport const assignTrayToSystem = (trayId: string, systemId: string, userId: number = 1): boolean => {\n  const systems = getAllSystems();\n  const system = systems.find((s: GrowingSystem) => s.id === systemId);\n  \n  if (system && system.currentLoad < system.capacity) {\n    system.currentLoad += 1;\n    localStorage.setItem('growingSystems', JSON.stringify(systems));\n    \n    // Record the assignment\n    const assignments = JSON.parse(localStorage.getItem('trayAssignments') || '{}');\n    assignments[trayId] = {\n      systemId,\n      assignedAt: new Date().toISOString(),\n      assignedBy: userId\n    };\n    localStorage.setItem('trayAssignments', JSON.stringify(assignments));\n    \n    return true;\n  }\n  \n  return false;\n};\n\nexport const getTrayAssignments = (): Record<string, TrayAssignment> => {\n  return JSON.parse(localStorage.getItem('trayAssignments') || '{}');\n};\n\nexport const removeTrayFromSystem = (trayId: string): boolean => {\n  const assignments = getTrayAssignments();\n  const assignment = assignments[trayId];\n  \n  if (assignment) {\n    const systems = getAllSystems();\n    const system = systems.find((s: GrowingSystem) => s.id === assignment.systemId);\n    \n    if (system && system.currentLoad > 0) {\n      system.currentLoad -= 1;\n      localStorage.setItem('growingSystems', JSON.stringify(systems));\n    }\n    \n    delete assignments[trayId];\n    localStorage.setItem('trayAssignments', JSON.stringify(assignments));\n    \n    return true;\n  }\n  \n  return false;\n};","path":null,"size_bytes":3661,"size_tokens":null},"client/src/pages/ProductionData.tsx":{"content":"import React, { useState, useMemo, useEffect, useRef } from \"react\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Download, AlertTriangle, Sprout, Calendar, TrendingUp, Plus, Edit2, Trash2, ChevronLeft, ChevronRight } from \"lucide-react\";\nimport { getStoredAuth } from \"@/lib/auth\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { TrayService, ProductionTray } from \"@/services/trayService\";\nimport SystemConfiguration from \"@/components/SystemConfiguration\";\nimport { EquipmentManagement } from \"@/components/EquipmentManagement\";\nimport TrayTracking from \"@/pages/TrayTracking\";\n\ninterface Crop {\n  id: number;\n  name: string;\n  category: string;\n  expectedYieldPerTray: number;\n  averageGrowthTime: number;\n  lightRequirements: string;\n  status: string;\n  checklistTemplate: any;\n}\n\ninterface Tray {\n  id: string;\n  cropType: string;\n  cropId?: number;\n  datePlanted: string;\n  assignedSystem: string;\n  estimatedHarvestDate: string;\n  status: string;\n  actualYield?: number;\n  notes?: string;\n}\n\n// Mock data for initial implementation\nconst mockCrops: Crop[] = [\n  {\n    id: 1,\n    name: 'Romaine Lettuce',\n    category: 'Leafy Green',\n    expectedYieldPerTray: 2.5,\n    averageGrowthTime: 35,\n    lightRequirements: 'Medium (14-16 hours)',\n    status: 'active',\n    checklistTemplate: null\n  },\n  {\n    id: 2,\n    name: 'Broccoli Microgreens',\n    category: 'Microgreen',\n    expectedYieldPerTray: 0.75,\n    averageGrowthTime: 7,\n    lightRequirements: 'Low (8-10 hours)',\n    status: 'active',\n    checklistTemplate: null\n  },\n  {\n    id: 3,\n    name: 'Arugula',\n    category: 'Leafy Green',\n    expectedYieldPerTray: 1.8,\n    averageGrowthTime: 28,\n    lightRequirements: 'Medium (12-14 hours)',\n    status: 'active',\n    checklistTemplate: null\n  },\n  {\n    id: 4,\n    name: 'Basil',\n    category: 'Herb',\n    expectedYieldPerTray: 1.2,\n    averageGrowthTime: 42,\n    lightRequirements: 'High (16-18 hours)',\n    status: 'active',\n    checklistTemplate: null\n  }\n];\n\nconst mockTrays: Tray[] = [\n  {\n    id: 'K071725-MG-BROC-1C',\n    cropType: 'Broccoli Microgreens',\n    cropId: 2,\n    datePlanted: '2024-03-10',\n    assignedSystem: 'Tower 3 - Level A',\n    estimatedHarvestDate: '2024-03-17',\n    status: 'growing',\n    actualYield: null,\n    notes: ''\n  },\n  {\n    id: 'K071725-LG-ROM-2A',\n    cropType: 'Romaine Lettuce',\n    cropId: 1,\n    datePlanted: '2024-02-15',\n    assignedSystem: 'NFT System 1',\n    estimatedHarvestDate: '2024-03-22',\n    status: 'growing',\n    actualYield: null,\n    notes: 'Looking healthy'\n  },\n  {\n    id: 'K071725-LG-ARU-3B',\n    cropType: 'Arugula',\n    cropId: 3,\n    datePlanted: '2024-03-01',\n    assignedSystem: 'Tower 2 - Level B',\n    estimatedHarvestDate: '2024-03-29',\n    status: 'growing',\n    actualYield: null,\n    notes: ''\n  },\n  {\n    id: 'K071725-MG-BROC-2C',\n    cropType: 'Broccoli Microgreens',\n    cropId: 2,\n    datePlanted: '2024-03-08',\n    assignedSystem: 'Tower 3 - Level B',\n    estimatedHarvestDate: '2024-03-15',\n    status: 'ready-to-harvest',\n    actualYield: null,\n    notes: 'Ready for harvest'\n  },\n  {\n    id: 'K071725-LG-ROM-1A',\n    cropType: 'Romaine Lettuce',\n    cropId: 1,\n    datePlanted: '2024-02-10',\n    assignedSystem: 'NFT System 2',\n    estimatedHarvestDate: '2024-03-17',\n    status: 'harvested',\n    actualYield: 2.3,\n    harvestDate: '2024-03-16',\n    notes: 'Good yield'\n  }\n];\n\nconst CropModal: React.FC<{\n  crop: Crop | null;\n  isOpen: boolean;\n  onClose: () => void;\n  onSave: (crop: Crop) => void;\n}> = ({ crop, isOpen, onClose, onSave }) => {\n  const [formData, setFormData] = useState<Partial<Crop>>({\n    name: crop?.name || '',\n    category: crop?.category || 'Leafy Green',\n    expectedYieldPerTray: crop?.expectedYieldPerTray || 0,\n    averageGrowthTime: crop?.averageGrowthTime || 0,\n    lightRequirements: crop?.lightRequirements || 'Medium (12-14 hours)',\n    status: crop?.status || 'active'\n  });\n\n  const handleSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    onSave({\n      id: crop?.id || Date.now(),\n      ...formData\n    } as Crop);\n    onClose();\n  };\n\n  return (\n    <Dialog open={isOpen} onOpenChange={onClose}>\n      <DialogContent>\n        <DialogHeader>\n          <DialogTitle>{crop ? 'Edit Crop' : 'Add New Crop'}</DialogTitle>\n        </DialogHeader>\n        <form onSubmit={handleSubmit} className=\"space-y-4\">\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"name\">Crop Name</Label>\n            <Input\n              id=\"name\"\n              value={formData.name}\n              onChange={(e) => setFormData({ ...formData, name: e.target.value })}\n              required\n            />\n          </div>\n          \n          <div className=\"space-y-2\">\n            <Label htmlFor=\"category\">Category</Label>\n            <Select value={formData.category} onValueChange={(value) => setFormData({ ...formData, category: value })}>\n              <SelectTrigger>\n                <SelectValue placeholder=\"Select category\" />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"Leafy Green\">Leafy Green</SelectItem>\n                <SelectItem value=\"Microgreen\">Microgreen</SelectItem>\n                <SelectItem value=\"Herb\">Herb</SelectItem>\n                <SelectItem value=\"Vegetable\">Vegetable</SelectItem>\n              </SelectContent>\n            </Select>\n          </div>\n          \n          <div className=\"space-y-2\">\n            <Label htmlFor=\"yield\">Expected Yield Per Tray (lbs)</Label>\n            <Input\n              id=\"yield\"\n              type=\"number\"\n              step=\"0.1\"\n              value={formData.expectedYieldPerTray}\n              onChange={(e) => setFormData({ ...formData, expectedYieldPerTray: parseFloat(e.target.value) })}\n              required\n            />\n          </div>\n          \n          <div className=\"space-y-2\">\n            <Label htmlFor=\"growthTime\">Average Growth Time (days)</Label>\n            <Input\n              id=\"growthTime\"\n              type=\"number\"\n              value={formData.averageGrowthTime}\n              onChange={(e) => setFormData({ ...formData, averageGrowthTime: parseInt(e.target.value) })}\n              required\n            />\n          </div>\n          \n          <div className=\"space-y-2\">\n            <Label htmlFor=\"lightRequirements\">Light Requirements</Label>\n            <Select value={formData.lightRequirements} onValueChange={(value) => setFormData({ ...formData, lightRequirements: value })}>\n              <SelectTrigger>\n                <SelectValue placeholder=\"Select light requirements\" />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"Low (8-10 hours)\">Low (8-10 hours)</SelectItem>\n                <SelectItem value=\"Medium (12-14 hours)\">Medium (12-14 hours)</SelectItem>\n                <SelectItem value=\"Medium (14-16 hours)\">Medium (14-16 hours)</SelectItem>\n                <SelectItem value=\"High (16-18 hours)\">High (16-18 hours)</SelectItem>\n              </SelectContent>\n            </Select>\n          </div>\n          \n          <div className=\"space-y-2\">\n            <Label htmlFor=\"status\">Status</Label>\n            <Select value={formData.status} onValueChange={(value) => setFormData({ ...formData, status: value })}>\n              <SelectTrigger>\n                <SelectValue placeholder=\"Select status\" />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"active\">Active</SelectItem>\n                <SelectItem value=\"inactive\">Inactive</SelectItem>\n                <SelectItem value=\"archived\">Archived</SelectItem>\n              </SelectContent>\n            </Select>\n          </div>\n          \n          <div className=\"flex justify-end space-x-2\">\n            <Button type=\"button\" variant=\"outline\" onClick={onClose}>\n              Cancel\n            </Button>\n            <Button type=\"submit\" className=\"bg-[#2D8028] hover:bg-[#203B17]\">\n              {crop ? 'Update' : 'Create'} Crop\n            </Button>\n          </div>\n        </form>\n      </DialogContent>\n    </Dialog>\n  );\n};\n\nconst ProductionDashboard: React.FC<{\n  trays: ProductionTray[];\n  crops: Crop[];\n  onUpdateTray: (tray: ProductionTray) => void;\n}> = ({ trays, crops, onUpdateTray }) => {\n  const getStatusBadge = (status: string) => {\n    const statusConfig = {\n      active: { label: 'Active', className: 'bg-green-100 text-green-800' },\n      growing: { label: 'Growing', className: 'bg-blue-100 text-blue-800' },\n      split: { label: 'Split', className: 'bg-purple-100 text-purple-800' },\n      harvested: { label: 'Harvested', className: 'bg-gray-100 text-gray-800' }\n    };\n    \n    const config = statusConfig[status as keyof typeof statusConfig] || statusConfig.active;\n    return <Badge className={config.className}>{config.label}</Badge>;\n  };\n\n  // Calculate metrics from actual tray data\n  const activeTrayCount = trays.filter(t => t.status === 'active' || t.status === 'growing').length;\n  const readyToHarvestCount = trays.filter(t => {\n    // Ready if planted more than expected growth time ago\n    const plantedDate = new Date(t.datePlanted);\n    const daysGrowing = Math.floor((Date.now() - plantedDate.getTime()) / (1000 * 60 * 60 * 24));\n    return t.status === 'growing' && daysGrowing >= 25; // Approximate ready threshold\n  }).length;\n  const harvestedCount = trays.filter(t => t.status === 'harvested').length;\n  const totalTrayCount = trays.length;\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Overview Cards */}\n      <div className=\"grid grid-cols-1 md:grid-cols-4 gap-6\">\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Active Trays</CardTitle>\n            <Sprout className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\">{activeTrayCount}</div>\n            <p className=\"text-xs text-muted-foreground\">Currently growing</p>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Ready to Harvest</CardTitle>\n            <Calendar className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold text-yellow-600\">{readyToHarvestCount}</div>\n            <p className=\"text-xs text-muted-foreground\">Awaiting harvest</p>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Harvested</CardTitle>\n            <TrendingUp className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold text-green-600\">{harvestedCount}</div>\n            <p className=\"text-xs text-muted-foreground\">Completed trays</p>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Total Trays</CardTitle>\n            <TrendingUp className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\">{totalTrayCount}</div>\n            <p className=\"text-xs text-muted-foreground\">All trays tracked</p>\n          </CardContent>\n        </Card>\n      </div>\n\n\n\n    </div>\n  );\n};\n\nconst CropConfiguration: React.FC<{\n  crops: Crop[];\n  onAddCrop: () => void;\n  onEditCrop: (crop: Crop) => void;\n  onDeleteCrop: (cropId: number) => void;\n}> = ({ crops, onAddCrop, onEditCrop, onDeleteCrop }) => {\n  const getCategoryBadge = (category: string) => {\n    const categoryConfig = {\n      'Leafy Green': { className: 'bg-green-100 text-green-800' },\n      'Microgreen': { className: 'bg-blue-100 text-blue-800' },\n      'Herb': { className: 'bg-purple-100 text-purple-800' },\n      'Vegetable': { className: 'bg-orange-100 text-orange-800' }\n    };\n    \n    const config = categoryConfig[category as keyof typeof categoryConfig] || categoryConfig['Leafy Green'];\n    return <Badge className={config.className}>{category}</Badge>;\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex justify-between items-center\">\n        <h2 className=\"text-xl font-semibold\">Crop Configuration</h2>\n        <Button onClick={onAddCrop} className=\"bg-[#2D8028] hover:bg-[#203B17]\">\n          <Plus className=\"h-4 w-4 mr-2\" />\n          Add New Crop\n        </Button>\n      </div>\n\n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\n        {crops.map((crop) => (\n          <Card key={crop.id}>\n            <CardHeader>\n              <div className=\"flex justify-between items-start\">\n                <div>\n                  <CardTitle className=\"text-lg\">{crop.name}</CardTitle>\n                  {getCategoryBadge(crop.category)}\n                </div>\n                <div className=\"flex space-x-2\">\n                  <Button\n                    variant=\"ghost\"\n                    size=\"sm\"\n                    onClick={() => onEditCrop(crop)}\n                  >\n                    <Edit2 className=\"h-4 w-4\" />\n                  </Button>\n                  <Button\n                    variant=\"ghost\"\n                    size=\"sm\"\n                    onClick={() => onDeleteCrop(crop.id)}\n                  >\n                    <Trash2 className=\"h-4 w-4\" />\n                  </Button>\n                </div>\n              </div>\n            </CardHeader>\n            <CardContent>\n              <div className=\"space-y-2 text-sm\">\n                <div className=\"flex justify-between\">\n                  <span className=\"text-gray-600\">Expected Yield:</span>\n                  <span className=\"font-medium\">{crop.expectedYieldPerTray} lbs/tray</span>\n                </div>\n                <div className=\"flex justify-between\">\n                  <span className=\"text-gray-600\">Growth Time:</span>\n                  <span className=\"font-medium\">{crop.averageGrowthTime} days</span>\n                </div>\n                <div className=\"flex justify-between\">\n                  <span className=\"text-gray-600\">Light Requirements:</span>\n                  <span className=\"font-medium\">{crop.lightRequirements}</span>\n                </div>\n                <div className=\"flex justify-between\">\n                  <span className=\"text-gray-600\">Status:</span>\n                  <Badge className={crop.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}>\n                    {crop.status}\n                  </Badge>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        ))}\n      </div>\n    </div>\n  );\n};\n\nconst ProductionData: React.FC = () => {\n  const auth = getStoredAuth();\n  const isCorporateManager = auth.user?.role === 'corporate';\n  const isManager = auth.user?.role === 'manager' || isCorporateManager;\n  const { toast } = useToast();\n  \n  const [activeTab, setActiveTab] = useState<string>('dashboard');\n  const tabsRef = useRef<HTMLDivElement>(null);\n  const [showLeftScroll, setShowLeftScroll] = useState(false);\n  const [showRightScroll, setShowRightScroll] = useState(false);\n\n  const [crops, setCrops] = useState<Crop[]>(mockCrops);\n  const [trays, setTrays] = useState<ProductionTray[]>([]);\n  const [showCropModal, setShowCropModal] = useState(false);\n  const [editingCrop, setEditingCrop] = useState<Crop | null>(null);\n  \n  const tabs = [\n    { id: 'dashboard', label: 'üìä Live Dashboard', icon: 'üìä' },\n    { id: 'trays', label: 'üì¶ Tray Tracking', icon: 'üì¶' },\n    { id: 'equipment', label: 'üè≠ Equipment', icon: 'üè≠' },\n    ...(isCorporateManager ? [{ id: 'crops', label: 'üåæ Crop Config', icon: 'üåæ' }] : []),\n    ...(isCorporateManager ? [{ id: 'systems', label: '‚öôÔ∏è System Config', icon: '‚öôÔ∏è' }] : [])\n  ];\n\n  // Check scroll indicators\n  useEffect(() => {\n    const checkScroll = () => {\n      if (tabsRef.current) {\n        const { scrollLeft, scrollWidth, clientWidth } = tabsRef.current;\n        setShowLeftScroll(scrollLeft > 0);\n        setShowRightScroll(scrollLeft + clientWidth < scrollWidth - 5);\n      }\n    };\n    \n    checkScroll();\n    window.addEventListener('resize', checkScroll);\n    \n    return () => window.removeEventListener('resize', checkScroll);\n  }, [tabs.length]);\n  \n  const scrollTabs = (direction: 'left' | 'right') => {\n    if (tabsRef.current) {\n      const scrollAmount = 200;\n      tabsRef.current.scrollBy({\n        left: direction === 'left' ? -scrollAmount : scrollAmount,\n        behavior: 'smooth'\n      });\n      \n      // Check scroll indicators after scrolling\n      setTimeout(() => {\n        if (tabsRef.current) {\n          const { scrollLeft, scrollWidth, clientWidth } = tabsRef.current;\n          setShowLeftScroll(scrollLeft > 0);\n          setShowRightScroll(scrollLeft + clientWidth < scrollWidth - 5);\n        }\n      }, 300);\n    }\n  };\n\n  // Initialize trays from TrayService\n  useEffect(() => {\n    setTrays(TrayService.getAllTrays());\n  }, []);\n\n  // Listen for tray updates\n  useEffect(() => {\n    const handleTrayAdded = (event: any) => {\n      setTrays(prevTrays => [...prevTrays, event.detail]);\n    };\n    \n    const handleTrayUpdated = () => {\n      setTrays(TrayService.getAllTrays());\n    };\n    \n    window.addEventListener('trayAdded', handleTrayAdded);\n    window.addEventListener('trayUpdated', handleTrayUpdated);\n    \n    return () => {\n      window.removeEventListener('trayAdded', handleTrayAdded);\n      window.removeEventListener('trayUpdated', handleTrayUpdated);\n    };\n  }, []);\n\n  const handleAddCrop = () => {\n    setEditingCrop(null);\n    setShowCropModal(true);\n  };\n\n  const handleEditCrop = (crop: Crop) => {\n    setEditingCrop(crop);\n    setShowCropModal(true);\n  };\n\n  const handleSaveCrop = (crop: Crop) => {\n    if (editingCrop) {\n      setCrops(crops.map(c => c.id === crop.id ? crop : c));\n      toast({\n        title: \"Crop Updated\",\n        description: \"Crop configuration has been updated successfully.\",\n      });\n    } else {\n      setCrops([...crops, crop]);\n      toast({\n        title: \"Crop Added\",\n        description: \"New crop has been added to the system.\",\n      });\n    }\n    setShowCropModal(false);\n    setEditingCrop(null);\n  };\n\n  const handleDeleteCrop = (cropId: number) => {\n    if (window.confirm('Are you sure you want to delete this crop?')) {\n      setCrops(crops.filter(c => c.id !== cropId));\n      toast({\n        title: \"Crop Deleted\",\n        description: \"Crop has been removed from the system.\",\n      });\n    }\n  };\n\n  const handleUpdateTray = (tray: Tray) => {\n    TrayService.updateTray(tray.id, tray);\n  };\n\n  const handleExport = () => {\n    const csvContent = [\n      ['Tray ID', 'Crop Type', 'Date Planted', 'System', 'Est. Harvest', 'Status', 'Yield', 'Notes'],\n      ...trays.map(tray => [\n        tray.id,\n        tray.cropType,\n        new Date(tray.datePlanted).toLocaleDateString(),\n        tray.assignedSystem,\n        new Date(tray.estimatedHarvestDate).toLocaleDateString(),\n        tray.status,\n        tray.actualYield ? `${tray.actualYield} lbs` : 'N/A',\n        tray.notes || ''\n      ])\n    ];\n    \n    const csvString = csvContent.map(row => row.join(',')).join('\\n');\n    const blob = new Blob([csvString], { type: 'text/csv' });\n    const url = window.URL.createObjectURL(blob);\n    const a = document.createElement('a');\n    a.href = url;\n    a.download = `production-data-${new Date().toISOString().split('T')[0]}.csv`;\n    a.click();\n    window.URL.revokeObjectURL(url);\n  };\n\n  if (!isManager) {\n    return (\n      <div className=\"flex items-center justify-center h-64\">\n        <Card className=\"w-full max-w-md\">\n          <CardContent className=\"flex flex-col items-center justify-center p-6\">\n            <AlertTriangle className=\"h-12 w-12 text-red-500 mb-4\" />\n            <h2 className=\"text-xl font-semibold mb-2\">Access Denied</h2>\n            <p className=\"text-gray-600 text-center\">\n              This page is only available to managers and corporate users.\n            </p>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Header */}\n      <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between\">\n        <div></div>\n        <div className=\"mt-4 sm:mt-0\">\n          <Button onClick={handleExport} className=\"bg-[#2D8028] hover:bg-[#203B17] text-white\">\n            <Download className=\"h-4 w-4 mr-2\" />\n            Export Report\n          </Button>\n        </div>\n      </div>\n\n      {/* Horizontal Scrolling Tabs */}\n      <div className=\"tab-navigation-wrapper relative\">\n        {showLeftScroll && (\n          <Button \n            variant=\"outline\" \n            size=\"sm\"\n            className=\"absolute left-0 top-1/2 transform -translate-y-1/2 z-10 bg-white shadow-md\"\n            onClick={() => scrollTabs('left')}\n          >\n            <ChevronLeft size={20} />\n          </Button>\n        )}\n        \n        <div \n          className=\"flex overflow-x-auto scrollbar-hide space-x-2 px-8 pb-2\"\n          ref={tabsRef}\n          style={{ scrollbarWidth: 'none', msOverflowStyle: 'none' }}\n          onScroll={(e) => {\n            const target = e.target as HTMLDivElement;\n            setShowLeftScroll(target.scrollLeft > 0);\n            setShowRightScroll(target.scrollLeft + target.clientWidth < target.scrollWidth - 5);\n          }}\n        >\n          {tabs.map(tab => (\n            <Button\n              key={tab.id}\n              variant={activeTab === tab.id ? \"default\" : \"outline\"}\n              onClick={() => setActiveTab(tab.id)}\n              className={`flex-shrink-0 whitespace-nowrap ${activeTab === tab.id ? 'bg-[#2D8028] text-white' : 'bg-white text-gray-600'}`}\n            >\n              {tab.label}\n            </Button>\n          ))}\n        </div>\n        \n        {showRightScroll && (\n          <Button \n            variant=\"outline\" \n            size=\"sm\"\n            className=\"absolute right-0 top-1/2 transform -translate-y-1/2 z-10 bg-white shadow-md\"\n            onClick={() => scrollTabs('right')}\n          >\n            <ChevronRight size={20} />\n          </Button>\n        )}\n      </div>\n      \n      {/* Tab Content */}\n      <div className=\"tab-content mt-6\">\n        {activeTab === 'dashboard' && (\n          <ProductionDashboard \n            trays={trays}\n            crops={crops}\n            onUpdateTray={handleUpdateTray}\n          />\n        )}\n        \n        {activeTab === 'trays' && (\n          <TrayTracking />\n        )}\n        \n        {activeTab === 'equipment' && (\n          <EquipmentManagement />\n        )}\n        \n        {activeTab === 'crops' && isCorporateManager && (\n          <CropConfiguration\n            crops={crops}\n            onAddCrop={handleAddCrop}\n            onEditCrop={handleEditCrop}\n            onDeleteCrop={handleDeleteCrop}\n          />\n        )}\n        \n        {activeTab === 'systems' && isCorporateManager && (\n          <SystemConfiguration isCorporateManager={isCorporateManager} />\n        )}\n      </div>\n\n      {/* Crop Modal */}\n      <CropModal\n        crop={editingCrop}\n        isOpen={showCropModal}\n        onClose={() => {\n          setShowCropModal(false);\n          setEditingCrop(null);\n        }}\n        onSave={handleSaveCrop}\n      />\n    </div>\n  );\n};\n\nexport default ProductionData;","path":null,"size_bytes":24413,"size_tokens":null},"client/src/components/AddInventoryModal.tsx":{"content":"import React, { useState } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle } from \"@/components/ui/dialog\";\n\n\ninterface AddInventoryModalProps {\n  isOpen: boolean;\n  onClose: () => void;\n  onSave: (data: AddInventoryData) => Promise<void>;\n}\n\nexport interface AddInventoryData {\n  name: string;\n  sku: string;\n  category: string;\n  quantity: number;\n  unit: string;\n  totalCost: number;\n  costPerUnit: number;\n  supplier: string;\n  minimumStock: number;\n  notes: string;\n}\n\nconst AddInventoryModal: React.FC<AddInventoryModalProps> = ({\n  isOpen,\n  onClose,\n  onSave\n}) => {\n  const [inventoryData, setInventoryData] = useState<AddInventoryData>({\n    name: '',\n    sku: '',\n    category: 'seeds',\n    quantity: 0,\n    unit: 'oz',\n    totalCost: 0,\n    costPerUnit: 0,\n    supplier: '',\n    minimumStock: 0,\n    notes: ''\n  });\n  const [isSubmitting, setIsSubmitting] = useState(false);\n\n  const handleCostChange = (field: 'totalCost' | 'quantity', value: string) => {\n    const numValue = parseFloat(value) || 0;\n    const updates = { ...inventoryData, [field]: numValue };\n    \n    if (field === 'totalCost' || field === 'quantity') {\n      const total = field === 'totalCost' ? numValue : inventoryData.totalCost;\n      const qty = field === 'quantity' ? numValue : inventoryData.quantity;\n      \n      if (qty > 0 && total > 0) {\n        updates.costPerUnit = Math.round((total / qty) * 100) / 100; // Round to 2 decimal places\n      } else {\n        updates.costPerUnit = 0;\n      }\n    }\n    \n    setInventoryData(updates);\n  };\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault();\n    if (!inventoryData.name || !inventoryData.sku || inventoryData.quantity <= 0 || inventoryData.totalCost <= 0) {\n      return;\n    }\n\n    setIsSubmitting(true);\n    try {\n      await onSave(inventoryData);\n      // Reset form\n      setInventoryData({\n        name: '',\n        sku: '',\n        category: 'seeds',\n        quantity: 0,\n        unit: 'oz',\n        totalCost: 0,\n        costPerUnit: 0,\n        supplier: '',\n        minimumStock: 0,\n        notes: ''\n      });\n      onClose();\n    } catch (error) {\n      console.error(\"Failed to add inventory:\", error);\n    } finally {\n      setIsSubmitting(false);\n    }\n  };\n\n  return (\n    <Dialog open={isOpen} onOpenChange={onClose}>\n      <DialogContent className=\"max-w-md max-h-[90vh] overflow-y-auto\">\n        <DialogHeader>\n          <DialogTitle className=\"flex items-center gap-2\">\n            üå± Add New Item to Inventory\n          </DialogTitle>\n        </DialogHeader>\n        \n        <form onSubmit={handleSubmit} className=\"space-y-4\">\n          {/* Item Name */}\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"name\">Item Name *</Label>\n            <Input\n              id=\"name\"\n              type=\"text\"\n              value={inventoryData.name}\n              onChange={(e) => setInventoryData({...inventoryData, name: e.target.value})}\n              placeholder=\"e.g., Spinach Seeds - Bloomsdale\"\n              required\n            />\n          </div>\n\n          {/* SKU */}\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"sku\">SKU (4 characters max) *</Label>\n            <Input\n              id=\"sku\"\n              type=\"text\"\n              value={inventoryData.sku}\n              onChange={(e) => setInventoryData({...inventoryData, sku: e.target.value.toUpperCase().slice(0, 4)})}\n              placeholder=\"SPIN\"\n              maxLength={4}\n              required\n            />\n            <div className=\"text-sm text-gray-500\">\n              4-character code for tray IDs\n            </div>\n          </div>\n\n          {/* Category */}\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"category\">Category *</Label>\n            <Select\n              value={inventoryData.category}\n              onValueChange={(value) => setInventoryData({...inventoryData, category: value})}\n            >\n              <SelectTrigger>\n                <SelectValue />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"seeds\">Seeds</SelectItem>\n                <SelectItem value=\"nutrients\">Nutrients</SelectItem>\n                <SelectItem value=\"farm-supplies\">Farm Supplies</SelectItem>\n                <SelectItem value=\"other-supplies\">Other Supplies</SelectItem>\n                <SelectItem value=\"equipment\">Equipment</SelectItem>\n              </SelectContent>\n            </Select>\n          </div>\n\n          {/* Quantity and Unit Row */}\n          <div className=\"grid grid-cols-2 gap-3\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"quantity\">Quantity to Add *</Label>\n              <Input\n                id=\"quantity\"\n                type=\"number\"\n                min=\"0.01\"\n                step=\"0.01\"\n                value={inventoryData.quantity || ''}\n                onChange={(e) => handleCostChange('quantity', e.target.value)}\n                placeholder=\"50\"\n                required\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"unit\">Unit *</Label>\n              <Select\n                value={inventoryData.unit}\n                onValueChange={(value) => setInventoryData({...inventoryData, unit: value})}\n              >\n                <SelectTrigger>\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"oz\">oz</SelectItem>\n                  <SelectItem value=\"lbs\">lbs</SelectItem>\n                  <SelectItem value=\"grams\">grams</SelectItem>\n                  <SelectItem value=\"kg\">kg</SelectItem>\n                  <SelectItem value=\"pieces\">pieces</SelectItem>\n                  <SelectItem value=\"liters\">liters</SelectItem>\n                  <SelectItem value=\"gallons\">gallons</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n          </div>\n\n          {/* Supplier */}\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"supplier\">Supplier</Label>\n            <Input\n              id=\"supplier\"\n              type=\"text\"\n              value={inventoryData.supplier}\n              onChange={(e) => setInventoryData({...inventoryData, supplier: e.target.value})}\n              placeholder=\"e.g., Johnny Seeds\"\n            />\n          </div>\n\n          {/* Total Cost */}\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"total-cost\">Total Cost Paid ($) *</Label>\n            <Input\n              id=\"total-cost\"\n              type=\"number\"\n              min=\"0.01\"\n              step=\"0.01\"\n              value={inventoryData.totalCost || ''}\n              onChange={(e) => handleCostChange('totalCost', e.target.value)}\n              placeholder=\"e.g., 125.00\"\n              required\n            />\n            <div className=\"text-sm text-gray-500\">\n              Enter the total amount paid for this quantity\n            </div>\n          </div>\n\n          {/* Minimum Stock Level */}\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"minimum-stock\">Minimum Stock Level</Label>\n            <Input\n              id=\"minimum-stock\"\n              type=\"number\"\n              min=\"0\"\n              step=\"0.1\"\n              value={inventoryData.minimumStock || ''}\n              onChange={(e) => setInventoryData({...inventoryData, minimumStock: parseFloat(e.target.value) || 0})}\n              placeholder=\"0\"\n            />\n            <div className=\"text-sm text-gray-500\">\n              Alert when stock falls below this level\n            </div>\n          </div>\n\n          {/* Calculated Cost Per Unit */}\n          <div className=\"bg-blue-50 p-3 rounded-lg\">\n            <Label className=\"text-sm font-medium text-blue-900\">Cost Per Unit (Calculated)</Label>\n            <div className=\"text-xl font-bold text-blue-900\">\n              ${inventoryData.costPerUnit.toFixed(2)} / {inventoryData.unit}\n            </div>\n          </div>\n\n          {/* Optional Notes */}\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"notes\">Notes (Optional)</Label>\n            <Textarea\n              id=\"notes\"\n              value={inventoryData.notes}\n              onChange={(e) => setInventoryData({...inventoryData, notes: e.target.value})}\n              placeholder=\"e.g., Purchased from Supplier X, Invoice #12345\"\n              rows={3}\n            />\n          </div>\n\n          {/* Actions */}\n          <div className=\"flex gap-2 pt-4\">\n            <Button \n              type=\"submit\" \n              className=\"flex-1 bg-[#2D8028] hover:bg-[#203B17]\"\n              disabled={isSubmitting || !inventoryData.name || !inventoryData.sku || inventoryData.quantity <= 0 || inventoryData.totalCost <= 0}\n            >\n              {isSubmitting ? \"Adding...\" : \"Add New Item\"}\n            </Button>\n            <Button type=\"button\" variant=\"outline\" onClick={onClose} className=\"flex-1\">\n              Cancel\n            </Button>\n          </div>\n        </form>\n      </DialogContent>\n    </Dialog>\n  );\n};\n\nexport default AddInventoryModal;","path":null,"size_bytes":9453,"size_tokens":null},"client/src/pages/Login.tsx":{"content":"import React from \"react\";\nimport { useLocation } from \"wouter\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useMutation } from \"@tanstack/react-query\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { setStoredAuth } from \"@/lib/auth\";\nimport { User } from \"@shared/schema\";\n\nconst Login: React.FC = () => {\n  const [, setLocation] = useLocation();\n  const [isLogin, setIsLogin] = React.useState(true);\n  const [formData, setFormData] = React.useState({\n    username: \"\",\n    password: \"\",\n    name: \"\",\n    role: \"technician\",\n  });\n  const { toast } = useToast();\n\n  // Production launch - test users removed\n\n  const loginMutation = useMutation({\n    mutationFn: async (credentials: { username: string; password: string }) => {\n      const response = await apiRequest(\"POST\", \"/api/auth/login\", credentials);\n      return response.json();\n    },\n    onSuccess: (data: { user: User }) => {\n      setStoredAuth(data.user);\n      toast({\n        title: \"Login successful!\",\n        description: `Welcome back, ${data.user.name}!`,\n      });\n      setLocation(\"/\");\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Login failed\",\n        description: error.message || \"Invalid credentials\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const registerMutation = useMutation({\n    mutationFn: async (userData: { username: string; password: string; name: string; role: string }) => {\n      const response = await apiRequest(\"POST\", \"/api/auth/register\", userData);\n      return response.json();\n    },\n    onSuccess: (data: { user: User }) => {\n      toast({\n        title: \"Registration successful!\",\n        description: \"Your account has been created. Please wait for approval.\",\n      });\n      setIsLogin(true);\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Registration failed\",\n        description: error.message || \"Something went wrong\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    \n    if (isLogin) {\n      loginMutation.mutate({\n        username: formData.username,\n        password: formData.password,\n      });\n    } else {\n      registerMutation.mutate(formData);\n    }\n  };\n\n  const handleDevLogin = () => {\n    // Create a mock authenticated user for development\n    const mockUser: User = {\n      id: 999,\n      username: \"dev\",\n      password: \"dev\",\n      name: \"Dev User\",\n      role: \"corporate\",\n      approved: true,\n      location: \"Kenosha\",\n      payType: \"salary\",\n      payRate: 75000,\n      businessEmail: \"dev@growspace.com\",\n      personalEmail: \"dev@email.com\",\n      homePhone: null,\n      businessPhone: null,\n      mobilePhone: null,\n      emergencyContactName: null,\n      emergencyRelationship: null,\n      emergencyPhone: null,\n      lastActive: null,\n      createdAt: new Date(),\n    };\n    \n    setStoredAuth(mockUser);\n    toast({\n      title: \"Dev Login successful!\",\n      description: \"Welcome to the development environment!\",\n    });\n    setLocation(\"/\");\n  };\n\n  const handleInputChange = (field: string, value: string) => {\n    setFormData(prev => ({ ...prev, [field]: value }));\n  };\n\n  return (\n    <div className=\"min-h-screen bg-[#F5F5F5] flex items-center justify-center p-4\">\n      <div className=\"w-full max-w-md\">\n        <div className=\"text-center mb-8\">\n          <h1 className=\"text-3xl font-bold text-[#203B17] mb-2\">üå± Grow Space</h1>\n          <p className=\"text-gray-600\">Task Management for Vertical Farms</p>\n        </div>\n\n        <Card>\n          <CardHeader>\n            <CardTitle>{isLogin ? \"Sign In\" : \"Create Account\"}</CardTitle>\n            <CardDescription>\n              {isLogin \n                ? \"Enter your credentials to access your account\"\n                : \"Fill in your details to create a new account\"\n              }\n            </CardDescription>\n          </CardHeader>\n          <CardContent>\n            <form onSubmit={handleSubmit} className=\"space-y-4\">\n              {!isLogin && (\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"name\">Full Name</Label>\n                  <Input\n                    id=\"name\"\n                    type=\"text\"\n                    placeholder=\"Enter your full name\"\n                    value={formData.name}\n                    onChange={(e) => handleInputChange(\"name\", e.target.value)}\n                    required\n                  />\n                </div>\n              )}\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"username\">Username</Label>\n                <Input\n                  id=\"username\"\n                  type=\"text\"\n                  placeholder=\"Enter your username\"\n                  value={formData.username}\n                  onChange={(e) => handleInputChange(\"username\", e.target.value)}\n                  required\n                />\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"password\">Password</Label>\n                <Input\n                  id=\"password\"\n                  type=\"password\"\n                  placeholder=\"Enter your password\"\n                  value={formData.password}\n                  onChange={(e) => handleInputChange(\"password\", e.target.value)}\n                  required\n                />\n              </div>\n\n              {!isLogin && (\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"role\">Role</Label>\n                  <Select value={formData.role} onValueChange={(value) => handleInputChange(\"role\", value)}>\n                    <SelectTrigger>\n                      <SelectValue placeholder=\"Select your role\" />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"technician\">Farm Technician</SelectItem>\n                      <SelectItem value=\"manager\">Manager</SelectItem>\n                      <SelectItem value=\"corporate\">Corporate</SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n              )}\n\n              <Button\n                type=\"submit\"\n                className=\"w-full bg-[#2D8028] hover:bg-[#203B17] text-white\"\n                disabled={loginMutation.isPending || registerMutation.isPending}\n              >\n                {(loginMutation.isPending || registerMutation.isPending) \n                  ? \"Processing...\" \n                  : isLogin ? \"Sign In\" : \"Create Account\"\n                }\n              </Button>\n            </form>\n\n            {isLogin && import.meta.env.DEV && (\n              <div className=\"mt-6\">\n                <div className=\"text-center text-sm text-gray-600 mb-4\">\n                  Development mode:\n                </div>\n                <Button\n                  variant=\"outline\"\n                  className=\"w-full\"\n                  onClick={handleDevLogin}\n                  data-testid=\"button-dev-login\"\n                >\n                  üöÄ Dev Login (Skip Authentication)\n                </Button>\n              </div>\n            )}\n\n            <div className=\"mt-6 text-center\">\n              <button\n                type=\"button\"\n                onClick={() => setIsLogin(!isLogin)}\n                className=\"text-sm text-[#2D8028] hover:text-[#203B17]\"\n              >\n                {isLogin \n                  ? \"Don't have an account? Sign up\"\n                  : \"Already have an account? Sign in\"\n                }\n              </button>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n};\n\nexport default Login;\n","path":null,"size_bytes":7991,"size_tokens":null},"client/src/pages/Inventory.tsx":{"content":"import React from \"react\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { AlertTriangle, Package, Search, Plus, TrendingDown, Mail, Edit, DollarSign } from \"lucide-react\";\nimport { InventoryItem } from \"@shared/schema\";\nimport { useUser } from \"@/contexts/UserContext\";\nimport { useLocation } from \"@/contexts/LocationContext\";\nimport { locations } from \"@/data/locationsData\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport InventoryModal from \"@/components/InventoryModal\";\nimport AddInventoryModal, { AddInventoryData } from \"@/components/AddInventoryModal\";\nimport AddStockModal from \"@/components/AddStockModal\";\n\nconst Inventory: React.FC = () => {\n  const [searchTerm, setSearchTerm] = React.useState(\"\");\n  const [categoryFilter, setCategoryFilter] = React.useState<string>(\"all\");\n  const [showLowStockOnly, setShowLowStockOnly] = React.useState(false);\n  const [sortBy, setSortBy] = React.useState<string>(\"name\");\n  const [showModal, setShowModal] = React.useState(false);\n  const [showAddInventoryModal, setShowAddInventoryModal] = React.useState(false);\n  const [showAddStockModal, setShowAddStockModal] = React.useState(false);\n  const [editingItem, setEditingItem] = React.useState<InventoryItem | null>(null);\n  const [modalMode, setModalMode] = React.useState<'add' | 'edit'>('add');\n  const [isCostBreakdownOpen, setIsCostBreakdownOpen] = React.useState(true);\n  const { currentUser } = useUser();\n  const { currentLocation, isViewingAllLocations } = useLocation();\n  const isManager = currentUser?.role === 'Manager' || currentUser?.role === 'Corporate';\n  const queryClient = useQueryClient();\n\n  // Use location code for API filtering (K, R, MKE)\n  const locationCode = currentLocation.code;\n  \n  const { data: inventory = [], isLoading } = useQuery<InventoryItem[]>({\n    queryKey: [\"/api/inventory\", locationCode, isViewingAllLocations],\n    queryFn: async () => {\n      try {\n        const url = isViewingAllLocations \n          ? \"/api/inventory\" \n          : `/api/inventory?location=${locationCode}`;\n        const result = await apiRequest(\"GET\", url);\n        return Array.isArray(result) ? result : [];\n      } catch (error) {\n        console.error('Failed to fetch inventory:', error);\n        return [];\n      }\n    },\n  });\n\n  const { data: lowStockItems = [] } = useQuery<InventoryItem[]>({\n    queryKey: [\"/api/inventory/low-stock\", locationCode, isViewingAllLocations],\n    queryFn: async () => {\n      try {\n        const url = isViewingAllLocations \n          ? \"/api/inventory/low-stock\" \n          : `/api/inventory/low-stock?location=${locationCode}`;\n        const result = await apiRequest(\"GET\", url);\n        return Array.isArray(result) ? result : [];\n      } catch (error) {\n        console.error('Failed to fetch low stock items:', error);\n        return [];\n      }\n    },\n  });\n\n  const createItemMutation = useMutation({\n    mutationFn: (itemData: any) => apiRequest(\"POST\", \"/api/inventory\", itemData),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/inventory\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/inventory/low-stock\"] });\n      setShowModal(false);\n    },\n  });\n\n  const updateItemMutation = useMutation({\n    mutationFn: (itemData: any) => apiRequest(\"PATCH\", `/api/inventory/${itemData.id}`, itemData),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/inventory\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/inventory/low-stock\"] });\n      setShowModal(false);\n    },\n  });\n\n  const deleteItemMutation = useMutation({\n    mutationFn: (itemId: number) => apiRequest(\"DELETE\", `/api/inventory/${itemId}`),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/inventory\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/inventory/low-stock\"] });\n      setShowModal(false);\n    },\n  });\n\n  const addStockMutation = useMutation({\n    mutationFn: (data: { itemId: number; quantity: number; unitCost: number; supplier: string; notes: string }) => \n      apiRequest(\"POST\", \"/api/inventory/add-stock\", data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/inventory\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/inventory/low-stock\"] });\n      setShowAddStockModal(false);\n    },\n    onError: (error) => {\n      console.error(\"Failed to add stock:\", error);\n    },\n  });\n\n  const categories = [\n    { value: \"all\", label: \"All Categories\" },\n    { value: \"seeds\", label: \"Seeds\" },\n    { value: \"nutrients\", label: \"Nutrients\" },\n    { value: \"farm-supplies\", label: \"Farm Supplies\" },\n    { value: \"other-supplies\", label: \"Other Supplies\" },\n    { value: \"equipment\", label: \"Equipment\" },\n  ];\n\n  const categoryDetails = [\n    { id: 'seeds', name: 'Seeds', icon: 'üå±', color: '#22c55e' },\n    { id: 'nutrients', name: 'Nutrients', icon: 'üß™', color: '#3b82f6' },\n    { id: 'farm-supplies', name: 'Farm Supplies', icon: 'üöú', color: '#f59e0b' },\n    { id: 'other-supplies', name: 'Other Supplies', icon: 'üì¶', color: '#8b5cf6' },\n    { id: 'equipment', name: 'Equipment', icon: 'üîß', color: '#6366f1' }\n  ];\n\n  const calculateCategoryTotals = () => {\n    const totals = {\n      'seeds': { value: 0, count: 0 },\n      'nutrients': { value: 0, count: 0 },\n      'farm-supplies': { value: 0, count: 0 },\n      'other-supplies': { value: 0, count: 0 },\n      'equipment': { value: 0, count: 0 }\n    };\n    \n    inventory.forEach(item => {\n      const categoryKey = item.category?.toLowerCase().replace(/\\s+/g, '-') || 'other-supplies';\n      if (totals[categoryKey as keyof typeof totals]) {\n        totals[categoryKey as keyof typeof totals].value += getItemTotalValue(item);\n        totals[categoryKey as keyof typeof totals].count += 1;\n      }\n    });\n    \n    const grandTotal = Object.values(totals).reduce((sum, cat) => sum + cat.value, 0);\n    \n    // Add percentages\n    Object.keys(totals).forEach(category => {\n      const cat = category as keyof typeof totals;\n      (totals[cat] as any).percentage = grandTotal > 0 \n        ? ((totals[cat].value / grandTotal) * 100).toFixed(1)\n        : '0.0';\n    });\n    \n    return { totals, grandTotal };\n  };\n\n  // Cost calculation functions\n  const getItemCostPerUnit = (item: InventoryItem): number => {\n    // Use the weighted average cost from the database\n    return item.avgCostPerUnit || 0;\n  };\n\n  const getItemTotalValue = (item: InventoryItem): number => {\n    // Use the total value from the database or calculate it\n    return item.totalValue || ((item.currentStock || 0) * getItemCostPerUnit(item));\n  };\n\n  const getTotalInventoryValue = (): number => {\n    return inventory.reduce((total, item) => total + getItemTotalValue(item), 0);\n  };\n\n  const getLocationName = (locationCode: string): string => {\n    const location = locations.find(l => l.code === locationCode);\n    return location ? location.name : locationCode;\n  };\n\n  const filteredInventory = React.useMemo(() => {\n    let filtered = inventory;\n\n    if (searchTerm) {\n      filtered = filtered.filter(item =>\n        item.name.toLowerCase().includes(searchTerm.toLowerCase()) ||\n        item.supplier?.toLowerCase().includes(searchTerm.toLowerCase())\n      );\n    }\n\n    if (categoryFilter && categoryFilter !== \"all\") {\n      filtered = filtered.filter(item => item.category === categoryFilter);\n    }\n\n    if (showLowStockOnly) {\n      filtered = filtered.filter(item => (item.currentStock || 0) <= (item.minimumStock || 0));\n    }\n\n    // Sort the filtered items\n    filtered.sort((a, b) => {\n      switch (sortBy) {\n        case \"name\":\n          return a.name.localeCompare(b.name);\n        case \"stock\":\n          return (a.currentStock || 0) - (b.currentStock || 0);\n        case \"category\":\n          return a.category.localeCompare(b.category);\n        case \"cost\":\n          return getItemCostPerUnit(b) - getItemCostPerUnit(a); // Highest cost first\n        case \"value\":\n          return getItemTotalValue(b) - getItemTotalValue(a); // Highest value first\n        default:\n          return 0;\n      }\n    });\n\n    return filtered;\n  }, [inventory, searchTerm, categoryFilter, showLowStockOnly, sortBy]);\n\n  const getStockStatus = (item: InventoryItem) => {\n    const currentStock = item.currentStock || 0;\n    const minimumStock = item.minimumStock || 0;\n    if (currentStock <= minimumStock) {\n      return { status: \"low\", color: \"bg-red-100 text-red-800\", label: \"Low Stock\" };\n    }\n    if (currentStock <= minimumStock * 1.5) {\n      return { status: \"warning\", color: \"bg-yellow-100 text-yellow-800\", label: \"Warning\" };\n    }\n    return { status: \"good\", color: \"bg-green-100 text-green-800\", label: \"In Stock\" };\n  };\n\n  const getCategoryIcon = (category: string) => {\n    const icons = {\n      seeds: \"üå±\",\n      nutrients: \"üß™\",\n      \"farm-supplies\": \"üöú\",\n      \"other-supplies\": \"üì¶\",\n      equipment: \"üîß\",\n      // Legacy support\n      supplies: \"üì¶\",\n    };\n    return icons[category as keyof typeof icons] || \"üìã\";\n  };\n\n  const handleReorder = (item: InventoryItem) => {\n    const reorderAmount = item.minimumStock * 2; // Default reorder amount\n    const subject = `Reorder Request: ${item.name}`;\n    const body = `Item: ${item.name}\nCurrent Quantity: ${item.currentStock} ${item.unit}\nMinimum Quantity: ${item.minimumStock} ${item.unit}\nRequested Reorder Amount: ${reorderAmount} ${item.unit}\nSupplier: ${item.supplier || 'TBD'}\n\nRequesting Location: Grow Space Vertical Farm\nRequested By: ${currentUser?.name}\nDate: ${new Date().toLocaleDateString()}\n\nPlease process this reorder request at your earliest convenience.`;\n\n    const mailtoLink = `mailto:accounting@growspace.farm?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;\n    window.open(mailtoLink, '_blank');\n  };\n\n  const handleAddItem = () => {\n    setEditingItem(null);\n    setModalMode('add');\n    setShowModal(true);\n  };\n\n  const handleEditItem = (item: InventoryItem) => {\n    setEditingItem(item);\n    setModalMode('edit');\n    setShowModal(true);\n  };\n\n  const handleSaveItem = (itemData: any) => {\n    if (modalMode === 'edit') {\n      updateItemMutation.mutate(itemData);\n    } else {\n      createItemMutation.mutate(itemData);\n    }\n  };\n\n  const handleDeleteItem = (itemId: number) => {\n    deleteItemMutation.mutate(itemId);\n  };\n\n  const handleCloseModal = () => {\n    setShowModal(false);\n    setEditingItem(null);\n  };\n\n  const handleAddInventory = async (data: AddInventoryData) => {\n    // Create a new inventory item with the form data\n    const newItem = {\n      name: data.name,\n      sku: data.sku,\n      category: data.category,\n      currentStock: data.quantity,\n      unit: data.unit,\n      minimumStock: data.minimumStock,\n      supplier: data.supplier,\n      avgCostPerUnit: data.costPerUnit,\n      totalValue: data.totalCost\n    };\n    \n    // Use the create item mutation instead\n    await createItemMutation.mutateAsync(newItem);\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"space-y-6\">\n        <div className=\"animate-pulse space-y-4\">\n          <div className=\"h-8 bg-gray-200 rounded w-1/4\"></div>\n          <div className=\"h-4 bg-gray-200 rounded w-1/2\"></div>\n          <div className=\"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6\">\n            {[1, 2, 3, 4, 5, 6].map((i) => (\n              <div key={i} className=\"h-48 bg-gray-200 rounded-xl\"></div>\n            ))}\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"px-4 md:px-6 py-4 md:py-6 max-w-7xl mx-auto bg-gray-50\">\n      {/* Collapsible Cost Breakdown - At Top */}\n      <div className=\"bg-white rounded-lg shadow-sm border border-gray-200 mb-6 overflow-hidden\">\n        {/* Collapsible Header */}\n        <div \n          className=\"flex justify-between items-center px-6 py-5 cursor-pointer select-none hover:bg-gray-50 transition-colors\"\n          onClick={() => setIsCostBreakdownOpen(!isCostBreakdownOpen)}\n        >\n          <h2 className=\"text-lg font-semibold text-[#203B17] flex items-center gap-2 m-0\">\n            <span className=\"text-xl\">{isCostBreakdownOpen ? '‚ñº' : '‚ñ∂'}</span>\n            üí∞ Inventory Cost Breakdown\n          </h2>\n          <div className=\"text-xl font-bold text-[#203B17]\">\n            ${calculateCategoryTotals().grandTotal.toFixed(2)}\n          </div>\n        </div>\n        \n        {/* Collapsible Content */}\n        {isCostBreakdownOpen && (\n          <div className=\"px-6 pb-6 border-t border-gray-200\">\n            {/* Total Inventory Value Display */}\n            <div className=\"bg-gray-50 p-5 rounded-lg mb-6 text-center mt-6\">\n              <p className=\"text-sm text-gray-600 mb-2\">Total Inventory Value</p>\n              <p className=\"text-3xl font-bold text-[#203B17]\">\n                ${calculateCategoryTotals().grandTotal.toFixed(2)}\n              </p>\n            </div>\n            \n            {/* Category Breakdown Cards */}\n            <div className=\"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4\">\n              {categoryDetails.map((category) => {\n                const totals = calculateCategoryTotals().totals;\n                const categoryData = totals[category.id as keyof typeof totals];\n                return (\n                  <div key={category.id} className=\"bg-white border border-gray-200 rounded-lg p-4 text-center shadow-sm\">\n                    <div className=\"text-2xl mb-2\">{category.icon}</div>\n                    <h3 className=\"font-medium text-gray-900 text-sm mb-1\">{category.name}</h3>\n                    <p className=\"text-xs text-gray-600 mb-2\">{categoryData.percentage}%</p>\n                    <p className=\"font-bold text-[#203B17] text-sm mb-1\">\n                      ${categoryData.value.toFixed(2)}\n                    </p>\n                    <p className=\"text-xs text-gray-500\">{categoryData.count} items</p>\n                  </div>\n                );\n              })}\n            </div>\n          </div>\n        )}\n      </div>\n\n      {/* Single-Line Control Bar */}\n      <div className=\"bg-gray-50 p-4 rounded-lg mb-6 flex flex-wrap items-center gap-3\">\n        {/* Search input */}\n        <div className=\"relative flex-1 min-w-[300px] w-full lg:w-auto\">\n          <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400\" />\n          <Input\n            placeholder=\"Search inventory items or suppliers...\"\n            value={searchTerm}\n            onChange={(e) => setSearchTerm(e.target.value)}\n            className=\"pl-10 bg-white\"\n          />\n        </div>\n        \n        {/* Location display/selector */}\n        {isViewingAllLocations ? (\n          <div className=\"px-3 py-2 bg-blue-50 border border-blue-200 rounded-md text-sm font-medium text-blue-700\">\n            üìç All Locations\n          </div>\n        ) : (\n          <div className=\"px-3 py-2 bg-green-50 border border-green-200 rounded-md text-sm font-medium text-green-700\">\n            üìç {currentLocation.name}\n          </div>\n        )}\n        \n        {/* Category filter */}\n        <Select value={categoryFilter} onValueChange={setCategoryFilter}>\n          <SelectTrigger className=\"w-[140px] bg-white\">\n            <SelectValue placeholder=\"Category\" />\n          </SelectTrigger>\n          <SelectContent>\n            {categories.map((category) => (\n              <SelectItem key={category.value} value={category.value}>\n                {category.label}\n              </SelectItem>\n            ))}\n          </SelectContent>\n        </Select>\n        \n        {/* Sort dropdown */}\n        <Select value={sortBy} onValueChange={setSortBy}>\n          <SelectTrigger className=\"w-[140px] bg-white\">\n            <SelectValue placeholder=\"Sort\" />\n          </SelectTrigger>\n          <SelectContent>\n            <SelectItem value=\"name\">Sort by Name</SelectItem>\n            <SelectItem value=\"stock\">Sort by Stock</SelectItem>\n            <SelectItem value=\"category\">Sort by Category</SelectItem>\n            <SelectItem value=\"cost\">Sort by Cost</SelectItem>\n            <SelectItem value=\"value\">Sort by Value</SelectItem>\n          </SelectContent>\n        </Select>\n        \n        {/* Low stock checkbox */}\n        <label className=\"flex items-center gap-2 whitespace-nowrap px-3 py-2 bg-white border border-gray-300 rounded-md cursor-pointer\">\n          <input\n            type=\"checkbox\"\n            checked={showLowStockOnly}\n            onChange={(e) => setShowLowStockOnly(e.target.checked)}\n            className=\"h-4 w-4 text-[#2D8028] rounded border-gray-300 focus:ring-[#2D8028]\"\n          />\n          <span className=\"text-sm text-gray-700 flex items-center\">\n            <AlertTriangle className=\"h-4 w-4 mr-1 text-red-500\" />\n            Low Stock Only\n          </span>\n        </label>\n        \n        {/* Divider */}\n        <div className=\"w-px h-8 bg-gray-300 mx-1\"></div>\n        \n        {/* Action buttons */}\n        <button \n          onClick={() => setShowAddStockModal(true)}\n          className=\"bg-[#2D8028] hover:bg-[#236622] text-white px-4 py-2 rounded-md text-sm font-medium flex items-center gap-2 transition-colors whitespace-nowrap\"\n        >\n          üì¶ Add Stock\n        </button>\n        \n        {isManager && (\n          <button \n            onClick={handleAddItem}\n            className=\"bg-[#2D8028] hover:bg-[#236622] text-white px-4 py-2 rounded-md text-sm font-medium flex items-center gap-2 transition-colors whitespace-nowrap\"\n          >\n            + Add Item\n          </button>\n        )}\n      </div>\n\n      {/* Low Stock Alerts Section */}\n      {lowStockItems.length > 0 && (\n        <div className=\"mb-10 p-5 bg-red-50 border border-red-200 rounded-lg\">\n          <h3 className=\"text-lg font-semibold text-red-800 mb-6 flex items-center gap-2\">\n            <AlertTriangle className=\"h-5 w-5\" />\n            Low Stock Alerts ({lowStockItems.length})\n          </h3>\n          <div className=\"space-y-4\">\n            {lowStockItems.map((item) => (\n              <div key={item.id} className=\"flex items-center justify-between p-4 bg-red-100 rounded-md shadow-sm\">\n                <div className=\"flex items-center\">\n                  <span className=\"text-lg mr-3\">{getCategoryIcon(item.category)}</span>\n                  <div>\n                    <p className=\"font-medium text-red-900\">{item.name}</p>\n                    <p className=\"text-sm text-red-700\">\n                      {item.currentStock} {item.unit} remaining ‚Ä¢ Reorder at {item.minimumStock} {item.unit}\n                    </p>\n                    <p className=\"text-xs text-blue-600 mt-1\">\n                      Location: {getLocationName(item.location || 'K')} ({item.location || 'K'})\n                    </p>\n                  </div>\n                </div>\n                <button\n                  onClick={() => handleReorder(item)}\n                  className=\"bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded text-sm flex items-center gap-1 transition-colors\"\n                >\n                  <Mail className=\"h-4 w-4\" />\n                  Reorder\n                </button>\n              </div>\n            ))}\n          </div>\n        </div>\n      )}\n\n      {/* Main Inventory Items Section */}\n      <div className=\"mt-8\">\n        <h3 className=\"text-lg font-semibold text-gray-900 mb-6 flex items-center gap-2\">\n          üì¶ {isViewingAllLocations ? 'All Locations' : `${currentLocation.name}`} Inventory ({filteredInventory.length} items)\n        </h3>\n\n\n\n\n\n      {/* Inventory Grid */}\n      {filteredInventory.length === 0 ? (\n        <div className=\"text-center py-20 px-5\">\n          <div className=\"text-5xl mb-4\">üì¶</div>\n          <h3 className=\"text-lg font-medium text-gray-900 mb-2\">No items found</h3>\n          <p className=\"text-gray-600\">\n            {searchTerm || categoryFilter\n              ? \"Try adjusting your search or filter\"\n              : \"No inventory items available. Add some items to get started.\"\n            }\n          </p>\n        </div>\n      ) : (\n        <div className=\"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6\">\n          {filteredInventory.map((item) => {\n            const stockStatus = getStockStatus(item);\n            return (\n              <Card key={item.id} className=\"hover:shadow-md transition-shadow\">\n                <CardContent className=\"p-6\">\n                  <div className=\"flex items-start justify-between mb-4\">\n                    <div className=\"flex items-center\">\n                      <span className=\"text-2xl mr-3\">{getCategoryIcon(item.category)}</span>\n                      <div>\n                        <h3 className=\"font-semibold text-[#203B17]\">{item.name}</h3>\n                        <p className=\"text-sm text-gray-600 capitalize\">{item.category}</p>\n                        <p className=\"text-xs text-blue-600 font-mono bg-blue-50 px-2 py-1 rounded inline-block mt-1\">\n                          SKU: {item.sku}\n                        </p>\n                      </div>\n                    </div>\n                    <Badge className={`${stockStatus.color} border-none`}>\n                      {stockStatus.label}\n                    </Badge>\n                  </div>\n\n                  <div className=\"space-y-3\">\n                    <div className=\"flex justify-between items-center\">\n                      <span className=\"text-sm text-gray-600\">Current Stock</span>\n                      <span className=\"font-medium text-[#203B17]\">\n                        {item.currentStock} {item.unit}\n                      </span>\n                    </div>\n\n                    <div className=\"flex justify-between items-center\">\n                      <span className=\"text-sm text-gray-600\">Minimum Stock</span>\n                      <span className=\"font-medium text-gray-900\">\n                        {item.minimumStock} {item.unit}\n                      </span>\n                    </div>\n\n                    {item.supplier && (\n                      <div className=\"flex justify-between items-center\">\n                        <span className=\"text-sm text-gray-600\">Supplier</span>\n                        <span className=\"font-medium text-gray-900\">{item.supplier}</span>\n                      </div>\n                    )}\n\n                    <div className=\"flex justify-between items-center\">\n                      <span className=\"text-sm text-gray-600\">Location</span>\n                      <span className=\"font-medium text-blue-600\">\n                        {getLocationName(item.location || 'K')} ({item.location || 'K'})\n                      </span>\n                    </div>\n\n                    {item.lastRestocked && (\n                      <div className=\"flex justify-between items-center\">\n                        <span className=\"text-sm text-gray-600\">Last Restocked</span>\n                        <span className=\"font-medium text-gray-900\">\n                          {new Date(item.lastRestocked).toLocaleDateString()}\n                        </span>\n                      </div>\n                    )}\n\n                    {/* Cost Information */}\n                    <div className=\"flex justify-between items-center\">\n                      <span className=\"text-sm text-gray-600\">Cost per {item.unit}</span>\n                      <span className=\"font-medium text-green-600\">\n                        ${getItemCostPerUnit(item).toFixed(2)}\n                      </span>\n                    </div>\n\n                    <div className=\"flex justify-between items-center\">\n                      <span className=\"text-sm text-gray-600\">Total Value</span>\n                      <span className=\"font-semibold text-[#203B17]\">\n                        ${getItemTotalValue(item).toFixed(2)}\n                      </span>\n                    </div>\n                  </div>\n\n                  <div className=\"mt-4 flex gap-2\">\n                    <Button\n                      variant=\"outline\"\n                      size=\"sm\"\n                      className=\"flex-1 text-[#2D8028] border-[#2D8028] hover:bg-[#2D8028] hover:text-white\"\n                      onClick={() => handleReorder(item)}\n                    >\n                      <Mail className=\"h-4 w-4 mr-1\" />\n                      Reorder\n                    </Button>\n                    {isManager && (\n                      <Button \n                        variant=\"outline\" \n                        size=\"sm\" \n                        className=\"flex-1\"\n                        onClick={() => handleEditItem(item)}\n                      >\n                        <Edit className=\"h-4 w-4 mr-1\" />\n                        Edit\n                      </Button>\n                    )}\n                  </div>\n                </CardContent>\n              </Card>\n            );\n          })}\n        </div>\n      )}\n      </div>\n\n      {/* Add/Edit Item Modal */}\n      <InventoryModal\n        key={editingItem?.id}\n        item={editingItem}\n        mode={modalMode}\n        isOpen={showModal}\n        onSave={handleSaveItem}\n        onDelete={handleDeleteItem}\n        onClose={handleCloseModal}\n      />\n\n      {/* Add to Inventory Modal */}\n      <AddInventoryModal\n        isOpen={showAddInventoryModal}\n        onClose={() => setShowAddInventoryModal(false)}\n        onSave={handleAddInventory}\n      />\n\n      {/* Add Stock Modal */}\n      <AddStockModal\n        isOpen={showAddStockModal}\n        onClose={() => setShowAddStockModal(false)}\n        onSave={addStockMutation.mutateAsync}\n      />\n\n\n    </div>\n  );\n};\n\nexport default Inventory;\n","path":null,"size_bytes":25965,"size_tokens":null},"client/src/components/common/SearchableDropdown.tsx":{"content":"import React, { useState, useEffect, useRef } from 'react';\n\ninterface SearchableDropdownProps<T> {\n  options: T[];\n  value: string;\n  onChange: (value: string) => void;\n  placeholder?: string;\n  displayField: keyof T;\n  valueField: keyof T;\n  renderOption?: (option: T) => React.ReactNode;\n  className?: string;\n}\n\nconst SearchableDropdown = <T extends Record<string, any>>({ \n  options, \n  value, \n  onChange, \n  placeholder = \"Search...\",\n  displayField,\n  valueField,\n  renderOption,\n  className = \"\"\n}: SearchableDropdownProps<T>) => {\n  const [isOpen, setIsOpen] = useState(false);\n  const [searchTerm, setSearchTerm] = useState('');\n  const [filteredOptions, setFilteredOptions] = useState<T[]>(options);\n  const dropdownRef = useRef<HTMLDivElement>(null);\n  \n  useEffect(() => {\n    // Filter options based on search\n    const filtered = options.filter(option => {\n      const searchFields = [\n        option[displayField],\n        option[valueField],\n        option.id,\n        option.cropType,\n        option.cropName\n      ].filter(Boolean);\n      \n      return searchFields.some(field => \n        field?.toString().toLowerCase().includes(searchTerm.toLowerCase())\n      );\n    });\n    \n    setFilteredOptions(filtered);\n  }, [searchTerm, options, displayField, valueField]);\n  \n  // Close dropdown when clicking outside\n  useEffect(() => {\n    const handleClickOutside = (event: MouseEvent) => {\n      if (dropdownRef.current && !dropdownRef.current.contains(event.target as Node)) {\n        setIsOpen(false);\n      }\n    };\n    \n    document.addEventListener('mousedown', handleClickOutside);\n    return () => document.removeEventListener('mousedown', handleClickOutside);\n  }, []);\n  \n  const selectedOption = options.find(opt => opt[valueField] === value);\n  \n  return (\n    <div className={`searchable-dropdown ${className}`} ref={dropdownRef}>\n      <div \n        className=\"dropdown-header\"\n        onClick={() => setIsOpen(!isOpen)}\n      >\n        <span className=\"selected-value\">\n          {selectedOption ? String(selectedOption[displayField]) : placeholder}\n        </span>\n        <span className=\"dropdown-arrow\">{isOpen ? '‚ñ≤' : '‚ñº'}</span>\n      </div>\n      \n      {isOpen && (\n        <div className=\"dropdown-content\">\n          <input\n            type=\"text\"\n            className=\"dropdown-search\"\n            placeholder=\"Search trays...\"\n            value={searchTerm}\n            onChange={(e) => setSearchTerm(e.target.value)}\n            onClick={(e) => e.stopPropagation()}\n            autoFocus\n          />\n          \n          <div className=\"dropdown-options\">\n            {filteredOptions.length === 0 ? (\n              <div className=\"no-options\">No trays found</div>\n            ) : (\n              filteredOptions.map((option) => (\n                <div\n                  key={String(option[valueField])}\n                  className={`dropdown-option ${value === option[valueField] ? 'selected' : ''}`}\n                  onClick={() => {\n                    onChange(String(option[valueField]));\n                    setIsOpen(false);\n                    setSearchTerm('');\n                  }}\n                >\n                  {renderOption ? renderOption(option) : String(option[displayField])}\n                </div>\n              ))\n            )}\n          </div>\n        </div>\n      )}\n    </div>\n  );\n};\n\nexport default SearchableDropdown;","path":null,"size_bytes":3398,"size_tokens":null},"client/src/pages/TaskData.tsx":{"content":"import React, { useState } from \"react\";\nimport { SubTabNavigation } from \"@/components/SubTabNavigation\";\nimport { TaskOverview } from \"@/components/TaskOverview\";\nimport { TaskAnalytics } from \"@/components/TaskAnalytics\";\nimport { useLocation } from \"@/contexts/LocationContext\";\nimport { getStoredAuth } from \"@/lib/auth\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { AlertTriangle } from \"lucide-react\";\n\nconst TaskData: React.FC = () => {\n  const [activeTab, setActiveTab] = useState('overview');\n  const { currentLocation, isViewingAllLocations } = useLocation();\n  const auth = getStoredAuth();\n  const isManager = auth.user?.role === 'manager' || auth.user?.role === 'corporate';\n  \n  const tabs = [\n    { id: 'overview', label: 'Overview', icon: 'üìä' },\n    { id: 'analytics', label: 'Analytics', icon: 'üìà' },\n    { id: 'costs', label: 'Cost Analysis', icon: 'üí∞' }\n  ];\n  \n  if (!isManager) {\n    return (\n      <div className=\"flex items-center justify-center h-64\">\n        <Card className=\"w-full max-w-md\">\n          <CardContent className=\"flex flex-col items-center justify-center p-6\">\n            <AlertTriangle className=\"h-12 w-12 text-red-500 mb-4\" />\n            <h2 className=\"text-xl font-semibold mb-2\">Access Denied</h2>\n            <p className=\"text-gray-600 text-center\">\n              This page is only available to managers and corporate users.\n            </p>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n  \n  return (\n    <div className=\"task-data-page\">\n      {/* Navigation and Actions on same line */}\n      <div className=\"nav-with-actions\">\n        <SubTabNavigation \n          tabs={tabs}\n          activeTab={activeTab}\n          onTabChange={setActiveTab}\n        />\n        \n        <div className=\"nav-actions\">\n          <button className=\"btn-export\">\n            üìä Export Task Report\n          </button>\n        </div>\n      </div>\n      \n      <div className=\"tab-content\">\n        {activeTab === 'overview' && <TaskOverview />}\n        {activeTab === 'analytics' && <TaskAnalytics />}\n        {activeTab === 'costs' && <div className=\"p-8 text-center text-gray-500\">Cost Analysis coming soon...</div>}\n      </div>\n    </div>\n  );\n};\n\nexport default TaskData;","path":null,"size_bytes":2261,"size_tokens":null},"client/src/components/ui/popover.tsx":{"content":"import * as React from \"react\"\nimport * as PopoverPrimitive from \"@radix-ui/react-popover\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Popover = PopoverPrimitive.Root\n\nconst PopoverTrigger = PopoverPrimitive.Trigger\n\nconst PopoverContent = React.forwardRef<\n  React.ElementRef<typeof PopoverPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof PopoverPrimitive.Content>\n>(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\n  <PopoverPrimitive.Portal>\n    <PopoverPrimitive.Content\n      ref={ref}\n      align={align}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-popover-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </PopoverPrimitive.Portal>\n))\nPopoverContent.displayName = PopoverPrimitive.Content.displayName\n\nexport { Popover, PopoverTrigger, PopoverContent }\n","path":null,"size_bytes":1280,"size_tokens":null},"client/src/services/courseService.ts":{"content":"import { apiRequest } from \"@/lib/queryClient\";\n\nexport interface Course {\n  id: number;\n  title: string;\n  description: string;\n  roleAwarded: string;\n  sections: number;\n  estimatedTime: string;\n  status: 'not-started' | 'in-progress' | 'completed';\n  progress: number;\n  completedDate?: string;\n  icon: string;\n  requiresApproval?: boolean;\n  prerequisites?: {\n    courses: number[];\n    requirements: {\n      type: 'age' | 'tenure' | 'license' | 'certification';\n      value: number | string;\n      label: string;\n    }[];\n  };\n  assignedBy?: string;\n  assignedDate?: string;\n  dueDate?: string;\n  priority?: 'low' | 'normal' | 'high';\n  sectionDetails?: {\n    title: string;\n    type: string;\n    content: string;\n  }[];\n  createdBy?: string;\n  createdAt?: string;\n}\n\n// Central course database (would eventually be moved to backend database)\nlet coursesDatabase: Course[] = [\n  {\n    id: 1,\n    title: 'Basic Safety & Orientation',\n    description: 'Introduction to farm safety procedures and basic orientation',\n    roleAwarded: 'General Staff',\n    sections: 3,\n    estimatedTime: '20 minutes',\n    status: 'not-started',\n    progress: 0,\n    icon: 'üõ°Ô∏è',\n    sectionDetails: [\n      {\n        title: 'Farm Safety Overview',\n        type: 'text',\n        content: 'Welcome to Grow Space Vertical Farms! This course covers essential safety procedures and farm orientation.'\n      },\n      {\n        title: 'Emergency Procedures',\n        type: 'text', \n        content: 'Learn about emergency exits, first aid locations, and emergency contact procedures.'\n      },\n      {\n        title: 'Basic Equipment Safety',\n        type: 'text',\n        content: 'Understanding proper use of basic farm equipment and safety protocols.'\n      }\n    ]\n  },\n  {\n    id: 2,\n    title: 'Seeding Technician Certification',\n    description: 'Complete training for seeding operations and microgreen cultivation',\n    roleAwarded: 'Seeding Tech',\n    sections: 4,\n    estimatedTime: '45 minutes',\n    status: 'not-started',\n    progress: 0,\n    icon: 'üå±',\n    prerequisites: {\n      courses: [1],\n      requirements: []\n    },\n    sectionDetails: [\n      {\n        title: 'Seeding Fundamentals',\n        type: 'text',\n        content: 'Learn proper seeding techniques for microgreens and optimal growing conditions.'\n      },\n      {\n        title: 'Seed Selection & Storage',\n        type: 'text',\n        content: 'Understanding different seed varieties and proper storage methods.'\n      },\n      {\n        title: 'Tray Preparation',\n        type: 'text',\n        content: 'Proper tray cleaning, medium preparation, and setup procedures.'\n      },\n      {\n        title: 'Quality Control',\n        type: 'text',\n        content: 'Monitoring seed germination rates and identifying potential issues.'\n      }\n    ]\n  },\n  {\n    id: 3,\n    title: 'Harvest Operations Training',\n    description: 'Learn proper harvesting techniques and quality control',\n    roleAwarded: 'Harvest Tech',\n    sections: 3,\n    estimatedTime: '35 minutes',\n    status: 'not-started',\n    progress: 0,\n    icon: 'üåæ',\n    prerequisites: {\n      courses: [1],\n      requirements: []\n    },\n    sectionDetails: [\n      {\n        title: 'Harvest Timing',\n        type: 'text',\n        content: 'Understanding optimal harvest timing for different crops and quality indicators.'\n      },\n      {\n        title: 'Harvesting Techniques',\n        type: 'text',\n        content: 'Proper cutting techniques, handling, and post-harvest procedures.'\n      },\n      {\n        title: 'Quality Assessment',\n        type: 'text',\n        content: 'Grading standards and quality control measures for harvested products.'\n      }\n    ]\n  },\n  {\n    id: 4,\n    title: 'Equipment Operation & Maintenance',\n    description: 'Training on equipment operation, maintenance, and troubleshooting',\n    roleAwarded: 'Equipment Tech',\n    sections: 5,\n    estimatedTime: '60 minutes',\n    status: 'not-started',\n    progress: 0,\n    icon: '‚öôÔ∏è',\n    prerequisites: {\n      courses: [1],\n      requirements: [\n        { type: 'tenure', value: 90, label: 'Employed for at least 3 months' }\n      ]\n    },\n    sectionDetails: [\n      {\n        title: 'Equipment Overview',\n        type: 'text',\n        content: 'Introduction to various equipment used in vertical farming operations.'\n      },\n      {\n        title: 'Operation Procedures',\n        type: 'text',\n        content: 'Step-by-step operating procedures for each piece of equipment.'\n      },\n      {\n        title: 'Preventive Maintenance',\n        type: 'text',\n        content: 'Regular maintenance schedules and procedures to prevent equipment failure.'\n      },\n      {\n        title: 'Troubleshooting',\n        type: 'text',\n        content: 'Common issues and troubleshooting steps for equipment problems.'\n      },\n      {\n        title: 'Safety Protocols',\n        type: 'text',\n        content: 'Safety procedures specific to equipment operation and maintenance.'\n      }\n    ]\n  },\n  {\n    id: 5,\n    title: 'Cleaning & Sanitation Procedures',\n    description: 'Comprehensive cleaning protocols and sanitation standards',\n    roleAwarded: 'Cleaning Crew',\n    sections: 2,\n    estimatedTime: '25 minutes',\n    status: 'not-started',\n    progress: 0,\n    icon: 'üßΩ',\n    prerequisites: {\n      courses: [1],\n      requirements: []\n    },\n    sectionDetails: [\n      {\n        title: 'Sanitation Standards',\n        type: 'text',\n        content: 'Understanding food safety requirements and sanitation standards for vertical farms.'\n      },\n      {\n        title: 'Cleaning Procedures',\n        type: 'text',\n        content: 'Step-by-step cleaning procedures for growing systems, equipment, and work areas.'\n      }\n    ]\n  },\n  {\n    id: 6,\n    title: 'Packaging & Quality Control',\n    description: 'Learn packaging standards and quality control procedures',\n    roleAwarded: 'Packaging Tech',\n    sections: 3,\n    estimatedTime: '40 minutes',\n    status: 'not-started',\n    progress: 0,\n    icon: 'üì¶',\n    prerequisites: {\n      courses: [1, 3],\n      requirements: []\n    },\n    sectionDetails: [\n      {\n        title: 'Packaging Standards',\n        type: 'text',\n        content: 'Understanding packaging requirements and standards for different products.'\n      },\n      {\n        title: 'Quality Control Checks',\n        type: 'text',\n        content: 'Quality control procedures and documentation requirements.'\n      },\n      {\n        title: 'Labeling & Traceability',\n        type: 'text',\n        content: 'Proper labeling procedures and traceability requirements.'\n      }\n    ]\n  },\n  {\n    id: 7,\n    title: 'Management Fundamentals',\n    description: 'Leadership training for supervisory roles',\n    roleAwarded: 'Team Lead',\n    sections: 4,\n    estimatedTime: '90 minutes',\n    status: 'not-started',\n    progress: 0,\n    icon: 'üëî',\n    requiresApproval: true,\n    prerequisites: {\n      courses: [2, 3, 6],\n      requirements: [\n        { type: 'tenure', value: 180, label: 'Employed for at least 6 months' }\n      ]\n    },\n    sectionDetails: [\n      {\n        title: 'Leadership Principles',\n        type: 'text',\n        content: 'Fundamental leadership concepts and management principles.'\n      },\n      {\n        title: 'Team Management',\n        type: 'text',\n        content: 'Effective team management strategies and communication techniques.'\n      },\n      {\n        title: 'Performance Monitoring',\n        type: 'text',\n        content: 'Methods for monitoring team performance and providing feedback.'\n      },\n      {\n        title: 'Problem Resolution',\n        type: 'text',\n        content: 'Conflict resolution and problem-solving strategies for managers.'\n      }\n    ]\n  }\n];\n\n// User progress tracking (would eventually be in backend database)\nlet userProgressDatabase: Record<number, Record<number, {\n  completedSections: number[];\n  startedAt: Date;\n  completedAt?: Date;\n  status: 'not-started' | 'in-progress' | 'completed';\n}>> = {};\n\nexport const courseService = {\n  // Get all courses\n  getAllCourses: (): Course[] => {\n    return coursesDatabase;\n  },\n  \n  // Get courses for specific user (for now, return all - would filter by assignments in backend)\n  getUserCourses: (userId: number): Course[] => {\n    const userProgress = userProgressDatabase[userId] || {};\n    \n    return coursesDatabase.map(course => {\n      const progress = userProgress[course.id];\n      return {\n        ...course,\n        status: progress?.status || 'not-started',\n        progress: progress?.completedSections?.length || 0,\n        completedDate: progress?.completedAt?.toISOString()\n      };\n    });\n  },\n  \n  // Get user's progress for a specific course\n  getUserProgress: (userId: number, courseId: number) => {\n    return userProgressDatabase[userId]?.[courseId];\n  },\n  \n  // Update progress for a course section\n  updateProgress: (userId: number, courseId: number, sectionIndex: number) => {\n    if (!userProgressDatabase[userId]) {\n      userProgressDatabase[userId] = {};\n    }\n    if (!userProgressDatabase[userId][courseId]) {\n      userProgressDatabase[userId][courseId] = {\n        completedSections: [],\n        startedAt: new Date(),\n        status: 'in-progress'\n      };\n    }\n    \n    const progress = userProgressDatabase[userId][courseId];\n    if (!progress.completedSections.includes(sectionIndex)) {\n      progress.completedSections.push(sectionIndex);\n    }\n    \n    // Check if course is complete\n    const course = coursesDatabase.find(c => c.id === courseId);\n    if (course && progress.completedSections.length === course.sections) {\n      progress.status = 'completed';\n      progress.completedAt = new Date();\n      \n      // Call backend to assign role\n      return courseService.completeCourse(userId, courseId, course.roleAwarded);\n    }\n    \n    return Promise.resolve(progress);\n  },\n  \n  // Complete course and assign role via backend\n  completeCourse: async (userId: number, courseId: number, roleAwarded: string) => {\n    try {\n      const response = await apiRequest('POST', `/api/courses/${courseId}/complete`, {\n        userId,\n        roleAwarded\n      });\n      \n      console.log('Course completion response:', response);\n      return response;\n    } catch (error) {\n      console.error('Failed to complete course:', error);\n      throw error;\n    }\n  },\n  \n  // Create/update course (Corporate Manager only)\n  saveCourse: (course: Omit<Course, 'id' | 'status' | 'progress'> & { id?: number }): Course => {\n    if (course.id) {\n      // Update existing course\n      const index = coursesDatabase.findIndex(c => c.id === course.id);\n      if (index >= 0) {\n        coursesDatabase[index] = {\n          ...course,\n          status: coursesDatabase[index].status,\n          progress: coursesDatabase[index].progress,\n          createdAt: coursesDatabase[index].createdAt\n        } as Course;\n        return coursesDatabase[index];\n      }\n    }\n    \n    // Create new course\n    const newCourse: Course = {\n      ...course,\n      id: Date.now(),\n      status: 'not-started',\n      progress: 0,\n      createdAt: new Date().toISOString()\n    };\n    coursesDatabase.push(newCourse);\n    return newCourse;\n  },\n  \n  // Delete course\n  deleteCourse: (courseId: number): boolean => {\n    const index = coursesDatabase.findIndex(c => c.id === courseId);\n    if (index >= 0) {\n      coursesDatabase.splice(index, 1);\n      return true;\n    }\n    return false;\n  }\n};","path":null,"size_bytes":11455,"size_tokens":null},"client/src/hooks/use-mobile.tsx":{"content":"import * as React from \"react\"\n\nconst MOBILE_BREAKPOINT = 768\n\nexport function useIsMobile() {\n  const [isMobile, setIsMobile] = React.useState<boolean | undefined>(undefined)\n\n  React.useEffect(() => {\n    const mql = window.matchMedia(`(max-width: ${MOBILE_BREAKPOINT - 1}px)`)\n    const onChange = () => {\n      setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    }\n    mql.addEventListener(\"change\", onChange)\n    setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    return () => mql.removeEventListener(\"change\", onChange)\n  }, [])\n\n  return !!isMobile\n}\n\nexport const useMobile = useIsMobile\n","path":null,"size_bytes":603,"size_tokens":null},"client/src/components/CourseModal.tsx":{"content":"import React, { useState, useEffect } from \"react\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription } from \"@/components/ui/dialog\";\nimport { Button } from \"@/components/ui/button\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { CheckCircle, X, Play, ArrowRight } from \"lucide-react\";\nimport { courseService } from \"@/services/courseService\";\nimport { getStoredAuth } from \"@/lib/auth\";\n\ninterface Course {\n  id: number;\n  title: string;\n  description: string;\n  roleAwarded: string;\n  sections: number;\n  estimatedTime: string;\n  status: 'not-started' | 'in-progress' | 'completed';\n  progress: number;\n  completedDate?: string;\n  icon: string;\n  requiresApproval?: boolean;\n}\n\ninterface CourseModalProps {\n  course: Course;\n  isOpen: boolean;\n  onClose: () => void;\n  onComplete: (courseId: number) => void;\n}\n\nconst CourseModal: React.FC<CourseModalProps> = ({ course, isOpen, onClose, onComplete }) => {\n  const [currentSection, setCurrentSection] = useState(0);\n  const [sectionCompleted, setSectionCompleted] = useState(false);\n  const auth = getStoredAuth();\n  const currentUser = auth.user;\n  \n  // Update current section when course changes\n  useEffect(() => {\n    if (course && currentUser) {\n      const userProgress = courseService.getUserProgress(currentUser.id, course.id);\n      const completedSections = userProgress?.completedSections || [];\n      setCurrentSection(completedSections.length);\n      setSectionCompleted(false);\n    }\n  }, [course, currentUser]);\n\n  // Helper functions for video URLs\n  const isYouTubeUrl = (url: string) => {\n    return url.includes('youtube.com/watch') || url.includes('youtu.be/');\n  };\n\n  const getYouTubeEmbedUrl = (url: string) => {\n    let videoId = '';\n    if (url.includes('youtube.com/watch')) {\n      videoId = url.split('v=')[1]?.split('&')[0];\n    } else if (url.includes('youtu.be/')) {\n      videoId = url.split('youtu.be/')[1]?.split('?')[0];\n    }\n    return `https://www.youtube.com/embed/${videoId}`;\n  };\n\n  const isVimeoUrl = (url: string) => {\n    return url.includes('vimeo.com/');\n  };\n\n  const getVimeoEmbedUrl = (url: string) => {\n    const videoId = url.split('vimeo.com/')[1]?.split('?')[0];\n    return `https://player.vimeo.com/video/${videoId}`;\n  };\n\n  // Render rich text content with embedded media\n  const renderRichContent = (content: string) => {\n    if (!content) return null;\n    \n    // Split content by media tags\n    const parts = content.split(/(\\[\\[IMAGE:.*?\\]\\]|\\[\\[VIDEO:.*?\\]\\])/);\n    \n    return parts.map((part, index) => {\n      if (part.startsWith('[[IMAGE:')) {\n        const url = part.match(/\\[\\[IMAGE:(.*?)\\]\\]/)?.[1];\n        return url ? (\n          <img \n            key={index} \n            src={url} \n            alt=\"Embedded\" \n            className=\"max-w-full h-auto my-3 rounded-lg\"\n            onError={(e) => {\n              (e.target as HTMLImageElement).src = 'https://via.placeholder.com/400x300?text=Image+Not+Found';\n            }}\n          />\n        ) : null;\n      } else if (part.startsWith('[[VIDEO:')) {\n        const url = part.match(/\\[\\[VIDEO:(.*?)\\]\\]/)?.[1];\n        if (!url) return null;\n        \n        if (isYouTubeUrl(url)) {\n          return (\n            <iframe\n              key={index}\n              src={getYouTubeEmbedUrl(url)}\n              className=\"w-full h-96 my-3 rounded-lg\"\n              frameBorder=\"0\"\n              allowFullScreen\n            />\n          );\n        } else if (isVimeoUrl(url)) {\n          return (\n            <iframe\n              key={index}\n              src={getVimeoEmbedUrl(url)}\n              className=\"w-full h-96 my-3 rounded-lg\"\n              frameBorder=\"0\"\n              allowFullScreen\n            />\n          );\n        } else {\n          return (\n            <video key={index} controls className=\"w-full my-3 rounded-lg\">\n              <source src={url} />\n            </video>\n          );\n        }\n      } else {\n        return <p key={index} className=\"mb-3\">{part}</p>;\n      }\n    });\n  };\n  \n  if (!course) return null;\n  \n  const totalSections = course.sections;\n  const isLastSection = currentSection === totalSections - 1;\n\n  const handleNext = async () => {\n    if (!currentUser) return;\n    \n    if (sectionCompleted) {\n      // Update progress in central service\n      try {\n        await courseService.updateProgress(currentUser.id, course.id, currentSection);\n        \n        if (isLastSection) {\n          // Course will be completed by the service, which calls onComplete\n          onComplete(course.id);\n        } else {\n          setCurrentSection(currentSection + 1);\n          setSectionCompleted(false);\n        }\n      } catch (error) {\n        console.error('Failed to update course progress:', error);\n        alert('Failed to save progress. Please try again.');\n      }\n    }\n  };\n\n  const getSectionTitle = (courseId: number, sectionIndex: number) => {\n    // Get section details from course data if available\n    if (course.sectionDetails && course.sectionDetails[sectionIndex]) {\n      return course.sectionDetails[sectionIndex].title;\n    }\n    return `Section ${sectionIndex + 1}`;\n  };\n  \n  const getSectionContent = (courseId: number, sectionIndex: number) => {\n    // Get section content from course data if available\n    if (course.sectionDetails && course.sectionDetails[sectionIndex]) {\n      return course.sectionDetails[sectionIndex].content;\n    }\n    return 'Course content will be available here.';\n  };\n\n  const renderSectionForViewing = (section: any) => {\n    if (!section) return null;\n    \n    switch (section.type) {\n      case 'video':\n        if (isYouTubeUrl(section.content)) {\n          return (\n            <iframe\n              src={getYouTubeEmbedUrl(section.content)}\n              className=\"w-full h-96 rounded-lg\"\n              frameBorder=\"0\"\n              allowFullScreen\n            />\n          );\n        } else if (isVimeoUrl(section.content)) {\n          return (\n            <iframe\n              src={getVimeoEmbedUrl(section.content)}\n              className=\"w-full h-96 rounded-lg\"\n              frameBorder=\"0\"\n              allowFullScreen\n            />\n          );\n        } else {\n          return (\n            <video className=\"w-full rounded-lg\" controls>\n              <source src={section.content} />\n              Your browser does not support video.\n            </video>\n          );\n        }\n        \n      case 'image':\n        return (\n          <div className=\"text-center\">\n            <img \n              src={section.content} \n              alt={section.title} \n              className=\"max-w-full h-auto rounded-lg mx-auto\"\n              onError={(e) => {\n                (e.target as HTMLImageElement).src = 'https://via.placeholder.com/400x300?text=Image+Not+Found';\n              }}\n            />\n            {section.caption && (\n              <p className=\"text-center italic text-gray-600 mt-2\">{section.caption}</p>\n            )}\n          </div>\n        );\n        \n      case 'rich-text':\n        return (\n          <div className=\"prose max-w-none\">\n            {renderRichContent(section.content)}\n          </div>\n        );\n        \n      case 'quiz':\n        return (\n          <div className=\"space-y-4\">\n            <p className=\"text-lg font-semibold\">{section.content}</p>\n            <div className=\"space-y-2\">\n              {['A', 'B', 'C', 'D'].map(option => (\n                <label key={option} className=\"flex items-center p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100\">\n                  <input\n                    type=\"radio\"\n                    name={`quiz-${section.id}`}\n                    value={option}\n                    className=\"mr-3\"\n                  />\n                  <span>{section[`option${option}`]}</span>\n                </label>\n              ))}\n            </div>\n          </div>\n        );\n        \n      case 'checklist':\n        const items = section.content.split('\\n').filter((item: string) => item.trim());\n        return (\n          <div className=\"space-y-2\">\n            {items.map((item: string, idx: number) => (\n              <label key={idx} className=\"flex items-center p-2 rounded cursor-pointer hover:bg-gray-50\">\n                <input type=\"checkbox\" className=\"mr-3\" />\n                <span>{item.replace(/^‚òê\\s*/, '')}</span>\n              </label>\n            ))}\n          </div>\n        );\n        \n      default:\n        return <div className=\"whitespace-pre-wrap\">{section.content}</div>;\n    }\n  };\n\n  const progressPercentage = ((currentSection + (sectionCompleted ? 1 : 0)) / totalSections) * 100;\n\n  return (\n    <Dialog open={isOpen} onOpenChange={onClose}>\n      <DialogContent className=\"max-w-4xl max-h-[90vh] overflow-y-auto\">\n        <DialogHeader>\n          <div className=\"flex items-center justify-between\">\n            <div className=\"flex items-center gap-3\">\n              <span className=\"text-2xl\">{course.icon}</span>\n              <div>\n                <DialogTitle className=\"text-xl text-[#203B17]\">\n                  {course.title}\n                </DialogTitle>\n                <DialogDescription>\n                  Section {currentSection + 1} of {totalSections}\n                </DialogDescription>\n              </div>\n            </div>\n            <Button variant=\"ghost\" size=\"sm\" onClick={onClose}>\n              <X className=\"h-4 w-4\" />\n            </Button>\n          </div>\n        </DialogHeader>\n\n        <div className=\"space-y-6\">\n          {/* Progress Bar */}\n          <div className=\"space-y-2\">\n            <div className=\"flex justify-between text-sm\">\n              <span>Course Progress</span>\n              <span>{Math.round(progressPercentage)}% Complete</span>\n            </div>\n            <Progress value={progressPercentage} className=\"h-2\" />\n          </div>\n\n          {/* Section Indicators */}\n          <div className=\"flex justify-center gap-2\">\n            {Array.from({ length: totalSections }, (_, i) => (\n              <div\n                key={i}\n                className={`w-3 h-3 rounded-full ${\n                  i < currentSection ? 'bg-green-500' : \n                  i === currentSection ? 'bg-blue-500' : \n                  'bg-gray-300'\n                }`}\n              />\n            ))}\n          </div>\n\n          {/* Section Content */}\n          <Card>\n            <CardContent className=\"p-6\">\n              <div className=\"space-y-4\">\n                <div className=\"flex items-center gap-2 mb-4\">\n                  <Play className=\"h-5 w-5 text-[#2D8028]\" />\n                  <h3 className=\"text-lg font-semibold text-[#203B17]\">\n                    {getSectionTitle(course.id, currentSection)}\n                  </h3>\n                </div>\n                \n                <div className=\"space-y-6\">\n                  {/* Actual course section content */}\n                  <div className=\"bg-gray-50 p-4 rounded-lg\">\n                    <div className=\"bg-white p-4 rounded-lg mb-4\">\n                      <h4 className=\"font-semibold mb-3\">Section Content:</h4>\n                      {course.sectionDetails && course.sectionDetails[currentSection] ? (\n                        renderSectionForViewing(course.sectionDetails[currentSection])\n                      ) : (\n                        <div className=\"text-gray-600\">\n                          <p className=\"mb-4\">\n                            This section covers essential knowledge and skills for the {course.roleAwarded} role.\n                          </p>\n                          <p>{getSectionContent(course.id, currentSection)}</p>\n                        </div>\n                      )}\n                    </div>\n\n                    <div className=\"mt-6 p-4 bg-blue-50 rounded-lg\">\n                      <div className=\"flex items-center gap-2 mb-2\">\n                        <CheckCircle className=\"h-5 w-5 text-blue-600\" />\n                        <span className=\"font-medium text-blue-800\">Section Review</span>\n                      </div>\n                      <p className=\"text-sm text-blue-700 mb-3\">\n                        Please confirm you have reviewed all materials in this section.\n                      </p>\n                      <label className=\"flex items-center gap-2 cursor-pointer\">\n                        <input\n                          type=\"checkbox\"\n                          checked={sectionCompleted}\n                          onChange={(e) => setSectionCompleted(e.target.checked)}\n                          className=\"rounded border-gray-300\"\n                        />\n                        <span className=\"text-sm text-blue-800\">\n                          I have completed this section\n                        </span>\n                      </label>\n                    </div>\n                  </div>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n\n          {/* Action Buttons */}\n          <div className=\"flex justify-between items-center pt-4\">\n            <Button \n              variant=\"outline\" \n              onClick={onClose}\n              className=\"flex items-center gap-2\"\n            >\n              Save & Exit\n            </Button>\n            \n            <Button\n              onClick={handleNext}\n              disabled={!sectionCompleted}\n              className={`flex items-center gap-2 ${\n                isLastSection ? 'bg-green-600 hover:bg-green-700' : 'bg-[#2D8028] hover:bg-[#203B17]'\n              }`}\n            >\n              {isLastSection ? (\n                <>\n                  <CheckCircle className=\"h-4 w-4\" />\n                  Complete Course\n                </>\n              ) : (\n                <>\n                  Next Section\n                  <ArrowRight className=\"h-4 w-4\" />\n                </>\n              )}\n            </Button>\n          </div>\n        </div>\n      </DialogContent>\n    </Dialog>\n  );\n};\n\nexport default CourseModal;","path":null,"size_bytes":14012,"size_tokens":null},"client/src/services/trayService.ts":{"content":"// Tray service for managing production trays - NOW USING API\nimport { trayApiService, type ProductionTray } from './trayApiService';\n\nexport { type ProductionTray } from './trayApiService';\n\nexport const TrayService = {\n  // Get all trays from API\n  async getAllTrays(): Promise<ProductionTray[]> {\n    return await trayApiService.getAllTrays();\n  },\n\n  // Get all active trays (not split, not harvested)\n  async getActiveTrays(): Promise<ProductionTray[]> {\n    const trays = await this.getAllTrays();\n    \n    // Filter for active trays only\n    return trays.filter(tray => \n      (tray.status === 'active' || \n       tray.status === 'growing' ||\n       !tray.status) && // Default to active if no status\n      !tray.harvestedAt && \n      !tray.splitFrom // Don't show trays that are already splits\n    );\n  },\n  \n  // Search trays by ID or crop type\n  async searchTrays(searchTerm: string): Promise<ProductionTray[]> {\n    const activeTrays = await this.getActiveTrays();\n    const term = searchTerm.toLowerCase();\n    \n    return activeTrays.filter(tray => \n      tray.id.toLowerCase().includes(term) ||\n      tray.cropType?.toLowerCase().includes(term) ||\n      tray.cropName?.toLowerCase().includes(term)\n    );\n  },\n\n  // Split tray\n  async splitTray(originalTrayId: string, splitCount: number): Promise<ProductionTray[] | null> {\n    return await trayApiService.splitTray(originalTrayId, splitCount);\n  },\n\n  // Create new tray\n  async createTray(trayData: Partial<ProductionTray>): Promise<ProductionTray> {\n    return await trayApiService.createTray(trayData);\n  },\n\n  // Update tray data\n  async updateTray(trayId: string, updates: Partial<ProductionTray>): Promise<ProductionTray | null> {\n    return await trayApiService.updateTray(trayId, updates);\n  },\n\n  // Delete tray\n  async deleteTray(trayId: string): Promise<boolean> {\n    return await trayApiService.deleteTray(trayId);\n  },\n\n  // Update tray location (for movement operations)\n  async updateTrayLocation(trayId: string, newLocation: string, systemId?: string): Promise<ProductionTray | null> {\n    return await trayApiService.updateTrayLocation(trayId, newLocation, systemId);\n  },\n\n  // Create tray from seeding task\n  async createTrayFromSeeding(taskData: any): Promise<ProductionTray> {\n    return await trayApiService.createTrayFromSeeding(taskData);\n  },\n\n  // Generate unique tray ID\n  generateTrayId(cropType: string): string {\n    return trayApiService.generateTrayId(cropType);\n  }\n};\n\n// Legacy support - alias for compatibility\nexport const trayService = TrayService;","path":null,"size_bytes":2553,"size_tokens":null},"client/src/components/SystemVisualizer.tsx":{"content":"import React from 'react';\nimport { GrowingSystem } from '@shared/schema';\n\nexport const SystemVisualizer: React.FC<{ system: GrowingSystem }> = ({ system }) => {\n  const occupancyPercent = Math.round((system.currentOccupancy / system.capacity) * 100);\n  \n  if (system.type === 'nursery' || system.type === 'blackout') {\n    // Simple staging area visualization\n    return (\n      <div className=\"system-viz staging bg-gray-50 p-3 rounded-lg\">\n        <div className=\"flex flex-wrap gap-1\">\n          {Array(Math.min(system.currentOccupancy, 16)).fill(0).map((_, i) => (\n            <div \n              key={i} \n              className=\"w-4 h-4 bg-green-500 rounded-sm\"\n              title=\"Occupied spot\"\n            />\n          ))}\n          {Array(Math.min(system.capacity - system.currentOccupancy, 16 - Math.min(system.currentOccupancy, 16))).fill(0).map((_, i) => (\n            <div \n              key={`empty-${i}`} \n              className=\"w-4 h-4 bg-gray-200 rounded-sm border border-gray-300\"\n              title=\"Empty spot\"\n            />\n          ))}\n          {system.currentOccupancy > 16 && (\n            <div className=\"text-xs text-gray-500 mt-1\">\n              +{system.currentOccupancy - 16} more\n            </div>\n          )}\n        </div>\n      </div>\n    );\n  }\n\n  if (system.type === 'ebbFlow') {\n    // Ebb & Flow visualization\n    return (\n      <div className=\"system-viz ebb-flow bg-blue-50 p-3 rounded-lg\">\n        <div className=\"grid grid-cols-6 gap-1\">\n          {Array(Math.min(system.capacity, 24)).fill(0).map((_, i) => (\n            <div \n              key={i} \n              className={`w-4 h-4 rounded-sm ${\n                i < system.currentOccupancy \n                  ? 'bg-blue-500' \n                  : 'bg-gray-200 border border-gray-300'\n              }`}\n              title={i < system.currentOccupancy ? 'Occupied' : 'Empty'}\n            />\n          ))}\n        </div>\n        {system.capacity > 24 && (\n          <div className=\"text-xs text-gray-500 mt-1 text-center\">\n            Showing 24 of {system.capacity} spots\n          </div>\n        )}\n      </div>\n    );\n  }\n\n  if (system.type === 'towers') {\n    // Tower visualization\n    const levels = Math.min(Math.ceil(system.capacity / 8), 6);\n    return (\n      <div className=\"system-viz tower bg-green-50 p-3 rounded-lg\">\n        <div className=\"flex flex-col-reverse space-y-1\">\n          {Array(levels).fill(0).map((_, levelIndex) => (\n            <div key={levelIndex} className=\"flex space-x-1\">\n              {Array(8).fill(0).map((_, spotIndex) => {\n                const spotNumber = levelIndex * 8 + spotIndex;\n                return (\n                  <div\n                    key={spotIndex}\n                    className={`w-3 h-3 rounded-sm ${\n                      spotNumber < system.currentOccupancy \n                        ? 'bg-green-500' \n                        : spotNumber < system.capacity \n                        ? 'bg-gray-200 border border-gray-300' \n                        : 'bg-transparent'\n                    }`}\n                    title={`Level ${levels - levelIndex}, Spot ${spotIndex + 1}`}\n                  />\n                );\n              })}\n            </div>\n          ))}\n        </div>\n        <div className=\"text-xs text-gray-500 mt-1 text-center\">\n          {levels} levels, {system.capacity} spots\n        </div>\n      </div>\n    );\n  }\n\n  if (system.type === 'nft') {\n    // NFT Channel visualization\n    const channels = Math.min(Math.ceil(system.capacity / 12), 4);\n    return (\n      <div className=\"system-viz nft bg-purple-50 p-3 rounded-lg\">\n        <div className=\"space-y-2\">\n          {Array(channels).fill(0).map((_, channelIndex) => (\n            <div key={channelIndex} className=\"flex space-x-1\">\n              {Array(12).fill(0).map((_, spotIndex) => {\n                const spotNumber = channelIndex * 12 + spotIndex;\n                return (\n                  <div\n                    key={spotIndex}\n                    className={`w-2 h-4 rounded-sm ${\n                      spotNumber < system.currentOccupancy \n                        ? 'bg-purple-500' \n                        : spotNumber < system.capacity \n                        ? 'bg-gray-200 border border-gray-300' \n                        : 'bg-transparent'\n                    }`}\n                    title={`Channel ${channelIndex + 1}, Spot ${spotIndex + 1}`}\n                  />\n                );\n              })}\n            </div>\n          ))}\n        </div>\n        <div className=\"text-xs text-gray-500 mt-1 text-center\">\n          {channels} channels\n        </div>\n      </div>\n    );\n  }\n\n  if (system.type === 'microgreens') {\n    // Microgreen rack visualization\n    return (\n      <div className=\"system-viz microgreens bg-yellow-50 p-3 rounded-lg\">\n        <div className=\"grid grid-cols-8 gap-1\">\n          {Array(Math.min(system.capacity, 32)).fill(0).map((_, i) => (\n            <div \n              key={i} \n              className={`w-3 h-3 rounded-sm ${\n                i < system.currentOccupancy \n                  ? 'bg-yellow-500' \n                  : 'bg-gray-200 border border-gray-300'\n              }`}\n              title={i < system.currentOccupancy ? 'Occupied tray' : 'Empty slot'}\n            />\n          ))}\n        </div>\n        {system.capacity > 32 && (\n          <div className=\"text-xs text-gray-500 mt-1 text-center\">\n            Showing 32 of {system.capacity} spots\n          </div>\n        )}\n      </div>\n    );\n  }\n\n  // Default visualization\n  return (\n    <div className=\"system-viz default bg-gray-50 p-3 rounded-lg\">\n      <div className=\"flex items-center justify-center space-x-2\">\n        <div className=\"w-6 h-6 bg-gray-300 rounded-full\" />\n        <div className=\"text-sm text-gray-600\">\n          {system.currentOccupancy} / {system.capacity}\n        </div>\n      </div>\n    </div>\n  );\n};","path":null,"size_bytes":5895,"size_tokens":null},"client/src/components/TraySplitInterface.tsx":{"content":"import React, { useState, useEffect } from 'react';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { Label } from '@/components/ui/label';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { Plus, Minus, Split, AlertTriangle } from 'lucide-react';\nimport { Tray } from '../data/trayTracking';\nimport { GrowingSystem } from '../data/systemsData';\nimport { findAvailableSpots } from '../utils/systemAvailability';\n\ninterface TraySplitInterfaceProps {\n  tray: Tray;\n  systems: GrowingSystem[];\n  onSplit: (splits: Array<{\n    systemId: string;\n    systemType: string;\n    spotIds: string[];\n    plantCount: number;\n  }>) => void;\n  onCancel: () => void;\n}\n\nexport const TraySplitInterface: React.FC<TraySplitInterfaceProps> = ({\n  tray,\n  systems,\n  onSplit,\n  onCancel\n}) => {\n  const [splits, setSplits] = useState<Array<{\n    id: string;\n    systemId: string;\n    systemType: string;\n    plantCount: number;\n    availableSpots: any[];\n  }>>([\n    { id: '1', systemId: '', systemType: 'towers', plantCount: 0, availableSpots: [] },\n    { id: '2', systemId: '', systemType: 'towers', plantCount: 0, availableSpots: [] }\n  ]);\n  \n  const totalPlants = tray.plantCount;\n  const allocatedPlants = splits.reduce((sum, split) => sum + split.plantCount, 0);\n  const remainingPlants = totalPlants - allocatedPlants;\n  \n  useEffect(() => {\n    // Update available spots for each split\n    const updatedSplits = splits.map(split => {\n      const spots = findAvailableSpots(\n        systems,\n        split.systemType,\n        split.plantCount || 1,\n        tray.cropType\n      );\n      return { ...split, availableSpots: spots };\n    });\n    setSplits(updatedSplits);\n  }, [splits.map(s => `${s.systemType}-${s.plantCount}`).join(','), systems, tray.cropType]);\n  \n  const handleAddSplit = () => {\n    setSplits([\n      ...splits,\n      {\n        id: Date.now().toString(),\n        systemId: '',\n        systemType: 'towers',\n        plantCount: 0,\n        availableSpots: []\n      }\n    ]);\n  };\n  \n  const handleRemoveSplit = (id: string) => {\n    setSplits(splits.filter(s => s.id !== id));\n  };\n  \n  const handleUpdateSplit = (id: string, field: string, value: any) => {\n    setSplits(splits.map(split =>\n      split.id === id ? { ...split, [field]: value } : split\n    ));\n  };\n  \n  const handleConfirmSplit = () => {\n    const validSplits = splits\n      .filter(s => s.systemId && s.plantCount > 0)\n      .map(split => {\n        const spot = split.availableSpots.find(a => a.systemId === split.systemId);\n        return {\n          systemId: split.systemId,\n          systemType: split.systemType,\n          spotIds: spot?.spotIds || [],\n          plantCount: split.plantCount\n        };\n      });\n    \n    onSplit(validSplits);\n  };\n  \n  const isValid = allocatedPlants === totalPlants && \n    splits.every(s => s.systemId && s.plantCount > 0);\n  \n  return (\n    <Card className=\"w-full max-w-4xl\">\n      <CardHeader className=\"pb-4\">\n        <CardTitle className=\"flex items-center gap-2\">\n          <Split className=\"w-5 h-5\" />\n          Split Tray: {tray.id}\n        </CardTitle>\n        <div className=\"flex items-center justify-between text-sm\">\n          <span>Total plants to distribute: <strong>{totalPlants}</strong></span>\n          <span className={`px-2 py-1 rounded ${\n            remainingPlants === 0 ? 'bg-green-100 text-green-800' : \n            remainingPlants > 0 ? 'bg-yellow-100 text-yellow-800' : \n            'bg-red-100 text-red-800'\n          }`}>\n            {remainingPlants > 0 ? `${remainingPlants} remaining` : \n             remainingPlants < 0 ? `${Math.abs(remainingPlants)} over-allocated` : \n             'Fully allocated'}\n          </span>\n        </div>\n      </CardHeader>\n      \n      <CardContent className=\"space-y-4\">\n        {splits.map((split, index) => (\n          <Card key={split.id} className=\"p-4\">\n            <div className=\"flex items-center justify-between mb-3\">\n              <h4 className=\"font-medium\">Destination {index + 1}</h4>\n              {splits.length > 2 && (\n                <Button\n                  variant=\"ghost\"\n                  size=\"sm\"\n                  onClick={() => handleRemoveSplit(split.id)}\n                  className=\"text-red-600 hover:text-red-700\"\n                >\n                  <Minus className=\"w-4 h-4\" />\n                </Button>\n              )}\n            </div>\n            \n            <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n              <div>\n                <Label>System Type</Label>\n                <Select\n                  value={split.systemType}\n                  onValueChange={(value) => handleUpdateSplit(split.id, 'systemType', value)}\n                >\n                  <SelectTrigger>\n                    <SelectValue placeholder=\"Select system type\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"towers\">Towers</SelectItem>\n                    <SelectItem value=\"nft\">NFT</SelectItem>\n                    <SelectItem value=\"ebbFlow\">Ebb & Flow</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n              \n              <div>\n                <Label>Plant Count</Label>\n                <Input\n                  type=\"number\"\n                  value={split.plantCount || ''}\n                  onChange={(e) => handleUpdateSplit(split.id, 'plantCount', parseInt(e.target.value) || 0)}\n                  placeholder=\"Enter plant count\"\n                  min=\"1\"\n                  max={totalPlants}\n                />\n              </div>\n              \n              <div>\n                <Label>Available Systems</Label>\n                <Select\n                  value={split.systemId}\n                  onValueChange={(value) => handleUpdateSplit(split.id, 'systemId', value)}\n                  disabled={split.availableSpots.length === 0}\n                >\n                  <SelectTrigger>\n                    <SelectValue placeholder=\"Select system\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {split.availableSpots.map((spot) => (\n                      <SelectItem key={spot.systemId} value={spot.systemId}>\n                        {spot.systemName} ({spot.availableSpots} spots)\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n            </div>\n            \n            {split.availableSpots.length === 0 && split.systemType && (\n              <div className=\"flex items-center gap-2 mt-2 text-amber-600 text-sm\">\n                <AlertTriangle className=\"w-4 h-4\" />\n                No available spots for {split.systemType} systems\n              </div>\n            )}\n          </Card>\n        ))}\n        \n        <div className=\"flex justify-between items-center pt-4\">\n          <Button\n            variant=\"outline\"\n            onClick={handleAddSplit}\n            className=\"flex items-center gap-2\"\n          >\n            <Plus className=\"w-4 h-4\" />\n            Add Destination\n          </Button>\n          \n          <div className=\"flex gap-2\">\n            <Button variant=\"outline\" onClick={onCancel}>\n              Cancel\n            </Button>\n            <Button\n              onClick={handleConfirmSplit}\n              disabled={!isValid}\n              className=\"bg-green-600 hover:bg-green-700\"\n            >\n              Confirm Split\n            </Button>\n          </div>\n        </div>\n      </CardContent>\n    </Card>\n  );\n};","path":null,"size_bytes":7740,"size_tokens":null},"client/src/components/NewTaskModal.tsx":{"content":"import React from \"react\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle } from \"@/components/ui/dialog\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { insertTaskSchema } from \"@shared/schema\";\nimport { z } from \"zod\";\nimport { useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { getStoredAuth } from \"@/lib/auth\";\n\ninterface NewTaskModalProps {\n  open: boolean;\n  onClose: () => void;\n}\n\nconst newTaskSchema = insertTaskSchema.extend({\n  dueDate: z.string().min(1, \"Due date is required\"),\n});\n\ntype NewTaskForm = z.infer<typeof newTaskSchema>;\n\nconst NewTaskModal: React.FC<NewTaskModalProps> = ({ open, onClose }) => {\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n  const auth = getStoredAuth();\n\n  const form = useForm<NewTaskForm>({\n    resolver: zodResolver(newTaskSchema),\n    defaultValues: {\n      title: \"\",\n      description: \"\",\n      type: \"seeding-microgreens\",\n      priority: \"medium\",\n      assignedTo: auth.user?.id || 1,\n      createdBy: auth.user?.id || 1,\n      estimatedTime: 60,\n      status: \"pending\",\n      progress: 0,\n      data: {},\n      checklist: [],\n    },\n  });\n\n  const createTaskMutation = useMutation({\n    mutationFn: async (taskData: NewTaskForm) => {\n      const { dueDate, ...rest } = taskData;\n      return await apiRequest(\"/api/tasks\", {\n        method: \"POST\",\n        body: JSON.stringify({\n          ...rest,\n          dueDate: new Date(dueDate).toISOString(),\n        }),\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/tasks\"] });\n      toast({\n        title: \"Task created!\",\n        description: \"The new task has been created successfully.\",\n      });\n      onClose();\n      form.reset();\n    },\n    onError: () => {\n      toast({\n        title: \"Error\",\n        description: \"Failed to create task. Please try again.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const onSubmit = (data: NewTaskForm) => {\n    createTaskMutation.mutate(data);\n  };\n\n  return (\n    <Dialog open={open} onOpenChange={onClose}>\n      <DialogContent className=\"max-w-2xl\">\n        <DialogHeader>\n          <DialogTitle>Create New Task</DialogTitle>\n        </DialogHeader>\n        \n        <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-4\">\n          <div className=\"grid grid-cols-2 gap-4\">\n            <div>\n              <Label htmlFor=\"title\">Task Title *</Label>\n              <Input\n                id=\"title\"\n                {...form.register(\"title\")}\n                placeholder=\"Enter task title\"\n              />\n              {form.formState.errors.title && (\n                <p className=\"text-sm text-red-600\">{form.formState.errors.title.message}</p>\n              )}\n            </div>\n            \n            <div>\n              <Label htmlFor=\"type\">Task Type *</Label>\n              <Select value={form.watch(\"type\")} onValueChange={(value) => form.setValue(\"type\", value)}>\n                <SelectTrigger>\n                  <SelectValue placeholder=\"Select task type\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"seeding-microgreens\">üå± Seeding - Microgreens</SelectItem>\n                  <SelectItem value=\"seeding-leafy-greens\">üåø Seeding - Leafy Greens</SelectItem>\n                  <SelectItem value=\"harvest-microgreens\">üåæ Harvest - Microgreens</SelectItem>\n                  <SelectItem value=\"harvest-leafy-greens\">ü•¨ Harvest - Leafy Greens</SelectItem>\n                  <SelectItem value=\"blackout-tasks\">üåë Blackout Tasks</SelectItem>\n                  <SelectItem value=\"moving\">üì¶ Moving</SelectItem>\n                  <SelectItem value=\"packing\">üì¶ Packing</SelectItem>\n                  <SelectItem value=\"cleaning\">üßπ Cleaning</SelectItem>\n                  <SelectItem value=\"inventory\">üìä Inventory</SelectItem>\n                  <SelectItem value=\"equipment-maintenance\">üîß Equipment Maintenance</SelectItem>\n                  <SelectItem value=\"other\">üìù Other</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n          </div>\n\n          <div>\n            <Label htmlFor=\"description\">Quick Info</Label>\n            <Input\n              id=\"description\"\n              {...form.register(\"description\")}\n              placeholder=\"Brief description shown on task card\"\n            />\n          </div>\n\n          <div>\n            <Label htmlFor=\"fullDescription\">Description</Label>\n            <Textarea\n              id=\"fullDescription\"\n              {...form.register(\"description\")}\n              placeholder=\"Full task description and details\"\n              rows={3}\n            />\n          </div>\n\n          <div className=\"grid grid-cols-2 gap-4\">\n            <div>\n              <Label htmlFor=\"priority\">Priority</Label>\n              <Select value={form.watch(\"priority\")} onValueChange={(value) => form.setValue(\"priority\", value)}>\n                <SelectTrigger>\n                  <SelectValue placeholder=\"Select priority\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"low\">Low</SelectItem>\n                  <SelectItem value=\"medium\">Medium</SelectItem>\n                  <SelectItem value=\"high\">High</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n\n            <div>\n              <Label htmlFor=\"estimatedTime\">Estimated Duration</Label>\n              <Input\n                id=\"estimatedTime\"\n                type=\"number\"\n                {...form.register(\"estimatedTime\", { valueAsNumber: true })}\n                placeholder=\"60\"\n              />\n              <p className=\"text-xs text-gray-500 mt-1\">Duration in minutes (e.g., 30 for 30 minutes, 120 for 2 hours)</p>\n            </div>\n\n            <div>\n              <Label htmlFor=\"dueDate\">Due Date *</Label>\n              <Input\n                id=\"dueDate\"\n                type=\"date\"\n                {...form.register(\"dueDate\")}\n              />\n              {form.formState.errors.dueDate && (\n                <p className=\"text-sm text-red-600\">{form.formState.errors.dueDate.message}</p>\n              )}\n            </div>\n          </div>\n\n          <div className=\"flex justify-end space-x-2 pt-4\">\n            <Button type=\"button\" variant=\"outline\" onClick={onClose}>\n              Cancel\n            </Button>\n            <Button \n              type=\"submit\" \n              disabled={createTaskMutation.isPending}\n              className=\"bg-[#2D8028] hover:bg-[#203B17]\"\n            >\n              {createTaskMutation.isPending ? \"Creating...\" : \"Create Task\"}\n            </Button>\n          </div>\n        </form>\n      </DialogContent>\n    </Dialog>\n  );\n};\n\nexport default NewTaskModal;","path":null,"size_bytes":7271,"size_tokens":null},"client/src/components/ui/dropdown-menu.tsx":{"content":"import * as React from \"react\"\nimport * as DropdownMenuPrimitive from \"@radix-ui/react-dropdown-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst DropdownMenu = DropdownMenuPrimitive.Root\n\nconst DropdownMenuTrigger = DropdownMenuPrimitive.Trigger\n\nconst DropdownMenuGroup = DropdownMenuPrimitive.Group\n\nconst DropdownMenuPortal = DropdownMenuPrimitive.Portal\n\nconst DropdownMenuSub = DropdownMenuPrimitive.Sub\n\nconst DropdownMenuRadioGroup = DropdownMenuPrimitive.RadioGroup\n\nconst DropdownMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto\" />\n  </DropdownMenuPrimitive.SubTrigger>\n))\nDropdownMenuSubTrigger.displayName =\n  DropdownMenuPrimitive.SubTrigger.displayName\n\nconst DropdownMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuSubContent.displayName =\n  DropdownMenuPrimitive.SubContent.displayName\n\nconst DropdownMenuContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <DropdownMenuPrimitive.Portal>\n    <DropdownMenuPrimitive.Content\n      ref={ref}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 max-h-[var(--radix-dropdown-menu-content-available-height)] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </DropdownMenuPrimitive.Portal>\n))\nDropdownMenuContent.displayName = DropdownMenuPrimitive.Content.displayName\n\nconst DropdownMenuItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuItem.displayName = DropdownMenuPrimitive.Item.displayName\n\nconst DropdownMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <DropdownMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.CheckboxItem>\n))\nDropdownMenuCheckboxItem.displayName =\n  DropdownMenuPrimitive.CheckboxItem.displayName\n\nconst DropdownMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.RadioItem>\n))\nDropdownMenuRadioItem.displayName = DropdownMenuPrimitive.RadioItem.displayName\n\nconst DropdownMenuLabel = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuLabel.displayName = DropdownMenuPrimitive.Label.displayName\n\nconst DropdownMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nDropdownMenuSeparator.displayName = DropdownMenuPrimitive.Separator.displayName\n\nconst DropdownMenuShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\"ml-auto text-xs tracking-widest opacity-60\", className)}\n      {...props}\n    />\n  )\n}\nDropdownMenuShortcut.displayName = \"DropdownMenuShortcut\"\n\nexport {\n  DropdownMenu,\n  DropdownMenuTrigger,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuCheckboxItem,\n  DropdownMenuRadioItem,\n  DropdownMenuLabel,\n  DropdownMenuSeparator,\n  DropdownMenuShortcut,\n  DropdownMenuGroup,\n  DropdownMenuPortal,\n  DropdownMenuSub,\n  DropdownMenuSubContent,\n  DropdownMenuSubTrigger,\n  DropdownMenuRadioGroup,\n}\n","path":null,"size_bytes":7609,"size_tokens":null},"client/src/components/ui/aspect-ratio.tsx":{"content":"import * as AspectRatioPrimitive from \"@radix-ui/react-aspect-ratio\"\n\nconst AspectRatio = AspectRatioPrimitive.Root\n\nexport { AspectRatio }\n","path":null,"size_bytes":140,"size_tokens":null},"client/src/services/trayDataService.ts":{"content":"import { Tray, sampleTrays } from '../data/trayTracking';\nimport { TrayDataApiService } from './trayApiService';\n\n// Shared service for managing tray data with API persistence\nclass TrayDataService {\n  \n  // Load trays from API\n  static async loadTrays(): Promise<Tray[]> {\n    return await TrayDataApiService.loadTrays();\n  }\n\n  // Save trays to API\n  static async saveTrays(trays: Tray[]): Promise<void> {\n    await TrayDataApiService.saveTrays(trays);\n    \n    // Dispatch event to notify other components\n    window.dispatchEvent(new CustomEvent('trayDataUpdated', { \n      detail: { trays } \n    }));\n  }\n\n  // Get filtered trays by query (location, system, etc.)\n  static async getTraysFiltered(filterFn: (tray: Tray) => boolean): Promise<Tray[]> {\n    const allTrays = await this.loadTrays();\n    return allTrays.filter(filterFn);\n  }\n\n  // Get trays by status\n  static async getTraysByStatus(status: Tray['status']): Promise<Tray[]> {\n    return this.getTraysFiltered(tray => tray.status === status);\n  }\n\n  // Get trays by location\n  static async getTraysByLocation(systemId: string): Promise<Tray[]> {\n    return this.getTraysFiltered(tray => tray.currentLocation.systemId === systemId);\n  }\n\n  // Get trays by crop type\n  static async getTraysByCropType(cropType: string): Promise<Tray[]> {\n    return this.getTraysFiltered(tray => tray.cropType.toLowerCase() === cropType.toLowerCase());\n  }\n\n  // Get trays ready for harvest (based on expected harvest date)\n  static async getTraysReadyForHarvest(): Promise<Tray[]> {\n    const today = new Date();\n    return this.getTraysFiltered(tray => {\n      return tray.status === 'growing' && tray.expectedHarvest <= today;\n    });\n  }\n\n  // Get trays by date range\n  static async getTraysByDateRange(startDate: Date, endDate: Date): Promise<Tray[]> {\n    return this.getTraysFiltered(tray => {\n      return tray.datePlanted >= startDate && tray.datePlanted <= endDate;\n    });\n  }\n\n  // Search trays by ID or crop type\n  static async searchTrays(searchTerm: string): Promise<Tray[]> {\n    const term = searchTerm.toLowerCase();\n    return this.getTraysFiltered(tray => \n      tray.id.toLowerCase().includes(term) ||\n      tray.cropType.toLowerCase().includes(term) ||\n      tray.notes.toLowerCase().includes(term) ||\n      tray.createdBy.toLowerCase().includes(term)\n    );\n  }\n\n  // Get all active growing trays (not harvested, discarded, or split)\n  static async getActiveTrays(): Promise<Tray[]> {\n    return this.getTraysFiltered(tray => \n      tray.status === 'seeded' || \n      tray.status === 'germinating' || \n      tray.status === 'growing' || \n      tray.status === 'ready'\n    );\n  }\n\n  // Get tray summary statistics\n  static async getTrayStats(): Promise<{\n    total: number;\n    byStatus: Record<string, number>;\n    byCropType: Record<string, number>;\n    readyForHarvest: number;\n  }> {\n    const allTrays = await this.loadTrays();\n    const readyTrays = await this.getTraysReadyForHarvest();\n    \n    const byStatus: Record<string, number> = {};\n    const byCropType: Record<string, number> = {};\n    \n    allTrays.forEach(tray => {\n      byStatus[tray.status] = (byStatus[tray.status] || 0) + 1;\n      byCropType[tray.cropType] = (byCropType[tray.cropType] || 0) + 1;\n    });\n    \n    return {\n      total: allTrays.length,\n      byStatus,\n      byCropType,\n      readyForHarvest: readyTrays.length\n    };\n  }\n  \n  // Add new tray\n  static async addTray(tray: Tray): Promise<void> {\n    await TrayDataApiService.addTray(tray);\n    \n    // Dispatch update event\n    window.dispatchEvent(new CustomEvent('trayDataUpdated', { \n      detail: { trays: await this.loadTrays() } \n    }));\n  }\n  \n  // Update existing tray\n  static async updateTray(updatedTray: Tray): Promise<void> {\n    await TrayDataApiService.updateTray(updatedTray);\n    \n    // Dispatch update event\n    window.dispatchEvent(new CustomEvent('trayDataUpdated', { \n      detail: { trays: await this.loadTrays() } \n    }));\n  }\n  \n  // Delete tray\n  static async deleteTray(trayId: string): Promise<void> {\n    await TrayDataApiService.deleteTray(trayId);\n    \n    // Dispatch update event\n    window.dispatchEvent(new CustomEvent('trayDataUpdated', { \n      detail: { trays: await this.loadTrays() } \n    }));\n  }\n\n  // Clear all trays\n  static async clearAllTrays(): Promise<void> {\n    await TrayDataApiService.clearAllTrays();\n    \n    // Dispatch update event\n    window.dispatchEvent(new CustomEvent('trayDataUpdated', { \n      detail: { trays: [] } \n    }));\n  }\n}\n\nexport default TrayDataService;","path":null,"size_bytes":4538,"size_tokens":null},"client/src/data/systemsData.ts":{"content":"export interface SystemSpot {\n  id: string;\n  occupied: boolean;\n  trayId?: string;\n  plantType?: string;\n  plantedDate?: Date;\n  expectedMove?: Date;\n}\n\nexport interface GrowingSystem {\n  id: string;\n  name: string;\n  type: 'nursery' | 'blackout' | 'ebbFlow' | 'towers' | 'nft' | 'microgreens';\n  category: 'microgreens' | 'leafyGreens';\n  location: string;\n  configuration: {\n    sections?: Array<{\n      id: string;\n      spots: number;\n      spotType?: 'ports' | 'slots' | 'spaces';\n    }>;\n    totalCapacity: number;\n    restrictions?: {\n      samePerChannel?: boolean; // For NFT\n      maxPerTray?: number;\n    };\n  };\n  currentOccupancy: number;\n  spots: SystemSpot[];\n}\n\n// Initial systems data\nexport const defaultSystems: { [location: string]: GrowingSystem[] } = {\n  'Grow Space': [\n    // Microgreen Systems\n    {\n      id: 'mg-nursery',\n      name: 'Microgreen Nursery',\n      type: 'nursery',\n      category: 'microgreens',\n      location: 'Grow Space',\n      configuration: {\n        totalCapacity: 100\n      },\n      currentOccupancy: 0,\n      spots: Array(100).fill(null).map((_, i) => ({\n        id: `nursery-${i + 1}`,\n        occupied: false\n      }))\n    },\n    {\n      id: 'mg-blackout',\n      name: 'Blackout Area',\n      type: 'blackout',\n      category: 'microgreens',\n      location: 'Grow Space',\n      configuration: {\n        totalCapacity: 200\n      },\n      currentOccupancy: 0,\n      spots: Array(200).fill(null).map((_, i) => ({\n        id: `blackout-${i + 1}`,\n        occupied: false\n      }))\n    },\n    // Ebb & Flow Systems\n    {\n      id: 'ebb-flow-a',\n      name: 'Ebb & Flow A',\n      type: 'ebbFlow',\n      category: 'leafyGreens',\n      location: 'Grow Space',\n      configuration: {\n        sections: [{ id: 'A', spots: 16, spotType: 'spaces' }],\n        totalCapacity: 16\n      },\n      currentOccupancy: 0,\n      spots: Array(16).fill(null).map((_, i) => ({\n        id: `ebb-a-${i + 1}`,\n        occupied: false\n      }))\n    },\n    // Tower Systems\n    ...Array(7).fill(null).map((_, i) => ({\n      id: `tower-a${i + 1}`,\n      name: `Tower A${i + 1}`,\n      type: 'towers',\n      category: 'leafyGreens',\n      location: 'Grow Space',\n      configuration: {\n        totalCapacity: 44,\n        sections: [{ id: `A${i + 1}`, spots: 44, spotType: 'ports' }]\n      },\n      currentOccupancy: 0,\n      spots: Array(44).fill(null).map((_, j) => ({\n        id: `tower-a${i + 1}-${j + 1}`,\n        occupied: false\n      }))\n    })),\n    // NFT Systems\n    {\n      id: 'nft-1',\n      name: 'NFT Shelf 1',\n      type: 'nft',\n      category: 'leafyGreens',\n      location: 'Grow Space',\n      configuration: {\n        sections: [\n          { id: 'CH1', spots: 18, spotType: 'slots' },\n          { id: 'CH2', spots: 18, spotType: 'slots' },\n          { id: 'CH3', spots: 18, spotType: 'slots' },\n          { id: 'CH4', spots: 18, spotType: 'slots' }\n        ],\n        totalCapacity: 72,\n        restrictions: {\n          samePerChannel: true\n        }\n      },\n      currentOccupancy: 0,\n      spots: Array(72).fill(null).map((_, i) => ({\n        id: `nft-1-${Math.floor(i / 18) + 1}-${(i % 18) + 1}`,\n        occupied: false\n      }))\n    }\n  ]\n};","path":null,"size_bytes":3185,"size_tokens":null},"client/src/components/ui/separator.tsx":{"content":"import * as React from \"react\"\nimport * as SeparatorPrimitive from \"@radix-ui/react-separator\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Separator = React.forwardRef<\n  React.ElementRef<typeof SeparatorPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof SeparatorPrimitive.Root>\n>(\n  (\n    { className, orientation = \"horizontal\", decorative = true, ...props },\n    ref\n  ) => (\n    <SeparatorPrimitive.Root\n      ref={ref}\n      decorative={decorative}\n      orientation={orientation}\n      className={cn(\n        \"shrink-0 bg-border\",\n        orientation === \"horizontal\" ? \"h-[1px] w-full\" : \"h-full w-[1px]\",\n        className\n      )}\n      {...props}\n    />\n  )\n)\nSeparator.displayName = SeparatorPrimitive.Root.displayName\n\nexport { Separator }\n","path":null,"size_bytes":756,"size_tokens":null},"client/src/components/SearchableAssignmentSelect.tsx":{"content":"import React, { useState, useRef, useEffect } from 'react';\n\ninterface AssignmentOption {\n  value: string;\n  label: string;\n  type: 'none' | 'special' | 'role' | 'user';\n  staffCount?: number;\n  roles?: string[];\n  searchText?: string;\n}\n\ninterface AssignmentOptions {\n  special: AssignmentOption[];\n  roles: AssignmentOption[];\n  users: AssignmentOption[];\n}\n\ninterface SearchableAssignmentSelectProps {\n  value: string;\n  onChange: (value: string) => void;\n  assignmentOptions: AssignmentOptions;\n  placeholder?: string;\n  disabled?: boolean;\n}\n\nconst SearchableAssignmentSelect: React.FC<SearchableAssignmentSelectProps> = ({\n  value,\n  onChange,\n  assignmentOptions,\n  placeholder = \"Search or select assignment...\",\n  disabled = false\n}) => {\n  const [isOpen, setIsOpen] = useState(false);\n  const [searchQuery, setSearchQuery] = useState('');\n  const [highlightedIndex, setHighlightedIndex] = useState(0);\n  const dropdownRef = useRef<HTMLDivElement>(null);\n  const inputRef = useRef<HTMLInputElement>(null);\n\n  // Close dropdown when clicking outside\n  useEffect(() => {\n    const handleClickOutside = (event: MouseEvent) => {\n      if (dropdownRef.current && !dropdownRef.current.contains(event.target as Node)) {\n        setIsOpen(false);\n      }\n    };\n\n    document.addEventListener('mousedown', handleClickOutside);\n    return () => document.removeEventListener('mousedown', handleClickOutside);\n  }, []);\n\n  // Get all options in a flat list\n  const getAllOptions = (): AssignmentOption[] => {\n    const options: AssignmentOption[] = [];\n\n    // Add \"No default assignment\" option\n    options.push({\n      value: 'no-assignment',\n      label: 'No default assignment',\n      type: 'none',\n      searchText: 'no default assignment none'\n    });\n\n    // Add special options\n    assignmentOptions.special.forEach(opt => {\n      options.push({\n        ...opt,\n        type: 'special',\n        searchText: `${opt.label} all staff`.toLowerCase()\n      });\n    });\n\n    // Add roles (PRIMARY - most tasks should be role-based, not person-based)\n    assignmentOptions.roles.forEach(opt => {\n      options.push({\n        ...opt,\n        type: 'role',\n        searchText: `${opt.label} role`.toLowerCase()\n      });\n    });\n\n    // Add individual users (FALLBACK - only for rare cases where specific person needed)\n    assignmentOptions.users.forEach(opt => {\n      options.push({\n        ...opt,\n        type: 'user',\n        searchText: `${opt.label} ${opt.roles?.join(' ') || ''} individual person`.toLowerCase()\n      });\n    });\n\n    return options;\n  };\n\n  // Filter options based on search\n  const filteredOptions = getAllOptions().filter(option =>\n    !searchQuery || option.searchText?.includes(searchQuery.toLowerCase())\n  );\n\n  // Get display text for selected value\n  const getDisplayText = () => {\n    if (!value || value === 'no-assignment') return 'No default assignment';\n\n    const allOptions = getAllOptions();\n    const selected = allOptions.find(opt => opt.value === value);\n\n    if (selected) {\n      if (selected.staffCount !== undefined) {\n        return `${selected.label} (${selected.staffCount} ${selected.staffCount === 1 ? 'person' : 'people'})`;\n      }\n      return selected.label;\n    }\n\n    return value;\n  };\n\n  // Handle keyboard navigation\n  const handleKeyDown = (e: React.KeyboardEvent) => {\n    if (!isOpen) {\n      if (e.key === 'Enter' || e.key === ' ' || e.key === 'ArrowDown') {\n        setIsOpen(true);\n        e.preventDefault();\n      }\n      return;\n    }\n\n    switch (e.key) {\n      case 'ArrowDown':\n        e.preventDefault();\n        setHighlightedIndex(prev =>\n          prev < filteredOptions.length - 1 ? prev + 1 : prev\n        );\n        break;\n\n      case 'ArrowUp':\n        e.preventDefault();\n        setHighlightedIndex(prev => prev > 0 ? prev - 1 : 0);\n        break;\n\n      case 'Enter':\n        e.preventDefault();\n        if (filteredOptions[highlightedIndex]) {\n          selectOption(filteredOptions[highlightedIndex]);\n        }\n        break;\n\n      case 'Escape':\n        setIsOpen(false);\n        setSearchQuery('');\n        break;\n    }\n  };\n\n  const selectOption = (option: AssignmentOption) => {\n    onChange(option.value);\n    setIsOpen(false);\n    setSearchQuery('');\n    setHighlightedIndex(0);\n  };\n\n  // Reset highlighted index when search changes\n  useEffect(() => {\n    setHighlightedIndex(0);\n  }, [searchQuery]);\n\n  if (disabled) {\n    return (\n      <div className=\"searchable-select\">\n        <div className=\"select-input disabled\">\n          <div className=\"select-value\">\n            {getDisplayText()}\n          </div>\n          <div className=\"select-arrow\">‚ñº</div>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"searchable-select\" ref={dropdownRef}>\n      <div\n        className=\"select-input\"\n        onClick={() => {\n          setIsOpen(!isOpen);\n          if (!isOpen) {\n            setTimeout(() => inputRef.current?.focus(), 0);\n          }\n        }}\n      >\n        <div className=\"select-value\">\n          {getDisplayText()}\n        </div>\n        <div className=\"select-arrow\">‚ñº</div>\n      </div>\n\n      {isOpen && (\n        <div className=\"select-dropdown\">\n          <div className=\"search-box\">\n            <input\n              ref={inputRef}\n              type=\"text\"\n              className=\"search-input\"\n              placeholder=\"Type to search...\"\n              value={searchQuery}\n              onChange={(e) => setSearchQuery(e.target.value)}\n              onKeyDown={handleKeyDown}\n              autoFocus\n            />\n          </div>\n\n          <div className=\"options-list\">\n            {filteredOptions.length === 0 ? (\n              <div className=\"no-results\">No matches found</div>\n            ) : (\n              <>\n                {/* No assignment option */}\n                {filteredOptions.filter(opt => opt.type === 'none').map((option, idx) => (\n                  <div\n                    key={option.value}\n                    className={`option ${highlightedIndex === filteredOptions.indexOf(option) ? 'highlighted' : ''}`}\n                    onClick={() => selectOption(option)}\n                  >\n                    {option.label}\n                  </div>\n                ))}\n\n                {/* Special options */}\n                {filteredOptions.filter(opt => opt.type === 'special').length > 0 && (\n                  <div className=\"option-group-header\">All Staff</div>\n                )}\n                {filteredOptions.filter(opt => opt.type === 'special').map((option) => {\n                  const actualIdx = filteredOptions.indexOf(option);\n                  return (\n                    <div\n                      key={option.value}\n                      className={`option ${highlightedIndex === actualIdx ? 'highlighted' : ''}`}\n                      onClick={() => selectOption(option)}\n                    >\n                      {option.label} ({option.staffCount} people)\n                    </div>\n                  );\n                })}\n\n                {/* Roles */}\n                {filteredOptions.filter(opt => opt.type === 'role').length > 0 && (\n                  <div className=\"option-group-header\">Roles</div>\n                )}\n                {filteredOptions.filter(opt => opt.type === 'role').map((option) => {\n                  const actualIdx = filteredOptions.indexOf(option);\n                  return (\n                    <div\n                      key={option.value}\n                      className={`option ${highlightedIndex === actualIdx ? 'highlighted' : ''}`}\n                      onClick={() => selectOption(option)}\n                    >\n                      {option.label} ({option.staffCount} {option.staffCount === 1 ? 'person' : 'people'})\n                    </div>\n                  );\n                })}\n\n                {/* Users */}\n                {filteredOptions.filter(opt => opt.type === 'user').length > 0 && (\n                  <div className=\"option-group-header\">People</div>\n                )}\n                {filteredOptions.filter(opt => opt.type === 'user').map((option) => {\n                  const actualIdx = filteredOptions.indexOf(option);\n                  return (\n                    <div\n                      key={option.value}\n                      className={`option ${highlightedIndex === actualIdx ? 'highlighted' : ''}`}\n                      onClick={() => selectOption(option)}\n                    >\n                      {option.label}\n                      {option.roles && option.roles.length > 0 && (\n                        <span className=\"option-roles\"> - {option.roles.join(', ')}</span>\n                      )}\n                    </div>\n                  );\n                })}\n              </>\n            )}\n          </div>\n        </div>\n      )}\n    </div>\n  );\n};\n\nexport default SearchableAssignmentSelect;","path":null,"size_bytes":8878,"size_tokens":null},"client/src/components/AddTaskModal.tsx":{"content":"import React, { useState, useEffect } from 'react';\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription } from '@/components/ui/dialog';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { Label } from '@/components/ui/label';\nimport { Textarea } from '@/components/ui/textarea';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue, SelectSeparator, SelectGroup, SelectLabel } from '@/components/ui/select';\nimport { useToast } from '@/hooks/use-toast';\nimport { getTaskTypeOptions } from '../data/roleTaskMapping';\nimport { getAssignmentOptions, AssignmentOptions } from '../services/taskAssignmentService';\n\ninterface AddTaskModalProps {\n  open: boolean;\n  onClose: () => void;\n  onSave: (taskData: any) => void;\n  currentUser?: any;\n}\n\nexport const AddTaskModal: React.FC<AddTaskModalProps> = ({ open, onClose, onSave, currentUser }) => {\n  const { toast } = useToast();\n  \n  const [taskData, setTaskData] = useState({\n    title: '',\n    description: '',\n    type: '',\n    priority: 'medium',\n    assignTo: '',\n    dueDate: new Date().toISOString().split('T')[0],\n    estimatedTime: ''\n  });\n\n  const [assignmentOptions, setAssignmentOptions] = useState<AssignmentOptions>({\n    roles: [],\n    users: [],\n    special: []\n  });\n\n  const [isLoadingAssignments, setIsLoadingAssignments] = useState(false);\n\n  const taskTypes = getTaskTypeOptions();\n\n  // Fetch assignment options when task type changes\n  useEffect(() => {\n    const loadAssignmentOptions = async () => {\n      if (taskData.type && currentUser) {\n        setIsLoadingAssignments(true);\n        try {\n          const options = await getAssignmentOptions(currentUser, taskData.type);\n          setAssignmentOptions(options);\n        } catch (error) {\n          console.error('‚ùå AddTaskModal: Error loading assignment options:', error);\n          toast({\n            title: \"Error Loading Assignments\",\n            description: \"Could not load assignment options. Please try again.\",\n            variant: \"destructive\"\n          });\n        } finally {\n          setIsLoadingAssignments(false);\n        }\n      }\n    };\n    \n    loadAssignmentOptions();\n  }, [taskData.type, currentUser, toast]);\n\n  const handleSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    \n    console.log('Form submitted with data:', taskData);\n    \n    // Validate required fields\n    if (!taskData.title || !taskData.type || !taskData.dueDate || !taskData.estimatedTime) {\n      toast({\n        title: \"Missing Required Fields\",\n        description: \"Please fill in all required fields marked with *\",\n        variant: \"destructive\"\n      });\n      return;\n    }\n\n    // Convert estimated time to minutes\n    const estimatedMinutes = parseEstimatedTime(taskData.estimatedTime);\n    \n    if (estimatedMinutes <= 0) {\n      toast({\n        title: \"Invalid Time Format\",\n        description: \"Please enter a valid duration (e.g., '2h 30m' or '90m')\",\n        variant: \"destructive\"\n      });\n      return;\n    }\n\n    const newTask = {\n      ...taskData,\n      assignTo: taskData.assignTo, // New dynamic assignment field\n      assignedTo: taskData.assignTo.startsWith('user_') ? parseInt(taskData.assignTo.replace('user_', '')) : null, // Legacy compatibility\n      estimatedTime: estimatedMinutes,\n      status: 'pending' as const,\n      progress: 0,\n      checklist: [],\n      startedAt: null,\n      completedAt: null,\n      createdBy: currentUser?.id || 1,\n      data: {}\n    };\n\n    console.log('Calling onSave with:', newTask);\n    onSave(newTask);\n    resetForm();\n  };\n\n  const parseEstimatedTime = (timeStr: string): number => {\n    const str = timeStr.toLowerCase().trim();\n    let totalMinutes = 0;\n    \n    // Match patterns like \"2h 30m\", \"2h\", \"30m\", \"90m\"\n    const hourMatch = str.match(/(\\d+)\\s*h/);\n    const minuteMatch = str.match(/(\\d+)\\s*m/);\n    \n    if (hourMatch) {\n      totalMinutes += parseInt(hourMatch[1]) * 60;\n    }\n    \n    if (minuteMatch) {\n      totalMinutes += parseInt(minuteMatch[1]);\n    }\n    \n    // If no h or m, assume it's minutes\n    if (!hourMatch && !minuteMatch) {\n      const numMatch = str.match(/(\\d+)/);\n      if (numMatch) {\n        totalMinutes = parseInt(numMatch[1]);\n      }\n    }\n    \n    return totalMinutes;\n  };\n\n  const resetForm = () => {\n    setTaskData({\n      title: '',\n      description: '',\n      type: '',\n      priority: 'medium',\n      assignTo: '',\n      dueDate: new Date().toISOString().split('T')[0],\n      estimatedTime: ''\n    });\n  };\n\n  const handleClose = () => {\n    resetForm();\n    onClose();\n  };\n\n  const handleOpenChange = (isOpen: boolean) => {\n    if (!isOpen) {\n      // Only reset form when dialog is actually closing\n      handleClose();\n    }\n  };\n\n  return (\n    <Dialog open={open} onOpenChange={handleOpenChange}>\n      <DialogContent className=\"sm:max-w-[500px] max-h-[90vh] overflow-y-auto\">\n        <DialogHeader>\n          <DialogTitle className=\"text-[#203B17]\">Add New Task</DialogTitle>\n          <DialogDescription>\n            Create a new task for your team to complete\n          </DialogDescription>\n        </DialogHeader>\n        \n        <form onSubmit={handleSubmit} className=\"space-y-4\">\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"title\">Title *</Label>\n            <Input\n              id=\"title\"\n              value={taskData.title}\n              onChange={(e) => setTaskData({ ...taskData, title: e.target.value })}\n              placeholder=\"e.g., Seed Lettuce Trays\"\n              required\n            />\n          </div>\n\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"description\">Description</Label>\n            <Textarea\n              id=\"description\"\n              value={taskData.description}\n              onChange={(e) => setTaskData({ ...taskData, description: e.target.value })}\n              placeholder=\"Detailed task instructions...\"\n              rows={3}\n            />\n          </div>\n\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"type\">Task Type *</Label>\n            <Select value={taskData.type} onValueChange={(value) => setTaskData({ ...taskData, type: value })}>\n              <SelectTrigger>\n                <SelectValue placeholder=\"Select Type\" />\n              </SelectTrigger>\n              <SelectContent>\n                {taskTypes.map((type) => (\n                  <SelectItem key={type.value} value={type.value}>\n                    {type.label}\n                  </SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n          </div>\n\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"priority\">Priority</Label>\n            <Select value={taskData.priority} onValueChange={(value) => setTaskData({ ...taskData, priority: value })}>\n              <SelectTrigger>\n                <SelectValue />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"high\">High</SelectItem>\n                <SelectItem value=\"medium\">Medium</SelectItem>\n                <SelectItem value=\"low\">Low</SelectItem>\n              </SelectContent>\n            </Select>\n          </div>\n\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"assignTo\">Assign To</Label>\n            <Select value={taskData.assignTo} onValueChange={(value) => setTaskData({ ...taskData, assignTo: value })}>\n              <SelectTrigger>\n                <SelectValue placeholder={isLoadingAssignments ? \"Loading...\" : \"Select Assignee (Optional)\"} />\n              </SelectTrigger>\n              <SelectContent>\n                {isLoadingAssignments ? (\n                  <SelectItem value=\"__loading__\" disabled>Loading assignments...</SelectItem>\n                ) : (\n                  <>\n                    {/* Special Options */}\n                    {assignmentOptions.special.map(option => (\n                      <SelectItem \n                        key={option.value} \n                        value={option.value}\n                        className=\"font-semibold\"\n                      >\n                        {option.label} ({option.staffCount} {option.staffCount === 1 ? 'person' : 'people'})\n                      </SelectItem>\n                    ))}\n                    \n                    {/* Staff Members - Direct list without groups/separators */}\n                    {assignmentOptions.users.map(user => (\n                      <SelectItem \n                        key={user.value} \n                        value={user.value}\n                        className={user.isCurrentUser ? 'bg-blue-50' : ''}\n                      >\n                        {user.label}{user.isCurrentUser ? ' (You)' : ''}\n                      </SelectItem>\n                    ))}\n                  </>\n                )}\n              </SelectContent>\n            </Select>\n            \n            {/* Show assignment preview */}\n            {taskData.assignTo && taskData.assignTo.startsWith('role_') && (\n              <div className=\"text-sm text-gray-600 bg-gray-50 p-2 rounded\">\n                <strong>Will assign to:</strong> {\n                  assignmentOptions.roles\n                    .find(r => r.value === taskData.assignTo)\n                    ?.staffIds\n                    ?.map(id => assignmentOptions.users.find(u => u.userId === id)?.label)\n                    .join(', ') || 'Loading...'\n                }\n              </div>\n            )}\n            \n            {/* Show note for \"Other\" tasks */}\n            {taskData.type === 'Other' && !taskData.assignTo && (\n              <div className=\"text-sm text-blue-600 bg-blue-50 p-2 rounded\">\n                üí° \"Other\" tasks are typically assigned to All Staff\n              </div>\n            )}\n          </div>\n\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"dueDate\">Due Date *</Label>\n            <Input\n              id=\"dueDate\"\n              type=\"date\"\n              value={taskData.dueDate}\n              onChange={(e) => setTaskData({ ...taskData, dueDate: e.target.value })}\n              required\n            />\n          </div>\n\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"estimatedTime\">Estimated Duration *</Label>\n            <Input\n              id=\"estimatedTime\"\n              value={taskData.estimatedTime}\n              onChange={(e) => setTaskData({ ...taskData, estimatedTime: e.target.value })}\n              placeholder=\"e.g., 2h 30m, 90m\"\n              required\n            />\n            <p className=\"text-sm text-gray-500\">\n              Enter time in format: 2h 30m, 1h, 90m, or just numbers for minutes\n            </p>\n          </div>\n\n          <div className=\"flex gap-2 pt-4\">\n            <Button type=\"submit\" className=\"flex-1 bg-[#2D8028] hover:bg-[#203B17]\">\n              Save Task\n            </Button>\n            <Button type=\"button\" onClick={handleClose} variant=\"outline\" className=\"flex-1\">\n              Cancel\n            </Button>\n          </div>\n        </form>\n      </DialogContent>\n    </Dialog>\n  );\n};","path":null,"size_bytes":11101,"size_tokens":null},"client/src/hooks/useLocationData.ts":{"content":"import { useLocation } from '../contexts/LocationContext';\nimport { useEffect, useState } from 'react';\n\nexport function useLocationData<T>(\n  fetchSingleLocation: (locationId: string) => Promise<T>,\n  fetchAllLocations?: () => Promise<T>,\n  dependencies: any[] = []\n) {\n  const { currentLocation, isViewingAllLocations } = useLocation();\n  const [data, setData] = useState<T | null>(null);\n  const [loading, setLoading] = useState(true);\n  const [error, setError] = useState<string | null>(null);\n  \n  useEffect(() => {\n    const fetchData = async () => {\n      setLoading(true);\n      setError(null);\n      \n      try {\n        let result: T;\n        \n        if (isViewingAllLocations && fetchAllLocations) {\n          result = await fetchAllLocations();\n        } else {\n          result = await fetchSingleLocation(currentLocation.id);\n        }\n        \n        setData(result);\n      } catch (err) {\n        setError(err instanceof Error ? err.message : 'An error occurred');\n      } finally {\n        setLoading(false);\n      }\n    };\n    \n    fetchData();\n  }, [currentLocation.id, isViewingAllLocations, ...dependencies]);\n  \n  return { data, loading, error };\n}\n\n// Helper hook for filtering data by location\nexport function useLocationFilter<T extends { location?: string }>(\n  data: T[] | null,\n  defaultLocation?: string\n) {\n  const { currentLocation, isViewingAllLocations } = useLocation();\n  \n  if (!data) return [];\n  \n  if (isViewingAllLocations) {\n    return data;\n  }\n  \n  // Filter by current location or default location\n  const targetLocation = defaultLocation || currentLocation.code;\n  return data.filter(item => \n    item.location === targetLocation || \n    (item.location === undefined && targetLocation === 'K') // Default to Kenosha\n  );\n}","path":null,"size_bytes":1769,"size_tokens":null},"client/src/data/trayTracking.ts":{"content":"export interface TrayVariety {\n  seedId: string;\n  seedName: string;\n  sku: string;\n  quantity: number;\n  seedsOz: number;\n}\n\nexport interface Tray {\n  id: string; // e.g., \"K071725-MG-BROC-1A\"\n  barcode?: string;\n  cropType: string;\n  cropCategory: 'microgreens' | 'leafyGreens';\n  datePlanted: Date;\n  expectedHarvest: Date;\n  status: 'seeded' | 'germinating' | 'growing' | 'ready' | 'harvested' | 'split' | 'discarded';\n  currentLocation: {\n    systemId: string;\n    systemType: string;\n    spotIds: string[];\n    movedDate: Date;\n  };\n  locationHistory: Array<{\n    systemId: string;\n    systemType: string;\n    spotIds: string[];\n    movedDate: Date;\n    movedBy: string;\n    reason?: string;\n  }>;\n  parentTrayId?: string; // For split trays\n  childTrayIds?: string[]; // For parent trays that were split\n  plantCount: number;\n  varieties?: TrayVariety[]; // Multiple crop varieties in one tray\n  notes: string;\n  createdBy: string;\n  createdDate: Date;\n}\n\nexport interface TrayMovement {\n  id: string;\n  trayId: string;\n  fromSystem: string;\n  toSystem: string;\n  movementType: 'automatic' | 'manual' | 'split';\n  scheduledDate?: Date;\n  completedDate?: Date;\n  status: 'pending' | 'in-progress' | 'completed' | 'failed';\n  reason?: string;\n  splitDetails?: {\n    parentTrayId: string;\n    newTrayIds: string[];\n    distribution: Array<{\n      trayId: string;\n      systemId: string;\n      plantCount: number;\n    }>;\n  };\n}\n\n// Tray ID generator\nexport const generateTrayId = (\n  location: string,\n  cropType: string,\n  category: 'microgreens' | 'leafyGreens'\n): string => {\n  const locationCode = location.charAt(0).toUpperCase();\n  const date = new Date();\n  const dateStr = `${(date.getMonth() + 1).toString().padStart(2, '0')}${date.getDate().toString().padStart(2, '0')}${date.getFullYear().toString().slice(-2)}`;\n  const categoryCode = category === 'microgreens' ? 'MG' : 'LG';\n  const cropCode = cropType.substring(0, 4).toUpperCase();\n  const random = Math.floor(Math.random() * 100).toString().padStart(2, '0');\n  const section = String.fromCharCode(65 + Math.floor(Math.random() * 4)); // A-D\n  \n  return `${locationCode}${dateStr}-${categoryCode}-${cropCode}-${random}${section}`;\n};\n\n// Production launch - sample tray data removed for clean start\nexport const sampleTrays: Tray[] = [];","path":null,"size_bytes":2307,"size_tokens":null},"client/src/utils/taskAssignment.ts":{"content":"import { Task } from '@shared/schema';\n\ninterface CurrentUser {\n  id: number | null;\n  email: string;\n  fullName: string;\n  rolesAssigned: string[];\n}\n\n/**\n * Centralized function to check if a task is assigned to the current user\n */\nexport const isTaskAssignedToUser = (task: Task | any, currentUser: CurrentUser | null): boolean => {\n  if (!currentUser || !currentUser.id) {\n    console.log('No current user or user ID:', currentUser);\n    return false;\n  }\n  \n  // Check both assignTo (new) and assignedTo (legacy) fields\n  const assignment = task.assignTo || task.assignedTo;\n  if (!assignment) {\n    return false;\n  }\n  \n  // Convert user ID to string for comparison\n  const userIdStr = String(currentUser.id);\n  \n  // Debug logging for any assigned tasks\n  if (assignment === 'all_staff' || (assignment && assignment.startsWith('role_'))) {\n    console.log('üîç Assignment Debug:', {\n      taskId: task.id,\n      taskTitle: task.title,\n      assignment: assignment,\n      userIdStr: userIdStr,\n      userRoles: currentUser.rolesAssigned,\n      assignmentType: typeof assignment\n    });\n  }\n  \n  // Direct user assignment\n  if (assignment === `user_${userIdStr}`) {\n    console.log('‚úÖ Direct user assignment match');\n    return true;\n  }\n  \n  // All staff assignment\n  if (assignment === 'all_staff') {\n    console.log('‚úÖ All staff assignment match for task:', task.title);\n    return true;\n  }\n  \n  // Role-based assignment\n  if (typeof assignment === 'string' && assignment.startsWith('role_')) {\n    const roleName = assignment.replace('role_', '');\n    const hasRole = currentUser.rolesAssigned?.includes(roleName) || false;\n    if (hasRole) {\n      console.log(`‚úÖ Role match: \"${roleName}\" for task:`, task.title);\n    }\n    return hasRole;\n  }\n  \n  return false;\n};\n\n/**\n * Get human-readable assignment text for display\n */\nexport const getAssignmentDisplay = (assignTo: string | number | null | undefined): string => {\n  if (!assignTo) return 'Unassigned';\n  \n  const assignment = String(assignTo);\n  \n  if (assignment === 'all_staff') return 'All Staff';\n  if (assignment.startsWith('role_')) {\n    return assignment.replace('role_', '').replace(/([A-Z])/g, ' $1').trim();\n  }\n  if (assignment.startsWith('user_')) {\n    return 'Specific User';\n  }\n  \n  return assignment;\n};","path":null,"size_bytes":2297,"size_tokens":null},"client/src/components/ui/tabs.tsx":{"content":"import * as React from \"react\"\nimport * as TabsPrimitive from \"@radix-ui/react-tabs\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Tabs = TabsPrimitive.Root\n\nconst TabsList = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.List\n    ref={ref}\n    className={cn(\n      \"inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsList.displayName = TabsPrimitive.List.displayName\n\nconst TabsTrigger = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Trigger>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsTrigger.displayName = TabsPrimitive.Trigger.displayName\n\nconst TabsContent = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.Content\n    ref={ref}\n    className={cn(\n      \"mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsContent.displayName = TabsPrimitive.Content.displayName\n\nexport { Tabs, TabsList, TabsTrigger, TabsContent }\n","path":null,"size_bytes":1883,"size_tokens":null},"client/src/utils/taskAssignmentUtils.ts":{"content":"import { Task } from '@shared/schema';\n\ninterface CurrentUser {\n  id: number | null;\n  email: string;\n  fullName: string;\n  rolesAssigned: string[];\n}\n\ninterface StaffMember {\n  id: string | number;\n  email: string;\n  fullName: string;\n  rolesAssigned: string[];\n}\n\n/**\n * Enhanced task assignment checker with proper email-based user matching\n */\nexport const isTaskAssignedToCurrentUser = (\n  task: Task | any, \n  currentUser: CurrentUser | null, \n  allStaff: StaffMember[]\n): boolean => {\n  if (!currentUser) {\n    return false;\n  }\n  \n  // Check both assignTo (new format) and assignedTo (legacy format)\n  const assignment = task.assignTo || task.assignedTo;\n  \n  if (!assignment) {\n    return false;\n  }\n  \n  console.log('üîç Checking task assignment:', { \n    taskTitle: task.title,\n    taskAssignTo: task.assignTo,\n    taskAssignedTo: task.assignedTo,\n    finalAssignment: assignment,\n    currentUserId: currentUser.id,\n    currentUserEmail: currentUser.email,\n    currentUserRoles: currentUser.rolesAssigned\n  });\n  \n  // Handle direct user assignment (user_123)\n  if (assignment.startsWith('user_')) {\n    const assignedUserId = parseInt(assignment.replace('user_', ''));\n    const isAssigned = assignedUserId === currentUser.id;\n    console.log(`  ‚Üí User assignment check: ${assignedUserId} === ${currentUser.id} = ${isAssigned}`);\n    return isAssigned;\n  }\n  \n  // Handle all staff assignment\n  if (assignment === 'all_staff') {\n    // User must be in staff to be included in all_staff\n    const isInStaff = currentUser.id !== null;\n    console.log(`  ‚Üí All staff assignment check: user in staff = ${isInStaff}`);\n    return isInStaff;\n  }\n  \n  // Handle role assignment (role_Manager, role_Equipment Tech, etc.)\n  if (assignment.startsWith('role_')) {\n    const roleName = assignment.replace('role_', '');\n    const hasRole = currentUser.rolesAssigned?.includes(roleName) || false;\n    console.log(`  ‚Üí Role assignment check: \"${roleName}\" in [${currentUser.rolesAssigned?.join(', ')}] = ${hasRole}`);\n    return hasRole;\n  }\n  \n  console.log(`  ‚Üí Unknown assignment type: ${assignment}`);\n  return false;\n};\n\n/**\n * Legacy support for the existing isTaskAssignedToUser function\n */\nexport const isTaskAssignedToUser = isTaskAssignedToCurrentUser;","path":null,"size_bytes":2269,"size_tokens":null},"client/src/components/ui/navigation-menu.tsx":{"content":"import * as React from \"react\"\nimport * as NavigationMenuPrimitive from \"@radix-ui/react-navigation-menu\"\nimport { cva } from \"class-variance-authority\"\nimport { ChevronDown } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst NavigationMenu = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Root>\n>(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative z-10 flex max-w-max flex-1 items-center justify-center\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <NavigationMenuViewport />\n  </NavigationMenuPrimitive.Root>\n))\nNavigationMenu.displayName = NavigationMenuPrimitive.Root.displayName\n\nconst NavigationMenuList = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.List\n    ref={ref}\n    className={cn(\n      \"group flex flex-1 list-none items-center justify-center space-x-1\",\n      className\n    )}\n    {...props}\n  />\n))\nNavigationMenuList.displayName = NavigationMenuPrimitive.List.displayName\n\nconst NavigationMenuItem = NavigationMenuPrimitive.Item\n\nconst navigationMenuTriggerStyle = cva(\n  \"group inline-flex h-10 w-max items-center justify-center rounded-md bg-background px-4 py-2 text-sm font-medium transition-colors hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground focus:outline-none disabled:pointer-events-none disabled:opacity-50 data-[state=open]:text-accent-foreground data-[state=open]:bg-accent/50 data-[state=open]:hover:bg-accent data-[state=open]:focus:bg-accent\"\n)\n\nconst NavigationMenuTrigger = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Trigger\n    ref={ref}\n    className={cn(navigationMenuTriggerStyle(), \"group\", className)}\n    {...props}\n  >\n    {children}{\" \"}\n    <ChevronDown\n      className=\"relative top-[1px] ml-1 h-3 w-3 transition duration-200 group-data-[state=open]:rotate-180\"\n      aria-hidden=\"true\"\n    />\n  </NavigationMenuPrimitive.Trigger>\n))\nNavigationMenuTrigger.displayName = NavigationMenuPrimitive.Trigger.displayName\n\nconst NavigationMenuContent = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Content\n    ref={ref}\n    className={cn(\n      \"left-0 top-0 w-full data-[motion^=from-]:animate-in data-[motion^=to-]:animate-out data-[motion^=from-]:fade-in data-[motion^=to-]:fade-out data-[motion=from-end]:slide-in-from-right-52 data-[motion=from-start]:slide-in-from-left-52 data-[motion=to-end]:slide-out-to-right-52 data-[motion=to-start]:slide-out-to-left-52 md:absolute md:w-auto \",\n      className\n    )}\n    {...props}\n  />\n))\nNavigationMenuContent.displayName = NavigationMenuPrimitive.Content.displayName\n\nconst NavigationMenuLink = NavigationMenuPrimitive.Link\n\nconst NavigationMenuViewport = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Viewport>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Viewport>\n>(({ className, ...props }, ref) => (\n  <div className={cn(\"absolute left-0 top-full flex justify-center\")}>\n    <NavigationMenuPrimitive.Viewport\n      className={cn(\n        \"origin-top-center relative mt-1.5 h-[var(--radix-navigation-menu-viewport-height)] w-full overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-90 md:w-[var(--radix-navigation-menu-viewport-width)]\",\n        className\n      )}\n      ref={ref}\n      {...props}\n    />\n  </div>\n))\nNavigationMenuViewport.displayName =\n  NavigationMenuPrimitive.Viewport.displayName\n\nconst NavigationMenuIndicator = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Indicator>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Indicator>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Indicator\n    ref={ref}\n    className={cn(\n      \"top-full z-[1] flex h-1.5 items-end justify-center overflow-hidden data-[state=visible]:animate-in data-[state=hidden]:animate-out data-[state=hidden]:fade-out data-[state=visible]:fade-in\",\n      className\n    )}\n    {...props}\n  >\n    <div className=\"relative top-[60%] h-2 w-2 rotate-45 rounded-tl-sm bg-border shadow-md\" />\n  </NavigationMenuPrimitive.Indicator>\n))\nNavigationMenuIndicator.displayName =\n  NavigationMenuPrimitive.Indicator.displayName\n\nexport {\n  navigationMenuTriggerStyle,\n  NavigationMenu,\n  NavigationMenuList,\n  NavigationMenuItem,\n  NavigationMenuContent,\n  NavigationMenuTrigger,\n  NavigationMenuLink,\n  NavigationMenuIndicator,\n  NavigationMenuViewport,\n}\n","path":null,"size_bytes":5128,"size_tokens":null},"replit.md":{"content":"# Grow Space Task App 2.0\n\n## Overview\nThis application is a task management system for Grow Space Vertical Farms, designed to replace an existing Power Apps solution. It facilitates task management, inventory tracking, education, and analytics for Farm Technicians, Managers, and Corporate users. The business vision is to streamline farm operations, enhance productivity, and provide robust data insights for vertical farming.\n\n## User Preferences\nPreferred communication style: Simple, everyday language.\n\n## System Architecture\n\n### Frontend\n- **Framework**: React 18 with TypeScript\n- **Build Tool**: Vite\n- **UI Library**: Radix UI components with shadcn/ui\n- **Styling**: Tailwind CSS with custom CSS variables\n- **State Management**: TanStack Query (React Query)\n- **Routing**: Wouter\n- **Form Handling**: React Hook Form with Zod validation\n- **Design System**: Mobile-first responsive design, clean modern interface with slight playfulness (e.g., emoji visual indicators, confetti animations), consistent spacing and typography, custom color palette (e.g., Accent: #203B17, Primary: #2D8028), reusable components, and accessibility features.\n- **Date Utilities**: Custom date handling utilities in `client/src/utils/dateUtils.ts` for consistent UTC-aware date comparison and formatting\n\n### Backend\n- **Runtime**: Node.js with Express.js\n- **Database**: PostgreSQL with Drizzle ORM\n- **API Design**: RESTful API with typed endpoints\n- **Session Management**: Basic in-memory storage (designed for future Teams SSO integration)\n\n### Key Features\n- **Authentication**: Enterprise Microsoft SSO authentication using Azure AD (@growspace.farm domain restriction), role-based access control (Staff, Manager, Corporate), automatic user provisioning with corporate email detection (robert@growspace.farm, matt@growspace.farm, matt.carlson@growspace.farm), secure session management with proper logout functionality.\n- **Task Management**: CRUD operations for various task types (seeding, moving, harvesting, packing, cleaning, inventory), assignment, status tracking (pending, in_progress, completed, approved), checklist functionality with data collection, time tracking, progress tracking, manager approval workflows, and automated task instance generation from recurring patterns. Includes features for pausing and skipping tasks. **FIXED: Date filtering system with UTC-aware date comparison ensuring tasks appear only on their correct due dates.** **AUTOMATED TASK GENERATION**: Fully automated 31-day rolling buffer system that runs without manual intervention - generates tasks on app startup, when viewing task list, and maintains generation tracking in database with duplicate prevention and health monitoring dashboard. **UX OPTIMIZATIONS**: Implemented optimistic UI updates for instant feedback on all task operations (start, complete, skip, pause, resume) - UI updates immediately on button click with background API sync and automatic rollback on errors. Added comprehensive duplicate prevention system in backend that checks title, date, location, and recurring_task_id before creating tasks, automatically updating existing tasks instead of creating duplicates. **DUPLICATE CLEANUP**: Smart Refresh Tasks button with automatic duplicate detection and removal - uses composite key (title + date + location + recurringTaskId) to find duplicates, intelligently keeps the best instance (prioritizes completed/in-progress over pending/skipped, then oldest ID), deletes duplicates from database, and provides user feedback via toast notifications showing how many duplicates were removed. **HARD RESET SYSTEM**: Comprehensive state isolation preventing task data persistence between different tasks - ChecklistExecution, TaskActionModal, TaskModal, and RecurringTaskModal all reset completely when switching tasks using React key props for forced remounting, synchronous state clearing in performHardReset() function, and useEffect hooks that clear all state when task.id changes. RecurringTaskModal uses incrementing modalKey counter for creating new tasks to ensure fresh state. All modal keys are unique to prevent React key collisions (e.g., `task-modal-${id}` vs `task-action-modal-${id}`). Eliminates cross-task data contamination ensuring each task starts with clean state.\n- **Inventory Management**: Item tracking with categories, stock level monitoring with low-stock alerts, supplier info, restocking history, and weighted average cost calculation. **Converted from \"Add New Item\" to proper \"Add Stock\" functionality for restocking existing inventory items.** Prepared for QuickBooks integration.\n- **Education System**: Training modules by category, user progress tracking, completion certificates, role-based access, module prerequisites, course creation for corporate managers, and mobile layout optimization. **BREAKTHROUGH: Converted from localStorage to central database storage with proper role assignment when courses are completed.**\n- **Analytics Dashboard**: Real-time performance metrics and KPIs, task completion rates, time tracking, charts (Recharts), inventory alerts, and filter-responsive statistics.\n- **Production Data Management**: Comprehensive growing systems management (towers, NFT, Ebb & Flow, Staging) with capacity tracking, system assignment, and tray split integration.\n- **Tray Tracking System**: Complete tray lifecycle management (creation, movement, splitting) with unique ID generation, location history, and status progression. **Multi-variety tray system operational with default varieties (ARU, BROC, ROM) configured.**\n- **Location-Based Data Quarantining**: All operational data is filtered by selected location, with corporate users having an override to view all locations.\n- **Production Ready**: Application fully deployed with Microsoft SSO authentication, professional UI, disabled development features, comprehensive error handling, and clean data initialization. **BETA LAUNCH READY**: All test data removed, dynamic staff generation from Microsoft logins operational, clean production state with authentic data only. Enterprise authentication system fully functional with automatic role assignment for @growspace.farm domain users. **DEPLOYMENT OPTIMIZED**: Fixed production error handling to prevent server crashes, verified static file serving functionality, and ensured proper NODE_ENV configuration for deployment.\n- **Advanced Assignment System**: Comprehensive role-based task assignment system with 12 specialized roles (Microgreens Seeder, Leafy Greens Seeder, Microgreens Harvester, Leafy Greens Harvester, Blackout Specialist, Moving Tech, Packing Tech, Cleaning Crew, Inventory Tech, Equipment Tech, Manager, General Staff). **RECURRING TASK ASSIGNMENTS**: Added assignTo field to recurring_tasks table enabling default assignment inheritance for generated daily tasks. Staff management enhanced with color-coded role badges, visual role icons, and improved UI for role assignment in staff edit modal.\n\n## External Dependencies\n\n### Core Dependencies\n- **Database**: Neon Database (PostgreSQL) with Drizzle ORM\n- **UI Components**: Radix UI primitives with shadcn/ui\n- **Charts**: Recharts\n- **Date Handling**: date-fns\n- **Icons**: Lucide React\n\n### Development Tools\n- **TypeScript**: For type safety\n- **Vite**: Development server with HMR\n- **Tailwind CSS**: Utility-first styling\n- **ESBuild**: Fast bundling for production\n\n### Integrated Services\n- **Microsoft Azure AD**: Enterprise SSO authentication with @growspace.farm domain restriction\n- **PostgreSQL Database**: Full database integration for production data persistence\n\n### Future Integrations\n- QuickBooks API for financial data sync\n- Enhanced Microsoft Teams integration","path":null,"size_bytes":7723,"size_tokens":null},"client/src/components/TaskOverview.tsx":{"content":"import React, { useState, useMemo, useEffect } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Calendar, Download, Filter, BarChart3, Users, Clock, CheckCircle, AlertTriangle, SkipForward } from \"lucide-react\";\nimport { useLocation } from \"@/contexts/LocationContext\";\nimport { \n  BarChart, Bar, LineChart, Line, PieChart, Pie, Cell,\n  XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer \n} from 'recharts';\n\ninterface TaskFilters {\n  dateRange: string;\n  startDate: string | null;\n  endDate: string | null;\n  location: string;\n  role: string;\n  taskType: string;\n  status: string;\n  priority: string;\n  assignedUser: string;\n  recurringTaskSource: string;\n  checklistCompletionRate: string;\n  approvalStatus: string;\n  hasProcessLink: string;\n}\n\n// Helper function to format dates without timezone issues\nconst formatDueDate = (dateInput: string | Date): string => {\n  if (!dateInput) return '';\n  \n  let dateString: string;\n  \n  // Handle both Date objects and strings\n  if (dateInput instanceof Date) {\n    // Convert Date to YYYY-MM-DD format without timezone issues\n    const year = dateInput.getFullYear();\n    const month = String(dateInput.getMonth() + 1).padStart(2, '0');\n    const day = String(dateInput.getDate()).padStart(2, '0');\n    dateString = `${year}-${month}-${day}`;\n  } else {\n    // Handle ISO string format by extracting date part\n    dateString = dateInput.split('T')[0];\n  }\n  \n  // Parse the date string without timezone conversion\n  const [year, month, day] = dateString.split('-');\n  \n  // Create month names array\n  const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', \n                  'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];\n  \n  // Return formatted date (e.g., \"Jan 18, 2025\")\n  return `${months[parseInt(month) - 1]} ${parseInt(day)}, ${year}`;\n};\n\ninterface TaskDataProps {\n  id: number;\n  title: string;\n  description: string;\n  type: string;\n  status: string;\n  priority: string;\n  assignedTo: number;\n  createdBy: number;\n  location?: string;\n  estimatedTime: number;\n  actualTime: number | null;\n  progress: number;\n  checklist: Array<{\n    id: string;\n    text: string;\n    completed: boolean;\n  }>;\n  startedAt: string | null;\n  completedAt: string | null;\n  dueDate: string;\n  createdAt: string;\n  data: any;\n  isOverdue?: boolean;\n  skippedAt?: string | null;\n  skipReason?: string | null;\n  pausedAt?: string | null;\n  resumedAt?: string | null;\n}\n\nconst TaskDataFilters: React.FC<{\n  filters: TaskFilters;\n  setFilters: (filters: TaskFilters) => void;\n  tasks: TaskDataProps[];\n}> = ({ filters, setFilters, tasks }) => {\n  const uniqueUsers = [...new Set(tasks.map(t => t.assignedTo))].filter(Boolean);\n  const uniqueTaskTypes = [...new Set(tasks.map(t => t.type))].filter(Boolean);\n\n  const updateFilter = (key: string, value: string) => {\n    setFilters({ ...filters, [key]: value });\n  };\n\n  const clearAllFilters = () => {\n    setFilters({\n      dateRange: 'last7days',\n      startDate: null,\n      endDate: null,\n      location: 'all',\n      role: 'all',\n      taskType: 'all',\n      status: 'all',\n      priority: 'all',\n      assignedUser: 'all',\n      recurringTaskSource: 'all',\n      checklistCompletionRate: 'all',\n      approvalStatus: 'all',\n      hasProcessLink: 'all'\n    });\n  };\n\n  return (\n    <Card className=\"mb-6\">\n      <CardHeader>\n        <CardTitle className=\"flex items-center\">\n          <Filter className=\"h-5 w-5 mr-2\" />\n          Filters\n        </CardTitle>\n      </CardHeader>\n      <CardContent>\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4\">\n          {/* Date Range */}\n          <div className=\"space-y-2\">\n            <label className=\"text-sm font-medium\">Date Range</label>\n            <Select value={filters.dateRange} onValueChange={(value) => updateFilter('dateRange', value)}>\n              <SelectTrigger>\n                <SelectValue placeholder=\"Select date range\" />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"today\">Today</SelectItem>\n                <SelectItem value=\"last7days\">Last 7 Days</SelectItem>\n                <SelectItem value=\"last30days\">Last 30 Days</SelectItem>\n                <SelectItem value=\"custom\">Custom Range</SelectItem>\n              </SelectContent>\n            </Select>\n          </div>\n\n          {/* Task Type */}\n          <div className=\"space-y-2\">\n            <label className=\"text-sm font-medium\">Task Type</label>\n            <Select value={filters.taskType} onValueChange={(value) => updateFilter('taskType', value)}>\n              <SelectTrigger>\n                <SelectValue placeholder=\"All Types\" />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"all\">All Types</SelectItem>\n                <SelectItem value=\"seeding-microgreens\">Seeding - Microgreens</SelectItem>\n                <SelectItem value=\"seeding-leafy\">Seeding - Leafy Greens</SelectItem>\n                <SelectItem value=\"harvest-microgreens\">Harvest - Microgreens</SelectItem>\n                <SelectItem value=\"harvest-leafy\">Harvest - Leafy Greens</SelectItem>\n                <SelectItem value=\"blackout-tasks\">Blackout Tasks</SelectItem>\n                <SelectItem value=\"moving\">Moving</SelectItem>\n                <SelectItem value=\"packing\">Packing</SelectItem>\n                <SelectItem value=\"cleaning\">Cleaning</SelectItem>\n                <SelectItem value=\"inventory\">Inventory</SelectItem>\n                <SelectItem value=\"maintenance\">Equipment Maintenance</SelectItem>\n                <SelectItem value=\"other\">Other</SelectItem>\n              </SelectContent>\n            </Select>\n          </div>\n\n          {/* Status */}\n          <div className=\"space-y-2\">\n            <label className=\"text-sm font-medium\">Status</label>\n            <Select value={filters.status} onValueChange={(value) => updateFilter('status', value)}>\n              <SelectTrigger>\n                <SelectValue placeholder=\"All Statuses\" />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"all\">All Statuses</SelectItem>\n                <SelectItem value=\"completed\">Completed</SelectItem>\n                <SelectItem value=\"in_progress\">In Progress</SelectItem>\n                <SelectItem value=\"pending\">Pending</SelectItem>\n                <SelectItem value=\"skipped\">Skipped</SelectItem>\n                <SelectItem value=\"paused\">Paused</SelectItem>\n              </SelectContent>\n            </Select>\n          </div>\n\n          {/* Priority */}\n          <div className=\"space-y-2\">\n            <label className=\"text-sm font-medium\">Priority</label>\n            <Select value={filters.priority} onValueChange={(value) => updateFilter('priority', value)}>\n              <SelectTrigger>\n                <SelectValue placeholder=\"All Priorities\" />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"all\">All Priorities</SelectItem>\n                <SelectItem value=\"high\">High</SelectItem>\n                <SelectItem value=\"medium\">Medium</SelectItem>\n                <SelectItem value=\"low\">Low</SelectItem>\n              </SelectContent>\n            </Select>\n          </div>\n\n          {/* Checklist Completion */}\n          <div className=\"space-y-2\">\n            <label className=\"text-sm font-medium\">Checklist Completion</label>\n            <Select value={filters.checklistCompletionRate} onValueChange={(value) => updateFilter('checklistCompletionRate', value)}>\n              <SelectTrigger>\n                <SelectValue placeholder=\"Any\" />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"all\">Any</SelectItem>\n                <SelectItem value=\"under80\">Under 80%</SelectItem>\n                <SelectItem value=\"80to100\">80-99%</SelectItem>\n                <SelectItem value=\"100\">100%</SelectItem>\n              </SelectContent>\n            </Select>\n          </div>\n        </div>\n\n        {/* Custom Date Range */}\n        {filters.dateRange === 'custom' && (\n          <div className=\"mt-4 flex gap-4\">\n            <div className=\"space-y-2\">\n              <label className=\"text-sm font-medium\">Start Date</label>\n              <input\n                type=\"date\"\n                value={filters.startDate || ''}\n                onChange={(e) => updateFilter('startDate', e.target.value)}\n                className=\"px-3 py-2 border rounded-md\"\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <label className=\"text-sm font-medium\">End Date</label>\n              <input\n                type=\"date\"\n                value={filters.endDate || ''}\n                onChange={(e) => updateFilter('endDate', e.target.value)}\n                className=\"px-3 py-2 border rounded-md\"\n              />\n            </div>\n          </div>\n        )}\n\n        <div className=\"mt-6\">\n          <Button variant=\"outline\" onClick={clearAllFilters}>\n            Clear All Filters\n          </Button>\n        </div>\n      </CardContent>\n    </Card>\n  );\n};\n\nconst MetricsCards: React.FC<{ tasks: TaskDataProps[] }> = ({ tasks }) => {\n  const totalTasks = tasks.length;\n  const completedTasks = tasks.filter(t => t.status === 'completed').length;\n  const overdueTasks = tasks.filter(t => t.isOverdue).length;\n  const skippedTasks = tasks.filter(t => t.status === 'skipped').length;\n  const inProgressTasks = tasks.filter(t => t.status === 'in_progress').length;\n  \n  const completionRate = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;\n  \n  const avgCompletionTime = tasks\n    .filter(t => t.actualTime)\n    .reduce((acc, t) => acc + (t.actualTime || 0), 0) / completedTasks || 0;\n\n  const avgChecklistCompletion = tasks\n    .filter(t => t.checklist && t.checklist.length > 0)\n    .reduce((acc, t) => {\n      const completed = t.checklist.filter(item => item.completed).length;\n      return acc + (completed / t.checklist.length) * 100;\n    }, 0) / tasks.filter(t => t.checklist && t.checklist.length > 0).length || 0;\n\n  return (\n    <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6\">\n      <Card>\n        <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n          <CardTitle className=\"text-sm font-medium\">Total Tasks</CardTitle>\n          <BarChart3 className=\"h-4 w-4 text-muted-foreground\" />\n        </CardHeader>\n        <CardContent>\n          <div className=\"text-2xl font-bold\">{totalTasks}</div>\n          <p className=\"text-xs text-muted-foreground\">\n            {inProgressTasks} in progress\n          </p>\n        </CardContent>\n      </Card>\n\n      <Card>\n        <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n          <CardTitle className=\"text-sm font-medium\">Completion Rate</CardTitle>\n          <CheckCircle className=\"h-4 w-4 text-muted-foreground\" />\n        </CardHeader>\n        <CardContent>\n          <div className=\"text-2xl font-bold\">{completionRate}%</div>\n          <p className=\"text-xs text-muted-foreground\">\n            {completedTasks} of {totalTasks} completed\n          </p>\n        </CardContent>\n      </Card>\n\n      <Card>\n        <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n          <CardTitle className=\"text-sm font-medium\">Avg Completion Time</CardTitle>\n          <Clock className=\"h-4 w-4 text-muted-foreground\" />\n        </CardHeader>\n        <CardContent>\n          <div className=\"text-2xl font-bold\">{Math.round(avgCompletionTime)}m</div>\n          <p className=\"text-xs text-muted-foreground\">\n            Average time to complete\n          </p>\n        </CardContent>\n      </Card>\n\n      <Card>\n        <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n          <CardTitle className=\"text-sm font-medium\">Issues</CardTitle>\n          <AlertTriangle className=\"h-4 w-4 text-muted-foreground\" />\n        </CardHeader>\n        <CardContent>\n          <div className=\"text-2xl font-bold text-red-600\">{overdueTasks + skippedTasks}</div>\n          <p className=\"text-xs text-muted-foreground\">\n            {overdueTasks} overdue, {skippedTasks} skipped\n          </p>\n        </CardContent>\n      </Card>\n    </div>\n  );\n};\n\nconst TaskDataTable: React.FC<{ tasks: TaskDataProps[] }> = ({ tasks }) => {\n  const getStatusBadge = (status: string) => {\n    const statusConfig = {\n      completed: { label: 'Completed', className: 'bg-green-100 text-green-800' },\n      in_progress: { label: 'In Progress', className: 'bg-blue-100 text-blue-800' },\n      pending: { label: 'Pending', className: 'bg-yellow-100 text-yellow-800' },\n      skipped: { label: 'Skipped', className: 'bg-gray-100 text-gray-800' },\n      paused: { label: 'Paused', className: 'bg-orange-100 text-orange-800' }\n    };\n    \n    const config = statusConfig[status as keyof typeof statusConfig] || statusConfig.pending;\n    return <Badge className={config.className}>{config.label}</Badge>;\n  };\n\n  const getPriorityBadge = (priority: string) => {\n    const priorityConfig = {\n      high: { label: 'High', className: 'bg-red-100 text-red-800' },\n      medium: { label: 'Medium', className: 'bg-yellow-100 text-yellow-800' },\n      low: { label: 'Low', className: 'bg-green-100 text-green-800' }\n    };\n    \n    const config = priorityConfig[priority as keyof typeof priorityConfig] || priorityConfig.medium;\n    return <Badge className={config.className}>{config.label}</Badge>;\n  };\n\n  return (\n    <Card>\n      <CardHeader>\n        <CardTitle>Task Details</CardTitle>\n      </CardHeader>\n      <CardContent>\n        <div className=\"overflow-x-auto\">\n          <table className=\"w-full border-collapse border border-gray-200\">\n            <thead>\n              <tr className=\"bg-gray-50\">\n                <th className=\"border border-gray-200 px-4 py-2 text-left\">Task</th>\n                <th className=\"border border-gray-200 px-4 py-2 text-left\">Type</th>\n                <th className=\"border border-gray-200 px-4 py-2 text-left\">Status</th>\n                <th className=\"border border-gray-200 px-4 py-2 text-left\">Priority</th>\n                <th className=\"border border-gray-200 px-4 py-2 text-left\">Assigned To</th>\n                <th className=\"border border-gray-200 px-4 py-2 text-left\">Progress</th>\n                <th className=\"border border-gray-200 px-4 py-2 text-left\">Time</th>\n                <th className=\"border border-gray-200 px-4 py-2 text-left\">Due Date</th>\n              </tr>\n            </thead>\n            <tbody>\n              {tasks.map((task) => (\n                <tr key={task.id} className=\"hover:bg-gray-50\">\n                  <td className=\"border border-gray-200 px-4 py-2\">\n                    <div>\n                      <div className=\"font-medium\">{task.title}</div>\n                      <div className=\"text-sm text-gray-600\">{task.description}</div>\n                    </div>\n                  </td>\n                  <td className=\"border border-gray-200 px-4 py-2\">\n                    <Badge variant=\"outline\">{task.type}</Badge>\n                  </td>\n                  <td className=\"border border-gray-200 px-4 py-2\">\n                    {getStatusBadge(task.status)}\n                  </td>\n                  <td className=\"border border-gray-200 px-4 py-2\">\n                    {getPriorityBadge(task.priority)}\n                  </td>\n                  <td className=\"border border-gray-200 px-4 py-2\">\n                    User {task.assignedTo}\n                  </td>\n                  <td className=\"border border-gray-200 px-4 py-2\">\n                    <div className=\"flex items-center\">\n                      <div className=\"w-full bg-gray-200 rounded-full h-2\">\n                        <div\n                          className=\"bg-blue-600 h-2 rounded-full\"\n                          style={{ width: `${task.progress}%` }}\n                        ></div>\n                      </div>\n                      <span className=\"ml-2 text-sm\">{task.progress}%</span>\n                    </div>\n                  </td>\n                  <td className=\"border border-gray-200 px-4 py-2\">\n                    <div className=\"text-sm\">\n                      <div>Est: {task.estimatedTime}m</div>\n                      {task.actualTime && <div>Act: {task.actualTime}m</div>}\n                    </div>\n                  </td>\n                  <td className=\"border border-gray-200 px-4 py-2\">\n                    <div className=\"text-sm\">\n                      {formatDueDate(task.dueDate)}\n                    </div>\n                  </td>\n                </tr>\n              ))}\n            </tbody>\n          </table>\n        </div>\n      </CardContent>\n    </Card>\n  );\n};\n\nexport const TaskOverview: React.FC = () => {\n  const { currentLocation, isViewingAllLocations } = useLocation();\n  const [dateRange, setDateRange] = useState('7d');\n  const [selectedMetric, setSelectedMetric] = useState('completion');\n  \n  const [filters, setFilters] = useState<TaskFilters>({\n    dateRange: 'last7days',\n    startDate: null,\n    endDate: null,\n    location: 'all',\n    role: 'all',\n    taskType: 'all',\n    status: 'all',\n    priority: 'all',\n    assignedUser: 'all',\n    recurringTaskSource: 'all',\n    checklistCompletionRate: 'all',\n    approvalStatus: 'all',\n    hasProcessLink: 'all'\n  });\n\n  const { data: tasks = [], isLoading } = useQuery<TaskDataProps[]>({\n    queryKey: [\"/api/tasks\", { location: currentLocation.code }],\n    queryFn: async () => {\n      const response = await fetch(`/api/tasks?location=${currentLocation.code}`);\n      if (!response.ok) throw new Error('Failed to fetch tasks');\n      return response.json();\n    },\n    enabled: true,\n  });\n\n  // Calculate comprehensive analytics from task data\n  const analyticsData = useMemo(() => {\n    const locationFilteredTasks = isViewingAllLocations \n      ? tasks \n      : tasks.filter(task => task.location === currentLocation.code);\n    \n    const totalTasks = locationFilteredTasks.length;\n    const completedTasks = locationFilteredTasks.filter(task => task.status === 'completed').length;\n    const inProgressTasks = locationFilteredTasks.filter(task => task.status === 'in_progress').length;\n    const pendingTasks = locationFilteredTasks.filter(task => task.status === 'pending').length;\n    const skippedTasks = locationFilteredTasks.filter(task => task.status === 'skipped').length;\n    const pausedTasks = locationFilteredTasks.filter(task => task.status === 'paused').length;\n    \n    const completionRate = totalTasks > 0 ? (completedTasks / totalTasks) * 100 : 0;\n    const avgCompletionTime = completedTasks > 0 \n      ? locationFilteredTasks.filter(task => task.actualTime).reduce((sum, task) => sum + (task.actualTime || 0), 0) / completedTasks\n      : 0;\n    \n    const now = new Date();\n    const today = new Date();\n    today.setHours(0, 0, 0, 0);\n    const tomorrow = new Date(today);\n    tomorrow.setDate(tomorrow.getDate() + 1);\n    \n    const todaysTasks = locationFilteredTasks.filter(task => {\n      const taskDate = new Date(task.createdAt);\n      return taskDate >= today && taskDate < tomorrow;\n    });\n    \n    const overdueRate = locationFilteredTasks.filter(task => {\n      const dueDate = new Date(task.dueDate);\n      return dueDate < now && task.status !== 'completed';\n    }).length;\n    \n    return {\n      totalTasks,\n      completedTasks,\n      inProgressTasks,\n      pendingTasks,\n      skippedTasks,\n      pausedTasks,\n      avgCompletionTime,\n      overdueRate: totalTasks > 0 ? (overdueRate / totalTasks) * 100 : 0,\n      skipRate: totalTasks > 0 ? (skippedTasks / totalTasks) * 100 : 0,\n      todaysTasks: todaysTasks.length,\n      todaysCompleted: todaysTasks.filter(task => task.status === 'completed').length,\n      completionRate\n    };\n  }, [tasks, currentLocation.code, isViewingAllLocations]);\n\n  // Generate trend data for charts\n  const trendData = useMemo(() => {\n    const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];\n    const data = [];\n    \n    for (let i = 6; i >= 0; i--) {\n      const date = new Date();\n      date.setDate(date.getDate() - i);\n      const dayStart = new Date(date);\n      dayStart.setHours(0, 0, 0, 0);\n      const dayEnd = new Date(date);\n      dayEnd.setHours(23, 59, 59, 999);\n      \n      const dayTasks = tasks.filter(task => {\n        const taskDate = new Date(task.createdAt);\n        return taskDate >= dayStart && taskDate <= dayEnd;\n      });\n      \n      data.push({\n        date: days[date.getDay()],\n        completed: dayTasks.filter(task => task.status === 'completed').length,\n        assigned: dayTasks.length\n      });\n    }\n    \n    return data;\n  }, [tasks]);\n\n  // Task type distribution\n  const taskTypeData = useMemo(() => {\n    const types = {};\n    tasks.forEach(task => {\n      types[task.type] = (types[task.type] || 0) + 1;\n    });\n    \n    const colors = ['#10b981', '#3b82f6', '#f59e0b', '#8b5cf6', '#6b7280'];\n    return Object.entries(types).map(([type, count], index) => ({\n      name: type.charAt(0).toUpperCase() + type.slice(1).replace(/[-_]/g, ' '),\n      value: count,\n      color: colors[index % colors.length]\n    }));\n  }, [tasks]);\n\n  // Time distribution\n  const timeDistribution = useMemo(() => {\n    const ranges = {\n      '0-5 min': 0,\n      '5-10 min': 0,\n      '10-20 min': 0,\n      '20-30 min': 0,\n      '30+ min': 0\n    };\n    \n    tasks.forEach(task => {\n      const time = task.actualTime || task.estimatedTime;\n      if (time <= 5) ranges['0-5 min']++;\n      else if (time <= 10) ranges['5-10 min']++;\n      else if (time <= 20) ranges['10-20 min']++;\n      else if (time <= 30) ranges['20-30 min']++;\n      else ranges['30+ min']++;\n    });\n    \n    return Object.entries(ranges).map(([range, count]) => ({\n      range,\n      count\n    }));\n  }, [tasks]);\n\n  const filteredTasks = useMemo(() => {\n    return tasks.filter(task => {\n      // Location filter - only show tasks for current location unless viewing all locations\n      if (!isViewingAllLocations && task.location !== currentLocation.code) return false;\n      \n      // Apply filters\n      if (filters.taskType !== 'all' && task.type !== filters.taskType) return false;\n      if (filters.status !== 'all' && task.status !== filters.status) return false;\n      if (filters.priority !== 'all' && task.priority !== filters.priority) return false;\n      if (filters.assignedUser !== 'all' && task.assignedTo.toString() !== filters.assignedUser) return false;\n      \n      // Date range filtering\n      const taskDate = new Date(task.createdAt);\n      const now = new Date();\n      \n      if (filters.dateRange === 'today') {\n        const today = new Date();\n        today.setHours(0, 0, 0, 0);\n        const tomorrow = new Date(today);\n        tomorrow.setDate(tomorrow.getDate() + 1);\n        if (taskDate < today || taskDate >= tomorrow) return false;\n      } else if (filters.dateRange === 'last7days') {\n        const sevenDaysAgo = new Date(now);\n        sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);\n        if (taskDate < sevenDaysAgo) return false;\n      } else if (filters.dateRange === 'last30days') {\n        const thirtyDaysAgo = new Date(now);\n        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);\n        if (taskDate < thirtyDaysAgo) return false;\n      } else if (filters.dateRange === 'custom') {\n        if (filters.startDate && new Date(filters.startDate) > taskDate) return false;\n        if (filters.endDate && new Date(filters.endDate) < taskDate) return false;\n      }\n      \n      // Checklist completion filtering\n      if (filters.checklistCompletionRate !== 'all' && task.checklist && task.checklist.length > 0) {\n        const completionRate = (task.checklist.filter(item => item.completed).length / task.checklist.length) * 100;\n        if (filters.checklistCompletionRate === 'under80' && completionRate >= 80) return false;\n        if (filters.checklistCompletionRate === '80to100' && (completionRate < 80 || completionRate >= 100)) return false;\n        if (filters.checklistCompletionRate === '100' && completionRate < 100) return false;\n      }\n      \n      return true;\n    });\n  }, [tasks, filters, currentLocation.code, isViewingAllLocations]);\n\n  // Key metrics for display\n  const metrics = [\n    {\n      label: 'Completion Rate',\n      value: `${analyticsData.completionRate.toFixed(1)}%`,\n      change: '+2.3%',\n      positive: true,\n      icon: CheckCircle\n    },\n    {\n      label: 'Avg. Completion Time',\n      value: `${analyticsData.avgCompletionTime.toFixed(1)} min`,\n      change: '-1.2 min',\n      positive: true,\n      icon: Clock\n    },\n    {\n      label: 'Overdue Rate',\n      value: `${analyticsData.overdueRate.toFixed(1)}%`,\n      change: '+0.5%',\n      positive: false,\n      icon: AlertTriangle\n    },\n    {\n      label: 'Tasks Today',\n      value: `${analyticsData.todaysCompleted}/${analyticsData.todaysTasks}`,\n      change: analyticsData.todaysTasks > 0 ? `${((analyticsData.todaysCompleted / analyticsData.todaysTasks) * 100).toFixed(1)}%` : '0%',\n      positive: true,\n      icon: BarChart3\n    }\n  ];\n\n  if (isLoading) {\n    return (\n      <div className=\"space-y-6\">\n        <div className=\"animate-pulse\">\n          <div className=\"h-8 bg-gray-200 rounded mb-4\"></div>\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6\">\n            {[1, 2, 3, 4].map((i) => (\n              <div key={i} className=\"h-32 bg-gray-200 rounded\"></div>\n            ))}\n          </div>\n          <div className=\"h-64 bg-gray-200 rounded\"></div>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Date Range Selector */}\n      <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between\">\n        <div>\n          <h2 className=\"text-xl font-bold text-[#203B17] mb-2\">Task Overview</h2>\n          <p className=\"text-gray-600\">Comprehensive analytics for {isViewingAllLocations ? 'all locations' : currentLocation.name}</p>\n        </div>\n        <div className=\"flex gap-2 mt-4 sm:mt-0\">\n          {['24h', '7d', '30d', '90d'].map((range) => (\n            <Button\n              key={range}\n              variant={dateRange === range ? 'default' : 'outline'}\n              onClick={() => setDateRange(range)}\n              className=\"text-sm\"\n            >\n              {range === '24h' ? '24h' : range === '7d' ? '7 days' : range === '30d' ? '30 days' : '90 days'}\n            </Button>\n          ))}\n        </div>\n      </div>\n      \n      {/* Key Metrics */}\n      <div className=\"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6\">\n        {metrics.map((metric, index) => (\n          <Card key={index} className=\"p-6\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <p className=\"text-sm font-medium text-gray-600\">{metric.label}</p>\n                <p className=\"text-2xl font-bold text-gray-900\">{metric.value}</p>\n                <p className={`text-sm ${metric.positive ? 'text-green-600' : 'text-red-600'}`}>\n                  {metric.change}\n                </p>\n              </div>\n              <div className=\"p-3 bg-blue-50 rounded-full\">\n                <metric.icon className=\"w-6 h-6 text-[#2D8028]\" />\n              </div>\n            </div>\n          </Card>\n        ))}\n      </div>\n      \n      {/* Charts Section */}\n      <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n        {/* Completion Trend */}\n        <Card className=\"p-6\">\n          <CardHeader>\n            <CardTitle>Task Completion Trend</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <ResponsiveContainer width=\"100%\" height={300}>\n              <LineChart data={trendData}>\n                <CartesianGrid strokeDasharray=\"3 3\" />\n                <XAxis dataKey=\"date\" />\n                <YAxis />\n                <Tooltip />\n                <Legend />\n                <Line \n                  type=\"monotone\" \n                  dataKey=\"completed\" \n                  stroke=\"#10b981\" \n                  strokeWidth={2}\n                  name=\"Completed\"\n                />\n                <Line \n                  type=\"monotone\" \n                  dataKey=\"assigned\" \n                  stroke=\"#6b7280\" \n                  strokeDasharray=\"5 5\"\n                  name=\"Assigned\"\n                />\n              </LineChart>\n            </ResponsiveContainer>\n          </CardContent>\n        </Card>\n        \n        {/* Task Type Distribution */}\n        <Card className=\"p-6\">\n          <CardHeader>\n            <CardTitle>Tasks by Type</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <ResponsiveContainer width=\"100%\" height={300}>\n              <PieChart>\n                <Pie\n                  data={taskTypeData}\n                  cx=\"50%\"\n                  cy=\"50%\"\n                  labelLine={false}\n                  label={({ name, percent }) => `${name} ${(percent * 100).toFixed(0)}%`}\n                  outerRadius={80}\n                  fill=\"#8884d8\"\n                  dataKey=\"value\"\n                >\n                  {taskTypeData.map((entry, index) => (\n                    <Cell key={`cell-${index}`} fill={entry.color} />\n                  ))}\n                </Pie>\n                <Tooltip />\n              </PieChart>\n            </ResponsiveContainer>\n          </CardContent>\n        </Card>\n        \n        {/* Time Distribution */}\n        <Card className=\"p-6\">\n          <CardHeader>\n            <CardTitle>Completion Time Distribution</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <ResponsiveContainer width=\"100%\" height={300}>\n              <BarChart data={timeDistribution}>\n                <CartesianGrid strokeDasharray=\"3 3\" />\n                <XAxis dataKey=\"range\" />\n                <YAxis />\n                <Tooltip />\n                <Bar dataKey=\"count\" fill=\"#3b82f6\" />\n              </BarChart>\n            </ResponsiveContainer>\n          </CardContent>\n        </Card>\n        \n        {/* Location Breakdown (if viewing all) */}\n        {isViewingAllLocations && (\n          <Card className=\"p-6\">\n            <CardHeader>\n              <CardTitle>Performance by Location</CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"space-y-4\">\n                <div className=\"space-y-2\">\n                  <h4 className=\"font-semibold\">Kenosha</h4>\n                  <div className=\"flex justify-between text-sm\">\n                    <span>Completion Rate:</span>\n                    <span className=\"font-medium\">94.2%</span>\n                  </div>\n                  <div className=\"flex justify-between text-sm\">\n                    <span>Avg. Time:</span>\n                    <span className=\"font-medium\">22.1 min</span>\n                  </div>\n                </div>\n                <div className=\"space-y-2\">\n                  <h4 className=\"font-semibold\">Racine (Dev)</h4>\n                  <div className=\"flex justify-between text-sm\">\n                    <span>Completion Rate:</span>\n                    <span className=\"font-medium\">91.8%</span>\n                  </div>\n                  <div className=\"flex justify-between text-sm\">\n                    <span>Avg. Time:</span>\n                    <span className=\"font-medium\">24.9 min</span>\n                  </div>\n                </div>\n                <div className=\"space-y-2\">\n                  <h4 className=\"font-semibold\">Milwaukee</h4>\n                  <div className=\"flex justify-between text-sm\">\n                    <span>Completion Rate:</span>\n                    <span className=\"font-medium\">89.5%</span>\n                  </div>\n                  <div className=\"flex justify-between text-sm\">\n                    <span>Avg. Time:</span>\n                    <span className=\"font-medium\">26.3 min</span>\n                  </div>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        )}\n      </div>\n      \n      {/* Recent Activity Table */}\n      <Card className=\"p-6\">\n        <CardHeader>\n          <CardTitle>Recent Task Completions</CardTitle>\n        </CardHeader>\n        <CardContent>\n          <div className=\"overflow-x-auto\">\n            <table className=\"w-full border-collapse\">\n              <thead>\n                <tr className=\"border-b\">\n                  <th className=\"text-left p-2 font-medium\">Task</th>\n                  <th className=\"text-left p-2 font-medium\">Status</th>\n                  <th className=\"text-left p-2 font-medium\">Time Taken</th>\n                  <th className=\"text-left p-2 font-medium\">Priority</th>\n                  <th className=\"text-left p-2 font-medium\">Created</th>\n                </tr>\n              </thead>\n              <tbody>\n                {filteredTasks.slice(0, 10).map((task) => (\n                  <tr key={task.id} className=\"border-b hover:bg-gray-50\">\n                    <td className=\"p-2\">\n                      <div className=\"font-medium\">{task.title}</div>\n                      <div className=\"text-sm text-gray-500\">{task.description}</div>\n                    </td>\n                    <td className=\"p-2\">\n                      <Badge variant={\n                        task.status === 'completed' ? 'default' : \n                        task.status === 'in_progress' ? 'secondary' : \n                        'outline'\n                      }>\n                        {task.status.replace('_', ' ')}\n                      </Badge>\n                    </td>\n                    <td className=\"p-2 text-sm\">\n                      {task.actualTime || task.estimatedTime || 0} min\n                    </td>\n                    <td className=\"p-2\">\n                      <Badge variant={task.priority === 'high' ? 'destructive' : task.priority === 'medium' ? 'secondary' : 'outline'}>\n                        {task.priority}\n                      </Badge>\n                    </td>\n                    <td className=\"p-2 text-sm text-gray-500\">\n                      {new Date(task.createdAt).toLocaleDateString()}\n                    </td>\n                  </tr>\n                ))}\n              </tbody>\n            </table>\n          </div>\n        </CardContent>\n      </Card>\n      \n      {/* Original filters and table for backward compatibility */}\n      <TaskDataFilters\n        filters={filters}\n        setFilters={setFilters}\n        tasks={tasks}\n      />\n      \n      <MetricsCards tasks={filteredTasks} />\n      \n      <TaskDataTable tasks={filteredTasks} />\n    </div>\n  );\n};","path":null,"size_bytes":34982,"size_tokens":null},"client/src/pages/DevTools.tsx":{"content":"import React, { useState, useEffect } from 'react';\nimport { useLocation as useWouterLocation } from 'wouter';\nimport { useUser } from '@/contexts/UserContext';\nimport { useToast } from '@/hooks/use-toast';\nimport { apiRequest } from '@/lib/queryClient';\nimport type { Task } from '@shared/schema';\nimport { Button } from '@/components/ui/button';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Shield, SkipForward, Trash2, ArrowLeft, Settings, Bug, Monitor, RotateCcw } from 'lucide-react';\nimport { detectIOSEnvironment, testStorageAvailability } from '@/config/authConfig';\n\nconst DevTools = () => {\n  const [, setLocation] = useWouterLocation();\n  const [isProcessing, setIsProcessing] = useState(false);\n  const [debugLogs, setDebugLogs] = useState<any[]>([]);\n  const [deviceInfo, setDeviceInfo] = useState<any>({});\n  const [verificationReport, setVerificationReport] = useState<any>(null);\n  const [isVerificationLoading, setIsVerificationLoading] = useState(false);\n  const { toast } = useToast();\n  const { currentUser } = useUser();\n\n  // Check access for Corporate users only\n  \n  // Only allow access for Corporate users (Robert and Matt)\n  console.log('üõ†Ô∏è DevTools Access Check:', {\n    currentUser,\n    hasCurrentUser: !!currentUser,\n    role: currentUser?.role,\n    email: currentUser?.email,\n    allowedEmails: ['robert@growspace.farm', 'matt@growspace.farm']\n  });\n  \n  const hasAccess = currentUser && \n    (currentUser.role?.includes('Corporate') || currentUser.role?.includes('Manager')) && \n    (currentUser.email === 'robert@growspace.farm' || currentUser.email === 'matt@growspace.farm');\n\n  // Load debug information\n  useEffect(() => {\n    if (!hasAccess) return;\n    \n    // Get device info\n    const { isIOS, isTeamsApp, isWebView, isSafari } = detectIOSEnvironment();\n    const storageInfo = testStorageAvailability();\n    \n    setDeviceInfo({\n      isIOS,\n      isTeamsApp, \n      isWebView,\n      isSafari,\n      userAgent: navigator.userAgent,\n      screen: `${window.screen.width}x${window.screen.height}`,\n      viewport: `${window.innerWidth}x${window.innerHeight}`,\n      cookies: navigator.cookieEnabled,\n      online: navigator.onLine,\n      storage: storageInfo,\n      language: navigator.language,\n      platform: navigator.platform\n    });\n    \n    // Load existing debug logs\n    const storedLogs = sessionStorage.getItem('authDebugLogs');\n    if (storedLogs) {\n      try {\n        setDebugLogs(JSON.parse(storedLogs));\n      } catch (e) {\n        console.warn('Failed to parse debug logs:', e);\n      }\n    }\n    \n    // Update logs every 5 seconds (less frequent than the corner debug panel)\n    const interval = setInterval(() => {\n      const storedLogs = sessionStorage.getItem('authDebugLogs');\n      if (storedLogs) {\n        try {\n          const logs = JSON.parse(storedLogs);\n          setDebugLogs(logs);\n        } catch (e) {\n          console.warn('Failed to parse debug logs:', e);\n        }\n      }\n    }, 5000);\n    \n    return () => clearInterval(interval);\n  }, [hasAccess]);\n\n  // Load verification report\n  const fetchVerificationReport = async () => {\n    try {\n      const response = await apiRequest('GET', '/api/dev/verification-report');\n      setVerificationReport(response);\n    } catch (error) {\n      console.error('Failed to fetch verification report:', error);\n    }\n  };\n\n  // Auto-fetch verification report on load and then periodically\n  useEffect(() => {\n    if (!hasAccess) return;\n    \n    fetchVerificationReport();\n    \n    // Update verification report every 30 seconds\n    const interval = setInterval(fetchVerificationReport, 30000);\n    return () => clearInterval(interval);\n  }, [hasAccess]);\n\n  // Manual verification trigger\n  const runManualVerification = async () => {\n    setIsVerificationLoading(true);\n    try {\n      const response = await apiRequest('POST', '/api/dev/run-verification', {});\n      \n      toast({\n        title: 'Verification Complete',\n        description: `Created ${response.result.missingTasksCreated} missing tasks, removed ${response.result.duplicatesRemoved} duplicates`,\n      });\n      \n      // Refresh the verification report\n      await fetchVerificationReport();\n    } catch (error) {\n      console.error('Manual verification failed:', error);\n      toast({\n        title: 'Verification Failed',\n        description: 'Failed to run verification. Check console for details.',\n        variant: 'destructive',\n      });\n    } finally {\n      setIsVerificationLoading(false);\n    }\n  };\n\n  // Auto-generate missing tasks on load (improved 31-day system)\n  useEffect(() => {\n    if (!hasAccess) return;\n\n    const autoPopulateIfNeeded = async () => {\n      try {\n        console.log('üîÑ Checking if task auto-generation is needed...');\n        \n        // Get existing tasks\n        const tasksResponse = await apiRequest('GET', '/api/tasks');\n        const existingTasks = await tasksResponse.json();\n        \n        if (existingTasks.length === 0) {\n          console.log('üìã No existing tasks found - running full 31-day population');\n          \n          const today = new Date();\n          today.setHours(0, 0, 0, 0);\n          \n          let totalCreated = 0;\n          \n          // Generate for each of the next 31 days\n          for (let day = 0; day <= 31; day++) {\n            const targetDate = new Date(today);\n            targetDate.setDate(today.getDate() + day);\n            \n            const created = await generateTasksForFutureDate(targetDate);\n            totalCreated += created;\n          }\n          \n          if (totalCreated > 0) {\n            console.log(`‚úÖ Auto-populated ${totalCreated} tasks for next 31 days`);\n            toast({\n              title: 'Auto-Population Complete',\n              description: `Generated ${totalCreated} tasks for the next 31 days.`,\n            });\n          }\n        } else {\n          console.log('üìã Existing tasks found - running daily generation check');\n          \n          const today = new Date();\n          today.setHours(0, 0, 0, 0);\n          \n          // Just generate for today's future date (31 days from now)\n          const futureDate = new Date(today);\n          futureDate.setDate(today.getDate() + 31);\n          \n          const created = await generateTasksForFutureDate(futureDate);\n          \n          if (created > 0) {\n            console.log(`‚úÖ Auto-generated ${created} tasks for ${futureDate.toDateString()}`);\n            toast({\n              title: 'Auto-Generation Complete',\n              description: `Generated ${created} missing tasks for future date.`,\n            });\n          } else {\n            console.log('‚úÖ All tasks up to date - no generation needed');\n          }\n        }\n        \n      } catch (error) {\n        console.error('‚ùå Failed to auto-generate tasks:', error);\n      }\n    };\n    \n    // Run auto-generation after a short delay to let the page load\n    const timeoutId = setTimeout(autoPopulateIfNeeded, 2000);\n    \n    return () => clearTimeout(timeoutId);\n  }, [hasAccess]);\n\n  if (!hasAccess) {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center p-4\">\n        <Card className=\"w-full max-w-md\">\n          <CardHeader className=\"text-center\">\n            <CardTitle className=\"text-red-600\">Access Denied</CardTitle>\n            <CardDescription>\n              Developer tools are restricted to corporate managers only.\n            </CardDescription>\n          </CardHeader>\n          <CardContent className=\"text-center\">\n            <Button onClick={() => setLocation('/')} variant=\"outline\">\n              <ArrowLeft className=\"w-4 h-4 mr-2\" />\n              Go Back\n            </Button>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  // Skip all overdue tasks\n  const skipAllOverdueTasks = async () => {\n    if (!window.confirm('This will skip ALL overdue tasks. Are you sure?')) {\n      return;\n    }\n\n    setIsProcessing(true);\n    try {\n      // Get all tasks from the API\n      const response = await fetch('/api/tasks');\n      if (!response.ok) throw new Error('Failed to fetch tasks');\n      const tasks = await response.json();\n      \n      // Find overdue tasks\n      const now = new Date();\n      const overdueTasks = tasks.filter((task: Task) => \n        task.status !== 'completed' && \n        task.status !== 'skipped' && \n        task.dueDate && new Date(task.dueDate) < now\n      );\n\n      // Skip each overdue task\n      let skippedCount = 0;\n      for (const task of overdueTasks) {\n        try {\n          await apiRequest('PATCH', `/api/tasks/${task.id}`, {\n            status: 'skipped',\n            skipReason: 'Bulk skip via dev tools',\n            skippedAt: now.toISOString()\n          });\n          skippedCount++;\n        } catch (error) {\n          console.error(`Failed to skip task ${task.id}:`, error);\n        }\n      }\n\n      toast({\n        title: `Skipped ${skippedCount} overdue tasks`,\n        description: `Successfully processed ${skippedCount} out of ${overdueTasks.length} overdue tasks`,\n      });\n    } catch (error) {\n      console.error('Error skipping tasks:', error);\n      toast({\n        title: 'Error',\n        description: 'Failed to skip overdue tasks. Check console for details.',\n        variant: 'destructive',\n      });\n    } finally {\n      setIsProcessing(false);\n    }\n  };\n\n  // Delete all tasks (but keep recurring templates)\n  const deleteAllTasks = async () => {\n    if (!window.confirm('‚ö†Ô∏è This will DELETE ALL TASKS. Recurring templates will remain. Continue?')) {\n      return;\n    }\n    \n    setIsProcessing(true);\n    try {\n      // Get all tasks\n      const response = await apiRequest('GET', '/api/tasks');\n      const allTasks = await response.json();\n      \n      console.log(`Deleting ${allTasks.length} tasks...`);\n      \n      let deleted = 0;\n      for (const task of allTasks) {\n        try {\n          await apiRequest('DELETE', `/api/tasks/${task.id}`);\n          deleted++;\n        } catch (error) {\n          console.error(`Failed to delete task ${task.id}:`, error);\n        }\n      }\n      \n      console.log(`Deleted ${deleted} tasks. Ready for fresh generation.`);\n      toast({\n        title: 'Tasks Deleted',\n        description: `Successfully deleted ${deleted} tasks. Recurring templates preserved.`,\n      });\n      \n      // Small delay before reload\n      setTimeout(() => {\n        window.location.reload();\n      }, 1000);\n      \n    } catch (error) {\n      console.error('Failed to delete tasks:', error);\n      toast({\n        title: 'Error',\n        description: 'Failed to delete all tasks. See console for details.',\n        variant: 'destructive',\n      });\n    } finally {\n      setIsProcessing(false);\n    }\n  };\n\n  // Debug function to test what we're actually getting\n  const debugRecurringTasks = async () => {\n    console.log('=== GENERATION DEBUG ===');\n    \n    try {\n      console.log('Testing recurring tasks API...');\n      const response = await apiRequest('GET', '/api/recurring-tasks');\n      const templates = await response.json();\n      \n      console.log('üìã Recurring templates loaded:', templates.length);\n      console.log('üìã First few templates:', templates.slice(0, 3));\n      console.log('üìã Template IDs found:', templates.map((t: any) => t.id));\n      \n      toast({\n        title: 'Debug Complete',\n        description: `Found ${templates.length} templates. Check console for details.`,\n      });\n      \n    } catch (error) {\n      console.error('‚ùå Failed to load recurring tasks:', error);\n      toast({\n        title: 'Debug Failed', \n        description: 'Could not load recurring tasks. Check console.',\n        variant: 'destructive',\n      });\n    }\n  };\n\n  // Test creating a single task\n  const testCreateSingleTask = async () => {\n    console.log('=== SINGLE TASK TEST ===');\n    \n    try {\n      // Get the first recurring task template\n      const response = await apiRequest('GET', '/api/recurring-tasks');\n      const templates = await response.json();\n      \n      if (templates.length === 0) {\n        console.error('‚ùå No recurring templates found!');\n        toast({\n          title: 'No Templates',\n          description: 'No recurring task templates found in database.',\n          variant: 'destructive',\n        });\n        return;\n      }\n      \n      const firstTemplate = templates[0];\n      console.log('üéØ Using template:', firstTemplate);\n      \n      const testTask = {\n        title: `üß™ TEST: ${firstTemplate.title}`,\n        description: firstTemplate.description || 'Test task generated',\n        type: firstTemplate.type || 'general',\n        priority: firstTemplate.priority || 'medium',\n        status: 'pending',\n        dueDate: new Date().toISOString(),\n        location: firstTemplate.location || 'Kenosha',\n        assignTo: firstTemplate.assignTo || null,\n        estimatedDuration: firstTemplate.estimatedDuration || 30,\n        requiresApproval: firstTemplate.requiresApproval || false,\n        checklist: firstTemplate.checklist || [],\n        recurringTaskId: firstTemplate.id,\n        completedBy: null,\n        completedAt: null,\n        approvedBy: null,\n        approvedAt: null,\n        notes: '',\n        timeTracking: {\n          startTime: null,\n          endTime: null,\n          totalMinutes: 0,\n          isPaused: false,\n          pausedTime: 0\n        }\n      };\n      \n      console.log('üéØ Creating test task:', testTask);\n      \n      const createResponse = await apiRequest('POST', '/api/tasks', testTask);\n      \n      if (createResponse.ok) {\n        console.log('‚úÖ Test task created successfully!');\n        toast({\n          title: 'Test Success',\n          description: 'Single test task created successfully!',\n        });\n        \n        // Reload after success\n        setTimeout(() => window.location.reload(), 1000);\n      } else {\n        const errorData = await createResponse.json();\n        console.error('‚ùå Test task creation failed:', errorData);\n        toast({\n          title: 'Test Failed',\n          description: 'Single task creation failed. Check console.',\n          variant: 'destructive',\n        });\n      }\n      \n    } catch (error) {\n      console.error('‚ùå Test failed with error:', error);\n      toast({\n        title: 'Test Error',\n        description: 'Test failed with error. Check console.',\n        variant: 'destructive',\n      });\n    }\n  };\n\n  // Generate tasks for a specific future date (improved 31-day system)\n  const generateTasksForFutureDate = async (futureDate: Date) => {\n    const response = await apiRequest('GET', '/api/recurring-tasks');\n    const recurringTemplates = await response.json();\n    \n    console.log(`üîç DEBUG: Found ${recurringTemplates.length} templates`);\n    console.log(`üîç DEBUG: Template IDs:`, recurringTemplates.map((t: any) => t.id));\n    \n    const dayOfMonth = futureDate.getDate();\n    // FIXED: Use UTC-aware day calculation to avoid timezone issues\n    const dayOfWeek = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'][futureDate.getUTCDay()];\n    const month = futureDate.getMonth();\n    const year = futureDate.getFullYear();\n    \n    let created = 0;\n    \n    for (const template of recurringTemplates) {\n      let shouldCreate = false;\n      let taskConfig: any = null;\n      \n      switch (template.frequency) {\n        case 'daily': // This is actually weekly tasks\n          // Check if template has selectedDays or activeDays\n          const activeDays = template.activeDays || template.selectedDays || ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];\n          if (activeDays.includes(dayOfWeek)) {\n            shouldCreate = true;\n            taskConfig = {\n              id: `${template.id}-${futureDate.toISOString().split('T')[0]}`,\n              dueDate: futureDate.toISOString(),\n            };\n          }\n          break;\n          \n        case 'weekly': // Same as daily for now\n          const weeklyDays = template.activeDays || template.selectedDays || ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];\n          if (weeklyDays.includes(dayOfWeek)) {\n            shouldCreate = true;\n            taskConfig = {\n              id: `${template.id}-${futureDate.toISOString().split('T')[0]}`,\n              dueDate: futureDate.toISOString(),\n            };\n          }\n          break;\n          \n        case 'biweekly':\n        case 'bi-weekly':\n          // First half: generate on 1st for days 1-14\n          if (dayOfMonth === 1) {\n            shouldCreate = true;\n            const midMonth = new Date(year, month, 14);\n            taskConfig = {\n              id: `${template.id}-${year}-${String(month + 1).padStart(2, '0')}-01`,\n              dueDate: midMonth.toISOString(),\n              periodLabel: '1st-14th'\n            };\n          }\n          // Second half: generate on 15th for days 15-end\n          else if (dayOfMonth === 15) {\n            const lastDay = new Date(year, month + 1, 0);\n            shouldCreate = true;\n            taskConfig = {\n              id: `${template.id}-${year}-${String(month + 1).padStart(2, '0')}-15`,\n              dueDate: lastDay.toISOString(),\n              periodLabel: `15th-${lastDay.getDate()}th`\n            };\n          }\n          break;\n          \n        case 'monthly':\n          if (dayOfMonth === 1) {\n            const lastDay = new Date(year, month + 1, 0);\n            shouldCreate = true;\n            taskConfig = {\n              id: `${template.id}-${year}-${String(month + 1).padStart(2, '0')}`,\n              dueDate: lastDay.toISOString(),\n            };\n          }\n          break;\n          \n        case 'quarterly':\n          const quarterStartMonths = [0, 3, 6, 9]; // Jan, Apr, Jul, Oct\n          if (quarterStartMonths.includes(month) && dayOfMonth === 1) {\n            const quarter = Math.floor(month / 3) + 1;\n            const quarterEndDate = new Date(year, month + 3, 0); // Last day of quarter\n            shouldCreate = true;\n            taskConfig = {\n              id: `${template.id}-${year}-Q${quarter}`,\n              dueDate: quarterEndDate.toISOString(),\n              periodLabel: `Q${quarter}`\n            };\n          }\n          break;\n      }\n      \n      if (shouldCreate && taskConfig) {\n        // Check if task already exists by checking for similar tasks\n        const existingTasksResponse = await apiRequest('GET', '/api/tasks');\n        const existingTasks = await existingTasksResponse.json();\n        \n        const dateStr = futureDate.toISOString().split('T')[0];\n        const exists = existingTasks.find((task: any) => \n          task.recurringTaskId === template.id && \n          task.dueDate?.startsWith(dateStr)\n        );\n        \n        if (!exists) {\n          const newTask = {\n            title: template.title,\n            description: template.description || '',\n            type: template.type || 'general',\n            priority: template.priority || 'medium',\n            status: 'pending',\n            dueDate: taskConfig.dueDate,\n            location: template.location || 'Unknown',\n            assignTo: template.assignTo || null,\n            estimatedDuration: template.estimatedDuration || 30,\n            requiresApproval: template.requiresApproval || false,\n            checklist: template.checklist || [],\n            recurringTaskId: template.id,\n            completedBy: null,\n            completedAt: null,\n            approvedBy: null,\n            approvedAt: null,\n            notes: '',\n            timeTracking: {\n              startTime: null,\n              endTime: null,\n              totalMinutes: 0,\n              isPaused: false,\n              pausedTime: 0\n            }\n          };\n          \n          try {\n            await apiRequest('POST', '/api/tasks', newTask);\n            created++;\n            console.log(`‚úÖ Created: ${newTask.title} for ${dateStr}`);\n          } catch (error) {\n            console.error(`‚ùå Failed to create task for template ${template.id}:`, error);\n          }\n        }\n      }\n    }\n    \n    return created;\n  };\n\n  // Populate next 31 days (initial setup)\n  const populateNext31Days = async () => {\n    setIsProcessing(true);\n    try {\n      console.log('üîÑ Populating tasks for next 31 days...');\n      \n      const today = new Date();\n      today.setHours(0, 0, 0, 0);\n      \n      let totalCreated = 0;\n      \n      // Generate for each of the next 31 days\n      for (let day = 0; day <= 31; day++) {\n        const targetDate = new Date(today);\n        targetDate.setDate(today.getDate() + day);\n        \n        const created = await generateTasksForFutureDate(targetDate);\n        totalCreated += created;\n      }\n      \n      console.log(`‚úÖ Population complete - created ${totalCreated} tasks`);\n      toast({\n        title: 'Tasks Generated',\n        description: `Successfully generated ${totalCreated} tasks for the next 31 days.`,\n      });\n      \n      // Small delay before reload\n      setTimeout(() => {\n        window.location.reload();\n      }, 1000);\n      \n    } catch (error) {\n      console.error('‚ùå Failed to populate tasks:', error);\n      toast({\n        title: 'Error',\n        description: 'Failed to generate tasks. See console for details.',\n        variant: 'destructive',\n      });\n    } finally {\n      setIsProcessing(false);\n    }\n  };\n\n  // Daily generation process (maintains 31-day buffer)\n  const runDailyGeneration = async () => {\n    setIsProcessing(true);\n    try {\n      const today = new Date();\n      today.setHours(0, 0, 0, 0);\n      \n      // Calculate the date 31 days from now\n      const futureDate = new Date(today);\n      futureDate.setDate(today.getDate() + 31);\n      \n      console.log(`üéØ Generating tasks for ${futureDate.toDateString()}`);\n      const created = await generateTasksForFutureDate(futureDate);\n      \n      if (created > 0) {\n        console.log(`‚úÖ Daily generation complete - created ${created} tasks`);\n        toast({\n          title: 'Daily Generation Complete',\n          description: `Generated ${created} tasks for ${futureDate.toDateString()}.`,\n        });\n      } else {\n        console.log('‚úÖ Daily generation complete - no new tasks needed');\n        toast({\n          title: 'Daily Generation Complete',\n          description: 'No new tasks needed for the future date.',\n        });\n      }\n      \n    } catch (error) {\n      console.error('‚ùå Daily generation failed:', error);\n      toast({\n        title: 'Error',\n        description: 'Daily generation failed. See console for details.',\n        variant: 'destructive',\n      });\n    } finally {\n      setIsProcessing(false);\n    }\n  };\n\n\n  // Clear debug logs\n  const clearDebugLogs = () => {\n    sessionStorage.removeItem('authDebugLogs');\n    setDebugLogs([]);\n    \n    toast({\n      title: 'Debug Logs Cleared',\n      description: 'All authentication debug logs have been removed.',\n    });\n  };\n\n  // Clear all test data (this would need API endpoints to clear data safely)\n  const clearTestData = async () => {\n    if (!window.confirm('This will clear ALL test tasks and data. Are you sure? This action cannot be undone.')) {\n      return;\n    }\n\n    setIsProcessing(true);\n    try {\n      // Note: In a real implementation, you'd want specific API endpoints for this\n      // For now, we'll just clear localStorage dev settings\n      \n      toast({\n        title: 'Test Data Cleared',\n        description: 'Development settings have been reset. Database clearing would need API endpoints.',\n        variant: 'default',\n      });\n    } catch (error) {\n      console.error('Error clearing test data:', error);\n      toast({\n        title: 'Error',\n        description: 'Failed to clear test data. Check console for details.',\n        variant: 'destructive',\n      });\n    } finally {\n      setIsProcessing(false);\n    }\n  };\n\n  return (\n    <div className=\"min-h-screen bg-gray-50 p-4\">\n      <div className=\"max-w-4xl mx-auto space-y-6\">\n        {/* Header */}\n        <div className=\"flex items-center justify-between\">\n          <div>\n            <h1 className=\"text-3xl font-bold text-[#203B17] flex items-center gap-2\">\n              <Settings className=\"w-8 h-8\" />\n              Developer Tools\n            </h1>\n            <p className=\"text-gray-600 mt-1\">Testing utilities for development</p>\n          </div>\n          <Button onClick={() => setLocation('/')} variant=\"outline\">\n            <ArrowLeft className=\"w-4 h-4 mr-2\" />\n            Back to App\n          </Button>\n        </div>\n\n        {/* User Info */}\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"text-sm\">Current User</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <p><strong>Name:</strong> {currentUser?.name}</p>\n            <p><strong>Email:</strong> {currentUser?.email}</p>\n            <p><strong>Role:</strong> {currentUser?.role}</p>\n          </CardContent>\n        </Card>\n\n        {/* Developer Tools */}\n        <div className=\"grid gap-6 md:grid-cols-2 lg:grid-cols-3\">\n          {/* Skip All Overdue Tasks */}\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <SkipForward className=\"w-5 h-5\" />\n                Skip Overdue Tasks\n              </CardTitle>\n              <CardDescription>\n                Mark all currently overdue tasks as skipped\n              </CardDescription>\n            </CardHeader>\n            <CardContent>\n              <Button\n                onClick={skipAllOverdueTasks}\n                disabled={isProcessing}\n                className=\"w-full bg-orange-600 hover:bg-orange-700\"\n                data-testid=\"button-skip-overdue-tasks\"\n              >\n                {isProcessing ? (\n                  'Processing...'\n                ) : (\n                  <>\n                    <SkipForward className=\"w-4 h-4 mr-2\" />\n                    Skip All Overdue\n                  </>\n                )}\n              </Button>\n            </CardContent>\n          </Card>\n\n          {/* Clear Test Data */}\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Trash2 className=\"w-5 h-5\" />\n                Clear Test Data\n              </CardTitle>\n              <CardDescription>\n                Remove development settings and reset testing state\n              </CardDescription>\n            </CardHeader>\n            <CardContent>\n              <Button\n                onClick={clearTestData}\n                disabled={isProcessing}\n                variant=\"destructive\"\n                className=\"w-full\"\n                data-testid=\"button-clear-test-data\"\n              >\n                {isProcessing ? (\n                  'Processing...'\n                ) : (\n                  <>\n                    <Trash2 className=\"w-4 h-4 mr-2\" />\n                    Clear Test Data\n                  </>\n                )}\n              </Button>\n            </CardContent>\n          </Card>\n\n          {/* Delete All Tasks */}\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Trash2 className=\"w-5 h-5\" />\n                Delete All Tasks\n              </CardTitle>\n              <CardDescription>\n                Remove ALL task instances while preserving recurring templates\n              </CardDescription>\n            </CardHeader>\n            <CardContent>\n              <Button\n                onClick={deleteAllTasks}\n                disabled={isProcessing}\n                variant=\"destructive\"\n                className=\"w-full bg-red-600 hover:bg-red-700\"\n                data-testid=\"button-delete-all-tasks\"\n              >\n                {isProcessing ? (\n                  'Deleting...'\n                ) : (\n                  <>\n                    <Trash2 className=\"w-4 h-4 mr-2\" />\n                    üóëÔ∏è DELETE ALL TASKS (Start Fresh)\n                  </>\n                )}\n              </Button>\n            </CardContent>\n          </Card>\n\n          {/* Debug Tools */}\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Settings className=\"w-5 h-5\" />\n                Debug Generation Issues\n              </CardTitle>\n              <CardDescription>\n                Test what's causing the foreign key constraint errors\n              </CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-3\">\n              <Button\n                onClick={debugRecurringTasks}\n                disabled={isProcessing}\n                className=\"w-full bg-purple-600 hover:bg-purple-700\"\n                data-testid=\"button-debug-recurring\"\n              >\n                <Settings className=\"w-4 h-4 mr-2\" />\n                üîç Debug Recurring Tasks API\n              </Button>\n              \n              <Button\n                onClick={testCreateSingleTask}\n                disabled={isProcessing}\n                className=\"w-full bg-red-600 hover:bg-red-700\"\n                data-testid=\"button-test-single\"\n              >\n                <Settings className=\"w-4 h-4 mr-2\" />\n                üß™ Create ONE Test Task\n              </Button>\n            </CardContent>\n          </Card>\n\n          {/* Populate 31 Days */}\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <RotateCcw className=\"w-5 h-5\" />\n                Populate Next 31 Days\n              </CardTitle>\n              <CardDescription>\n                Generate task instances for the entire next 31 days (initial setup)\n              </CardDescription>\n            </CardHeader>\n            <CardContent>\n              <Button\n                onClick={populateNext31Days}\n                disabled={isProcessing}\n                className=\"w-full bg-green-600 hover:bg-green-700\"\n                data-testid=\"button-populate-31-days\"\n              >\n                {isProcessing ? (\n                  'Generating...'\n                ) : (\n                  <>\n                    <RotateCcw className=\"w-4 h-4 mr-2\" />\n                    üîÑ Generate All (Next 31 Days)\n                  </>\n                )}\n              </Button>\n            </CardContent>\n          </Card>\n\n          {/* Daily Generation */}\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Settings className=\"w-5 h-5\" />\n                Daily Generation\n              </CardTitle>\n              <CardDescription>\n                Generate tasks for date 31 days from now (maintains rolling buffer)\n              </CardDescription>\n            </CardHeader>\n            <CardContent>\n              <Button\n                onClick={runDailyGeneration}\n                disabled={isProcessing}\n                className=\"w-full bg-blue-600 hover:bg-blue-700\"\n                data-testid=\"button-daily-generation\"\n              >\n                {isProcessing ? (\n                  'Generating...'\n                ) : (\n                  <>\n                    <Settings className=\"w-4 h-4 mr-2\" />\n                    üéØ Generate Today's Future Tasks\n                  </>\n                )}\n              </Button>\n            </CardContent>\n          </Card>\n\n          {/* Task Verification System */}\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Shield className=\"w-5 h-5\" />\n                Task Verification System\n              </CardTitle>\n              <CardDescription>\n                Automated verification that checks for missing tasks and removes duplicates\n              </CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                {/* System Status */}\n                <div className=\"p-3 bg-gray-50 rounded-lg\">\n                  <h4 className=\"font-medium text-sm mb-2\">System Status</h4>\n                  <div className=\"space-y-1 text-xs\">\n                    <div className=\"flex justify-between\">\n                      <span>Status:</span>\n                      <span className=\"text-green-600 font-medium\">\n                        {verificationReport?.systemStatus?.verificationEnabled ? '‚úÖ Active' : '‚ùå Inactive'}\n                      </span>\n                    </div>\n                    <div className=\"flex justify-between\">\n                      <span>Last Run:</span>\n                      <span className=\"font-mono\">\n                        {verificationReport?.systemStatus?.lastRunTime \n                          ? new Date(verificationReport.systemStatus.lastRunTime).toLocaleString()\n                          : 'Never'\n                        }\n                      </span>\n                    </div>\n                    <div className=\"flex justify-between\">\n                      <span>Triggered By:</span>\n                      <span className=\"font-mono\">\n                        {verificationReport?.systemStatus?.triggeredBy || 'none'}\n                      </span>\n                    </div>\n                  </div>\n                </div>\n\n                {/* Last Verification Results */}\n                <div className=\"p-3 bg-gray-50 rounded-lg\">\n                  <h4 className=\"font-medium text-sm mb-2\">Last Verification</h4>\n                  <div className=\"space-y-1 text-xs\">\n                    <div className=\"flex justify-between\">\n                      <span>Missing Tasks Created:</span>\n                      <span className=\"font-mono text-blue-600\">\n                        {verificationReport?.lastVerificationResult?.missingTasksCreated || 0}\n                      </span>\n                    </div>\n                    <div className=\"flex justify-between\">\n                      <span>Duplicates Removed:</span>\n                      <span className=\"font-mono text-red-600\">\n                        {verificationReport?.lastVerificationResult?.duplicatesRemoved || 0}\n                      </span>\n                    </div>\n                    <div className=\"flex justify-between\">\n                      <span>Errors:</span>\n                      <span className=\"font-mono text-red-600\">\n                        {verificationReport?.lastVerificationResult?.errors?.length || 0}\n                      </span>\n                    </div>\n                  </div>\n                </div>\n              </div>\n\n              {/* Verification Details */}\n              {verificationReport?.lastVerificationResult?.verificationReport && (\n                <div className=\"p-3 bg-blue-50 rounded-lg\">\n                  <h4 className=\"font-medium text-sm mb-2\">Verification Report</h4>\n                  <div className=\"space-y-1 text-xs max-h-32 overflow-y-auto\">\n                    {verificationReport.lastVerificationResult.verificationReport.map((line: string, idx: number) => (\n                      <div key={idx} className=\"font-mono text-gray-700\">{line}</div>\n                    ))}\n                  </div>\n                </div>\n              )}\n\n              {/* Manual Trigger */}\n              <Button\n                onClick={runManualVerification}\n                disabled={isVerificationLoading}\n                className=\"w-full bg-green-600 hover:bg-green-700\"\n                data-testid=\"button-run-verification\"\n              >\n                {isVerificationLoading ? (\n                  'Running Verification...'\n                ) : (\n                  <>\n                    <Shield className=\"w-4 h-4 mr-2\" />\n                    üîç Run Manual Verification\n                  </>\n                )}\n              </Button>\n            </CardContent>\n          </Card>\n\n          {/* Device Info */}\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Monitor className=\"w-5 h-5\" />\n                Device Information\n              </CardTitle>\n              <CardDescription>\n                Device and browser environment details\n              </CardDescription>\n            </CardHeader>\n            <CardContent>\n              <div className=\"space-y-1 text-sm\">\n                <div className=\"flex justify-between\">\n                  <span>Platform:</span>\n                  <span className=\"font-mono text-xs\">{deviceInfo.platform || 'N/A'}</span>\n                </div>\n                <div className=\"flex justify-between\">\n                  <span>Screen:</span>\n                  <span className=\"font-mono text-xs\">{deviceInfo.screen || 'N/A'}</span>\n                </div>\n                <div className=\"flex justify-between\">\n                  <span>Viewport:</span>\n                  <span className=\"font-mono text-xs\">{deviceInfo.viewport || 'N/A'}</span>\n                </div>\n                <div className=\"flex justify-between\">\n                  <span>iOS:</span>\n                  <span>{deviceInfo.isIOS ? '‚úÖ' : '‚ùå'}</span>\n                </div>\n                <div className=\"flex justify-between\">\n                  <span>Teams App:</span>\n                  <span>{deviceInfo.isTeamsApp ? '‚úÖ' : '‚ùå'}</span>\n                </div>\n                <div className=\"flex justify-between\">\n                  <span>WebView:</span>\n                  <span>{deviceInfo.isWebView ? '‚úÖ' : '‚ùå'}</span>\n                </div>\n                <div className=\"flex justify-between\">\n                  <span>Safari:</span>\n                  <span>{deviceInfo.isSafari ? '‚úÖ' : '‚ùå'}</span>\n                </div>\n                <div className=\"flex justify-between\">\n                  <span>Cookies:</span>\n                  <span>{deviceInfo.cookies ? '‚úÖ' : '‚ùå'}</span>\n                </div>\n                <div className=\"flex justify-between\">\n                  <span>Online:</span>\n                  <span>{deviceInfo.online ? '‚úÖ' : '‚ùå'}</span>\n                </div>\n                {deviceInfo.storage && (\n                  <>\n                    <div className=\"flex justify-between\">\n                      <span>Local Storage:</span>\n                      <span>{deviceInfo.storage.localStorage ? '‚úÖ' : '‚ùå'}</span>\n                    </div>\n                    <div className=\"flex justify-between\">\n                      <span>Session Storage:</span>\n                      <span>{deviceInfo.storage.sessionStorage ? '‚úÖ' : '‚ùå'}</span>\n                    </div>\n                  </>\n                )}\n              </div>\n            </CardContent>\n          </Card>\n\n          {/* Debug Logs */}\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Bug className=\"w-5 h-5\" />\n                Auth Debug Logs ({debugLogs.length})\n              </CardTitle>\n              <CardDescription>\n                Recent authentication debug information\n              </CardDescription>\n            </CardHeader>\n            <CardContent>\n              <div className=\"space-y-2 max-h-48 overflow-y-auto\">\n                {debugLogs.length === 0 ? (\n                  <div className=\"text-sm text-gray-500 italic\">No debug logs yet...</div>\n                ) : (\n                  debugLogs.slice(-10).reverse().map((log: any, i: number) => (\n                    <div key={i} className=\"text-xs p-2 bg-gray-100 rounded border-l-2 border-blue-400\">\n                      <div className=\"text-gray-500 mb-1\">\n                        {new Date(log.timestamp).toLocaleTimeString()}\n                      </div>\n                      <div className=\"font-medium mb-1\">{log.message}</div>\n                      {log.data && (\n                        <div className=\"text-gray-600 font-mono\">\n                          {typeof log.data === 'object' ? JSON.stringify(log.data, null, 1) : log.data}\n                        </div>\n                      )}\n                    </div>\n                  ))\n                )}\n              </div>\n              {debugLogs.length > 0 && (\n                <Button\n                  onClick={clearDebugLogs}\n                  size=\"sm\"\n                  variant=\"outline\"\n                  className=\"mt-3 w-full\"\n                >\n                  Clear Debug Logs\n                </Button>\n              )}\n            </CardContent>\n          </Card>\n        </div>\n\n        {/* Status Information */}\n        <Card>\n          <CardHeader>\n            <CardTitle>Current Settings</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"space-y-2\">\n              <div className=\"flex justify-between\">\n                <span>Environment:</span>\n                <span className=\"font-medium\">Development</span>\n              </div>\n              <div className=\"flex justify-between\">\n                <span>Access Level:</span>\n                <span className=\"font-medium text-blue-600\">Corporate Manager</span>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n};\n\nexport default DevTools;","path":null,"size_bytes":41332,"size_tokens":null},"client/src/components/ui/command.tsx":{"content":"import * as React from \"react\"\nimport { type DialogProps } from \"@radix-ui/react-dialog\"\nimport { Command as CommandPrimitive } from \"cmdk\"\nimport { Search } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Dialog, DialogContent } from \"@/components/ui/dialog\"\n\nconst Command = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nCommand.displayName = CommandPrimitive.displayName\n\nconst CommandDialog = ({ children, ...props }: DialogProps) => {\n  return (\n    <Dialog {...props}>\n      <DialogContent className=\"overflow-hidden p-0 shadow-lg\">\n        <Command className=\"[&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground [&_[cmdk-group]:not([hidden])_~[cmdk-group]]:pt-0 [&_[cmdk-group]]:px-2 [&_[cmdk-input-wrapper]_svg]:h-5 [&_[cmdk-input-wrapper]_svg]:w-5 [&_[cmdk-input]]:h-12 [&_[cmdk-item]]:px-2 [&_[cmdk-item]]:py-3 [&_[cmdk-item]_svg]:h-5 [&_[cmdk-item]_svg]:w-5\">\n          {children}\n        </Command>\n      </DialogContent>\n    </Dialog>\n  )\n}\n\nconst CommandInput = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Input>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Input>\n>(({ className, ...props }, ref) => (\n  <div className=\"flex items-center border-b px-3\" cmdk-input-wrapper=\"\">\n    <Search className=\"mr-2 h-4 w-4 shrink-0 opacity-50\" />\n    <CommandPrimitive.Input\n      ref={ref}\n      className={cn(\n        \"flex h-11 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    />\n  </div>\n))\n\nCommandInput.displayName = CommandPrimitive.Input.displayName\n\nconst CommandList = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.List\n    ref={ref}\n    className={cn(\"max-h-[300px] overflow-y-auto overflow-x-hidden\", className)}\n    {...props}\n  />\n))\n\nCommandList.displayName = CommandPrimitive.List.displayName\n\nconst CommandEmpty = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Empty>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Empty>\n>((props, ref) => (\n  <CommandPrimitive.Empty\n    ref={ref}\n    className=\"py-6 text-center text-sm\"\n    {...props}\n  />\n))\n\nCommandEmpty.displayName = CommandPrimitive.Empty.displayName\n\nconst CommandGroup = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Group>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Group>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Group\n    ref={ref}\n    className={cn(\n      \"overflow-hidden p-1 text-foreground [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\n\nCommandGroup.displayName = CommandPrimitive.Group.displayName\n\nconst CommandSeparator = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nCommandSeparator.displayName = CommandPrimitive.Separator.displayName\n\nconst CommandItem = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Item>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default gap-2 select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[disabled=true]:pointer-events-none data-[selected='true']:bg-accent data-[selected=true]:text-accent-foreground data-[disabled=true]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      className\n    )}\n    {...props}\n  />\n))\n\nCommandItem.displayName = CommandPrimitive.Item.displayName\n\nconst CommandShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nCommandShortcut.displayName = \"CommandShortcut\"\n\nexport {\n  Command,\n  CommandDialog,\n  CommandInput,\n  CommandList,\n  CommandEmpty,\n  CommandGroup,\n  CommandItem,\n  CommandShortcut,\n  CommandSeparator,\n}\n","path":null,"size_bytes":4885,"size_tokens":null},"client/src/components/ui/slider.tsx":{"content":"import * as React from \"react\"\nimport * as SliderPrimitive from \"@radix-ui/react-slider\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Slider = React.forwardRef<\n  React.ElementRef<typeof SliderPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof SliderPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <SliderPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative flex w-full touch-none select-none items-center\",\n      className\n    )}\n    {...props}\n  >\n    <SliderPrimitive.Track className=\"relative h-2 w-full grow overflow-hidden rounded-full bg-secondary\">\n      <SliderPrimitive.Range className=\"absolute h-full bg-primary\" />\n    </SliderPrimitive.Track>\n    <SliderPrimitive.Thumb className=\"block h-5 w-5 rounded-full border-2 border-primary bg-background ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50\" />\n  </SliderPrimitive.Root>\n))\nSlider.displayName = SliderPrimitive.Root.displayName\n\nexport { Slider }\n","path":null,"size_bytes":1077,"size_tokens":null},"client/src/utils/microgreenAutomation.ts":{"content":"import { GrowingSystem } from '../data/systemsData';\nimport { findAvailableSpots, assignToSystem } from './systemAvailability';\n\nexport interface MicrogreenFlow {\n  trayId: string;\n  currentStage: 'nursery' | 'blackout' | 'racks' | 'harvested';\n  plantedDate: Date;\n  movedToBlackout?: Date;\n  movedToRacks?: Date;\n  expectedHarvest: Date;\n}\n\nexport const MICROGREEN_TIMINGS = {\n  nurseryDuration: 0, // Same day\n  blackoutDuration: 2, // 2 days\n  racksDuration: 5, // 5 days on racks\n  totalGrowthTime: 7 // Total days\n};\n\nexport const checkMicrogreenMovements = (\n  flows: MicrogreenFlow[],\n  systems: GrowingSystem[]\n): Array<{ trayId: string; action: string; fromSystem: string; toSystem: string }> => {\n  const movements = [];\n  const now = new Date();\n  \n  for (const flow of flows) {\n    const daysSincePlanted = Math.floor(\n      (now.getTime() - flow.plantedDate.getTime()) / (1000 * 60 * 60 * 24)\n    );\n    \n    if (flow.currentStage === 'nursery' && daysSincePlanted >= 0) {\n      // Move to blackout immediately\n      movements.push({\n        trayId: flow.trayId,\n        action: 'move',\n        fromSystem: 'nursery',\n        toSystem: 'blackout'\n      });\n    } else if (flow.currentStage === 'blackout' && daysSincePlanted >= 2) {\n      // Move to racks after 2 days\n      movements.push({\n        trayId: flow.trayId,\n        action: 'move',\n        fromSystem: 'blackout',\n        toSystem: 'racks'\n      });\n    }\n  }\n  \n  return movements;\n};\n\nexport const executeMicrogreenMovement = (\n  movement: { trayId: string; fromSystem: string; toSystem: string },\n  systems: GrowingSystem[]\n): { success: boolean; updatedSystems?: GrowingSystem[]; error?: string } => {\n  try {\n    const fromSystem = systems.find(s => s.type === movement.fromSystem);\n    const toSystemType = movement.toSystem;\n    \n    if (!fromSystem) {\n      return { success: false, error: 'Source system not found' };\n    }\n    \n    // Find the tray in source system\n    const traySpot = fromSystem.spots.find(s => s.trayId === movement.trayId);\n    if (!traySpot) {\n      return { success: false, error: 'Tray not found in source system' };\n    }\n    \n    // Find available spot in destination\n    const availableSpots = findAvailableSpots(\n      systems,\n      toSystemType,\n      1,\n      traySpot.plantType\n    );\n    \n    if (availableSpots.length === 0) {\n      return { \n        success: false, \n        error: `No available spots in ${toSystemType}` \n      };\n    }\n    \n    // Execute movement\n    const updatedSystems = systems.map(system => {\n      if (system.id === fromSystem.id) {\n        // Remove from source\n        return {\n          ...system,\n          spots: system.spots.map(spot => \n            spot.id === traySpot.id \n              ? { ...spot, occupied: false, trayId: undefined, plantType: undefined }\n              : spot\n          ),\n          currentOccupancy: system.currentOccupancy - 1\n        };\n      } else if (system.id === availableSpots[0].systemId) {\n        // Add to destination\n        return assignToSystem(\n          system,\n          [availableSpots[0].spotIds[0]],\n          movement.trayId,\n          traySpot.plantType || ''\n        );\n      }\n      return system;\n    });\n    \n    return { success: true, updatedSystems };\n  } catch (error) {\n    return { success: false, error: String(error) };\n  }\n};","path":null,"size_bytes":3338,"size_tokens":null},"client/src/components/ui/button.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst buttonVariants = cva(\n  \"inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-primary text-primary-foreground hover:bg-primary/90\",\n        destructive:\n          \"bg-destructive text-destructive-foreground hover:bg-destructive/90\",\n        outline:\n          \"border border-input bg-background hover:bg-accent hover:text-accent-foreground\",\n        secondary:\n          \"bg-secondary text-secondary-foreground hover:bg-secondary/80\",\n        ghost: \"hover:bg-accent hover:text-accent-foreground\",\n        link: \"text-primary underline-offset-4 hover:underline\",\n      },\n      size: {\n        default: \"h-10 px-4 py-2\",\n        sm: \"h-9 rounded-md px-3\",\n        lg: \"h-11 rounded-md px-8\",\n        icon: \"h-10 w-10\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nexport interface ButtonProps\n  extends React.ButtonHTMLAttributes<HTMLButtonElement>,\n    VariantProps<typeof buttonVariants> {\n  asChild?: boolean\n}\n\nconst Button = React.forwardRef<HTMLButtonElement, ButtonProps>(\n  ({ className, variant, size, asChild = false, ...props }, ref) => {\n    const Comp = asChild ? Slot : \"button\"\n    return (\n      <Comp\n        className={cn(buttonVariants({ variant, size, className }))}\n        ref={ref}\n        {...props}\n      />\n    )\n  }\n)\nButton.displayName = \"Button\"\n\nexport { Button, buttonVariants }\n","path":null,"size_bytes":1901,"size_tokens":null},"client/src/components/ui/toggle.tsx":{"content":"import * as React from \"react\"\nimport * as TogglePrimitive from \"@radix-ui/react-toggle\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst toggleVariants = cva(\n  \"inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors hover:bg-muted hover:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=on]:bg-accent data-[state=on]:text-accent-foreground [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 gap-2\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-transparent\",\n        outline:\n          \"border border-input bg-transparent hover:bg-accent hover:text-accent-foreground\",\n      },\n      size: {\n        default: \"h-10 px-3 min-w-10\",\n        sm: \"h-9 px-2.5 min-w-9\",\n        lg: \"h-11 px-5 min-w-11\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nconst Toggle = React.forwardRef<\n  React.ElementRef<typeof TogglePrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof TogglePrimitive.Root> &\n    VariantProps<typeof toggleVariants>\n>(({ className, variant, size, ...props }, ref) => (\n  <TogglePrimitive.Root\n    ref={ref}\n    className={cn(toggleVariants({ variant, size, className }))}\n    {...props}\n  />\n))\n\nToggle.displayName = TogglePrimitive.Root.displayName\n\nexport { Toggle, toggleVariants }\n","path":null,"size_bytes":1527,"size_tokens":null},"client/src/components/ui/pagination.tsx":{"content":"import * as React from \"react\"\nimport { ChevronLeft, ChevronRight, MoreHorizontal } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { ButtonProps, buttonVariants } from \"@/components/ui/button\"\n\nconst Pagination = ({ className, ...props }: React.ComponentProps<\"nav\">) => (\n  <nav\n    role=\"navigation\"\n    aria-label=\"pagination\"\n    className={cn(\"mx-auto flex w-full justify-center\", className)}\n    {...props}\n  />\n)\nPagination.displayName = \"Pagination\"\n\nconst PaginationContent = React.forwardRef<\n  HTMLUListElement,\n  React.ComponentProps<\"ul\">\n>(({ className, ...props }, ref) => (\n  <ul\n    ref={ref}\n    className={cn(\"flex flex-row items-center gap-1\", className)}\n    {...props}\n  />\n))\nPaginationContent.displayName = \"PaginationContent\"\n\nconst PaginationItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentProps<\"li\">\n>(({ className, ...props }, ref) => (\n  <li ref={ref} className={cn(\"\", className)} {...props} />\n))\nPaginationItem.displayName = \"PaginationItem\"\n\ntype PaginationLinkProps = {\n  isActive?: boolean\n} & Pick<ButtonProps, \"size\"> &\n  React.ComponentProps<\"a\">\n\nconst PaginationLink = ({\n  className,\n  isActive,\n  size = \"icon\",\n  ...props\n}: PaginationLinkProps) => (\n  <a\n    aria-current={isActive ? \"page\" : undefined}\n    className={cn(\n      buttonVariants({\n        variant: isActive ? \"outline\" : \"ghost\",\n        size,\n      }),\n      className\n    )}\n    {...props}\n  />\n)\nPaginationLink.displayName = \"PaginationLink\"\n\nconst PaginationPrevious = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof PaginationLink>) => (\n  <PaginationLink\n    aria-label=\"Go to previous page\"\n    size=\"default\"\n    className={cn(\"gap-1 pl-2.5\", className)}\n    {...props}\n  >\n    <ChevronLeft className=\"h-4 w-4\" />\n    <span>Previous</span>\n  </PaginationLink>\n)\nPaginationPrevious.displayName = \"PaginationPrevious\"\n\nconst PaginationNext = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof PaginationLink>) => (\n  <PaginationLink\n    aria-label=\"Go to next page\"\n    size=\"default\"\n    className={cn(\"gap-1 pr-2.5\", className)}\n    {...props}\n  >\n    <span>Next</span>\n    <ChevronRight className=\"h-4 w-4\" />\n  </PaginationLink>\n)\nPaginationNext.displayName = \"PaginationNext\"\n\nconst PaginationEllipsis = ({\n  className,\n  ...props\n}: React.ComponentProps<\"span\">) => (\n  <span\n    aria-hidden\n    className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n    {...props}\n  >\n    <MoreHorizontal className=\"h-4 w-4\" />\n    <span className=\"sr-only\">More pages</span>\n  </span>\n)\nPaginationEllipsis.displayName = \"PaginationEllipsis\"\n\nexport {\n  Pagination,\n  PaginationContent,\n  PaginationEllipsis,\n  PaginationItem,\n  PaginationLink,\n  PaginationNext,\n  PaginationPrevious,\n}\n","path":null,"size_bytes":2751,"size_tokens":null},"client/src/pages/Education.tsx":{"content":"import React, { useState, useEffect } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Clock, BookOpen, Award, CheckCircle, Play, Filter, Plus, Target } from \"lucide-react\";\nimport { TrainingModule, UserProgress, CourseAssignment, User } from \"@shared/schema\";\nimport { getStoredAuth } from \"@/lib/auth\";\nimport CourseCard from \"@/components/CourseCard\";\nimport CourseModal from \"@/components/CourseModal\";\nimport CourseCreationModal from \"@/components/CourseCreationModal\";\nimport CourseAssignmentModal from \"@/components/CourseAssignmentModal\";\nimport { courseService, Course } from \"@/services/courseService\";\nimport confetti from \"canvas-confetti\";\n\n// Course interface moved to courseService\n\nconst Education: React.FC = () => {\n  const auth = getStoredAuth();\n  const [filterTab, setFilterTab] = useState<string>('assigned');\n  const [selectedCourse, setSelectedCourse] = useState<Course | null>(null);\n  const [showCourseModal, setShowCourseModal] = useState(false);\n  const [showCreateModal, setShowCreateModal] = useState(false);\n  const [showAssignmentModal, setShowAssignmentModal] = useState(false);\n  const [courseToAssign, setCourseToAssign] = useState<Course | null>(null);  \n  const [editingCourse, setEditingCourse] = useState<Course | null>(null);\n  const isCorporateManager = auth.user?.role === 'corporate';\n  const isManager = auth.user?.role === 'manager' || auth.user?.role === 'corporate';\n  \n  // Debug logging for create course button visibility\n  console.log('üéì Education Page Debug:', {\n    userRole: auth.user?.role,\n    isCorporateManager,\n    isManager,\n    userName: auth.user?.name\n  });\n  const currentUser = auth.user as User;\n  // Query for course assignments\n  const { data: courseAssignments = [] } = useQuery<CourseAssignment[]>({\n    queryKey: ['/api/course-assignments', { userId: currentUser?.id }],\n    queryFn: () => fetch(`/api/course-assignments?userId=${currentUser?.id}`).then(res => res.json()),\n    enabled: !!currentUser\n  });\n\n  // Query for all users (for assignment modal)\n  const { data: allUsers = [] } = useQuery<User[]>({\n    queryKey: ['/api/users']\n  });\n\n  // Load courses from central service instead of local state\n  const [courses, setCourses] = useState<Course[]>([]);\n  const [coursesLoaded, setCoursesLoaded] = useState(false);\n  \n  // Load courses on component mount (one-time load)\n  useEffect(() => {\n    if (currentUser && !coursesLoaded) {\n      const userCourses = courseService.getUserCourses(currentUser.id);\n      setCourses(userCourses);\n      setCoursesLoaded(true);\n    }\n  }, [currentUser, coursesLoaded]);\n\n  // Calculate completed courses from assignments (for progress bar)\n  const assignedCompletedCourses = courseAssignments.filter(assignment => {\n    const course = courses.find(c => c.id === assignment.courseId);\n    return course?.status === 'completed';\n  }).length;\n\n  const completedCourses = courses.filter(c => c.status === 'completed').length;\n  const totalCourses = courses.length;\n  const overallProgress = totalCourses > 0 ? (completedCourses / totalCourses) * 100 : 0;\n\n  // Handle course assignment\n  const handleAssignCourse = (course: Course) => {\n    setCourseToAssign(course);\n    setShowAssignmentModal(true);\n  };\n\n  const handleCloseAssignmentModal = () => {\n    setShowAssignmentModal(false);\n    setCourseToAssign(null);\n  };\n\n  // Get assigned courses with assignment details\n  const getAssignedCourses = () => {\n    if (!currentUser) return [];\n    \n    return courseAssignments.map(assignment => {\n      const course = courses.find(c => c.id === assignment.courseId);\n      if (!course) return null;\n      \n      const assignedByUser = allUsers.find(u => u.id === assignment.assignedByUserId);\n      \n      return {\n        ...course,\n        assignedBy: assignedByUser?.name || 'Unknown',\n        assignedDate: assignment.assignedDate ? new Date(assignment.assignedDate).toISOString() : undefined,\n        dueDate: assignment.dueDate ? new Date(assignment.dueDate).toISOString() : undefined,\n        priority: assignment.priority as 'low' | 'normal' | 'high' | undefined\n      };\n    }).filter(Boolean) as Course[];\n  };\n\n  const filteredCourses = (() => {\n    switch (filterTab) {\n      case 'assigned':\n        return getAssignedCourses();\n      case 'in-progress':\n        return courses.filter(course => course.status === 'in-progress');\n      case 'completed':\n        return courses.filter(course => course.status === 'completed');\n      case 'not-started':\n        return courses.filter(course => course.status === 'not-started');\n      case 'all':\n      default:\n        return courses;\n    }\n  })();\n\n  const handleStartCourse = (course: Course) => {\n    setSelectedCourse(course);\n    setShowCourseModal(true);\n  };\n\n  const handleResumeCourse = (course: Course) => {\n    setSelectedCourse(course);\n    setShowCourseModal(true);\n  };\n\n  const handleCourseComplete = async (courseId: number) => {\n    const completedCourse = courses.find(c => c.id === courseId);\n    if (!completedCourse || !currentUser) return;\n    \n    try {\n      // Complete course via central service with role assignment\n      const response = await courseService.completeCourse(\n        currentUser.id, \n        courseId, \n        completedCourse.roleAwarded\n      );\n      \n      // Update local course state\n      setCourses(prevCourses =>\n        prevCourses.map(course =>\n          course.id === courseId\n            ? {\n                ...course,\n                status: 'completed' as const,\n                progress: course.sections,\n                completedDate: new Date().toISOString()\n              }\n            : course\n        )\n      );\n      \n      // Trigger confetti animation\n      confetti({\n        particleCount: 100,\n        spread: 70,\n        origin: { y: 0.6 }\n      });\n      \n      // Show success message with role assignment confirmation\n      setTimeout(() => {\n        alert(`üéâ Congratulations! You've completed \"${completedCourse.title}\" and earned the ${completedCourse.roleAwarded} role!`);\n      }, 500);\n      \n      // Refresh user authentication to show updated role\n      setTimeout(() => {\n        window.location.reload();\n      }, 2000);\n      \n    } catch (error) {\n      console.error('Failed to complete course:', error);\n      alert('Course completed locally, but there was an issue assigning the role. Please contact your manager.');\n    }\n  };\n\n  const handleCloseModal = () => {\n    setShowCourseModal(false);\n    setSelectedCourse(null);\n  };\n\n  const handleCreateCourse = (newCourse: Omit<Course, 'id' | 'status' | 'progress'>) => {\n    const savedCourse = courseService.saveCourse(newCourse);\n    setCourses(prevCourses => [...prevCourses, savedCourse]);\n    setShowCreateModal(false);\n  };\n\n  const handleEditCourse = (course: Course) => {\n    setEditingCourse(course);\n    setShowCreateModal(true);\n  };\n\n  const handleUpdateCourse = (updatedCourse: Omit<Course, 'id' | 'status' | 'progress'>) => {\n    if (editingCourse) {\n      const savedCourse = courseService.saveCourse({\n        ...updatedCourse,\n        id: editingCourse.id\n      });\n      \n      setCourses(prevCourses => \n        prevCourses.map(course => \n          course.id === editingCourse.id ? savedCourse : course\n        )\n      );\n      setEditingCourse(null);\n      setShowCreateModal(false);\n    }\n  };\n\n  const handleDeleteCourse = (courseId: number) => {\n    const courseToDelete = courses.find(c => c.id === courseId);\n    if (!courseToDelete) return;\n    \n    // Check if any other courses have this as a prerequisite\n    const dependentCourses = courses.filter(course => \n      course.prerequisites?.courses?.includes(courseId)\n    );\n    \n    if (dependentCourses.length > 0) {\n      const dependentTitles = dependentCourses.map(c => `‚Ä¢ ${c.title}`).join('\\n');\n      alert(`Cannot delete this course. The following courses require it as a prerequisite:\\n\\n${dependentTitles}\\n\\nRemove this prerequisite from these courses first.`);\n      return;\n    }\n    \n    // Final confirmation\n    if (confirm(`Delete \"${courseToDelete.title}\"?\\n\\nThis action cannot be undone.`)) {\n      const deleted = courseService.deleteCourse(courseId);\n      \n      if (deleted) {\n        setCourses(prevCourses => prevCourses.filter(course => course.id !== courseId));\n        \n        console.log(`Course deleted:`, {\n          courseId,\n          title: courseToDelete.title,\n          deletedBy: currentUser.name,\n          deletedAt: new Date().toISOString()\n        });\n        \n        // If in edit modal, close it\n        if (showCreateModal && editingCourse?.id === courseId) {\n          setShowCreateModal(false);\n          setEditingCourse(null);\n        }\n      }\n    }\n  };\n\n  const handleCloseCreateModal = () => {\n    setShowCreateModal(false);\n    setEditingCourse(null);\n  };\n\n  const checkPrerequisites = (course: Course) => {\n    if (!course.prerequisites) {\n      return true;\n    }\n    \n    // Check course prerequisites\n    const coursePrereqsMet = course.prerequisites.courses.every(prereqId => {\n      const prereqCourse = courses.find(c => c.id === prereqId);\n      return prereqCourse?.status === 'completed';\n    });\n    \n    // Check additional requirements (mock implementation for demo)\n    const requirementsMet = course.prerequisites.requirements.every(req => {\n      switch (req.type) {\n        case 'age':\n          // Mock: assume user meets age requirement\n          return true;\n        case 'tenure':\n          // Mock: assume user has sufficient tenure\n          return true;\n        case 'license':\n        case 'certification':\n          // Mock: simulate some users having certifications\n          return Math.random() > 0.3;\n        default:\n          return true;\n      }\n    });\n    \n    return coursePrereqsMet && requirementsMet;\n  };\n\n  const getAvailableCourses = () => {\n    return courses.filter(course => {\n      const prerequisitesMet = checkPrerequisites(course);\n      return prerequisitesMet;\n    });\n  };\n\n  const getLockedCourses = () => {\n    return courses.filter(course => !checkPrerequisites(course));\n  };\n\n  return (\n    <div className=\"education-page\">\n      {/* Action button in top right */}\n      {isCorporateManager && (\n        <div className=\"page-actions\">\n          <button \n            className=\"btn-create-course\"\n            onClick={() => setShowCreateModal(true)}\n          >\n            + Create Course\n          </button>\n        </div>\n      )}\n      \n      {/* Progress Summary Card */}\n      <div className=\"learning-progress-card\">\n        <div className=\"progress-icon\">üéì</div>\n        <div className=\"progress-content\">\n          <h3>Your Learning Progress</h3>\n          <div className=\"progress-stats\">\n            <span className=\"assigned\">{courseAssignments.length} Courses Assigned</span>\n            <span className=\"separator\">‚Ä¢</span>\n            <span className=\"completed\">{assignedCompletedCourses} Completed</span>\n            <span className=\"separator\">‚Ä¢</span>\n            <span className=\"role\">üë§ {auth.user?.role === 'manager' ? 'Manager' : 'Technician'} Role</span>\n          </div>\n          <div className=\"progress-bar\">\n            <div \n              className=\"progress-fill\" \n              style={{ width: `${courseAssignments.length > 0 ? (assignedCompletedCourses / courseAssignments.length) * 100 : 0}%` }} \n            />\n          </div>\n          <span className=\"progress-text\">\n            {courseAssignments.length > 0 ? Math.round((assignedCompletedCourses / courseAssignments.length) * 100) : 0}% Complete\n          </span>\n        </div>\n      </div>\n      \n      {/* Filter tabs matching sub-tab style */}\n      <div className=\"course-filter-tabs\">\n        <button\n          className={`filter-tab ${filterTab === 'assigned' ? 'active' : ''}`}\n          onClick={() => setFilterTab('assigned')}\n        >\n          üéØ Assigned\n        </button>\n        <button\n          className={`filter-tab ${filterTab === 'all' ? 'active' : ''}`}\n          onClick={() => setFilterTab('all')}\n        >\n          üìö All Courses\n        </button>\n        <button\n          className={`filter-tab ${filterTab === 'in-progress' ? 'active' : ''}`}\n          onClick={() => setFilterTab('in-progress')}\n        >\n          üîÑ In Progress\n        </button>\n        <button\n          className={`filter-tab ${filterTab === 'completed' ? 'active' : ''}`}\n          onClick={() => setFilterTab('completed')}\n        >\n          ‚úÖ Completed\n        </button>\n        <button\n          className={`filter-tab ${filterTab === 'not-started' ? 'active' : ''}`}\n          onClick={() => setFilterTab('not-started')}\n        >\n          üìã Not Started\n        </button>\n      </div>\n\n      {/* Course Grid */}\n      <div className=\"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 courses-grid\">\n        {filteredCourses.map((course) => (\n          <CourseCard\n            key={course.id}\n            course={course}\n            onStart={handleStartCourse}\n            onResume={handleResumeCourse}\n            onEdit={handleEditCourse}\n            onDelete={isCorporateManager ? handleDeleteCourse : undefined}\n            onAssign={isManager ? handleAssignCourse : undefined}\n            allCourses={courses}\n            isLocked={!checkPrerequisites(course)}\n            isCorporateManager={isCorporateManager}\n          />\n        ))}\n      </div>\n\n      {filteredCourses.length === 0 && (\n        <div className=\"text-center py-12\">\n          <div className=\"text-4xl mb-4\">üéì</div>\n          <h3 className=\"text-lg font-medium text-gray-900 mb-2\">\n            No courses found for \"{filterTab}\" filter\n          </h3>\n          <p className=\"text-gray-600\">\n            Try selecting a different filter or check back later for new courses.\n          </p>\n        </div>\n      )}\n\n      {/* Course Modal */}\n      {selectedCourse && (\n        <CourseModal\n          course={selectedCourse}\n          isOpen={showCourseModal}\n          onClose={handleCloseModal}\n          onComplete={handleCourseComplete}\n        />\n      )}\n\n      {/* Course Creation Modal */}\n      <CourseCreationModal\n        isOpen={showCreateModal}\n        onClose={handleCloseCreateModal}\n        onSave={editingCourse ? handleUpdateCourse : handleCreateCourse}\n        onDelete={isCorporateManager ? handleDeleteCourse : undefined}\n        allCourses={courses}\n        editingCourse={editingCourse}\n      />\n\n      {/* Course Assignment Modal */}\n      {isManager && (\n        <CourseAssignmentModal\n          isOpen={showAssignmentModal}\n          onClose={handleCloseAssignmentModal}\n          course={courseToAssign}\n          assignedBy={currentUser}\n        />\n      )}\n    </div>\n  );\n};\n\nexport default Education;\n","path":null,"size_bytes":15102,"size_tokens":null},"client/src/pages/RecurringTasks.tsx":{"content":"import React, { useState, useMemo } from 'react';\nimport { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';\nimport { Button } from '@/components/ui/button';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Badge } from '@/components/ui/badge';\nimport { Switch } from '@/components/ui/switch';\nimport { Input } from '@/components/ui/input';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { Plus, Edit, Trash2, Settings, Calendar, Clock, RotateCcw, Building2, CheckSquare, Search, X } from 'lucide-react';\nimport { getStoredAuth } from '@/lib/auth';\nimport { useToast } from '@/hooks/use-toast';\nimport { apiRequest } from '@/lib/queryClient';\nimport { RecurringTask } from '@shared/schema';\nimport RecurringTaskModal from '@/components/RecurringTaskModal';\nimport DeleteRecurringTaskModal from '@/components/DeleteRecurringTaskModal';\nimport { useLocation } from '@/contexts/LocationContext';\nimport { migrateSharePointTasks, importRecurringTasks } from '@/utils/sharePointMigration';\n\nconst RecurringTasks: React.FC = () => {\n  const auth = getStoredAuth();\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n  const { currentLocation, isViewingAllLocations } = useLocation();\n  const [showAddModal, setShowAddModal] = useState(false);\n  const [editingTask, setEditingTask] = useState<RecurringTask | null>(null);\n  const [showDeleteModal, setShowDeleteModal] = useState(false);\n  const [deletingTask, setDeletingTask] = useState<RecurringTask | null>(null);\n  const [modalKey, setModalKey] = useState(0); // Used to force modal remount\n\n  \n  // Filter states\n  const [searchTerm, setSearchTerm] = useState('');\n  const [typeFilter, setTypeFilter] = useState('all');\n  const [frequencyFilter, setFrequencyFilter] = useState('all');\n  const [dayFilter, setDayFilter] = useState('all');\n\n  const { data: recurringTasks = [], isLoading, refetch } = useQuery<RecurringTask[]>({\n    queryKey: ['/api/recurring-tasks', currentLocation.id, isViewingAllLocations],\n    queryFn: async () => {\n      console.log('üîç currentLocation object:', currentLocation);\n      console.log('üîç Fetching recurring tasks for location:', currentLocation.name, 'viewing all:', isViewingAllLocations);\n      const url = isViewingAllLocations \n        ? '/api/recurring-tasks' \n        : `/api/recurring-tasks?location=${encodeURIComponent(currentLocation.id)}`;\n      \n      console.log('üîç Making API call to:', url);\n      const response = await fetch(url, { cache: 'no-cache' });\n      if (!response.ok) throw new Error('Failed to fetch recurring tasks');\n      const data = await response.json();\n      console.log(`üîç Fetched ${data.length} recurring tasks from API for location: ${currentLocation.name}`);\n      console.log('üîç First few tasks:');\n      if (data.length > 0) {\n        data.slice(0, 3).forEach((task: any, index: number) => {\n          console.log(`  ${index + 1}. ${task.title} (location: ${task.location})`);\n        });\n      }\n      return data;\n    },\n    enabled: !!auth.user,\n    staleTime: 0,\n    gcTime: 0\n  });\n\n  // Filter recurring tasks based on search term, type, and frequency\n  const filteredRecurringTasks = useMemo(() => {\n    let filtered = [...recurringTasks];\n    \n    // Search filter - searches across title and description\n    if (searchTerm) {\n      const search = searchTerm.toLowerCase();\n      filtered = filtered.filter(task => \n        task.title.toLowerCase().includes(search) ||\n        (task.description && task.description.toLowerCase().includes(search))\n      );\n    }\n    \n    // Type filter\n    if (typeFilter !== 'all') {\n      filtered = filtered.filter(task => \n        task.type && task.type.toLowerCase() === typeFilter.toLowerCase()\n      );\n    }\n    \n    // Frequency filter\n    if (frequencyFilter !== 'all') {\n      filtered = filtered.filter(task => {\n        const taskFreq = task.frequency.toLowerCase();\n        \n        if (frequencyFilter === 'weekly') {\n          // Weekly means it happens on specific days of the week\n          return taskFreq.includes('monday') || \n                 taskFreq.includes('tuesday') || \n                 taskFreq.includes('wednesday') || \n                 taskFreq.includes('thursday') || \n                 taskFreq.includes('friday') || \n                 taskFreq.includes('saturday') || \n                 taskFreq.includes('sunday');\n        }\n        \n        if (frequencyFilter === 'bi-weekly') {\n          return taskFreq.includes('bi-weekly') || taskFreq.includes('biweekly');\n        }\n        \n        if (frequencyFilter === 'monthly') {\n          return taskFreq.includes('monthly');\n        }\n        \n        return false;\n      });\n    }\n    \n    // Day filter\n    if (dayFilter !== 'all') {\n      filtered = filtered.filter(task => {\n        const selectedDay = dayFilter.toLowerCase();\n        \n        console.log(`üóìÔ∏è Checking task \"${task.title}\" for day \"${selectedDay}\"`);\n        console.log(`   - Frequency: \"${task.frequency}\"`);\n        console.log(`   - DaysOfWeek: ${task.daysOfWeek ? JSON.stringify(task.daysOfWeek) : 'undefined'}`);\n        \n        // First check if task has daysOfWeek array (most accurate)\n        if (task.daysOfWeek && Array.isArray(task.daysOfWeek)) {\n          const matchesDay = task.daysOfWeek.some(day => \n            day.toLowerCase() === selectedDay || \n            day.toLowerCase().startsWith(selectedDay.substring(0, 3)) // mon, tue, etc.\n          );\n          if (matchesDay) {\n            console.log(`‚úÖ Day match in daysOfWeek for ${task.title}`);\n            return true;\n          }\n        }\n        \n        // Fallback: check frequency string for day names (for older data)\n        if (task.frequency) {\n          const taskFreq = task.frequency.toLowerCase();\n          \n          // Check for exact day match in frequency string\n          if (taskFreq.includes(selectedDay)) {\n            console.log(`‚úÖ Day match in frequency for ${task.title}`);\n            return true;\n          }\n          \n          // Check for day abbreviations\n          const dayAbbreviations = {\n            'monday': ['mon'],\n            'tuesday': ['tue', 'tues'],\n            'wednesday': ['wed'],\n            'thursday': ['thu', 'thur', 'thurs'],\n            'friday': ['fri'],\n            'saturday': ['sat'],\n            'sunday': ['sun']\n          };\n          \n          if (dayAbbreviations[selectedDay]) {\n            const hasAbbrev = dayAbbreviations[selectedDay].some(abbr => taskFreq.includes(abbr));\n            if (hasAbbrev) {\n              console.log(`‚úÖ Day abbreviation match in frequency for ${task.title}`);\n              return true;\n            }\n          }\n        }\n        \n        console.log(`‚ùå No day match for ${task.title}`);\n        return false;\n      });\n    }\n    \n    return filtered;\n  }, [recurringTasks, searchTerm, typeFilter, frequencyFilter, dayFilter]);\n\n  // Clear all filters function\n  const clearFilters = () => {\n    setSearchTerm('');\n    setTypeFilter('all');\n    setFrequencyFilter('all');\n    setDayFilter('all');\n  };\n  \n  // Debug logging\n  React.useEffect(() => {\n    console.log('üîç DEBUG: filteredRecurringTasks updated:', filteredRecurringTasks.length, 'tasks');\n    if (filteredRecurringTasks.length > 0) {\n      console.log('First 3 tasks:', filteredRecurringTasks.slice(0, 3).map(t => ({ id: t.id, title: t.title, location: t.location })));\n    }\n  }, [filteredRecurringTasks]);\n\n  // Debug day filter\n  React.useEffect(() => {\n    if (dayFilter !== 'all' && recurringTasks.length > 0) {\n      console.log('üóìÔ∏è Day filter active:', dayFilter);\n      const uniqueFreqs = new Set(recurringTasks.map(t => t.frequency));\n      const sampleFrequencies = Array.from(uniqueFreqs).slice(0, 5);\n      console.log('üóìÔ∏è Sample frequencies:', sampleFrequencies);\n      \n      // Show filtering summary\n      const totalTasks = recurringTasks.length;\n      const filteredCount = filteredRecurringTasks.length;\n      console.log(`üìä Day filter summary: ${filteredCount}/${totalTasks} tasks shown for ${dayFilter}`);\n    }\n  }, [dayFilter, recurringTasks, filteredRecurringTasks]);\n\n\n\n  // Force refetch when location changes\n  React.useEffect(() => {\n    console.log('üîç Location changed, forcing refetch...');\n    refetch();\n  }, [currentLocation.id, isViewingAllLocations, refetch]);\n\n  const toggleTaskMutation = useMutation({\n    mutationFn: async ({ id, isActive }: { id: number; isActive: boolean }) => {\n      return await apiRequest('PATCH', `/api/recurring-tasks/${id}`, { isActive });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/recurring-tasks'] });\n      toast({\n        title: 'Task Updated',\n        description: 'Recurring task has been updated successfully.',\n      });\n    },\n  });\n\n  const deleteTaskMutation = useMutation({\n    mutationFn: async (id: number) => {\n      return await apiRequest('DELETE', `/api/recurring-tasks/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/recurring-tasks'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/tasks'] }); // Also refresh tasks\n      setShowDeleteModal(false);\n      setDeletingTask(null);\n      toast({\n        title: 'Task Deleted',\n        description: 'Recurring task deleted. Future tasks removed, historical data preserved.',\n      });\n    },\n  });\n\n  const saveTaskMutation = useMutation({\n    mutationFn: async (taskData: any) => {\n      console.log('Creating/updating recurring task with data:', taskData);\n      if (taskData.id) {\n        return await apiRequest('PATCH', `/api/recurring-tasks/${taskData.id}`, taskData);\n      } else {\n        return await apiRequest('POST', '/api/recurring-tasks', taskData);\n      }\n    },\n    onSuccess: (result) => {\n      console.log('Task save successful, result:', result);\n      // Invalidate and refetch both recurring tasks and regular tasks\n      queryClient.invalidateQueries({ queryKey: ['/api/recurring-tasks'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/tasks'] });\n      queryClient.refetchQueries({ queryKey: ['/api/recurring-tasks'] });\n      queryClient.refetchQueries({ queryKey: ['/api/tasks'] });\n      setShowAddModal(false);\n      setEditingTask(null);\n      toast({\n        title: editingTask ? 'Task Updated' : 'Task Created',\n        description: editingTask ? 'Recurring task and all future instances have been updated successfully.' : 'Recurring task has been created successfully.',\n      });\n    },\n    onError: (error) => {\n      console.error('Failed to save recurring task:', error);\n      toast({\n        title: 'Save Failed',\n        description: 'Failed to save recurring task. Please try again.',\n        variant: 'destructive'\n      });\n    }\n  });\n\n  const getFrequencyDisplay = (task: RecurringTask) => {\n    if (task.frequency === 'weekly') {\n      const days = task.daysOfWeek?.map(day => \n        typeof day === 'string' ? day.charAt(0).toUpperCase() + day.slice(1) : String(day)\n      ).join(', ');\n      return `Weekly on ${days}`;\n    }\n    if (task.frequency === 'bi-weekly') {\n      return 'Bi-Weekly (1st & 15th)';\n    }\n    if (task.frequency === 'monthly') {\n      return 'Monthly (Last Day)';\n    }\n    if (task.frequency === 'quarterly') {\n      return 'Quarterly';\n    }\n    return task.frequency;\n  };\n\n  const getTaskTypeEmoji = (type: string) => {\n    const emojis: { [key: string]: string } = {\n      'seeding-microgreens': 'üå±',\n      'seeding-leafy-greens': 'üåø',\n      'harvest-microgreens': 'üåæ',\n      'harvest-leafy-greens': 'ü•¨',\n      'blackout-tasks': 'üåë',\n      'moving': 'üì¶',\n      'packing': 'üì¶',\n      'cleaning': 'üßπ',\n      'inventory': 'üìä',\n      'equipment-maintenance': 'üîß',\n      'other': 'üìù'\n    };\n    return emojis[type] || 'üìã';\n  };\n\n  const handleDeleteClick = (task: RecurringTask) => {\n    setDeletingTask(task);\n    setShowDeleteModal(true);\n  };\n\n  const handleDeleteConfirm = () => {\n    if (deletingTask) {\n      deleteTaskMutation.mutate(deletingTask.id);\n    }\n  };\n\n\n\n  if (isLoading) return <div className=\"p-6\">Loading recurring tasks...</div>;\n\n  return (\n    <div className=\"p-6 max-w-7xl mx-auto\">\n      <div className=\"mb-6\">\n        <div className=\"flex justify-between items-center mb-4\">\n          <h1 className=\"text-2xl font-bold\">üìã Recurring Tasks</h1>\n          <Button \n            onClick={() => {\n              // Increment modalKey to force fresh state when opening modal for new task\n              setModalKey(prev => prev + 1);\n              setShowAddModal(true);\n            }}\n            className=\"bg-[#2D8028] hover:bg-[#203B17]\"\n          >\n            <Plus className=\"w-4 h-4 mr-2\" />\n            Add Recurring Task\n          </Button>\n        </div>\n\n        {/* Filters Section */}\n        <div className=\"flex flex-wrap gap-4 items-center bg-white p-4 rounded-lg border\">\n          {/* Search Bar */}\n          <div className=\"flex-1 min-w-[200px]\">\n            <div className=\"relative\">\n              <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4\" />\n              <Input\n                type=\"text\"\n                placeholder=\"üîç Search tasks...\"\n                value={searchTerm}\n                onChange={(e) => setSearchTerm(e.target.value)}\n                className=\"pl-10\"\n              />\n            </div>\n          </div>\n          \n          {/* Type Filter */}\n          <div className=\"min-w-[160px]\">\n            <Select value={typeFilter} onValueChange={setTypeFilter}>\n              <SelectTrigger>\n                <SelectValue placeholder=\"All Types\" />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"all\">All Types</SelectItem>\n                <SelectItem value=\"seeding-microgreens\">Seeding - Microgreens</SelectItem>\n                <SelectItem value=\"harvest-microgreens\">Harvest - Microgreens</SelectItem>\n                <SelectItem value=\"blackout-tasks\">Blackout Tasks</SelectItem>\n                <SelectItem value=\"cleaning\">Cleaning</SelectItem>\n                <SelectItem value=\"equipment-maintenance\">Equipment Maintenance</SelectItem>\n                <SelectItem value=\"inventory\">Inventory</SelectItem>\n                <SelectItem value=\"other\">Other</SelectItem>\n              </SelectContent>\n            </Select>\n          </div>\n          \n          {/* Frequency Filter */}\n          <div className=\"min-w-[160px]\">\n            <Select value={frequencyFilter} onValueChange={setFrequencyFilter}>\n              <SelectTrigger>\n                <SelectValue placeholder=\"All Frequencies\" />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"all\">All Frequencies</SelectItem>\n                <SelectItem value=\"weekly\">Weekly</SelectItem>\n                <SelectItem value=\"bi-weekly\">Bi-Weekly</SelectItem>\n                <SelectItem value=\"monthly\">Monthly</SelectItem>\n              </SelectContent>\n            </Select>\n          </div>\n\n          {/* Day Filter */}\n          <div className=\"min-w-[140px]\">\n            <Select value={dayFilter} onValueChange={setDayFilter}>\n              <SelectTrigger>\n                <SelectValue placeholder=\"All Days\" />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"all\">All Days</SelectItem>\n                <SelectItem value=\"monday\">Monday</SelectItem>\n                <SelectItem value=\"tuesday\">Tuesday</SelectItem>\n                <SelectItem value=\"wednesday\">Wednesday</SelectItem>\n                <SelectItem value=\"thursday\">Thursday</SelectItem>\n                <SelectItem value=\"friday\">Friday</SelectItem>\n                <SelectItem value=\"saturday\">Saturday</SelectItem>\n                <SelectItem value=\"sunday\">Sunday</SelectItem>\n              </SelectContent>\n            </Select>\n          </div>\n          \n          {/* Clear Filters Button */}\n          {(searchTerm || typeFilter !== 'all' || frequencyFilter !== 'all' || dayFilter !== 'all') && (\n            <Button\n              variant=\"outline\"\n              onClick={clearFilters}\n              className=\"text-gray-600 border-gray-300 hover:bg-gray-50\"\n            >\n              <X className=\"w-4 h-4 mr-2\" />\n              Clear Filters\n            </Button>\n          )}\n        </div>\n      </div>\n\n      {filteredRecurringTasks.length === 0 ? (\n        <div className=\"text-center py-12 text-gray-500 bg-gray-50 rounded-lg\">\n          <div className=\"text-6xl mb-4\">üìã</div>\n          {searchTerm || typeFilter !== 'all' || frequencyFilter !== 'all' || dayFilter !== 'all' ? (\n            <div>\n              <p className=\"text-lg font-medium mb-2\">No recurring tasks match your filters</p>\n              <p className=\"text-sm\">Try adjusting your search terms or clearing the filters to see more tasks.</p>\n            </div>\n          ) : (\n            <div>\n              <p className=\"text-lg font-medium mb-2\">No recurring tasks found</p>\n              <p className=\"text-sm\">Create your first recurring task to get started with automated scheduling.</p>\n            </div>\n          )}\n        </div>\n      ) : (\n        <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-3\">\n          {filteredRecurringTasks.map((task) => (\n          <Card key={task.id} className=\"relative\">\n            <CardHeader className=\"pb-3\">\n              <div className=\"flex items-start justify-between\">\n                <div className=\"flex items-center gap-3\">\n                  <span className=\"text-2xl\">{getTaskTypeEmoji(task.type)}</span>\n                  <div>\n                    <CardTitle className=\"text-lg\">{task.title}</CardTitle>\n                    <p className=\"text-sm text-gray-600 mt-1\">{task.description}</p>\n                  </div>\n                </div>\n                <div className=\"flex items-center gap-2\">\n                  <Switch\n                    checked={task.isActive ?? false}\n                    onCheckedChange={(checked) => \n                      toggleTaskMutation.mutate({ id: task.id, isActive: checked })\n                    }\n                  />\n                </div>\n              </div>\n            </CardHeader>\n            \n            <CardContent className=\"pt-0\">\n              <div className=\"space-y-3\">\n                <div className=\"flex items-center text-sm text-gray-600\">\n                  <Calendar className=\"w-4 h-4 mr-2\" />\n                  <span>{getFrequencyDisplay(task)}</span>\n                </div>\n                \n                <div className=\"flex items-center text-sm text-gray-600\">\n                  <RotateCcw className=\"w-4 h-4 mr-2\" />\n                  <span>Type: {task.type?.replace('-', ' ') || 'Unknown'}</span>\n                </div>\n                \n                {task.automation?.enabled && (\n                  <div className=\"flex items-center gap-2\">\n                    <Badge variant=\"secondary\" className=\"text-xs\">\n                      ü§ñ Automated\n                    </Badge>\n                    {task.automation.generateTrays && (\n                      <Badge variant=\"outline\" className=\"text-xs\">\n                        üìã {task.automation.trayCount} trays\n                      </Badge>\n                    )}\n                  </div>\n                )}\n                \n                {task.checklistTemplate?.steps && task.checklistTemplate.steps.length > 0 && (\n                  <div className=\"flex items-center gap-2 mb-2\">\n                    <CheckSquare className=\"w-4 h-4 text-blue-600\" />\n                    <span className=\"text-sm text-blue-600\">\n                      {task.checklistTemplate.steps.length} checklist steps\n                    </span>\n                  </div>\n                )}\n\n                {task.automation?.flow?.stages && task.automation.flow.stages.length > 0 && (\n                  <div className=\"flex items-center gap-2 mb-2\">\n                    <Building2 className=\"w-4 h-4 text-green-600\" />\n                    <span className=\"text-sm text-green-600\">\n                      {task.automation.flow.stages.length} stage flow\n                    </span>\n                  </div>\n                )}\n                \n                <div className=\"flex justify-end gap-2 pt-2\">\n                  <Button\n                    variant=\"outline\"\n                    size=\"sm\"\n                    onClick={() => setEditingTask(task)}\n                  >\n                    <Edit className=\"w-4 h-4 mr-1\" />\n                    Edit\n                  </Button>\n                  <Button\n                    variant=\"outline\"\n                    size=\"sm\"\n                    onClick={() => handleDeleteClick(task)}\n                    className=\"text-red-600 hover:text-red-700\"\n                  >\n                    <Trash2 className=\"w-4 h-4 mr-1\" />\n                    Delete\n                  </Button>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        ))}\n        </div>\n      )}\n\n      {/* Add/Edit Modal - Keyed to force remount when task changes or creating new task */}\n      <RecurringTaskModal\n        key={`recurring-modal-${editingTask?.id || `new-${modalKey}`}`}\n        task={editingTask}\n        isOpen={showAddModal || !!editingTask}\n        onClose={() => {\n          setShowAddModal(false);\n          setEditingTask(null);\n        }}\n        onSave={(taskData) => saveTaskMutation.mutateAsync(taskData)}\n      />\n\n      {/* Delete Confirmation Modal */}\n      <DeleteRecurringTaskModal\n        recurringTask={deletingTask}\n        isOpen={showDeleteModal}\n        onClose={() => {\n          setShowDeleteModal(false);\n          setDeletingTask(null);\n        }}\n        onConfirm={handleDeleteConfirm}\n      />\n    </div>\n  );\n};\n\nexport default RecurringTasks;","path":null,"size_bytes":21988,"size_tokens":null},"server/index.ts":{"content":"import express, { type Request, Response, NextFunction } from \"express\";\nimport { registerRoutes } from \"./routes\";\nimport { setupVite, serveStatic, log } from \"./vite\";\n\nconst app = express();\napp.use(express.json());\napp.use(express.urlencoded({ extended: false }));\n\n// Disable ETag caching globally\napp.disable('etag');\n\n// Disable HTTP caching for all API routes to prevent 304 responses\napp.use('/api', (req, res, next) => {\n  res.set('Cache-Control', 'no-store, no-cache, must-revalidate, max-age=0');\n  res.set('Pragma', 'no-cache');\n  res.set('Expires', '0');\n  next();\n});\n\napp.use((req, res, next) => {\n  const start = Date.now();\n  const path = req.path;\n  let capturedJsonResponse: Record<string, any> | undefined = undefined;\n\n  const originalResJson = res.json;\n  res.json = function (bodyJson, ...args) {\n    capturedJsonResponse = bodyJson;\n    return originalResJson.apply(res, [bodyJson, ...args]);\n  };\n\n  res.on(\"finish\", () => {\n    const duration = Date.now() - start;\n    if (path.startsWith(\"/api\")) {\n      let logLine = `${req.method} ${path} ${res.statusCode} in ${duration}ms`;\n      if (capturedJsonResponse) {\n        logLine += ` :: ${JSON.stringify(capturedJsonResponse)}`;\n      }\n\n      if (logLine.length > 80) {\n        logLine = logLine.slice(0, 79) + \"‚Ä¶\";\n      }\n\n      log(logLine);\n    }\n  });\n\n  next();\n});\n\n(async () => {\n  const server = await registerRoutes(app);\n\n  app.use((err: any, _req: Request, res: Response, _next: NextFunction) => {\n    const status = err.status || err.statusCode || 500;\n    const message = err.message || \"Internal Server Error\";\n\n    res.status(status).json({ message });\n    \n    // Only throw error in development to avoid server crashes in production\n    if (process.env.NODE_ENV === \"development\") {\n      throw err;\n    } else {\n      // Log the error in production instead of throwing\n      console.error(\"Production error:\", err);\n    }\n  });\n\n  // importantly only setup vite in development and after\n  // setting up all the other routes so the catch-all route\n  // doesn't interfere with the other routes\n  if (app.get(\"env\") === \"development\") {\n    await setupVite(app, server);\n  } else {\n    serveStatic(app);\n  }\n\n  // ALWAYS serve the app on the port specified in the environment variable PORT\n  // Other ports are firewalled. Default to 5000 if not specified.\n  // this serves both the API and the client.\n  // It is the only port that is not firewalled.\n  const port = parseInt(process.env.PORT || '5000', 10);\n  server.listen({\n    port,\n    host: \"0.0.0.0\",\n    reusePort: true,\n  }, () => {\n    log(`serving on port ${port}`);\n  });\n})();\n","path":null,"size_bytes":2637,"size_tokens":null},"client/src/components/ui/form.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport {\n  Controller,\n  FormProvider,\n  useFormContext,\n  type ControllerProps,\n  type FieldPath,\n  type FieldValues,\n} from \"react-hook-form\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Label } from \"@/components/ui/label\"\n\nconst Form = FormProvider\n\ntype FormFieldContextValue<\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n> = {\n  name: TName\n}\n\nconst FormFieldContext = React.createContext<FormFieldContextValue>(\n  {} as FormFieldContextValue\n)\n\nconst FormField = <\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n>({\n  ...props\n}: ControllerProps<TFieldValues, TName>) => {\n  return (\n    <FormFieldContext.Provider value={{ name: props.name }}>\n      <Controller {...props} />\n    </FormFieldContext.Provider>\n  )\n}\n\nconst useFormField = () => {\n  const fieldContext = React.useContext(FormFieldContext)\n  const itemContext = React.useContext(FormItemContext)\n  const { getFieldState, formState } = useFormContext()\n\n  const fieldState = getFieldState(fieldContext.name, formState)\n\n  if (!fieldContext) {\n    throw new Error(\"useFormField should be used within <FormField>\")\n  }\n\n  const { id } = itemContext\n\n  return {\n    id,\n    name: fieldContext.name,\n    formItemId: `${id}-form-item`,\n    formDescriptionId: `${id}-form-item-description`,\n    formMessageId: `${id}-form-item-message`,\n    ...fieldState,\n  }\n}\n\ntype FormItemContextValue = {\n  id: string\n}\n\nconst FormItemContext = React.createContext<FormItemContextValue>(\n  {} as FormItemContextValue\n)\n\nconst FormItem = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const id = React.useId()\n\n  return (\n    <FormItemContext.Provider value={{ id }}>\n      <div ref={ref} className={cn(\"space-y-2\", className)} {...props} />\n    </FormItemContext.Provider>\n  )\n})\nFormItem.displayName = \"FormItem\"\n\nconst FormLabel = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  const { error, formItemId } = useFormField()\n\n  return (\n    <Label\n      ref={ref}\n      className={cn(error && \"text-destructive\", className)}\n      htmlFor={formItemId}\n      {...props}\n    />\n  )\n})\nFormLabel.displayName = \"FormLabel\"\n\nconst FormControl = React.forwardRef<\n  React.ElementRef<typeof Slot>,\n  React.ComponentPropsWithoutRef<typeof Slot>\n>(({ ...props }, ref) => {\n  const { error, formItemId, formDescriptionId, formMessageId } = useFormField()\n\n  return (\n    <Slot\n      ref={ref}\n      id={formItemId}\n      aria-describedby={\n        !error\n          ? `${formDescriptionId}`\n          : `${formDescriptionId} ${formMessageId}`\n      }\n      aria-invalid={!!error}\n      {...props}\n    />\n  )\n})\nFormControl.displayName = \"FormControl\"\n\nconst FormDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => {\n  const { formDescriptionId } = useFormField()\n\n  return (\n    <p\n      ref={ref}\n      id={formDescriptionId}\n      className={cn(\"text-sm text-muted-foreground\", className)}\n      {...props}\n    />\n  )\n})\nFormDescription.displayName = \"FormDescription\"\n\nconst FormMessage = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, children, ...props }, ref) => {\n  const { error, formMessageId } = useFormField()\n  const body = error ? String(error?.message ?? \"\") : children\n\n  if (!body) {\n    return null\n  }\n\n  return (\n    <p\n      ref={ref}\n      id={formMessageId}\n      className={cn(\"text-sm font-medium text-destructive\", className)}\n      {...props}\n    >\n      {body}\n    </p>\n  )\n})\nFormMessage.displayName = \"FormMessage\"\n\nexport {\n  useFormField,\n  Form,\n  FormItem,\n  FormLabel,\n  FormControl,\n  FormDescription,\n  FormMessage,\n  FormField,\n}\n","path":null,"size_bytes":4120,"size_tokens":null},"client/src/components/ui/textarea.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Textarea = React.forwardRef<\n  HTMLTextAreaElement,\n  React.ComponentProps<\"textarea\">\n>(({ className, ...props }, ref) => {\n  return (\n    <textarea\n      className={cn(\n        \"flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n        className\n      )}\n      ref={ref}\n      {...props}\n    />\n  )\n})\nTextarea.displayName = \"Textarea\"\n\nexport { Textarea }\n","path":null,"size_bytes":689,"size_tokens":null},"clear_tray_data.js":{"content":"// Clear tray data from localStorage for testing\nconsole.log('Clearing tray data from localStorage...');\n\n// Clear the tray tracking data\nif (typeof localStorage !== 'undefined') {\n  localStorage.removeItem('trayTrackingData');\n  console.log('Tray data cleared from localStorage');\n} else {\n  console.log('localStorage not available in this context');\n}\n","path":null,"size_bytes":354,"size_tokens":null},"client/src/hooks/use-toast.ts":{"content":"import * as React from \"react\"\n\nimport type {\n  ToastActionElement,\n  ToastProps,\n} from \"@/components/ui/toast\"\n\nconst TOAST_LIMIT = 1\nconst TOAST_REMOVE_DELAY = 1000000\n\ntype ToasterToast = ToastProps & {\n  id: string\n  title?: React.ReactNode\n  description?: React.ReactNode\n  action?: ToastActionElement\n}\n\nconst actionTypes = {\n  ADD_TOAST: \"ADD_TOAST\",\n  UPDATE_TOAST: \"UPDATE_TOAST\",\n  DISMISS_TOAST: \"DISMISS_TOAST\",\n  REMOVE_TOAST: \"REMOVE_TOAST\",\n} as const\n\nlet count = 0\n\nfunction genId() {\n  count = (count + 1) % Number.MAX_SAFE_INTEGER\n  return count.toString()\n}\n\ntype ActionType = typeof actionTypes\n\ntype Action =\n  | {\n      type: ActionType[\"ADD_TOAST\"]\n      toast: ToasterToast\n    }\n  | {\n      type: ActionType[\"UPDATE_TOAST\"]\n      toast: Partial<ToasterToast>\n    }\n  | {\n      type: ActionType[\"DISMISS_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n  | {\n      type: ActionType[\"REMOVE_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n\ninterface State {\n  toasts: ToasterToast[]\n}\n\nconst toastTimeouts = new Map<string, ReturnType<typeof setTimeout>>()\n\nconst addToRemoveQueue = (toastId: string) => {\n  if (toastTimeouts.has(toastId)) {\n    return\n  }\n\n  const timeout = setTimeout(() => {\n    toastTimeouts.delete(toastId)\n    dispatch({\n      type: \"REMOVE_TOAST\",\n      toastId: toastId,\n    })\n  }, TOAST_REMOVE_DELAY)\n\n  toastTimeouts.set(toastId, timeout)\n}\n\nexport const reducer = (state: State, action: Action): State => {\n  switch (action.type) {\n    case \"ADD_TOAST\":\n      return {\n        ...state,\n        toasts: [action.toast, ...state.toasts].slice(0, TOAST_LIMIT),\n      }\n\n    case \"UPDATE_TOAST\":\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === action.toast.id ? { ...t, ...action.toast } : t\n        ),\n      }\n\n    case \"DISMISS_TOAST\": {\n      const { toastId } = action\n\n      // ! Side effects ! - This could be extracted into a dismissToast() action,\n      // but I'll keep it here for simplicity\n      if (toastId) {\n        addToRemoveQueue(toastId)\n      } else {\n        state.toasts.forEach((toast) => {\n          addToRemoveQueue(toast.id)\n        })\n      }\n\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === toastId || toastId === undefined\n            ? {\n                ...t,\n                open: false,\n              }\n            : t\n        ),\n      }\n    }\n    case \"REMOVE_TOAST\":\n      if (action.toastId === undefined) {\n        return {\n          ...state,\n          toasts: [],\n        }\n      }\n      return {\n        ...state,\n        toasts: state.toasts.filter((t) => t.id !== action.toastId),\n      }\n  }\n}\n\nconst listeners: Array<(state: State) => void> = []\n\nlet memoryState: State = { toasts: [] }\n\nfunction dispatch(action: Action) {\n  memoryState = reducer(memoryState, action)\n  listeners.forEach((listener) => {\n    listener(memoryState)\n  })\n}\n\ntype Toast = Omit<ToasterToast, \"id\">\n\nfunction toast({ ...props }: Toast) {\n  const id = genId()\n\n  const update = (props: ToasterToast) =>\n    dispatch({\n      type: \"UPDATE_TOAST\",\n      toast: { ...props, id },\n    })\n  const dismiss = () => dispatch({ type: \"DISMISS_TOAST\", toastId: id })\n\n  dispatch({\n    type: \"ADD_TOAST\",\n    toast: {\n      ...props,\n      id,\n      open: true,\n      onOpenChange: (open) => {\n        if (!open) dismiss()\n      },\n    },\n  })\n\n  return {\n    id: id,\n    dismiss,\n    update,\n  }\n}\n\nfunction useToast() {\n  const [state, setState] = React.useState<State>(memoryState)\n\n  React.useEffect(() => {\n    listeners.push(setState)\n    return () => {\n      const index = listeners.indexOf(setState)\n      if (index > -1) {\n        listeners.splice(index, 1)\n      }\n    }\n  }, [state])\n\n  return {\n    ...state,\n    toast,\n    dismiss: (toastId?: string) => dispatch({ type: \"DISMISS_TOAST\", toastId }),\n  }\n}\n\nexport { useToast, toast }\n","path":null,"size_bytes":3895,"size_tokens":null},"client/src/components/ui/input.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Input = React.forwardRef<HTMLInputElement, React.ComponentProps<\"input\">>(\n  ({ className, type, ...props }, ref) => {\n    return (\n      <input\n        type={type}\n        className={cn(\n          \"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n          className\n        )}\n        ref={ref}\n        {...props}\n      />\n    )\n  }\n)\nInput.displayName = \"Input\"\n\nexport { Input }\n","path":null,"size_bytes":791,"size_tokens":null},"client/src/pages/StaffData.tsx":{"content":"import React, { useState, useEffect } from 'react';\nimport { useUser } from '@/contexts/UserContext';\nimport { useToast } from '@/hooks/use-toast';\nimport { useLocation } from '@/contexts/LocationContext';\nimport { SubTabNavigation } from '@/components/SubTabNavigation';\nimport { \n  getAllStaff, \n  updateStaffMember, \n  addStaffMember, \n  deleteStaffMember,\n  getAvailableRoles, \n  canAssignRole,\n  type StaffMember \n} from '@/services/staffService';\nimport { formatLastActive } from '@/hooks/useActivityTracking';\n\n// Mock staff data with location codes\nconst mockStaff = [\n  {\n    id: 1,\n    fullName: 'Alex Martinez',\n    email: 'alex.martinez@growspace.farm',\n    phone: '555-0101',\n    location: 'K', // Kenosha\n    rolesAssigned: ['General Staff', 'Seeding Tech'],\n    dateHired: '2023-06-15',\n    payRate: 18.50, // Hidden from non-managers\n    trainingCompleted: ['Basic Safety & Orientation', 'Seeding Technician Certification'],\n    trainingInProgress: [],\n    preferredHours: 'Morning (6am-2pm)',\n    activeStatus: 'active',\n    lastTaskCompleted: '2024-03-15T14:30:00',\n    managerNotes: 'Excellent attention to detail, very reliable',\n    tasksCompleted: 156,\n    avgTaskDuration: '45m',\n    onTimeRate: 98.5,\n    microsoftId: null // Will be populated with Teams integration\n  },\n  {\n    id: 2,\n    fullName: 'Sarah Johnson',\n    email: 'sarah.j@growspace.farm',\n    phone: '555-0102',\n    location: 'K', // Kenosha\n    rolesAssigned: ['General Staff', 'Harvest Tech', 'Packing'],\n    dateHired: '2023-03-22',\n    payRate: 20.00,\n    trainingCompleted: ['Basic Safety & Orientation', 'Harvest Operations Training'],\n    trainingInProgress: ['Equipment Operation & Maintenance'],\n    preferredHours: 'Flexible',\n    activeStatus: 'active',\n    lastTaskCompleted: '2024-03-15T16:45:00',\n    managerNotes: 'Fast learner, great with customers',\n    tasksCompleted: 234,\n    avgTaskDuration: '38m',\n    onTimeRate: 96.2,\n    microsoftId: null\n  },\n  {\n    id: 3,\n    fullName: 'Mike Chen',\n    email: 'mike.chen@growspace.farm',\n    phone: '555-0103',\n    location: 'R', // Racine\n    rolesAssigned: ['General Staff', 'Equipment Tech', 'Cleaning Crew'],\n    dateHired: '2024-01-10',\n    payRate: 17.00,\n    trainingCompleted: ['Basic Safety & Orientation'],\n    trainingInProgress: ['Equipment Operation & Maintenance'],\n    preferredHours: 'Afternoon (2pm-10pm)',\n    activeStatus: 'active',\n    lastTaskCompleted: '2024-03-14T18:20:00',\n    managerNotes: 'New hire, showing good progress',\n    tasksCompleted: 42,\n    avgTaskDuration: '52m',\n    onTimeRate: 88.5,\n    microsoftId: null\n  },\n  {\n    id: 4,\n    fullName: 'Jessica Wong',\n    email: 'jessica.w@growspace.farm',\n    phone: '555-0104',\n    location: 'R', // Racine\n    rolesAssigned: ['Manager', 'All Roles'],\n    dateHired: '2022-11-01',\n    payRate: 28.00,\n    trainingCompleted: ['Basic Safety & Orientation', 'Manager Fundamentals', 'All Technical Courses'],\n    trainingInProgress: [],\n    preferredHours: 'Full-time',\n    activeStatus: 'active',\n    lastTaskCompleted: '2024-03-15T17:00:00',\n    managerNotes: 'Shift supervisor, excellent leadership',\n    tasksCompleted: 412,\n    avgTaskDuration: '32m',\n    onTimeRate: 99.1,\n    microsoftId: null\n  },\n  {\n    id: 5,\n    fullName: 'Tom Rodriguez',\n    email: 'tom.r@growspace.farm',\n    phone: '555-0105',\n    location: 'MKE', // Milwaukee\n    rolesAssigned: ['General Staff'],\n    dateHired: '2024-02-20',\n    payRate: 16.50,\n    trainingCompleted: ['Basic Safety & Orientation'],\n    trainingInProgress: ['Seeding Technician Certification'],\n    preferredHours: 'Morning (6am-2pm)',\n    activeStatus: 'on-leave',\n    lastTaskCompleted: '2024-03-01T12:00:00',\n    managerNotes: 'On medical leave until 03/20',\n    tasksCompleted: 18,\n    avgTaskDuration: '48m',\n    onTimeRate: 85.0,\n    microsoftId: null\n  },\n  {\n    id: 6,\n    fullName: 'David Kim',\n    email: 'david.k@growspace.farm',\n    phone: '555-0106',\n    location: 'MKE', // Milwaukee\n    rolesAssigned: ['General Staff', 'Harvest Tech'],\n    dateHired: '2023-09-12',\n    payRate: 19.25,\n    trainingCompleted: ['Basic Safety & Orientation', 'Harvest Operations Training'],\n    trainingInProgress: [],\n    preferredHours: 'Evening (2pm-10pm)',\n    activeStatus: 'active',\n    lastTaskCompleted: '2024-03-15T19:30:00',\n    managerNotes: 'Consistent performer, good teamwork',\n    tasksCompleted: 187,\n    avgTaskDuration: '41m',\n    onTimeRate: 94.8,\n    microsoftId: null\n  }\n];\n\n// Staff Table Row Component\nconst StaffTableRow: React.FC<{\n  person: any;\n  isManager: boolean;\n  onEdit: (person: any) => void;\n}> = ({ person, isManager, onEdit }) => {\n  const formatDate = (dateString: string) => {\n    return new Date(dateString).toLocaleDateString();\n  };\n  \n  const formatTimeAgo = (dateString: string) => {\n    if (!dateString) return 'Never';\n    \n    const date = new Date(dateString);\n    const now = new Date();\n    const diffHours = Math.floor((now.getTime() - date.getTime()) / (1000 * 60 * 60));\n    \n    if (diffHours < 1) return 'Just now';\n    if (diffHours < 24) return `${diffHours}h ago`;\n    if (diffHours < 48) return 'Yesterday';\n    return `${Math.floor(diffHours / 24)}d ago`;\n  };\n  \n  return (\n    <tr className={person.activeStatus !== 'active' ? 'inactive-row' : ''}>\n      <td>\n        <div className=\"staff-name\">\n          {person.fullName}\n          {person.microsoftId && (\n            <span className=\"ms-connected\" title=\"Microsoft Teams Connected\">\n              üìß\n            </span>\n          )}\n        </div>\n      </td>\n      <td>\n        <div className=\"contact-info\">\n          <div className=\"email\">{person.businessEmail || person.email}</div>\n          <div className=\"phone\">{person.mobilePhone || person.phone}</div>\n          {person.personalEmail && <div className=\"personal-email\">Personal: {person.personalEmail}</div>}\n        </div>\n      </td>\n      <td>\n        <div className=\"roles-list\">\n          {person.rolesAssigned && person.rolesAssigned.length > 0 ? (\n            person.rolesAssigned.map((role: string) => (\n              <span key={role} className={`role-badge role-${role.toLowerCase().replace(/\\s+/g, '-')}`}>\n                {getRoleIcon(role)} {role}\n              </span>\n            ))\n          ) : (\n            <span className=\"no-roles\">No roles assigned</span>\n          )}\n        </div>\n      </td>\n      <td>{formatDate(person.dateHired)}</td>\n      {isManager && (\n        <td className=\"pay-rate\">\n          {person.payType === 'unpaid' ? \n            'Unpaid' : \n            person.payType === 'salary' ? \n              `$${person.payRate.toLocaleString()}/year` : \n              `$${person.payRate.toFixed(2)}/hr`\n          }\n        </td>\n      )}\n      <td>\n        <div className=\"training-status\">\n          <span className=\"completed\" title=\"Completed courses\">\n            ‚úÖ {person.trainingCompleted.length}\n          </span>\n          {person.trainingInProgress.length > 0 && (\n            <span className=\"in-progress\" title=\"In progress\">\n              üìö {person.trainingInProgress.length}\n            </span>\n          )}\n        </div>\n      </td>\n      <td>\n        <span className={`status-badge status-${person.activeStatus}`}>\n          {person.activeStatus.replace('-', ' ')}\n        </span>\n      </td>\n      <td>\n        <span className=\"last-active\">\n          {formatLastActive(person.lastActive)}\n        </span>\n      </td>\n      <td>\n        <button \n          onClick={() => onEdit(person)}\n          className=\"btn-edit\"\n        >\n          Edit\n        </button>\n      </td>\n    </tr>\n  );\n};\n\n// Staff Edit View Component\nconst StaffEditView: React.FC<{\n  staff: any[];\n  isManager: boolean;\n  onUpdateStaff: (updatedStaff: any[]) => void;\n  onDeleteStaff?: () => void;\n}> = ({ staff, isManager, onUpdateStaff, onDeleteStaff }) => {\n  const [searchTerm, setSearchTerm] = useState('');\n  const [sortBy, setSortBy] = useState('name');\n  const [showEditModal, setShowEditModal] = useState(false);\n  const [editingStaff, setEditingStaff] = useState(null);\n  const { toast } = useToast();\n  \n  // Filter staff based on search\n  const filteredStaff = staff.filter(person =>\n    person.fullName.toLowerCase().includes(searchTerm.toLowerCase()) ||\n    person.email.toLowerCase().includes(searchTerm.toLowerCase()) ||\n    person.rolesAssigned.some((role: string) => role.toLowerCase().includes(searchTerm.toLowerCase()))\n  );\n  \n  // Sort staff - inactive/deleted items go to bottom\n  const sortedStaff = [...filteredStaff].sort((a, b) => {\n    // First sort by active status (active first, then inactive)\n    const aActive = a.activeStatus === 'active' ? 0 : 1;\n    const bActive = b.activeStatus === 'active' ? 0 : 1;\n    \n    if (aActive !== bActive) {\n      return aActive - bActive;\n    }\n    \n    // Then sort by the selected criteria within each group\n    switch (sortBy) {\n      case 'name':\n        return a.fullName.localeCompare(b.fullName);\n      case 'dateHired':\n        return new Date(b.dateHired).getTime() - new Date(a.dateHired).getTime();\n      case 'payRate':\n        return b.payRate - a.payRate;\n      case 'tasks':\n        return b.tasksCompleted - a.tasksCompleted;\n      default:\n        return 0;\n    }\n  });\n  \n  const handleEdit = (person: any) => {\n    setEditingStaff(person);\n    setShowEditModal(true);\n  };\n\n  const handleAddStaff = () => {\n    setEditingStaff(null);\n    setShowEditModal(true);\n  };\n\n  const handleSaveStaff = async (staffData: StaffMember) => {\n    try {\n      if (editingStaff) {\n        // Update existing staff member\n        await updateStaffMember(staffData);\n        const updatedStaff = staff.map(person => \n          person.id === staffData.id ? staffData : person\n        );\n        onUpdateStaff(updatedStaff);\n      } else {\n        // Add new staff member\n        const newStaff = await addStaffMember({\n          fullName: staffData.fullName,\n          email: staffData.email,\n          phone: staffData.phone,\n          location: staffData.location,\n          rolesAssigned: staffData.rolesAssigned,\n          dateHired: staffData.dateHired,\n          payRate: staffData.payRate,\n          trainingCompleted: staffData.trainingCompleted || [],\n          trainingInProgress: staffData.trainingInProgress || [],\n          preferredHours: staffData.preferredHours,\n          activeStatus: staffData.activeStatus,\n          lastTaskCompleted: staffData.lastTaskCompleted,\n          managerNotes: staffData.managerNotes,\n          tasksCompleted: staffData.tasksCompleted || 0,\n          avgTaskDuration: staffData.avgTaskDuration || '0m',\n          onTimeRate: staffData.onTimeRate || 100,\n          microsoftId: staffData.microsoftId || '',\n          lastActive: new Date().toISOString()\n        });\n        const updatedStaff = [...staff, newStaff];\n        onUpdateStaff(updatedStaff);\n      }\n      \n      setShowEditModal(false);\n      setEditingStaff(null);\n      toast({\n        title: \"Staff Member Saved\",\n        description: `${staffData.fullName} has been ${editingStaff ? 'updated' : 'added'} successfully.`,\n      });\n    } catch (error) {\n      console.error('Error saving staff member:', error);\n      toast({\n        title: \"Error\",\n        description: \"Failed to save staff member. Please try again.\",\n        variant: \"destructive\"\n      });\n    }\n  };\n  \n  return (\n    <div className=\"staff-edit-view\">\n      {/* Toolbar */}\n      <div className=\"staff-toolbar\">\n        <input\n          type=\"text\"\n          placeholder=\"üîç Search by name, email, or role...\"\n          value={searchTerm}\n          onChange={(e) => setSearchTerm(e.target.value)}\n          className=\"search-input\"\n        />\n        \n        <select \n          value={sortBy} \n          onChange={(e) => setSortBy(e.target.value)}\n          className=\"sort-select\"\n        >\n          <option value=\"name\">Sort by Name</option>\n          <option value=\"dateHired\">Sort by Hire Date</option>\n          <option value=\"payRate\">Sort by Pay Rate</option>\n          <option value=\"tasks\">Sort by Tasks Completed</option>\n        </select>\n        \n        <button className=\"btn-add-staff\" onClick={handleAddStaff}>\n          + Add Staff Member\n        </button>\n      </div>\n      \n      {/* Staff Table */}\n      <div className=\"staff-table-container\">\n        <table className={`staff-table ${isManager ? 'manager-view' : ''}`}>\n          <thead>\n            <tr>\n              <th>Name</th>\n              <th>Contact</th>\n              <th>Roles</th>\n              <th>Hire Date</th>\n              {isManager && <th>Pay Rate</th>}\n              <th>Training</th>\n              <th>Status</th>\n              <th>Last Active</th>\n              <th>Actions</th>\n            </tr>\n          </thead>\n          <tbody>\n            {sortedStaff.map(person => (\n              <StaffTableRow \n                key={person.id}\n                person={person}\n                isManager={isManager}\n                onEdit={handleEdit}\n              />\n            ))}\n          </tbody>\n        </table>\n      </div>\n      \n      {/* Edit Modal */}\n      {showEditModal && (\n        <StaffEditModal\n          staff={editingStaff}\n          onSave={handleSaveStaff}\n          onClose={() => {\n            setShowEditModal(false);\n            setEditingStaff(null);\n          }}\n          onDelete={onDeleteStaff}\n        />\n      )}\n    </div>\n  );\n};\n\n// Staff Edit Modal Component\nconst StaffEditModal: React.FC<{\n  staff: any;\n  onSave: (staffData: any) => void;\n  onClose: () => void;\n  onDelete?: () => void;\n}> = ({ staff, onSave, onClose, onDelete }) => {\n  const [formData, setFormData] = useState({\n    fullName: staff?.fullName || '',\n    businessEmail: staff?.businessEmail || staff?.email || '',\n    personalEmail: staff?.personalEmail || '',\n    homePhone: staff?.homePhone || '',\n    businessPhone: staff?.businessPhone || '',\n    mobilePhone: staff?.mobilePhone || staff?.phone || '',\n    emergencyContactName: staff?.emergencyContactName || '',\n    emergencyRelationship: staff?.emergencyRelationship || '',\n    emergencyPhone: staff?.emergencyPhone || '',\n    location: staff?.location || 'Grow Space',\n    rolesAssigned: staff?.rolesAssigned || [],\n    dateHired: staff?.dateHired || new Date().toISOString().split('T')[0],\n    payType: staff?.payType || 'hourly',\n    payRate: staff?.payRate || 16.00,\n    preferredHours: staff?.preferredHours || 'Flexible',\n    activeStatus: staff?.activeStatus || 'active',\n    managerNotes: staff?.managerNotes || ''\n  });\n  \n  const [errors, setErrors] = useState<{[key: string]: string}>({});\n  const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);\n  const [isDeleting, setIsDeleting] = useState(false);\n  \n  const availableRoles = [\n    'Microgreens Seeder',\n    'Leafy Greens Seeder',\n    'Microgreens Harvester',\n    'Leafy Greens Harvester',\n    'Blackout Specialist',\n    'Moving Tech',\n    'Packing Tech',\n    'Cleaning Crew',\n    'Inventory Tech',\n    'Equipment Tech',\n    'Manager',\n    'General Staff'\n  ];\n  \n  const validateForm = () => {\n    const newErrors: {[key: string]: string} = {};\n    if (!formData.fullName.trim()) newErrors.fullName = 'Name is required';\n    if (!formData.businessEmail.trim()) newErrors.businessEmail = 'Business email is required';\n    if (!formData.businessEmail.includes('@')) newErrors.businessEmail = 'Invalid email format';\n    if (!formData.mobilePhone.trim()) newErrors.mobilePhone = 'Mobile phone is required for emergencies';\n    if (!formData.emergencyContactName.trim()) newErrors.emergencyContactName = 'Emergency contact name is required';\n    if (!formData.emergencyRelationship.trim()) newErrors.emergencyRelationship = 'Emergency contact relationship is required';\n    if (!formData.emergencyPhone.trim()) newErrors.emergencyPhone = 'Emergency contact phone is required';\n    if (formData.payType !== 'unpaid' && formData.payRate <= 0) {\n      newErrors.payRate = 'Pay rate must be greater than 0 for paid positions';\n    }\n    if (formData.payRate < 0) newErrors.payRate = 'Pay rate cannot be negative';\n    if (formData.rolesAssigned.length === 0) newErrors.roles = 'At least one role required';\n    \n    setErrors(newErrors);\n    return Object.keys(newErrors).length === 0;\n  };\n\n  // Delete handler with double-click confirmation\n  const handleDelete = async () => {\n    if (!staff || !onDelete) return;\n\n    if (!showDeleteConfirm) {\n      // First click - show confirmation\n      setShowDeleteConfirm(true);\n      \n      // Reset confirmation after 5 seconds\n      setTimeout(() => {\n        setShowDeleteConfirm(false);\n      }, 5000);\n      return;\n    }\n    \n    // Second click - actually delete\n    setIsDeleting(true);\n    \n    try {\n      await deleteStaffMember(staff.id);\n      \n      // Close modal and trigger parent refresh\n      onDelete();\n      onClose();\n    } catch (error: any) {\n      // Handle different error types\n      if (error.message.includes('active tasks')) {\n        alert(`Cannot delete ${staff.fullName}: They have active tasks that need to be completed or reassigned first.`);\n      } else {\n        alert(`Error deleting staff member: ${error.message}`);\n      }\n      setIsDeleting(false);\n      setShowDeleteConfirm(false);\n    }\n  };\n  \n  const handleSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    \n    if (!validateForm()) return;\n    \n    // For unpaid positions, ensure pay rate is 0\n    const finalPayRate = formData.payType === 'unpaid' ? 0 : formData.payRate;\n    \n    const staffData = {\n      ...staff,\n      ...formData,\n      payRate: finalPayRate,\n      // Backward compatibility: keep the original email and phone fields\n      email: formData.businessEmail,\n      phone: formData.mobilePhone,\n      id: staff?.id || Date.now(),\n      // Keep existing data that isn't in the form\n      trainingCompleted: staff?.trainingCompleted || [],\n      trainingInProgress: staff?.trainingInProgress || [],\n      lastTaskCompleted: staff?.lastTaskCompleted || null,\n      tasksCompleted: staff?.tasksCompleted || 0,\n      avgTaskDuration: staff?.avgTaskDuration || '0m',\n      onTimeRate: staff?.onTimeRate || 100,\n      microsoftId: staff?.microsoftId || null\n    };\n    \n    onSave(staffData);\n  };\n  \n  return (\n    <div className=\"modal-overlay\">\n      <div className=\"modal-content large-modal\">\n        <div className=\"modal-header\">\n          <h2>{staff ? 'Edit Staff Member' : 'Add New Staff Member'}</h2>\n          <button onClick={onClose} className=\"close-btn\">‚úï</button>\n        </div>\n        \n        <form onSubmit={handleSubmit} className=\"staff-form\">\n          <div className=\"form-grid\">\n            {/* Personal Information Section */}\n            <div className=\"form-section\">\n              <h3>üìã Personal Information</h3>\n              \n              <label className={errors.fullName ? 'error' : ''}>\n                Full Name *\n                <input\n                  type=\"text\"\n                  value={formData.fullName}\n                  onChange={(e) => setFormData({...formData, fullName: e.target.value})}\n                  placeholder=\"John Smith\"\n                />\n                {errors.fullName && <span className=\"error-text\">{errors.fullName}</span>}\n              </label>\n              \n              {/* Email Fields Row */}\n              <div className=\"form-row\">\n                <label className={errors.businessEmail ? 'error' : ''}>\n                  Business Email *\n                  <input\n                    type=\"email\"\n                    value={formData.businessEmail}\n                    onChange={(e) => setFormData({...formData, businessEmail: e.target.value})}\n                    placeholder=\"john@growspace.farm\"\n                  />\n                  <small>Used for login authentication (Teams/Work account)</small>\n                  {errors.businessEmail && <span className=\"error-text\">{errors.businessEmail}</span>}\n                </label>\n                \n                <label>\n                  Personal Email\n                  <input\n                    type=\"email\"\n                    value={formData.personalEmail}\n                    onChange={(e) => setFormData({...formData, personalEmail: e.target.value})}\n                    placeholder=\"john.doe@gmail.com\"\n                  />\n                  <small>Personal email address</small>\n                </label>\n              </div>\n\n              {/* Phone Fields Row */}\n              <div className=\"form-row\">\n                <label>\n                  Home Phone\n                  <input\n                    type=\"tel\"\n                    value={formData.homePhone}\n                    onChange={(e) => setFormData({...formData, homePhone: e.target.value})}\n                    placeholder=\"555-555-5555\"\n                  />\n                </label>\n                \n                <label>\n                  Business Phone\n                  <input\n                    type=\"tel\"\n                    value={formData.businessPhone}\n                    onChange={(e) => setFormData({...formData, businessPhone: e.target.value})}\n                    placeholder=\"555-555-5555 ext 123\"\n                  />\n                </label>\n              </div>\n\n              {/* Mobile Phone - Critical for emergencies */}\n              <label className={errors.mobilePhone ? 'error' : ''}>\n                Mobile Phone *\n                <input\n                  type=\"tel\"\n                  value={formData.mobilePhone}\n                  onChange={(e) => setFormData({...formData, mobilePhone: e.target.value})}\n                  placeholder=\"555-555-5555\"\n                />\n                <small>Primary contact for emergencies</small>\n                {errors.mobilePhone && <span className=\"error-text\">{errors.mobilePhone}</span>}\n              </label>\n            </div>\n            \n            {/* Emergency Contact Section */}\n            <div className=\"form-section\">\n              <h3>üö® Emergency Contact</h3>\n              \n              <label className={errors.emergencyContactName ? 'error' : ''}>\n                Emergency Contact Name *\n                <input\n                  type=\"text\"\n                  value={formData.emergencyContactName}\n                  onChange={(e) => setFormData({...formData, emergencyContactName: e.target.value})}\n                  placeholder=\"Jane Doe\"\n                />\n                {errors.emergencyContactName && <span className=\"error-text\">{errors.emergencyContactName}</span>}\n              </label>\n              \n              <div className=\"form-row\">\n                <label className={errors.emergencyRelationship ? 'error' : ''}>\n                  Relationship *\n                  <input\n                    type=\"text\"\n                    value={formData.emergencyRelationship}\n                    onChange={(e) => setFormData({...formData, emergencyRelationship: e.target.value})}\n                    placeholder=\"Spouse, Parent, etc.\"\n                  />\n                  {errors.emergencyRelationship && <span className=\"error-text\">{errors.emergencyRelationship}</span>}\n                </label>\n                \n                <label className={errors.emergencyPhone ? 'error' : ''}>\n                  Emergency Phone *\n                  <input\n                    type=\"tel\"\n                    value={formData.emergencyPhone}\n                    onChange={(e) => setFormData({...formData, emergencyPhone: e.target.value})}\n                    placeholder=\"555-555-5555\"\n                  />\n                  {errors.emergencyPhone && <span className=\"error-text\">{errors.emergencyPhone}</span>}\n                </label>\n              </div>\n            </div>\n            \n            {/* Work Information Section */}\n            <div className=\"form-section\">\n              <h3>üíº Work Information</h3>\n              \n              <label>\n                Location\n                <select\n                  value={formData.location}\n                  onChange={(e) => setFormData({...formData, location: e.target.value})}\n                >\n                  <option value=\"Grow Space\">Grow Space</option>\n                </select>\n              </label>\n              \n              <label>\n                Date Hired\n                <input\n                  type=\"date\"\n                  value={formData.dateHired}\n                  onChange={(e) => setFormData({...formData, dateHired: e.target.value})}\n                />\n              </label>\n              \n              <label>\n                Pay Type *\n                <select\n                  value={formData.payType}\n                  onChange={(e) => {\n                    const newPayType = e.target.value;\n                    setFormData({\n                      ...formData, \n                      payType: newPayType,\n                      payRate: newPayType === 'unpaid' ? 0 : formData.payRate\n                    });\n                  }}\n                >\n                  <option value=\"hourly\">Hourly</option>\n                  <option value=\"salary\">Salary</option>\n                  <option value=\"unpaid\">Unpaid (Volunteer/Intern)</option>\n                </select>\n              </label>\n              \n              <label className={`pay-rate-field ${errors.payRate ? 'error' : ''}`}>\n                {formData.payType === 'hourly' ? 'Pay Rate ($/hr)' : \n                 formData.payType === 'salary' ? 'Annual Salary ($)' : \n                 'Pay Rate'} *\n                <div className=\"input-with-note\">\n                  <input\n                    type=\"number\"\n                    value={formData.payRate}\n                    onChange={(e) => setFormData({...formData, payRate: parseFloat(e.target.value) || 0})}\n                    min=\"0\"\n                    step={formData.payType === 'hourly' ? \"0.01\" : \"1000\"}\n                    disabled={formData.payType === 'unpaid'}\n                    placeholder={\n                      formData.payType === 'hourly' ? \"15.00\" : \n                      formData.payType === 'salary' ? \"40000\" : \n                      \"0\"\n                    }\n                  />\n                  <span className=\"field-note\">üîí Hidden from non-managers</span>\n                  {formData.payType === 'unpaid' && (\n                    <span className=\"field-note\">Unpaid position - no compensation</span>\n                  )}\n                </div>\n                {errors.payRate && <span className=\"error-text\">{errors.payRate}</span>}\n              </label>\n              \n              <label>\n                Preferred Hours\n                <select\n                  value={formData.preferredHours}\n                  onChange={(e) => setFormData({...formData, preferredHours: e.target.value})}\n                >\n                  <option value=\"Flexible\">Flexible</option>\n                  <option value=\"Morning (6am-2pm)\">Morning (6am-2pm)</option>\n                  <option value=\"Afternoon (2pm-10pm)\">Afternoon (2pm-10pm)</option>\n                  <option value=\"Full-time\">Full-time</option>\n                  <option value=\"Part-time\">Part-time</option>\n                </select>\n              </label>\n              \n              <label>\n                Status\n                <select\n                  value={formData.activeStatus}\n                  onChange={(e) => setFormData({...formData, activeStatus: e.target.value})}\n                >\n                  <option value=\"active\">Active</option>\n                  <option value=\"on-leave\">On Leave</option>\n                  <option value=\"inactive\">Inactive</option>\n                </select>\n              </label>\n            </div>\n            \n            {/* Roles Section */}\n            <div className=\"form-section full-width\">\n              <h3>üë§ Assigned Roles</h3>\n              {errors.roles && <span className=\"error-text\">{errors.roles}</span>}\n              \n              <div className=\"checkbox-group\">\n                {availableRoles.map(role => (\n                  <label key={role} className=\"checkbox-label\">\n                    <input\n                      type=\"checkbox\"\n                      checked={formData.rolesAssigned.includes(role)}\n                      onChange={(e) => {\n                        if (e.target.checked) {\n                          setFormData({\n                            ...formData,\n                            rolesAssigned: [...formData.rolesAssigned, role]\n                          });\n                        } else {\n                          setFormData({\n                            ...formData,\n                            rolesAssigned: formData.rolesAssigned.filter((r: string) => r !== role)\n                          });\n                        }\n                      }}\n                    />\n                    <span>{getRoleIcon(role)} {role}</span>\n                  </label>\n                ))}\n              </div>\n            </div>\n            \n            {/* Manager Notes Section */}\n            <div className=\"form-section full-width\">\n              <h3>üìù Manager Notes</h3>\n              <textarea\n                value={formData.managerNotes}\n                onChange={(e) => setFormData({...formData, managerNotes: e.target.value})}\n                rows={4}\n                placeholder=\"Internal notes about this staff member...\"\n              />\n            </div>\n            \n            {/* Training Info - Read Only for now */}\n            {staff && (\n              <div className=\"form-section full-width info-section\">\n                <h3>üìö Training Information</h3>\n                <div className=\"info-grid\">\n                  <div>\n                    <strong>Completed Training:</strong>\n                    <ul>\n                      {staff.trainingCompleted.length > 0 ? (\n                        staff.trainingCompleted.map((training: string) => (\n                          <li key={training}>{training}</li>\n                        ))\n                      ) : (\n                        <li>No completed training</li>\n                      )}\n                    </ul>\n                  </div>\n                  <div>\n                    <strong>In Progress:</strong>\n                    <ul>\n                      {staff.trainingInProgress.length > 0 ? (\n                        staff.trainingInProgress.map((training: string) => (\n                          <li key={training}>{training}</li>\n                        ))\n                      ) : (\n                        <li>No training in progress</li>\n                      )}\n                    </ul>\n                  </div>\n                </div>\n              </div>\n            )}\n          </div>\n          \n          <div className=\"modal-actions\">\n            {staff && onDelete && ( // Only show delete for existing staff, not new ones\n              <button \n                type=\"button\" \n                className={`btn-delete ${showDeleteConfirm ? 'confirm' : ''}`}\n                onClick={handleDelete}\n                disabled={isDeleting}\n                data-testid=\"button-delete-staff\"\n              >\n                {isDeleting ? 'Deleting...' : \n                 showDeleteConfirm ? '‚ö†Ô∏è Click again to confirm delete' : \n                 'üóëÔ∏è Delete Staff Member'}\n              </button>\n            )}\n            \n            <div className=\"modal-actions-right\">\n              <button type=\"submit\" className=\"btn-save\" disabled={isDeleting} data-testid=\"button-save-staff\">\n                {staff ? 'Save Changes' : 'Add Staff Member'}\n              </button>\n              <button type=\"button\" onClick={onClose} className=\"btn-cancel\" disabled={isDeleting} data-testid=\"button-cancel-staff\">\n                Cancel\n              </button>\n            </div>\n          </div>\n        </form>\n      </div>\n    </div>\n  );\n};\n\n// Staff Ranking Row Component\nconst StaffRankingRow: React.FC<{\n  person: any;\n  rank: number;\n  metric: string;\n}> = ({ person, rank, metric }) => {\n  const getRankEmoji = (rank: number) => {\n    switch (rank) {\n      case 1: return 'ü•á';\n      case 2: return 'ü•à';\n      case 3: return 'ü•â';\n      default: return `#${rank}`;\n    }\n  };\n  \n  const getMetricValue = () => {\n    switch (metric) {\n      case 'tasks':\n        return `${person.tasksCompleted} tasks`;\n      case 'efficiency':\n        return `${person.onTimeRate}% on-time`;\n      case 'cost':\n        const costPerTask = person.payRate / (person.tasksCompleted / 100);\n        return `$${costPerTask.toFixed(2)}/task`;\n      default:\n        return person.tasksCompleted;\n    }\n  };\n  \n  return (\n    <div className=\"ranking-row\">\n      <span className=\"rank\">{getRankEmoji(rank)}</span>\n      <div className=\"person-info\">\n        <span className=\"name\">{person.fullName}</span>\n        <span className=\"roles\">{person.rolesAssigned.join(', ')}</span>\n      </div>\n      <span className=\"metric-value\">{getMetricValue()}</span>\n    </div>\n  );\n};\n\n// Staff Performance Card Component\nconst StaffPerformanceCard: React.FC<{\n  staff: any;\n}> = ({ staff }) => {\n  // Calculate individual metrics\n  const hoursWorked = staff.tasksCompleted * 0.75; // Rough estimate\n  const laborCost = hoursWorked * staff.payRate;\n  const costPerTask = staff.tasksCompleted > 0 ? laborCost / staff.tasksCompleted : 0;\n  \n  // Task type breakdown (mock data)\n  const taskBreakdown = {\n    'Seeding': Math.floor(staff.tasksCompleted * 0.3),\n    'Harvesting': Math.floor(staff.tasksCompleted * 0.25),\n    'Cleaning': Math.floor(staff.tasksCompleted * 0.2),\n    'Packing': Math.floor(staff.tasksCompleted * 0.15),\n    'Other': Math.floor(staff.tasksCompleted * 0.1)\n  };\n  \n  return (\n    <div className=\"performance-card\">\n      <div className=\"card-header\">\n        <h4>{staff.fullName}</h4>\n        <span className={`status-indicator ${staff.activeStatus}`}>\n          {staff.activeStatus}\n        </span>\n      </div>\n      \n      <div className=\"performance-metrics\">\n        <div className=\"metric-row\">\n          <span className=\"label\">Tasks Completed:</span>\n          <span className=\"value\">{staff.tasksCompleted}</span>\n        </div>\n        <div className=\"metric-row\">\n          <span className=\"label\">Avg Task Duration:</span>\n          <span className=\"value\">{staff.avgTaskDuration}</span>\n        </div>\n        <div className=\"metric-row\">\n          <span className=\"label\">On-Time Rate:</span>\n          <span className={`value ${staff.onTimeRate > 95 ? 'good' : staff.onTimeRate > 85 ? 'warning' : 'poor'}`}>\n            {staff.onTimeRate}%\n          </span>\n        </div>\n        <div className=\"metric-row\">\n          <span className=\"label\">Est. Labor Cost:</span>\n          <span className=\"value\">${laborCost.toFixed(2)}</span>\n        </div>\n        <div className=\"metric-row\">\n          <span className=\"label\">Cost per Task:</span>\n          <span className=\"value\">${costPerTask.toFixed(2)}</span>\n        </div>\n      </div>\n      \n      {/* Mini Task Breakdown Chart */}\n      <div className=\"task-breakdown\">\n        <h5>Tasks by Type</h5>\n        <div className=\"breakdown-bars\">\n          {Object.entries(taskBreakdown).map(([type, count]) => (\n            <div key={type} className=\"breakdown-item\">\n              <span className=\"type-label\">{type}</span>\n              <div className=\"bar-container\">\n                <div \n                  className=\"bar\" \n                  style={{ width: `${(count / staff.tasksCompleted) * 100}%` }}\n                />\n              </div>\n              <span className=\"count\">{count}</span>\n            </div>\n          ))}\n        </div>\n      </div>\n    </div>\n  );\n};\n\n// Training Overview Component\nconst TrainingOverview: React.FC<{\n  staff: any[];\n}> = ({ staff }) => {\n  // Get all unique training courses\n  const allCourses = [\n    'Basic Safety & Orientation',\n    'Seeding Technician Certification',\n    'Harvest Operations Training',\n    'Equipment Operation & Maintenance',\n    'Manager Fundamentals'\n  ];\n  \n  return (\n    <div className=\"training-overview\">\n      <h3>üéì Training Completion Matrix</h3>\n      <div className=\"training-matrix\">\n        <table>\n          <thead>\n            <tr>\n              <th>Staff Member</th>\n              {allCourses.map(course => (\n                <th key={course} className=\"course-header\">\n                  {course.split(' ').map(word => word[0]).join('')}\n                </th>\n              ))}\n            </tr>\n          </thead>\n          <tbody>\n            {staff.map(person => (\n              <tr key={person.id}>\n                <td className=\"staff-name-cell\">{person.fullName}</td>\n                {allCourses.map(course => (\n                  <td key={course} className=\"status-cell\">\n                    {person.trainingCompleted.includes(course) ? (\n                      <span className=\"completed\">‚úÖ</span>\n                    ) : person.trainingInProgress.includes(course) ? (\n                      <span className=\"in-progress\">üìö</span>\n                    ) : (\n                      <span className=\"not-started\">-</span>\n                    )}\n                  </td>\n                ))}\n              </tr>\n            ))}\n          </tbody>\n        </table>\n      </div>\n      \n      {/* Course name legend */}\n      <div className=\"course-legend\">\n        <h4>Course Abbreviations:</h4>\n        <ul>\n          {allCourses.map(course => (\n            <li key={course}>\n              <strong>{course.split(' ').map(word => word[0]).join('')}:</strong> {course}\n            </li>\n          ))}\n        </ul>\n      </div>\n    </div>\n  );\n};\n\n// Staff Analytics View Component\nconst StaffAnalyticsView: React.FC<{\n  staff: any[];\n}> = ({ staff }) => {\n  const [dateRange, setDateRange] = useState('last30days');\n  const [selectedMetric, setSelectedMetric] = useState('tasks');\n  \n  // Format date range for display\n  const getDateRangeLabel = (range: string) => {\n    switch (range) {\n      case 'last7days': return 'Last 7 Days';\n      case 'last30days': return 'Last 30 Days';\n      case 'last90days': return 'Last 90 Days';\n      case 'last6months': return 'Last 6 Months';\n      case 'last12months': return 'Last 12 Months';\n      default: return 'Last 30 Days';\n    }\n  };\n  \n  const getDateRangeShort = (range: string) => {\n    switch (range) {\n      case 'last7days': return '7d';\n      case 'last30days': return '30d';\n      case 'last90days': return '90d';\n      case 'last6months': return '6mo';\n      case 'last12months': return '12mo';\n      default: return '30d';\n    }\n  };\n  \n  // Filter staff data based on date range\n  const getDateRangeMultiplier = (range: string) => {\n    switch (range) {\n      case 'last7days': return 0.25;\n      case 'last30days': return 1;\n      case 'last90days': return 3;\n      case 'last6months': return 6;\n      case 'last12months': return 12;\n      default: return 1;\n    }\n  };\n  \n  const dateMultiplier = getDateRangeMultiplier(dateRange);\n  \n  // Apply date range filtering to staff performance data\n  const getFilteredStaffData = () => {\n    return staff.map((person, index) => ({\n      ...person,\n      tasksCompleted: Math.round(person.tasksCompleted * dateMultiplier),\n      onTimeRate: Math.max(50, Math.min(100, person.onTimeRate + (index * 2 - 3) * dateMultiplier * 0.5))\n    }));\n  };\n  \n  const filteredStaff = getFilteredStaffData();\n  \n  // Calculate summary metrics based on filtered data\n  const activeStaff = filteredStaff.filter(s => s.activeStatus === 'active');\n  const totalStaff = filteredStaff.length;\n  const avgPayRate = filteredStaff.reduce((sum, s) => sum + s.payRate, 0) / filteredStaff.length;\n  \n  // Calculate total labor cost with date range consideration\n  const calculateTotalLaborCost = () => {\n    let totalCost = 0;\n    filteredStaff.forEach(person => {\n      const hoursWorked = person.tasksCompleted * 0.75; // Rough estimate\n      totalCost += hoursWorked * person.payRate;\n    });\n    return totalCost;\n  };\n  \n  const totalLaborCost = calculateTotalLaborCost();\n  \n  // Calculate average on-time rate from filtered data\n  const avgOnTimeRate = filteredStaff.reduce((sum, s) => sum + s.onTimeRate, 0) / filteredStaff.length;\n  \n  return (\n    <div className=\"staff-analytics-view\">\n      {/* Date Range Filter */}\n      <div className=\"analytics-toolbar\">\n        <select \n          value={dateRange} \n          onChange={(e) => setDateRange(e.target.value)}\n          className=\"date-range-select\"\n        >\n          <option value=\"last7days\">Last 7 Days</option>\n          <option value=\"last30days\">Last 30 Days</option>\n          <option value=\"last90days\">Last 90 Days</option>\n          <option value=\"last6months\">Last 6 Months</option>\n          <option value=\"last12months\">Last 12 Months</option>\n        </select>\n        \n        <select \n          value={selectedMetric} \n          onChange={(e) => setSelectedMetric(e.target.value)}\n          className=\"metric-select\"\n        >\n          <option value=\"tasks\">Tasks Completed</option>\n          <option value=\"hours\">Hours Worked</option>\n          <option value=\"efficiency\">Efficiency</option>\n          <option value=\"cost\">Labor Cost</option>\n        </select>\n      </div>\n      \n      {/* Summary Cards */}\n      <div className=\"analytics-cards\">\n        <div className=\"analytics-card\">\n          <div className=\"card-icon\">üë•</div>\n          <div className=\"card-content\">\n            <h3>Total Staff</h3>\n            <div className=\"metric\">{totalStaff}</div>\n            <div className=\"sub-metric\">{activeStaff.length} active</div>\n          </div>\n        </div>\n        \n        <div className=\"analytics-card\">\n          <div className=\"card-icon\">üí∞</div>\n          <div className=\"card-content\">\n            <h3>Avg Pay Rate</h3>\n            <div className=\"metric\">${avgPayRate.toFixed(2)}</div>\n            <div className=\"sub-metric\">per hour</div>\n          </div>\n        </div>\n        \n        <div className=\"analytics-card\">\n          <div className=\"card-icon\">‚è±Ô∏è</div>\n          <div className=\"card-content\">\n            <h3>On-Time Rate</h3>\n            <div className=\"metric\">{avgOnTimeRate.toFixed(1)}%</div>\n            <div className=\"sub-metric\">average</div>\n          </div>\n        </div>\n        \n        <div className=\"analytics-card\">\n          <div className=\"card-icon\">üíµ</div>\n          <div className=\"card-content\">\n            <h3>Labor Cost ({getDateRangeShort(dateRange)})</h3>\n            <div className=\"metric\">${totalLaborCost.toFixed(2)}</div>\n            <div className=\"sub-metric\">estimated</div>\n          </div>\n        </div>\n      </div>\n      \n      {/* Performance Rankings */}\n      <div className=\"performance-section\">\n        <h3>üèÜ Top Performers by {selectedMetric === 'tasks' ? 'Tasks Completed' : \n                                   selectedMetric === 'hours' ? 'Hours Worked' :\n                                   selectedMetric === 'efficiency' ? 'Efficiency Rate' :\n                                   'Cost Efficiency'} ({getDateRangeLabel(dateRange)})</h3>\n        <div className=\"rankings-list\">\n          {activeStaff\n            .sort((a, b) => {\n              switch (selectedMetric) {\n                case 'tasks':\n                  return b.tasksCompleted - a.tasksCompleted;\n                case 'efficiency':\n                  return b.onTimeRate - a.onTimeRate;\n                case 'cost':\n                  return (a.tasksCompleted / a.payRate) - (b.tasksCompleted / b.payRate);\n                default:\n                  return b.tasksCompleted - a.tasksCompleted;\n              }\n            })\n            .slice(0, 10)\n            .map((person, index) => (\n              <StaffRankingRow \n                key={person.id}\n                person={person}\n                rank={index + 1}\n                metric={selectedMetric}\n              />\n            ))\n          }\n        </div>\n      </div>\n      \n      {/* Individual Performance Cards */}\n      <div className=\"individual-performance\">\n        <h3>üìä Individual Performance Details ({getDateRangeLabel(dateRange)})</h3>\n        <div className=\"performance-grid\">\n          {activeStaff.map(person => (\n            <StaffPerformanceCard \n              key={person.id}\n              staff={person}\n            />\n          ))}\n        </div>\n      </div>\n      \n      {/* Training Overview */}\n      <TrainingOverview staff={filteredStaff} />\n    </div>\n  );\n};\n\n// Helper function for role icons\nconst getRoleIcon = (role: string) => {\n  const roleIcons: Record<string, string> = {\n    'Microgreens Seeder': 'üå±',\n    'Leafy Greens Seeder': 'ü•¨',\n    'Microgreens Harvester': '‚úÇÔ∏è',\n    'Leafy Greens Harvester': 'ü•ó',\n    'Blackout Specialist': 'üåë',\n    'Moving Tech': 'üì¶',\n    'Packing Tech': 'üìã',\n    'Cleaning Crew': 'üßπ',\n    'Inventory Tech': 'üìä',\n    'Equipment Tech': 'üîß',\n    'Manager': 'üëî',\n    'General Staff': 'üë•'\n  };\n  return roleIcons[role] || 'üë§';\n};\n\nconst StaffData: React.FC = () => {\n  const { currentUser } = useUser();\n  const { toast } = useToast();\n  const { currentLocation, isViewingAllLocations } = useLocation();\n  const isManager = currentUser?.role === 'Manager' || currentUser?.role === 'Corporate';\n  const [activeTab, setActiveTab] = useState('edit');\n  const [staff, setStaff] = useState<StaffMember[]>([]);\n\n  // Load staff data from service on component mount\n  useEffect(() => {\n    loadStaff();\n  }, []);\n  \n  // Filter staff by location\n  const filteredStaff = React.useMemo(() => {\n    if (isViewingAllLocations || currentUser?.role === 'Corporate') {\n      return staff;\n    }\n    return staff.filter(person => person.location === currentLocation.code);\n  }, [staff, currentLocation.code, isViewingAllLocations, currentUser?.role]);\n\n  // Load staff data function to reuse\n  const loadStaff = async () => {\n    try {\n      const allStaff = await getAllStaff();\n      setStaff(allStaff);\n      console.log('Loaded staff data:', allStaff.length, 'members');\n    } catch (error) {\n      console.error('Error loading staff data:', error);\n      setStaff([]); // Fallback to empty array\n    }\n  };\n\n  // Update staff data handler\n  const handleUpdateStaff = (updatedStaff: StaffMember[]) => {\n    setStaff(updatedStaff);\n    // Staff service handles persistence automatically\n  };\n\n  // Delete staff handler\n  const handleDeleteStaff = async () => {\n    // Refresh staff list after deletion\n    await loadStaff();\n    \n    toast({\n      title: \"Staff Member Deleted\",\n      description: \"Staff member has been successfully removed from the system.\",\n    });\n  };\n\n  const handleExport = () => {\n    toast({\n      title: \"Export Started\",\n      description: \"Staff report will be downloaded shortly.\",\n    });\n  };\n\n  if (!isManager) {\n    return (\n      <div className=\"access-denied\">\n        <h2>Access Denied</h2>\n        <p>This page is only available to managers.</p>\n      </div>\n    );\n  }\n\n  const tabs = [\n    { id: 'edit', label: 'Staff Edit', icon: '‚úèÔ∏è' },\n    { id: 'analytics', label: 'Staff Analytics', icon: 'üìä' }\n  ];\n\n  return (\n    <div className=\"staff-data-page\">\n      {/* Navigation and Actions on same line */}\n      <div className=\"nav-with-actions\">\n        <SubTabNavigation \n          tabs={tabs}\n          activeTab={activeTab}\n          onTabChange={setActiveTab}\n        />\n        \n        <div className=\"nav-actions\">\n          <button className=\"btn-export\" onClick={handleExport}>\n            üìä Export Staff Report\n          </button>\n        </div>\n      </div>\n      \n      {/* Content will go here based on activeTab */}\n      <div className=\"tab-content\">\n        {activeTab === 'edit' ? (\n          <StaffEditView \n            staff={filteredStaff}\n            isManager={isManager}\n            onUpdateStaff={setStaff}\n            onDeleteStaff={handleDeleteStaff}\n          />\n        ) : (\n          <StaffAnalyticsView \n            staff={filteredStaff}\n          />\n        )}\n      </div>\n    </div>\n  );\n};\n\nexport default StaffData;","path":null,"size_bytes":48061,"size_tokens":null},"client/src/components/DevLogin.tsx":{"content":"import { useState } from 'react';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\nimport { setStoredAuth } from '@/lib/auth';\nimport { useToast } from '@/hooks/use-toast';\n\ninterface DevLoginProps {\n  onSuccess: () => void;\n}\n\nexport function DevLogin({ onSuccess }: DevLoginProps) {\n  const [email, setEmail] = useState('');\n  const [isLoading, setIsLoading] = useState(false);\n  const { toast } = useToast();\n\n  const quickLoginOptions = [\n    { email: 'robert@growspace.farm', name: 'Robert Carlson', role: 'Corporate Manager' },\n    { email: 'Simone@growspace.farm', name: 'Simone Birriel', role: 'Staff' }\n  ];\n\n  const handleLogin = async (loginEmail: string) => {\n    setIsLoading(true);\n    try {\n      const response = await fetch('/api/auth/dev-login', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({ email: loginEmail }),\n      });\n\n      const data = await response.json();\n\n      if (response.ok) {\n        // Store the user in localStorage like Microsoft auth does\n        setStoredAuth(data.user);\n        \n        toast({\n          title: 'Login Successful',\n          description: `Logged in as ${data.user.name}`,\n        });\n        \n        // Trigger page reload to initialize user context\n        setTimeout(() => {\n          window.location.reload();\n        }, 500);\n      } else {\n        throw new Error(data.message || 'Login failed');\n      }\n    } catch (error) {\n      toast({\n        title: 'Login Failed',\n        description: error instanceof Error ? error.message : 'Unknown error',\n        variant: 'destructive',\n      });\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  return (\n    <Card className=\"w-full max-w-md mx-auto\" data-testid=\"card-dev-login\">\n      <CardHeader>\n        <CardTitle>Development Login</CardTitle>\n        <CardDescription>\n          Choose a user to log in as, or enter an email manually\n        </CardDescription>\n      </CardHeader>\n      <CardContent className=\"space-y-4\">\n        {/* Quick login buttons */}\n        <div className=\"space-y-2\">\n          <h4 className=\"text-sm font-medium\">Quick Login</h4>\n          {quickLoginOptions.map((option) => (\n            <Button\n              key={option.email}\n              variant=\"outline\"\n              className=\"w-full justify-start\"\n              onClick={() => handleLogin(option.email)}\n              disabled={isLoading}\n              data-testid={`button-quick-login-${option.email.split('@')[0]}`}\n            >\n              <div className=\"text-left\">\n                <div className=\"font-medium\">{option.name}</div>\n                <div className=\"text-xs text-muted-foreground\">{option.email} - {option.role}</div>\n              </div>\n            </Button>\n          ))}\n        </div>\n\n        {/* Manual email input */}\n        <div className=\"space-y-2\">\n          <h4 className=\"text-sm font-medium\">Custom Email</h4>\n          <div className=\"flex gap-2\">\n            <Input\n              type=\"email\"\n              placeholder=\"Enter email address\"\n              value={email}\n              onChange={(e) => setEmail(e.target.value)}\n              disabled={isLoading}\n              data-testid=\"input-custom-email\"\n            />\n            <Button\n              onClick={() => handleLogin(email)}\n              disabled={isLoading || !email}\n              data-testid=\"button-custom-login\"\n            >\n              Login\n            </Button>\n          </div>\n        </div>\n\n        <div className=\"text-xs text-muted-foreground\">\n          This is a development-only login bypass. In production, Microsoft authentication would be required.\n        </div>\n      </CardContent>\n    </Card>\n  );\n}","path":null,"size_bytes":3879,"size_tokens":null},"client/src/components/ui/collapsible.tsx":{"content":"\"use client\"\n\nimport * as CollapsiblePrimitive from \"@radix-ui/react-collapsible\"\n\nconst Collapsible = CollapsiblePrimitive.Root\n\nconst CollapsibleTrigger = CollapsiblePrimitive.CollapsibleTrigger\n\nconst CollapsibleContent = CollapsiblePrimitive.CollapsibleContent\n\nexport { Collapsible, CollapsibleTrigger, CollapsibleContent }\n","path":null,"size_bytes":329,"size_tokens":null},"client/src/components/ui/menubar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as MenubarPrimitive from \"@radix-ui/react-menubar\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nfunction MenubarMenu({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Menu>) {\n  return <MenubarPrimitive.Menu {...props} />\n}\n\nfunction MenubarGroup({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Group>) {\n  return <MenubarPrimitive.Group {...props} />\n}\n\nfunction MenubarPortal({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Portal>) {\n  return <MenubarPrimitive.Portal {...props} />\n}\n\nfunction MenubarRadioGroup({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.RadioGroup>) {\n  return <MenubarPrimitive.RadioGroup {...props} />\n}\n\nfunction MenubarSub({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Sub>) {\n  return <MenubarPrimitive.Sub data-slot=\"menubar-sub\" {...props} />\n}\n\nconst Menubar = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"flex h-10 items-center space-x-1 rounded-md border bg-background p-1\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubar.displayName = MenubarPrimitive.Root.displayName\n\nconst MenubarTrigger = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Trigger>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-3 py-1.5 text-sm font-medium outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarTrigger.displayName = MenubarPrimitive.Trigger.displayName\n\nconst MenubarSubTrigger = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <MenubarPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </MenubarPrimitive.SubTrigger>\n))\nMenubarSubTrigger.displayName = MenubarPrimitive.SubTrigger.displayName\n\nconst MenubarSubContent = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarSubContent.displayName = MenubarPrimitive.SubContent.displayName\n\nconst MenubarContent = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Content>\n>(\n  (\n    { className, align = \"start\", alignOffset = -4, sideOffset = 8, ...props },\n    ref\n  ) => (\n    <MenubarPrimitive.Portal>\n      <MenubarPrimitive.Content\n        ref={ref}\n        align={align}\n        alignOffset={alignOffset}\n        sideOffset={sideOffset}\n        className={cn(\n          \"z-50 min-w-[12rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]\",\n          className\n        )}\n        {...props}\n      />\n    </MenubarPrimitive.Portal>\n  )\n)\nMenubarContent.displayName = MenubarPrimitive.Content.displayName\n\nconst MenubarItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <MenubarPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarItem.displayName = MenubarPrimitive.Item.displayName\n\nconst MenubarCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <MenubarPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <MenubarPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </MenubarPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </MenubarPrimitive.CheckboxItem>\n))\nMenubarCheckboxItem.displayName = MenubarPrimitive.CheckboxItem.displayName\n\nconst MenubarRadioItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <MenubarPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <MenubarPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </MenubarPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </MenubarPrimitive.RadioItem>\n))\nMenubarRadioItem.displayName = MenubarPrimitive.RadioItem.displayName\n\nconst MenubarLabel = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <MenubarPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarLabel.displayName = MenubarPrimitive.Label.displayName\n\nconst MenubarSeparator = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nMenubarSeparator.displayName = MenubarPrimitive.Separator.displayName\n\nconst MenubarShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nMenubarShortcut.displayname = \"MenubarShortcut\"\n\nexport {\n  Menubar,\n  MenubarMenu,\n  MenubarTrigger,\n  MenubarContent,\n  MenubarItem,\n  MenubarSeparator,\n  MenubarLabel,\n  MenubarCheckboxItem,\n  MenubarRadioGroup,\n  MenubarRadioItem,\n  MenubarPortal,\n  MenubarSubContent,\n  MenubarSubTrigger,\n  MenubarGroup,\n  MenubarSub,\n  MenubarShortcut,\n}\n","path":null,"size_bytes":8605,"size_tokens":null},"client/src/components/ui/sheet.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as SheetPrimitive from \"@radix-ui/react-dialog\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Sheet = SheetPrimitive.Root\n\nconst SheetTrigger = SheetPrimitive.Trigger\n\nconst SheetClose = SheetPrimitive.Close\n\nconst SheetPortal = SheetPrimitive.Portal\n\nconst SheetOverlay = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Overlay\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  />\n))\nSheetOverlay.displayName = SheetPrimitive.Overlay.displayName\n\nconst sheetVariants = cva(\n  \"fixed z-50 gap-4 bg-background p-6 shadow-lg transition ease-in-out data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:duration-300 data-[state=open]:duration-500\",\n  {\n    variants: {\n      side: {\n        top: \"inset-x-0 top-0 border-b data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top\",\n        bottom:\n          \"inset-x-0 bottom-0 border-t data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom\",\n        left: \"inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm\",\n        right:\n          \"inset-y-0 right-0 h-full w-3/4  border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm\",\n      },\n    },\n    defaultVariants: {\n      side: \"right\",\n    },\n  }\n)\n\ninterface SheetContentProps\n  extends React.ComponentPropsWithoutRef<typeof SheetPrimitive.Content>,\n    VariantProps<typeof sheetVariants> {}\n\nconst SheetContent = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Content>,\n  SheetContentProps\n>(({ side = \"right\", className, children, ...props }, ref) => (\n  <SheetPortal>\n    <SheetOverlay />\n    <SheetPrimitive.Content\n      ref={ref}\n      className={cn(sheetVariants({ side }), className)}\n      {...props}\n    >\n      {children}\n      <SheetPrimitive.Close className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-secondary\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </SheetPrimitive.Close>\n    </SheetPrimitive.Content>\n  </SheetPortal>\n))\nSheetContent.displayName = SheetPrimitive.Content.displayName\n\nconst SheetHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-2 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nSheetHeader.displayName = \"SheetHeader\"\n\nconst SheetFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nSheetFooter.displayName = \"SheetFooter\"\n\nconst SheetTitle = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Title\n    ref={ref}\n    className={cn(\"text-lg font-semibold text-foreground\", className)}\n    {...props}\n  />\n))\nSheetTitle.displayName = SheetPrimitive.Title.displayName\n\nconst SheetDescription = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nSheetDescription.displayName = SheetPrimitive.Description.displayName\n\nexport {\n  Sheet,\n  SheetPortal,\n  SheetOverlay,\n  SheetTrigger,\n  SheetClose,\n  SheetContent,\n  SheetHeader,\n  SheetFooter,\n  SheetTitle,\n  SheetDescription,\n}\n","path":null,"size_bytes":4281,"size_tokens":null},"client/src/components/SystemEditModal.tsx":{"content":"import React, { useState } from 'react';\nimport { Dialog, DialogContent, DialogHeader, DialogTitle } from '@/components/ui/dialog';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { Label } from '@/components/ui/label';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Plus, Trash2 } from 'lucide-react';\nimport { GrowingSystem } from '@shared/schema';\n\ninterface SystemEditModalProps {\n  system: GrowingSystem | null;\n  onSave: (systemData: any) => void;\n  onClose: () => void;\n}\n\nexport const SystemEditModal: React.FC<SystemEditModalProps> = ({ system, onSave, onClose }) => {\n  const [formData, setFormData] = useState({\n    name: system?.name || '',\n    category: system?.category || 'nursery',\n    type: system?.type || 'microgreen',\n    capacity: system?.capacity || 0,\n    currentOccupancy: system?.currentOccupancy || 0,\n    systemData: system?.systemData || {\n      sections: {},\n      units: [],\n      channels: []\n    },\n    isActive: system?.isActive ?? true\n  });\n\n  const systemTypes = {\n    microgreen: ['nursery', 'staging', 'final'],\n    'leafy-green': ['nursery', 'staging', 'final']\n  };\n\n  const handleAddSection = () => {\n    const newSection = formData.type === 'microgreen' \n      ? { capacity: 20, occupied: [] }\n      : { capacity: 18, crop: null, occupied: [] };\n      \n    const sectionId = `section-${Date.now()}`;\n    setFormData({\n      ...formData,\n      systemData: {\n        ...formData.systemData,\n        sections: {\n          ...formData.systemData.sections,\n          [sectionId]: newSection\n        }\n      }\n    });\n  };\n\n  const handleAddUnit = () => {\n    const newUnit = {\n      id: `unit-${Date.now()}`,\n      type: 'regular',\n      totalPorts: 44,\n      occupiedPorts: []\n    };\n    \n    setFormData({\n      ...formData,\n      systemData: {\n        ...formData.systemData,\n        units: [...(formData.systemData.units || []), newUnit]\n      }\n    });\n  };\n\n  const handleAddChannel = () => {\n    const newChannel = {\n      id: formData.systemData.channels?.length || 0,\n      capacity: 20,\n      crop: null,\n      occupied: []\n    };\n    \n    setFormData({\n      ...formData,\n      systemData: {\n        ...formData.systemData,\n        channels: [...(formData.systemData.channels || []), newChannel]\n      }\n    });\n  };\n\n  const updateSection = (sectionId: string, field: string, value: any) => {\n    setFormData({\n      ...formData,\n      systemData: {\n        ...formData.systemData,\n        sections: {\n          ...formData.systemData.sections,\n          [sectionId]: {\n            ...formData.systemData.sections[sectionId],\n            [field]: value\n          }\n        }\n      }\n    });\n  };\n\n  const updateUnit = (index: number, field: string, value: any) => {\n    const units = [...(formData.systemData.units || [])];\n    units[index] = { ...units[index], [field]: value };\n    \n    if (field === 'type') {\n      units[index].totalPorts = value === 'HD' ? 176 : 44;\n    }\n    \n    setFormData({\n      ...formData,\n      systemData: {\n        ...formData.systemData,\n        units\n      }\n    });\n  };\n\n  const updateChannel = (index: number, field: string, value: any) => {\n    const channels = [...(formData.systemData.channels || [])];\n    channels[index] = { ...channels[index], [field]: value };\n    \n    setFormData({\n      ...formData,\n      systemData: {\n        ...formData.systemData,\n        channels\n      }\n    });\n  };\n\n  const removeSection = (sectionId: string) => {\n    const sections = { ...formData.systemData.sections };\n    delete sections[sectionId];\n    setFormData({\n      ...formData,\n      systemData: {\n        ...formData.systemData,\n        sections\n      }\n    });\n  };\n\n  const removeUnit = (index: number) => {\n    const units = [...(formData.systemData.units || [])];\n    units.splice(index, 1);\n    setFormData({\n      ...formData,\n      systemData: {\n        ...formData.systemData,\n        units\n      }\n    });\n  };\n\n  const removeChannel = (index: number) => {\n    const channels = [...(formData.systemData.channels || [])];\n    channels.splice(index, 1);\n    setFormData({\n      ...formData,\n      systemData: {\n        ...formData.systemData,\n        channels\n      }\n    });\n  };\n\n  const handleSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    \n    // Calculate total capacity based on configuration\n    let totalCapacity = 0;\n    if (formData.systemData.sections) {\n      totalCapacity += Object.values(formData.systemData.sections).reduce((sum, section: any) => sum + section.capacity, 0);\n    }\n    if (formData.systemData.units) {\n      totalCapacity += formData.systemData.units.reduce((sum, unit) => sum + unit.totalPorts, 0);\n    }\n    if (formData.systemData.channels) {\n      totalCapacity += formData.systemData.channels.reduce((sum, channel) => sum + channel.capacity, 0);\n    }\n    \n    const systemData = {\n      ...formData,\n      capacity: totalCapacity || formData.capacity,\n      id: system?.id\n    };\n    \n    onSave(systemData);\n  };\n\n  return (\n    <Dialog open={true} onOpenChange={onClose}>\n      <DialogContent className=\"max-w-4xl max-h-[90vh] overflow-y-auto\">\n        <DialogHeader>\n          <DialogTitle>{system ? 'Edit System' : 'Add New System'}</DialogTitle>\n        </DialogHeader>\n        \n        <form onSubmit={handleSubmit} className=\"space-y-6\">\n          <div className=\"grid grid-cols-2 gap-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"name\">System Name</Label>\n              <Input\n                id=\"name\"\n                value={formData.name}\n                onChange={(e) => setFormData({...formData, name: e.target.value})}\n                required\n              />\n            </div>\n            \n            <div className=\"space-y-2\">\n              <Label htmlFor=\"type\">System Type</Label>\n              <Select\n                value={formData.type}\n                onValueChange={(value) => setFormData({\n                  ...formData,\n                  type: value as any,\n                  category: systemTypes[value as keyof typeof systemTypes][0]\n                })}\n              >\n                <SelectTrigger>\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"microgreen\">Microgreen</SelectItem>\n                  <SelectItem value=\"leafy-green\">Leafy Green</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"category\">Category</Label>\n              <Select\n                value={formData.category}\n                onValueChange={(value) => setFormData({...formData, category: value})}\n              >\n                <SelectTrigger>\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  {systemTypes[formData.type as keyof typeof systemTypes].map(category => (\n                    <SelectItem key={category} value={category}>\n                      {category.charAt(0).toUpperCase() + category.slice(1)}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"capacity\">Manual Capacity (optional)</Label>\n              <Input\n                id=\"capacity\"\n                type=\"number\"\n                value={formData.capacity}\n                onChange={(e) => setFormData({...formData, capacity: parseInt(e.target.value)})}\n                placeholder=\"Leave blank for auto-calculation\"\n              />\n            </div>\n          </div>\n\n          {/* Configuration based on type */}\n          <div className=\"space-y-4\">\n            <div className=\"flex items-center justify-between\">\n              <h4 className=\"text-lg font-medium\">System Configuration</h4>\n              <div className=\"flex gap-2\">\n                <Button type=\"button\" onClick={handleAddSection} variant=\"outline\" size=\"sm\">\n                  <Plus className=\"w-4 h-4 mr-1\" />\n                  Add Section\n                </Button>\n                <Button type=\"button\" onClick={handleAddUnit} variant=\"outline\" size=\"sm\">\n                  <Plus className=\"w-4 h-4 mr-1\" />\n                  Add Unit\n                </Button>\n                <Button type=\"button\" onClick={handleAddChannel} variant=\"outline\" size=\"sm\">\n                  <Plus className=\"w-4 h-4 mr-1\" />\n                  Add Channel\n                </Button>\n              </div>\n            </div>\n\n            {/* Sections */}\n            {formData.systemData.sections && Object.keys(formData.systemData.sections).length > 0 && (\n              <Card>\n                <CardHeader>\n                  <CardTitle>Sections</CardTitle>\n                </CardHeader>\n                <CardContent className=\"space-y-3\">\n                  {Object.entries(formData.systemData.sections).map(([sectionId, section]: [string, any]) => (\n                    <div key={sectionId} className=\"flex items-center gap-3 p-3 border rounded\">\n                      <Input\n                        placeholder=\"Section ID\"\n                        value={sectionId}\n                        onChange={(e) => {\n                          const newSections = { ...formData.systemData.sections };\n                          delete newSections[sectionId];\n                          newSections[e.target.value] = section;\n                          setFormData({\n                            ...formData,\n                            systemData: { ...formData.systemData, sections: newSections }\n                          });\n                        }}\n                      />\n                      <Input\n                        type=\"number\"\n                        placeholder=\"Capacity\"\n                        value={section.capacity}\n                        onChange={(e) => updateSection(sectionId, 'capacity', parseInt(e.target.value))}\n                      />\n                      <Button\n                        type=\"button\"\n                        variant=\"outline\"\n                        size=\"sm\"\n                        onClick={() => removeSection(sectionId)}\n                        className=\"text-red-600\"\n                      >\n                        <Trash2 className=\"w-4 h-4\" />\n                      </Button>\n                    </div>\n                  ))}\n                </CardContent>\n              </Card>\n            )}\n\n            {/* Units */}\n            {formData.systemData.units && formData.systemData.units.length > 0 && (\n              <Card>\n                <CardHeader>\n                  <CardTitle>Units (Towers)</CardTitle>\n                </CardHeader>\n                <CardContent className=\"space-y-3\">\n                  {formData.systemData.units.map((unit, index) => (\n                    <div key={index} className=\"flex items-center gap-3 p-3 border rounded\">\n                      <Input\n                        placeholder=\"Unit ID (e.g., A1)\"\n                        value={unit.id}\n                        onChange={(e) => updateUnit(index, 'id', e.target.value)}\n                      />\n                      <Select\n                        value={unit.type}\n                        onValueChange={(value) => updateUnit(index, 'type', value)}\n                      >\n                        <SelectTrigger>\n                          <SelectValue />\n                        </SelectTrigger>\n                        <SelectContent>\n                          <SelectItem value=\"regular\">Regular (44 ports)</SelectItem>\n                          <SelectItem value=\"HD\">HD (176 ports)</SelectItem>\n                        </SelectContent>\n                      </Select>\n                      <Input\n                        type=\"number\"\n                        value={unit.totalPorts}\n                        onChange={(e) => updateUnit(index, 'totalPorts', parseInt(e.target.value))}\n                        readOnly\n                      />\n                      <Button\n                        type=\"button\"\n                        variant=\"outline\"\n                        size=\"sm\"\n                        onClick={() => removeUnit(index)}\n                        className=\"text-red-600\"\n                      >\n                        <Trash2 className=\"w-4 h-4\" />\n                      </Button>\n                    </div>\n                  ))}\n                </CardContent>\n              </Card>\n            )}\n\n            {/* Channels */}\n            {formData.systemData.channels && formData.systemData.channels.length > 0 && (\n              <Card>\n                <CardHeader>\n                  <CardTitle>Channels</CardTitle>\n                </CardHeader>\n                <CardContent className=\"space-y-3\">\n                  {formData.systemData.channels.map((channel, index) => (\n                    <div key={index} className=\"flex items-center gap-3 p-3 border rounded\">\n                      <Input\n                        type=\"number\"\n                        placeholder=\"Channel ID\"\n                        value={channel.id}\n                        onChange={(e) => updateChannel(index, 'id', parseInt(e.target.value))}\n                      />\n                      <Input\n                        type=\"number\"\n                        placeholder=\"Capacity\"\n                        value={channel.capacity}\n                        onChange={(e) => updateChannel(index, 'capacity', parseInt(e.target.value))}\n                      />\n                      <Input\n                        placeholder=\"Current Crop\"\n                        value={channel.crop || ''}\n                        onChange={(e) => updateChannel(index, 'crop', e.target.value)}\n                      />\n                      <Button\n                        type=\"button\"\n                        variant=\"outline\"\n                        size=\"sm\"\n                        onClick={() => removeChannel(index)}\n                        className=\"text-red-600\"\n                      >\n                        <Trash2 className=\"w-4 h-4\" />\n                      </Button>\n                    </div>\n                  ))}\n                </CardContent>\n              </Card>\n            )}\n          </div>\n\n          <div className=\"flex justify-end gap-2\">\n            <Button type=\"button\" variant=\"outline\" onClick={onClose}>\n              Cancel\n            </Button>\n            <Button type=\"submit\" className=\"bg-[#2D8028] hover:bg-[#203B17]\">\n              {system ? 'Update System' : 'Create System'}\n            </Button>\n          </div>\n        </form>\n      </DialogContent>\n    </Dialog>\n  );\n};","path":null,"size_bytes":14885,"size_tokens":null},"client/src/components/Layout.tsx":{"content":"import React, { useState } from \"react\";\nimport { Link, useLocation } from \"wouter\";\nimport { Bell, User, MapPin, ChevronDown, Home, Package, GraduationCap, Settings } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { DropdownMenu, DropdownMenuContent, DropdownMenuItem, DropdownMenuTrigger } from \"@/components/ui/dropdown-menu\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { LogoutButton } from \"@/components/auth/LogoutButton\";\nimport { useUser } from \"@/contexts/UserContext\";\nimport { DashboardAnalytics } from \"@/types\";\nimport { useIsMobile } from \"@/hooks/use-mobile\";\n\nimport { useLocation as useLocationContext } from \"@/contexts/LocationContext\";\nimport { Notification } from \"@shared/schema\";\nimport NotificationDropdown from \"@/components/NotificationDropdown\";\nimport { AdminResetButton } from \"@/utils/dataCleanup\";\n\ninterface LayoutProps {\n  children: React.ReactNode;\n}\n\nconst Layout: React.FC<LayoutProps> = ({ children }) => {\n  const [location, setLocation] = useLocation();\n  const [mobileMenuOpen, setMobileMenuOpen] = React.useState(false);\n  const [selectedLocation, setSelectedLocation] = React.useState(\"grow-space\");\n  const [showNotifications, setShowNotifications] = useState(false);\n  const { currentUser } = useUser();\n  const isMobile = useIsMobile();\n  const { currentLocation } = useLocationContext();\n\n  const { data: analytics } = useQuery<DashboardAnalytics>({\n    queryKey: [\"/api/analytics/dashboard\"],\n    enabled: !!currentUser,\n  });\n\n  // Query for user notifications\n  const { data: notifications = [] } = useQuery<Notification[]>({\n    queryKey: ['/api/notifications', currentUser?.id],\n    enabled: !!currentUser?.id,\n  });\n\n  const unreadCount = notifications.filter(n => !n.isRead).length;\n\n  const toggleNotifications = () => {\n    setShowNotifications(!showNotifications);\n  };\n\n  // Production: Single authenticated user, no test users\n\n  const navigationItems = [\n    { href: \"/\", label: \"Tasks\", icon: \"üìã\", lucideIcon: Home, requiresRole: null },\n    { href: \"/account\", label: \"Account\", icon: \"üë§\", lucideIcon: User, requiresRole: null },\n    { href: \"/inventory\", label: \"Inventory\", icon: \"üì¶\", lucideIcon: Package, requiresRole: null },\n    { href: \"/education\", label: \"Education\", icon: \"üéì\", lucideIcon: GraduationCap, requiresRole: null },\n  ];\n\n  const managerItems = [\n    { href: \"/recurring-tasks\", label: \"Recurring Tasks\", icon: \"üîÑ\", requiresRole: \"manager\", enabled: true },\n    { href: \"/task-data\", label: \"Task Data\", icon: \"üìä\", requiresRole: \"manager\", enabled: false, comingSoon: true },\n    { href: \"/staff-data\", label: \"Staff Data\", icon: \"üë•\", requiresRole: \"manager\", enabled: true },\n    { href: \"/production-data\", label: \"Production Data\", icon: \"üå±\", requiresRole: \"manager\", enabled: false, comingSoon: true },\n  ];\n\n  // Use Microsoft authenticated user\n  \n  const isManager = currentUser?.role === \"Manager\" || currentUser?.role === \"Corporate\";\n\n  const isActive = (href: string) => {\n    if (href === \"/\" && location === \"/\") return true;\n    if (href !== \"/\" && location.startsWith(href)) return true;\n    return false;\n  };\n\n  if (!currentUser) {\n    return <>{children}</>;\n  }\n\n  return (\n    <div className=\"app-container bg-[#F5F5F5]\">\n      {/* Mobile Header */}\n      {isMobile && (\n        <div className=\"fixed top-0 left-0 right-0 z-50 bg-white border-b border-gray-200 px-4 py-3 flex items-center justify-between\">\n          <h1 className=\"text-lg font-semibold text-[#203B17]\">Grow Space</h1>\n          <DropdownMenu>\n            <DropdownMenuTrigger asChild>\n              <Button variant=\"ghost\" className=\"flex items-center space-x-2\">\n                <span className=\"text-sm font-medium\">{currentUser.name}</span>\n                <ChevronDown className=\"h-4 w-4\" />\n              </Button>\n            </DropdownMenuTrigger>\n            <DropdownMenuContent align=\"end\">\n              <DropdownMenuItem disabled>\n                <div className=\"flex flex-col\">\n                  <span className=\"font-medium\">{currentUser.name}</span>\n                  <span className=\"text-xs text-gray-500\">{currentUser.role}</span>\n                </div>\n              </DropdownMenuItem>\n            </DropdownMenuContent>\n          </DropdownMenu>\n        </div>\n      )}\n\n      {/* Fixed Left Sidebar - Hidden on mobile */}\n      <aside className={`sidebar ${isMobile ? 'hidden' : ''}`}>\n        {/* Logo/Header */}\n        <div className=\"p-6 border-b border-[#2D8028]\">\n          <h1 className=\"text-xl font-bold text-white\">üå± Grow Space</h1>\n        </div>\n\n        {/* Navigation */}\n        <nav className=\"flex-1 py-6\">\n          <div className=\"space-y-2 px-4\">\n            {navigationItems.map((item) => (\n              <Link\n                key={item.href}\n                href={item.href}\n                className={`flex items-center px-4 py-3 rounded-lg font-medium transition-colors ${\n                  isActive(item.href)\n                    ? \"bg-[#2D8028] text-white\"\n                    : \"text-gray-300 hover:text-white hover:bg-[#2D8028]/50\"\n                }`}\n              >\n                <span className=\"mr-3\">{item.icon}</span>\n                {item.label}\n              </Link>\n            ))}\n            \n            {/* Manager-only items */}\n            {isManager && (\n              <>\n                <div className=\"border-t border-[#2D8028] my-4\"></div>\n                {managerItems.map((item) => (\n                  <div key={item.href} className=\"relative\">\n                    {item.enabled ? (\n                      <Link\n                        href={item.href}\n                        className={`flex items-center px-4 py-3 rounded-lg font-medium transition-colors ${\n                          isActive(item.href)\n                            ? \"bg-[#2D8028] text-white\"\n                            : \"text-gray-300 hover:text-white hover:bg-[#2D8028]/50\"\n                        }`}\n                      >\n                        <span className=\"mr-3\">{item.icon}</span>\n                        {item.label}\n                      </Link>\n                    ) : (\n                      <div \n                        className=\"flex items-center px-4 py-3 rounded-lg font-medium text-gray-500 cursor-not-allowed opacity-60 relative group\"\n                        title=\"Coming Soon\"\n                      >\n                        <span className=\"mr-3\">{item.icon}</span>\n                        {item.label}\n                        <span className=\"ml-auto text-xs bg-gray-200 text-gray-600 px-2 py-1 rounded-full\">Soon</span>\n                        {/* Tooltip */}\n                        <div className=\"absolute left-full ml-2 top-1/2 transform -translate-y-1/2 bg-gray-800 text-white text-sm px-2 py-1 rounded whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity z-50\">\n                          Coming Soon\n                        </div>\n                      </div>\n                    )}\n                  </div>\n                ))}\n              </>\n            )}\n          </div>\n        </nav>\n\n        {/* Bottom Section */}\n        <div className=\"p-4 border-t border-[#2D8028]\">\n          {/* Simple Location Display */}\n          <div className=\"flex items-center text-gray-300 mb-4\">\n            <MapPin className=\"h-4 w-4 mr-2\" />\n            <span className=\"text-sm\">{currentLocation.name}</span>\n          </div>\n\n          {/* Logout Button */}\n          <div className=\"w-full\">\n            <LogoutButton />\n          </div>\n        </div>\n      </aside>\n\n      {/* Main Content Area */}\n      <div className=\"main-content\">\n        {/* Top Header - Hidden on mobile */}\n        {!isMobile && (\n          <header className=\"app-header\">\n            {/* Left side - Just the page title with emoji */}\n            <div className=\"header-left\">\n              {(() => {\n                const pageTitle: { [key: string]: string } = {\n                  '/': 'üìã Tasks',\n                  '/account': 'üë§ Account',\n                  '/inventory': 'üì¶ Inventory',\n                  '/education': 'üéì Education',\n                  '/recurring-tasks': 'üîÑ Recurring Tasks',\n                  '/task-data': 'üìä Task Data',\n                  '/staff-data': 'üë• Staff Data',\n                  '/production-data': 'üå± Production Data'\n                };\n                \n                return (\n                  <div className=\"page-title\">\n                    {pageTitle[location] || 'üìã Tasks'}\n                  </div>\n                );\n              })()}\n            </div>\n            \n            {/* Right side - Location dropdown, notifications, and user info */}\n            <div className=\"header-right\">\n              {/* Simple Location Display */}\n              <div className=\"flex items-center text-gray-600 mr-4\">\n                <MapPin className=\"h-4 w-4 mr-1\" />\n                <span className=\"text-sm\">{currentLocation.name}</span>\n              </div>\n              \n              {/* Notification Bell */}\n              <div className=\"relative\">\n                <Button\n                  variant=\"ghost\"\n                  size=\"sm\"\n                  onClick={toggleNotifications}\n                  className=\"relative p-2 hover:bg-gray-100 rounded-full\"\n                >\n                  <Bell className=\"h-5 w-5 text-gray-600\" />\n                  {unreadCount > 0 && (\n                    <Badge\n                      variant=\"destructive\"\n                      className=\"absolute -top-1 -right-1 h-5 w-5 flex items-center justify-center p-0 text-xs\"\n                    >\n                      {unreadCount > 99 ? '99+' : unreadCount}\n                    </Badge>\n                  )}\n                </Button>\n                \n                {showNotifications && (\n                  <NotificationDropdown\n                    notifications={notifications}\n                    onClose={() => setShowNotifications(false)}\n                  />\n                )}\n              </div>\n              \n              <div className=\"user-info\">\n                <User size={14} />\n                <span className=\"user-name\">Welcome, {currentUser?.name}</span>\n              </div>\n            </div>\n          </header>\n        )}\n\n        {/* Main Content */}\n        <main className={`${isMobile ? 'pt-20 pb-20' : ''}`}>\n          {children}\n        </main>\n      </div>\n\n      {/* Bottom Navigation - Only visible on mobile */}\n      {isMobile && (\n        <nav className=\"fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 z-50 h-16\">\n          <div className=\"flex justify-around items-center h-full\">\n            {navigationItems.slice(0, 4).map((item) => {\n              const IconComponent = item.lucideIcon;\n              return (\n                <Link\n                  key={item.href}\n                  href={item.href}\n                  className={`flex flex-col items-center justify-center min-h-[44px] px-3 ${\n                    isActive(item.href) ? \"text-[#2D8028]\" : \"text-gray-600\"\n                  }`}\n                >\n                  <IconComponent className=\"h-5 w-5\" />\n                  <span className=\"text-xs mt-1\">{item.label}</span>\n                </Link>\n              );\n            })}\n          </div>\n        </nav>\n      )}\n    </div>\n  );\n};\n\nexport default Layout;\n","path":null,"size_bytes":11450,"size_tokens":null},"client/src/services/teamsAuthService.ts":{"content":"import * as microsoftTeams from \"@microsoft/teams-js\";\nimport { AccountInfo } from \"@azure/msal-browser\";\nimport { debugLog, detectIOSEnvironment } from '../config/authConfig';\n\nexport interface TeamsContext {\n  user?: {\n    userPrincipalName: string;\n    displayName: string;\n    id: string; // Changed from objectId to id to match Teams SDK\n  };\n  app?: {\n    host: {\n      name: string;\n    };\n  };\n  page?: {\n    id: string;\n    frameContext: string;\n  };\n}\n\nexport interface TeamsAuthResult {\n  isInTeams: boolean;\n  context: TeamsContext | null;\n  account: AccountInfo | null;\n  error?: string;\n}\n\nclass TeamsAuthService {\n  private isInitialized = false;\n  private teamsContext: TeamsContext | null = null;\n\n  async initialize(): Promise<TeamsAuthResult> {\n    const { isIOS, isTeamsApp } = detectIOSEnvironment();\n    debugLog('Teams initialization started', { isIOS, isTeamsApp });\n    \n    try {\n      // Check if we're in an iframe (likely Teams)\n      const isInIframe = window.parent !== window.self;\n      debugLog('Environment check', { isInIframe, isIOS, isTeamsApp });\n      \n      if (!isInIframe && !isTeamsApp) {\n        debugLog('Not in Teams environment');\n        return {\n          isInTeams: false,\n          context: null,\n          account: null\n        };\n      }\n\n      // iOS-specific Teams initialization with timeout\n      if (isIOS) {\n        debugLog('Initializing Teams SDK for iOS with extended timeout');\n        return await this.initializeTeamsForIOS();\n      }\n\n      // Standard Teams initialization\n      debugLog('Initializing Teams SDK (standard)');\n      await microsoftTeams.app.initialize();\n      \n      // Get Teams context\n      const context = await microsoftTeams.app.getContext();\n      debugLog('Teams context obtained', {\n        hasUser: !!context.user,\n        userPrincipalName: context.user?.userPrincipalName,\n        displayName: context.user?.displayName\n      });\n      \n      // Convert to our interface format\n      const teamsContext: TeamsContext = {\n        user: context.user ? {\n          userPrincipalName: context.user.userPrincipalName || '',\n          displayName: context.user.displayName || '',\n          id: context.user.id || ''\n        } : undefined,\n        app: context.app,\n        page: context.page\n      };\n      \n      this.teamsContext = teamsContext;\n      this.isInitialized = true;\n\n      // Create a mock account object compatible with MSAL\n      const account: AccountInfo = {\n        homeAccountId: context.user?.id || '',\n        localAccountId: context.user?.id || '',\n        environment: 'login.microsoftonline.com',\n        tenantId: '', // Teams context doesn't provide tenant info directly\n        username: context.user?.userPrincipalName || '',\n        name: context.user?.displayName || '',\n        authorityType: 'MSSTS',\n        tenantProfiles: new Map(),\n        idToken: '',\n        idTokenClaims: {},\n        nativeAccountId: ''\n      };\n\n      debugLog('Teams account created', {\n        username: account.username,\n        name: account.name\n      });\n\n      return {\n        isInTeams: true,\n        context: teamsContext,\n        account,\n      };\n      \n    } catch (error) {\n      debugLog('Teams initialization failed', {\n        error: (error as Error).message,\n        isIOS,\n        isTeamsApp\n      });\n      console.log(\"Teams initialization failed (not in Teams or error):\", error);\n      return {\n        isInTeams: false,\n        context: null,\n        account: null,\n        error: error instanceof Error ? error.message : 'Unknown error'\n      };\n    }\n  }\n  \n  // iOS-specific Teams initialization with proper timeout handling\n  private async initializeTeamsForIOS(): Promise<TeamsAuthResult> {\n    debugLog('iOS Teams initialization started');\n    \n    return new Promise((resolve, reject) => {\n      const timeout = setTimeout(() => {\n        debugLog('iOS Teams initialization timeout');\n        resolve({\n          isInTeams: false,\n          context: null,\n          account: null,\n          error: 'Teams initialization timeout on iOS'\n        });\n      }, 10000); // 10 second timeout for iOS\n      \n      microsoftTeams.app.initialize().then(() => {\n        debugLog('iOS Teams SDK initialized successfully');\n        \n        const contextTimeout = setTimeout(() => {\n          debugLog('iOS Teams context timeout');\n          clearTimeout(timeout);\n          resolve({\n            isInTeams: false,\n            context: null, \n            account: null,\n            error: 'Teams context timeout on iOS'\n          });\n        }, 5000);\n        \n        microsoftTeams.app.getContext().then((context) => {\n          clearTimeout(timeout);\n          clearTimeout(contextTimeout);\n          \n          debugLog('iOS Teams context received', {\n            hasUser: !!context.user,\n            userPrincipalName: context.user?.userPrincipalName\n          });\n          \n          const teamsContext: TeamsContext = {\n            user: context.user ? {\n              userPrincipalName: context.user.userPrincipalName || '',\n              displayName: context.user.displayName || '',\n              id: context.user.id || ''\n            } : undefined,\n            app: context.app,\n            page: context.page\n          };\n          \n          this.teamsContext = teamsContext;\n          this.isInitialized = true;\n          \n          const account: AccountInfo = {\n            homeAccountId: context.user?.id || '',\n            localAccountId: context.user?.id || '',\n            environment: 'login.microsoftonline.com',\n            tenantId: '',\n            username: context.user?.userPrincipalName || '',\n            name: context.user?.displayName || '',\n            authorityType: 'MSSTS',\n            tenantProfiles: new Map(),\n            idToken: '',\n            idTokenClaims: {},\n            nativeAccountId: ''\n          };\n          \n          resolve({\n            isInTeams: true,\n            context: teamsContext,\n            account\n          });\n        }).catch((error) => {\n          clearTimeout(timeout);\n          clearTimeout(contextTimeout);\n          debugLog('iOS Teams context failed', { error: (error as Error).message });\n          resolve({\n            isInTeams: false,\n            context: null,\n            account: null,\n            error: (error as Error).message\n          });\n        });\n      }).catch((error) => {\n        clearTimeout(timeout);\n        debugLog('iOS Teams SDK initialization failed', { error: (error as Error).message });\n        resolve({\n          isInTeams: false,\n          context: null,\n          account: null,\n          error: (error as Error).message\n        });\n      });\n    });\n  }\n\n  async getAuthToken(): Promise<string | null> {\n    if (!this.isInitialized) {\n      throw new Error(\"Teams SDK not initialized\");\n    }\n\n    return new Promise((resolve, reject) => {\n      const authTokenRequest = {\n        successCallback: (token: string) => {\n          console.log(\"Got auth token from Teams\");\n          resolve(token);\n        },\n        failureCallback: (error: string) => {\n          console.error(\"Failed to get auth token from Teams:\", error);\n          reject(new Error(error));\n        }\n      };\n\n      try {\n        microsoftTeams.authentication.getAuthToken(authTokenRequest);\n      } catch (error) {\n        reject(error);\n      }\n    });\n  }\n\n  getTeamsContext(): TeamsContext | null {\n    return this.teamsContext;\n  }\n\n  isTeamsEnvironment(): boolean {\n    return this.isInitialized && this.teamsContext !== null;\n  }\n\n  // Notify Teams about authentication state changes\n  notifySuccess() {\n    if (this.isInitialized) {\n      try {\n        microsoftTeams.authentication.notifySuccess();\n      } catch (error) {\n        console.error(\"Failed to notify Teams of success:\", error);\n      }\n    }\n  }\n\n  notifyFailure(reason?: string) {\n    if (this.isInitialized) {\n      try {\n        microsoftTeams.authentication.notifyFailure(reason || \"Authentication failed\");\n      } catch (error) {\n        console.error(\"Failed to notify Teams of failure:\", error);\n      }\n    }\n  }\n}\n\nexport const teamsAuthService = new TeamsAuthService();","path":null,"size_bytes":8155,"size_tokens":null},"server/routes.ts":{"content":"import type { Express } from \"express\";\nimport { createServer, type Server } from \"http\";\nimport { storage } from \"./storage\";\nimport { db } from \"./db\";\nimport { sql } from \"drizzle-orm\";\nimport { insertUserSchema, insertTaskSchema, insertInventoryItemSchema, insertTrainingModuleSchema, insertUserProgressSchema, insertTaskLogSchema, insertCourseAssignmentSchema, insertNotificationSchema } from \"@shared/schema\";\nimport path from \"path\";\nimport fs from \"fs\";\n\nexport async function registerRoutes(app: Express): Promise<Server> {\n  // Authentication routes\n  app.post(\"/api/auth/login\", async (req, res) => {\n    try {\n      const { username, password } = req.body;\n      const user = await storage.getUserByUsername(username);\n      \n      if (!user || user.password !== password) {\n        return res.status(401).json({ message: \"Invalid credentials\" });\n      }\n\n      if (!user.approved) {\n        return res.status(403).json({ message: \"Account pending approval\" });\n      }\n\n      // In a real app, you'd set up proper session management\n      res.json({ user: { ...user, password: undefined } });\n    } catch (error) {\n      res.status(500).json({ message: \"Login failed\" });\n    }\n  });\n\n  app.post(\"/api/auth/register\", async (req, res) => {\n    try {\n      const userData = insertUserSchema.parse(req.body);\n      const existingUser = await storage.getUserByUsername(userData.username);\n      \n      if (existingUser) {\n        return res.status(400).json({ message: \"Username already exists\" });\n      }\n\n      const user = await storage.createUser(userData);\n      res.json({ user: { ...user, password: undefined } });\n    } catch (error) {\n      res.status(400).json({ message: \"Registration failed\" });\n    }\n  });\n\n  // Development login endpoint - bypasses Microsoft authentication\n  app.post(\"/api/auth/dev-login\", async (req, res) => {\n    try {\n      const { email } = req.body;\n      \n      if (!email) {\n        return res.status(400).json({ message: \"Email is required\" });\n      }\n      \n      // Find user by email in the staff system\n      const users = await storage.getAllUsers();\n      const user = users.find(u => \n        (u.username?.toLowerCase() === email.toLowerCase()) || \n        (u.businessEmail?.toLowerCase() === email.toLowerCase())\n      );\n      \n      if (!user) {\n        return res.status(404).json({ message: \"User not found\" });\n      }\n\n      if (!user.approved) {\n        return res.status(403).json({ message: \"Account pending approval\" });\n      }\n\n      // Create auth response compatible with Microsoft login\n      const authUser = {\n        id: user.id,\n        name: user.name || 'User',\n        username: user.businessEmail || user.username,\n        businessEmail: user.businessEmail || user.username,\n        role: user.role || 'General Staff'\n      };\n\n      res.json({ \n        user: authUser,\n        message: \"Development login successful\"\n      });\n    } catch (error) {\n      console.error('Dev login error:', error);\n      res.status(500).json({ message: \"Development login failed\" });\n    }\n  });\n\n  // Staff routes (dedicated endpoints for staff management)\n  app.get(\"/api/staff\", async (req, res) => {\n    try {\n      const users = await storage.getAllUsers();\n      // Filter out deleted users before transforming\n      const activeUsers = users.filter(user => !user.name?.startsWith('[DELETED]'));\n      // Transform active users to staff format for frontend compatibility\n      const staff = activeUsers.map(user => ({\n        id: user.id.toString(),\n        fullName: user.name || 'Unknown User',\n        email: user.username,\n        phone: user.businessPhone || user.mobilePhone || user.homePhone || '',\n        location: user.location || 'Kenosha',\n        rolesAssigned: user.role ? user.role.split(',').map(r => r.trim()) : ['General Staff'],\n        dateHired: user.createdAt ? new Date(user.createdAt).toISOString().split('T')[0] : new Date().toISOString().split('T')[0],\n        payType: user.payType || 'hourly',\n        payRate: user.payRate || 16.00,\n        businessEmail: user.businessEmail || user.username,\n        personalEmail: user.personalEmail,\n        homePhone: user.homePhone,\n        businessPhone: user.businessPhone,\n        mobilePhone: user.mobilePhone,\n        emergencyContactName: user.emergencyContactName,\n        emergencyRelationship: user.emergencyRelationship,\n        emergencyPhone: user.emergencyPhone,\n        trainingCompleted: [],\n        trainingInProgress: [],\n        preferredHours: 'Flexible',\n        activeStatus: user.approved ? 'Active' : 'Pending',\n        lastTaskCompleted: '',\n        managerNotes: user.role?.includes('Corporate') ? 'Corporate Manager' : 'Staff Member',\n        tasksCompleted: 0,\n        avgTaskDuration: '0m',\n        onTimeRate: 100,\n        microsoftId: user.id.toString(),\n        lastActive: user.lastActive ? new Date(user.lastActive).toISOString() : null,\n        password: undefined\n      }));\n      \n      console.log(`Returning ${staff.length} staff members from ${activeUsers.length} active users (${users.length} total users)`);\n      res.json(staff);\n    } catch (error) {\n      console.error('Staff fetch error:', error);\n      res.status(500).json({ message: \"Failed to fetch staff\" });\n    }\n  });\n\n  app.post(\"/api/staff\", async (req, res) => {\n    try {\n      const staffData = req.body;\n      \n      // Check if user already exists by email to prevent duplicates\n      const existingUser = await storage.getUserByUsername(staffData.email);\n      if (existingUser) {\n        // Return existing user as staff format\n        const existingStaff = {\n          id: existingUser.id.toString(),\n          fullName: existingUser.name,\n          email: existingUser.username,\n          phone: existingUser.businessPhone || existingUser.mobilePhone || existingUser.homePhone || '',\n          location: existingUser.location || 'Kenosha',\n          rolesAssigned: existingUser.role ? existingUser.role.split(',').map(r => r.trim()) : ['General Staff'],\n          dateHired: existingUser.createdAt ? new Date(existingUser.createdAt).toISOString().split('T')[0] : new Date().toISOString().split('T')[0],\n          payType: existingUser.payType || 'hourly',\n          payRate: existingUser.payRate || 16.00,\n          businessEmail: existingUser.businessEmail || existingUser.username,\n          personalEmail: existingUser.personalEmail,\n          homePhone: existingUser.homePhone,\n          businessPhone: existingUser.businessPhone,\n          mobilePhone: existingUser.mobilePhone,\n          emergencyContactName: existingUser.emergencyContactName,\n          emergencyRelationship: existingUser.emergencyRelationship,\n          emergencyPhone: existingUser.emergencyPhone,\n          trainingCompleted: [],\n          trainingInProgress: [],\n          preferredHours: 'Flexible',\n          activeStatus: existingUser.approved ? 'Active' : 'Pending',\n          lastTaskCompleted: '',\n          managerNotes: 'Updated from Microsoft login',\n          tasksCompleted: 0,\n          avgTaskDuration: '0m',\n          onTimeRate: 100,\n          microsoftId: existingUser.id.toString(),\n          lastActive: existingUser.lastActive ? new Date(existingUser.lastActive).toISOString() : null\n        };\n        return res.json(existingStaff);\n      }\n      \n      // Convert staff format to user format\n      const userData = {\n        username: staffData.email,\n        password: 'temp-password', // Will be set via Microsoft auth\n        name: staffData.fullName,\n        role: Array.isArray(staffData.rolesAssigned) ? staffData.rolesAssigned.join(', ') : 'technician',\n        approved: staffData.activeStatus === 'Active',\n        location: staffData.location || 'Kenosha',\n        payType: staffData.payType || 'hourly',\n        payRate: staffData.payRate || 16.00,\n        businessEmail: staffData.businessEmail || staffData.email,\n        personalEmail: staffData.personalEmail,\n        homePhone: staffData.homePhone,\n        businessPhone: staffData.businessPhone || staffData.phone,\n        mobilePhone: staffData.mobilePhone || staffData.phone,\n        emergencyContactName: staffData.emergencyContactName,\n        emergencyRelationship: staffData.emergencyRelationship,\n        emergencyPhone: staffData.emergencyPhone,\n        lastActive: new Date() // Set last active on first creation\n      };\n      const user = await storage.createUser(userData);\n      res.json({ ...staffData, id: user.id.toString() });\n    } catch (error) {\n      console.error('Staff creation error:', error);\n      res.status(500).json({ message: \"Failed to create staff member\" });\n    }\n  });\n\n  app.put(\"/api/staff/:id\", async (req, res) => {\n    try {\n      const id = req.params.id;\n      const staffData = req.body;\n      \n      // Check if user exists first by string ID (Microsoft ID format)\n      const existingUser = await storage.getUserByUsername(staffData.email);\n      \n      if (!existingUser) {\n        // If user doesn't exist, create them instead\n        const userData = {\n          username: staffData.email,\n          password: 'temp-password', // Will be set via Microsoft auth\n          name: staffData.fullName,\n          role: Array.isArray(staffData.rolesAssigned) ? staffData.rolesAssigned.join(', ') : 'technician',\n          approved: staffData.activeStatus === 'Active',\n          location: staffData.location || 'Kenosha',\n          payType: staffData.payType || 'hourly',\n          payRate: staffData.payRate || 16.00,\n          businessEmail: staffData.businessEmail || staffData.email,\n          personalEmail: staffData.personalEmail,\n          homePhone: staffData.homePhone,\n          businessPhone: staffData.businessPhone || staffData.phone,\n          mobilePhone: staffData.mobilePhone || staffData.phone,\n          emergencyContactName: staffData.emergencyContactName,\n          emergencyRelationship: staffData.emergencyRelationship,\n          emergencyPhone: staffData.emergencyPhone\n        };\n        const newUser = await storage.createUser(userData);\n        return res.json({ ...staffData, id: newUser.id.toString() });\n      }\n      \n      // Update existing user with complete staff data\n      const updates = {\n        name: staffData.fullName,\n        role: Array.isArray(staffData.rolesAssigned) ? staffData.rolesAssigned.join(', ') : staffData.rolesAssigned,\n        approved: staffData.activeStatus === 'Active',\n        location: staffData.location || 'Kenosha',\n        payType: staffData.payType || 'hourly',\n        payRate: staffData.payRate || 16.00,\n        businessEmail: staffData.businessEmail || staffData.email,\n        personalEmail: staffData.personalEmail,\n        homePhone: staffData.homePhone,\n        businessPhone: staffData.businessPhone || staffData.phone,\n        mobilePhone: staffData.mobilePhone || staffData.phone,\n        emergencyContactName: staffData.emergencyContactName,\n        emergencyRelationship: staffData.emergencyRelationship,\n        emergencyPhone: staffData.emergencyPhone\n      };\n      const user = await storage.updateUser(existingUser.id, updates);\n      if (!user) {\n        return res.status(404).json({ message: \"Staff member not found\" });\n      }\n      res.json(staffData);\n    } catch (error) {\n      console.error('Staff update error:', error);\n      res.status(500).json({ message: \"Failed to update staff member\" });\n    }\n  });\n\n  app.delete(\"/api/staff/:id\", async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const user = await storage.getUser(id);\n      \n      if (!user) {\n        return res.status(404).json({ message: \"Staff member not found\" });\n      }\n      \n      // Check for active tasks assigned to this staff member\n      const tasks = await storage.getAllTasks();\n      const activeTasks = tasks.filter(task => \n        task.assignedTo === id && \n        task.status !== 'completed' && \n        task.status !== 'cancelled'\n      );\n      \n      if (activeTasks.length > 0) {\n        return res.status(400).json({ \n          message: \"Cannot delete staff member with active tasks\",\n          activeTasks: true,\n          activeTaskCount: activeTasks.length\n        });\n      }\n      \n      // Check for recurring tasks that might be assigned to this user's roles\n      const recurringTasks = await storage.getAllRecurringTasks();\n      const userRoles = user.role ? user.role.split(',').map((r: string) => r.trim()) : [];\n      // Note: recurring tasks don't have assignedRoles field in current schema\n      const recurringTasksAssigned = recurringTasks.filter(rt => \n        // For now, assume all recurring tasks could be affected\n        rt.isActive\n      );\n      \n      // Log deletion for audit purposes\n      console.log(`Attempting to delete staff member: ${user.name} (ID: ${id})`);\n      console.log(`User roles: ${userRoles.join(', ')}`);\n      console.log(`Active tasks: ${activeTasks.length}`);\n      console.log(`Recurring tasks potentially affected: ${recurringTasksAssigned.length}`);\n      \n      // Perform soft delete by marking as inactive and removing roles\n      const updatedUser = await storage.updateUser(id, { \n        approved: false,\n        role: 'inactive',\n        name: `[DELETED] ${user.name}`\n      });\n      \n      console.log(`Staff member soft deleted: ${user.name} (ID: ${id})`);\n      \n      res.json({ \n        success: true, \n        deleted: {\n          id: user.id,\n          name: user.name,\n          username: user.username\n        },\n        softDelete: true,\n        message: \"Staff member has been deactivated and removed from assignments\"\n      });\n    } catch (error) {\n      console.error('Staff deletion error:', error);\n      res.status(500).json({ message: \"Failed to delete staff member\" });\n    }\n  });\n\n  // Activity tracking endpoint\n  app.post(\"/api/users/:id/activity\", async (req, res) => {\n    try {\n      const userId = parseInt(req.params.id);\n      const user = await storage.updateUser(userId, { lastActive: new Date() });\n      if (user) {\n        res.json({ message: \"Activity updated\", lastActive: user.lastActive });\n      } else {\n        res.status(404).json({ message: \"User not found\" });\n      }\n    } catch (error) {\n      console.error('Activity update error:', error);\n      res.status(500).json({ message: \"Failed to update activity\" });\n    }\n  });\n\n  // User routes (keeping existing functionality)\n  app.get(\"/api/users\", async (req, res) => {\n    try {\n      const users = await storage.getAllUsers();\n      res.json(users.map(user => ({ ...user, password: undefined })));\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to fetch users\" });\n    }\n  });\n\n  app.post(\"/api/users\", async (req, res) => {\n    try {\n      const userData = req.body;\n      const user = await storage.createUser(userData);\n      res.json({ ...user, password: undefined });\n    } catch (error) {\n      console.error('User creation error:', error);\n      res.status(500).json({ message: \"Failed to create user\" });\n    }\n  });\n\n  app.patch(\"/api/users/:id\", async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const updates = req.body;\n      const user = await storage.updateUser(id, updates);\n      \n      if (!user) {\n        return res.status(404).json({ message: \"User not found\" });\n      }\n\n      res.json({ ...user, password: undefined });\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to update user\" });\n    }\n  });\n\n  // Task routes\n  app.get(\"/api/tasks\", async (req, res) => {\n    // AUTOMATIC TRIGGER: Run generation when viewing tasks (background, non-blocking)\n    runAutomatedTaskGeneration().catch(err => \n      console.error('Background generation failed:', err)\n    );\n    \n    try {\n      const { userId, location } = req.query;\n      console.log(`üîç /api/tasks called with userId: ${userId}, location: \"${location}\"`);\n      let tasks;\n      \n      if (location) {\n        // Normalize and sanitize location input\n        const rawLocation = String(location);\n        const cleanedLocation = rawLocation.trim().replace(/^['\"]|['\"]$/g, '');\n        const upperLocation = cleanedLocation.toUpperCase();\n        \n        // Map short location codes to full names for backwards compatibility  \n        const locationMap: { [key: string]: string } = {\n          'K': 'Kenosha'\n        };\n        const actualLocation = locationMap[upperLocation] || cleanedLocation;\n        \n        console.log(`üîç Using location filtering for: \"${cleanedLocation}\" ‚Üí \"${actualLocation}\"`);\n        tasks = await storage.getTasksByLocation(actualLocation);\n        \n        // Defensive retry if mapping exists but got 0 results\n        if (tasks.length === 0 && locationMap[upperLocation] && actualLocation !== cleanedLocation) {\n          console.log(`üîç Retrying with mapped location: \"${actualLocation}\"`);\n          tasks = await storage.getTasksByLocation(actualLocation);\n        }\n      } else if (userId) {\n        console.log(`üîç Using user filtering for userId: ${userId}`);\n        tasks = await storage.getTasksByUser(parseInt(userId as string));\n      } else {\n        console.log(`üîç Using getAllTasks() - no filters`);\n        tasks = await storage.getAllTasks();\n      }\n      \n      console.log(`üîç Retrieved ${tasks.length} tasks from storage`);\n      if (tasks.length > 0) {\n        console.log(`üîç First task: \"${tasks[0].title}\" (location: \"${tasks[0].location}\", dueDate: ${tasks[0].dueDate})`);\n      }\n      \n      // Transform tasks to include explicit visibleFromDate for client filtering\n      const transformedTasks = tasks.map(task => {\n        const dueDate = task.dueDate ? new Date(task.dueDate) : new Date();\n        let visibleFromDate = null;\n        \n        // For biweekly/period tasks, calculate visibleFromDate (13 days before dueDate)\n        if (task.frequency === 'biweekly' || (task.frequency && task.frequency.toLowerCase().includes('biweekly'))) {\n          visibleFromDate = new Date(dueDate);\n          visibleFromDate.setDate(visibleFromDate.getDate() - 13);\n        }\n        \n        return {\n          ...task,\n          // Serialize dates as YYYY-MM-DD for consistent client parsing\n          taskDate: task.taskDate ? new Date(task.taskDate).toISOString().split('T')[0] : null,\n          dueDate: dueDate.toISOString().split('T')[0],\n          visibleFromDate: visibleFromDate ? visibleFromDate.toISOString().split('T')[0] : null\n        };\n      });\n      \n      // Log first 5 tasks for debugging\n      console.log('üìã Transformed tasks sample:');\n      transformedTasks.slice(0, 5).forEach(task => {\n        console.log(`  ${task.id}: \"${task.title}\" | taskDate: ${task.taskDate} | dueDate: ${task.dueDate} | visibleFromDate: ${task.visibleFromDate}`);\n      });\n      \n      res.json(transformedTasks);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to fetch tasks\" });\n    }\n  });\n\n  app.get(\"/api/tasks/:id\", async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const task = await storage.getTask(id);\n      \n      if (!task) {\n        return res.status(404).json({ message: \"Task not found\" });\n      }\n      \n      res.json(task);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to fetch task\" });\n    }\n  });\n\n  app.post(\"/api/tasks\", async (req, res) => {\n    try {\n      console.log(\"Creating task with data:\", req.body);\n      \n      // UTC-aware date parsing helper to prevent timezone issues\n      const parseUTCDate = (dateString: string): Date => {\n        if (!dateString) return new Date();\n        \n        // If it's already an ISO string, use it directly\n        if (dateString.includes('T') || dateString.includes('Z')) {\n          return new Date(dateString);\n        }\n        \n        // For YYYY-MM-DD format, explicitly create UTC date to avoid timezone shifts\n        const [year, month, day] = dateString.split('-').map(Number);\n        return new Date(Date.UTC(year, month - 1, day, 12, 0, 0)); // Use noon UTC to avoid edge cases\n      };\n\n      // Location mapping helper to ensure consistency with API filtering\n      const mapLocation = (location: string): string => {\n        if (!location) return location;\n        const cleanedLocation = location.trim();\n        const upperLocation = cleanedLocation.toUpperCase();\n        \n        // Map short location codes to full names for backwards compatibility  \n        const locationMap: { [key: string]: string } = {\n          'K': 'Kenosha'\n        };\n        return locationMap[upperLocation] || cleanedLocation;\n      };\n\n      // Convert date string to Date object before validation\n      const processedBody = {\n        ...req.body,\n        dueDate: req.body.dueDate ? parseUTCDate(req.body.dueDate) : undefined,\n        startedAt: req.body.startedAt ? parseUTCDate(req.body.startedAt) : undefined,\n        completedAt: req.body.completedAt ? parseUTCDate(req.body.completedAt) : undefined,\n        pausedAt: req.body.pausedAt ? parseUTCDate(req.body.pausedAt) : undefined,\n        resumedAt: req.body.resumedAt ? parseUTCDate(req.body.resumedAt) : undefined,\n        skippedAt: req.body.skippedAt ? parseUTCDate(req.body.skippedAt) : undefined,\n        // CRITICAL FIX: Ensure taskDate is set - use visibleFromDate or dueDate as fallback\n        taskDate: req.body.taskDate ? parseUTCDate(req.body.taskDate) : \n                  req.body.visibleFromDate ? parseUTCDate(req.body.visibleFromDate) :\n                  req.body.dueDate ? parseUTCDate(req.body.dueDate) : undefined,\n        // LOCATION MAPPING FIX: Apply same location mapping as API filtering to ensure consistency\n        location: req.body.location ? mapLocation(req.body.location) : req.body.location,\n      };\n      \n      const taskData = insertTaskSchema.parse(processedBody);\n      console.log(\"Parsed task data:\", taskData);\n      const task = await storage.createTask(taskData);\n      console.log(\"Created task:\", task);\n      res.json(task);\n    } catch (error) {\n      console.error(\"Create task error:\", error);\n      console.error(\"Request body:\", req.body);\n      res.status(400).json({ message: \"Failed to create task\", error: error instanceof Error ? error.message : String(error) });\n    }\n  });\n\n  app.patch(\"/api/tasks/:id\", async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const updates = req.body;\n      console.log(\"Updating task:\", id, \"with updates:\", updates);\n      \n      // Convert date strings to Date objects for Drizzle ORM\n      if (updates.skippedAt && typeof updates.skippedAt === 'string') {\n        updates.skippedAt = new Date(updates.skippedAt);\n      }\n      if (updates.completedAt && typeof updates.completedAt === 'string') {\n        updates.completedAt = new Date(updates.completedAt);\n      }\n      if (updates.startedAt && typeof updates.startedAt === 'string') {\n        updates.startedAt = new Date(updates.startedAt);\n      }\n      if (updates.pausedAt && typeof updates.pausedAt === 'string') {\n        updates.pausedAt = new Date(updates.pausedAt);\n      }\n      \n      // Run verification when a task is started (status changes to in_progress)\n      if (updates.status === 'in_progress') {\n        console.log(\"üîç Task being started - running verification system...\");\n        try {\n          const verificationResult = await storage.verifyTaskIntegrity();\n          console.log(\"‚úÖ Verification complete:\", verificationResult);\n          \n          // Store verification result for dev page reporting\n          (global as any).lastVerificationResult = {\n            ...verificationResult,\n            timestamp: new Date(),\n            triggeredBy: 'task_start',\n            taskId: id\n          };\n        } catch (verifyError) {\n          console.error(\"‚ö†Ô∏è Verification failed:\", verifyError);\n          // Don't fail the task start if verification fails\n        }\n      }\n      \n      const task = await storage.updateTask(id, updates);\n      \n      if (!task) {\n        console.log(\"Task not found:\", id);\n        return res.status(404).json({ message: \"Task not found\" });\n      }\n\n      console.log(\"Task updated successfully:\", task);\n      res.json(task);\n    } catch (error) {\n      console.error(\"Error updating task:\", error);\n      res.status(500).json({ message: \"Failed to update task\", error: error instanceof Error ? error.message : String(error) });\n    }\n  });\n\n  app.delete(\"/api/tasks/:id\", async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const success = await storage.deleteTask(id);\n      \n      if (!success) {\n        return res.status(404).json({ message: \"Task not found\" });\n      }\n\n      res.json({ message: \"Task deleted successfully\" });\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to delete task\" });\n    }\n  });\n\n  app.post(\"/api/tasks/reset\", async (req, res) => {\n    try {\n      const success = await storage.resetTasks();\n      \n      if (!success) {\n        return res.status(500).json({ message: \"Failed to reset tasks\" });\n      }\n\n      res.json({ message: \"Tasks reset successfully\" });\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to reset tasks\" });\n    }\n  });\n\n  // Remove duplicate tasks endpoint\n  app.post(\"/api/tasks/remove-duplicates\", async (req, res) => {\n    try {\n      console.log(\"=== STARTING DUPLICATE REMOVAL ===\");\n      \n      // Get all tasks from database\n      const allTasks = await storage.getAllTasks();\n      console.log(`Found ${allTasks.length} total tasks`);\n      \n      if (allTasks.length === 0) {\n        return res.json({ \n          totalTasks: 0, \n          duplicatesRemoved: 0, \n          finalCount: 0,\n          message: \"No tasks to process\" \n        });\n      }\n      \n      // Group tasks by unique key to find duplicates\n      const taskGroups = new Map<string, typeof allTasks>();\n      \n      allTasks.forEach(task => {\n        // Create composite key for duplicate detection\n        // Normalize values to handle null/undefined consistently\n        const title = (task.title || '').trim();\n        const taskDate = task.taskDate ? new Date(task.taskDate).toISOString().split('T')[0] : 'none';\n        const location = (task.location || 'none').trim();\n        const recurringTaskId = task.recurringTaskId?.toString() || 'none';\n        \n        const key = `${title}|${taskDate}|${location}|${recurringTaskId}`;\n        \n        if (!taskGroups.has(key)) {\n          taskGroups.set(key, []);\n        }\n        taskGroups.get(key)!.push(task);\n      });\n      \n      // Process duplicates\n      let duplicatesRemoved = 0;\n      const tasksToKeep: typeof allTasks = [];\n      const tasksToDelete: typeof allTasks = [];\n      \n      // Convert entries to array for iteration\n      const groupEntries = Array.from(taskGroups.entries());\n      \n      for (const [key, duplicates] of groupEntries) {\n        if (duplicates.length > 1) {\n          console.log(`Found ${duplicates.length} duplicates for: ${key}`);\n          \n          // Sort to determine which task to keep\n          type TaskType = typeof duplicates[0];\n          duplicates.sort((a: TaskType, b: TaskType) => {\n            // Prefer completed/in-progress over pending/skipped\n            const statusPriority: { [key: string]: number } = {\n              'completed': 4,\n              'approved': 4,\n              'in_progress': 3,\n              'pending': 2,\n              'skipped': 1\n            };\n            const aPriority = statusPriority[a.status || 'pending'] || 0;\n            const bPriority = statusPriority[b.status || 'pending'] || 0;\n            if (aPriority !== bPriority) {\n              return bPriority - aPriority; // Higher priority first\n            }\n            // If same priority, keep original (lower ID = older)\n            return a.id - b.id;\n          });\n          \n          // Keep first one (best match based on sort), delete the rest\n          tasksToKeep.push(duplicates[0]);\n          console.log(`  Keeping task ID ${duplicates[0].id} (status: ${duplicates[0].status})`);\n          \n          for (let i = 1; i < duplicates.length; i++) {\n            tasksToDelete.push(duplicates[i]);\n            console.log(`  Removing duplicate ID ${duplicates[i].id} (status: ${duplicates[i].status})`);\n            duplicatesRemoved++;\n          }\n        } else {\n          // No duplicates, keep the task\n          tasksToKeep.push(duplicates[0]);\n        }\n      }\n      \n      // Delete duplicates from database\n      console.log(`Removing ${duplicatesRemoved} duplicate tasks...`);\n      for (const task of tasksToDelete) {\n        await storage.deleteTask(task.id);\n      }\n      \n      console.log(\"=== DUPLICATE REMOVAL COMPLETE ===\");\n      console.log(`- Started with: ${allTasks.length} tasks`);\n      console.log(`- Removed: ${duplicatesRemoved} duplicates`);\n      console.log(`- Final count: ${tasksToKeep.length} unique tasks`);\n      \n      res.json({\n        totalTasks: allTasks.length,\n        duplicatesRemoved,\n        finalCount: tasksToKeep.length,\n        message: duplicatesRemoved > 0 \n          ? `Removed ${duplicatesRemoved} duplicate task${duplicatesRemoved !== 1 ? 's' : ''}` \n          : \"No duplicates found\"\n      });\n    } catch (error) {\n      console.error(\"Error removing duplicates:\", error);\n      res.status(500).json({ \n        message: \"Failed to remove duplicates\", \n        error: error instanceof Error ? error.message : String(error) \n      });\n    }\n  });\n\n  // Inventory routes\n  app.get(\"/api/inventory\", async (req, res) => {\n    try {\n      const { location } = req.query;\n      let items;\n      \n      if (location) {\n        items = await storage.getInventoryItemsByLocation(location as string);\n      } else {\n        items = await storage.getAllInventoryItems();\n      }\n      \n      res.json(items);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to fetch inventory\" });\n    }\n  });\n\n  app.get(\"/api/inventory/low-stock\", async (req, res) => {\n    try {\n      const { location } = req.query;\n      let items;\n      \n      if (location) {\n        items = await storage.getLowStockItemsByLocation(location as string);\n      } else {\n        items = await storage.getLowStockItems();\n      }\n      \n      res.json(items);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to fetch low stock items\" });\n    }\n  });\n\n  app.post(\"/api/inventory\", async (req, res) => {\n    try {\n      const itemData = insertInventoryItemSchema.parse(req.body);\n      const item = await storage.createInventoryItem(itemData);\n      res.json(item);\n    } catch (error) {\n      res.status(400).json({ message: \"Failed to create inventory item\" });\n    }\n  });\n\n  app.patch(\"/api/inventory/:id\", async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const updates = req.body;\n      const item = await storage.updateInventoryItem(id, updates);\n      \n      if (!item) {\n        return res.status(404).json({ message: \"Inventory item not found\" });\n      }\n\n      res.json(item);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to update inventory item\" });\n    }\n  });\n\n  app.delete(\"/api/inventory/:id\", async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const success = await storage.deleteInventoryItem(id);\n      \n      if (!success) {\n        return res.status(404).json({ message: \"Inventory item not found\" });\n      }\n\n      res.json({ message: \"Inventory item deleted successfully\" });\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to delete inventory item\" });\n    }\n  });\n\n  app.post(\"/api/inventory/add-stock\", async (req, res) => {\n    try {\n      console.log(\"Add inventory request:\", req.body);\n      const { itemId, quantity, unitCost, costPerUnit, supplier, notes } = req.body;\n      const finalUnitCost = unitCost || costPerUnit;\n      \n      if (!itemId || !quantity || !finalUnitCost) {\n        return res.status(400).json({ message: \"Missing required fields: itemId, quantity, unitCost\" });\n      }\n\n      const result = await storage.addInventoryStock({\n        itemId: parseInt(itemId),\n        quantity: parseFloat(quantity),\n        unitCost: parseFloat(finalUnitCost),\n        supplier,\n        notes\n      });\n\n      res.json(result);\n    } catch (error) {\n      console.error(\"Add inventory error:\", error);\n      res.status(500).json({ message: \"Failed to add inventory\", error: error instanceof Error ? error.message : String(error) });\n    }\n  });\n\n  // Training routes\n  app.get(\"/api/training/modules\", async (req, res) => {\n    try {\n      const modules = await storage.getAllTrainingModules();\n      res.json(modules);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to fetch training modules\" });\n    }\n  });\n\n  app.get(\"/api/training/modules/:id\", async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const module = await storage.getTrainingModule(id);\n      \n      if (!module) {\n        return res.status(404).json({ message: \"Training module not found\" });\n      }\n      \n      res.json(module);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to fetch training module\" });\n    }\n  });\n\n  app.post(\"/api/training/modules\", async (req, res) => {\n    try {\n      const moduleData = insertTrainingModuleSchema.parse(req.body);\n      const module = await storage.createTrainingModule(moduleData);\n      res.json(module);\n    } catch (error) {\n      res.status(400).json({ message: \"Failed to create training module\" });\n    }\n  });\n\n  app.get(\"/api/training/progress/:userId\", async (req, res) => {\n    try {\n      const userId = parseInt(req.params.userId);\n      const progress = await storage.getUserProgress(userId);\n      res.json(progress);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to fetch user progress\" });\n    }\n  });\n\n  app.post(\"/api/training/progress\", async (req, res) => {\n    try {\n      const progressData = insertUserProgressSchema.parse(req.body);\n      const progress = await storage.updateUserProgress(progressData);\n      res.json(progress);\n    } catch (error) {\n      res.status(400).json({ message: \"Failed to update progress\" });\n    }\n  });\n\n  // Course completion and role assignment\n  app.post(\"/api/courses/:courseId/complete\", async (req, res) => {\n    try {\n      const courseId = parseInt(req.params.courseId);\n      const { userId, roleAwarded } = req.body;\n      \n      if (!userId || !roleAwarded) {\n        return res.status(400).json({ message: \"Missing userId or roleAwarded\" });\n      }\n\n      // Get the user first\n      const user = await storage.getUser(userId);\n      if (!user) {\n        return res.status(404).json({ message: \"User not found\" });\n      }\n\n      // Parse existing roles (assuming it's stored as a comma-separated string)\n      const currentRoles = user.role ? user.role.split(',').map(r => r.trim()) : ['technician'];\n      \n      // Add the new role if not already present\n      if (!currentRoles.includes(roleAwarded)) {\n        currentRoles.push(roleAwarded);\n        \n        // Update user with new role\n        const updatedUser = await storage.updateUser(userId, {\n          role: currentRoles.join(', ')\n        });\n        \n        console.log(`Role \"${roleAwarded}\" assigned to user ${user.name} upon course completion`);\n        \n        res.json({\n          message: `Course completed! Role \"${roleAwarded}\" assigned to ${user.name}`,\n          user: updatedUser,\n          newRole: roleAwarded\n        });\n      } else {\n        res.json({\n          message: `Course completed! User already has the \"${roleAwarded}\" role`,\n          user: user,\n          newRole: roleAwarded\n        });\n      }\n    } catch (error) {\n      console.error(\"Course completion error:\", error);\n      res.status(500).json({ message: \"Failed to complete course and assign role\" });\n    }\n  });\n\n  // Task logs\n  app.post(\"/api/tasks/:id/logs\", async (req, res) => {\n    try {\n      const taskId = parseInt(req.params.id);\n      const logData = insertTaskLogSchema.parse({ ...req.body, taskId });\n      const log = await storage.createTaskLog(logData);\n      res.json(log);\n    } catch (error) {\n      res.status(400).json({ message: \"Failed to create task log\" });\n    }\n  });\n\n  app.get(\"/api/tasks/:id/logs\", async (req, res) => {\n    try {\n      const taskId = parseInt(req.params.id);\n      const logs = await storage.getTaskLogs(taskId);\n      res.json(logs);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to fetch task logs\" });\n    }\n  });\n\n  // Analytics routes\n  app.get(\"/api/analytics/dashboard\", async (req, res) => {\n    try {\n      const tasks = await storage.getAllTasks();\n      const users = await storage.getAllUsers();\n      const inventory = await storage.getAllInventoryItems();\n      const lowStockItems = await storage.getLowStockItems();\n\n      const completedTasks = tasks.filter(t => t.status === 'completed').length;\n      const inProgressTasks = tasks.filter(t => t.status === 'in_progress').length;\n      const pendingTasks = tasks.filter(t => t.status === 'pending').length;\n\n      const totalTime = tasks\n        .filter(t => t.actualTime)\n        .reduce((sum, t) => sum + (t.actualTime || 0), 0);\n\n      const analytics = {\n        totalTasks: tasks.length,\n        completedTasks,\n        inProgressTasks,\n        pendingTasks,\n        totalUsers: users.length,\n        totalInventoryItems: inventory.length,\n        lowStockAlerts: lowStockItems.length,\n        totalTimeLogged: totalTime,\n        tasksByType: tasks.reduce((acc, task) => {\n          acc[task.type] = (acc[task.type] || 0) + 1;\n          return acc;\n        }, {} as Record<string, number>),\n        tasksByStatus: {\n          completed: completedTasks,\n          in_progress: inProgressTasks,\n          pending: pendingTasks\n        }\n      };\n\n      res.json(analytics);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to fetch analytics\" });\n    }\n  });\n\n  // Recurring tasks routes\n  app.get(\"/api/recurring-tasks\", async (req, res) => {\n    try {\n      const { location } = req.query;\n      let tasks;\n      \n      if (location) {\n        // Apply same location mapping as tasks route\n        const rawLocation = String(location);\n        const cleanedLocation = rawLocation.trim().replace(/^['\"]|['\"]$/g, '');\n        const upperLocation = cleanedLocation.toUpperCase();\n        \n        // Map short location codes to full names for backwards compatibility  \n        const locationMap: { [key: string]: string } = {\n          'K': 'Kenosha'\n        };\n        const actualLocation = locationMap[upperLocation] || cleanedLocation;\n        \n        console.log(`üîç [RECURRING] Using location filtering for: \"${cleanedLocation}\" ‚Üí \"${actualLocation}\"`);\n        tasks = await storage.getRecurringTasksByLocation(actualLocation);\n        \n        // Defensive retry if mapping exists but got 0 results\n        if (tasks.length === 0 && locationMap[upperLocation] && actualLocation !== cleanedLocation) {\n          console.log(`üîç [RECURRING] Retrying with mapped location: \"${actualLocation}\"`);\n          tasks = await storage.getRecurringTasksByLocation(actualLocation);\n        }\n      } else {\n        tasks = await storage.getAllRecurringTasks();\n      }\n      \n      res.json(tasks);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to fetch recurring tasks\" });\n    }\n  });\n\n  app.post(\"/api/recurring-tasks\", async (req, res) => {\n    try {\n      console.log('üîÑ Creating new recurring task and generating instances...');\n      \n      // Apply location mapping for consistency\n      const mapLocation = (loc: string): string => {\n        const locationMap: { [key: string]: string } = { 'K': 'Kenosha' };\n        return locationMap[loc] || loc;\n      };\n      \n      const processedBody = {\n        ...req.body,\n        location: req.body.location ? mapLocation(req.body.location) : req.body.location\n      };\n      \n      // VALIDATION: Reject 'daily' frequency (eliminated from system)\n      if (processedBody.frequency === 'daily') {\n        return res.status(400).json({ \n          message: \"'daily' frequency is no longer supported. Please use 'weekly' instead and select the days of the week.\" \n        });\n      }\n      \n      // Create the recurring task template\n      const task = await storage.createRecurringTask(processedBody);\n      console.log(`‚úÖ Created recurring task template: \"${task.title}\" (ID: ${task.id})`);\n      \n      // CRITICAL FIX: Generate task instances for the next 31 days\n      try {\n        const result = await storage.regenerateTaskInstances(task.id);\n        console.log(`üéØ Generated task instances for recurring task \"${task.title}\"`);\n        \n        res.status(201).json({ \n          task, \n          generationSuccess: true,\n          message: `Created recurring task \"${task.title}\" and generated task instances` \n        });\n      } catch (generationError) {\n        console.error(`‚ùå Failed to generate instances for recurring task ${task.id}:`, generationError);\n        \n        // Attempt rollback - delete the created recurring task since it's not functional\n        try {\n          await storage.deleteRecurringTask(task.id);\n          console.log(`üîÑ Rolled back recurring task ${task.id} due to generation failure`);\n        } catch (rollbackError) {\n          console.error(`‚ùå Failed to rollback recurring task ${task.id}:`, rollbackError);\n        }\n        \n        res.status(500).json({ \n          message: \"Failed to generate task instances for recurring task\",\n          error: \"Task creation rolled back due to generation failure\"\n        });\n      }\n      \n    } catch (error) {\n      console.error('‚ùå Error creating recurring task:', error);\n      res.status(500).json({ message: \"Failed to create recurring task\" });\n    }\n  });\n\n  // Bulk update recurring tasks location (migration fix)\n  app.patch(\"/api/recurring-tasks/bulk-location\", async (req, res) => {\n    try {\n      const { location = 'K' } = req.body;\n      const recurringTasks = await storage.getAllRecurringTasks();\n      \n      let updated = 0;\n      for (const task of recurringTasks) {\n        if (!task.location || task.location === null) {\n          await storage.updateRecurringTask(task.id, { location });\n          updated++;\n        }\n      }\n      \n      console.log(`Updated ${updated} recurring tasks with location: ${location}`);\n      res.json({ message: `Updated ${updated} recurring tasks with location`, updated, location });\n    } catch (error) {\n      console.error('Error bulk updating recurring task locations:', error);\n      res.status(500).json({ message: 'Failed to update recurring task locations' });\n    }\n  });\n\n  // Get verification system reports for dev page\n  app.get(\"/api/dev/verification-report\", async (req, res) => {\n    try {\n      const lastResult = (global as any).lastVerificationResult || null;\n      res.json({\n        lastVerificationResult: lastResult,\n        systemStatus: {\n          verificationEnabled: true,\n          lastRunTime: lastResult?.timestamp || null,\n          triggeredBy: lastResult?.triggeredBy || 'none'\n        }\n      });\n    } catch (error) {\n      console.error('Error fetching verification report:', error);\n      res.status(500).json({ message: 'Failed to fetch verification report' });\n    }\n  });\n\n  // Manual verification trigger for dev testing\n  app.post(\"/api/dev/run-verification\", async (req, res) => {\n    try {\n      console.log('üîß Manual verification triggered from dev page');\n      const verificationResult = await storage.verifyTaskIntegrity();\n      \n      // Store verification result\n      (global as any).lastVerificationResult = {\n        ...verificationResult,\n        timestamp: new Date(),\n        triggeredBy: 'manual_dev_trigger',\n        taskId: null\n      };\n      \n      res.json({\n        success: true,\n        result: verificationResult\n      });\n    } catch (error) {\n      console.error('Error running manual verification:', error);\n      res.status(500).json({ message: 'Failed to run verification', error: error instanceof Error ? error.message : String(error) });\n    }\n  });\n\n  // Bulk update ALL recurring tasks location (for SharePoint migration fix)\n  app.post(\"/api/recurring-tasks/bulk-update-location\", async (req, res) => {\n    try {\n      const { fromLocation, toLocation } = req.body;\n      const recurringTasks = await storage.getAllRecurringTasks();\n      \n      let updated = 0;\n      for (const task of recurringTasks) {\n        // Update all tasks with the specified fromLocation, or update all if no fromLocation specified\n        if (!fromLocation || task.location === fromLocation) {\n          await storage.updateRecurringTask(task.id, { location: toLocation });\n          updated++;\n          console.log(`Updated task \"${task.title}\" location from \"${task.location}\" to \"${toLocation}\"`);\n        }\n      }\n      \n      console.log(`Bulk updated ${updated} recurring tasks to location: ${toLocation}`);\n      res.json({ message: `Updated ${updated} recurring tasks to location: ${toLocation}`, updated, toLocation });\n    } catch (error) {\n      console.error('Error bulk updating recurring task locations:', error);\n      res.status(500).json({ message: 'Failed to bulk update recurring task locations' });\n    }\n  });\n\n  // Preflight endpoint for impact calculation\n  // Get single recurring task\n  app.get(\"/api/recurring-tasks/:id\", async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      if (isNaN(id)) {\n        return res.status(400).json({ message: \"Invalid ID format\" });\n      }\n      \n      const task = await storage.getRecurringTask(id);\n      \n      if (!task) {\n        return res.status(404).json({ message: \"Recurring task not found\" });\n      }\n\n      res.json(task);\n    } catch (error) {\n      console.error(\"Error getting recurring task:\", error);\n      res.status(500).json({ message: \"Failed to get recurring task\" });\n    }\n  });\n\n  app.get(\"/api/recurring-tasks/:id/impact\", async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const changedFields = JSON.parse(req.query.changedFields as string || '[]');\n      \n      // Get the original recurring task\n      const originalTask = await storage.getRecurringTask(id);\n      if (!originalTask) {\n        return res.status(404).json({ message: \"Recurring task not found\" });\n      }\n\n      // Calculate impact without making changes\n      const impact = await storage.calculateUpdateImpact(id, changedFields);\n      \n      res.json({\n        taskId: id,\n        taskTitle: originalTask.title,\n        ...impact\n      });\n    } catch (error) {\n      console.error('Error calculating update impact:', error);\n      res.status(500).json({ message: \"Failed to calculate update impact\" });\n    }\n  });\n\n  app.patch(\"/api/recurring-tasks/:id\", async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const { strategy, userId, ...updates } = req.body;\n      \n      // VALIDATION: Reject 'daily' frequency (eliminated from system)\n      if (updates.frequency === 'daily') {\n        return res.status(400).json({ \n          message: \"'daily' frequency is no longer supported. Please use 'weekly' instead and select the days of the week.\" \n        });\n      }\n      \n      // Use the new comprehensive update method with options\n      const result = await storage.updateRecurringTask(id, updates, { strategy, userId });\n      \n      if (!result.task) {\n        return res.status(404).json({ message: \"Recurring task not found\" });\n      }\n\n      res.json({\n        task: result.task,\n        report: result.report\n      });\n    } catch (error) {\n      console.error('Error updating recurring task:', error);\n      res.status(500).json({ message: \"Failed to update recurring task\" });\n    }\n  });\n\n  // PUT route for recurring tasks (same as PATCH for frontend compatibility)\n  app.put(\"/api/recurring-tasks/:id\", async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const { strategy, userId, ...updates } = req.body;\n      \n      // VALIDATION: Reject 'daily' frequency (eliminated from system)\n      if (updates.frequency === 'daily') {\n        return res.status(400).json({ \n          message: \"'daily' frequency is no longer supported. Please use 'weekly' instead and select the days of the week.\" \n        });\n      }\n      \n      console.log(`üìù [PUT] Updating recurring task ${id} with updates:`, Object.keys(updates));\n      \n      // Use the new comprehensive update method with options\n      const result = await storage.updateRecurringTask(id, updates, { strategy, userId });\n      \n      if (!result.task) {\n        return res.status(404).json({ message: \"Recurring task not found\" });\n      }\n\n      console.log(`‚úÖ [PUT] Successfully updated recurring task ${id}, propagated to ${result.report.processedInstances || 0} instances`);\n      res.json({\n        task: result.task,\n        report: result.report\n      });\n    } catch (error) {\n      console.error(`‚ùå [PUT] Failed to update recurring task:`, error);\n      res.status(500).json({ message: \"Failed to update recurring task\" });\n    }\n  });\n\n  app.delete(\"/api/recurring-tasks/:id\", async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const deleted = await storage.deleteRecurringTask(id);\n      \n      if (!deleted) {\n        return res.status(404).json({ message: \"Recurring task not found\" });\n      }\n\n      res.json({ message: \"Recurring task deleted successfully\" });\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to delete recurring task\" });\n    }\n  });\n\n  // Regenerate ALL task instances with corrected logic\n  app.post(\"/api/recurring-tasks/regenerate-all\", async (req, res) => {\n    try {\n      console.log(\"üîÑ Starting bulk regeneration of all task instances...\");\n      const result = await storage.regenerateAllTaskInstances();\n      \n      res.json({ \n        message: \"Successfully regenerated all task instances with corrected date logic\",\n        ...result\n      });\n    } catch (error) {\n      console.error('Error regenerating all task instances:', error);\n      res.status(500).json({ message: \"Failed to regenerate task instances\" });\n    }\n  });\n\n  app.post(\"/api/recurring-tasks/:id/regenerate\", async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const success = await storage.regenerateTaskInstances(id);\n      \n      if (!success) {\n        return res.status(404).json({ message: \"Recurring task not found\" });\n      }\n\n      res.json({ message: \"Task instances regenerated successfully\" });\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to regenerate task instances\" });\n    }\n  });\n\n  // Course assignment routes\n  app.get(\"/api/course-assignments\", async (req, res) => {\n    try {\n      const { userId } = req.query;\n      let assignments;\n      \n      if (userId) {\n        assignments = await storage.getCourseAssignmentsByUser(parseInt(userId as string));\n      } else {\n        assignments = await storage.getAllCourseAssignments();\n      }\n      \n      res.json(assignments);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to fetch course assignments\" });\n    }\n  });\n\n  app.post(\"/api/course-assignments\", async (req, res) => {\n    try {\n      console.log(\"Received assignment data:\", req.body);\n      \n      // Convert date string to Date object if provided\n      const processedData = {\n        ...req.body,\n        dueDate: req.body.dueDate ? new Date(req.body.dueDate) : null\n      };\n      \n      const assignmentData = insertCourseAssignmentSchema.parse(processedData);\n      console.log(\"Parsed assignment data:\", assignmentData);\n      const assignment = await storage.createCourseAssignment(assignmentData);\n      \n      // Create notification for course assignment\n      const assignedByUser = await storage.getUser(assignmentData.assignedByUserId!);\n      const assignedToUser = await storage.getUser(assignmentData.assignedToUserId!);\n      \n      if (assignedByUser && assignedToUser) {\n        await storage.createNotification({\n          userId: assignmentData.assignedToUserId!,\n          type: 'course_assigned',\n          title: 'New Course Assigned',\n          message: `${assignedByUser.name} assigned you training course #${assignmentData.courseId}`,\n          relatedId: assignmentData.courseId,\n          relatedType: 'course',\n          isRead: false\n        });\n      }\n      \n      res.json(assignment);\n    } catch (error) {\n      console.error(\"Course assignment error:\", error);\n      res.status(400).json({ message: \"Failed to create course assignment\", error: error instanceof Error ? error.message : String(error) });\n    }\n  });\n\n  app.patch(\"/api/course-assignments/:id\", async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const assignment = await storage.updateCourseAssignment(id, req.body);\n      \n      if (!assignment) {\n        return res.status(404).json({ message: \"Course assignment not found\" });\n      }\n\n      res.json(assignment);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to update course assignment\" });\n    }\n  });\n\n  // Notification routes\n  app.get(\"/api/notifications/:userId\", async (req, res) => {\n    try {\n      const userId = parseInt(req.params.userId);\n      const notifications = await storage.getNotificationsByUser(userId);\n      res.json(notifications);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to fetch notifications\" });\n    }\n  });\n\n  app.post(\"/api/notifications\", async (req, res) => {\n    try {\n      const notificationData = insertNotificationSchema.parse(req.body);\n      const notification = await storage.createNotification(notificationData);\n      res.json(notification);\n    } catch (error) {\n      res.status(400).json({ message: \"Failed to create notification\", error: error instanceof Error ? error.message : String(error) });\n    }\n  });\n\n  app.patch(\"/api/notifications/:id\", async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const { isRead } = req.body;\n      \n      if (isRead) {\n        const notification = await storage.markNotificationAsRead(id);\n        if (!notification) {\n          return res.status(404).json({ message: \"Notification not found\" });\n        }\n        res.json(notification);\n      } else {\n        const notification = await storage.updateNotification(id, req.body);\n        if (!notification) {\n          return res.status(404).json({ message: \"Notification not found\" });\n        }\n        res.json(notification);\n      }\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to update notification\" });\n    }\n  });\n\n  app.patch(\"/api/notifications/mark-all-read\", async (req, res) => {\n    try {\n      const { userId } = req.body;\n      await storage.markAllNotificationsAsRead(userId);\n      res.json({ success: true });\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to mark all notifications as read\" });\n    }\n  });\n\n  app.delete(\"/api/notifications/:id\", async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const success = await storage.deleteNotification(id);\n      \n      if (!success) {\n        return res.status(404).json({ message: \"Notification not found\" });\n      }\n      \n      res.json({ success: true });\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to delete notification\" });\n    }\n  });\n\n\n\n  // Growing systems routes\n  app.get(\"/api/growing-systems\", async (req, res) => {\n    try {\n      const { location } = req.query;\n      let systems;\n      \n      if (location) {\n        systems = await storage.getGrowingSystemsByLocation(location as string);\n      } else {\n        systems = await storage.getAllGrowingSystems();\n      }\n      \n      res.json(systems);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to fetch growing systems\" });\n    }\n  });\n\n  app.post(\"/api/growing-systems\", async (req, res) => {\n    try {\n      const system = await storage.createGrowingSystem(req.body);\n      res.json(system);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to create growing system\" });\n    }\n  });\n\n  app.patch(\"/api/growing-systems/:id\", async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const system = await storage.updateGrowingSystem(id, req.body);\n      \n      if (!system) {\n        return res.status(404).json({ message: \"Growing system not found\" });\n      }\n\n      res.json(system);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to update growing system\" });\n    }\n  });\n\n  app.delete(\"/api/growing-systems/:id\", async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const deleted = await storage.deleteGrowingSystem(id);\n      \n      if (!deleted) {\n        return res.status(404).json({ message: \"Growing system not found\" });\n      }\n\n      res.json({ message: \"Growing system deleted successfully\" });\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to delete growing system\" });\n    }\n  });\n\n  // Regenerate tasks with fixed dates endpoint\n  app.post(\"/api/regenerate-tasks\", async (req, res) => {\n    try {\n      // Delete all recurring task instances (not the recurring tasks themselves)\n      const recurringTasks = await storage.getAllRecurringTasks();\n      const tasks = await storage.getAllTasks();\n      \n      // Remove all task instances that were generated from recurring tasks\n      const recurringTaskIds = new Set(recurringTasks.map((rt: any) => rt.id));\n      const tasksToDelete = tasks.filter((task: any) => task.isRecurring && task.recurringTaskId && recurringTaskIds.has(task.recurringTaskId));\n      \n      console.log(`Deleting ${tasksToDelete.length} existing recurring task instances`);\n      for (const task of tasksToDelete) {\n        await storage.deleteTask(task.id);\n      }\n      \n      // Regenerate all task instances with fixed date logic\n      console.log(`Regenerating task instances for ${recurringTasks.length} recurring tasks`);\n      for (const recurringTask of recurringTasks) {\n        await (storage as any).generateTaskInstances(recurringTask);\n      }\n      \n      const newTasks = await storage.getAllTasks();\n      const newRecurringInstances = newTasks.filter(task => task.isRecurring);\n      \n      res.json({ \n        message: \"Tasks regenerated successfully with fixed dates\",\n        deletedTasks: tasksToDelete.length,\n        regeneratedTasks: newRecurringInstances.length,\n        recurringTasks: recurringTasks.length\n      });\n    } catch (error) {\n      console.error(\"Failed to regenerate tasks:\", error);\n      res.status(500).json({ message: \"Failed to regenerate tasks\" });\n    }\n  });\n\n\n\n  // Clear all data endpoint - Complete reset\n  app.post(\"/api/clear-data\", async (req, res) => {\n    try {\n      console.log('=== CLEARING ALL DATA ===');\n      \n      const success = await storage.clearAllData();\n      \n      if (!success) {\n        return res.status(500).json({ message: \"Failed to clear data\" });\n      }\n\n      console.log('All data cleared successfully');\n      \n      res.json({ \n        message: \"All data cleared successfully\",\n        tasks: 0,\n        recurringTasks: 0,\n        inventoryItems: 0\n      });\n    } catch (error) {\n      console.error('Error clearing data:', error);\n      res.status(500).json({ error: \"Failed to clear data\" });\n    }\n  });\n\n  // System status and lock endpoints for task generation coordination\n  app.get(\"/api/system/status/:id\", async (req, res) => {\n    try {\n      const id = req.params.id;\n      const status = await storage.getSystemStatus(id);\n      res.json(status);\n    } catch (error) {\n      console.error('Error fetching system status:', error);\n      res.status(500).json({ message: \"Failed to fetch system status\" });\n    }\n  });\n\n  app.post(\"/api/system/status\", async (req, res) => {\n    try {\n      const statusData = req.body;\n      const status = await storage.setSystemStatus(statusData);\n      res.json(status);\n    } catch (error) {\n      console.error('Error setting system status:', error);\n      res.status(500).json({ message: \"Failed to set system status\" });\n    }\n  });\n\n  app.post(\"/api/system/lock/:lockId\", async (req, res) => {\n    try {\n      const lockId = req.params.lockId;\n      const { userId, lockType, expirationMinutes } = req.body;\n      const lock = await storage.acquireLock(lockId, userId, lockType, expirationMinutes);\n      \n      if (!lock) {\n        return res.status(423).json({ message: \"Lock already held by another user\" });\n      }\n      \n      res.json(lock);\n    } catch (error) {\n      console.error('Error acquiring lock:', error);\n      res.status(500).json({ message: \"Failed to acquire lock\" });\n    }\n  });\n\n  app.delete(\"/api/system/lock/:lockId\", async (req, res) => {\n    try {\n      const lockId = req.params.lockId;\n      const success = await storage.releaseLock(lockId);\n      res.json({ success, message: success ? \"Lock released\" : \"Lock not found\" });\n    } catch (error) {\n      console.error('Error releasing lock:', error);\n      res.status(500).json({ message: \"Failed to release lock\" });\n    }\n  });\n\n  app.get(\"/api/system/lock/:lockId\", async (req, res) => {\n    try {\n      const lockId = req.params.lockId;\n      const lock = await storage.checkLock(lockId);\n      res.json(lock);\n    } catch (error) {\n      console.error('Error checking lock:', error);\n      res.status(500).json({ message: \"Failed to check lock\" });\n    }\n  });\n\n  // Window focus verification trigger endpoint\n  app.post(\"/api/system/verify-tasks\", async (req, res) => {\n    try {\n      const { userId = 1 } = req.body;\n      console.log(`üîÑ Window focus triggered verification for user ${userId}`);\n      \n      // Call the existing verification method with all locking and timing logic\n      await (storage as any).initializeAppVerification(userId);\n      \n      res.json({ \n        success: true, \n        message: \"Verification check triggered\",\n        timestamp: new Date().toISOString()\n      });\n    } catch (error) {\n      console.error('Error triggering verification:', error);\n      res.status(500).json({ message: \"Failed to trigger verification\" });\n    }\n  });\n\n  // Tray API endpoints (temporary localStorage bridge until database migration)\n  app.get(\"/api/trays\", async (req, res) => {\n    try {\n      // For now, return empty array - will be replaced with database implementation\n      res.json([]);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to fetch trays\" });\n    }\n  });\n\n  app.post(\"/api/trays\", async (req, res) => {\n    try {\n      // For now, just return the created tray data\n      const trayData = req.body;\n      res.json(trayData);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to create tray\" });\n    }\n  });\n\n  app.put(\"/api/trays/:id\", async (req, res) => {\n    try {\n      const trayId = req.params.id;\n      const updates = req.body;\n      // For now, just return the updated data\n      res.json({ id: trayId, ...updates });\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to update tray\" });\n    }\n  });\n\n  app.delete(\"/api/trays/:id\", async (req, res) => {\n    try {\n      const trayId = req.params.id;\n      res.json({ message: \"Tray deleted successfully\", id: trayId });\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to delete tray\" });\n    }\n  });\n\n  app.post(\"/api/trays/:id/split\", async (req, res) => {\n    try {\n      const trayId = req.params.id;\n      const { splitCount } = req.body;\n      // For now, return mock split data\n      const splitTrays = Array.from({ length: splitCount }, (_, i) => ({\n        id: `${trayId}-${i + 1}`,\n        splitFrom: trayId,\n        splitNumber: i + 1,\n        splitTotal: splitCount\n      }));\n      res.json(splitTrays);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to split tray\" });\n    }\n  });\n\n  // Complete SharePoint CSV import endpoint - Import all 50+ transformed tasks\n  app.post(\"/api/admin/import-complete-csv\", async (req, res) => {\n    try {\n      // Clear existing recurring tasks to avoid duplicates\n      await storage.resetRecurringTasks();\n      \n      // Get default user (Robert Carlson)\n      let defaultUserId = 4; // Robert Carlson's ID\n      const users = await storage.getAllUsers();\n      if (users.length > 0) {\n        defaultUserId = users[0].id;\n      }\n\n      // Helper to map category to type\n      const mapCategoryToType = (category: string) => {\n        const categoryLower = category.toLowerCase();\n        if (categoryLower.includes('seeding')) return 'seeding-microgreens';\n        if (categoryLower.includes('harvest')) return 'harvest-microgreens'; \n        if (categoryLower.includes('blackout')) return 'blackout-tasks';\n        if (categoryLower.includes('moving')) return 'moving';\n        if (categoryLower.includes('cleaning')) return 'cleaning';\n        if (categoryLower.includes('inventory')) return 'inventory';\n        if (categoryLower.includes('farm')) return 'general-maintenance';\n        return 'other';\n      };\n\n      // Helper to parse days of week from CSV format\n      const parseDaysOfWeek = (daysStr: string) => {\n        if (!daysStr || daysStr === '[]') return null;\n        if (daysStr.includes(',')) {\n          return daysStr.split(',').map((d: string) => d.trim().toLowerCase());\n        }\n        return [daysStr.toLowerCase()];\n      };\n\n      // Complete transformed CSV data (all 50+ tasks)\n      const transformedTasks = [\n        { title: \"Remove BO and Move Arugula Microgreens to Watering Rack\", description: \"Move to watering rack\", category: \"Blackout Tasks\", priority: \"high\", frequency: \"weekly\", daysOfWeek: \"wednesday\", assignedRole: \"General Staff\" },\n        { title: \"Seed Broccoli Microgreens\", description: \"Seed Broccoli Microgreens\", category: \"Seeding - Microgreens\", priority: \"high\", frequency: \"weekly\", daysOfWeek: \"sunday\", assignedRole: \"Microgreen Seeder\" },\n        { title: \"Soak Pea Microgreens\", description: \"Soak the Seeds for 12 hours; Drain and rinse occasionaly until tomorrow afternoon.\", category: \"Other\", priority: \"high\", frequency: \"weekly\", daysOfWeek: \"sunday\", assignedRole: \"Microgreen Seeder\" },\n        { title: \"Remove Weight/BO and Move Radish Microgreens to Watering Rack\", description: \"Remove Weight/BO and Move Radish Microgreens\", category: \"Moving\", priority: \"high\", frequency: \"weekly\", daysOfWeek: \"tuesday\", assignedRole: \"General Staff\" },\n        { title: \"Adjust Nutrients in Microgreen Reservoirs\", description: \"Check the nutrient and pH level and adjust\", category: \"Other\", priority: \"medium\", frequency: \"weekly\", daysOfWeek: \"wednesday\", assignedRole: \"General Staff\" },\n        { title: \"Clean Bathroom\", description: \"Clean the Bathroom\", category: \"Cleaning\", priority: \"medium\", frequency: \"weekly\", daysOfWeek: \"monday\", assignedRole: \"Manager\" },\n        { title: \"Deep Floor Scrub\", description: \"This task is designed to deep clean stained and heavily soiled areas of the facility floor using a baking soda solution and manual scrubbing.\", category: \"Other\", priority: \"medium\", frequency: \"bi-weekly\", daysOfWeek: null, assignedRole: \"Manager\" },\n        { title: \"Opening\", description: \"Open the farm.\", category: \"Other\", priority: \"high\", frequency: \"daily\", daysOfWeek: null, assignedRole: \"General Staff\" },\n        { title: \"Clean Tower Clips\", description: \"Clean tower clips.\", category: \"Cleaning\", priority: \"medium\", frequency: \"weekly\", daysOfWeek: \"tuesday\", assignedRole: \"General Staff\" },\n        { title: \"Check the Inventory of Leafy Green Stock\", description: \"Check the Rockwool, Oasis Cubes, Seeds, and Leafy Green Bags.\", category: \"Inventory\", priority: \"medium\", frequency: \"monthly\", daysOfWeek: null, dayOfMonth: 1, assignedRole: \"General Staff\" },\n        { title: \"Check General Inventory Stock\", description: \"Check the stock of Order Bags, Order Boxes, Labels, and More\", category: \"Inventory\", priority: \"medium\", frequency: \"monthly\", daysOfWeek: null, dayOfMonth: 1, assignedRole: \"General Staff\" },\n        { title: \"Check Nutrient Inventory\", description: \"Ensure we have enough nutrients to last roughly three months.\", category: \"Inventory\", priority: \"medium\", frequency: \"monthly\", daysOfWeek: null, dayOfMonth: 1, assignedRole: \"General Staff\" },\n        { title: \"Uncover the Leafy Green and Herb trays\", description: \"There should be many trays to uncover including Romaine, Swiss Chard, Butter Crunch, Red Oak, Kale, Summer Crisp, Basil, and Collard Greens\", category: \"Other\", priority: \"medium\", frequency: \"weekly\", daysOfWeek: \"friday\", assignedRole: \"General Staff\" },\n        { title: \"Seed Pea Microgreens\", description: \"Use soaked seeds. Place trays directly into Watering Rack. Use 1 shim under tray in watering rack.\", category: \"Seeding - Microgreens\", priority: \"high\", frequency: \"weekly\", daysOfWeek: \"monday\", assignedRole: \"Microgreen Seeder\" },\n        { title: \"Seed Radish Microgreens\", description: \"Seed the Radish Microgreens\", category: \"Seeding - Microgreens\", priority: \"high\", frequency: \"weekly\", daysOfWeek: \"saturday\", assignedRole: \"Microgreen Seeder\" },\n        { title: \"Seed Mustard Microgreens\", description: \"Do not stack while germinating.\", category: \"Seeding - Microgreens\", priority: \"high\", frequency: \"weekly\", daysOfWeek: \"sunday\", assignedRole: \"Microgreen Seeder\" },\n        { title: \"Remove Weight/BO and Move Broccoli Microgreens to Watering Rack\", description: \"Put in D watering rack on shelf with fan; After move, run water in rack until tray is wet.\", category: \"Moving\", priority: \"high\", frequency: \"weekly\", daysOfWeek: \"wednesday\", assignedRole: \"General Staff\" },\n        { title: \"Remove Weight and BO for Pea Microgreens\", description: \"Remove Weight and dome for Pea Microgreens\", category: \"Blackout Tasks\", priority: \"high\", frequency: \"weekly\", daysOfWeek: \"friday\", assignedRole: \"General Staff\" },\n        { title: \"Remove BO and Move Mustard Microgreens to Watering Rack\", description: \"Remove Dome and Move Mustard Microgreens to Watering Rack\", category: \"Blackout Tasks\", priority: \"high\", frequency: \"weekly\", daysOfWeek: \"wednesday\", assignedRole: \"General Staff\" },\n        { title: \"Harvest Pea Microgreens\", description: \"Apis: 3 oz in 24 oz container; Others: 1 oz in 8 oz container\", category: \"Harvest - Microgreens\", priority: \"medium\", frequency: \"weekly\", daysOfWeek: \"wednesday\", assignedRole: \"Harvester\" },\n        { title: \"Harvest Broccoli Microgreens\", description: \"1 oz per 8 oz container\", category: \"Harvest - Microgreens\", priority: \"medium\", frequency: \"weekly\", daysOfWeek: \"wednesday\", assignedRole: \"Harvester\" },\n        { title: \"Harvest Radish Microgreens\", description: \"1 oz in 8 oz container\", category: \"Harvest - Microgreens\", priority: \"medium\", frequency: \"weekly\", daysOfWeek: \"wednesday\", assignedRole: \"Harvester\" },\n        { title: \"Harvest Mustard Microgreens\", description: \"0.7 oz in 8 oz container\", category: \"Harvest - Microgreens\", priority: \"medium\", frequency: \"weekly\", daysOfWeek: \"wednesday\", assignedRole: \"Harvester\" },\n        { title: \"Seed Arugula Microgreens\", description: \"Mucilagenous seeds; do not stack\", category: \"Seeding - Microgreens\", priority: \"high\", frequency: \"weekly\", daysOfWeek: \"monday\", assignedRole: \"Microgreen Seeder\" },\n        { title: \"Harvest Arugula Microgreens\", description: \"0.5 oz in 8 oz container\", category: \"Harvest - Microgreens\", priority: \"medium\", frequency: \"weekly\", daysOfWeek: \"wednesday\", assignedRole: \"Harvester\" },\n        { title: \"Water Microgreen Germination Trays\", description: \"Water microgreens daily\", category: \"General Farm\", priority: \"high\", frequency: \"weekly\", daysOfWeek: \"sunday,monday,tuesday,saturday\", assignedRole: \"General Staff\" },\n        { title: \"Change Microgreen Reservoir Water and Clean Shelves\", description: \"This process ensures that the water in the microgreen reservoir is fresh and properly prepared with nutrients and pH adjustments.\", category: \"Cleaning\", priority: \"medium\", frequency: \"monthly\", daysOfWeek: null, dayOfMonth: 1, assignedRole: \"General Staff\" },\n        { title: \"Check Paper Towel Levels\", description: \"Ensure adequate paper towel supplies are maintained.\", category: \"Other\", priority: \"medium\", frequency: \"weekly\", daysOfWeek: \"thursday\", assignedRole: \"General Staff\" },\n        { title: \"Remove Garbage from Non-Farm areas\", description: \"Collect and dispose of trash from lobby and office areas.\", category: \"Moving\", priority: \"medium\", frequency: \"weekly\", daysOfWeek: \"thursday\", assignedRole: \"General Staff\" },\n        { title: \"Vacuum the Office and Lobby\", description: \"Maintain cleanliness in office and lobby areas.\", category: \"Other\", priority: \"medium\", frequency: \"weekly\", daysOfWeek: \"thursday\", assignedRole: \"General Staff\" },\n        { title: \"Clean Outside Facing Lobby Window\", description: \"Keep lobby windows clean and professional.\", category: \"Cleaning\", priority: \"medium\", frequency: \"monthly\", daysOfWeek: null, dayOfMonth: 1, assignedRole: \"General Staff\" },\n        { title: \"Washing Farm Towels and Filter Socks\", description: \"Ensure farm towels and filter socks are cleaned properly.\", category: \"Other\", priority: \"medium\", frequency: \"weekly\", daysOfWeek: \"tuesday\", assignedRole: \"General Staff\" },\n        { title: \"Clean Farm Floor\", description: \"Deep clean and sanitize farm floors.\", category: \"Cleaning\", priority: \"medium\", frequency: \"weekly\", daysOfWeek: \"monday\", assignedRole: \"General Staff\" },\n        { title: \"Interior Window Cleaning\", description: \"Clean interior windows throughout the facility.\", category: \"Cleaning\", priority: \"medium\", frequency: \"monthly\", daysOfWeek: null, dayOfMonth: 1, assignedRole: \"General Staff\" },\n        { title: \"Check pH and Water Levels in Towers\", description: \"Ensure optimal water pH and levels in all towers.\", category: \"General Farm\", priority: \"medium\", frequency: \"weekly\", daysOfWeek: \"thursday\", assignedRole: \"General Staff\" },\n        { title: \"Seed Leafy Greens\", description: \"Seed leafy greens based on planning spreadsheet.\", category: \"Seeding - Leafy Greens\", priority: \"high\", frequency: \"weekly\", daysOfWeek: \"tuesday\", assignedRole: \"Microgreen Seeder\" },\n        { title: \"Harvest Turnip Microgreens\", description: \"1 oz per 8 oz container\", category: \"Harvest - Microgreens\", priority: \"medium\", frequency: \"weekly\", daysOfWeek: \"wednesday\", assignedRole: \"Harvester\" },\n        { title: \"Harvest Spicy Mix Microgreens\", description: \"0.7 oz per 8 oz container\", category: \"Harvest - Microgreens\", priority: \"medium\", frequency: \"weekly\", daysOfWeek: \"wednesday\", assignedRole: \"Harvester\" },\n        { title: \"Remove Weight/BO and Move Turnip Microgreens to Watering Rack\", description: \"Move turnip microgreens to watering rack\", category: \"Moving\", priority: \"high\", frequency: \"weekly\", daysOfWeek: \"thursday\", assignedRole: \"General Staff\" },\n        { title: \"Remove BO and Move Spicy Mix Microgreens to Watering Rack\", description: \"Move spicy mix microgreens to watering rack\", category: \"Blackout Tasks\", priority: \"high\", frequency: \"weekly\", daysOfWeek: \"wednesday\", assignedRole: \"General Staff\" },\n        { title: \"Seed Turnip Microgreens\", description: \"Seed Turnip Microgreens\", category: \"Seeding - Microgreens\", priority: \"high\", frequency: \"weekly\", daysOfWeek: \"monday\", assignedRole: \"Microgreen Seeder\" },\n        { title: \"Seed Spicy Mix Microgreens\", description: \"Seed Spicy Mix Microgreens\", category: \"Seeding - Microgreens\", priority: \"high\", frequency: \"weekly\", daysOfWeek: \"sunday\", assignedRole: \"Microgreen Seeder\" },\n        { title: \"Clean Tower Basins\", description: \"Proper disassembly, cleanup, and preparation of Tower Garden basins\", category: \"Cleaning\", priority: \"medium\", frequency: \"weekly\", daysOfWeek: \"wednesday\", assignedRole: \"General Staff\" },\n        { title: \"Set Clean Towers\", description: \"Install clean, fully assembled towers in fresh basins\", category: \"Cleaning\", priority: \"medium\", frequency: \"weekly\", daysOfWeek: \"wednesday\", assignedRole: \"General Staff\" },\n        { title: \"Clean Tower Garden Pots\", description: \"Clean Tower Garden pots and structural rods thoroughly\", category: \"Cleaning\", priority: \"medium\", frequency: \"weekly\", daysOfWeek: \"thursday\", assignedRole: \"General Staff\" },\n        { title: \"Assemble Tower Gardens\", description: \"Full assembly of Tower Garden units with proper alignment\", category: \"Other\", priority: \"medium\", frequency: \"weekly\", daysOfWeek: \"saturday\", assignedRole: \"General Staff\" },\n        { title: \"Disassemble Towers\", description: \"Disassemble tower units after removal from growing position\", category: \"Other\", priority: \"medium\", frequency: \"weekly\", daysOfWeek: \"wednesday\", assignedRole: \"General Staff\" },\n        { title: \"Replace Fan and Furnace Filter\", description: \"Replace filters to prevent mildew\", category: \"Other\", priority: \"medium\", frequency: \"bi-weekly\", daysOfWeek: null, assignedRole: \"General Staff\" },\n        { title: \"Plant Towers\", description: \"Plant needed towers for the week based on checklist\", category: \"Other\", priority: \"medium\", frequency: \"weekly\", daysOfWeek: \"thursday\", assignedRole: \"General Staff\" },\n        { title: \"Harvest Towers\", description: \"Harvest towers according to checklist\", category: \"Other\", priority: \"high\", frequency: \"weekly\", daysOfWeek: \"tuesday\", assignedRole: \"Harvester\" }\n      ];\n\n      let imported = 0;\n      \n      for (const csvTask of transformedTasks) {\n        try {\n          const task = {\n            title: csvTask.title,\n            description: csvTask.description,\n            type: mapCategoryToType(csvTask.category),\n            frequency: csvTask.frequency,\n            daysOfWeek: csvTask.daysOfWeek ? parseDaysOfWeek(csvTask.daysOfWeek) : null,\n            dayOfMonth: csvTask.dayOfMonth || null,\n            location: \"Kenosha\",\n            isActive: true,\n            createdBy: defaultUserId\n          };\n\n          await storage.createRecurringTask(task);\n          imported++;\n        } catch (error) {\n          console.error(`Failed to import task: ${csvTask.title}`, error);\n        }\n      }\n      \n      console.log(`‚úÖ Complete CSV Migration: Imported ${imported} recurring tasks`);\n      res.json({ \n        success: true,\n        message: `Successfully imported ${imported} SharePoint recurring tasks from complete CSV dataset`,\n        imported \n      });\n    } catch (error) {\n      console.error('‚ùå Complete CSV migration failed:', error);\n      res.status(500).json({ message: 'Failed to import complete CSV tasks' });\n    }\n  });\n\n  // Admin endpoint to fix frequency field in existing task instances\n  app.post(\"/api/admin/fix-task-frequencies\", async (req, res) => {\n    try {\n      console.log('üîß FIXING FREQUENCY FIELDS IN EXISTING TASKS');\n      \n      const allTasks = await storage.getAllTasks();\n      const allRecurringTasks = await storage.getAllRecurringTasks();\n      \n      // Create lookup map for recurring tasks\n      const recurringTaskMap = new Map();\n      allRecurringTasks.forEach(rt => {\n        recurringTaskMap.set(rt.id, rt);\n      });\n      \n      let updatedCount = 0;\n      \n      for (const task of allTasks) {\n        if (task.recurringTaskId && (task.frequency === null || task.frequency === undefined)) {\n          const recurringTask = recurringTaskMap.get(task.recurringTaskId);\n          if (recurringTask?.frequency) {\n            console.log(`üîß Updating task ${task.id}: \"${task.title}\" with frequency: ${recurringTask.frequency}`);\n            \n            // Update the task with frequency and visibleFromDate if missing\n            const updates: any = {\n              frequency: recurringTask.frequency\n            };\n            \n            // If no visibleFromDate, set it to the due date for daily tasks or start of period for others\n            if (!task.visibleFromDate && task.dueDate) {\n              if (recurringTask.frequency === 'monthly') {\n                // Monthly tasks visible from 1st of month\n                const dueDate = new Date(task.dueDate);\n                const firstOfMonth = new Date(dueDate.getFullYear(), dueDate.getMonth(), 1);\n                updates.visibleFromDate = firstOfMonth.toISOString().split('T')[0];\n              } else if (recurringTask.frequency === 'biweekly') {\n                // Bi-weekly tasks - check if it's first or second half\n                const dueDate = new Date(task.dueDate);\n                const dayOfMonth = dueDate.getDate();\n                if (dayOfMonth <= 14) {\n                  // First half\n                  const firstOfMonth = new Date(dueDate.getFullYear(), dueDate.getMonth(), 1);\n                  updates.visibleFromDate = firstOfMonth.toISOString().split('T')[0];\n                } else {\n                  // Second half\n                  const fifteenth = new Date(dueDate.getFullYear(), dueDate.getMonth(), 15);\n                  updates.visibleFromDate = fifteenth.toISOString().split('T')[0];\n                }\n              } else if (recurringTask.frequency === 'quarterly') {\n                // Quarterly tasks visible from start of quarter\n                const dueDate = new Date(task.dueDate);\n                const month = dueDate.getMonth();\n                const quarterStart = Math.floor(month / 3) * 3;\n                const quarterStartDate = new Date(dueDate.getFullYear(), quarterStart, 1);\n                updates.visibleFromDate = quarterStartDate.toISOString().split('T')[0];\n              } else {\n                // Daily/weekly tasks visible on their due date\n                updates.visibleFromDate = task.dueDate;\n              }\n            }\n            \n            await storage.updateTask(task.id, updates);\n            updatedCount++;\n            console.log(`‚úÖ Updated task ${task.id}: ${task.title} with frequency: ${recurringTask.frequency}`);\n          }\n        }\n      }\n      \n      console.log(`üéâ FREQUENCY FIX COMPLETE: Updated ${updatedCount} tasks`);\n      \n      res.json({ \n        success: true,\n        message: `Updated ${updatedCount} tasks with frequency data`,\n        updatedCount,\n        totalTasks: allTasks.length,\n        recurringTasks: allRecurringTasks.length\n      });\n    } catch (error) {\n      console.error('‚ùå Frequency fix failed:', error);\n      res.status(500).json({ \n        success: false,\n        message: 'Failed to fix task frequencies', \n        error: error instanceof Error ? error.message : 'Unknown error' \n      });\n    }\n  });\n\n  // Fix monthly task date ranges to show all month\n  app.post(\"/api/admin/fix-monthly-date-ranges\", async (req, res) => {\n    try {\n      console.log('üîß FIXING MONTHLY TASK DATE RANGES');\n      \n      const allTasks = await storage.getAllTasks();\n      let updateCount = 0;\n      \n      const today = new Date();\n      const currentMonth = today.getMonth();\n      const currentYear = today.getFullYear();\n      \n      // First day of current month\n      const monthStart = new Date(currentYear, currentMonth, 1);\n      // Last day of current month\n      const monthEnd = new Date(currentYear, currentMonth + 1, 0);\n      \n      for (const task of allTasks) {\n        // Fix monthly tasks that have same visibleFromDate and dueDate\n        if (task.frequency === 'monthly' && task.recurringTaskId) {\n          const visibleDate = task.visibleFromDate ? new Date(task.visibleFromDate) : null;\n          const dueDate = task.dueDate ? new Date(task.dueDate) : null;\n          \n          // Check if both dates are the same (indicating they need fixing)\n          if (visibleDate && dueDate && visibleDate.getTime() === dueDate.getTime()) {\n            console.log(`‚úÖ Fixing monthly date range for: ${task.title}`);\n            console.log(`   Before: ${task.visibleFromDate} to ${task.dueDate}`);\n            \n            await storage.updateTask(task.id, {\n              ...task,\n              visibleFromDate: monthStart,\n              dueDate: monthEnd,\n              frequency: 'monthly',\n              isRecurring: true\n            });\n            \n            console.log(`   After: ${monthStart.toISOString()} to ${monthEnd.toISOString()}`);\n            updateCount++;\n          }\n        }\n      }\n      \n      console.log(`üéâ MONTHLY DATE RANGE FIX COMPLETE: Updated ${updateCount} tasks`);\n      \n      res.json({\n        success: true,\n        message: `Fixed date ranges for ${updateCount} monthly tasks`,\n        updateCount\n      });\n      \n    } catch (error) {\n      console.error('‚ùå Monthly date range fix failed:', error);\n      res.status(500).json({ \n        success: false,\n        message: 'Failed to fix monthly date ranges', \n        error: error instanceof Error ? error.message : 'Unknown error' \n      });\n    }\n  });\n\n  // CRITICAL DATA REPAIR - Fix orphaned task instances by linking them to recurring task templates\n  app.post(\"/api/admin/repair-orphaned-task-linkage\", async (req, res) => {\n    try {\n      console.log('üîß REPAIRING ORPHANED TASK LINKAGE - FIXING CASCADE DELETION');\n      \n      // Call the comprehensive repair method from DatabaseStorage\n      const result = await (storage as any).repairOrphanedTaskLinkage();\n      \n      // Detailed logging for audit trail\n      console.log(`üìä REPAIR RESULTS:`);\n      console.log(`   Orphaned tasks found: ${result.orphanedTasksFound}`);\n      console.log(`   Tasks successfully linked: ${result.tasksLinked}`);\n      console.log(`   Unmatched tasks: ${result.unmatchedTasks}`);\n      console.log(`   Errors encountered: ${result.errors.length}`);\n      \n      if (result.errors.length > 0) {\n        console.log('‚ùå Repair errors:');\n        result.errors.forEach((error: string, index: number) => {\n          console.log(`   ${index + 1}. ${error}`);\n        });\n      }\n      \n      const successRate = result.orphanedTasksFound > 0 \n        ? Math.round((result.tasksLinked / result.orphanedTasksFound) * 100) \n        : 100;\n\n      console.log(`üéØ REPAIR COMPLETE: ${successRate}% success rate`);\n      \n      res.json({\n        success: true,\n        message: `Orphaned task linkage repair completed`,\n        results: {\n          orphanedTasksFound: result.orphanedTasksFound,\n          tasksLinked: result.tasksLinked,\n          unmatchedTasks: result.unmatchedTasks,\n          successRate: `${successRate}%`,\n          errorCount: result.errors.length\n        },\n        detailedReport: result.repairReport,\n        errors: result.errors\n      });\n      \n    } catch (error) {\n      console.error('‚ùå Orphaned task repair failed:', error);\n      res.status(500).json({\n        success: false,\n        message: 'Failed to repair orphaned task linkage',\n        error: error instanceof Error ? error.message : 'Unknown error'\n      });\n    }\n  });\n\n  // MANUAL BI-WEEKLY TASK CREATOR - Create missing tasks without foreign key issues\n  app.post(\"/api/admin/create-missing-biweekly\", async (req, res) => {\n    try {\n      console.log('üöÄ MANUALLY CREATING MISSING BI-WEEKLY TASKS');\n      \n      const tasksToCreate = [\n        {\n          title: \"Change Microgreen Reservoir Water and Clean Shelves\",\n          description: \"Change the water in the microgreen reservoir and clean all shelves\",\n          type: \"cleaning\"\n        },\n        {\n          title: \"Vacuum the Office and Lobby\", \n          description: \"Vacuum all office areas and lobby spaces\",\n          type: \"cleaning\"\n        },\n        {\n          title: \"Clean Outside Facing Lobby Window\",\n          description: \"Clean the exterior windows facing the lobby\",\n          type: \"cleaning\"\n        },\n        {\n          title: \"Interior Window Cleaning\",\n          description: \"Clean all interior windows throughout the facility\", \n          type: \"cleaning\"\n        }\n      ];\n      \n      let totalCreated = 0;\n      const currentYear = 2025;\n      const currentMonth = 8; // September (0-indexed)\n      \n      for (const taskTemplate of tasksToCreate) {\n        console.log(`Creating instances for: ${taskTemplate.title}`);\n        \n        // Create first half (Sept 1-15)\n        const firstHalfTask = {\n          title: taskTemplate.title,\n          description: taskTemplate.description,\n          type: taskTemplate.type,\n          status: 'pending' as const,\n          priority: 'medium' as const,\n          assignedTo: null,\n          createdBy: null,\n          location: 'K',\n          dueDate: new Date(currentYear, currentMonth, 15),\n          visibleFromDate: new Date(currentYear, currentMonth, 1),\n          frequency: 'bi-weekly',\n          recurringTaskId: null, // Skip foreign key to avoid constraint issues\n          isRecurring: true,\n          createdAt: new Date()\n        };\n        \n        // Create second half (Sept 16-30)\n        const secondHalfTask = {\n          title: taskTemplate.title,\n          description: taskTemplate.description,\n          type: taskTemplate.type,\n          status: 'pending' as const,\n          priority: 'medium' as const,\n          assignedTo: null,\n          createdBy: null,\n          location: 'K',\n          dueDate: new Date(currentYear, currentMonth, 30),\n          visibleFromDate: new Date(currentYear, currentMonth, 16),\n          frequency: 'bi-weekly',\n          recurringTaskId: null, // Skip foreign key to avoid constraint issues\n          isRecurring: true,\n          createdAt: new Date()\n        };\n        \n        try {\n          await storage.createTask(firstHalfTask);\n          await storage.createTask(secondHalfTask);\n          totalCreated += 2;\n          console.log(`‚úÖ Created both halves for: ${taskTemplate.title}`);\n        } catch (error) {\n          console.log(`‚ö†Ô∏è Failed ${taskTemplate.title}: ${error instanceof Error ? error.message : 'Unknown error'}`);\n        }\n      }\n      \n      console.log(`üéâ MANUAL BI-WEEKLY CREATION COMPLETE: Created ${totalCreated} tasks`);\n      \n      res.json({\n        success: true,\n        message: `Manually created ${totalCreated} bi-weekly task instances`,\n        totalCreated\n      });\n      \n    } catch (error) {\n      console.error('‚ùå Manual bi-weekly creation failed:', error);\n      res.status(500).json({ \n        success: false,\n        message: 'Failed to create bi-weekly tasks manually', \n        error: error instanceof Error ? error.message : 'Unknown error' \n      });\n    }\n  });\n\n  // SIMPLE BI-WEEKLY TASK GENERATOR - Create all missing bi-weekly tasks\n  app.post(\"/api/admin/create-all-biweekly-tasks\", async (req, res) => {\n    try {\n      console.log('üöÄ CREATING ALL BI-WEEKLY TASKS FOR SEPTEMBER');\n      \n      const recurringTasks = await storage.getAllRecurringTasks();\n      const biweeklyTasks = recurringTasks.filter(rt => rt.frequency === 'bi-weekly');\n      const existingTasks = await storage.getAllTasks();\n      \n      let totalCreated = 0;\n      const currentYear = 2025;\n      const currentMonth = 8; // September (0-indexed)\n      \n      for (const recurringTask of biweeklyTasks) {\n        console.log(`Creating instances for: ${recurringTask.title}`);\n        \n        // Check if tasks already exist for this recurring pattern\n        const existingForPattern = existingTasks.filter(t => \n          t.recurringTaskId === recurringTask.id && \n          t.frequency === 'bi-weekly'\n        );\n        \n        if (existingForPattern.length >= 2) {\n          console.log(`   ‚è≠Ô∏è  Already has ${existingForPattern.length} instances`);\n          continue;\n        }\n        \n        // Create first half (Sept 1-15) - only if doesn't exist\n        const hasFirstHalf = existingForPattern.some(t => \n          t.visibleFromDate ? new Date(t.visibleFromDate).getDate() === 1 : false\n        );\n        \n        if (!hasFirstHalf) {\n          const firstHalfTask = {\n            title: recurringTask.title,\n            description: recurringTask.description,\n            type: recurringTask.type,\n            status: 'pending' as const,\n            priority: 'medium' as const,\n            assignedTo: null,\n            createdBy: recurringTask.createdBy,\n            location: recurringTask.location,\n            dueDate: new Date(currentYear, currentMonth, 15),\n            visibleFromDate: new Date(currentYear, currentMonth, 1),\n            frequency: 'bi-weekly',\n            recurringTaskId: recurringTask.id,\n            isRecurring: true,\n            createdAt: new Date()\n          };\n          \n          try {\n            await storage.createTask(firstHalfTask);\n            totalCreated++;\n            console.log(`‚úÖ Created first half for: ${recurringTask.title}`);\n          } catch (error) {\n            console.log(`‚ö†Ô∏è Failed first half ${recurringTask.title}: ${error instanceof Error ? error.message : 'Unknown error'}`);\n          }\n        }\n        \n        // Create second half (Sept 16-30) - only if doesn't exist\n        const hasSecondHalf = existingForPattern.some(t => \n          t.visibleFromDate ? new Date(t.visibleFromDate).getDate() === 16 : false\n        );\n        \n        if (!hasSecondHalf) {\n          const secondHalfTask = {\n            title: recurringTask.title,\n            description: recurringTask.description,\n            type: recurringTask.type,\n            status: 'pending' as const,\n            priority: 'medium' as const,\n            assignedTo: null,\n            createdBy: recurringTask.createdBy,\n            location: recurringTask.location,\n            dueDate: new Date(currentYear, currentMonth, 30), // Sept 30\n            visibleFromDate: new Date(currentYear, currentMonth, 16),\n            frequency: 'bi-weekly',\n            recurringTaskId: recurringTask.id,\n            isRecurring: true,\n            createdAt: new Date()\n          };\n          \n          try {\n            await storage.createTask(secondHalfTask);\n            totalCreated++;\n            console.log(`‚úÖ Created second half for: ${recurringTask.title}`);\n          } catch (error) {\n            console.log(`‚ö†Ô∏è Failed second half ${recurringTask.title}: ${error instanceof Error ? error.message : 'Unknown error'}`);\n          }\n        }\n      }\n      \n      console.log(`üéâ BI-WEEKLY TASK CREATION COMPLETE: Created ${totalCreated} tasks`);\n      \n      res.json({\n        success: true,\n        message: `Created ${totalCreated} bi-weekly task instances`,\n        totalCreated\n      });\n      \n    } catch (error) {\n      console.error('‚ùå Bi-weekly task creation failed:', error);\n      res.status(500).json({ \n        success: false,\n        message: 'Failed to create bi-weekly tasks', \n        error: error instanceof Error ? error.message : 'Unknown error' \n      });\n    }\n  });\n\n  // PRODUCTION BLUEPRINT SYSTEM - Phase 1: Generation Engine Hardening\n  app.post(\"/api/admin/generate-blueprint-tasks\", async (req, res) => {\n    const userId = 1; // Admin user for system operations\n    const lockId = 'blueprint-task-generation';\n    \n    try {\n      console.log('üöÄ BLUEPRINT GENERATION ENGINE - Phase 1: Generation Hardening');\n      \n      // Step 1: Acquire system lock to prevent duplicates\n      const lock = await storage.acquireLock(lockId, userId, 'task_generation', 15);\n      if (!lock) {\n        console.log('‚è≥ Another generation process is running, skipping');\n        return res.status(423).json({\n          success: false,\n          message: 'Another task generation is in progress',\n          error: 'SYSTEM_LOCKED'\n        });\n      }\n\n      console.log(`üîí Generation lock acquired: ${lock.id}`);\n      \n      try {\n        // Step 2: Get all active recurring tasks\n        const recurringTasks = await storage.getAllRecurringTasks();\n        const activeRecurringTasks = recurringTasks.filter(rt => rt.isActive);\n        console.log(`üìã Processing ${activeRecurringTasks.length} active recurring tasks`);\n        \n        // Step 3: Get current time references\n        const now = new Date();\n        const currentYear = now.getFullYear();\n        const currentMonth = now.getMonth(); // 0-indexed\n        const today = new Date(currentYear, currentMonth, now.getDate());\n        \n        let totalCreated = 0;\n        let taskInstancesGenerated = 0;\n        \n        // Step 4: Process each recurring task with blueprint logic\n        for (const recurringTask of activeRecurringTasks) {\n          try {\n            console.log(`\\nüéØ Processing: \"${recurringTask.title}\" (${recurringTask.frequency})`);\n            \n            const generatedInstances = await generateBlueprintTaskInstances(\n              recurringTask, \n              today, \n              currentYear, \n              currentMonth\n            );\n            \n            totalCreated += generatedInstances.length;\n            taskInstancesGenerated += generatedInstances.length;\n            \n            if (generatedInstances.length > 0) {\n              console.log(`‚úÖ Generated ${generatedInstances.length} instances for \"${recurringTask.title}\"`);\n            }\n            \n          } catch (error) {\n            console.error(`‚ùå Failed to process \"${recurringTask.title}\":`, error);\n          }\n        }\n        \n        console.log(`\\nüéâ BLUEPRINT GENERATION COMPLETE:`);\n        console.log(`   üìä Total instances created: ${totalCreated}`);\n        console.log(`   üîÑ Recurring tasks processed: ${activeRecurringTasks.length}`);\n        \n        // Step 5: Release the lock\n        await storage.releaseLock(lockId);\n        console.log(`üîì Generation lock released`);\n        \n        res.json({\n          success: true,\n          message: `Blueprint generation complete`,\n          totalCreated,\n          recurringTasksProcessed: activeRecurringTasks.length,\n          generationTimestamp: now.toISOString()\n        });\n        \n      } catch (error) {\n        // Always release lock on error\n        await storage.releaseLock(lockId);\n        console.log(`üîì Lock released due to error`);\n        throw error;\n      }\n      \n    } catch (error) {\n      console.error('‚ùå Blueprint generation failed:', error);\n      res.status(500).json({\n        success: false,\n        message: 'Blueprint task generation failed',\n        error: error instanceof Error ? error.message : 'Unknown error'\n      });\n    }\n  });\n\n// Blueprint Generation Engine - Core Logic Functions (Module Level)\nasync function generateBlueprintTaskInstances(\n    recurringTask: any,\n    today: Date,\n    currentYear: number,\n    currentMonth: number\n  ): Promise<any[]> {\n    console.log(`üîß Blueprint generation for: ${recurringTask.title} (${recurringTask.frequency})`);\n    \n    const createdInstances: any[] = [];\n    \n    // Step 1: Generate instances for next 31 days from TODAY\n    const requiredInstances: Array<{\n      visibleFromDate: Date;\n      dueDate: Date;\n      label: string;\n    }> = [];\n    \n    const endDate = new Date(today);\n    endDate.setDate(today.getDate() + 31);\n    \n    const currentDate = new Date(today);\n    const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];\n    \n    console.log(`üìÖ Generating from ${formatDateYYYYMMDD(currentDate)} to ${formatDateYYYYMMDD(endDate)}`);\n    \n    while (currentDate <= endDate) {\n      let shouldGenerate = false;\n      const taskDate = new Date(currentDate); // Clone date for this instance\n      const dueDate = new Date(currentDate);  // Clone date for due date\n      \n      switch (recurringTask.frequency.toLowerCase()) {\n        case 'daily':\n          shouldGenerate = true;\n          dueDate.setDate(dueDate.getDate() + 1); // Due tomorrow\n          break;\n          \n        case 'weekly':\n          if (recurringTask.daysOfWeek && recurringTask.daysOfWeek.length > 0) {\n            const dayIndex = currentDate.getDay();\n            const dayName = dayNames[dayIndex];\n            const normalizedDays = recurringTask.daysOfWeek.map((d: string) => d.toLowerCase());\n            shouldGenerate = normalizedDays.includes(dayName);\n            if (shouldGenerate) {\n              dueDate.setDate(dueDate.getDate() + 7); // Due 7 days later\n            }\n          }\n          break;\n          \n        case 'bi-weekly':\n        case 'biweekly':\n          const dayOfMonth = currentDate.getDate();\n          if (dayOfMonth === 1 || dayOfMonth === 15) {\n            shouldGenerate = true;\n            if (dayOfMonth === 1) {\n              dueDate.setDate(14); // Due on 14th\n            } else {\n              dueDate.setMonth(dueDate.getMonth() + 1, 0); // Due on last day of month\n            }\n          }\n          break;\n          \n        case 'monthly':\n          if (currentDate.getDate() === 1) {\n            shouldGenerate = true;\n            dueDate.setMonth(dueDate.getMonth() + 1, 0); // Due on last day of month\n          }\n          break;\n          \n        case 'quarterly':\n          if (currentDate.getDate() === 1 && currentDate.getMonth() % 3 === 0) {\n            shouldGenerate = true;\n            dueDate.setMonth(dueDate.getMonth() + 3, 0); // Due on last day of quarter\n          }\n          break;\n      }\n      \n      if (shouldGenerate) {\n        const label = `${taskDate.getFullYear()}-${taskDate.getMonth() + 1}-${taskDate.getDate()}-${dayNames[taskDate.getDay()]}`;\n        console.log(`Generation loop - Day: ${taskDate.toISOString().split('T')[0]}, Creating: 1 task for ${recurringTask.title}`);\n        requiredInstances.push({\n          visibleFromDate: taskDate,\n          dueDate: dueDate,\n          label: label\n        });\n      }\n      \n      currentDate.setDate(currentDate.getDate() + 1); // Move to next day\n    }\n    \n    console.log(`üìÖ Generation loop complete - Created ${requiredInstances.length} instances for ${recurringTask.frequency}`);\n    \n    // Step 2: Check existing instances to avoid duplicates\n    const existingTasks = await storage.getAllTasks();\n    const existingInstances = existingTasks.filter(task => \n      task.recurringTaskId === recurringTask.id &&\n      task.isRecurring === true\n    );\n    \n    console.log(`üìù Found ${existingInstances.length} existing instances`);\n    \n    // Step 3: Create missing instances with blueprint specifications\n    for (const required of requiredInstances) {\n      // Check if this specific instance already exists\n      const instanceExists = existingInstances.some(existing => \n        existing.visibleFromDate && existing.dueDate &&\n        areDatesEqual(new Date(existing.visibleFromDate), required.visibleFromDate) &&\n        areDatesEqual(new Date(existing.dueDate), required.dueDate)\n      );\n      \n      if (!instanceExists) {\n        console.log(`üìù Creating instance: ${required.label}`);\n        \n        try {\n          // Blueprint Data Transfer - Copy ALL fields from template\n          const taskInstance = {\n            title: recurringTask.title,\n            description: recurringTask.description,\n            type: recurringTask.type,\n            status: 'pending' as const,\n            priority: 'medium' as const,\n            \n            // Assignment Logic - Use template assignment or default to null  \n            assignTo: recurringTask.assignTo || null, // New dynamic assignment system\n            assignedTo: null, // Legacy field for compatibility\n            \n            createdBy: recurringTask.createdBy,\n            location: recurringTask.location,\n            \n            // Blueprint Date Logic - Precise visibility and due dates\n            taskDate: required.visibleFromDate, // Primary filtering date\n            visibleFromDate: required.visibleFromDate, // When task becomes visible\n            dueDate: required.dueDate, // When task is due\n            \n            // Recurring Task Metadata\n            isRecurring: true,\n            recurringTaskId: recurringTask.id,\n            frequency: recurringTask.frequency,\n            \n            // Template Version Tracking for Update Propagation\n            templateVersion: recurringTask.versionNumber || 1,\n            isModifiedAfterCreation: false,\n            \n            // Advanced Checklist Transfer  \n            checklist: recurringTask.checklistTemplate ? \n              generateChecklistFromTemplate(recurringTask.checklistTemplate) : [],\n            \n            // Data Collection Container\n            data: {},\n            \n            // Time tracking\n            estimatedTime: null,\n            actualTime: null,\n            progress: 0,\n            \n            // Dates\n            startedAt: null,\n            completedAt: null,\n            pausedAt: null,\n            resumedAt: null,\n            skippedAt: null,\n            skipReason: null,\n            modifiedFromTemplateAt: null,\n            \n            createdAt: new Date()\n          };\n          \n          // Create the task instance\n          const createdTask = await storage.createTask(taskInstance);\n          createdInstances.push(createdTask);\n          \n          console.log(`‚úÖ Created: \"${taskInstance.title}\" | Visible: ${required.visibleFromDate.toDateString()} | Due: ${required.dueDate.toDateString()}`);\n          \n        } catch (error) {\n          console.error(`‚ùå Failed to create instance for ${recurringTask.title}:`, error);\n        }\n      } else {\n        console.log(`‚è≠Ô∏è Skipping existing instance: ${required.label}`);\n      }\n    }\n    \n    return createdInstances;\n  }\n\n// Calculate Required Instances - Blueprint Specification Logic\nfunction calculateRequiredInstances(\n    frequency: string,\n    currentYear: number,\n    currentMonth: number,\n    today: Date,\n    recurringTask?: any\n  ): Array<{\n    visibleFromDate: Date;\n    dueDate: Date;\n    label: string;\n    period?: string;\n  }> {\n    const instances: Array<{\n      visibleFromDate: Date;\n      dueDate: Date;\n      label: string;\n      period?: string;\n    }> = [];\n    \n    switch (frequency) {\n      case 'daily':\n        // Daily: Visible and due on same day\n        instances.push({\n          visibleFromDate: new Date(today),\n          dueDate: new Date(today),\n          label: `${currentYear}-${currentMonth + 1}-${today.getDate()}-daily`\n        });\n        break;\n        \n      case 'weekly':\n        // FIXED: Generate instances for ALL 31 days, but only on selected days of week\n        // Parse selected days from recurring task\n        let selectedDays: string[] = [];\n        if (recurringTask && recurringTask.daysOfWeek) {\n          try {\n            selectedDays = typeof recurringTask.daysOfWeek === 'string' \n              ? JSON.parse(recurringTask.daysOfWeek) \n              : recurringTask.daysOfWeek;\n          } catch (error) {\n            console.error('Failed to parse daysOfWeek:', error);\n          }\n        }\n        \n        const normalizedDays = selectedDays.map(d => d.toLowerCase());\n        const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];\n        \n        // Generate task for each day in next 31 days that matches selected days\n        for (let dayOffset = 0; dayOffset < 31; dayOffset++) {\n          const checkDate = new Date(today);\n          checkDate.setDate(today.getDate() + dayOffset);\n          \n          const dayIndex = checkDate.getDay(); // Use local day, not UTC\n          const dayName = dayNames[dayIndex];\n          \n          // Only create if this day matches selectedDays\n          if (normalizedDays.includes(dayName)) {\n            const dueDate = new Date(checkDate);\n            dueDate.setDate(checkDate.getDate() + 6); // Due 6 days later\n            \n            instances.push({\n              visibleFromDate: new Date(checkDate),\n              dueDate: dueDate,\n              label: `${checkDate.getFullYear()}-${checkDate.getMonth() + 1}-${checkDate.getDate()}-${dayName}`\n            });\n          }\n        }\n        break;\n        \n      case 'bi-weekly':\n      case 'biweekly':\n        // BI-WEEKLY BLUEPRINT SPECIFICATION - EXACT IMPLEMENTATION\n        console.log(`üìÖ Bi-weekly logic: Today is ${today.getDate()}th of month`);\n        \n        // First Half: Days 1-14 (visible Sept 1-14, due Sept 14)\n        const firstHalf = {\n          visibleFromDate: new Date(currentYear, currentMonth, 1),\n          dueDate: new Date(currentYear, currentMonth, 14),\n          label: `${currentYear}-${currentMonth + 1}-1st-14th`,\n          period: \"1st-14th\"\n        };\n        \n        // Second Half: Days 15-end (visible Sept 15-30, due last day)\n        const secondHalf = {\n          visibleFromDate: new Date(currentYear, currentMonth, 15),\n          dueDate: new Date(currentYear, currentMonth + 1, 0), // Last day of month\n          label: `${currentYear}-${currentMonth + 1}-15th-end`,\n          period: \"15th-end\"\n        };\n        \n        instances.push(firstHalf, secondHalf);\n        \n        console.log(`üìÖ First half: ${firstHalf.visibleFromDate.toDateString()} ‚Üí ${firstHalf.dueDate.toDateString()}`);\n        console.log(`üìÖ Second half: ${secondHalf.visibleFromDate.toDateString()} ‚Üí ${secondHalf.dueDate.toDateString()}`);\n        break;\n        \n      case 'monthly':\n        // Monthly: Visible all month, due on last day\n        instances.push({\n          visibleFromDate: new Date(currentYear, currentMonth, 1),\n          dueDate: new Date(currentYear, currentMonth + 1, 0),\n          label: `${currentYear}-${currentMonth + 1}-monthly`\n        });\n        break;\n        \n      case 'quarterly':\n        // Quarterly: Visible all quarter, due on last day of quarter\n        const quarterStart = Math.floor(currentMonth / 3) * 3;\n        instances.push({\n          visibleFromDate: new Date(currentYear, quarterStart, 1),\n          dueDate: new Date(currentYear, quarterStart + 3, 0),\n          label: `${currentYear}-Q${Math.floor(currentMonth / 3) + 1}`\n        });\n        break;\n        \n      default:\n        console.log(`‚ö†Ô∏è Unsupported frequency: ${frequency}`);\n        break;\n    }\n    \n    return instances;\n  }\n\n// Advanced Checklist Generation from Template\nfunction generateChecklistFromTemplate(checklistTemplate: any): any[] {\n    if (!checklistTemplate || !checklistTemplate.steps) {\n      return [];\n    }\n    \n    return checklistTemplate.steps.map((step: any, index: number) => ({\n      id: `step-${index + 1}`,\n      text: step.text || step.label || '',\n      type: step.type || 'instruction',\n      completed: false,\n      required: step.required || false,\n      config: {\n        inventoryCategory: step.inventoryCategory,\n        min: step.min,\n        max: step.max,\n        default: step.default,\n        systemType: step.systemType,\n        autoSuggest: step.autoSuggest,\n        dataType: step.dataType,\n        calculation: step.calculation\n      },\n      data: null,\n      dataCollection: step.type === 'data-capture' ? {\n        type: step.dataType || 'text',\n        label: step.label || '',\n        value: null\n      } : undefined\n    }));\n  }\n\n// Utility function for precise date comparison\nfunction areDatesEqual(date1: Date, date2: Date): boolean {\n    return date1.getFullYear() === date2.getFullYear() &&\n           date1.getMonth() === date2.getMonth() &&\n           date1.getDate() === date2.getDate();\n  }\n\n// AUTOMATED TASK GENERATION SYSTEM - 31-Day Rolling Buffer\nasync function runAutomatedTaskGeneration(userId: number = 1): Promise<{\n  success: boolean;\n  tasksCreated: number;\n  generatedThrough: string;\n  message: string;\n}> {\n  const lockId = 'automated-task-generation';\n  \n  try {\n    // Step 1: Acquire system lock\n    const lock = await storage.acquireLock(lockId, userId, 'automated_generation', 5);\n    if (!lock) {\n      console.log('‚è≠Ô∏è Generation already running, skipping');\n      return { success: false, tasksCreated: 0, generatedThrough: '', message: 'Generation already running' };\n    }\n\n    console.log('ü§ñ AUTOMATED TASK GENERATION - Starting 31-day buffer maintenance');\n    \n    try {\n      const today = new Date();\n      today.setHours(0, 0, 0, 0);\n      const todayStr = formatDateYYYYMMDD(today);\n      \n      // Step 2: Check last generation date\n      const generationStatus = await storage.getSystemStatus('task-generation-status');\n      const lastGenDate = generationStatus?.lastGenerationDate || null;\n      \n      console.log(`üìÖ Last generation: ${lastGenDate || 'Never'}`);\n      console.log(`üìÖ Today: ${todayStr}`);\n      \n      // Step 3: Determine generation range\n      let startDate: Date;\n      if (!lastGenDate || lastGenDate < todayStr) {\n        // Never run or outdated - start from today\n        startDate = new Date(today);\n      } else {\n        // Already run today - nothing to do\n        console.log('‚úÖ Already generated today, buffer is current');\n        await storage.releaseLock(lockId);\n        return { \n          success: true, \n          tasksCreated: 0, \n          generatedThrough: generationStatus?.generatedThrough || todayStr,\n          message: 'Generation already current'\n        };\n      }\n      \n      // Calculate end date (today + 31 days)\n      const endDate = new Date(today);\n      endDate.setDate(today.getDate() + 31);\n      const endDateStr = formatDateYYYYMMDD(endDate);\n      \n      console.log(`üìä Generating tasks from ${formatDateYYYYMMDD(startDate)} to ${endDateStr}`);\n      \n      // Step 4: Get all active recurring tasks\n      const recurringTasks = await storage.getAllRecurringTasks();\n      const activeRecurringTasks = recurringTasks.filter(rt => rt.isActive);\n      console.log(`üîÑ Processing ${activeRecurringTasks.length} active recurring tasks`);\n      \n      // Step 5: Generate tasks for each date in range\n      let totalCreated = 0;\n      \n      for (let dayOffset = 0; dayOffset <= 31; dayOffset++) {\n        const currentDate = new Date(startDate);\n        currentDate.setDate(startDate.getDate() + dayOffset);\n        \n        const tasksForDate = await generateTasksForDate(currentDate, activeRecurringTasks);\n        if (tasksForDate > 0) {\n          console.log(`üìÖ Automated generation - Day ${dayOffset}: ${formatDateYYYYMMDD(currentDate)}, Created: ${tasksForDate} tasks`);\n        }\n        totalCreated += tasksForDate;\n      }\n      \n      // Step 6: Update generation status\n      await storage.setSystemStatus({\n        id: 'task-generation-status',\n        lastGenerationDate: todayStr,\n        generatedThrough: endDateStr,\n        lastUpdateBy: userId\n      });\n      \n      console.log(`‚úÖ AUTOMATED GENERATION COMPLETE:`);\n      console.log(`   üìä Tasks created: ${totalCreated}`);\n      console.log(`   üìÖ Buffer extends through: ${endDateStr}`);\n      \n      await storage.releaseLock(lockId);\n      \n      return {\n        success: true,\n        tasksCreated: totalCreated,\n        generatedThrough: endDateStr,\n        message: `Generated ${totalCreated} tasks through ${endDateStr}`\n      };\n      \n    } catch (error) {\n      await storage.releaseLock(lockId);\n      throw error;\n    }\n    \n  } catch (error) {\n    console.error('‚ùå Automated generation failed:', error);\n    return {\n      success: false,\n      tasksCreated: 0,\n      generatedThrough: '',\n      message: error instanceof Error ? error.message : 'Unknown error'\n    };\n  }\n}\n\n// Generate tasks for a specific date based on recurring task templates\nasync function generateTasksForDate(date: Date, recurringTasks: any[]): Promise<number> {\n  let created = 0;\n  const dateStr = formatDateYYYYMMDD(date);\n  const dayOfWeek = date.getDay(); // 0 = Sunday, 1 = Monday, etc.\n  const dayOfMonth = date.getDate();\n  const isFirstOfMonth = dayOfMonth === 1;\n  const isFifteenthOfMonth = dayOfMonth === 15;\n  const isStartOfQuarter = isFirstOfMonth && (date.getMonth() % 3 === 0);\n  \n  for (const recurringTask of recurringTasks) {\n    let shouldGenerate = false;\n    let visibleFrom: Date | null = null;\n    let dueDate: Date | null = null;\n    \n    switch (recurringTask.frequency.toLowerCase()) {\n      case 'daily':\n        shouldGenerate = true;\n        visibleFrom = new Date(date);\n        dueDate = new Date(date);\n        break;\n        \n      case 'weekly':\n        // Check if this day of week matches\n        if (recurringTask.daysOfWeek && recurringTask.daysOfWeek.length > 0) {\n          const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];\n          const currentDayName = dayNames[dayOfWeek];\n          shouldGenerate = recurringTask.daysOfWeek.map((d: string) => d.toLowerCase()).includes(currentDayName);\n        }\n        if (shouldGenerate) {\n          visibleFrom = new Date(date.getFullYear(), date.getMonth(), date.getDate());\n          dueDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());\n        }\n        break;\n        \n      case 'bi-weekly':\n      case 'biweekly':\n        // First half (1st-14th) - generate on 1st\n        if (isFirstOfMonth) {\n          shouldGenerate = true;\n          visibleFrom = new Date(date.getFullYear(), date.getMonth(), 1);\n          dueDate = new Date(date.getFullYear(), date.getMonth(), 14);\n        }\n        // Second half (15th-end) - generate on 15th\n        else if (isFifteenthOfMonth) {\n          shouldGenerate = true;\n          visibleFrom = new Date(date.getFullYear(), date.getMonth(), 15);\n          dueDate = new Date(date.getFullYear(), date.getMonth() + 1, 0); // Last day of month\n        }\n        break;\n        \n      case 'monthly':\n        // Generate on first of month or specific day\n        if (recurringTask.dayOfMonth) {\n          shouldGenerate = dayOfMonth === recurringTask.dayOfMonth;\n        } else {\n          shouldGenerate = isFirstOfMonth;\n        }\n        if (shouldGenerate) {\n          visibleFrom = new Date(date.getFullYear(), date.getMonth(), 1);\n          dueDate = new Date(date.getFullYear(), date.getMonth() + 1, 0);\n        }\n        break;\n        \n      case 'quarterly':\n        shouldGenerate = isStartOfQuarter;\n        if (shouldGenerate) {\n          const quarterStart = Math.floor(date.getMonth() / 3) * 3;\n          visibleFrom = new Date(date.getFullYear(), quarterStart, 1);\n          dueDate = new Date(date.getFullYear(), quarterStart + 3, 0);\n        }\n        break;\n    }\n    \n    if (shouldGenerate && visibleFrom && dueDate) {\n      // Check if task already exists\n      const existingTasks = await storage.getAllTasks();\n      const taskExists = existingTasks.some(t => \n        t.recurringTaskId === recurringTask.id &&\n        t.visibleFromDate &&\n        areDatesEqual(new Date(t.visibleFromDate), visibleFrom!) &&\n        t.dueDate &&\n        areDatesEqual(new Date(t.dueDate), dueDate!)\n      );\n      \n      if (!taskExists) {\n        // Create the task instance\n        try {\n          await storage.createTask({\n            title: recurringTask.title,\n            description: recurringTask.description,\n            type: recurringTask.type,\n            status: 'pending',\n            priority: 'medium',\n            assignTo: recurringTask.assignTo || null,\n            assignedTo: null,\n            createdBy: recurringTask.createdBy,\n            location: recurringTask.location,\n            taskDate: visibleFrom,\n            visibleFromDate: visibleFrom,\n            dueDate: dueDate,\n            isRecurring: true,\n            recurringTaskId: recurringTask.id,\n            frequency: recurringTask.frequency,\n            templateVersion: recurringTask.versionNumber || 1,\n            isModifiedAfterCreation: false,\n            checklist: recurringTask.checklistTemplate ? \n              generateChecklistFromTemplate(recurringTask.checklistTemplate) : [],\n            data: {},\n            estimatedTime: null,\n            actualTime: null,\n            progress: 0,\n            startedAt: null,\n            completedAt: null,\n            pausedAt: null,\n            resumedAt: null,\n            skippedAt: null,\n            skipReason: null,\n            modifiedFromTemplateAt: null\n          });\n          created++;\n          console.log(`   ‚úÖ ${dateStr}: Created \"${recurringTask.title}\"`);\n        } catch (error) {\n          console.error(`   ‚ùå ${dateStr}: Failed to create \"${recurringTask.title}\":`, error);\n        }\n      }\n    }\n  }\n  \n  return created;\n}\n\n// Helper function to format date as YYYY-MM-DD\nfunction formatDateYYYYMMDD(date: Date): string {\n  const year = date.getFullYear();\n  const month = String(date.getMonth() + 1).padStart(2, '0');\n  const day = String(date.getDate()).padStart(2, '0');\n  return `${year}-${month}-${day}`;\n}\n\n  // API: Get generation status (read-only monitoring)\n  app.get(\"/api/admin/generation-status\", async (req, res) => {\n    try {\n      const status = await storage.getSystemStatus('task-generation-status');\n      const today = formatDateYYYYMMDD(new Date());\n      \n      if (!status || !status.lastGenerationDate) {\n        return res.json({\n          lastGeneration: null,\n          generatedThrough: null,\n          health: 'RED',\n          message: 'Never generated - system needs initialization',\n          totalFutureTasks: 0\n        });\n      }\n      \n      const lastGenDate = status.lastGenerationDate;\n      const generatedThrough = status.generatedThrough || lastGenDate;\n      \n      // Calculate health status\n      let health: 'GREEN' | 'YELLOW' | 'RED';\n      if (lastGenDate >= today) {\n        health = 'GREEN';\n      } else if (lastGenDate >= formatDateYYYYMMDD(new Date(Date.now() - 86400000))) {\n        health = 'YELLOW';\n      } else {\n        health = 'RED';\n      }\n      \n      // Count future tasks\n      const allTasks = await storage.getAllTasks();\n      const futureTasks = allTasks.filter(t => \n        t.taskDate && new Date(t.taskDate) >= new Date()\n      );\n      \n      res.json({\n        lastGeneration: lastGenDate,\n        generatedThrough: generatedThrough,\n        health,\n        message: health === 'GREEN' ? 'System healthy' : \n                 health === 'YELLOW' ? 'Generation slightly outdated' : \n                 'Generation critically outdated',\n        totalFutureTasks: futureTasks.length,\n        lastUpdateBy: status.lastUpdateBy,\n        updatedAt: status.updatedAt\n      });\n      \n    } catch (error) {\n      res.status(500).json({\n        error: 'Failed to fetch generation status',\n        message: error instanceof Error ? error.message : 'Unknown error'\n      });\n    }\n  });\n\n  // API: Trigger automated generation (for testing/manual override)\n  app.post(\"/api/admin/trigger-generation\", async (req, res) => {\n    const userId = req.body.userId || 1;\n    const result = await runAutomatedTaskGeneration(userId);\n    res.json(result);\n  });\n\n  app.post(\"/api/admin/generate-dynamic-recurring\", async (req, res) => {\n    try {\n      console.log('üöÄ PRODUCTION RECURRING TASK GENERATION - FIX FOREIGN KEY ISSUE');\n      \n      // Get recurring tasks from database storage (not memory)\n      const recurringTasks = await storage.getAllRecurringTasks();\n      const allTasks = await storage.getAllTasks();\n      \n      console.log(`üìã Found ${recurringTasks.length} recurring tasks in database`);\n      \n      const today = new Date();\n      const currentYear = today.getFullYear();\n      const currentMonth = today.getMonth(); // 0-indexed\n      let totalCreated = 0;\n      \n      // Process EVERY recurring task pattern in the database\n      for (const recurringTask of recurringTasks) {\n        const { frequency, id: recurringId, title } = recurringTask;\n        \n        if (!frequency || frequency === 'daily' || frequency === 'weekly') {\n          continue; // Skip daily/weekly - handled by existing system\n        }\n        \n        console.log(`Processing: ${title} (${frequency}) - ID: ${recurringId}`);\n        \n        // VALIDATE: This recurring task already came from getAllRecurringTasks, so it exists\n        console.log(`   ‚úÖ Processing verified recurring task: ${title}`);\n        \n        // Check existing instances for this recurring pattern\n        const existingInstances = allTasks.filter(t => \n          t.recurringTaskId === recurringId &&\n          t.frequency === frequency\n        );\n        \n        console.log(`   Found ${existingInstances.length} existing instances`);\n        \n        // Determine what instances should exist for this frequency\n        let requiredInstances: Array<{visibleFrom: Date, dueDate: Date, label: string, periodLabel?: string}> = [];\n        \n        if (frequency === 'monthly') {\n          // Monthly: One instance per month with full month visibility\n          requiredInstances = [{\n            visibleFrom: new Date(currentYear, currentMonth, 1),\n            dueDate: new Date(currentYear, currentMonth + 1, 0), // Last day of month\n            label: `${currentYear}-${currentMonth + 1}` // Sept = month 9\n          }];\n        } else if (frequency === 'bi-weekly' || frequency === 'biweekly') {\n          // BI-WEEKLY: Two separate tasks per month exactly as specified\n          const today = new Date();\n          const dayOfMonth = today.getDate();\n          \n          console.log(`   üìÖ Bi-weekly logic: Today is ${dayOfMonth}th of month`);\n          \n          // First Half: Days 1-14 (visible Sept 1-14, due Sept 14)\n          const firstHalf = {\n            visibleFrom: new Date(currentYear, currentMonth, 1),\n            dueDate: new Date(currentYear, currentMonth, 14), // Due on 14th as specified\n            label: `${currentYear}-${currentMonth + 1}-1st-14th`,\n            periodLabel: \"1st-14th\"\n          };\n          \n          // Second Half: Days 15-end (visible Sept 15-30, due last day)\n          const secondHalf = {\n            visibleFrom: new Date(currentYear, currentMonth, 15),\n            dueDate: new Date(currentYear, currentMonth + 1, 0), // Last day of month\n            label: `${currentYear}-${currentMonth + 1}-15th-end`,\n            periodLabel: \"15th-31st\"\n          };\n          \n          requiredInstances = [firstHalf, secondHalf];\n          \n          console.log(`   üìÖ First half: ${firstHalf.visibleFrom.toDateString()} - ${firstHalf.dueDate.toDateString()}`);\n          console.log(`   üìÖ Second half: ${secondHalf.visibleFrom.toDateString()} - ${secondHalf.dueDate.toDateString()}`);\n        } else if (frequency === 'quarterly') {\n          // Quarterly: One instance per quarter with full quarter visibility\n          const quarterStart = Math.floor(currentMonth / 3) * 3;\n          requiredInstances = [{\n            visibleFrom: new Date(currentYear, quarterStart, 1),\n            dueDate: new Date(currentYear, quarterStart + 3, 0),\n            label: `${currentYear}-Q${Math.floor(currentMonth / 3) + 1}`\n          }];\n        }\n        \n        // Create missing instances\n        for (const required of requiredInstances) {\n          // Check if this specific instance already exists\n          const exists = existingInstances.some(existing => {\n            const existingVisible = existing.visibleFromDate ? new Date(existing.visibleFromDate) : null;\n            const existingDue = existing.dueDate ? new Date(existing.dueDate) : null;\n            return existingVisible && existingDue &&\n                   existingVisible.getTime() === required.visibleFrom.getTime() &&\n                   existingDue.getTime() === required.dueDate.getTime();\n          });\n          \n          if (!exists) {\n            console.log(`   Creating instance: ${required.label}`);\n            \n            // CLEAN TITLE FORMAT: No period labels in title, use clean names\n            const taskTitle = recurringTask.title; // Keep original title clean\n            \n            const newInstance = {\n              title: taskTitle,\n              description: recurringTask.description,\n              type: recurringTask.type,\n              status: 'pending' as const,\n              priority: 'medium' as const,\n              assignedTo: null, // Will be handled by assignment logic\n              createdBy: recurringTask.createdBy,\n              location: recurringTask.location,\n              dueDate: required.dueDate,\n              visibleFromDate: required.visibleFrom,\n              frequency: frequency,\n              recurringTaskId: recurringId, // Proper foreign key reference\n              isRecurring: true,\n              createdAt: new Date()\n            };\n            \n            try {\n              await storage.createTask(newInstance);\n              totalCreated++;\n              console.log(`   ‚úÖ Created: ${title} for ${required.label}`);\n            } catch (error) {\n              console.log(`   ‚ùå Failed to create ${title}: ${error instanceof Error ? error.message : 'Unknown error'}`);\n              // Continue processing other tasks even if one fails\n            }\n          } else {\n            console.log(`   ‚è≠Ô∏è  Instance already exists for ${required.label}`);\n          }\n        }\n      }\n      \n      console.log(`üéâ PRODUCTION RECURRING GENERATION COMPLETE: Created ${totalCreated} tasks`);\n      \n      res.json({\n        success: true,\n        message: `Generated ${totalCreated} recurring task instances`,\n        totalCreated\n      });\n      \n    } catch (error) {\n      console.error('‚ùå Production recurring generation failed:', error);\n      res.status(500).json({ \n        success: false,\n        message: 'Failed to generate dynamic recurring tasks', \n        error: error instanceof Error ? error.message : 'Unknown error' \n      });\n    }\n  });\n\n  // OLD SYSTEM - DEPRECATED\n  app.post(\"/api/admin/old-generate-dynamic-recurring\", async (req, res) => {\n    try {\n      console.log('üöÄ OLD DYNAMIC RECURRING TASK GENERATION');\n      \n      const recurringTasks = await storage.getAllRecurringTasks();\n      const allTasks = await storage.getAllTasks();\n      \n      const today = new Date();\n      let totalCreated = 0;\n      \n      for (const recurringTask of recurringTasks) {\n        const { frequency } = recurringTask;\n        \n        if (!frequency || frequency === 'daily' || frequency === 'weekly') {\n          continue; // Skip daily/weekly - they're handled by existing system\n        }\n        \n        console.log(`Processing: ${recurringTask.title} (${frequency})`);\n        \n        // Check if task instance already exists for this period\n        const existingTask = allTasks.find(t => \n          t.recurringTaskId === recurringTask.id &&\n          t.frequency === frequency &&\n          t.visibleFromDate && new Date(t.visibleFromDate).getMonth() === today.getMonth() &&\n          t.visibleFromDate && new Date(t.visibleFromDate).getFullYear() === today.getFullYear()\n        );\n        \n        if (existingTask) {\n          console.log(`   ‚è≠Ô∏è  Task already exists for this period`);\n          continue;\n        }\n        \n        let visibleFromDate, dueDate;\n        \n        // DYNAMIC FREQUENCY HANDLING\n        if (frequency === 'monthly') {\n          // Monthly: visible all month\n          visibleFromDate = new Date(today.getFullYear(), today.getMonth(), 1);\n          dueDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);\n          \n        } else if (frequency === 'biweekly' || frequency === 'bi-weekly') {\n          // Bi-weekly: create BOTH halves of the month for each pattern\n          // This ensures all bi-weekly tasks get proper instances\n          \n          // Create first half instance (1st-15th)\n          const firstHalfVisible = new Date(today.getFullYear(), today.getMonth(), 1);\n          const firstHalfDue = new Date(today.getFullYear(), today.getMonth(), 15);\n          \n          // Check if first half already exists\n          const existingFirstHalf = allTasks.find(t => \n            t.recurringTaskId === recurringTask.id &&\n            t.frequency === frequency &&\n            t.visibleFromDate && new Date(t.visibleFromDate).getDate() === 1 &&\n            t.visibleFromDate && new Date(t.visibleFromDate).getMonth() === today.getMonth()\n          );\n          \n          if (!existingFirstHalf) {\n            visibleFromDate = firstHalfVisible;\n            dueDate = firstHalfDue;\n            console.log(`   üìÖ Creating first half (1st-15th)`);\n          } else {\n            // Create second half instance (16th-end)\n            const secondHalfVisible = new Date(today.getFullYear(), today.getMonth(), 16);\n            const secondHalfDue = new Date(today.getFullYear(), today.getMonth() + 1, 0);\n            \n            // Check if second half already exists\n            const existingSecondHalf = allTasks.find(t => \n              t.recurringTaskId === recurringTask.id &&\n              t.frequency === frequency &&\n              t.visibleFromDate && new Date(t.visibleFromDate).getDate() >= 16 &&\n              t.visibleFromDate && new Date(t.visibleFromDate).getMonth() === today.getMonth()\n            );\n            \n            if (!existingSecondHalf) {\n              visibleFromDate = secondHalfVisible;\n              dueDate = secondHalfDue;\n              console.log(`   üìÖ Creating second half (16th-end)`);\n            } else {\n              console.log(`   ‚è≠Ô∏è  Both halves already exist for this month`);\n              continue;\n            }\n          }\n          \n        } else if (frequency === 'quarterly') {\n          // Quarterly: visible all quarter\n          const currentQuarter = Math.floor(today.getMonth() / 3);\n          const quarterStartMonth = currentQuarter * 3;\n          \n          visibleFromDate = new Date(today.getFullYear(), quarterStartMonth, 1);\n          dueDate = new Date(today.getFullYear(), quarterStartMonth + 3, 0);\n          \n        } else {\n          console.log(`   ‚ö†Ô∏è  Unknown frequency: ${frequency}`);\n          continue;\n        }\n        \n        // Create the task instance - handle role assignments by leaving them unassigned\n        let assignedTo = null;\n        if (recurringTask.assignTo) {\n          // For now, skip role assignments to avoid database errors\n          // Only handle direct user ID assignments\n          if (typeof recurringTask.assignTo === 'string' && !recurringTask.assignTo.startsWith('role_')) {\n            if (!isNaN(parseInt(recurringTask.assignTo))) {\n              assignedTo = parseInt(recurringTask.assignTo);\n            }\n          }\n          // Role assignments will be handled after task creation\n        }\n\n        const newTask = {\n          title: recurringTask.title,\n          description: recurringTask.description,\n          type: recurringTask.type,\n          status: 'pending' as const,\n          priority: 'medium' as const,\n          assignedTo: assignedTo,\n          createdBy: recurringTask.createdBy,\n          location: recurringTask.location,\n          dueDate,\n          visibleFromDate,\n          frequency,\n          recurringTaskId: recurringTask.id,\n          isRecurring: true,\n          createdAt: new Date()\n        };\n        \n        await storage.createTask(newTask);\n        totalCreated++;\n        \n        console.log(`   ‚úÖ Created ${frequency} task: ${recurringTask.title}`);\n        console.log(`      Visible: ${visibleFromDate.toISOString().split('T')[0]} to ${dueDate.toISOString().split('T')[0]}`);\n      }\n      \n      console.log(`üéâ DYNAMIC GENERATION COMPLETE: Created ${totalCreated} tasks`);\n      \n      res.json({\n        success: true,\n        message: `Generated ${totalCreated} recurring tasks`,\n        totalCreated,\n        processedPatterns: recurringTasks.length\n      });\n      \n    } catch (error) {\n      console.error('‚ùå Dynamic generation failed:', error);\n      res.status(500).json({ \n        success: false,\n        message: 'Failed to generate dynamic recurring tasks', \n        error: error instanceof Error ? error.message : 'Unknown error' \n      });\n    }\n  });\n\n  // Force generate monthly/bi-weekly/quarterly tasks for current period\n  app.post(\"/api/admin/force-generate-period-tasks\", async (req, res) => {\n    try {\n      console.log('üöÄ FORCE GENERATING MONTHLY/BI-WEEKLY/QUARTERLY TASKS');\n      \n      const today = new Date();\n      const year = today.getFullYear();\n      const month = today.getMonth();\n      \n      const recurringTasks = await storage.getAllRecurringTasks();\n      const periodicTasks = recurringTasks.filter(rt => \n        ['monthly', 'biweekly', 'quarterly'].includes(rt.frequency)\n      );\n      \n      console.log(`Found ${periodicTasks.length} periodic recurring tasks`);\n      \n      let createdCount = 0;\n      \n      for (const recurringTask of periodicTasks) {\n        console.log(`Processing: ${recurringTask.title} (${recurringTask.frequency})`);\n        \n        if (recurringTask.frequency === 'monthly') {\n          // Monthly task: visible Sept 1 - Sept 30, due Sept 30\n          const visibleFrom = new Date(year, month, 1);\n          const lastDay = new Date(year, month + 1, 0);\n          \n          const taskId = `${recurringTask.id}-${year}-${String(month + 1).padStart(2, '0')}`;\n          \n          const existingTask = await storage.getTask(parseInt(taskId)) || \n                              (await storage.getAllTasks()).find(t => \n                                t.title === recurringTask.title && \n                                t.dueDate && new Date(t.dueDate).getMonth() === month\n                              );\n          \n          if (!existingTask) {\n            const newTask = {\n              title: recurringTask.title,\n              description: recurringTask.description,\n              type: recurringTask.type,\n              status: 'pending' as const,\n              priority: 'medium' as const,\n              assignedTo: recurringTask.assignTo ? parseInt(recurringTask.assignTo as string) || null : null,\n              createdBy: recurringTask.createdBy,\n              location: recurringTask.location,\n              dueDate: lastDay,\n              visibleFromDate: visibleFrom,\n              frequency: 'monthly',\n              recurringTaskId: recurringTask.id,\n              isRecurring: true,\n              createdAt: new Date()\n            };\n            \n            await storage.createTask(newTask);\n            createdCount++;\n            console.log(`‚úÖ Created monthly task: ${recurringTask.title}`);\n          }\n        }\n        \n        if (recurringTask.frequency === 'biweekly') {\n          // Bi-weekly tasks: 1st-14th and 15th-end\n          const today = new Date();\n          const dayOfMonth = today.getDate();\n          \n          // First half (1st-14th)\n          const firstHalfVisible = new Date(year, month, 1);\n          const firstHalfDue = new Date(year, month, 14);\n          \n          const firstTaskId = `${recurringTask.id}-${year}-${String(month + 1).padStart(2, '0')}-01`;\n          const existingFirst = (await storage.getAllTasks()).find(t => \n            t.title === recurringTask.title && \n            t.dueDate && new Date(t.dueDate).getDate() <= 14 &&\n            new Date(t.dueDate).getMonth() === month\n          );\n          \n          if (!existingFirst) {\n            const firstTask = {\n              title: recurringTask.title + \" (1st Half)\",\n              description: recurringTask.description,\n              type: recurringTask.type,\n              status: 'pending' as const,\n              priority: 'medium' as const,\n              assignedTo: recurringTask.assignTo ? parseInt(recurringTask.assignTo as string) || null : null,\n              createdBy: recurringTask.createdBy,\n              location: recurringTask.location,\n              dueDate: firstHalfDue,\n              visibleFromDate: firstHalfVisible,\n              frequency: 'biweekly',\n              recurringTaskId: recurringTask.id,\n              isRecurring: true,\n              createdAt: new Date()\n            };\n            \n            await storage.createTask(firstTask);\n            createdCount++;\n            console.log(`‚úÖ Created bi-weekly task (1st half): ${recurringTask.title}`);\n          }\n          \n          // Second half (15th-end)\n          const secondHalfVisible = new Date(year, month, 15);\n          const lastDay = new Date(year, month + 1, 0);\n          \n          const existingSecond = (await storage.getAllTasks()).find(t => \n            t.title.includes(recurringTask.title) && \n            t.dueDate && new Date(t.dueDate).getDate() > 14 &&\n            new Date(t.dueDate).getMonth() === month\n          );\n          \n          if (!existingSecond) {\n            const secondTask = {\n              title: recurringTask.title + \" (2nd Half)\",\n              description: recurringTask.description,\n              type: recurringTask.type,\n              status: 'pending' as const,\n              priority: 'medium' as const,\n              assignedTo: recurringTask.assignTo ? parseInt(recurringTask.assignTo as string) || null : null,\n              createdBy: recurringTask.createdBy,\n              location: recurringTask.location,\n              dueDate: lastDay,\n              visibleFromDate: secondHalfVisible,\n              frequency: 'biweekly',\n              recurringTaskId: recurringTask.id,\n              isRecurring: true,\n              createdAt: new Date()\n            };\n            \n            await storage.createTask(secondTask);\n            createdCount++;\n            console.log(`‚úÖ Created bi-weekly task (2nd half): ${recurringTask.title}`);\n          }\n        }\n      }\n      \n      console.log(`üéâ PERIODIC TASK GENERATION COMPLETE: Created ${createdCount} tasks`);\n      \n      res.json({\n        success: true,\n        message: `Generated ${createdCount} periodic tasks`,\n        createdCount,\n        periodicPatterns: periodicTasks.length\n      });\n      \n    } catch (error) {\n      console.error('‚ùå Periodic task generation failed:', error);\n      res.status(500).json({ \n        success: false,\n        message: 'Failed to generate periodic tasks', \n        error: error instanceof Error ? error.message : 'Unknown error' \n      });\n    }\n  });\n\n  // Cleanup endpoint - Remove all daily task instances using batch delete\n  app.post(\"/api/admin/cleanup-daily-tasks\", async (req, res) => {\n    try {\n      console.log('üßπ CLEANING UP DAILY TASK INSTANCES (BATCH DELETE)');\n      \n      // Use direct SQL for fast batch delete\n      const result = await db.execute(sql`\n        DELETE FROM tasks \n        WHERE recurring_task_id IN (\n          SELECT id FROM recurring_tasks WHERE frequency = 'daily'\n        )\n      `);\n      \n      const deletedCount = result.rowCount || 0;\n      console.log(`‚úÖ Deleted ${deletedCount} daily task instances`);\n      \n      res.json({\n        success: true,\n        message: `Deleted ${deletedCount} daily task instances`,\n        deletedCount\n      });\n      \n    } catch (error) {\n      console.error('‚ùå Cleanup failed:', error);\n      res.status(500).json({ \n        success: false, \n        message: 'Failed to cleanup daily tasks', \n        error: error instanceof Error ? error.message : 'Unknown error' \n      });\n    }\n  });\n\n  // Delete daily recurring task templates permanently\n  app.post(\"/api/admin/delete-daily-templates\", async (req, res) => {\n    try {\n      console.log('üóëÔ∏è  DELETING DAILY RECURRING TASK TEMPLATES');\n      \n      const result = await db.execute(sql`\n        DELETE FROM recurring_tasks WHERE frequency = 'daily'\n      `);\n      \n      const deletedCount = result.rowCount || 0;\n      console.log(`‚úÖ Deleted ${deletedCount} daily recurring task templates`);\n      \n      res.json({\n        success: true,\n        message: `Deleted ${deletedCount} daily recurring task templates`,\n        deletedCount\n      });\n      \n    } catch (error) {\n      console.error('‚ùå Template deletion failed:', error);\n      res.status(500).json({ \n        success: false, \n        message: 'Failed to delete daily templates', \n        error: error instanceof Error ? error.message : 'Unknown error' \n      });\n    }\n  });\n\n  // Temporary download route for project zip file\n  app.get(\"/download-project\", (req, res) => {\n    const zipPath = path.join(process.cwd(), 'myprojects.zip');\n    \n    if (fs.existsSync(zipPath)) {\n      res.setHeader('Content-Disposition', 'attachment; filename=myprojects.zip');\n      res.setHeader('Content-Type', 'application/zip');\n      const fileStream = fs.createReadStream(zipPath);\n      fileStream.pipe(res);\n    } else {\n      res.status(404).send('Zip file not found. Please create it first.');\n    }\n  });\n\n  const httpServer = createServer(app);\n  return httpServer;\n}\n","path":null,"size_bytes":144455,"size_tokens":null},"client/src/components/EquipmentManagement.tsx":{"content":"import React, { useState, useEffect, useMemo } from 'react';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Button } from '@/components/ui/button';\nimport { Badge } from '@/components/ui/badge';\nimport { Progress } from '@/components/ui/progress';\nimport { Dialog, DialogContent, DialogHeader, DialogTitle } from '@/components/ui/dialog';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { \n  Grid, List, Plus, Edit2, Settings, AlertCircle, CheckCircle, Clock, \n  Activity, BarChart3, TrendingUp, TrendingDown, Thermometer, Droplets,\n  Lightbulb, Zap, AlertTriangle, Target\n} from 'lucide-react';\nimport { \n  LineChart, Line, BarChart, Bar, XAxis, YAxis, CartesianGrid, \n  Tooltip, Legend, ResponsiveContainer, PieChart, Pie, Cell \n} from 'recharts';\nimport { SystemConfigurationModal } from './SystemConfigurationModal';\nimport { SystemDetailsPanel } from './SystemDetailsPanel';\nimport { SystemVisualizer } from './SystemVisualizer';\nimport { useQuery } from '@tanstack/react-query';\nimport { GrowingSystem } from '@shared/schema';\nimport { sampleTrays } from '../data/trayTracking';\nimport { getStoredAuth } from '../lib/auth';\nimport { useLocation } from '@/contexts/LocationContext';\n\nexport const EquipmentManagement: React.FC = () => {\n  const [selectedSystem, setSelectedSystem] = useState<string | null>(null);\n  const [showConfigModal, setShowConfigModal] = useState(false);\n  const [editingSystem, setEditingSystem] = useState<GrowingSystem | null>(null);\n  const [viewMode, setViewMode] = useState<'grid' | 'list'>('grid');\n  \n  const auth = getStoredAuth();\n  const isCorporateManager = auth.user?.role === 'corporate';\n  const { currentLocation } = useLocation();\n  \n  // Fetch systems data with location filtering\n  const { data: systemsData = [] } = useQuery<GrowingSystem[]>({\n    queryKey: ['/api/growing-systems', currentLocation.code],\n    queryFn: async () => {\n      const response = await fetch(`/api/growing-systems?location=${currentLocation.code}`);\n      if (!response.ok) throw new Error('Failed to fetch systems');\n      return response.json();\n    },\n  });\n\n  // Filter systems by current location directly in useMemo\n  const systems = useMemo(() => {\n    return systemsData.filter(system => \n      system.location === currentLocation.code\n    );\n  }, [systemsData, currentLocation.code]);\n\n  // Group systems by category\n  const systemsByCategory = {\n    microgreens: systems.filter(s => s.category === 'microgreens'),\n    leafyGreens: systems.filter(s => s.category === 'leafyGreens')\n  };\n\n  // Mock sensor data for each system\n  const getSensorData = (systemId: string) => {\n    const sensorReadings = {\n      '1': { ph: 6.2, ec: 1.8, temperature: 72.5, lastReading: '2 minutes ago' },\n      '2': { ph: 6.4, ec: 2.1, temperature: 71.8, lastReading: '1 minute ago' },\n      '3': { ph: 6.0, ec: 1.9, temperature: 73.2, lastReading: '3 minutes ago' },\n      '4': { ph: 6.3, ec: 2.0, temperature: 72.0, lastReading: '2 minutes ago' },\n      '5': { ph: 6.1, ec: 1.7, temperature: 72.8, lastReading: '4 minutes ago' },\n      '6': { ph: 6.5, ec: 2.2, temperature: 71.5, lastReading: '1 minute ago' },\n      '7': { ph: 6.2, ec: 1.8, temperature: 72.3, lastReading: '2 minutes ago' },\n      '8': { ph: 6.4, ec: 2.0, temperature: 71.9, lastReading: '3 minutes ago' },\n    };\n    \n    return sensorReadings[systemId] || { ph: 6.2, ec: 1.8, temperature: 72.0, lastReading: '5 minutes ago' };\n  };\n\n  // Calculate basic statistics\n  const stats = useMemo(() => {\n    const totalCapacity = systems.reduce((sum, s) => sum + s.capacity, 0);\n    const totalOccupied = systems.reduce((sum, s) => sum + s.currentOccupancy, 0);\n    const utilizationRate = totalCapacity > 0 \n      ? Math.round((totalOccupied / totalCapacity) * 100) \n      : 0;\n    const systemsAtCapacity = systems.filter(s => s.currentOccupancy >= s.capacity).length;\n    \n    return {\n      totalCapacity,\n      totalOccupied,\n      utilizationRate,\n      systemsAtCapacity\n    };\n  }, [systems]);\n\n  return (\n    <div className=\"equipment-management space-y-6\">\n      {/* Header and Controls */}\n      <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between\">\n        <div>\n          <h2 className=\"text-xl font-bold text-[#203B17] mb-2\">Equipment Management - {currentLocation.name}</h2>\n          <p className=\"text-gray-600\">Monitor growing systems and sensor readings</p>\n        </div>\n        <div className=\"flex gap-2 mt-4 sm:mt-0\">\n          <div className=\"flex gap-1\">\n            <Button\n              variant={viewMode === 'grid' ? 'default' : 'outline'}\n              size=\"sm\"\n              onClick={() => setViewMode('grid')}\n            >\n              <Grid className=\"w-4 h-4 mr-1\" />\n              Grid\n            </Button>\n            <Button\n              variant={viewMode === 'list' ? 'default' : 'outline'}\n              size=\"sm\"\n              onClick={() => setViewMode('list')}\n            >\n              <List className=\"w-4 h-4 mr-1\" />\n              List\n            </Button>\n          </div>\n          {isCorporateManager && (\n            <Button onClick={() => setShowConfigModal(true)}>\n              <Plus className=\"w-4 h-4 mr-2\" />\n              Add System\n            </Button>\n          )}\n        </div>\n      </div>\n\n      {/* Overview Stats */}\n      <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n        <Card className=\"p-4\">\n          <div className=\"flex items-center justify-between\">\n            <div>\n              <p className=\"text-sm font-medium text-gray-600\">Total Systems</p>\n              <p className=\"text-2xl font-bold text-gray-900\">{systems.length}</p>\n            </div>\n            <div className=\"p-3 bg-blue-50 rounded-full\">\n              <Settings className=\"w-6 h-6 text-blue-600\" />\n            </div>\n          </div>\n        </Card>\n        \n        <Card className=\"p-4\">\n          <div className=\"flex items-center justify-between\">\n            <div>\n              <p className=\"text-sm font-medium text-gray-600\">Total Capacity</p>\n              <p className=\"text-2xl font-bold text-gray-900\">{stats.totalCapacity}</p>\n            </div>\n            <div className=\"p-3 bg-green-50 rounded-full\">\n              <Activity className=\"w-6 h-6 text-green-600\" />\n            </div>\n          </div>\n        </Card>\n\n        <Card className=\"p-4\">\n          <div className=\"flex items-center justify-between\">\n            <div>\n              <p className=\"text-sm font-medium text-gray-600\">Current Occupied</p>\n              <p className=\"text-2xl font-bold text-gray-900\">{stats.totalOccupied}</p>\n            </div>\n            <div className=\"p-3 bg-yellow-50 rounded-full\">\n              <CheckCircle className=\"w-6 h-6 text-yellow-600\" />\n            </div>\n          </div>\n        </Card>\n\n        <Card className=\"p-4\">\n          <div className=\"flex items-center justify-between\">\n            <div>\n              <p className=\"text-sm font-medium text-gray-600\">Utilization Rate</p>\n              <p className=\"text-2xl font-bold text-gray-900\">{stats.utilizationRate}%</p>\n            </div>\n            <div className=\"p-3 bg-purple-50 rounded-full\">\n              <BarChart3 className=\"w-6 h-6 text-purple-600\" />\n            </div>\n          </div>\n        </Card>\n      </div>\n\n      {/* Systems Display */}\n      <div className=\"space-y-6\">\n        {systems.length === 0 ? (\n          <Card className=\"p-8 text-center\">\n            <div className=\"text-gray-500\">\n              <Settings className=\"w-12 h-12 mx-auto mb-4 text-gray-300\" />\n              <h3 className=\"text-lg font-medium mb-2\">No Systems Found</h3>\n              <p className=\"text-sm\">No growing systems found for {currentLocation.name}.</p>\n              {isCorporateManager && (\n                <Button onClick={() => setShowConfigModal(true)} className=\"mt-4\">\n                  <Plus className=\"w-4 h-4 mr-2\" />\n                  Add System\n                </Button>\n              )}\n            </div>\n          </Card>\n        ) : (\n          <div className={`grid gap-4 ${viewMode === 'grid' ? 'grid-cols-1 md:grid-cols-2 lg:grid-cols-3' : 'grid-cols-1'}`}>\n            {systems.map((system) => {\n              const sensorData = getSensorData(system.id.toString());\n              const occupancyPercent = Math.round((system.currentOccupancy / system.capacity) * 100);\n              \n              return (\n                <Card key={system.id} className=\"p-4 hover:shadow-md transition-shadow\">\n                  <div className=\"flex items-center justify-between mb-4\">\n                    <div>\n                      <h3 className=\"font-semibold text-gray-900\">{system.name}</h3>\n                      <p className=\"text-sm text-gray-600\">{system.type}</p>\n                    </div>\n                    <Badge variant={occupancyPercent >= 90 ? 'destructive' : occupancyPercent >= 70 ? 'secondary' : 'default'}>\n                      {occupancyPercent >= 90 ? 'Full' : 'Available'}\n                    </Badge>\n                  </div>\n\n                  {/* Sensor Readings */}\n                  <div className=\"grid grid-cols-3 gap-4 mb-4\">\n                    <div className=\"text-center p-3 bg-blue-50 rounded-lg\">\n                      <div className=\"flex items-center justify-center mb-1\">\n                        <Droplets className=\"w-4 h-4 text-blue-600\" />\n                      </div>\n                      <p className=\"text-xs text-gray-600\">pH</p>\n                      <p className=\"text-lg font-bold text-gray-900\">{sensorData.ph}</p>\n                    </div>\n                    <div className=\"text-center p-3 bg-green-50 rounded-lg\">\n                      <div className=\"flex items-center justify-center mb-1\">\n                        <Zap className=\"w-4 h-4 text-green-600\" />\n                      </div>\n                      <p className=\"text-xs text-gray-600\">EC</p>\n                      <p className=\"text-lg font-bold text-gray-900\">{sensorData.ec}</p>\n                    </div>\n                    <div className=\"text-center p-3 bg-red-50 rounded-lg\">\n                      <div className=\"flex items-center justify-center mb-1\">\n                        <Thermometer className=\"w-4 h-4 text-red-600\" />\n                      </div>\n                      <p className=\"text-xs text-gray-600\">Temp</p>\n                      <p className=\"text-lg font-bold text-gray-900\">{sensorData.temperature}¬∞F</p>\n                    </div>\n                  </div>\n\n                  {/* Capacity */}\n                  <div className=\"space-y-2 mb-4\">\n                    <div className=\"flex justify-between items-center\">\n                      <span className=\"text-sm text-gray-600\">Capacity</span>\n                      <span className=\"text-sm font-medium\">{system.currentOccupancy}/{system.capacity}</span>\n                    </div>\n                    <Progress value={occupancyPercent} className=\"h-2\" />\n                  </div>\n\n                  {/* Last Reading */}\n                  <div className=\"text-xs text-gray-500 mb-4\">\n                    Last reading: {sensorData.lastReading}\n                  </div>\n\n                  {/* Actions */}\n                  <div className=\"flex gap-2\">\n                    <Button\n                      variant=\"outline\"\n                      size=\"sm\"\n                      onClick={() => setSelectedSystem(system.id.toString())}\n                      className=\"flex-1\"\n                    >\n                      View Details\n                    </Button>\n                    {isCorporateManager && (\n                      <Button\n                        variant=\"outline\"\n                        size=\"sm\"\n                        onClick={() => {\n                          setEditingSystem(system);\n                          setShowConfigModal(true);\n                        }}\n                      >\n                        <Edit2 className=\"w-4 h-4\" />\n                      </Button>\n                    )}\n                  </div>\n                </Card>\n              );\n            })}\n          </div>\n        )}\n      </div>\n\n      {/* System Configuration Modal */}\n      {showConfigModal && (\n        <SystemConfigurationModal\n          system={editingSystem}\n          onClose={() => {\n            setShowConfigModal(false);\n            setEditingSystem(null);\n          }}\n          onSave={(systemData) => {\n            // Handle save logic here\n            console.log('System saved:', systemData);\n            setShowConfigModal(false);\n            setEditingSystem(null);\n          }}\n        />\n      )}\n\n      {/* System Details Panel */}\n      {selectedSystem && (\n        <Dialog open={!!selectedSystem} onOpenChange={() => setSelectedSystem(null)}>\n          <DialogContent className=\"max-w-4xl\">\n            <DialogHeader>\n              <DialogTitle>System Details</DialogTitle>\n            </DialogHeader>\n            <SystemDetailsPanel\n              systemId={selectedSystem}\n              onClose={() => setSelectedSystem(null)}\n            />\n          </DialogContent>\n        </Dialog>\n      )}\n    </div>\n  );\n};\n\n","path":null,"size_bytes":13215,"size_tokens":null},"client/src/services/trayMovement.ts":{"content":"import { Tray, TrayMovement, generateTrayId } from '../data/trayTracking';\nimport { GrowingSystem } from '../data/systemsData';\nimport { findAvailableSpots, assignToSystem } from '../utils/systemAvailability';\n\nexport class TrayMovementService {\n  // Create new tray from seeding task\n  static createTray(\n    cropType: string,\n    category: 'microgreens' | 'leafyGreens',\n    plantCount: number,\n    systemId: string,\n    spotIds: string[],\n    location: string,\n    createdBy: string\n  ): Tray {\n    const cropData = this.getCropData(cropType);\n    const trayId = generateTrayId(location, cropType, category);\n    \n    const newTray: Tray = {\n      id: trayId,\n      cropType,\n      cropCategory: category,\n      datePlanted: new Date(),\n      expectedHarvest: new Date(Date.now() + cropData.growthTime * 24 * 60 * 60 * 1000),\n      status: 'seeded',\n      currentLocation: {\n        systemId,\n        systemType: category === 'microgreens' ? 'nursery' : 'ebbFlow',\n        spotIds,\n        movedDate: new Date()\n      },\n      locationHistory: [{\n        systemId,\n        systemType: category === 'microgreens' ? 'nursery' : 'ebbFlow',\n        spotIds,\n        movedDate: new Date(),\n        movedBy: createdBy,\n        reason: 'Initial seeding'\n      }],\n      plantCount,\n      notes: '',\n      createdBy,\n      createdDate: new Date()\n    };\n    \n    return newTray;\n  }\n  \n  // Move tray to new location\n  static moveTray(\n    tray: Tray,\n    toSystemId: string,\n    toSystemType: string,\n    toSpotIds: string[],\n    movedBy: string,\n    reason?: string\n  ): Tray {\n    const updatedTray: Tray = {\n      ...tray,\n      currentLocation: {\n        systemId: toSystemId,\n        systemType: toSystemType,\n        spotIds: toSpotIds,\n        movedDate: new Date()\n      },\n      locationHistory: [\n        ...tray.locationHistory,\n        {\n          systemId: toSystemId,\n          systemType: toSystemType,\n          spotIds: toSpotIds,\n          movedDate: new Date(),\n          movedBy,\n          reason: reason || 'Manual movement'\n        }\n      ],\n      status: this.getStatusForLocation(toSystemType, tray.cropCategory)\n    };\n    \n    return updatedTray;\n  }\n  \n  // Split tray into multiple trays\n  static splitTray(\n    parentTray: Tray,\n    splits: Array<{\n      systemId: string;\n      systemType: string;\n      spotIds: string[];\n      plantCount: number;\n    }>,\n    location: string,\n    splitBy: string\n  ): { parentTray: Tray; childTrays: Tray[] } {\n    const childTrays: Tray[] = [];\n    const childTrayIds: string[] = [];\n    \n    // Create child trays\n    splits.forEach((split, index) => {\n      const childId = `${parentTray.id}-S${index + 1}`;\n      childTrayIds.push(childId);\n      \n      const childTray: Tray = {\n        ...parentTray,\n        id: childId,\n        parentTrayId: parentTray.id,\n        plantCount: split.plantCount,\n        currentLocation: {\n          systemId: split.systemId,\n          systemType: split.systemType,\n          spotIds: split.spotIds,\n          movedDate: new Date()\n        },\n        locationHistory: [\n          ...parentTray.locationHistory,\n          {\n            systemId: split.systemId,\n            systemType: split.systemType,\n            spotIds: split.spotIds,\n            movedDate: new Date(),\n            movedBy: splitBy,\n            reason: `Split from parent tray ${parentTray.id}`\n          }\n        ],\n        status: this.getStatusForLocation(split.systemType, parentTray.cropCategory)\n      };\n      \n      childTrays.push(childTray);\n    });\n    \n    // Update parent tray\n    const updatedParentTray: Tray = {\n      ...parentTray,\n      childTrayIds,\n      status: 'harvested', // Parent tray is considered harvested after split\n      notes: `${parentTray.notes}\\nSplit into ${childTrays.length} trays on ${new Date().toLocaleDateString()}`\n    };\n    \n    return { parentTray: updatedParentTray, childTrays };\n  }\n  \n  // Check for automatic movements (microgreens)\n  static checkAutomaticMovements(\n    trays: Tray[],\n    systems: GrowingSystem[]\n  ): TrayMovement[] {\n    const movements: TrayMovement[] = [];\n    const now = new Date();\n    \n    trays\n      .filter(tray => tray.cropCategory === 'microgreens' && tray.status !== 'harvested')\n      .forEach(tray => {\n        const daysSincePlanted = Math.floor(\n          (now.getTime() - tray.datePlanted.getTime()) / (1000 * 60 * 60 * 24)\n        );\n        \n        if (tray.currentLocation.systemType === 'nursery' && daysSincePlanted >= 0) {\n          // Move to blackout immediately\n          movements.push({\n            id: `move-${tray.id}-${Date.now()}`,\n            trayId: tray.id,\n            fromSystem: tray.currentLocation.systemId,\n            toSystem: 'blackout',\n            movementType: 'automatic',\n            scheduledDate: now,\n            status: 'pending',\n            reason: 'Automatic movement: Nursery to Blackout'\n          });\n        } else if (tray.currentLocation.systemType === 'blackout' && daysSincePlanted >= 2) {\n          // Move to racks after 2 days\n          const availableRacks = findAvailableSpots(\n            systems.filter(s => s.type === 'microgreens'),\n            'microgreens',\n            1\n          );\n          \n          if (availableRacks.length > 0) {\n            movements.push({\n              id: `move-${tray.id}-${Date.now()}`,\n              trayId: tray.id,\n              fromSystem: tray.currentLocation.systemId,\n              toSystem: availableRacks[0].systemId,\n              movementType: 'automatic',\n              scheduledDate: now,\n              status: 'pending',\n              reason: 'Automatic movement: Blackout to Racks'\n            });\n          }\n        }\n      });\n    \n    return movements;\n  }\n  \n  private static getStatusForLocation(\n    systemType: string,\n    category: 'microgreens' | 'leafyGreens'\n  ): Tray['status'] {\n    if (category === 'microgreens') {\n      switch (systemType) {\n        case 'nursery': return 'seeded';\n        case 'blackout': return 'germinating';\n        case 'microgreens': return 'growing';\n        default: return 'growing';\n      }\n    } else {\n      switch (systemType) {\n        case 'ebbFlow': return 'seeded';\n        case 'towers':\n        case 'nft': return 'growing';\n        default: return 'growing';\n      }\n    }\n  }\n  \n  private static getCropData(cropType: string) {\n    // This would come from your crop configuration\n    const cropDatabase: { [key: string]: { growthTime: number } } = {\n      'Broccoli Microgreens': { growthTime: 7 },\n      'Arugula': { growthTime: 21 },\n      'Romaine Lettuce': { growthTime: 28 },\n      'Basil': { growthTime: 25 }\n    };\n    \n    return cropDatabase[cropType] || { growthTime: 21 };\n  }\n}","path":null,"size_bytes":6716,"size_tokens":null},"client/src/utils/systemAvailability.ts":{"content":"import { GrowingSystem, SystemSpot } from '../data/systemsData';\n\nexport interface AvailableSpot {\n  systemId: string;\n  systemName: string;\n  spotIds: string[];\n  systemType: string;\n  section?: string;\n}\n\nexport const findAvailableSpots = (\n  systems: GrowingSystem[],\n  systemType: string,\n  spotsNeeded: number,\n  plantType?: string\n): AvailableSpot[] => {\n  const availableSpots: AvailableSpot[] = [];\n  \n  const matchingSystems = systems.filter(s => s.type === systemType);\n  \n  for (const system of matchingSystems) {\n    if (system.type === 'nft' && system.configuration.restrictions?.samePerChannel) {\n      // Special handling for NFT channels\n      for (const section of system.configuration.sections || []) {\n        const channelSpots = system.spots.filter(spot => \n          spot.id.includes(section.id) && !spot.occupied\n        );\n        \n        // Check if channel is empty or has same plant type\n        const occupiedInChannel = system.spots.filter(spot =>\n          spot.id.includes(section.id) && spot.occupied\n        );\n        \n        if (channelSpots.length >= spotsNeeded && \n            (occupiedInChannel.length === 0 || \n             occupiedInChannel.every(s => s.plantType === plantType))) {\n          availableSpots.push({\n            systemId: system.id,\n            systemName: system.name,\n            spotIds: channelSpots.slice(0, spotsNeeded).map(s => s.id),\n            systemType: system.type,\n            section: section.id\n          });\n        }\n      }\n    } else {\n      // Regular system handling\n      const freeSpots = system.spots.filter(spot => !spot.occupied);\n      \n      if (freeSpots.length >= spotsNeeded) {\n        availableSpots.push({\n          systemId: system.id,\n          systemName: system.name,\n          spotIds: freeSpots.slice(0, spotsNeeded).map(s => s.id),\n          systemType: system.type\n        });\n      }\n    }\n  }\n  \n  // Sort by most available space first\n  return availableSpots.sort((a, b) => b.spotIds.length - a.spotIds.length);\n};\n\nexport const assignToSystem = (\n  system: GrowingSystem,\n  spotIds: string[],\n  trayId: string,\n  plantType: string\n): GrowingSystem => {\n  const updatedSpots = system.spots.map(spot => {\n    if (spotIds.includes(spot.id)) {\n      return {\n        ...spot,\n        occupied: true,\n        trayId,\n        plantType,\n        plantedDate: new Date()\n      };\n    }\n    return spot;\n  });\n  \n  return {\n    ...system,\n    spots: updatedSpots,\n    currentOccupancy: updatedSpots.filter(s => s.occupied).length\n  };\n};","path":null,"size_bytes":2532,"size_tokens":null},"client/src/components/DebugPanel.tsx":{"content":"import React, { useState } from 'react';\nimport { useCurrentUser } from '@/contexts/CurrentUserContext';\n\ninterface DebugPanelProps {\n  tasks: any[];\n  filteredTasks: any[];\n  staff: any[];\n  filters?: any;\n}\n\nconst DebugPanel: React.FC<DebugPanelProps> = ({ tasks, filteredTasks, staff, filters }) => {\n  const [showDebug, setShowDebug] = useState(false);\n  const { currentUser } = useCurrentUser();\n\n  if (!showDebug) {\n    return (\n      <button \n        onClick={() => setShowDebug(true)}\n        style={{ \n          position: 'fixed', \n          bottom: 10, \n          right: 10,\n          padding: '10px',\n          background: '#2D8028',\n          color: 'white',\n          borderRadius: '4px',\n          border: 'none',\n          cursor: 'pointer',\n          zIndex: 1000\n        }}\n      >\n        üîç Debug\n      </button>\n    );\n  }\n\n  const assignmentCounts: Record<string, number> = {};\n  tasks.forEach(task => {\n    if (task.assignTo) {\n      assignmentCounts[task.assignTo] = (assignmentCounts[task.assignTo] || 0) + 1;\n    }\n    if (task.assignedTo) {\n      const key = `legacy_${task.assignedTo}`;\n      assignmentCounts[key] = (assignmentCounts[key] || 0) + 1;\n    }\n  });\n\n  return (\n    <div style={{\n      position: 'fixed',\n      bottom: 10,\n      right: 10,\n      width: '500px',\n      maxHeight: '400px',\n      overflow: 'auto',\n      background: 'white',\n      border: '2px solid #e5e7eb',\n      borderRadius: '8px',\n      padding: '12px',\n      fontSize: '12px',\n      boxShadow: '0 4px 12px rgba(0,0,0,0.15)',\n      zIndex: 1000\n    }}>\n      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '10px' }}>\n        <h4 style={{ margin: 0 }}>üîç Assignment Debug Panel</h4>\n        <button \n          onClick={() => setShowDebug(false)}\n          style={{ \n            cursor: 'pointer', \n            background: 'none', \n            border: 'none', \n            fontSize: '16px' \n          }}\n        >\n          ‚úï\n        </button>\n      </div>\n\n      <div style={{ marginBottom: '12px' }}>\n        <strong>Current User:</strong>\n        <div style={{ \n          background: currentUser ? '#f0f9ff' : '#fef2f2', \n          padding: '6px', \n          borderRadius: '4px',\n          marginTop: '4px'\n        }}>\n          {currentUser ? (\n            <>\n              <div>‚úÖ {currentUser.fullName} ({currentUser.email})</div>\n              <div>ID: {currentUser.id}</div>\n              <div>Roles: {currentUser.rolesAssigned?.join(', ') || 'None'}</div>\n            </>\n          ) : (\n            <div>‚ùå No current user loaded</div>\n          )}\n        </div>\n      </div>\n\n      <div style={{ marginBottom: '12px' }}>\n        <strong>Task Counts:</strong>\n        <div>Total Tasks: {tasks.length}</div>\n        <div>Filtered Tasks: {filteredTasks.length}</div>\n        <div>Staff Members: {staff.length}</div>\n      </div>\n\n      <div style={{ marginBottom: '12px' }}>\n        <strong>Assignment Distribution:</strong>\n        <div style={{ \n          background: '#f9fafb', \n          padding: '6px', \n          borderRadius: '4px',\n          maxHeight: '100px',\n          overflow: 'auto'\n        }}>\n          {Object.entries(assignmentCounts).map(([assignment, count]) => (\n            <div key={assignment} style={{ fontSize: '10px' }}>\n              {assignment}: {count as number}\n            </div>\n          ))}\n        </div>\n      </div>\n\n      <div style={{ marginBottom: '12px' }}>\n        <strong>Sample Task Assignments:</strong>\n        <div style={{ \n          background: '#f9fafb', \n          padding: '6px', \n          borderRadius: '4px',\n          maxHeight: '120px',\n          overflow: 'auto'\n        }}>\n          {tasks.slice(0, 8).map(task => {\n            const assignment = task.assignTo || task.assignedTo;\n            const isMatch = currentUser ? \n              (assignment === 'all_staff' && currentUser.id !== null) ||\n              (assignment?.startsWith('role_') && currentUser.rolesAssigned?.includes(assignment.replace('role_', ''))) ||\n              (assignment?.startsWith('user_') && parseInt(assignment.replace('user_', '')) === currentUser.id)\n              : false;\n            \n            return (\n              <div key={task.id} style={{ \n                fontSize: '10px', \n                marginBottom: '2px',\n                color: isMatch ? '#059669' : '#374151',\n                fontWeight: isMatch ? 'bold' : 'normal'\n              }}>\n                {isMatch ? '‚úÖ' : '‚ùå'} {task.title?.substring(0, 25)}... ‚Üí {assignment || 'No assignment'}\n              </div>\n            );\n          })}\n        </div>\n      </div>\n\n      <div style={{ display: 'flex', gap: '8px' }}>\n        <button \n          onClick={() => {\n            console.log('=== DEBUG DATA DUMP ===');\n            console.log('Current User:', currentUser);\n            console.log('Assignment counts:', assignmentCounts);\n            console.log('First 10 tasks with assignments:');\n            tasks.slice(0, 10).forEach((task, i) => {\n              console.log(`${i+1}. \"${task.title}\" -> assignTo: \"${task.assignTo}\" | assignedTo: \"${task.assignedTo}\"`);\n            });\n            console.log('Staff roles available:', staff.map(s => ({ name: s.fullName, roles: s.rolesAssigned })));\n          }}\n          style={{\n            padding: '6px 12px',\n            background: '#2D8028',\n            color: 'white',\n            border: 'none',\n            borderRadius: '4px',\n            cursor: 'pointer',\n            fontSize: '11px'\n          }}\n        >\n          Log to Console\n        </button>\n        \n        <button \n          onClick={() => {\n            // Test assignment matching\n            const testTask = tasks.find(t => t.assignTo || t.assignedTo);\n            if (testTask && currentUser) {\n              console.log('=== TESTING ASSIGNMENT MATCH ===');\n              console.log('Test task:', testTask.title);\n              console.log('Assignment:', testTask.assignTo || testTask.assignedTo);\n              console.log('Current user ID:', currentUser.id);\n              console.log('Current user roles:', currentUser.rolesAssigned);\n              \n              // Test different assignment types\n              const assignment = testTask.assignTo || testTask.assignedTo;\n              if (assignment === `user_${currentUser.id}`) {\n                console.log('‚úÖ Direct user match');\n              } else if (assignment === 'all_staff') {\n                console.log('‚úÖ All staff match');\n              } else if (assignment?.startsWith('role_')) {\n                const role = assignment.replace('role_', '');\n                const hasRole = currentUser.rolesAssigned?.includes(role);\n                console.log(`Role check for \"${role}\": ${hasRole ? '‚úÖ' : '‚ùå'}`);\n              }\n            }\n          }}\n          style={{\n            padding: '6px 12px',\n            background: '#059669',\n            color: 'white',\n            border: 'none',\n            borderRadius: '4px',\n            cursor: 'pointer',\n            fontSize: '11px'\n          }}\n        >\n          Test Match\n        </button>\n      </div>\n    </div>\n  );\n};\n\nexport default DebugPanel;","path":null,"size_bytes":7212,"size_tokens":null},"client/src/components/ui/radio-group.tsx":{"content":"import * as React from \"react\"\nimport * as RadioGroupPrimitive from \"@radix-ui/react-radio-group\"\nimport { Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst RadioGroup = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Root\n      className={cn(\"grid gap-2\", className)}\n      {...props}\n      ref={ref}\n    />\n  )\n})\nRadioGroup.displayName = RadioGroupPrimitive.Root.displayName\n\nconst RadioGroupItem = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Item>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Item\n      ref={ref}\n      className={cn(\n        \"aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    >\n      <RadioGroupPrimitive.Indicator className=\"flex items-center justify-center\">\n        <Circle className=\"h-2.5 w-2.5 fill-current text-current\" />\n      </RadioGroupPrimitive.Indicator>\n    </RadioGroupPrimitive.Item>\n  )\n})\nRadioGroupItem.displayName = RadioGroupPrimitive.Item.displayName\n\nexport { RadioGroup, RadioGroupItem }\n","path":null,"size_bytes":1467,"size_tokens":null},"client/src/types/index.ts":{"content":"export interface DashboardAnalytics {\n  totalTasks: number;\n  completedTasks: number;\n  inProgressTasks: number;\n  pendingTasks: number;\n  totalUsers: number;\n  totalInventoryItems: number;\n  lowStockAlerts: number;\n  totalTimeLogged: number;\n  tasksByType: Record<string, number>;\n  tasksByStatus: Record<string, number>;\n}\n\nexport interface TaskFilters {\n  status?: string;\n  type?: string;\n  assignedTo?: number;\n}\n\nexport type TaskType = 'seeding-microgreens' | 'seeding-leafy-greens' | 'harvest-microgreens' | 'harvest-leafy-greens' | 'blackout-tasks' | 'moving' | 'packing' | 'cleaning' | 'inventory' | 'equipment-maintenance' | 'other';\nexport type TaskStatus = 'pending' | 'in_progress' | 'completed' | 'approved';\nexport type UserRole = 'technician' | 'manager' | 'corporate';\n","path":null,"size_bytes":786,"size_tokens":null},"client/src/components/ui/toaster.tsx":{"content":"import { useToast } from \"@/hooks/use-toast\"\nimport {\n  Toast,\n  ToastClose,\n  ToastDescription,\n  ToastProvider,\n  ToastTitle,\n  ToastViewport,\n} from \"@/components/ui/toast\"\n\nexport function Toaster() {\n  const { toasts } = useToast()\n\n  return (\n    <ToastProvider>\n      {toasts.map(function ({ id, title, description, action, ...props }) {\n        return (\n          <Toast key={id} {...props}>\n            <div className=\"grid gap-1\">\n              {title && <ToastTitle>{title}</ToastTitle>}\n              {description && (\n                <ToastDescription>{description}</ToastDescription>\n              )}\n            </div>\n            {action}\n            <ToastClose />\n          </Toast>\n        )\n      })}\n      <ToastViewport />\n    </ToastProvider>\n  )\n}\n","path":null,"size_bytes":772,"size_tokens":null},"client/src/components/ui/switch.tsx":{"content":"import * as React from \"react\"\nimport * as SwitchPrimitives from \"@radix-ui/react-switch\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Switch = React.forwardRef<\n  React.ElementRef<typeof SwitchPrimitives.Root>,\n  React.ComponentPropsWithoutRef<typeof SwitchPrimitives.Root>\n>(({ className, ...props }, ref) => (\n  <SwitchPrimitives.Root\n    className={cn(\n      \"peer inline-flex h-6 w-11 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  >\n    <SwitchPrimitives.Thumb\n      className={cn(\n        \"pointer-events-none block h-5 w-5 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-5 data-[state=unchecked]:translate-x-0\"\n      )}\n    />\n  </SwitchPrimitives.Root>\n))\nSwitch.displayName = SwitchPrimitives.Root.displayName\n\nexport { Switch }\n","path":null,"size_bytes":1139,"size_tokens":null},"client/src/components/DeleteRecurringTaskModal.tsx":{"content":"import React, { useState, useEffect } from 'react';\nimport { Button } from '@/components/ui/button';\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from '@/components/ui/dialog';\nimport { Input } from '@/components/ui/input';\nimport { AlertTriangle, Calendar, CheckCircle, Clock } from 'lucide-react';\nimport { RecurringTask, Task } from '@shared/schema';\n\ninterface DeleteRecurringTaskModalProps {\n  recurringTask: RecurringTask | null;\n  isOpen: boolean;\n  onClose: () => void;\n  onConfirm: () => void;\n}\n\ninterface TaskCounts {\n  future: number;\n  completed: number;\n  inProgress: number;\n}\n\nconst DeleteRecurringTaskModal: React.FC<DeleteRecurringTaskModalProps> = ({\n  recurringTask,\n  isOpen,\n  onClose,\n  onConfirm\n}) => {\n  const [confirmText, setConfirmText] = useState('');\n  const [taskCounts, setTaskCounts] = useState<TaskCounts>({ future: 0, completed: 0, inProgress: 0 });\n  const [isLoading, setIsLoading] = useState(false);\n\n  useEffect(() => {\n    if (isOpen && recurringTask) {\n      setIsLoading(true);\n      // Fetch associated tasks to count them\n      fetch('/api/tasks')\n        .then(response => response.json())\n        .then((tasks: Task[]) => {\n          const associatedTasks = tasks.filter(t => t.recurringTaskId === recurringTask.id);\n          \n          const now = new Date();\n          now.setHours(0, 0, 0, 0);\n          \n          const counts = {\n            future: 0,\n            completed: 0,\n            inProgress: 0\n          };\n          \n          associatedTasks.forEach(task => {\n            if (task.status === 'completed') {\n              counts.completed++;\n            } else if (task.status === 'in_progress' || task.startedAt) {\n              counts.inProgress++;\n            } else {\n              const dueDate = new Date(task.dueDate || '');\n              dueDate.setHours(0, 0, 0, 0);\n              if (dueDate >= now) {\n                counts.future++;\n              }\n            }\n          });\n          \n          setTaskCounts(counts);\n          setIsLoading(false);\n        })\n        .catch(error => {\n          console.error('Error fetching task counts:', error);\n          setIsLoading(false);\n        });\n    }\n  }, [isOpen, recurringTask]);\n\n  const handleDelete = () => {\n    if (confirmText === 'DELETE') {\n      onConfirm();\n      setConfirmText('');\n    }\n  };\n\n  const handleClose = () => {\n    setConfirmText('');\n    onClose();\n  };\n\n  if (!isOpen || !recurringTask) return null;\n\n  return (\n    <Dialog open={isOpen} onOpenChange={handleClose}>\n      <DialogContent className=\"max-w-md\">\n        <DialogHeader>\n          <DialogTitle className=\"flex items-center gap-2 text-red-600\">\n            <AlertTriangle className=\"h-5 w-5\" />\n            Delete Recurring Task\n          </DialogTitle>\n        </DialogHeader>\n        \n        <div className=\"space-y-4\">\n          <div className=\"bg-yellow-50 border border-yellow-200 rounded-lg p-4\">\n            <h3 className=\"font-semibold text-yellow-800 mb-2\">\n              Are you sure you want to delete \"{recurringTask.title}\"?\n            </h3>\n            \n            {isLoading ? (\n              <div className=\"text-center py-2\">Loading task counts...</div>\n            ) : (\n              <div className=\"space-y-3\">\n                <p className=\"text-yellow-700 font-medium\">This action will:</p>\n                <ul className=\"space-y-2 text-sm\">\n                  <li className=\"flex items-center gap-2\">\n                    <Calendar className=\"h-4 w-4 text-red-500\" />\n                    <span>Delete {taskCounts.future} future scheduled tasks</span>\n                  </li>\n                  <li className=\"flex items-center gap-2\">\n                    <CheckCircle className=\"h-4 w-4 text-green-500\" />\n                    <span>Preserve {taskCounts.completed} completed tasks for historical data</span>\n                  </li>\n                  {taskCounts.inProgress > 0 && (\n                    <li className=\"flex items-center gap-2\">\n                      <Clock className=\"h-4 w-4 text-blue-500\" />\n                      <span>Keep {taskCounts.inProgress} in-progress tasks active</span>\n                    </li>\n                  )}\n                </ul>\n                \n                <div className=\"bg-red-50 border border-red-200 rounded p-3 mt-3\">\n                  <p className=\"text-red-700 text-sm\">\n                    <AlertTriangle className=\"h-4 w-4 inline mr-1\" />\n                    This action cannot be undone. The recurring task will be permanently deleted, \n                    but historical data will be preserved for reporting.\n                  </p>\n                </div>\n              </div>\n            )}\n          </div>\n          \n          <div className=\"space-y-2\">\n            <p className=\"text-sm font-medium\">Type <span className=\"font-bold text-red-600\">DELETE</span> to confirm:</p>\n            <Input\n              type=\"text\"\n              value={confirmText}\n              onChange={(e) => setConfirmText(e.target.value)}\n              placeholder=\"Type DELETE to confirm\"\n              className=\"text-center border-red-300 focus:border-red-500\"\n            />\n          </div>\n        </div>\n        \n        <DialogFooter>\n          <Button variant=\"outline\" onClick={handleClose}>\n            Cancel\n          </Button>\n          <Button \n            variant=\"destructive\"\n            onClick={handleDelete} \n            disabled={confirmText !== 'DELETE' || isLoading}\n          >\n            Delete Recurring Task\n          </Button>\n        </DialogFooter>\n      </DialogContent>\n    </Dialog>\n  );\n};\n\nexport default DeleteRecurringTaskModal;","path":null,"size_bytes":5670,"size_tokens":null},"client/src/components/ui/calendar.tsx":{"content":"import * as React from \"react\"\nimport { ChevronLeft, ChevronRight } from \"lucide-react\"\nimport { DayPicker } from \"react-day-picker\"\n\nimport { cn } from \"@/lib/utils\"\nimport { buttonVariants } from \"@/components/ui/button\"\n\nexport type CalendarProps = React.ComponentProps<typeof DayPicker>\n\nfunction Calendar({\n  className,\n  classNames,\n  showOutsideDays = true,\n  ...props\n}: CalendarProps) {\n  return (\n    <DayPicker\n      showOutsideDays={showOutsideDays}\n      className={cn(\"p-3\", className)}\n      classNames={{\n        months: \"flex flex-col sm:flex-row space-y-4 sm:space-x-4 sm:space-y-0\",\n        month: \"space-y-4\",\n        caption: \"flex justify-center pt-1 relative items-center\",\n        caption_label: \"text-sm font-medium\",\n        nav: \"space-x-1 flex items-center\",\n        nav_button: cn(\n          buttonVariants({ variant: \"outline\" }),\n          \"h-7 w-7 bg-transparent p-0 opacity-50 hover:opacity-100\"\n        ),\n        nav_button_previous: \"absolute left-1\",\n        nav_button_next: \"absolute right-1\",\n        table: \"w-full border-collapse space-y-1\",\n        head_row: \"flex\",\n        head_cell:\n          \"text-muted-foreground rounded-md w-9 font-normal text-[0.8rem]\",\n        row: \"flex w-full mt-2\",\n        cell: \"h-9 w-9 text-center text-sm p-0 relative [&:has([aria-selected].day-range-end)]:rounded-r-md [&:has([aria-selected].day-outside)]:bg-accent/50 [&:has([aria-selected])]:bg-accent first:[&:has([aria-selected])]:rounded-l-md last:[&:has([aria-selected])]:rounded-r-md focus-within:relative focus-within:z-20\",\n        day: cn(\n          buttonVariants({ variant: \"ghost\" }),\n          \"h-9 w-9 p-0 font-normal aria-selected:opacity-100\"\n        ),\n        day_range_end: \"day-range-end\",\n        day_selected:\n          \"bg-primary text-primary-foreground hover:bg-primary hover:text-primary-foreground focus:bg-primary focus:text-primary-foreground\",\n        day_today: \"bg-accent text-accent-foreground\",\n        day_outside:\n          \"day-outside text-muted-foreground aria-selected:bg-accent/50 aria-selected:text-muted-foreground\",\n        day_disabled: \"text-muted-foreground opacity-50\",\n        day_range_middle:\n          \"aria-selected:bg-accent aria-selected:text-accent-foreground\",\n        day_hidden: \"invisible\",\n        ...classNames,\n      }}\n      components={{\n        IconLeft: ({ className, ...props }) => (\n          <ChevronLeft className={cn(\"h-4 w-4\", className)} {...props} />\n        ),\n        IconRight: ({ className, ...props }) => (\n          <ChevronRight className={cn(\"h-4 w-4\", className)} {...props} />\n        ),\n      }}\n      {...props}\n    />\n  )\n}\nCalendar.displayName = \"Calendar\"\n\nexport { Calendar }\n","path":null,"size_bytes":2695,"size_tokens":null},"client/src/components/TaskActionModal.tsx":{"content":"import React, { useState, useEffect } from \"react\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle } from \"@/components/ui/dialog\";\nimport { Button } from \"@/components/ui/button\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Label } from \"@/components/ui/label\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { Clock, Pause, CheckCircle, SkipForward } from \"lucide-react\";\nimport { Task } from \"@shared/schema\";\nimport { useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport confetti from \"canvas-confetti\";\n\ninterface TaskActionModalProps {\n  task: Task | null;\n  open: boolean;\n  onClose: () => void;\n}\n\nconst TaskActionModal: React.FC<TaskActionModalProps> = ({ task, open, onClose }) => {\n  const [notes, setNotes] = useState(\"\");\n  const [elapsedTime, setElapsedTime] = useState(0);\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n\n  // HARD RESET: Clear notes when task changes\n  useEffect(() => {\n    console.log('üîÑ HARD RESET - TaskActionModal task changed, clearing notes state');\n    setNotes(\"\");\n    setElapsedTime(0);\n  }, [task?.id]);\n\n  // Calculate elapsed time\n  useEffect(() => {\n    if (!task?.startedAt) return;\n    \n    const updateElapsedTime = () => {\n      const now = new Date();\n      const started = new Date(task.startedAt!);\n      const diff = now.getTime() - started.getTime();\n      setElapsedTime(Math.floor(diff / 1000 / 60)); // in minutes\n    };\n\n    updateElapsedTime();\n    const interval = setInterval(updateElapsedTime, 60000); // Update every minute\n    \n    return () => clearInterval(interval);\n  }, [task?.startedAt]);\n\n  const [actionType, setActionType] = useState<'pause' | 'complete' | 'skip' | null>(null);\n\n  const updateTaskMutation = useMutation({\n    mutationFn: async (updates: Partial<Task>) => {\n      return await apiRequest(`/api/tasks/${task?.id}`, {\n        method: \"PATCH\",\n        body: JSON.stringify(updates),\n      });\n    },\n    onMutate: async () => {\n      await queryClient.cancelQueries({ predicate: (query) => query.queryKey[0] === \"/api/tasks\" });\n    },\n    onError: (error) => {\n      toast({\n        title: \"Update failed\",\n        description: \"Failed to update task. Please try again.\",\n        variant: \"destructive\",\n      });\n      setActionType(null);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ predicate: (query) => query.queryKey[0] === \"/api/tasks\" });\n      \n      // Show success feedback based on action type\n      if (actionType === 'pause') {\n        toast({\n          title: \"Task paused\",\n          description: \"The task has been paused and can be resumed later.\",\n        });\n      } else if (actionType === 'complete') {\n        toast({\n          title: \"üéâ Task completed!\",\n          description: \"Great job! The task has been marked as completed.\",\n        });\n        confetti({\n          particleCount: 100,\n          spread: 70,\n          origin: { y: 0.6 }\n        });\n      } else if (actionType === 'skip') {\n        toast({\n          title: \"Task skipped\",\n          description: \"The task has been skipped with your reason noted.\",\n        });\n      }\n      \n      setActionType(null);\n      onClose();\n    },\n  });\n\n  const handlePauseTask = () => {\n    setActionType('pause');\n    updateTaskMutation.mutate({\n      status: \"pending\",\n      actualTime: elapsedTime,\n    });\n  };\n\n  const handleCompleteTask = () => {\n    setActionType('complete');\n    updateTaskMutation.mutate({\n      status: \"completed\",\n      progress: 100,\n      completedAt: new Date().toISOString(),\n      actualTime: elapsedTime,\n    });\n  };\n\n  const handleSkipTask = () => {\n    if (!notes.trim()) {\n      toast({\n        title: \"Reason required\",\n        description: \"Please provide a reason for skipping this task.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    \n    setActionType('skip');\n    updateTaskMutation.mutate({\n      status: \"pending\",\n      data: { \n        ...task?.data, \n        skipped: true, \n        skipReason: notes \n      },\n    });\n  };\n\n  const formatTime = (minutes: number): string => {\n    const hours = Math.floor(minutes / 60);\n    const mins = minutes % 60;\n    if (hours > 0) {\n      return `${hours}h ${mins}m`;\n    }\n    return `${mins}m`;\n  };\n\n  if (!task) return null;\n\n  return (\n    <Dialog open={open} onOpenChange={onClose}>\n      <DialogContent className=\"w-[95vw] max-w-md max-h-[85vh] overflow-y-auto overflow-x-hidden p-4 sm:p-6\">\n        <DialogHeader>\n          <DialogTitle>{task.title}</DialogTitle>\n        </DialogHeader>\n        \n        <div className=\"space-y-4\">\n          <div className=\"text-sm text-gray-600\">\n            <p><strong>Location:</strong> {task.location}</p>\n            <p><strong>Description:</strong> {task.description}</p>\n          </div>\n\n          <div className=\"flex items-center space-x-2 text-sm\">\n            <Clock className=\"h-4 w-4\" />\n            <span>\n              Time elapsed: <strong>{formatTime(elapsedTime)}</strong>\n              {task.estimatedTime && (\n                <span className=\"text-gray-500\"> / {formatTime(task.estimatedTime)}</span>\n              )}\n            </span>\n          </div>\n\n          {task.progress !== null && (\n            <div>\n              <div className=\"flex justify-between items-center mb-2\">\n                <Label className=\"text-sm\">Progress</Label>\n                <span className=\"text-sm font-medium\">{task.progress}%</span>\n              </div>\n              <Progress value={task.progress} className=\"h-2\" />\n            </div>\n          )}\n\n          <div>\n            <Label htmlFor=\"notes\">Notes (optional)</Label>\n            <Textarea\n              id=\"notes\"\n              value={notes}\n              onChange={(e) => setNotes(e.target.value)}\n              placeholder=\"Add any comments or observations...\"\n              className=\"mt-1\"\n            />\n          </div>\n\n          <div className=\"flex flex-col sm:grid sm:grid-cols-3 gap-2 pt-4\">\n            <Button\n              variant=\"outline\"\n              onClick={handlePauseTask}\n              disabled={updateTaskMutation.isPending}\n              className=\"flex items-center space-x-1\"\n              data-testid=\"button-pause-task\"\n            >\n              <Pause className=\"h-4 w-4\" />\n              <span>{updateTaskMutation.isPending && actionType === 'pause' ? 'Pausing...' : 'Pause'}</span>\n            </Button>\n            \n            <Button\n              onClick={handleCompleteTask}\n              disabled={updateTaskMutation.isPending}\n              className=\"flex items-center space-x-1 bg-[#2D8028] hover:bg-[#203B17]\"\n              data-testid=\"button-complete-task\"\n            >\n              <CheckCircle className=\"h-4 w-4\" />\n              <span>{updateTaskMutation.isPending && actionType === 'complete' ? 'Completing...' : 'Complete'}</span>\n            </Button>\n            \n            <Button\n              variant=\"outline\"\n              onClick={handleSkipTask}\n              disabled={updateTaskMutation.isPending}\n              className=\"flex items-center space-x-1 text-orange-600 border-orange-200 hover:bg-orange-50\"\n              data-testid=\"button-skip-task\"\n            >\n              <SkipForward className=\"h-4 w-4\" />\n              <span>{updateTaskMutation.isPending && actionType === 'skip' ? 'Skipping...' : 'Skip'}</span>\n            </Button>\n          </div>\n        </div>\n      </DialogContent>\n    </Dialog>\n  );\n};\n\nexport default TaskActionModal;","path":null,"size_bytes":7618,"size_tokens":null},"client/src/components/ui/carousel.tsx":{"content":"import * as React from \"react\"\nimport useEmblaCarousel, {\n  type UseEmblaCarouselType,\n} from \"embla-carousel-react\"\nimport { ArrowLeft, ArrowRight } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\n\ntype CarouselApi = UseEmblaCarouselType[1]\ntype UseCarouselParameters = Parameters<typeof useEmblaCarousel>\ntype CarouselOptions = UseCarouselParameters[0]\ntype CarouselPlugin = UseCarouselParameters[1]\n\ntype CarouselProps = {\n  opts?: CarouselOptions\n  plugins?: CarouselPlugin\n  orientation?: \"horizontal\" | \"vertical\"\n  setApi?: (api: CarouselApi) => void\n}\n\ntype CarouselContextProps = {\n  carouselRef: ReturnType<typeof useEmblaCarousel>[0]\n  api: ReturnType<typeof useEmblaCarousel>[1]\n  scrollPrev: () => void\n  scrollNext: () => void\n  canScrollPrev: boolean\n  canScrollNext: boolean\n} & CarouselProps\n\nconst CarouselContext = React.createContext<CarouselContextProps | null>(null)\n\nfunction useCarousel() {\n  const context = React.useContext(CarouselContext)\n\n  if (!context) {\n    throw new Error(\"useCarousel must be used within a <Carousel />\")\n  }\n\n  return context\n}\n\nconst Carousel = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement> & CarouselProps\n>(\n  (\n    {\n      orientation = \"horizontal\",\n      opts,\n      setApi,\n      plugins,\n      className,\n      children,\n      ...props\n    },\n    ref\n  ) => {\n    const [carouselRef, api] = useEmblaCarousel(\n      {\n        ...opts,\n        axis: orientation === \"horizontal\" ? \"x\" : \"y\",\n      },\n      plugins\n    )\n    const [canScrollPrev, setCanScrollPrev] = React.useState(false)\n    const [canScrollNext, setCanScrollNext] = React.useState(false)\n\n    const onSelect = React.useCallback((api: CarouselApi) => {\n      if (!api) {\n        return\n      }\n\n      setCanScrollPrev(api.canScrollPrev())\n      setCanScrollNext(api.canScrollNext())\n    }, [])\n\n    const scrollPrev = React.useCallback(() => {\n      api?.scrollPrev()\n    }, [api])\n\n    const scrollNext = React.useCallback(() => {\n      api?.scrollNext()\n    }, [api])\n\n    const handleKeyDown = React.useCallback(\n      (event: React.KeyboardEvent<HTMLDivElement>) => {\n        if (event.key === \"ArrowLeft\") {\n          event.preventDefault()\n          scrollPrev()\n        } else if (event.key === \"ArrowRight\") {\n          event.preventDefault()\n          scrollNext()\n        }\n      },\n      [scrollPrev, scrollNext]\n    )\n\n    React.useEffect(() => {\n      if (!api || !setApi) {\n        return\n      }\n\n      setApi(api)\n    }, [api, setApi])\n\n    React.useEffect(() => {\n      if (!api) {\n        return\n      }\n\n      onSelect(api)\n      api.on(\"reInit\", onSelect)\n      api.on(\"select\", onSelect)\n\n      return () => {\n        api?.off(\"select\", onSelect)\n      }\n    }, [api, onSelect])\n\n    return (\n      <CarouselContext.Provider\n        value={{\n          carouselRef,\n          api: api,\n          opts,\n          orientation:\n            orientation || (opts?.axis === \"y\" ? \"vertical\" : \"horizontal\"),\n          scrollPrev,\n          scrollNext,\n          canScrollPrev,\n          canScrollNext,\n        }}\n      >\n        <div\n          ref={ref}\n          onKeyDownCapture={handleKeyDown}\n          className={cn(\"relative\", className)}\n          role=\"region\"\n          aria-roledescription=\"carousel\"\n          {...props}\n        >\n          {children}\n        </div>\n      </CarouselContext.Provider>\n    )\n  }\n)\nCarousel.displayName = \"Carousel\"\n\nconst CarouselContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const { carouselRef, orientation } = useCarousel()\n\n  return (\n    <div ref={carouselRef} className=\"overflow-hidden\">\n      <div\n        ref={ref}\n        className={cn(\n          \"flex\",\n          orientation === \"horizontal\" ? \"-ml-4\" : \"-mt-4 flex-col\",\n          className\n        )}\n        {...props}\n      />\n    </div>\n  )\n})\nCarouselContent.displayName = \"CarouselContent\"\n\nconst CarouselItem = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const { orientation } = useCarousel()\n\n  return (\n    <div\n      ref={ref}\n      role=\"group\"\n      aria-roledescription=\"slide\"\n      className={cn(\n        \"min-w-0 shrink-0 grow-0 basis-full\",\n        orientation === \"horizontal\" ? \"pl-4\" : \"pt-4\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nCarouselItem.displayName = \"CarouselItem\"\n\nconst CarouselPrevious = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<typeof Button>\n>(({ className, variant = \"outline\", size = \"icon\", ...props }, ref) => {\n  const { orientation, scrollPrev, canScrollPrev } = useCarousel()\n\n  return (\n    <Button\n      ref={ref}\n      variant={variant}\n      size={size}\n      className={cn(\n        \"absolute  h-8 w-8 rounded-full\",\n        orientation === \"horizontal\"\n          ? \"-left-12 top-1/2 -translate-y-1/2\"\n          : \"-top-12 left-1/2 -translate-x-1/2 rotate-90\",\n        className\n      )}\n      disabled={!canScrollPrev}\n      onClick={scrollPrev}\n      {...props}\n    >\n      <ArrowLeft className=\"h-4 w-4\" />\n      <span className=\"sr-only\">Previous slide</span>\n    </Button>\n  )\n})\nCarouselPrevious.displayName = \"CarouselPrevious\"\n\nconst CarouselNext = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<typeof Button>\n>(({ className, variant = \"outline\", size = \"icon\", ...props }, ref) => {\n  const { orientation, scrollNext, canScrollNext } = useCarousel()\n\n  return (\n    <Button\n      ref={ref}\n      variant={variant}\n      size={size}\n      className={cn(\n        \"absolute h-8 w-8 rounded-full\",\n        orientation === \"horizontal\"\n          ? \"-right-12 top-1/2 -translate-y-1/2\"\n          : \"-bottom-12 left-1/2 -translate-x-1/2 rotate-90\",\n        className\n      )}\n      disabled={!canScrollNext}\n      onClick={scrollNext}\n      {...props}\n    >\n      <ArrowRight className=\"h-4 w-4\" />\n      <span className=\"sr-only\">Next slide</span>\n    </Button>\n  )\n})\nCarouselNext.displayName = \"CarouselNext\"\n\nexport {\n  type CarouselApi,\n  Carousel,\n  CarouselContent,\n  CarouselItem,\n  CarouselPrevious,\n  CarouselNext,\n}\n","path":null,"size_bytes":6210,"size_tokens":null},"client/src/components/ui/sidebar.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { VariantProps, cva } from \"class-variance-authority\"\nimport { PanelLeft } from \"lucide-react\"\n\nimport { useIsMobile } from \"@/hooks/use-mobile\"\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\nimport { Input } from \"@/components/ui/input\"\nimport { Separator } from \"@/components/ui/separator\"\nimport {\n  Sheet,\n  SheetContent,\n  SheetDescription,\n  SheetHeader,\n  SheetTitle,\n} from \"@/components/ui/sheet\"\nimport { Skeleton } from \"@/components/ui/skeleton\"\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\"\n\nconst SIDEBAR_COOKIE_NAME = \"sidebar_state\"\nconst SIDEBAR_COOKIE_MAX_AGE = 60 * 60 * 24 * 7\nconst SIDEBAR_WIDTH = \"16rem\"\nconst SIDEBAR_WIDTH_MOBILE = \"18rem\"\nconst SIDEBAR_WIDTH_ICON = \"3rem\"\nconst SIDEBAR_KEYBOARD_SHORTCUT = \"b\"\n\ntype SidebarContextProps = {\n  state: \"expanded\" | \"collapsed\"\n  open: boolean\n  setOpen: (open: boolean) => void\n  openMobile: boolean\n  setOpenMobile: (open: boolean) => void\n  isMobile: boolean\n  toggleSidebar: () => void\n}\n\nconst SidebarContext = React.createContext<SidebarContextProps | null>(null)\n\nfunction useSidebar() {\n  const context = React.useContext(SidebarContext)\n  if (!context) {\n    throw new Error(\"useSidebar must be used within a SidebarProvider.\")\n  }\n\n  return context\n}\n\nconst SidebarProvider = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & {\n    defaultOpen?: boolean\n    open?: boolean\n    onOpenChange?: (open: boolean) => void\n  }\n>(\n  (\n    {\n      defaultOpen = true,\n      open: openProp,\n      onOpenChange: setOpenProp,\n      className,\n      style,\n      children,\n      ...props\n    },\n    ref\n  ) => {\n    const isMobile = useIsMobile()\n    const [openMobile, setOpenMobile] = React.useState(false)\n\n    // This is the internal state of the sidebar.\n    // We use openProp and setOpenProp for control from outside the component.\n    const [_open, _setOpen] = React.useState(defaultOpen)\n    const open = openProp ?? _open\n    const setOpen = React.useCallback(\n      (value: boolean | ((value: boolean) => boolean)) => {\n        const openState = typeof value === \"function\" ? value(open) : value\n        if (setOpenProp) {\n          setOpenProp(openState)\n        } else {\n          _setOpen(openState)\n        }\n\n        // This sets the cookie to keep the sidebar state.\n        document.cookie = `${SIDEBAR_COOKIE_NAME}=${openState}; path=/; max-age=${SIDEBAR_COOKIE_MAX_AGE}`\n      },\n      [setOpenProp, open]\n    )\n\n    // Helper to toggle the sidebar.\n    const toggleSidebar = React.useCallback(() => {\n      return isMobile\n        ? setOpenMobile((open) => !open)\n        : setOpen((open) => !open)\n    }, [isMobile, setOpen, setOpenMobile])\n\n    // Adds a keyboard shortcut to toggle the sidebar.\n    React.useEffect(() => {\n      const handleKeyDown = (event: KeyboardEvent) => {\n        if (\n          event.key === SIDEBAR_KEYBOARD_SHORTCUT &&\n          (event.metaKey || event.ctrlKey)\n        ) {\n          event.preventDefault()\n          toggleSidebar()\n        }\n      }\n\n      window.addEventListener(\"keydown\", handleKeyDown)\n      return () => window.removeEventListener(\"keydown\", handleKeyDown)\n    }, [toggleSidebar])\n\n    // We add a state so that we can do data-state=\"expanded\" or \"collapsed\".\n    // This makes it easier to style the sidebar with Tailwind classes.\n    const state = open ? \"expanded\" : \"collapsed\"\n\n    const contextValue = React.useMemo<SidebarContextProps>(\n      () => ({\n        state,\n        open,\n        setOpen,\n        isMobile,\n        openMobile,\n        setOpenMobile,\n        toggleSidebar,\n      }),\n      [state, open, setOpen, isMobile, openMobile, setOpenMobile, toggleSidebar]\n    )\n\n    return (\n      <SidebarContext.Provider value={contextValue}>\n        <TooltipProvider delayDuration={0}>\n          <div\n            style={\n              {\n                \"--sidebar-width\": SIDEBAR_WIDTH,\n                \"--sidebar-width-icon\": SIDEBAR_WIDTH_ICON,\n                ...style,\n              } as React.CSSProperties\n            }\n            className={cn(\n              \"group/sidebar-wrapper flex min-h-svh w-full has-[[data-variant=inset]]:bg-sidebar\",\n              className\n            )}\n            ref={ref}\n            {...props}\n          >\n            {children}\n          </div>\n        </TooltipProvider>\n      </SidebarContext.Provider>\n    )\n  }\n)\nSidebarProvider.displayName = \"SidebarProvider\"\n\nconst Sidebar = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & {\n    side?: \"left\" | \"right\"\n    variant?: \"sidebar\" | \"floating\" | \"inset\"\n    collapsible?: \"offcanvas\" | \"icon\" | \"none\"\n  }\n>(\n  (\n    {\n      side = \"left\",\n      variant = \"sidebar\",\n      collapsible = \"offcanvas\",\n      className,\n      children,\n      ...props\n    },\n    ref\n  ) => {\n    const { isMobile, state, openMobile, setOpenMobile } = useSidebar()\n\n    if (collapsible === \"none\") {\n      return (\n        <div\n          className={cn(\n            \"flex h-full w-[--sidebar-width] flex-col bg-sidebar text-sidebar-foreground\",\n            className\n          )}\n          ref={ref}\n          {...props}\n        >\n          {children}\n        </div>\n      )\n    }\n\n    if (isMobile) {\n      return (\n        <Sheet open={openMobile} onOpenChange={setOpenMobile} {...props}>\n          <SheetContent\n            data-sidebar=\"sidebar\"\n            data-mobile=\"true\"\n            className=\"w-[--sidebar-width] bg-sidebar p-0 text-sidebar-foreground [&>button]:hidden\"\n            style={\n              {\n                \"--sidebar-width\": SIDEBAR_WIDTH_MOBILE,\n              } as React.CSSProperties\n            }\n            side={side}\n          >\n            <SheetHeader className=\"sr-only\">\n              <SheetTitle>Sidebar</SheetTitle>\n              <SheetDescription>Displays the mobile sidebar.</SheetDescription>\n            </SheetHeader>\n            <div className=\"flex h-full w-full flex-col\">{children}</div>\n          </SheetContent>\n        </Sheet>\n      )\n    }\n\n    return (\n      <div\n        ref={ref}\n        className=\"group peer hidden text-sidebar-foreground md:block\"\n        data-state={state}\n        data-collapsible={state === \"collapsed\" ? collapsible : \"\"}\n        data-variant={variant}\n        data-side={side}\n      >\n        {/* This is what handles the sidebar gap on desktop */}\n        <div\n          className={cn(\n            \"relative w-[--sidebar-width] bg-transparent transition-[width] duration-200 ease-linear\",\n            \"group-data-[collapsible=offcanvas]:w-0\",\n            \"group-data-[side=right]:rotate-180\",\n            variant === \"floating\" || variant === \"inset\"\n              ? \"group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)_+_theme(spacing.4))]\"\n              : \"group-data-[collapsible=icon]:w-[--sidebar-width-icon]\"\n          )}\n        />\n        <div\n          className={cn(\n            \"fixed inset-y-0 z-10 hidden h-svh w-[--sidebar-width] transition-[left,right,width] duration-200 ease-linear md:flex\",\n            side === \"left\"\n              ? \"left-0 group-data-[collapsible=offcanvas]:left-[calc(var(--sidebar-width)*-1)]\"\n              : \"right-0 group-data-[collapsible=offcanvas]:right-[calc(var(--sidebar-width)*-1)]\",\n            // Adjust the padding for floating and inset variants.\n            variant === \"floating\" || variant === \"inset\"\n              ? \"p-2 group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)_+_theme(spacing.4)_+2px)]\"\n              : \"group-data-[collapsible=icon]:w-[--sidebar-width-icon] group-data-[side=left]:border-r group-data-[side=right]:border-l\",\n            className\n          )}\n          {...props}\n        >\n          <div\n            data-sidebar=\"sidebar\"\n            className=\"flex h-full w-full flex-col bg-sidebar group-data-[variant=floating]:rounded-lg group-data-[variant=floating]:border group-data-[variant=floating]:border-sidebar-border group-data-[variant=floating]:shadow\"\n          >\n            {children}\n          </div>\n        </div>\n      </div>\n    )\n  }\n)\nSidebar.displayName = \"Sidebar\"\n\nconst SidebarTrigger = React.forwardRef<\n  React.ElementRef<typeof Button>,\n  React.ComponentProps<typeof Button>\n>(({ className, onClick, ...props }, ref) => {\n  const { toggleSidebar } = useSidebar()\n\n  return (\n    <Button\n      ref={ref}\n      data-sidebar=\"trigger\"\n      variant=\"ghost\"\n      size=\"icon\"\n      className={cn(\"h-7 w-7\", className)}\n      onClick={(event) => {\n        onClick?.(event)\n        toggleSidebar()\n      }}\n      {...props}\n    >\n      <PanelLeft />\n      <span className=\"sr-only\">Toggle Sidebar</span>\n    </Button>\n  )\n})\nSidebarTrigger.displayName = \"SidebarTrigger\"\n\nconst SidebarRail = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<\"button\">\n>(({ className, ...props }, ref) => {\n  const { toggleSidebar } = useSidebar()\n\n  return (\n    <button\n      ref={ref}\n      data-sidebar=\"rail\"\n      aria-label=\"Toggle Sidebar\"\n      tabIndex={-1}\n      onClick={toggleSidebar}\n      title=\"Toggle Sidebar\"\n      className={cn(\n        \"absolute inset-y-0 z-20 hidden w-4 -translate-x-1/2 transition-all ease-linear after:absolute after:inset-y-0 after:left-1/2 after:w-[2px] hover:after:bg-sidebar-border group-data-[side=left]:-right-4 group-data-[side=right]:left-0 sm:flex\",\n        \"[[data-side=left]_&]:cursor-w-resize [[data-side=right]_&]:cursor-e-resize\",\n        \"[[data-side=left][data-state=collapsed]_&]:cursor-e-resize [[data-side=right][data-state=collapsed]_&]:cursor-w-resize\",\n        \"group-data-[collapsible=offcanvas]:translate-x-0 group-data-[collapsible=offcanvas]:after:left-full group-data-[collapsible=offcanvas]:hover:bg-sidebar\",\n        \"[[data-side=left][data-collapsible=offcanvas]_&]:-right-2\",\n        \"[[data-side=right][data-collapsible=offcanvas]_&]:-left-2\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarRail.displayName = \"SidebarRail\"\n\nconst SidebarInset = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"main\">\n>(({ className, ...props }, ref) => {\n  return (\n    <main\n      ref={ref}\n      className={cn(\n        \"relative flex w-full flex-1 flex-col bg-background\",\n        \"md:peer-data-[variant=inset]:m-2 md:peer-data-[state=collapsed]:peer-data-[variant=inset]:ml-2 md:peer-data-[variant=inset]:ml-0 md:peer-data-[variant=inset]:rounded-xl md:peer-data-[variant=inset]:shadow\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarInset.displayName = \"SidebarInset\"\n\nconst SidebarInput = React.forwardRef<\n  React.ElementRef<typeof Input>,\n  React.ComponentProps<typeof Input>\n>(({ className, ...props }, ref) => {\n  return (\n    <Input\n      ref={ref}\n      data-sidebar=\"input\"\n      className={cn(\n        \"h-8 w-full bg-background shadow-none focus-visible:ring-2 focus-visible:ring-sidebar-ring\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarInput.displayName = \"SidebarInput\"\n\nconst SidebarHeader = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => {\n  return (\n    <div\n      ref={ref}\n      data-sidebar=\"header\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props}\n    />\n  )\n})\nSidebarHeader.displayName = \"SidebarHeader\"\n\nconst SidebarFooter = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => {\n  return (\n    <div\n      ref={ref}\n      data-sidebar=\"footer\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props}\n    />\n  )\n})\nSidebarFooter.displayName = \"SidebarFooter\"\n\nconst SidebarSeparator = React.forwardRef<\n  React.ElementRef<typeof Separator>,\n  React.ComponentProps<typeof Separator>\n>(({ className, ...props }, ref) => {\n  return (\n    <Separator\n      ref={ref}\n      data-sidebar=\"separator\"\n      className={cn(\"mx-2 w-auto bg-sidebar-border\", className)}\n      {...props}\n    />\n  )\n})\nSidebarSeparator.displayName = \"SidebarSeparator\"\n\nconst SidebarContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => {\n  return (\n    <div\n      ref={ref}\n      data-sidebar=\"content\"\n      className={cn(\n        \"flex min-h-0 flex-1 flex-col gap-2 overflow-auto group-data-[collapsible=icon]:overflow-hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarContent.displayName = \"SidebarContent\"\n\nconst SidebarGroup = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => {\n  return (\n    <div\n      ref={ref}\n      data-sidebar=\"group\"\n      className={cn(\"relative flex w-full min-w-0 flex-col p-2\", className)}\n      {...props}\n    />\n  )\n})\nSidebarGroup.displayName = \"SidebarGroup\"\n\nconst SidebarGroupLabel = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & { asChild?: boolean }\n>(({ className, asChild = false, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"div\"\n\n  return (\n    <Comp\n      ref={ref}\n      data-sidebar=\"group-label\"\n      className={cn(\n        \"flex h-8 shrink-0 items-center rounded-md px-2 text-xs font-medium text-sidebar-foreground/70 outline-none ring-sidebar-ring transition-[margin,opacity] duration-200 ease-linear focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        \"group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarGroupLabel.displayName = \"SidebarGroupLabel\"\n\nconst SidebarGroupAction = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<\"button\"> & { asChild?: boolean }\n>(({ className, asChild = false, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    <Comp\n      ref={ref}\n      data-sidebar=\"group-action\"\n      className={cn(\n        \"absolute right-3 top-3.5 flex aspect-square w-5 items-center justify-center rounded-md p-0 text-sidebar-foreground outline-none ring-sidebar-ring transition-transform hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 after:md:hidden\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarGroupAction.displayName = \"SidebarGroupAction\"\n\nconst SidebarGroupContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    data-sidebar=\"group-content\"\n    className={cn(\"w-full text-sm\", className)}\n    {...props}\n  />\n))\nSidebarGroupContent.displayName = \"SidebarGroupContent\"\n\nconst SidebarMenu = React.forwardRef<\n  HTMLUListElement,\n  React.ComponentProps<\"ul\">\n>(({ className, ...props }, ref) => (\n  <ul\n    ref={ref}\n    data-sidebar=\"menu\"\n    className={cn(\"flex w-full min-w-0 flex-col gap-1\", className)}\n    {...props}\n  />\n))\nSidebarMenu.displayName = \"SidebarMenu\"\n\nconst SidebarMenuItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentProps<\"li\">\n>(({ className, ...props }, ref) => (\n  <li\n    ref={ref}\n    data-sidebar=\"menu-item\"\n    className={cn(\"group/menu-item relative\", className)}\n    {...props}\n  />\n))\nSidebarMenuItem.displayName = \"SidebarMenuItem\"\n\nconst sidebarMenuButtonVariants = cva(\n  \"peer/menu-button flex w-full items-center gap-2 overflow-hidden rounded-md p-2 text-left text-sm outline-none ring-sidebar-ring transition-[width,height,padding] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-[[data-sidebar=menu-action]]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:bg-sidebar-accent data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:!size-8 group-data-[collapsible=icon]:!p-2 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0\",\n  {\n    variants: {\n      variant: {\n        default: \"hover:bg-sidebar-accent hover:text-sidebar-accent-foreground\",\n        outline:\n          \"bg-background shadow-[0_0_0_1px_hsl(var(--sidebar-border))] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground hover:shadow-[0_0_0_1px_hsl(var(--sidebar-accent))]\",\n      },\n      size: {\n        default: \"h-8 text-sm\",\n        sm: \"h-7 text-xs\",\n        lg: \"h-12 text-sm group-data-[collapsible=icon]:!p-0\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nconst SidebarMenuButton = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<\"button\"> & {\n    asChild?: boolean\n    isActive?: boolean\n    tooltip?: string | React.ComponentProps<typeof TooltipContent>\n  } & VariantProps<typeof sidebarMenuButtonVariants>\n>(\n  (\n    {\n      asChild = false,\n      isActive = false,\n      variant = \"default\",\n      size = \"default\",\n      tooltip,\n      className,\n      ...props\n    },\n    ref\n  ) => {\n    const Comp = asChild ? Slot : \"button\"\n    const { isMobile, state } = useSidebar()\n\n    const button = (\n      <Comp\n        ref={ref}\n        data-sidebar=\"menu-button\"\n        data-size={size}\n        data-active={isActive}\n        className={cn(sidebarMenuButtonVariants({ variant, size }), className)}\n        {...props}\n      />\n    )\n\n    if (!tooltip) {\n      return button\n    }\n\n    if (typeof tooltip === \"string\") {\n      tooltip = {\n        children: tooltip,\n      }\n    }\n\n    return (\n      <Tooltip>\n        <TooltipTrigger asChild>{button}</TooltipTrigger>\n        <TooltipContent\n          side=\"right\"\n          align=\"center\"\n          hidden={state !== \"collapsed\" || isMobile}\n          {...tooltip}\n        />\n      </Tooltip>\n    )\n  }\n)\nSidebarMenuButton.displayName = \"SidebarMenuButton\"\n\nconst SidebarMenuAction = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<\"button\"> & {\n    asChild?: boolean\n    showOnHover?: boolean\n  }\n>(({ className, asChild = false, showOnHover = false, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    <Comp\n      ref={ref}\n      data-sidebar=\"menu-action\"\n      className={cn(\n        \"absolute right-1 top-1.5 flex aspect-square w-5 items-center justify-center rounded-md p-0 text-sidebar-foreground outline-none ring-sidebar-ring transition-transform hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 peer-hover/menu-button:text-sidebar-accent-foreground [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 after:md:hidden\",\n        \"peer-data-[size=sm]/menu-button:top-1\",\n        \"peer-data-[size=default]/menu-button:top-1.5\",\n        \"peer-data-[size=lg]/menu-button:top-2.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        showOnHover &&\n          \"group-focus-within/menu-item:opacity-100 group-hover/menu-item:opacity-100 data-[state=open]:opacity-100 peer-data-[active=true]/menu-button:text-sidebar-accent-foreground md:opacity-0\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarMenuAction.displayName = \"SidebarMenuAction\"\n\nconst SidebarMenuBadge = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    data-sidebar=\"menu-badge\"\n    className={cn(\n      \"pointer-events-none absolute right-1 flex h-5 min-w-5 select-none items-center justify-center rounded-md px-1 text-xs font-medium tabular-nums text-sidebar-foreground\",\n      \"peer-hover/menu-button:text-sidebar-accent-foreground peer-data-[active=true]/menu-button:text-sidebar-accent-foreground\",\n      \"peer-data-[size=sm]/menu-button:top-1\",\n      \"peer-data-[size=default]/menu-button:top-1.5\",\n      \"peer-data-[size=lg]/menu-button:top-2.5\",\n      \"group-data-[collapsible=icon]:hidden\",\n      className\n    )}\n    {...props}\n  />\n))\nSidebarMenuBadge.displayName = \"SidebarMenuBadge\"\n\nconst SidebarMenuSkeleton = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & {\n    showIcon?: boolean\n  }\n>(({ className, showIcon = false, ...props }, ref) => {\n  // Random width between 50 to 90%.\n  const width = React.useMemo(() => {\n    return `${Math.floor(Math.random() * 40) + 50}%`\n  }, [])\n\n  return (\n    <div\n      ref={ref}\n      data-sidebar=\"menu-skeleton\"\n      className={cn(\"flex h-8 items-center gap-2 rounded-md px-2\", className)}\n      {...props}\n    >\n      {showIcon && (\n        <Skeleton\n          className=\"size-4 rounded-md\"\n          data-sidebar=\"menu-skeleton-icon\"\n        />\n      )}\n      <Skeleton\n        className=\"h-4 max-w-[--skeleton-width] flex-1\"\n        data-sidebar=\"menu-skeleton-text\"\n        style={\n          {\n            \"--skeleton-width\": width,\n          } as React.CSSProperties\n        }\n      />\n    </div>\n  )\n})\nSidebarMenuSkeleton.displayName = \"SidebarMenuSkeleton\"\n\nconst SidebarMenuSub = React.forwardRef<\n  HTMLUListElement,\n  React.ComponentProps<\"ul\">\n>(({ className, ...props }, ref) => (\n  <ul\n    ref={ref}\n    data-sidebar=\"menu-sub\"\n    className={cn(\n      \"mx-3.5 flex min-w-0 translate-x-px flex-col gap-1 border-l border-sidebar-border px-2.5 py-0.5\",\n      \"group-data-[collapsible=icon]:hidden\",\n      className\n    )}\n    {...props}\n  />\n))\nSidebarMenuSub.displayName = \"SidebarMenuSub\"\n\nconst SidebarMenuSubItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentProps<\"li\">\n>(({ ...props }, ref) => <li ref={ref} {...props} />)\nSidebarMenuSubItem.displayName = \"SidebarMenuSubItem\"\n\nconst SidebarMenuSubButton = React.forwardRef<\n  HTMLAnchorElement,\n  React.ComponentProps<\"a\"> & {\n    asChild?: boolean\n    size?: \"sm\" | \"md\"\n    isActive?: boolean\n  }\n>(({ asChild = false, size = \"md\", isActive, className, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"a\"\n\n  return (\n    <Comp\n      ref={ref}\n      data-sidebar=\"menu-sub-button\"\n      data-size={size}\n      data-active={isActive}\n      className={cn(\n        \"flex h-7 min-w-0 -translate-x-px items-center gap-2 overflow-hidden rounded-md px-2 text-sidebar-foreground outline-none ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 aria-disabled:pointer-events-none aria-disabled:opacity-50 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0 [&>svg]:text-sidebar-accent-foreground\",\n        \"data-[active=true]:bg-sidebar-accent data-[active=true]:text-sidebar-accent-foreground\",\n        size === \"sm\" && \"text-xs\",\n        size === \"md\" && \"text-sm\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarMenuSubButton.displayName = \"SidebarMenuSubButton\"\n\nexport {\n  Sidebar,\n  SidebarContent,\n  SidebarFooter,\n  SidebarGroup,\n  SidebarGroupAction,\n  SidebarGroupContent,\n  SidebarGroupLabel,\n  SidebarHeader,\n  SidebarInput,\n  SidebarInset,\n  SidebarMenu,\n  SidebarMenuAction,\n  SidebarMenuBadge,\n  SidebarMenuButton,\n  SidebarMenuItem,\n  SidebarMenuSkeleton,\n  SidebarMenuSub,\n  SidebarMenuSubButton,\n  SidebarMenuSubItem,\n  SidebarProvider,\n  SidebarRail,\n  SidebarSeparator,\n  SidebarTrigger,\n  useSidebar,\n}\n","path":null,"size_bytes":23567,"size_tokens":null},"client/src/components/ChecklistExecution.tsx":{"content":"/**\n * IMPORTANT: When implementing these changes, DO NOT DELETE or MODIFY:\n * - Existing tasks in the database\n * - Existing recurring tasks\n * - Any task instances that have been created\n * - User-entered data in tasks\n * \n * Only update the code logic, not the data!\n */\nimport React, { useState, useEffect } from 'react';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { Label } from '@/components/ui/label';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { Checkbox } from '@/components/ui/checkbox';\nimport { Textarea } from '@/components/ui/textarea';\nimport { Progress } from '@/components/ui/progress';\nimport { Alert, AlertDescription } from '@/components/ui/alert';\nimport { Badge } from '@/components/ui/badge';\nimport { useQuery } from '@tanstack/react-query';\nimport { CheckCircle, Circle, AlertTriangle, Camera, Package, Building, BarChart3, Split, ArrowRight, FileText, Edit3, PlusCircle } from 'lucide-react';\nimport { GrowingSystem, InventoryItem, Task } from '@shared/schema';\nimport SystemAssignmentStep from './checklist/SystemAssignmentStep';\nimport TraySplitStep from './checklist/TraySplitStep';\nimport CreateTrayStep from './checklist/CreateTrayStep';\nimport { assignTrayToSystem } from '../data/growingSystems';\n\ninterface ChecklistStep {\n  id: string;\n  type: string;\n  label: string;\n  text?: string;\n  required: boolean;\n  config: any;\n  completed?: boolean;\n  skipped?: boolean;\n  skippedAt?: string;\n}\n\ninterface ChecklistExecutionProps {\n  task: Task;\n  checklist: { steps: ChecklistStep[] };\n  systems: GrowingSystem[];\n  onComplete: (stepData: any) => void;\n  onProgress: (progress: { stepIndex: number; stepData: any }) => void;\n}\n\nconst ChecklistExecution: React.FC<ChecklistExecutionProps> = ({\n  task,\n  checklist,\n  systems,\n  onComplete,\n  onProgress\n}) => {\n  const [currentStep, setCurrentStep] = useState(0);\n  const [stepData, setStepData] = useState<Record<string, any>>({});\n  const [errors, setErrors] = useState<Record<string, string>>({});\n  const [isProcessing, setIsProcessing] = useState(false);\n  const [steps, setSteps] = useState(checklist.steps);\n  const [stepContext, setStepContext] = useState({\n    currentTrayId: task.id?.toString() || 'TRAY-001',\n    splitTrays: null as any\n  });\n\n  // HARD RESET: Clear all state when task ID changes\n  useEffect(() => {\n    console.log('üîÑ HARD RESET - Task changed, clearing all checklist state for task:', task.id);\n    \n    // 1. Reset all state variables to clean slate\n    setCurrentStep(0);\n    setStepData({});\n    setErrors({});\n    setIsProcessing(false);\n    setSteps([...checklist.steps]); // Fresh copy of steps\n    setStepContext({\n      currentTrayId: task.id?.toString() || 'TRAY-001',\n      splitTrays: null\n    });\n    \n    console.log('‚úÖ HARD RESET complete - Clean state initialized');\n  }, [task.id]); // Run whenever task ID changes\n\n  // Initialize checklist progress from saved task data\n  useEffect(() => {\n    if (task.data?.checklistProgress) {\n      console.log('üîÑ Restoring checklist progress:', task.data.checklistProgress);\n      \n      // Restore step completion states\n      const updatedSteps = steps.map((step, index) => {\n        const savedProgress = task.data.checklistProgress[index];\n        if (savedProgress) {\n          return {\n            ...step,\n            completed: savedProgress.completed || false\n          };\n        }\n        return step;\n      });\n      \n      setSteps(updatedSteps);\n      \n      // Restore step data\n      if (task.data.checklistStepData) {\n        setStepData(task.data.checklistStepData);\n      }\n      \n      // Find the current step (first incomplete step)\n      const firstIncompleteStep = updatedSteps.findIndex(step => !step.completed);\n      if (firstIncompleteStep !== -1) {\n        setCurrentStep(firstIncompleteStep);\n      } else {\n        // All steps completed\n        setCurrentStep(updatedSteps.length);\n      }\n    }\n  }, [task.data?.checklistProgress, task.data?.checklistStepData]);\n  const isLastStep = currentStep === steps.length - 1;\n  const progressPercentage = ((currentStep + 1) / steps.length) * 100;\n\n  // Auto-save checklist progress to prevent data loss\n  const saveChecklistProgress = async (updatedSteps?: ChecklistStep[], updatedStepData?: Record<string, any>) => {\n    const stepsToSave = updatedSteps || steps;\n    const dataToSave = updatedStepData || stepData;\n    \n    console.log('üíæ Auto-saving checklist progress:', { \n      stepCount: stepsToSave.length, \n      completedSteps: stepsToSave.filter(s => s.completed).length,\n      currentStep,\n      stepDataKeys: Object.keys(dataToSave)\n    });\n\n    // Create progress object with completion status and timestamps\n    const checklistProgress: Record<string, any> = {};\n    stepsToSave.forEach((step, index) => {\n      if (step.completed) {\n        checklistProgress[index] = {\n          completed: true,\n          completedAt: new Date().toISOString(),\n          stepData: dataToSave[index] || null\n        };\n      }\n    });\n\n    // Save via the onProgress callback which will update the task\n    onProgress({\n      stepIndex: currentStep,\n      stepData: {\n        checklistProgress,\n        checklistStepData: dataToSave,\n        currentStep,\n        completedSteps: stepsToSave.filter(s => s.completed).length,\n        totalSteps: stepsToSave.length\n      }\n    });\n  };\n\n  // Auto-save when stepData changes (debounced)\n  useEffect(() => {\n    const timeoutId = setTimeout(() => {\n      if (Object.keys(stepData).length > 0) {\n        saveChecklistProgress();\n      }\n    }, 1000); // 1 second debounce\n\n    return () => clearTimeout(timeoutId);\n  }, [stepData]);\n\n  // Auto-save when steps completion status changes\n  useEffect(() => {\n    const hasCompletedSteps = steps.some(step => step.completed);\n    if (hasCompletedSteps) {\n      saveChecklistProgress();\n    }\n  }, [steps]);\n\n  // Save progress when component unmounts (user closes modal or navigates away)\n  useEffect(() => {\n    return () => {\n      // Save any unsaved progress on cleanup\n      if (Object.keys(stepData).length > 0 || steps.some(s => s.completed)) {\n        console.log('üö™ Component unmounting, saving final progress');\n        saveChecklistProgress();\n      }\n    };\n  }, []);\n\n  // Fetch inventory items for inventory-select steps\n  const { data: inventoryItems = [] } = useQuery<InventoryItem[]>({\n    queryKey: ['/api/inventory'],\n    queryFn: async () => {\n      const response = await fetch('/api/inventory');\n      if (!response.ok) throw new Error('Failed to fetch inventory');\n      return response.json();\n    },\n  });\n\n  useEffect(() => {\n    // Auto-calculate fields when dependencies change\n    const currentStepData = steps[currentStep];\n    if (currentStepData?.type === 'data-capture' && currentStepData.config.calculation) {\n      const calculation = currentStepData.config.calculation;\n      try {\n        // Simple calculation evaluation (e.g., \"trays * 0.75\")\n        const result = evaluateCalculation(calculation, stepData);\n        if (result !== null) {\n          setStepData(prev => ({ ...prev, [currentStepData.id]: result }));\n        }\n      } catch (error) {\n        console.warn('Calculation error:', error);\n      }\n    }\n  }, [currentStep, stepData, steps]);\n\n  const evaluateCalculation = (calculation: string, data: Record<string, any>): number | null => {\n    // Simple calculation parser for basic math operations\n    try {\n      let expression = calculation;\n      \n      // Replace variables with actual values\n      Object.keys(data).forEach(key => {\n        const value = data[key];\n        if (typeof value === 'number') {\n          expression = expression.replace(new RegExp(`\\\\b${key}\\\\b`, 'g'), value.toString());\n        }\n      });\n      \n      // Replace common variable names\n      expression = expression.replace(/\\btrays\\b/g, data.trays || '0');\n      expression = expression.replace(/\\bweight\\b/g, data.weight || '0');\n      \n      // Evaluate simple mathematical expressions\n      const result = Function(`\"use strict\"; return (${expression})`)();\n      return typeof result === 'number' ? result : null;\n    } catch {\n      return null;\n    }\n  };\n\n  const handleStepComplete = async () => {\n    const step = steps[currentStep];\n    \n    // Validate required fields - skip validation for create-tray steps as they handle their own validation\n    if (step.required && step.type !== 'create-tray' && !stepData[step.id]) {\n      setErrors({ [step.id]: 'This field is required' });\n      return;\n    }\n\n    setIsProcessing(true);\n    setErrors({});\n\n    try {\n      // Process special step types\n      if (step.type === 'system-assignment') {\n        await handleSystemAssignment(step, stepData[step.id]);\n      } else if (step.type === 'movement-trigger') {\n        await handleMovementTrigger(step, stepData[step.id]);\n      } else if (step.type === 'tray-split') {\n        await handleTraySplit(step, stepData[step.id]);\n      } else if (step.type === 'inventory-select') {\n        await handleInventoryDeduction(step, stepData[step.id]);\n      }\n\n      // Mark current step as completed\n      const updatedSteps = steps.map((s, index) => {\n        if (index === currentStep) {\n          return { ...s, completed: true };\n        }\n        return s;\n      });\n      \n      setSteps(updatedSteps);\n      \n      console.log(`‚úÖ Step ${currentStep + 1} completed:`, step.label);\n\n      // Save progress immediately with updated completion status\n      await saveChecklistProgress(updatedSteps, stepData);\n\n      if (isLastStep) {\n        console.log('üéâ All checklist steps completed!');\n        onComplete(stepData);\n      } else {\n        setCurrentStep(currentStep + 1);\n      }\n    } catch (error) {\n      console.error('Error completing step:', error);\n      setErrors({ [step.id]: error instanceof Error ? error.message : 'An error occurred' });\n    } finally {\n      setIsProcessing(false);\n    }\n  };\n\n  const handleSystemAssignment = async (step: ChecklistStep, systemId: string) => {\n    // Update system occupancy\n    const system = systems.find(s => s.id === parseInt(systemId));\n    if (system) {\n      const updatedSystem = {\n        ...system,\n        currentOccupancy: (system.currentOccupancy || 0) + 1\n      };\n      \n      try {\n        await fetch(`/api/growing-systems/${system.id}`, {\n          method: 'PATCH',\n          headers: { 'Content-Type': 'application/json' },\n          body: JSON.stringify(updatedSystem)\n        });\n      } catch (error) {\n        throw new Error('Failed to update system assignment');\n      }\n    }\n  };\n\n  const handleMovementTrigger = async (step: ChecklistStep, movementData: any) => {\n    // Handle tray movement between systems\n    const { fromSystem, toSystem, trayIds } = movementData;\n    \n    try {\n      await fetch('/api/tray-movements', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          trayIds,\n          fromSystem,\n          toSystem,\n          taskId: task.id,\n          timestamp: new Date().toISOString()\n        })\n      });\n    } catch (error) {\n      throw new Error('Failed to record tray movement');\n    }\n  };\n\n  const handleTraySplit = async (step: ChecklistStep, splitData: any) => {\n    // Handle tray splitting for leafy greens\n    const { originalTrayId, splits } = splitData;\n    \n    try {\n      await fetch('/api/tray-splits', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          originalTrayId,\n          splits,\n          taskId: task.id,\n          timestamp: new Date().toISOString()\n        })\n      });\n    } catch (error) {\n      throw new Error('Failed to record tray split');\n    }\n  };\n\n  const handleInventoryDeduction = async (step: ChecklistStep, selectedItems: any) => {\n    // Handle inventory deduction for selected items\n    const items = Array.isArray(selectedItems) ? selectedItems : [selectedItems];\n    \n    try {\n      for (const item of items) {\n        await fetch(`/api/inventory/${item.id}`, {\n          method: 'PATCH',\n          headers: { 'Content-Type': 'application/json' },\n          body: JSON.stringify({\n            currentStock: (item.currentStock || 0) - (item.usedQuantity || 1)\n          })\n        });\n      }\n    } catch (error) {\n      throw new Error('Failed to update inventory');\n    }\n  };\n\n  const renderStepInput = (step: ChecklistStep) => {\n    const stepError = errors[step.id];\n    \n    switch (step.type) {\n      case 'instruction':\n        return (\n          <div className=\"space-y-4\">\n            <div className=\"p-4 bg-blue-50 rounded-lg border-l-4 border-blue-400\">\n              <div className=\"flex items-start text-blue-900\">\n                <FileText className=\"w-5 h-5 mr-3 mt-1 flex-shrink-0\" />\n                <div className=\"flex-1\">\n                  <h4 className=\"font-medium mb-2\">{step.label}</h4>\n                  <p className=\"text-blue-800 text-sm leading-relaxed\">\n                    {step.config.text || step.text || 'No instructions provided'}\n                  </p>\n                </div>\n              </div>\n              <div className=\"mt-3 pt-3 border-t border-blue-200\">\n                <p className=\"text-xs text-blue-600 flex items-center\">\n                  <CheckCircle className=\"w-4 h-4 mr-1\" />\n                  Click \"Complete Step\" below when you've read and understood these instructions\n                </p>\n              </div>\n            </div>\n          </div>\n        );\n\n      case 'checkbox':\n        return (\n          <div className=\"space-y-4\">\n            <div className=\"flex items-center space-x-3\">\n              <Checkbox\n                id={step.id}\n                checked={stepData[step.id] || false}\n                onCheckedChange={(checked) => {\n                  setStepData({ ...stepData, [step.id]: checked });\n                  if (checked) {\n                    handleStepComplete();\n                  }\n                }}\n                className=\"h-5 w-5\"\n              />\n              <Label htmlFor={step.id} className=\"text-base font-medium\">{step.label}</Label>\n            </div>\n            {stepData[step.id] && (\n              <div className=\"flex items-center text-green-600 font-medium\">\n                <CheckCircle className=\"w-4 h-4 mr-2\" />\n                Completed\n              </div>\n            )}\n          </div>\n        );\n\n      case 'number-input':\n        return (\n          <div className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor={step.id} className=\"text-base font-medium\">{step.label}</Label>\n              <div className=\"flex items-center space-x-2\">\n                <Input\n                  id={step.id}\n                  type=\"number\"\n                  value={stepData[step.id] || ''}\n                  onChange={(e) => {\n                    const value = parseInt(e.target.value) || 0;\n                    setStepData({ ...stepData, [step.id]: value });\n                  }}\n                  min={step.config.min || 0}\n                  max={step.config.max || 999}\n                  placeholder={step.config.placeholder || `Enter ${step.config.unit || 'number'}`}\n                  className=\"w-32\"\n                />\n                {step.config.unit && (\n                  <Badge variant=\"outline\" className=\"text-sm\">\n                    {step.config.unit}\n                  </Badge>\n                )}\n              </div>\n            </div>\n            {stepData[step.id] ? (\n              <div className=\"flex items-center justify-between\">\n                <div className=\"flex items-center text-green-600 font-medium\">\n                  <CheckCircle className=\"w-4 h-4 mr-2\" />\n                  Value entered: {stepData[step.id]} {step.config.unit}\n                </div>\n                <Button \n                  onClick={handleStepComplete} \n                  className=\"bg-green-600 hover:bg-green-700\"\n                  disabled={isProcessing}\n                >\n                  Continue\n                </Button>\n              </div>\n            ) : (\n              <p className=\"text-sm text-gray-500\">Enter a value to continue</p>\n            )}\n          </div>\n        );\n\n      case 'inventory-select':\n        // Use pre-configured inventory item from recurring task setup\n        const quantity = stepData[step.id] || step.config.defaultQuantity || '';\n        \n        // Handle case where inventory item isn't properly configured\n        const inventoryItem = {\n          id: step.config.inventoryItemId || '',\n          name: step.config.inventoryItemName || 'Unknown Item',\n          unit: step.config.inventoryUnit || 'units'\n        };\n        \n        // If no item is configured, show error\n        if (!inventoryItem.id) {\n          return (\n            <div className=\"space-y-4\">\n              <div className=\"p-4 bg-red-50 rounded-lg border-l-4 border-red-400\">\n                <div className=\"flex items-center text-red-800\">\n                  <AlertTriangle className=\"w-5 h-5 mr-2\" />\n                  <span className=\"font-medium\">Configuration Error</span>\n                </div>\n                <p className=\"text-sm text-red-700 mt-1\">\n                  This inventory step needs to be configured with an item selection. Please contact your manager to fix the recurring task setup.\n                </p>\n                <p className=\"text-xs text-red-600 mt-2\">\n                  <strong>For managers:</strong> Edit the recurring task and properly configure the inventory step with: item selection, custom text, and default quantity.\n                </p>\n              </div>\n              <Button \n                variant=\"outline\"\n                onClick={() => handleStepSkip(currentStep)}\n                disabled={isProcessing}\n              >\n                Skip Step\n              </Button>\n            </div>\n          );\n        }\n        \n        // Find current stock level for the pre-configured item\n        const currentItem = inventoryItems.find(item => item.id.toString() === inventoryItem.id);\n        const currentStock = currentItem?.currentStock || 0;\n        const hasQuantityError = quantity && parseFloat(quantity) > currentStock;\n        \n        return (\n          <div className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <Label className=\"text-base font-medium\">Record Inventory Usage</Label>\n              <p className=\"text-sm text-gray-600\">{step.config.customText || step.label}</p>\n            </div>\n            \n            {/* Show what item is being tracked */}\n            <div className=\"p-3 bg-blue-50 rounded-lg border-l-4 border-blue-400\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <span className=\"font-medium text-blue-900\">Item: {inventoryItem.name}</span>\n                  <p className=\"text-sm text-blue-700\">\n                    Current stock: {currentStock} {inventoryItem.unit}\n                  </p>\n                </div>\n                <Package className=\"w-5 h-5 text-blue-600\" />\n              </div>\n            </div>\n            \n            {/* Quantity input with default pre-filled */}\n            <div className=\"space-y-2\">\n              <Label htmlFor={step.id}>Amount used:</Label>\n              <div className=\"flex items-center space-x-2\">\n                <Input\n                  id={step.id}\n                  type=\"number\"\n                  value={quantity}\n                  onChange={(e) => setStepData({\n                    ...stepData,\n                    [step.id]: e.target.value\n                  })}\n                  placeholder={step.config.defaultQuantity || \"Enter amount\"}\n                  min=\"0\"\n                  step=\"0.01\"\n                  className=\"w-32\"\n                  autoFocus\n                />\n                <Badge variant=\"outline\">{inventoryItem.unit}</Badge>\n              </div>\n              \n              {hasQuantityError && (\n                <p className=\"text-sm text-red-600\">\n                  ‚ö†Ô∏è This exceeds available stock ({currentStock} {inventoryItem.unit})\n                </p>\n              )}\n            </div>\n\n            {quantity && parseFloat(quantity) > 0 && !hasQuantityError ? (\n              <div className=\"flex items-center justify-between\">\n                <div className=\"flex items-center text-green-600 font-medium\">\n                  <CheckCircle className=\"w-4 h-4 mr-2\" />\n                  Using: {quantity} {inventoryItem.unit} of {inventoryItem.name}\n                </div>\n                <Button \n                  onClick={() => {\n                    setStepData({\n                      ...stepData,\n                      [step.id]: {\n                        itemId: inventoryItem.id,\n                        itemName: inventoryItem.name,\n                        quantity: parseFloat(quantity),\n                        unit: inventoryItem.unit,\n                        action: 'remove'\n                      }\n                    });\n                    handleStepComplete();\n                  }}\n                  className=\"bg-green-600 hover:bg-green-700\"\n                  disabled={isProcessing}\n                >\n                  Record Usage\n                </Button>\n              </div>\n            ) : (\n              <div className=\"flex justify-between items-center\">\n                <p className=\"text-sm text-gray-500\">\n                  {!quantity ? 'Enter quantity to continue' : hasQuantityError ? 'Invalid quantity' : 'Ready to record'}\n                </p>\n                {!quantity && (\n                  <Button \n                    variant=\"outline\"\n                    onClick={() => handleStepSkip(currentStep)}\n                    disabled={isProcessing}\n                  >\n                    Complete Step\n                  </Button>\n                )}\n              </div>\n            )}\n          </div>\n        );\n\n      case 'system-assignment':\n        return (\n          <SystemAssignmentStep\n            step={step}\n            value={stepData[step.id]}\n            onChange={(value) => {\n              setStepData({ ...stepData, [step.id]: value });\n              // Handle system assignments\n              if (typeof value === 'object' && !value.trayId) {\n                // Multiple assignments from split trays\n                Object.entries(value).forEach(([trayId, systemId]) => {\n                  assignTrayToSystem(trayId, systemId as string, 1);\n                });\n              } else if (value?.trayId && value?.systemId) {\n                // Single assignment\n                assignTrayToSystem(value.trayId, value.systemId, 1);\n              }\n            }}\n            trayId={stepContext.currentTrayId}\n            splitTrays={stepContext.splitTrays}\n          />\n        );\n\n      case 'data-capture':\n        const isPercentage = step.label.toLowerCase().includes('percent');\n        return (\n          <div className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor={step.id} className=\"text-base font-medium\">{step.label}</Label>\n              <div className=\"flex items-center space-x-2\">\n                <Input\n                  id={step.id}\n                  type=\"number\"\n                  step={isPercentage ? \"1\" : \"0.1\"}\n                  min={isPercentage ? 0 : 0}\n                  max={isPercentage ? 100 : 999}\n                  value={stepData[step.id] || ''}\n                  onChange={(e) => {\n                    let value = parseFloat(e.target.value) || 0;\n                    if (isPercentage && value > 100) value = 100;\n                    if (isPercentage && value < 0) value = 0;\n                    setStepData({ ...stepData, [step.id]: value });\n                  }}\n                  placeholder={isPercentage ? \"0\" : \"Enter value\"}\n                  className=\"w-32\"\n                />\n                <Badge variant=\"outline\" className=\"text-sm\">\n                  {isPercentage ? '%' : 'units'}\n                </Badge>\n              </div>\n              {step.config.calculation && (\n                <p className=\"text-sm text-blue-600 mt-1\">\n                  Auto-calculated: {step.config.calculation}\n                </p>\n              )}\n            </div>\n            {stepData[step.id] !== undefined && stepData[step.id] !== '' && stepData[step.id] !== 0 ? (\n              <div className=\"flex items-center justify-between\">\n                <div className=\"flex items-center text-green-600 font-medium\">\n                  <CheckCircle className=\"w-4 h-4 mr-2\" />\n                  Recorded: {stepData[step.id]}{isPercentage ? '%' : ' units'}\n                </div>\n                <Button \n                  onClick={handleStepComplete} \n                  className=\"bg-green-600 hover:bg-green-700\"\n                  disabled={isProcessing}\n                >\n                  Save Data\n                </Button>\n              </div>\n            ) : (\n              <p className=\"text-sm text-gray-500\">Enter a value to continue</p>\n            )}\n          </div>\n        );\n\n      case 'photo':\n        const photoData = stepData[step.id];\n        const hasPhoto = photoData && (photoData.timestamp || photoData);\n        \n        return (\n          <div className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <Label className=\"text-base font-medium\">{step.label}</Label>\n              \n              {hasPhoto ? (\n                <div className=\"space-y-3\">\n                  <div className=\"p-4 bg-green-50 rounded-lg border-l-4 border-green-400\">\n                    <div className=\"flex items-center text-green-700\">\n                      <Camera className=\"w-5 h-5 mr-2\" />\n                      <span className=\"font-medium\">Photo captured successfully</span>\n                    </div>\n                    <p className=\"text-sm text-green-600 mt-1\">\n                      Captured: {new Date(photoData.timestamp || photoData).toLocaleString()}\n                    </p>\n                  </div>\n                  \n                  <div className=\"flex space-x-2\">\n                    <Button \n                      onClick={() => {\n                        // Simulate file input click for photo retake\n                        const photoTimestamp = new Date().toISOString();\n                        setStepData({ \n                          ...stepData, \n                          [step.id]: {\n                            timestamp: photoTimestamp,\n                            filename: `task_${task.id}_step_${step.id}_${Date.now()}.jpg`\n                          }\n                        });\n                      }}\n                      variant=\"outline\"\n                      className=\"flex-1\"\n                    >\n                      <Camera className=\"w-4 h-4 mr-2\" />\n                      Retake Photo\n                    </Button>\n                    \n                    <Button \n                      onClick={handleStepComplete}\n                      className=\"flex-1 bg-green-600 hover:bg-green-700\"\n                      disabled={isProcessing}\n                    >\n                      Continue\n                    </Button>\n                  </div>\n                </div>\n              ) : (\n                <div className=\"space-y-3\">\n                  <div className=\"border-2 border-dashed border-gray-300 rounded-lg p-6 text-center\">\n                    <Camera className=\"w-12 h-12 text-gray-400 mx-auto mb-3\" />\n                    <p className=\"text-gray-600 mb-3\">Take a photo to document this step</p>\n                    \n                    <div className=\"space-y-2\">\n                      <Button \n                        onClick={() => {\n                          // Simulate camera capture\n                          const photoTimestamp = new Date().toISOString();\n                          setStepData({ \n                            ...stepData, \n                            [step.id]: {\n                              timestamp: photoTimestamp,\n                              filename: `task_${task.id}_step_${step.id}_${Date.now()}.jpg`\n                            }\n                          });\n                        }}\n                        className=\"bg-blue-600 hover:bg-blue-700\"\n                      >\n                        <Camera className=\"w-4 h-4 mr-2\" />\n                        Capture Photo\n                      </Button>\n                      \n                      <p className=\"text-xs text-gray-500\">\n                        Opens camera on mobile devices\n                      </p>\n                    </div>\n                  </div>\n                </div>\n              )}\n            </div>\n          </div>\n        );\n\n      case 'movement-trigger':\n        return (\n          <div className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <Label className=\"text-base font-medium\">{step.label}</Label>\n              {stepData[step.id] ? (\n                <div className=\"p-4 bg-green-50 rounded-lg border-l-4 border-green-400\">\n                  <div className=\"flex items-center text-green-700\">\n                    <ArrowRight className=\"w-5 h-5 mr-2\" />\n                    <span className=\"font-medium\">Movement completed</span>\n                  </div>\n                  <p className=\"text-sm text-green-600 mt-1\">\n                    Completed at: {new Date(stepData[step.id]).toLocaleString()}\n                  </p>\n                </div>\n              ) : (\n                <div className=\"p-4 bg-yellow-50 rounded-lg border-l-4 border-yellow-400\">\n                  <p className=\"text-yellow-800\">Ready to execute movement action</p>\n                </div>\n              )}\n            </div>\n            {!stepData[step.id] ? (\n              <Button \n                onClick={() => {\n                  setStepData({ ...stepData, [step.id]: new Date().toISOString() });\n                  handleStepComplete();\n                }}\n                className=\"w-full bg-green-600 hover:bg-green-700\"\n                disabled={isProcessing}\n              >\n                <ArrowRight className=\"w-4 h-4 mr-2\" />\n                Execute Movement\n              </Button>\n            ) : (\n              <div className=\"flex items-center text-green-600 font-medium\">\n                <CheckCircle className=\"w-4 h-4 mr-2\" />\n                Movement Complete\n              </div>\n            )}\n          </div>\n        );\n\n      case 'tray-split':\n        const currentSplitData = stepData[step.id];\n        return (\n          <div className=\"space-y-4\">\n            <TraySplitStep\n              step={step}\n              value={currentSplitData}\n              onChange={(value) => {\n                setStepData({ ...stepData, [step.id]: value });\n                // Update context for next steps\n                if (value?.splits) {\n                  setStepContext(prev => ({\n                    ...prev,\n                    splitTrays: value.splits\n                  }));\n                }\n              }}\n              trayId={stepContext.currentTrayId}\n            />\n            \n            {/* Show complete step button when tray and split count are selected */}\n            {currentSplitData?.trayId && currentSplitData?.count && (\n              <div className=\"pt-4 border-t\">\n                <Button \n                  onClick={async () => {\n                    console.log('ChecklistExecution: Executing tray split...');\n                    try {\n                      // Execute the actual split operation\n                      if (currentSplitData.executeSplit) {\n                        const splitResult = currentSplitData.executeSplit();\n                        console.log('ChecklistExecution: Split executed:', splitResult);\n                      } else {\n                        console.warn('ChecklistExecution: No executeSplit method found, performing direct split');\n                        // Fallback to direct split\n                        const TrayDataService = (await import('../services/trayDataService')).default;\n                        const splitResult = TrayDataService.splitTray(currentSplitData.trayId, currentSplitData.count);\n                        console.log('ChecklistExecution: Fallback split executed:', splitResult);\n                      }\n                      \n                      // Mark step as complete and continue\n                      handleStepComplete();\n                    } catch (error) {\n                      console.error('ChecklistExecution: Split execution failed:', error);\n                      setErrors({ ...errors, [step.id]: 'Failed to execute tray split. Please try again.' });\n                    }\n                  }}\n                  className=\"w-full bg-green-600 hover:bg-green-700\"\n                  disabled={isProcessing}\n                >\n                  <Split className=\"w-4 h-4 mr-2\" />\n                  Execute Tray Split ({currentSplitData.count} new trays)\n                </Button>\n              </div>\n            )}\n          </div>\n        );\n\n      case 'create-tray':\n        return (\n          <div className=\"space-y-4\">\n            <CreateTrayStep\n              stepData={step.config}\n              onComplete={(data) => {\n                // Update step data with tray creation results\n                setStepData({ ...stepData, [step.id]: data });\n                \n                // Update context with new tray ID for subsequent steps\n                if (data.trayId) {\n                  setStepContext(prev => ({\n                    ...prev,\n                    currentTrayId: data.trayId\n                  }));\n                }\n                \n                // Mark step as complete and continue\n                handleStepComplete();\n              }}\n              defaultInstance={step.config?.defaultInstance || 1}\n              defaultTrayType={step.config?.defaultTrayType || 'LG'}\n              defaultSeedsOz={step.config?.defaultSeedsOz || ''}\n              defaultGrowingMedium={step.config?.defaultGrowingMedium || ''}\n              instructions={step.config?.instructions || ''}\n            />\n          </div>\n        );\n\n      default:\n        return (\n          <div className=\"space-y-4\">\n            <p className=\"text-gray-500\">Step type: {step.type}</p>\n            <Button \n              onClick={handleStepComplete} \n              className=\"w-full\"\n              disabled={isProcessing}\n            >\n              Continue\n            </Button>\n          </div>\n        );\n    }\n  };\n\n  const getStepIcon = (type: string) => {\n    const icons = {\n      instruction: FileText,\n      checkbox: CheckCircle,\n      'number-input': BarChart3,\n      'inventory-select': Package,\n      'system-assignment': Building,\n      'data-capture': BarChart3,\n      photo: Camera,\n      'tray-split': Split,\n      'movement-trigger': ArrowRight,\n      'create-tray': PlusCircle\n    };\n    return icons[type as keyof typeof icons] || Circle;\n  };\n\n  // Calculate progress including instruction steps (they can be checked off)\n  const calculateProgress = (steps: any[]) => {\n    if (steps.length === 0) return 100;\n    \n    const completedOrSkipped = steps.filter(s => s.completed || (s as any).skipped);\n    return Math.round((completedOrSkipped.length / steps.length) * 100);\n  };\n\n  // Handle step skip with proper error handling\n  const handleStepSkip = (stepIndex: number) => {\n    try {\n      const updatedSteps = [...steps];\n      \n      // Ensure the step exists\n      if (!updatedSteps[stepIndex]) {\n        console.error('Invalid step index:', stepIndex);\n        return;\n      }\n      \n      // Mark step as completed (not skipped anymore!)\n      updatedSteps[stepIndex] = {\n        ...updatedSteps[stepIndex],\n        completed: true,\n        skipped: false\n      };\n      \n      setSteps(updatedSteps);\n      \n      // Move to next step if available\n      const nextIndex = stepIndex + 1;\n      if (nextIndex < steps.length) {\n        setCurrentStep(nextIndex);\n      } else {\n        // All steps processed - show completion message but don't auto-complete task\n        setCurrentStep(steps.length); // This will show the completion section\n      }\n    } catch (error) {\n      console.error('Error completing step:', error);\n      setErrors({ ...errors, [steps[stepIndex]?.id]: 'Unable to complete step. Please try again.' });\n    }\n  };\n\n  return (\n    <div className=\"space-y-4\">\n      {/* Progress Header */}\n      <div className=\"space-y-2\">\n        <div className=\"flex items-center justify-between\">\n          <h3 className=\"text-lg font-semibold\">Task Checklist</h3>\n          <Badge variant=\"outline\">\n            {steps.filter(s => s.completed || s.skipped).length} of {steps.length} Steps\n          </Badge>\n        </div>\n        <Progress value={calculateProgress(steps)} className=\"w-full\" />\n      </div>\n\n      {/* Steps with Inline Inputs */}\n      <div className=\"space-y-3\">\n        {steps.map((step, index) => {\n          const StepIcon = getStepIcon(step.type);\n          const isCompleted = step.completed;\n          const isSkipped = step.skipped;\n          const isCurrent = index === currentStep && !isCompleted && !isSkipped;\n          \n          return (\n            <div key={step.id} className=\"space-y-2\">\n              {/* Step Item */}\n              <div \n                className={`\n                  flex items-center space-x-3 p-3 rounded-lg border cursor-pointer transition-all\n                  ${isCurrent ? 'bg-blue-50 border-blue-200 border-l-4 border-l-blue-500' : 'bg-white border-gray-200'}\n                  ${isCompleted ? 'bg-green-50 border-green-200' : ''}\n                  ${isSkipped ? 'bg-gray-50 border-gray-200 opacity-60' : ''}\n                `}\n                onClick={() => !isCompleted && !isSkipped && setCurrentStep(index)}\n              >\n                <div className=\"flex-shrink-0\">\n                  {isCompleted ? (\n                    <CheckCircle className=\"w-5 h-5 text-green-600\" />\n                  ) : isSkipped ? (\n                    <div className=\"w-5 h-5 flex items-center justify-center text-gray-500\">‚è≠Ô∏è</div>\n                  ) : (\n                    <StepIcon className={`w-5 h-5 ${isCurrent ? 'text-blue-600' : 'text-gray-400'}`} />\n                  )}\n                </div>\n                \n                <div className=\"flex-1\">\n                  <span className={`font-medium ${isSkipped ? 'line-through text-gray-500' : isCurrent ? 'text-blue-900' : isCompleted ? 'text-green-900' : 'text-gray-700'}`}>\n                    {step.text || step.label}\n                  </span>\n                </div>\n                \n                <Badge variant=\"outline\" className=\"text-xs\">\n                  Step {index + 1}\n                </Badge>\n              </div>\n\n              {/* Inline Input Block for Current Step */}\n              {isCurrent && (\n                <div className=\"ml-8 p-4 bg-gray-50 rounded-lg border border-gray-200\">\n                  {renderStepInput(step)}\n                  \n                  {/* Complete Step Button */}\n                  <div className=\"flex justify-end mt-3\">\n                    <Button\n                      variant=\"outline\"\n                      size=\"sm\"\n                      onClick={() => handleStepSkip(index)}\n                      className=\"text-green-600 hover:text-green-800\"\n                    >\n                      Complete Step\n                    </Button>\n                  </div>\n                  \n                  {errors[step.id] && (\n                    <Alert className=\"mt-3\" variant=\"destructive\">\n                      <AlertTriangle className=\"h-4 w-4\" />\n                      <AlertDescription>\n                        {errors[step.id]}\n                      </AlertDescription>\n                    </Alert>\n                  )}\n                </div>\n              )}\n            </div>\n          );\n        })}\n      </div>\n\n      {/* Checklist completion message - Task completion is separate */}\n      {currentStep >= steps.length && (\n        <div className=\"checklist-complete space-y-4 mt-6 pt-4 border-t bg-green-50 p-4 rounded-lg border-l-4 border-l-green-500\">\n          <div className=\"flex items-center justify-center text-green-600\">\n            <CheckCircle className=\"w-6 h-6 mr-2\" />\n            <span className=\"font-medium\">‚úÖ All checklist items completed!</span>\n          </div>\n          <p className=\"completion-note text-center text-green-700 text-sm\">\n            Please complete any remaining work, then click \"Complete Task\" in the task modal.\n          </p>\n          <p className=\"text-center text-green-600 text-xs\">\n            The task will remain open until you explicitly mark it as complete.\n          </p>\n        </div>\n      )}\n    </div>\n  );\n};\n\nexport default ChecklistExecution;","path":null,"size_bytes":41104,"size_tokens":null},"client/src/components/ui/breadcrumb.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { ChevronRight, MoreHorizontal } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Breadcrumb = React.forwardRef<\n  HTMLElement,\n  React.ComponentPropsWithoutRef<\"nav\"> & {\n    separator?: React.ReactNode\n  }\n>(({ ...props }, ref) => <nav ref={ref} aria-label=\"breadcrumb\" {...props} />)\nBreadcrumb.displayName = \"Breadcrumb\"\n\nconst BreadcrumbList = React.forwardRef<\n  HTMLOListElement,\n  React.ComponentPropsWithoutRef<\"ol\">\n>(({ className, ...props }, ref) => (\n  <ol\n    ref={ref}\n    className={cn(\n      \"flex flex-wrap items-center gap-1.5 break-words text-sm text-muted-foreground sm:gap-2.5\",\n      className\n    )}\n    {...props}\n  />\n))\nBreadcrumbList.displayName = \"BreadcrumbList\"\n\nconst BreadcrumbItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentPropsWithoutRef<\"li\">\n>(({ className, ...props }, ref) => (\n  <li\n    ref={ref}\n    className={cn(\"inline-flex items-center gap-1.5\", className)}\n    {...props}\n  />\n))\nBreadcrumbItem.displayName = \"BreadcrumbItem\"\n\nconst BreadcrumbLink = React.forwardRef<\n  HTMLAnchorElement,\n  React.ComponentPropsWithoutRef<\"a\"> & {\n    asChild?: boolean\n  }\n>(({ asChild, className, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"a\"\n\n  return (\n    <Comp\n      ref={ref}\n      className={cn(\"transition-colors hover:text-foreground\", className)}\n      {...props}\n    />\n  )\n})\nBreadcrumbLink.displayName = \"BreadcrumbLink\"\n\nconst BreadcrumbPage = React.forwardRef<\n  HTMLSpanElement,\n  React.ComponentPropsWithoutRef<\"span\">\n>(({ className, ...props }, ref) => (\n  <span\n    ref={ref}\n    role=\"link\"\n    aria-disabled=\"true\"\n    aria-current=\"page\"\n    className={cn(\"font-normal text-foreground\", className)}\n    {...props}\n  />\n))\nBreadcrumbPage.displayName = \"BreadcrumbPage\"\n\nconst BreadcrumbSeparator = ({\n  children,\n  className,\n  ...props\n}: React.ComponentProps<\"li\">) => (\n  <li\n    role=\"presentation\"\n    aria-hidden=\"true\"\n    className={cn(\"[&>svg]:w-3.5 [&>svg]:h-3.5\", className)}\n    {...props}\n  >\n    {children ?? <ChevronRight />}\n  </li>\n)\nBreadcrumbSeparator.displayName = \"BreadcrumbSeparator\"\n\nconst BreadcrumbEllipsis = ({\n  className,\n  ...props\n}: React.ComponentProps<\"span\">) => (\n  <span\n    role=\"presentation\"\n    aria-hidden=\"true\"\n    className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n    {...props}\n  >\n    <MoreHorizontal className=\"h-4 w-4\" />\n    <span className=\"sr-only\">More</span>\n  </span>\n)\nBreadcrumbEllipsis.displayName = \"BreadcrumbElipssis\"\n\nexport {\n  Breadcrumb,\n  BreadcrumbList,\n  BreadcrumbItem,\n  BreadcrumbLink,\n  BreadcrumbPage,\n  BreadcrumbSeparator,\n  BreadcrumbEllipsis,\n}\n","path":null,"size_bytes":2712,"size_tokens":null},"client/src/components/ui/resizable.tsx":{"content":"\"use client\"\n\nimport { GripVertical } from \"lucide-react\"\nimport * as ResizablePrimitive from \"react-resizable-panels\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ResizablePanelGroup = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof ResizablePrimitive.PanelGroup>) => (\n  <ResizablePrimitive.PanelGroup\n    className={cn(\n      \"flex h-full w-full data-[panel-group-direction=vertical]:flex-col\",\n      className\n    )}\n    {...props}\n  />\n)\n\nconst ResizablePanel = ResizablePrimitive.Panel\n\nconst ResizableHandle = ({\n  withHandle,\n  className,\n  ...props\n}: React.ComponentProps<typeof ResizablePrimitive.PanelResizeHandle> & {\n  withHandle?: boolean\n}) => (\n  <ResizablePrimitive.PanelResizeHandle\n    className={cn(\n      \"relative flex w-px items-center justify-center bg-border after:absolute after:inset-y-0 after:left-1/2 after:w-1 after:-translate-x-1/2 focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring focus-visible:ring-offset-1 data-[panel-group-direction=vertical]:h-px data-[panel-group-direction=vertical]:w-full data-[panel-group-direction=vertical]:after:left-0 data-[panel-group-direction=vertical]:after:h-1 data-[panel-group-direction=vertical]:after:w-full data-[panel-group-direction=vertical]:after:-translate-y-1/2 data-[panel-group-direction=vertical]:after:translate-x-0 [&[data-panel-group-direction=vertical]>div]:rotate-90\",\n      className\n    )}\n    {...props}\n  >\n    {withHandle && (\n      <div className=\"z-10 flex h-4 w-3 items-center justify-center rounded-sm border bg-border\">\n        <GripVertical className=\"h-2.5 w-2.5\" />\n      </div>\n    )}\n  </ResizablePrimitive.PanelResizeHandle>\n)\n\nexport { ResizablePanelGroup, ResizablePanel, ResizableHandle }\n","path":null,"size_bytes":1723,"size_tokens":null},"tailwind.config.ts":{"content":"import type { Config } from \"tailwindcss\";\n\nexport default {\n  darkMode: [\"class\"],\n  content: [\"./client/index.html\", \"./client/src/**/*.{js,jsx,ts,tsx}\"],\n  theme: {\n    extend: {\n      borderRadius: {\n        lg: \"var(--radius)\",\n        md: \"calc(var(--radius) - 2px)\",\n        sm: \"calc(var(--radius) - 4px)\",\n      },\n      colors: {\n        background: \"var(--background)\",\n        foreground: \"var(--foreground)\",\n        card: {\n          DEFAULT: \"var(--card)\",\n          foreground: \"var(--card-foreground)\",\n        },\n        popover: {\n          DEFAULT: \"var(--popover)\",\n          foreground: \"var(--popover-foreground)\",\n        },\n        primary: {\n          DEFAULT: \"var(--primary)\",\n          foreground: \"var(--primary-foreground)\",\n        },\n        secondary: {\n          DEFAULT: \"var(--secondary)\",\n          foreground: \"var(--secondary-foreground)\",\n        },\n        muted: {\n          DEFAULT: \"var(--muted)\",\n          foreground: \"var(--muted-foreground)\",\n        },\n        accent: {\n          DEFAULT: \"var(--accent)\",\n          foreground: \"var(--accent-foreground)\",\n        },\n        destructive: {\n          DEFAULT: \"var(--destructive)\",\n          foreground: \"var(--destructive-foreground)\",\n        },\n        border: \"var(--border)\",\n        input: \"var(--input)\",\n        ring: \"var(--ring)\",\n        chart: {\n          \"1\": \"var(--chart-1)\",\n          \"2\": \"var(--chart-2)\",\n          \"3\": \"var(--chart-3)\",\n          \"4\": \"var(--chart-4)\",\n          \"5\": \"var(--chart-5)\",\n        },\n        sidebar: {\n          DEFAULT: \"var(--sidebar-background)\",\n          foreground: \"var(--sidebar-foreground)\",\n          primary: \"var(--sidebar-primary)\",\n          \"primary-foreground\": \"var(--sidebar-primary-foreground)\",\n          accent: \"var(--sidebar-accent)\",\n          \"accent-foreground\": \"var(--sidebar-accent-foreground)\",\n          border: \"var(--sidebar-border)\",\n          ring: \"var(--sidebar-ring)\",\n        },\n      },\n      keyframes: {\n        \"accordion-down\": {\n          from: {\n            height: \"0\",\n          },\n          to: {\n            height: \"var(--radix-accordion-content-height)\",\n          },\n        },\n        \"accordion-up\": {\n          from: {\n            height: \"var(--radix-accordion-content-height)\",\n          },\n          to: {\n            height: \"0\",\n          },\n        },\n      },\n      animation: {\n        \"accordion-down\": \"accordion-down 0.2s ease-out\",\n        \"accordion-up\": \"accordion-up 0.2s ease-out\",\n      },\n    },\n  },\n  plugins: [require(\"tailwindcss-animate\"), require(\"@tailwindcss/typography\")],\n} satisfies Config;\n","path":null,"size_bytes":2627,"size_tokens":null},"client/src/components/TaskStatusIndicators.tsx":{"content":"import { Badge } from \"@/components/ui/badge\";\nimport { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from \"@/components/ui/tooltip\";\nimport { Sync, LinkOff, AlertCircle, Clock, CheckCircle2, Sparkles } from \"lucide-react\";\n\ninterface TaskStatusIndicatorsProps {\n  task: {\n    id: number;\n    title: string;\n    status: string;\n    isRecurring?: boolean;\n    recurringTaskId?: number | null;\n    templateVersion?: number;\n    isModifiedAfterCreation?: boolean;\n    modifiedFromTemplateAt?: string | null;\n    isFromDeletedRecurring?: boolean;\n    deletedRecurringTaskTitle?: string;\n  };\n  recurringTasks?: Array<{\n    id: number;\n    title: string;\n    versionNumber?: number;\n  }>;\n}\n\nconst TaskStatusIndicators: React.FC<TaskStatusIndicatorsProps> = ({ task, recurringTasks = [] }) => {\n  const getTemplateInfo = () => {\n    if (!task.recurringTaskId) return null;\n    return recurringTasks.find(rt => rt.id === task.recurringTaskId);\n  };\n\n  const templateInfo = getTemplateInfo();\n  const isOutdated = templateInfo && task.templateVersion && \n    templateInfo.versionNumber && task.templateVersion < templateInfo.versionNumber;\n\n  return (\n    <div className=\"flex items-center gap-1\">\n      {/* Recurring Task Link Indicator */}\n      {task.isRecurring && task.recurringTaskId && !task.isFromDeletedRecurring && (\n        <TooltipProvider>\n          <Tooltip>\n            <TooltipTrigger>\n              <Badge variant=\"outline\" className=\"text-xs px-1 py-0 h-5 bg-blue-50 border-blue-200\">\n                <Sync className=\"h-3 w-3 text-blue-600\" />\n              </Badge>\n            </TooltipTrigger>\n            <TooltipContent>\n              <p className=\"text-xs\">\n                Linked to recurring template\n                {templateInfo && (\n                  <>\n                    <br />\n                    <span className=\"font-medium\">\"{templateInfo.title}\"</span>\n                    {task.templateVersion && (\n                      <>\n                        <br />\n                        Template v{templateInfo.versionNumber || 1} (Task v{task.templateVersion})\n                      </>\n                    )}\n                  </>\n                )}\n              </p>\n            </TooltipContent>\n          </Tooltip>\n        </TooltipProvider>\n      )}\n\n      {/* Broken Link Indicator (Template Deleted) */}\n      {task.isFromDeletedRecurring && (\n        <TooltipProvider>\n          <Tooltip>\n            <TooltipTrigger>\n              <Badge variant=\"outline\" className=\"text-xs px-1 py-0 h-5 bg-gray-50 border-gray-300\">\n                <LinkOff className=\"h-3 w-3 text-gray-500\" />\n              </Badge>\n            </TooltipTrigger>\n            <TooltipContent>\n              <p className=\"text-xs\">\n                Template was deleted\n                <br />\n                <span className=\"font-medium\">\"{task.deletedRecurringTaskTitle}\"</span>\n                <br />\n                This task will continue as standalone\n              </p>\n            </TooltipContent>\n          </Tooltip>\n        </TooltipProvider>\n      )}\n\n      {/* Outdated Template Version */}\n      {isOutdated && (\n        <TooltipProvider>\n          <Tooltip>\n            <TooltipTrigger>\n              <Badge variant=\"outline\" className=\"text-xs px-1 py-0 h-5 bg-yellow-50 border-yellow-300\">\n                <AlertCircle className=\"h-3 w-3 text-yellow-600\" />\n              </Badge>\n            </TooltipTrigger>\n            <TooltipContent>\n              <p className=\"text-xs\">\n                Template has been updated\n                <br />\n                Task version: {task.templateVersion}\n                <br />\n                Latest version: {templateInfo?.versionNumber}\n                <br />\n                <span className=\"text-yellow-700\">Consider updating this task</span>\n              </p>\n            </TooltipContent>\n          </Tooltip>\n        </TooltipProvider>\n      )}\n\n      {/* Modified After Creation */}\n      {task.isModifiedAfterCreation && (\n        <TooltipProvider>\n          <Tooltip>\n            <TooltipTrigger>\n              <Badge variant=\"outline\" className=\"text-xs px-1 py-0 h-5 bg-purple-50 border-purple-200\">\n                <Sparkles className=\"h-3 w-3 text-purple-600\" />\n              </Badge>\n            </TooltipTrigger>\n            <TooltipContent>\n              <p className=\"text-xs\">\n                Task was manually modified\n                <br />\n                {task.modifiedFromTemplateAt && (\n                  <>\n                    Last updated: {new Date(task.modifiedFromTemplateAt).toLocaleDateString()}\n                    <br />\n                  </>\n                )}\n                <span className=\"text-purple-700\">May differ from template</span>\n              </p>\n            </TooltipContent>\n          </Tooltip>\n        </TooltipProvider>\n      )}\n\n      {/* Recently Updated Badge */}\n      {task.modifiedFromTemplateAt && (\n        (() => {\n          const modifiedDate = new Date(task.modifiedFromTemplateAt);\n          const now = new Date();\n          const daysDiff = Math.floor((now.getTime() - modifiedDate.getTime()) / (1000 * 60 * 60 * 24));\n          \n          if (daysDiff <= 3) {\n            return (\n              <TooltipProvider>\n                <Tooltip>\n                  <TooltipTrigger>\n                    <Badge className=\"text-xs px-2 py-0 h-5 bg-green-600 hover:bg-green-700\">\n                      Updated\n                    </Badge>\n                  </TooltipTrigger>\n                  <TooltipContent>\n                    <p className=\"text-xs\">\n                      Recently updated from template\n                      <br />\n                      {daysDiff === 0 ? 'Today' : `${daysDiff} day${daysDiff > 1 ? 's' : ''} ago`}\n                    </p>\n                  </TooltipContent>\n                </Tooltip>\n              </TooltipProvider>\n            );\n          }\n          return null;\n        })()\n      )}\n\n      {/* Task Status Indicators */}\n      {task.status === 'in_progress' && (\n        <Badge variant=\"outline\" className=\"text-xs px-1 py-0 h-5 bg-blue-50 border-blue-200\">\n          <Clock className=\"h-3 w-3 text-blue-600 mr-1\" />\n          In Progress\n        </Badge>\n      )}\n\n      {task.status === 'completed' && (\n        <Badge variant=\"outline\" className=\"text-xs px-1 py-0 h-5 bg-green-50 border-green-200\">\n          <CheckCircle2 className=\"h-3 w-3 text-green-600 mr-1\" />\n          Complete\n        </Badge>\n      )}\n    </div>\n  );\n};\n\nexport default TaskStatusIndicators;","path":null,"size_bytes":6551,"size_tokens":null},"client/src/data/locationsData.ts":{"content":"export interface Location {\n  id: string;\n  name: string;\n  code: string; // Short code for IDs (K for Kenosha, R for Racine)\n  address?: string;\n  isActive: boolean;\n  createdDate: Date;\n  settings?: {\n    timezone?: string;\n    workingHours?: {\n      start: string;\n      end: string;\n    };\n  };\n}\n\nexport const locations: Location[] = [\n  {\n    id: 'kenosha',\n    name: 'Kenosha',\n    code: 'K',\n    address: '123 Farm Road, Kenosha, WI',\n    isActive: true,\n    createdDate: new Date('2023-01-01')\n  },\n  {\n    id: 'racine-dev',\n    name: 'Racine (Dev)',\n    code: 'R',\n    address: '456 Test Street, Racine, WI',\n    isActive: true,\n    createdDate: new Date('2024-01-01')\n  }\n];\n\n// Update user mock data with location assignments\n// Production launch - mock users removed, using dynamic Microsoft authentication","path":null,"size_bytes":819,"size_tokens":null},"client/src/utils/dateUtils.ts":{"content":"// Date utility functions for consistent date handling across the app\n\n/**\n * Compare two dates to see if they represent the same calendar day\n * Handles both string and Date objects, avoiding timezone issues\n */\nexport const isSameDay = (date1: Date | string, date2: Date | string): boolean => {\n  if (!date1 || !date2) return false;\n  \n  try {\n    // Convert both dates to YYYY-MM-DD format for comparison\n    const d1Str = formatDateForComparison(date1);\n    const d2Str = formatDateForComparison(date2);\n    \n    return d1Str === d2Str;\n  } catch (error) {\n    console.error('Date comparison error:', error);\n    return false;\n  }\n};\n\n/**\n * Format a date as YYYY-MM-DD for consistent comparison\n * Handles timezone issues by using UTC methods for stored UTC dates\n */\nexport const formatDateForComparison = (date: Date | string): string => {\n  if (!date) return '';\n  \n  try {\n    if (typeof date === 'string') {\n      // Handle ISO strings like \"2025-08-01T00:00:00.000Z\"\n      if (date.includes('T')) {\n        return date.split('T')[0]; // Extract \"2025-08-01\" part\n      }\n      // Handle date strings like \"2025-08-01\"\n      if (date.match(/^\\d{4}-\\d{2}-\\d{2}$/)) {\n        return date;\n      }\n      // Try to parse other string formats\n      date = new Date(date);\n    }\n    \n    if (date instanceof Date) {\n      // Use UTC methods to avoid timezone conversion\n      const year = date.getUTCFullYear();\n      const month = String(date.getUTCMonth() + 1).padStart(2, '0');\n      const day = String(date.getUTCDate()).padStart(2, '0');\n      return `${year}-${month}-${day}`;\n    }\n    \n    return '';\n  } catch (error) {\n    console.error('Date formatting error:', error);\n    return '';\n  }\n};\n\n/**\n * Check if a task should appear on a specific date\n * FIXED: Tasks now show ONLY on their exact due date (no more date ranges)\n */\nexport const shouldTaskAppearOnDate = (task: any, targetDate: string): boolean => {\n  if (!task || !targetDate) return false;\n  \n  // ALL TASKS: Show only on exact due date\n  const dueDate = formatDateForComparison(task.dueDate);\n  \n  if (dueDate) {\n    const matches = targetDate === dueDate;\n    if (!matches) {\n      // Only log mismatches for debugging\n      // console.log(`[dateUtils] ‚ùå \"${task.title}\" | DueDate: ${dueDate} ‚â† ViewDate: ${targetDate}`);\n    }\n    return matches;\n  }\n  \n  // Fallback: Use taskDate if no dueDate (shouldn't happen with new tasks)\n  const taskDate = formatDateForComparison(task.taskDate);\n  if (taskDate) {\n    const matches = targetDate === taskDate;\n    console.log(`[dateUtils] üìÖ FALLBACK - \"${task.title}\" | TaskDate: ${taskDate} | ViewDate: ${targetDate} | Match: ${matches ? 'YES ‚úÖ' : 'NO ‚ùå'}`);\n    return matches;\n  }\n  \n  console.log(`üîç Task \"${task.title}\" has no valid dates - NO MATCH`);\n  return false;\n};\n\n/**\n * Get today's date in YYYY-MM-DD format (UTC timezone)\n * TIMEZONE FIX: Now uses UTC to match database storage and server-side task generation\n */\nexport const getTodayString = (): string => {\n  const today = new Date();\n  // Use UTC methods to match database storage timezone\n  const year = today.getUTCFullYear();\n  const month = String(today.getUTCMonth() + 1).padStart(2, '0');\n  const day = String(today.getUTCDate()).padStart(2, '0');\n  return `${year}-${month}-${day}`;\n};\n\n/**\n * Debug function to log date comparison details\n */\nexport const debugDateComparison = (taskDate: any, filterDate: any, taskTitle?: string): void => {\n  const task = taskTitle ? `\"${taskTitle}\"` : 'Task';\n  const taskFormatted = formatDateForComparison(taskDate);\n  const filterFormatted = formatDateForComparison(filterDate);\n  const matches = isSameDay(taskDate, filterDate);\n  \n  console.log(`üìÖ ${task}: ${taskDate} ‚Üí ${taskFormatted} vs ${filterFormatted} = ${matches ? '‚úÖ' : '‚ùå'}`);\n};\n\n/**\n * Check if a task is overdue\n * A task is overdue if its due date is before today and it's not completed/skipped\n */\nexport const isTaskOverdue = (task: { dueDate?: string | Date | null; status?: string }): boolean => {\n  // Completed or skipped tasks are never overdue\n  if (!task.dueDate || task.status === 'completed' || task.status === 'approved' || task.status === 'skipped') {\n    return false;\n  }\n  \n  // Get current date at midnight (start of day) in local time\n  const now = new Date();\n  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());\n  \n  // Parse due date - use UTC to avoid timezone issues\n  const dueDateStr = formatDateForComparison(task.dueDate);\n  if (!dueDateStr) return false;\n  \n  const [year, month, day] = dueDateStr.split('-').map(Number);\n  const dueDate = new Date(year, month - 1, day);\n  \n  // Task is overdue if due date is before today\n  return dueDate < today;\n};\n\n/**\n * Calculate how many days a task is overdue\n * Returns 0 if not overdue\n */\nexport const getDaysOverdue = (task: { dueDate?: string | Date | null; status?: string }): number => {\n  if (!isTaskOverdue(task)) return 0;\n  \n  const now = new Date();\n  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());\n  \n  const dueDateStr = formatDateForComparison(task.dueDate);\n  if (!dueDateStr) return 0;\n  \n  const [year, month, day] = dueDateStr.split('-').map(Number);\n  const dueDate = new Date(year, month - 1, day);\n  \n  const diffTime = today.getTime() - dueDate.getTime();\n  const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));\n  \n  return diffDays;\n};\n\n/**\n * Get overdue severity level for visual styling\n * Returns: 'critical' (7+ days), 'warning' (3-6 days), 'mild' (1-2 days), or null\n */\nexport const getOverdueSeverity = (task: { dueDate?: string | Date | null; status?: string }): 'critical' | 'warning' | 'mild' | null => {\n  const daysOverdue = getDaysOverdue(task);\n  \n  if (daysOverdue >= 7) return 'critical';\n  if (daysOverdue >= 3) return 'warning';\n  if (daysOverdue >= 1) return 'mild';\n  return null;\n};\n\n/**\n * Get a human-readable due date display with relative and absolute dates\n * Examples: \"Overdue by 3 days (Dec 9)\", \"Due today (Dec 12)\", \"Due tomorrow (Dec 13)\"\n */\nexport const getDueDateDisplay = (task: { dueDate?: string | Date | null; status?: string }): string => {\n  if (!task.dueDate) return 'No due date';\n  \n  const dueDateStr = formatDateForComparison(task.dueDate);\n  if (!dueDateStr) return 'Invalid date';\n  \n  const [year, month, day] = dueDateStr.split('-').map(Number);\n  const dueDate = new Date(year, month - 1, day);\n  \n  const now = new Date();\n  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());\n  \n  const diffTime = dueDate.getTime() - today.getTime();\n  const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));\n  \n  // Format the actual date (e.g., \"Dec 12\")\n  const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];\n  const dateStr = `${months[month - 1]} ${day}`;\n  \n  // For completed/skipped tasks, just show the date\n  if (task.status === 'completed' || task.status === 'approved' || task.status === 'skipped') {\n    return `Due ${dateStr}`;\n  }\n  \n  // Return both relative and absolute date\n  if (diffDays < 0) {\n    const daysOverdue = Math.abs(diffDays);\n    if (daysOverdue === 1) {\n      return `Overdue by 1 day (${dateStr})`;\n    }\n    return `Overdue by ${daysOverdue} days (${dateStr})`;\n  } else if (diffDays === 0) {\n    return `Due today (${dateStr})`;\n  } else if (diffDays === 1) {\n    return `Due tomorrow (${dateStr})`;\n  } else if (diffDays <= 7) {\n    return `Due in ${diffDays} days (${dateStr})`;\n  } else {\n    return `Due ${dateStr}`;\n  }\n};\n\n/**\n * Check if a completed task was completed late (after end of due date)\n */\nexport const wasCompletedLate = (task: { dueDate?: string | Date | null; status?: string; completedAt?: string | Date | null }): boolean => {\n  if (task.status !== 'completed' || !task.dueDate || !task.completedAt) {\n    return false;\n  }\n  \n  try {\n    const dueDateStr = formatDateForComparison(task.dueDate);\n    if (!dueDateStr) return false;\n    \n    const [year, month, day] = dueDateStr.split('-').map(Number);\n    // End of due date is 11:59:59 PM\n    const dueDateTime = new Date(year, month - 1, day, 23, 59, 59, 999);\n    \n    const completedDate = new Date(task.completedAt as string);\n    \n    // Check if dates are valid\n    if (isNaN(dueDateTime.getTime()) || isNaN(completedDate.getTime())) return false;\n    \n    return completedDate > dueDateTime;\n  } catch (error) {\n    return false;\n  }\n};","path":null,"size_bytes":8457,"size_tokens":null},"client/src/components/ui/alert-dialog.tsx":{"content":"import * as React from \"react\"\nimport * as AlertDialogPrimitive from \"@radix-ui/react-alert-dialog\"\n\nimport { cn } from \"@/lib/utils\"\nimport { buttonVariants } from \"@/components/ui/button\"\n\nconst AlertDialog = AlertDialogPrimitive.Root\n\nconst AlertDialogTrigger = AlertDialogPrimitive.Trigger\n\nconst AlertDialogPortal = AlertDialogPrimitive.Portal\n\nconst AlertDialogOverlay = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Overlay\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  />\n))\nAlertDialogOverlay.displayName = AlertDialogPrimitive.Overlay.displayName\n\nconst AlertDialogContent = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPortal>\n    <AlertDialogOverlay />\n    <AlertDialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\n        className\n      )}\n      {...props}\n    />\n  </AlertDialogPortal>\n))\nAlertDialogContent.displayName = AlertDialogPrimitive.Content.displayName\n\nconst AlertDialogHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-2 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nAlertDialogHeader.displayName = \"AlertDialogHeader\"\n\nconst AlertDialogFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nAlertDialogFooter.displayName = \"AlertDialogFooter\"\n\nconst AlertDialogTitle = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Title\n    ref={ref}\n    className={cn(\"text-lg font-semibold\", className)}\n    {...props}\n  />\n))\nAlertDialogTitle.displayName = AlertDialogPrimitive.Title.displayName\n\nconst AlertDialogDescription = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nAlertDialogDescription.displayName =\n  AlertDialogPrimitive.Description.displayName\n\nconst AlertDialogAction = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Action>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Action>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Action\n    ref={ref}\n    className={cn(buttonVariants(), className)}\n    {...props}\n  />\n))\nAlertDialogAction.displayName = AlertDialogPrimitive.Action.displayName\n\nconst AlertDialogCancel = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Cancel>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Cancel>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Cancel\n    ref={ref}\n    className={cn(\n      buttonVariants({ variant: \"outline\" }),\n      \"mt-2 sm:mt-0\",\n      className\n    )}\n    {...props}\n  />\n))\nAlertDialogCancel.displayName = AlertDialogPrimitive.Cancel.displayName\n\nexport {\n  AlertDialog,\n  AlertDialogPortal,\n  AlertDialogOverlay,\n  AlertDialogTrigger,\n  AlertDialogContent,\n  AlertDialogHeader,\n  AlertDialogFooter,\n  AlertDialogTitle,\n  AlertDialogDescription,\n  AlertDialogAction,\n  AlertDialogCancel,\n}\n","path":null,"size_bytes":4420,"size_tokens":null},"client/src/components/TaskAnalytics.tsx":{"content":"import React from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { \n  BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer,\n  PieChart, Pie, Cell, LineChart, Line \n} from \"recharts\";\nimport { \n  TrendingUp, Clock, CheckCircle, AlertTriangle, Users, \n  Target, Award, Activity, RotateCcw, Zap, DollarSign \n} from \"lucide-react\";\nimport { DashboardAnalytics } from \"@/types\";\nimport { useLocation } from \"@/contexts/LocationContext\";\nimport { RecurringTaskAnalytics } from \"./RecurringTaskAnalytics\";\nimport { TaskCostAnalysis } from \"./TaskCostAnalysis\";\n\n// Staff Comparison Component\nconst StaffComparison: React.FC = () => {\n  const { currentLocation, isViewingAllLocations } = useLocation();\n  \n  // Mock staff performance data - replace with real data\n  const staffData = [\n    { name: 'Sarah Johnson', tasksCompleted: 45, avgTime: 22.5, efficiency: 96.2, location: 'K' },\n    { name: 'Dan Smith', tasksCompleted: 42, avgTime: 24.1, efficiency: 94.8, location: 'K' },\n    { name: 'Mike Wilson', tasksCompleted: 38, avgTime: 26.3, efficiency: 92.1, location: 'R' },\n    { name: 'Lisa Brown', tasksCompleted: 41, avgTime: 23.7, efficiency: 95.4, location: 'R' },\n    { name: 'Tom Davis', tasksCompleted: 39, avgTime: 25.8, efficiency: 93.6, location: 'MKE' },\n    { name: 'Emma Clark', tasksCompleted: 44, avgTime: 21.9, efficiency: 97.1, location: 'MKE' },\n  ];\n\n  const filteredStaffData = isViewingAllLocations \n    ? staffData \n    : staffData.filter(staff => staff.location === currentLocation.code);\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n        {/* Staff Performance Chart */}\n        <Card className=\"p-6\">\n          <CardHeader>\n            <CardTitle>Staff Performance Comparison</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <ResponsiveContainer width=\"100%\" height={300}>\n              <BarChart data={filteredStaffData}>\n                <CartesianGrid strokeDasharray=\"3 3\" />\n                <XAxis dataKey=\"name\" />\n                <YAxis />\n                <Tooltip />\n                <Bar dataKey=\"tasksCompleted\" fill=\"#10b981\" name=\"Tasks Completed\" />\n                <Bar dataKey=\"avgTime\" fill=\"#3b82f6\" name=\"Avg. Time (min)\" />\n              </BarChart>\n            </ResponsiveContainer>\n          </CardContent>\n        </Card>\n\n        {/* Efficiency Ratings */}\n        <Card className=\"p-6\">\n          <CardHeader>\n            <CardTitle>Efficiency Ratings</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"space-y-4\">\n              {filteredStaffData.map((staff, index) => (\n                <div key={index} className=\"flex items-center justify-between p-3 bg-gray-50 rounded-lg\">\n                  <div>\n                    <div className=\"font-medium\">{staff.name}</div>\n                    <div className=\"text-sm text-gray-600\">{staff.tasksCompleted} tasks</div>\n                  </div>\n                  <div className=\"text-right\">\n                    <div className=\"font-bold text-lg\">{staff.efficiency.toFixed(1)}%</div>\n                    <div className=\"text-sm text-gray-600\">{staff.avgTime.toFixed(1)} min avg</div>\n                  </div>\n                </div>\n              ))}\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n};\n\n// Task Efficiency Component\nconst TaskEfficiency: React.FC = () => {\n  const { currentLocation, isViewingAllLocations } = useLocation();\n  \n  // Mock efficiency data - replace with real data\n  const efficiencyData = [\n    { task: 'Seeding', planned: 30, actual: 25, efficiency: 120 },\n    { task: 'Harvesting', planned: 45, actual: 42, efficiency: 107 },\n    { task: 'Cleaning', planned: 20, actual: 22, efficiency: 91 },\n    { task: 'Maintenance', planned: 35, actual: 38, efficiency: 92 },\n    { task: 'Packaging', planned: 25, actual: 23, efficiency: 109 },\n  ];\n\n  const timeAnalysis = [\n    { hour: '8:00', tasks: 12, efficiency: 95 },\n    { hour: '9:00', tasks: 15, efficiency: 98 },\n    { hour: '10:00', tasks: 18, efficiency: 102 },\n    { hour: '11:00', tasks: 16, efficiency: 99 },\n    { hour: '12:00', tasks: 8, efficiency: 85 },\n    { hour: '13:00', tasks: 14, efficiency: 96 },\n    { hour: '14:00', tasks: 17, efficiency: 101 },\n    { hour: '15:00', tasks: 15, efficiency: 97 },\n    { hour: '16:00', tasks: 12, efficiency: 94 },\n  ];\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Efficiency Overview */}\n      <div className=\"grid grid-cols-1 md:grid-cols-3 gap-6\">\n        <Card className=\"p-6\">\n          <div className=\"flex items-center justify-between\">\n            <div>\n              <p className=\"text-sm font-medium text-gray-600\">Overall Efficiency</p>\n              <p className=\"text-2xl font-bold text-green-600\">104.2%</p>\n            </div>\n            <div className=\"p-3 bg-green-50 rounded-full\">\n              <TrendingUp className=\"w-6 h-6 text-green-600\" />\n            </div>\n          </div>\n        </Card>\n        \n        <Card className=\"p-6\">\n          <div className=\"flex items-center justify-between\">\n            <div>\n              <p className=\"text-sm font-medium text-gray-600\">Time Saved</p>\n              <p className=\"text-2xl font-bold text-blue-600\">2.4 hrs</p>\n            </div>\n            <div className=\"p-3 bg-blue-50 rounded-full\">\n              <Clock className=\"w-6 h-6 text-blue-600\" />\n            </div>\n          </div>\n        </Card>\n        \n        <Card className=\"p-6\">\n          <div className=\"flex items-center justify-between\">\n            <div>\n              <p className=\"text-sm font-medium text-gray-600\">Peak Hour</p>\n              <p className=\"text-2xl font-bold text-purple-600\">10:00 AM</p>\n            </div>\n            <div className=\"p-3 bg-purple-50 rounded-full\">\n              <Activity className=\"w-6 h-6 text-purple-600\" />\n            </div>\n          </div>\n        </Card>\n      </div>\n\n      {/* Charts */}\n      <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n        {/* Task Efficiency */}\n        <Card className=\"p-6\">\n          <CardHeader>\n            <CardTitle>Task Type Efficiency</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <ResponsiveContainer width=\"100%\" height={300}>\n              <BarChart data={efficiencyData}>\n                <CartesianGrid strokeDasharray=\"3 3\" />\n                <XAxis dataKey=\"task\" />\n                <YAxis />\n                <Tooltip />\n                <Bar dataKey=\"planned\" fill=\"#e5e7eb\" name=\"Planned Time\" />\n                <Bar dataKey=\"actual\" fill=\"#3b82f6\" name=\"Actual Time\" />\n              </BarChart>\n            </ResponsiveContainer>\n          </CardContent>\n        </Card>\n\n        {/* Hourly Analysis */}\n        <Card className=\"p-6\">\n          <CardHeader>\n            <CardTitle>Hourly Efficiency Analysis</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <ResponsiveContainer width=\"100%\" height={300}>\n              <LineChart data={timeAnalysis}>\n                <CartesianGrid strokeDasharray=\"3 3\" />\n                <XAxis dataKey=\"hour\" />\n                <YAxis yAxisId=\"left\" orientation=\"left\" />\n                <YAxis yAxisId=\"right\" orientation=\"right\" />\n                <Tooltip />\n                <Bar yAxisId=\"left\" dataKey=\"tasks\" fill=\"#10b981\" name=\"Tasks Completed\" />\n                <Line \n                  yAxisId=\"right\"\n                  type=\"monotone\" \n                  dataKey=\"efficiency\" \n                  stroke=\"#f59e0b\" \n                  strokeWidth={2}\n                  name=\"Efficiency %\"\n                />\n              </LineChart>\n            </ResponsiveContainer>\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n};\n\nexport const TaskAnalytics: React.FC = () => {\n  const [activeView, setActiveView] = React.useState<'recurring' | 'staff' | 'efficiency' | 'costs'>('recurring');\n  const [timePeriod, setTimePeriod] = React.useState(\"7d\");\n  const { currentLocation, isViewingAllLocations } = useLocation();\n\n  const { data: analytics, isLoading } = useQuery<DashboardAnalytics>({\n    queryKey: [\"/api/analytics/dashboard\", { location: currentLocation.code }],\n    queryFn: async () => {\n      const response = await fetch(`/api/analytics/dashboard?location=${currentLocation.code}`);\n      if (!response.ok) throw new Error('Failed to fetch analytics');\n      return response.json();\n    },\n  });\n\n  const COLORS = ['#2D8028', '#203B17', '#4ADE80', '#F59E0B', '#EF4444'];\n\n  if (isLoading) {\n    return (\n      <div className=\"space-y-6\">\n        <div className=\"animate-pulse space-y-4\">\n          <div className=\"h-8 bg-gray-200 rounded w-1/4\"></div>\n          <div className=\"h-4 bg-gray-200 rounded w-1/2\"></div>\n          <div className=\"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6\">\n            {[1, 2, 3, 4].map((i) => (\n              <div key={i} className=\"h-32 bg-gray-200 rounded-xl\"></div>\n            ))}\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  if (!analytics) {\n    return (\n      <div className=\"text-center py-12\">\n        <div className=\"text-4xl mb-4\">üìä</div>\n        <h3 className=\"text-lg font-medium text-gray-900 mb-2\">No analytics data available</h3>\n        <p className=\"text-gray-600\">Analytics will appear here once you have task data.</p>\n      </div>\n    );\n  }\n\n  const taskStatusData = [\n    { name: 'Completed', value: analytics.completedTasks, color: '#2D8028' },\n    { name: 'In Progress', value: analytics.inProgressTasks, color: '#F59E0B' },\n    { name: 'Pending', value: analytics.pendingTasks, color: '#6B7280' },\n  ];\n\n  const taskTypeData = Object.entries(analytics.tasksByType).map(([type, count]) => ({\n    name: type.charAt(0).toUpperCase() + type.slice(1).replace('_', ' '),\n    value: count,\n  }));\n\n  const completionRate = analytics.totalTasks > 0 \n    ? Math.round((analytics.completedTasks / analytics.totalTasks) * 100)\n    : 0;\n\n  const avgTimePerTask = analytics.completedTasks > 0 \n    ? Math.round(analytics.totalTimeLogged / analytics.completedTasks)\n    : 0;\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Header */}\n      <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between\">\n        <div>\n          <h2 className=\"text-xl font-bold text-[#203B17] mb-2\">Task Analytics</h2>\n          <p className=\"text-gray-600\">Performance insights and task completion metrics</p>\n        </div>\n        <div className=\"mt-4 sm:mt-0\">\n          <Select value={timePeriod} onValueChange={setTimePeriod}>\n            <SelectTrigger className=\"w-32\">\n              <SelectValue />\n            </SelectTrigger>\n            <SelectContent>\n              <SelectItem value=\"7d\">Last 7 days</SelectItem>\n              <SelectItem value=\"30d\">Last 30 days</SelectItem>\n              <SelectItem value=\"90d\">Last 90 days</SelectItem>\n            </SelectContent>\n          </Select>\n        </div>\n      </div>\n\n      {/* Sub-navigation */}\n      <div className=\"flex flex-wrap gap-2 border-b border-gray-200\">\n        <Button\n          variant={activeView === 'recurring' ? 'default' : 'ghost'}\n          onClick={() => setActiveView('recurring')}\n          className=\"flex items-center gap-2\"\n        >\n          <RotateCcw className=\"w-4 h-4\" />\n          Recurring Task Analysis\n        </Button>\n        <Button\n          variant={activeView === 'staff' ? 'default' : 'ghost'}\n          onClick={() => setActiveView('staff')}\n          className=\"flex items-center gap-2\"\n        >\n          <Users className=\"w-4 h-4\" />\n          Staff Comparison\n        </Button>\n        <Button\n          variant={activeView === 'efficiency' ? 'default' : 'ghost'}\n          onClick={() => setActiveView('efficiency')}\n          className=\"flex items-center gap-2\"\n        >\n          <Zap className=\"w-4 h-4\" />\n          Efficiency Metrics\n        </Button>\n        <Button\n          variant={activeView === 'costs' ? 'default' : 'ghost'}\n          onClick={() => setActiveView('costs')}\n          className=\"flex items-center gap-2\"\n        >\n          <DollarSign className=\"w-4 h-4\" />\n          Cost Analysis\n        </Button>\n      </div>\n\n      {/* Content based on active view */}\n      {activeView === 'recurring' && <RecurringTaskAnalytics />}\n      {activeView === 'staff' && <StaffComparison />}\n      {activeView === 'efficiency' && <TaskEfficiency />}\n      {activeView === 'costs' && <TaskCostAnalysis />}\n    </div>\n  );\n};","path":null,"size_bytes":12802,"size_tokens":null},"client/src/config/authConfig.ts":{"content":"// iOS Detection Utility\nexport const detectIOSEnvironment = () => {\n  const ua = navigator.userAgent;\n  const isIOS = /iPad|iPhone|iPod/.test(ua);\n  const isTeamsApp = /Teams/.test(ua);\n  const isWebView = !/Safari/.test(ua) || /CriOS/.test(ua);\n  const isSafari = /Safari/.test(ua) && !/Chrome/.test(ua);\n  \n  return { isIOS, isTeamsApp, isWebView, isSafari };\n};\n\n// Debug Logging Utility\nexport const debugLog = (message: string, data: any = null) => {\n  const timestamp = new Date().toISOString();\n  const { isIOS, isTeamsApp, isWebView } = detectIOSEnvironment();\n  \n  console.log(`[AUTH DEBUG ${timestamp}] ${message}`, {\n    data,\n    isIOS,\n    isTeamsApp,\n    isWebView,\n    userAgent: navigator.userAgent,\n    platform: navigator.platform,\n    vendor: navigator.vendor\n  });\n  \n  // Store in sessionStorage for remote debugging\n  try {\n    const logs = JSON.parse(sessionStorage.getItem('authDebugLogs') || '[]');\n    logs.push({ timestamp, message, data, isIOS, isTeamsApp, isWebView });\n    // Keep only last 50 logs\n    if (logs.length > 50) logs.shift();\n    sessionStorage.setItem('authDebugLogs', JSON.stringify(logs));\n  } catch (e) {\n    console.warn('Failed to store debug log:', e);\n  }\n};\n\n// Storage Availability Test\nexport const testStorageAvailability = () => {\n  const results = {\n    localStorage: false,\n    sessionStorage: false,\n    cookies: false\n  };\n  \n  try {\n    localStorage.setItem('test', 'test');\n    localStorage.removeItem('test');\n    results.localStorage = true;\n    debugLog('localStorage available');\n  } catch (e) {\n    debugLog('localStorage blocked', { error: (e as Error).message });\n  }\n  \n  try {\n    sessionStorage.setItem('test', 'test');\n    sessionStorage.removeItem('test');\n    results.sessionStorage = true;\n    debugLog('sessionStorage available');\n  } catch (e) {\n    debugLog('sessionStorage blocked', { error: (e as Error).message });\n  }\n  \n  try {\n    document.cookie = \"test=test; SameSite=None; Secure\";\n    results.cookies = document.cookie.includes('test');\n    debugLog('Cookies status', { enabled: results.cookies });\n  } catch (e) {\n    debugLog('Cookies test failed', { error: (e as Error).message });\n  }\n  \n  return results;\n};\n\nconst { isIOS } = detectIOSEnvironment();\n\nexport const msalConfig = {\n  auth: {\n    clientId: \"0b4cf8e2-eda5-4fd9-8319-7ec72614f0f2\", // Your Application ID\n    authority: \"https://login.microsoftonline.com/86f7db5f-eb1e-4ac8-b010-4a2964d7749c\", // Your Directory ID\n    redirectUri: window.location.origin, // Automatically uses current URL\n    navigateToLoginRequestUrl: false // Important for iOS\n  },\n  cache: {\n    cacheLocation: \"sessionStorage\", // Better compatibility with iOS\n    storeAuthStateInCookie: isIOS, // Enable for iOS Safari\n    secureCookies: true\n  },\n  system: {\n    allowNativeBroker: false, // Disable for iOS web apps\n    windowHashTimeout: isIOS ? 90000 : 60000, // Increase timeout for iOS\n    iframeHashTimeout: isIOS ? 15000 : 10000,\n    navigateFrameWait: isIOS ? 1000 : 0,\n    loadFrameTimeout: isIOS ? 10000 : 6000\n  }\n};\n\nexport const loginRequest = {\n  scopes: [\"User.Read\", \"email\", \"profile\", \"openid\"]\n};\n\n// Email domain validation\nexport const isAuthorizedEmail = (email: string): boolean => {\n  return email.toLowerCase().endsWith('@growspace.farm');\n};","path":null,"size_bytes":3300,"size_tokens":null},"server/persistence.ts":{"content":"import { promises as fs } from 'fs';\nimport path from 'path';\nimport { Task, RecurringTask, InventoryItem } from '@shared/schema';\n\nconst DATA_DIR = path.join(process.cwd(), 'data');\n\nexport interface PersistenceData {\n  tasks: Task[];\n  recurringTasks: RecurringTask[];\n  inventoryItems: InventoryItem[];\n  counters: {\n    currentTaskId: number;\n    currentRecurringTaskId: number;\n    currentInventoryId: number;\n  };\n}\n\nexport class PersistenceManager {\n  private static instance: PersistenceManager;\n  \n  static getInstance(): PersistenceManager {\n    if (!PersistenceManager.instance) {\n      PersistenceManager.instance = new PersistenceManager();\n    }\n    return PersistenceManager.instance;\n  }\n\n  private async ensureDataDirectory(): Promise<void> {\n    try {\n      await fs.access(DATA_DIR);\n    } catch {\n      await fs.mkdir(DATA_DIR, { recursive: true });\n    }\n  }\n\n  private getFilePath(filename: string): string {\n    return path.join(DATA_DIR, filename);\n  }\n\n  async loadData(): Promise<PersistenceData | null> {\n    try {\n      await this.ensureDataDirectory();\n      \n      const tasksPath = this.getFilePath('tasks.json');\n      const recurringTasksPath = this.getFilePath('recurring_tasks.json');\n      const inventoryPath = this.getFilePath('inventory_levels.json');\n      const countersPath = this.getFilePath('counters.json');\n\n      let tasks: Task[] = [];\n      let recurringTasks: RecurringTask[] = [];\n      let inventoryItems: InventoryItem[] = [];\n      let counters = {\n        currentTaskId: 1,\n        currentRecurringTaskId: 1,\n        currentInventoryId: 1\n      };\n\n      // Load tasks\n      try {\n        const tasksData = await fs.readFile(tasksPath, 'utf-8');\n        tasks = JSON.parse(tasksData);\n        console.log(`Loaded ${tasks.length} tasks from persistence`);\n      } catch (error) {\n        console.log('No existing tasks file found, starting fresh');\n      }\n\n      // Load recurring tasks\n      try {\n        const recurringTasksData = await fs.readFile(recurringTasksPath, 'utf-8');\n        recurringTasks = JSON.parse(recurringTasksData);\n        console.log(`Loaded ${recurringTasks.length} recurring tasks from persistence`);\n      } catch (error) {\n        console.log('No existing recurring tasks file found, starting fresh');\n      }\n\n      // Load inventory\n      try {\n        const inventoryData = await fs.readFile(inventoryPath, 'utf-8');\n        inventoryItems = JSON.parse(inventoryData);\n        console.log(`Loaded ${inventoryItems.length} inventory items from persistence`);\n      } catch (error) {\n        console.log('No existing inventory file found, starting fresh');\n      }\n\n      // Load counters\n      try {\n        const countersData = await fs.readFile(countersPath, 'utf-8');\n        counters = JSON.parse(countersData);\n        console.log('Loaded ID counters from persistence');\n      } catch (error) {\n        console.log('No existing counters file found, using defaults');\n      }\n\n      return {\n        tasks,\n        recurringTasks,\n        inventoryItems,\n        counters\n      };\n    } catch (error) {\n      console.error('Error loading persistence data:', error);\n      return null;\n    }\n  }\n\n  async saveData(data: PersistenceData): Promise<void> {\n    try {\n      await this.ensureDataDirectory();\n\n      const promises = [\n        fs.writeFile(\n          this.getFilePath('tasks.json'),\n          JSON.stringify(data.tasks, null, 2),\n          'utf-8'\n        ),\n        fs.writeFile(\n          this.getFilePath('recurring_tasks.json'),\n          JSON.stringify(data.recurringTasks, null, 2),\n          'utf-8'\n        ),\n        fs.writeFile(\n          this.getFilePath('inventory_levels.json'),\n          JSON.stringify(data.inventoryItems, null, 2),\n          'utf-8'\n        ),\n        fs.writeFile(\n          this.getFilePath('counters.json'),\n          JSON.stringify(data.counters, null, 2),\n          'utf-8'\n        )\n      ];\n\n      await Promise.all(promises);\n      console.log('Data persisted to disk successfully');\n    } catch (error) {\n      console.error('Error saving persistence data:', error);\n    }\n  }\n\n  async saveTasks(tasks: Task[]): Promise<void> {\n    try {\n      await this.ensureDataDirectory();\n      await fs.writeFile(\n        this.getFilePath('tasks.json'),\n        JSON.stringify(tasks, null, 2),\n        'utf-8'\n      );\n    } catch (error) {\n      console.error('Error saving tasks:', error);\n    }\n  }\n\n  async saveRecurringTasks(recurringTasks: RecurringTask[]): Promise<void> {\n    try {\n      await this.ensureDataDirectory();\n      await fs.writeFile(\n        this.getFilePath('recurring_tasks.json'),\n        JSON.stringify(recurringTasks, null, 2),\n        'utf-8'\n      );\n    } catch (error) {\n      console.error('Error saving recurring tasks:', error);\n    }\n  }\n\n  async saveInventoryItems(inventoryItems: InventoryItem[]): Promise<void> {\n    try {\n      await this.ensureDataDirectory();\n      await fs.writeFile(\n        this.getFilePath('inventory_levels.json'),\n        JSON.stringify(inventoryItems, null, 2),\n        'utf-8'\n      );\n    } catch (error) {\n      console.error('Error saving inventory items:', error);\n    }\n  }\n\n  async saveCounters(counters: { currentTaskId: number; currentRecurringTaskId: number; currentInventoryId: number }): Promise<void> {\n    try {\n      await this.ensureDataDirectory();\n      await fs.writeFile(\n        this.getFilePath('counters.json'),\n        JSON.stringify(counters, null, 2),\n        'utf-8'\n      );\n    } catch (error) {\n      console.error('Error saving counters:', error);\n    }\n  }\n\n  async clearAllFiles(): Promise<void> {\n    console.log('Clearing all persistence files...');\n    try {\n      await this.ensureDataDirectory();\n      \n      const filesToClear = [\n        'tasks.json',\n        'recurring_tasks.json',\n        'inventory_levels.json',\n        'counters.json'\n      ];\n      \n      for (const filename of filesToClear) {\n        const filepath = this.getFilePath(filename);\n        try {\n          await fs.unlink(filepath);\n          console.log(`Deleted ${filename}`);\n        } catch (error) {\n          // File doesn't exist, which is fine\n          console.log(`${filename} didn't exist, skipping`);\n        }\n      }\n      \n      console.log('All persistence files cleared');\n    } catch (error) {\n      console.error('Error clearing files:', error);\n    }\n  }\n}","path":null,"size_bytes":6388,"size_tokens":null},"drizzle.config.ts":{"content":"import { defineConfig } from \"drizzle-kit\";\n\nif (!process.env.DATABASE_URL) {\n  throw new Error(\"DATABASE_URL, ensure the database is provisioned\");\n}\n\nexport default defineConfig({\n  out: \"./migrations\",\n  schema: \"./shared/schema.ts\",\n  dialect: \"postgresql\",\n  dbCredentials: {\n    url: process.env.DATABASE_URL,\n  },\n});\n","path":null,"size_bytes":325,"size_tokens":null},"client/src/components/QuickStats.tsx":{"content":"import React from \"react\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { DashboardAnalytics } from \"@/types\";\nimport { Clock, CheckCircle, AlertCircle } from \"lucide-react\";\n\nconst QuickStats: React.FC = () => {\n  const { data: analytics, isLoading } = useQuery<DashboardAnalytics>({\n    queryKey: [\"/api/analytics/dashboard\"],\n  });\n\n  if (isLoading) {\n    return (\n      <Card>\n        <CardContent className=\"p-6\">\n          <div className=\"animate-pulse space-y-4\">\n            <div className=\"h-4 bg-gray-200 rounded w-1/2\"></div>\n            <div className=\"h-2 bg-gray-200 rounded\"></div>\n            <div className=\"h-4 bg-gray-200 rounded w-1/3\"></div>\n          </div>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  if (!analytics) return null;\n\n  const completionRate = analytics.totalTasks > 0 \n    ? (analytics.completedTasks / analytics.totalTasks) * 100 \n    : 0;\n\n  return (\n    <Card>\n      <CardHeader>\n        <CardTitle className=\"text-lg font-semibold text-[#203B17]\">\n          Today's Progress\n        </CardTitle>\n      </CardHeader>\n      <CardContent className=\"space-y-4\">\n        <div className=\"space-y-2\">\n          <div className=\"flex justify-between items-center\">\n            <span className=\"text-sm text-gray-600\">Completed Tasks</span>\n            <span className=\"text-sm font-medium text-[#203B17]\">\n              {analytics.completedTasks}/{analytics.totalTasks}\n            </span>\n          </div>\n          <Progress value={completionRate} className=\"h-2\" />\n        </div>\n\n        <div className=\"space-y-3\">\n          <div className=\"flex items-center justify-between\">\n            <div className=\"flex items-center\">\n              <Clock className=\"h-4 w-4 mr-2 text-gray-500\" />\n              <span className=\"text-sm text-gray-600\">Hours Logged</span>\n            </div>\n            <span className=\"text-sm font-medium text-[#203B17]\">\n              {Math.round(analytics.totalTimeLogged / 60 * 10) / 10}h\n            </span>\n          </div>\n\n          <div className=\"flex items-center justify-between\">\n            <div className=\"flex items-center\">\n              <CheckCircle className=\"h-4 w-4 mr-2 text-green-500\" />\n              <span className=\"text-sm text-gray-600\">In Progress</span>\n            </div>\n            <span className=\"text-sm font-medium text-amber-600\">\n              {analytics.inProgressTasks}\n            </span>\n          </div>\n\n          {analytics.lowStockAlerts > 0 && (\n            <div className=\"flex items-center justify-between\">\n              <div className=\"flex items-center\">\n                <AlertCircle className=\"h-4 w-4 mr-2 text-red-500\" />\n                <span className=\"text-sm text-gray-600\">Low Stock Alerts</span>\n              </div>\n              <span className=\"text-sm font-medium text-red-600\">\n                {analytics.lowStockAlerts}\n              </span>\n            </div>\n          )}\n        </div>\n      </CardContent>\n    </Card>\n  );\n};\n\nexport default QuickStats;\n","path":null,"size_bytes":3140,"size_tokens":null},"client/src/components/ui/dialog.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as DialogPrimitive from \"@radix-ui/react-dialog\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Dialog = DialogPrimitive.Root\n\nconst DialogTrigger = DialogPrimitive.Trigger\n\nconst DialogPortal = DialogPrimitive.Portal\n\nconst DialogClose = DialogPrimitive.Close\n\nconst DialogOverlay = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Overlay\n    ref={ref}\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogOverlay.displayName = DialogPrimitive.Overlay.displayName\n\nconst DialogContent = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <DialogPortal>\n    <DialogOverlay />\n    <DialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\n        className\n      )}\n      {...props}\n    >\n      {children}\n      <DialogPrimitive.Close className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </DialogPrimitive.Close>\n    </DialogPrimitive.Content>\n  </DialogPortal>\n))\nDialogContent.displayName = DialogPrimitive.Content.displayName\n\nconst DialogHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-1.5 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogHeader.displayName = \"DialogHeader\"\n\nconst DialogFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogFooter.displayName = \"DialogFooter\"\n\nconst DialogTitle = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Title\n    ref={ref}\n    className={cn(\n      \"text-lg font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogTitle.displayName = DialogPrimitive.Title.displayName\n\nconst DialogDescription = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nDialogDescription.displayName = DialogPrimitive.Description.displayName\n\nexport {\n  Dialog,\n  DialogPortal,\n  DialogOverlay,\n  DialogClose,\n  DialogTrigger,\n  DialogContent,\n  DialogHeader,\n  DialogFooter,\n  DialogTitle,\n  DialogDescription,\n}\n","path":null,"size_bytes":3848,"size_tokens":null},"client/src/lib/queryClient.ts":{"content":"import { QueryClient, QueryFunction } from \"@tanstack/react-query\";\n\nasync function throwIfResNotOk(res: Response) {\n  if (!res.ok) {\n    const text = (await res.text()) || res.statusText;\n    throw new Error(`${res.status}: ${text}`);\n  }\n}\n\nexport async function apiRequest(\n  method: string,\n  url: string,\n  data?: unknown | undefined,\n): Promise<Response> {\n  const res = await fetch(url, {\n    method,\n    headers: data ? { \"Content-Type\": \"application/json\" } : {},\n    body: data ? JSON.stringify(data) : undefined,\n    credentials: \"include\",\n  });\n\n  await throwIfResNotOk(res);\n  return res;\n}\n\ntype UnauthorizedBehavior = \"returnNull\" | \"throw\";\nexport const getQueryFn: <T>(options: {\n  on401: UnauthorizedBehavior;\n}) => QueryFunction<T> =\n  ({ on401: unauthorizedBehavior }) =>\n  async ({ queryKey }) => {\n    const res = await fetch(queryKey.join(\"/\") as string, {\n      credentials: \"include\",\n    });\n\n    if (unauthorizedBehavior === \"returnNull\" && res.status === 401) {\n      return null;\n    }\n\n    await throwIfResNotOk(res);\n    return await res.json();\n  };\n\nexport const queryClient = new QueryClient({\n  defaultOptions: {\n    queries: {\n      queryFn: getQueryFn({ on401: \"throw\" }),\n      refetchInterval: false,\n      refetchOnWindowFocus: false,\n      staleTime: Infinity,\n      retry: false,\n    },\n    mutations: {\n      retry: false,\n    },\n  },\n});\n","path":null,"size_bytes":1383,"size_tokens":null},"client/src/components/ui/drawer.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport { Drawer as DrawerPrimitive } from \"vaul\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Drawer = ({\n  shouldScaleBackground = true,\n  ...props\n}: React.ComponentProps<typeof DrawerPrimitive.Root>) => (\n  <DrawerPrimitive.Root\n    shouldScaleBackground={shouldScaleBackground}\n    {...props}\n  />\n)\nDrawer.displayName = \"Drawer\"\n\nconst DrawerTrigger = DrawerPrimitive.Trigger\n\nconst DrawerPortal = DrawerPrimitive.Portal\n\nconst DrawerClose = DrawerPrimitive.Close\n\nconst DrawerOverlay = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Overlay\n    ref={ref}\n    className={cn(\"fixed inset-0 z-50 bg-black/80\", className)}\n    {...props}\n  />\n))\nDrawerOverlay.displayName = DrawerPrimitive.Overlay.displayName\n\nconst DrawerContent = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <DrawerPortal>\n    <DrawerOverlay />\n    <DrawerPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed inset-x-0 bottom-0 z-50 mt-24 flex h-auto flex-col rounded-t-[10px] border bg-background\",\n        className\n      )}\n      {...props}\n    >\n      <div className=\"mx-auto mt-4 h-2 w-[100px] rounded-full bg-muted\" />\n      {children}\n    </DrawerPrimitive.Content>\n  </DrawerPortal>\n))\nDrawerContent.displayName = \"DrawerContent\"\n\nconst DrawerHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\"grid gap-1.5 p-4 text-center sm:text-left\", className)}\n    {...props}\n  />\n)\nDrawerHeader.displayName = \"DrawerHeader\"\n\nconst DrawerFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\"mt-auto flex flex-col gap-2 p-4\", className)}\n    {...props}\n  />\n)\nDrawerFooter.displayName = \"DrawerFooter\"\n\nconst DrawerTitle = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Title\n    ref={ref}\n    className={cn(\n      \"text-lg font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nDrawerTitle.displayName = DrawerPrimitive.Title.displayName\n\nconst DrawerDescription = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nDrawerDescription.displayName = DrawerPrimitive.Description.displayName\n\nexport {\n  Drawer,\n  DrawerPortal,\n  DrawerOverlay,\n  DrawerTrigger,\n  DrawerClose,\n  DrawerContent,\n  DrawerHeader,\n  DrawerFooter,\n  DrawerTitle,\n  DrawerDescription,\n}\n","path":null,"size_bytes":3021,"size_tokens":null},"client/src/services/trayApiService.ts":{"content":"import { apiRequest } from \"@/lib/queryClient\";\n\nexport interface ProductionTray {\n  id: string;\n  cropType: string;\n  cropName?: string;\n  status: 'active' | 'growing' | 'split' | 'harvested';\n  location?: string;\n  systemId?: string;\n  datePlanted?: string;\n  harvestedAt?: string;\n  lastMoved?: string;\n  splitFrom?: string;\n  splitNumber?: number;\n  splitTotal?: number;\n  splitInto?: string[];\n  splitAt?: string;\n  createdAt: string;\n}\n\nexport interface TrayVariety {\n  seedId: string;\n  seedName: string;\n  sku: string;\n  quantity: number;\n  seedsOz: number;\n}\n\nexport interface Tray {\n  id: string;\n  barcode?: string;\n  cropType: string;\n  cropCategory: 'microgreens' | 'leafyGreens';\n  datePlanted: Date;\n  expectedHarvest: Date;\n  status: 'seeded' | 'germinating' | 'growing' | 'ready' | 'harvested' | 'split' | 'discarded';\n  currentLocation: {\n    systemId: string;\n    systemType: string;\n    spotIds: string[];\n    movedDate: Date;\n  };\n  locationHistory: Array<{\n    systemId: string;\n    systemType: string;\n    spotIds: string[];\n    movedDate: Date;\n    movedBy: string;\n    reason?: string;\n  }>;\n  parentTrayId?: string;\n  childTrayIds?: string[];\n  plantCount: number;\n  varieties?: TrayVariety[];\n  notes: string;\n  createdBy: string;\n  createdDate: Date;\n}\n\n// API-based tray service\nexport const trayApiService = {\n  // Get all trays\n  async getAllTrays(): Promise<ProductionTray[]> {\n    try {\n      const trays = await apiRequest(\"GET\", \"/api/trays\");\n      return Array.isArray(trays) ? trays : [];\n    } catch (error) {\n      console.error('Error loading trays:', error);\n      return [];\n    }\n  },\n\n  // Create new tray\n  async createTray(trayData: Partial<ProductionTray>): Promise<ProductionTray> {\n    const newTray: ProductionTray = {\n      id: trayData.id || this.generateTrayId(trayData.cropType || 'UNKN'),\n      cropType: trayData.cropType || 'unknown',\n      cropName: trayData.cropName,\n      datePlanted: trayData.datePlanted || new Date().toISOString().split('T')[0],\n      status: trayData.status || 'active',\n      location: trayData.location || 'Nursery',\n      createdAt: new Date().toISOString(),\n      ...trayData\n    };\n    \n    const createdTray = await apiRequest(\"POST\", \"/api/trays\", newTray) as ProductionTray;\n    return createdTray;\n  },\n\n  // Update tray\n  async updateTray(trayId: string, updates: Partial<ProductionTray>): Promise<ProductionTray | null> {\n    try {\n      const updatedTray = await apiRequest(\"PUT\", `/api/trays/${trayId}`, updates) as ProductionTray;\n      return updatedTray;\n    } catch (error) {\n      console.error('Error updating tray:', error);\n      return null;\n    }\n  },\n\n  // Delete tray\n  async deleteTray(trayId: string): Promise<boolean> {\n    try {\n      await apiRequest(\"DELETE\", `/api/trays/${trayId}`);\n      return true;\n    } catch (error) {\n      console.error('Error deleting tray:', error);\n      return false;\n    }\n  },\n\n  // Split tray\n  async splitTray(originalTrayId: string, splitCount: number): Promise<ProductionTray[] | null> {\n    try {\n      const splitTrays = await apiRequest(\"POST\", `/api/trays/${originalTrayId}/split`, { splitCount }) as ProductionTray[];\n      return splitTrays;\n    } catch (error) {\n      console.error('Error splitting tray:', error);\n      return null;\n    }\n  },\n\n  // Generate tray ID\n  generateTrayId(cropType: string): string {\n    const date = new Date();\n    const dateStr = `${(date.getMonth() + 1).toString().padStart(2, '0')}${date.getDate().toString().padStart(2, '0')}${date.getFullYear().toString().slice(-2)}`;\n    const cropCode = cropType.substring(0, 4).toUpperCase();\n    const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');\n    \n    return `K${dateStr}-${cropCode}-${random}`;\n  },\n\n  // Update tray location\n  async updateTrayLocation(trayId: string, newLocation: string, systemId?: string): Promise<ProductionTray | null> {\n    const updates = {\n      location: newLocation,\n      systemId,\n      lastMoved: new Date().toISOString()\n    };\n    \n    return this.updateTray(trayId, updates);\n  },\n\n  // Create tray from seeding task\n  async createTrayFromSeeding(taskData: any): Promise<ProductionTray> {\n    const trayId = this.generateTrayId(taskData.cropType || 'SEED');\n    \n    const tray: ProductionTray = {\n      id: trayId,\n      cropType: taskData.cropType || 'Unknown',\n      cropName: taskData.cropName,\n      status: 'active',\n      location: taskData.location || 'Nursery',\n      systemId: taskData.systemId,\n      datePlanted: new Date().toISOString().split('T')[0],\n      createdAt: new Date().toISOString()\n    };\n    \n    return this.createTray(tray);\n  }\n};\n\n// Advanced tray data service using API\nexport class TrayDataApiService {\n  // Load trays from API\n  static async loadTrays(): Promise<Tray[]> {\n    try {\n      const trays = await apiRequest(\"GET\", \"/api/trays\") as any[];\n      // Convert to proper Tray format with Date objects\n      return trays.map((tray: any) => ({\n        ...tray,\n        datePlanted: new Date(tray.datePlanted),\n        expectedHarvest: new Date(tray.expectedHarvest),\n        createdDate: new Date(tray.createdDate),\n        currentLocation: {\n          ...tray.currentLocation,\n          movedDate: new Date(tray.currentLocation?.movedDate || new Date())\n        },\n        locationHistory: (tray.locationHistory || []).map((history: any) => ({\n          ...history,\n          movedDate: new Date(history.movedDate)\n        }))\n      }));\n    } catch (error) {\n      console.error('Error loading tray data from API:', error);\n      return [];\n    }\n  }\n\n  // Save trays to API\n  static async saveTrays(trays: Tray[]): Promise<void> {\n    try {\n      // Save each tray individually via API\n      await Promise.all(trays.map(tray => \n        apiRequest(\"POST\", \"/api/trays\", tray)\n      ));\n      console.log('Saved', trays.length, 'trays to API');\n    } catch (error) {\n      console.error('Error saving tray data to API:', error);\n    }\n  }\n\n  // Add new tray\n  static async addTray(tray: Tray): Promise<void> {\n    try {\n      await apiRequest(\"POST\", \"/api/trays\", tray);\n    } catch (error) {\n      console.error('Error adding tray:', error);\n    }\n  }\n\n  // Update existing tray\n  static async updateTray(updatedTray: Tray): Promise<void> {\n    try {\n      await apiRequest(\"PUT\", `/api/trays/${updatedTray.id}`, updatedTray);\n    } catch (error) {\n      console.error('Error updating tray:', error);\n    }\n  }\n\n  // Delete tray\n  static async deleteTray(trayId: string): Promise<void> {\n    try {\n      await apiRequest(\"DELETE\", `/api/trays/${trayId}`);\n    } catch (error) {\n      console.error('Error deleting tray:', error);\n    }\n  }\n\n  // Clear all trays\n  static async clearAllTrays(): Promise<void> {\n    try {\n      const trays = await this.loadTrays();\n      await Promise.all(trays.map(tray => this.deleteTray(tray.id)));\n      console.log('All tray data cleared from API');\n    } catch (error) {\n      console.error('Error clearing tray data:', error);\n    }\n  }\n}","path":null,"size_bytes":7016,"size_tokens":null},"client/src/pages/Analytics.tsx":{"content":"import React from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { \n  BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer,\n  PieChart, Pie, Cell, LineChart, Line \n} from \"recharts\";\nimport { \n  TrendingUp, Clock, CheckCircle, AlertTriangle, Users, \n  Target, Award, Activity \n} from \"lucide-react\";\nimport { DashboardAnalytics } from \"@/types\";\n\nconst Analytics: React.FC = () => {\n  const [timePeriod, setTimePeriod] = React.useState(\"7d\");\n\n  const { data: analytics, isLoading } = useQuery<DashboardAnalytics>({\n    queryKey: [\"/api/analytics/dashboard\"],\n  });\n\n  const COLORS = ['#2D8028', '#203B17', '#4ADE80', '#F59E0B', '#EF4444'];\n\n  if (isLoading) {\n    return (\n      <div className=\"space-y-6\">\n        <div className=\"animate-pulse space-y-4\">\n          <div className=\"h-8 bg-gray-200 rounded w-1/4\"></div>\n          <div className=\"h-4 bg-gray-200 rounded w-1/2\"></div>\n          <div className=\"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6\">\n            {[1, 2, 3, 4].map((i) => (\n              <div key={i} className=\"h-32 bg-gray-200 rounded-xl\"></div>\n            ))}\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  if (!analytics) {\n    return (\n      <div className=\"text-center py-12\">\n        <div className=\"text-4xl mb-4\">üìä</div>\n        <h3 className=\"text-lg font-medium text-gray-900 mb-2\">No analytics data available</h3>\n        <p className=\"text-gray-600\">Analytics will appear here once you have task data.</p>\n      </div>\n    );\n  }\n\n  const taskStatusData = [\n    { name: 'Completed', value: analytics.completedTasks, color: '#2D8028' },\n    { name: 'In Progress', value: analytics.inProgressTasks, color: '#F59E0B' },\n    { name: 'Pending', value: analytics.pendingTasks, color: '#6B7280' },\n  ];\n\n  const taskTypeData = Object.entries(analytics.tasksByType).map(([type, count]) => ({\n    name: type.charAt(0).toUpperCase() + type.slice(1).replace('_', ' '),\n    value: count,\n  }));\n\n  const completionRate = analytics.totalTasks > 0 \n    ? Math.round((analytics.completedTasks / analytics.totalTasks) * 100)\n    : 0;\n\n  const avgTimePerTask = analytics.completedTasks > 0 \n    ? Math.round(analytics.totalTimeLogged / analytics.completedTasks)\n    : 0;\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Header */}\n      <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between\">\n        <div>\n          <h1 className=\"text-2xl font-bold text-[#203B17] mb-2\">Analytics Dashboard</h1>\n          <p className=\"text-gray-600\">Track performance and insights across your operations</p>\n        </div>\n        <div className=\"mt-4 sm:mt-0\">\n          <Select value={timePeriod} onValueChange={setTimePeriod}>\n            <SelectTrigger className=\"w-32\">\n              <SelectValue />\n            </SelectTrigger>\n            <SelectContent>\n              <SelectItem value=\"7d\">Last 7 days</SelectItem>\n              <SelectItem value=\"30d\">Last 30 days</SelectItem>\n              <SelectItem value=\"90d\">Last 90 days</SelectItem>\n            </SelectContent>\n          </Select>\n        </div>\n      </div>\n\n      {/* KPI Cards */}\n      <div className=\"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6\">\n        <Card>\n          <CardContent className=\"p-6\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <p className=\"text-sm text-gray-600\">Total Tasks</p>\n                <p className=\"text-2xl font-bold text-[#203B17]\">{analytics.totalTasks}</p>\n              </div>\n              <div className=\"bg-blue-100 p-3 rounded-full\">\n                <Target className=\"h-6 w-6 text-blue-600\" />\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardContent className=\"p-6\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <p className=\"text-sm text-gray-600\">Completion Rate</p>\n                <p className=\"text-2xl font-bold text-[#203B17]\">{completionRate}%</p>\n              </div>\n              <div className=\"bg-green-100 p-3 rounded-full\">\n                <CheckCircle className=\"h-6 w-6 text-green-600\" />\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardContent className=\"p-6\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <p className=\"text-sm text-gray-600\">Avg Time/Task</p>\n                <p className=\"text-2xl font-bold text-[#203B17]\">{avgTimePerTask}m</p>\n              </div>\n              <div className=\"bg-amber-100 p-3 rounded-full\">\n                <Clock className=\"h-6 w-6 text-amber-600\" />\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardContent className=\"p-6\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <p className=\"text-sm text-gray-600\">Stock Alerts</p>\n                <p className=\"text-2xl font-bold text-[#203B17]\">{analytics.lowStockAlerts}</p>\n              </div>\n              <div className=\"bg-red-100 p-3 rounded-full\">\n                <AlertTriangle className=\"h-6 w-6 text-red-600\" />\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Charts */}\n      <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n        {/* Task Status Distribution */}\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"flex items-center\">\n              <Activity className=\"h-5 w-5 mr-2\" />\n              Task Status Distribution\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <ResponsiveContainer width=\"100%\" height={300}>\n              <PieChart>\n                <Pie\n                  data={taskStatusData}\n                  cx=\"50%\"\n                  cy=\"50%\"\n                  labelLine={false}\n                  label={({ name, percent }) => `${name} ${(percent * 100).toFixed(0)}%`}\n                  outerRadius={80}\n                  fill=\"#8884d8\"\n                  dataKey=\"value\"\n                >\n                  {taskStatusData.map((entry, index) => (\n                    <Cell key={`cell-${index}`} fill={entry.color} />\n                  ))}\n                </Pie>\n                <Tooltip />\n              </PieChart>\n            </ResponsiveContainer>\n          </CardContent>\n        </Card>\n\n        {/* Task Types */}\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"flex items-center\">\n              <BarChart className=\"h-5 w-5 mr-2\" />\n              Tasks by Type\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <ResponsiveContainer width=\"100%\" height={300}>\n              <BarChart data={taskTypeData}>\n                <CartesianGrid strokeDasharray=\"3 3\" />\n                <XAxis dataKey=\"name\" />\n                <YAxis />\n                <Tooltip />\n                <Bar dataKey=\"value\" fill=\"#2D8028\" />\n              </BarChart>\n            </ResponsiveContainer>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Recent Activity */}\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center\">\n            <TrendingUp className=\"h-5 w-5 mr-2\" />\n            Performance Summary\n          </CardTitle>\n        </CardHeader>\n        <CardContent>\n          <div className=\"grid grid-cols-1 md:grid-cols-3 gap-6\">\n            <div className=\"text-center p-4 bg-gray-50 rounded-lg\">\n              <div className=\"text-2xl font-bold text-[#203B17] mb-2\">\n                {Math.round(analytics.totalTimeLogged / 60 * 10) / 10}h\n              </div>\n              <p className=\"text-sm text-gray-600\">Total Time Logged</p>\n            </div>\n            <div className=\"text-center p-4 bg-gray-50 rounded-lg\">\n              <div className=\"text-2xl font-bold text-[#203B17] mb-2\">\n                {analytics.totalUsers}\n              </div>\n              <p className=\"text-sm text-gray-600\">Active Users</p>\n            </div>\n            <div className=\"text-center p-4 bg-gray-50 rounded-lg\">\n              <div className=\"text-2xl font-bold text-[#203B17] mb-2\">\n                {analytics.totalInventoryItems}\n              </div>\n              <p className=\"text-sm text-gray-600\">Inventory Items</p>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n};\n\nexport default Analytics;\n","path":null,"size_bytes":8757,"size_tokens":null},"client/src/utils/taskHelpers.ts":{"content":"import { Task } from \"@shared/schema\";\n\ninterface User {\n  id: number;\n  rolesAssigned?: string[];\n}\n\nexport function isMyTask(task: Task | null | undefined, currentUser: User | null | undefined): boolean {\n  if (!task) {\n    console.log('‚ùå No task provided');\n    return false;\n  }\n  if (!currentUser) {\n    console.log('‚ùå No current user provided');\n    return false;\n  }\n  \n  // Check assignTo (current) and assignedTo (legacy) fields\n  const assignment = task.assignTo || task.assignedTo;\n  \n  if (!assignment) {\n    console.log('‚ùå No assignment for task:', task.title);\n    return false;\n  }\n  \n  console.log('üîç Assignment Debug:', {\n    taskId: task.id,\n    taskTitle: task.title,\n    assignment: assignment,\n    userIdStr: currentUser.id?.toString(),\n    userRoles: currentUser.rolesAssigned,\n    assignmentType: typeof assignment\n  });\n  \n  // Check if task is assigned to me directly\n  if (assignment === `user_${currentUser.id}`) {\n    console.log('‚úÖ Direct user match:', assignment);\n    return true;\n  }\n  \n  // Check if task is assigned to all staff\n  if (assignment === 'all_staff') {\n    console.log('‚úÖ All staff assignment');\n    return true;\n  }\n  \n  // Check if task is assigned to my role\n  if (assignment && typeof assignment === 'string' && assignment.startsWith('role_')) {\n    const taskRole = assignment.replace('role_', '');\n    if (currentUser.rolesAssigned && currentUser.rolesAssigned.includes(taskRole)) {\n      console.log('‚úÖ Role match:', `\"${taskRole}\" for task:`, task.title);\n      console.log('üéØ ASSIGNED TASK FOUND - SHOULD HAVE GREEN BORDER:', {\n        taskId: task.id,\n        taskTitle: task.title,\n        assignedTo: assignment,\n        isAssigned: true,\n        cssClass: 'assigned-to-me'\n      });\n      return true;\n    } else {\n      console.log('‚ùå Role mismatch:', `\"${taskRole}\" not in roles:`, currentUser.rolesAssigned);\n    }\n  }\n  \n  console.log('‚ùå No match found for task:', task.title);\n  return false;\n}","path":null,"size_bytes":1980,"size_tokens":null},"client/src/components/ui/toggle-group.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as ToggleGroupPrimitive from \"@radix-ui/react-toggle-group\"\nimport { type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\nimport { toggleVariants } from \"@/components/ui/toggle\"\n\nconst ToggleGroupContext = React.createContext<\n  VariantProps<typeof toggleVariants>\n>({\n  size: \"default\",\n  variant: \"default\",\n})\n\nconst ToggleGroup = React.forwardRef<\n  React.ElementRef<typeof ToggleGroupPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Root> &\n    VariantProps<typeof toggleVariants>\n>(({ className, variant, size, children, ...props }, ref) => (\n  <ToggleGroupPrimitive.Root\n    ref={ref}\n    className={cn(\"flex items-center justify-center gap-1\", className)}\n    {...props}\n  >\n    <ToggleGroupContext.Provider value={{ variant, size }}>\n      {children}\n    </ToggleGroupContext.Provider>\n  </ToggleGroupPrimitive.Root>\n))\n\nToggleGroup.displayName = ToggleGroupPrimitive.Root.displayName\n\nconst ToggleGroupItem = React.forwardRef<\n  React.ElementRef<typeof ToggleGroupPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Item> &\n    VariantProps<typeof toggleVariants>\n>(({ className, children, variant, size, ...props }, ref) => {\n  const context = React.useContext(ToggleGroupContext)\n\n  return (\n    <ToggleGroupPrimitive.Item\n      ref={ref}\n      className={cn(\n        toggleVariants({\n          variant: context.variant || variant,\n          size: context.size || size,\n        }),\n        className\n      )}\n      {...props}\n    >\n      {children}\n    </ToggleGroupPrimitive.Item>\n  )\n})\n\nToggleGroupItem.displayName = ToggleGroupPrimitive.Item.displayName\n\nexport { ToggleGroup, ToggleGroupItem }\n","path":null,"size_bytes":1753,"size_tokens":null},"client/src/components/RecurringTaskAnalytics.tsx":{"content":"import React, { useState, useMemo } from 'react';\nimport { useQuery } from '@tanstack/react-query';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Badge } from '@/components/ui/badge';\nimport { Button } from '@/components/ui/button';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { BarChart, Bar, LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer } from 'recharts';\nimport { useLocation } from '@/contexts/LocationContext';\nimport { TrendingUp, TrendingDown, Minus, Clock, CheckCircle, SkipForward } from 'lucide-react';\n\ninterface RecurringTaskData {\n  id: string;\n  title: string;\n  frequency: string;\n  avgCompletionTime: number;\n  completionRate: number;\n  totalInstances: number;\n  assignedTo: string;\n  trend: 'improving' | 'stable' | 'declining';\n  location: string;\n}\n\nexport const RecurringTaskAnalytics: React.FC = () => {\n  const { currentLocation, isViewingAllLocations } = useLocation();\n  const [selectedTask, setSelectedTask] = useState('all');\n  const [compareMode, setCompareMode] = useState(false);\n  const [selectedCompareTasks, setSelectedCompareTasks] = useState<string[]>([]);\n\n  const { data: recurringTasks = [], isLoading } = useQuery<RecurringTaskData[]>({\n    queryKey: ['/api/recurring-tasks', { location: currentLocation.code }],\n    queryFn: async () => {\n      const response = await fetch(`/api/recurring-tasks?location=${currentLocation.code}`);\n      if (!response.ok) throw new Error('Failed to fetch recurring tasks');\n      const rawTasks = await response.json();\n      \n      // Transform to analytics format with mock analytics data\n      return rawTasks.map((task: any) => ({\n        id: task.id,\n        title: task.title,\n        frequency: task.frequency,\n        avgCompletionTime: Math.random() * 30 + 15, // Mock data\n        completionRate: Math.random() * 20 + 80, // Mock data  \n        totalInstances: Math.floor(Math.random() * 100) + 50, // Mock data\n        assignedTo: task.assignedTo || 'Team',\n        trend: ['improving', 'stable', 'declining'][Math.floor(Math.random() * 3)] as 'improving' | 'stable' | 'declining',\n        location: task.location || currentLocation.code\n      }));\n    },\n    enabled: true,\n  });\n\n  // Filter tasks by location if needed\n  const filteredTasks = useMemo(() => {\n    if (isViewingAllLocations) return recurringTasks;\n    return recurringTasks.filter(task => task.location === currentLocation.code);\n  }, [recurringTasks, currentLocation.code, isViewingAllLocations]);\n\n  // Performance over time for selected task (mock data)\n  const performanceData = useMemo(() => {\n    const weeks = ['W1', 'W2', 'W3', 'W4', 'W5', 'W6'];\n    return weeks.map(week => ({\n      week,\n      avgTime: Math.random() * 10 + 15,\n      completionRate: Math.random() * 15 + 85,\n      instances: Math.floor(Math.random() * 20) + 30\n    }));\n  }, [selectedTask]);\n\n  // Staff performance on selected task (mock data)\n  const staffPerformance = useMemo(() => {\n    const staff = ['Sarah', 'Dan', 'Mike', 'Lisa', 'Tom', 'Emma'];\n    return staff.map(name => ({\n      name,\n      avgTime: Math.random() * 10 + 15,\n      instances: Math.floor(Math.random() * 20) + 30,\n      successRate: Math.random() * 10 + 90\n    }));\n  }, [selectedTask]);\n\n  // Task comparison data\n  const comparisonData = useMemo(() => {\n    if (!compareMode || selectedCompareTasks.length === 0) return [];\n    \n    const tasksToCompare = filteredTasks.filter(task => selectedCompareTasks.includes(task.id));\n    return tasksToCompare.map(task => ({\n      name: task.title.substring(0, 20) + '...',\n      completionRate: task.completionRate,\n      avgTime: task.avgCompletionTime,\n      instances: task.totalInstances\n    }));\n  }, [filteredTasks, selectedCompareTasks, compareMode]);\n\n  const getTrendIcon = (trend: string) => {\n    switch (trend) {\n      case 'improving':\n        return <TrendingUp className=\"w-4 h-4 text-green-500\" />;\n      case 'declining':\n        return <TrendingDown className=\"w-4 h-4 text-red-500\" />;\n      default:\n        return <Minus className=\"w-4 h-4 text-gray-500\" />;\n    }\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"space-y-6\">\n        <div className=\"animate-pulse\">\n          <div className=\"h-8 bg-gray-200 rounded mb-4\"></div>\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\n            {[1, 2, 3, 4, 5, 6].map((i) => (\n              <div key={i} className=\"h-32 bg-gray-200 rounded\"></div>\n            ))}\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Header and Controls */}\n      <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between\">\n        <div>\n          <h2 className=\"text-xl font-bold text-[#203B17] mb-2\">Recurring Task Analytics</h2>\n          <p className=\"text-gray-600\">Analyze performance patterns and trends for recurring tasks</p>\n        </div>\n        <div className=\"flex gap-2 mt-4 sm:mt-0\">\n          <Select value={selectedTask} onValueChange={setSelectedTask}>\n            <SelectTrigger className=\"w-48\">\n              <SelectValue placeholder=\"Select task\" />\n            </SelectTrigger>\n            <SelectContent>\n              <SelectItem value=\"all\">All Recurring Tasks</SelectItem>\n              {filteredTasks.map(task => (\n                <SelectItem key={task.id} value={task.id}>\n                  {task.title}\n                </SelectItem>\n              ))}\n            </SelectContent>\n          </Select>\n          <Button\n            variant={compareMode ? 'default' : 'outline'}\n            onClick={() => setCompareMode(!compareMode)}\n          >\n            Compare Tasks\n          </Button>\n        </div>\n      </div>\n\n      {/* Compare Mode Selection */}\n      {compareMode && (\n        <Card className=\"p-4\">\n          <div className=\"flex flex-wrap gap-2\">\n            <span className=\"text-sm font-medium\">Select tasks to compare:</span>\n            {filteredTasks.map(task => (\n              <Badge\n                key={task.id}\n                variant={selectedCompareTasks.includes(task.id) ? 'default' : 'outline'}\n                className=\"cursor-pointer\"\n                onClick={() => {\n                  setSelectedCompareTasks(prev => \n                    prev.includes(task.id) \n                      ? prev.filter(id => id !== task.id)\n                      : [...prev, task.id]\n                  );\n                }}\n              >\n                {task.title}\n              </Badge>\n            ))}\n          </div>\n        </Card>\n      )}\n\n      {/* Task Overview Cards */}\n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\n        {filteredTasks.map((task) => (\n          <Card key={task.id} className=\"p-6 hover:shadow-md transition-shadow\">\n            <div className=\"flex justify-between items-start mb-4\">\n              <div>\n                <h3 className=\"font-semibold text-lg mb-1\">{task.title}</h3>\n                <p className=\"text-sm text-gray-600\">{task.frequency}</p>\n              </div>\n              {getTrendIcon(task.trend)}\n            </div>\n            \n            <div className=\"space-y-3\">\n              <div className=\"flex justify-between items-center\">\n                <div className=\"flex items-center gap-2\">\n                  <CheckCircle className=\"w-4 h-4 text-green-500\" />\n                  <span className=\"text-sm\">Completion Rate</span>\n                </div>\n                <span className=\"font-semibold\">{task.completionRate.toFixed(1)}%</span>\n              </div>\n              \n              <div className=\"flex justify-between items-center\">\n                <div className=\"flex items-center gap-2\">\n                  <Clock className=\"w-4 h-4 text-blue-500\" />\n                  <span className=\"text-sm\">Avg. Time</span>\n                </div>\n                <span className=\"font-semibold\">{task.avgCompletionTime.toFixed(1)} min</span>\n              </div>\n              \n              <div className=\"flex justify-between items-center\">\n                <div className=\"flex items-center gap-2\">\n                  <SkipForward className=\"w-4 h-4 text-gray-500\" />\n                  <span className=\"text-sm\">Total Instances</span>\n                </div>\n                <span className=\"font-semibold\">{task.totalInstances}</span>\n              </div>\n              \n              <div className=\"pt-2 border-t\">\n                <div className=\"flex justify-between items-center\">\n                  <span className=\"text-sm text-gray-600\">Assigned to</span>\n                  <Badge variant=\"outline\">{task.assignedTo?.replace?.('role_', '') || task.assignedTo}</Badge>\n                </div>\n              </div>\n            </div>\n          </Card>\n        ))}\n      </div>\n\n      {/* Performance Charts */}\n      <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n        {/* Performance Over Time */}\n        <Card className=\"p-6\">\n          <CardHeader>\n            <CardTitle>Performance Trend Over Time</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <ResponsiveContainer width=\"100%\" height={300}>\n              <LineChart data={performanceData}>\n                <CartesianGrid strokeDasharray=\"3 3\" />\n                <XAxis dataKey=\"week\" />\n                <YAxis yAxisId=\"left\" orientation=\"left\" />\n                <YAxis yAxisId=\"right\" orientation=\"right\" />\n                <Tooltip />\n                <Bar yAxisId=\"left\" dataKey=\"instances\" fill=\"#e5e7eb\" name=\"Instances\" />\n                <Line \n                  yAxisId=\"right\"\n                  type=\"monotone\" \n                  dataKey=\"completionRate\" \n                  stroke=\"#10b981\" \n                  strokeWidth={2}\n                  name=\"Completion Rate (%)\"\n                />\n                <Line \n                  yAxisId=\"right\"\n                  type=\"monotone\" \n                  dataKey=\"avgTime\" \n                  stroke=\"#3b82f6\" \n                  strokeWidth={2}\n                  name=\"Avg. Time (min)\"\n                />\n              </LineChart>\n            </ResponsiveContainer>\n          </CardContent>\n        </Card>\n\n        {/* Staff Performance */}\n        <Card className=\"p-6\">\n          <CardHeader>\n            <CardTitle>Staff Performance Comparison</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <ResponsiveContainer width=\"100%\" height={300}>\n              <BarChart data={staffPerformance} layout=\"horizontal\">\n                <CartesianGrid strokeDasharray=\"3 3\" />\n                <XAxis type=\"number\" />\n                <YAxis dataKey=\"name\" type=\"category\" width={60} />\n                <Tooltip />\n                <Bar dataKey=\"avgTime\" fill=\"#3b82f6\" name=\"Avg. Time (min)\" />\n                <Bar dataKey=\"successRate\" fill=\"#10b981\" name=\"Success Rate (%)\" />\n              </BarChart>\n            </ResponsiveContainer>\n          </CardContent>\n        </Card>\n\n        {/* Task Comparison (if in compare mode) */}\n        {compareMode && comparisonData.length > 0 && (\n          <Card className=\"p-6 lg:col-span-2\">\n            <CardHeader>\n              <CardTitle>Task Comparison</CardTitle>\n            </CardHeader>\n            <CardContent>\n              <ResponsiveContainer width=\"100%\" height={300}>\n                <BarChart data={comparisonData}>\n                  <CartesianGrid strokeDasharray=\"3 3\" />\n                  <XAxis dataKey=\"name\" />\n                  <YAxis yAxisId=\"left\" orientation=\"left\" />\n                  <YAxis yAxisId=\"right\" orientation=\"right\" />\n                  <Tooltip />\n                  <Bar yAxisId=\"left\" dataKey=\"completionRate\" fill=\"#10b981\" name=\"Completion Rate (%)\" />\n                  <Bar yAxisId=\"right\" dataKey=\"avgTime\" fill=\"#3b82f6\" name=\"Avg. Time (min)\" />\n                </BarChart>\n              </ResponsiveContainer>\n            </CardContent>\n          </Card>\n        )}\n      </div>\n\n      {/* Task Performance Summary */}\n      <Card className=\"p-6\">\n        <CardHeader>\n          <CardTitle>Performance Summary</CardTitle>\n        </CardHeader>\n        <CardContent>\n          <div className=\"grid grid-cols-1 md:grid-cols-3 gap-6\">\n            <div className=\"text-center\">\n              <div className=\"text-2xl font-bold text-green-600\">\n                {(filteredTasks.reduce((acc, task) => acc + task.completionRate, 0) / filteredTasks.length).toFixed(1)}%\n              </div>\n              <div className=\"text-sm text-gray-600\">Average Completion Rate</div>\n            </div>\n            <div className=\"text-center\">\n              <div className=\"text-2xl font-bold text-blue-600\">\n                {(filteredTasks.reduce((acc, task) => acc + task.avgCompletionTime, 0) / filteredTasks.length).toFixed(1)} min\n              </div>\n              <div className=\"text-sm text-gray-600\">Average Completion Time</div>\n            </div>\n            <div className=\"text-center\">\n              <div className=\"text-2xl font-bold text-gray-600\">\n                {filteredTasks.reduce((acc, task) => acc + task.totalInstances, 0)}\n              </div>\n              <div className=\"text-sm text-gray-600\">Total Instances</div>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n};","path":null,"size_bytes":13376,"size_tokens":null},"vite.config.ts":{"content":"import { defineConfig } from \"vite\";\nimport react from \"@vitejs/plugin-react\";\nimport path from \"path\";\nimport runtimeErrorOverlay from \"@replit/vite-plugin-runtime-error-modal\";\n\nexport default defineConfig({\n  plugins: [\n    react(),\n    runtimeErrorOverlay(),\n    ...(process.env.NODE_ENV !== \"production\" &&\n    process.env.REPL_ID !== undefined\n      ? [\n          await import(\"@replit/vite-plugin-cartographer\").then((m) =>\n            m.cartographer(),\n          ),\n        ]\n      : []),\n  ],\n  resolve: {\n    alias: {\n      \"@\": path.resolve(import.meta.dirname, \"client\", \"src\"),\n      \"@shared\": path.resolve(import.meta.dirname, \"shared\"),\n      \"@assets\": path.resolve(import.meta.dirname, \"attached_assets\"),\n    },\n  },\n  root: path.resolve(import.meta.dirname, \"client\"),\n  build: {\n    outDir: path.resolve(import.meta.dirname, \"dist/public\"),\n    emptyOutDir: true,\n  },\n  server: {\n    fs: {\n      strict: true,\n      deny: [\"**/.*\"],\n    },\n  },\n});\n","path":null,"size_bytes":971,"size_tokens":null},"client/src/components/ui/hover-card.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as HoverCardPrimitive from \"@radix-ui/react-hover-card\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst HoverCard = HoverCardPrimitive.Root\n\nconst HoverCardTrigger = HoverCardPrimitive.Trigger\n\nconst HoverCardContent = React.forwardRef<\n  React.ElementRef<typeof HoverCardPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof HoverCardPrimitive.Content>\n>(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\n  <HoverCardPrimitive.Content\n    ref={ref}\n    align={align}\n    sideOffset={sideOffset}\n    className={cn(\n      \"z-50 w-64 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-hover-card-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nHoverCardContent.displayName = HoverCardPrimitive.Content.displayName\n\nexport { HoverCard, HoverCardTrigger, HoverCardContent }\n","path":null,"size_bytes":1251,"size_tokens":null},"client/src/components/ui/table.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Table = React.forwardRef<\n  HTMLTableElement,\n  React.HTMLAttributes<HTMLTableElement>\n>(({ className, ...props }, ref) => (\n  <div className=\"relative w-full overflow-auto\">\n    <table\n      ref={ref}\n      className={cn(\"w-full caption-bottom text-sm\", className)}\n      {...props}\n    />\n  </div>\n))\nTable.displayName = \"Table\"\n\nconst TableHeader = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <thead ref={ref} className={cn(\"[&_tr]:border-b\", className)} {...props} />\n))\nTableHeader.displayName = \"TableHeader\"\n\nconst TableBody = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tbody\n    ref={ref}\n    className={cn(\"[&_tr:last-child]:border-0\", className)}\n    {...props}\n  />\n))\nTableBody.displayName = \"TableBody\"\n\nconst TableFooter = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tfoot\n    ref={ref}\n    className={cn(\n      \"border-t bg-muted/50 font-medium [&>tr]:last:border-b-0\",\n      className\n    )}\n    {...props}\n  />\n))\nTableFooter.displayName = \"TableFooter\"\n\nconst TableRow = React.forwardRef<\n  HTMLTableRowElement,\n  React.HTMLAttributes<HTMLTableRowElement>\n>(({ className, ...props }, ref) => (\n  <tr\n    ref={ref}\n    className={cn(\n      \"border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted\",\n      className\n    )}\n    {...props}\n  />\n))\nTableRow.displayName = \"TableRow\"\n\nconst TableHead = React.forwardRef<\n  HTMLTableCellElement,\n  React.ThHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <th\n    ref={ref}\n    className={cn(\n      \"h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0\",\n      className\n    )}\n    {...props}\n  />\n))\nTableHead.displayName = \"TableHead\"\n\nconst TableCell = React.forwardRef<\n  HTMLTableCellElement,\n  React.TdHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <td\n    ref={ref}\n    className={cn(\"p-4 align-middle [&:has([role=checkbox])]:pr-0\", className)}\n    {...props}\n  />\n))\nTableCell.displayName = \"TableCell\"\n\nconst TableCaption = React.forwardRef<\n  HTMLTableCaptionElement,\n  React.HTMLAttributes<HTMLTableCaptionElement>\n>(({ className, ...props }, ref) => (\n  <caption\n    ref={ref}\n    className={cn(\"mt-4 text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nTableCaption.displayName = \"TableCaption\"\n\nexport {\n  Table,\n  TableHeader,\n  TableBody,\n  TableFooter,\n  TableHead,\n  TableRow,\n  TableCell,\n  TableCaption,\n}\n","path":null,"size_bytes":2765,"size_tokens":null},"client/src/components/SubTabNavigation.tsx":{"content":"import React from 'react';\nimport { getStoredAuth } from '@/lib/auth';\n\ninterface SubTab {\n  id: string;\n  label: string;\n  icon: string;\n  isActive?: boolean;\n  requiresRole?: string;\n}\n\ninterface SubTabNavigationProps {\n  tabs: SubTab[];\n  activeTab: string;\n  onTabChange: (tabId: string) => void;\n}\n\nexport const SubTabNavigation: React.FC<SubTabNavigationProps> = ({ \n  tabs, \n  activeTab, \n  onTabChange \n}) => {\n  const auth = getStoredAuth();\n  const currentUser = auth.user;\n  \n  const visibleTabs = tabs.filter(tab => \n    !tab.requiresRole || \n    currentUser?.role === tab.requiresRole || \n    currentUser?.role === 'corporate'\n  );\n  \n  return (\n    <div className=\"sub-tab-navigation\">\n      {visibleTabs.map(tab => (\n        <button\n          key={tab.id}\n          className={`sub-tab-btn ${activeTab === tab.id ? 'active' : ''}`}\n          onClick={() => onTabChange(tab.id)}\n        >\n          {tab.icon} {tab.label}\n        </button>\n      ))}\n    </div>\n  );\n};","path":null,"size_bytes":982,"size_tokens":null},"client/src/utils/trayIntegration.ts":{"content":"import { TrayMovementService } from '../services/trayMovement';\nimport { Task, InventoryItem } from '@shared/schema';\n\nexport interface TrayCreationData {\n  taskId: number;\n  cropType: string;\n  plantCount: number;\n  systemId: string;\n  spotIds: string[];\n  createdBy: string;\n}\n\nexport class TrayIntegration {\n  // Create tray when seeding task is completed\n  static async createTrayFromTask(task: Task, stepData: any): Promise<void> {\n    // Only create trays for seeding tasks\n    if (!task.type?.includes('seeding')) return;\n\n    const cropType = this.extractCropType(task.title);\n    const category = task.type.includes('microgreen') ? 'microgreens' : 'leafyGreens';\n    \n    // Extract plant count from step data or estimate\n    const plantCount = stepData.plantCount || this.estimatePlantCount(task.type, stepData);\n    \n    // Get system assignment from step data\n    const systemAssignment = stepData.systemAssignment || this.getDefaultSystem(category);\n    \n    try {\n      // Create tray record\n      const tray = TrayMovementService.createTray(\n        cropType,\n        category,\n        plantCount,\n        systemAssignment.systemId,\n        systemAssignment.spotIds,\n        'K', // Location code - could be extracted from task\n        'Current User' // Would come from auth context\n      );\n\n      // Send to backend for persistence\n      await fetch('/api/trays', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          tray,\n          taskId: task.id,\n          timestamp: new Date().toISOString()\n        })\n      });\n\n      console.log(`Created tray ${tray.id} for task ${task.title}`);\n    } catch (error) {\n      console.error('Failed to create tray:', error);\n    }\n  }\n\n  // Extract crop type from task title\n  private static extractCropType(title: string): string {\n    // Common crop mappings\n    const cropMappings: { [key: string]: string } = {\n      'arugula': 'Arugula',\n      'broccoli': 'Broccoli Microgreens',\n      'romaine': 'Romaine Lettuce',\n      'lettuce': 'Lettuce',\n      'basil': 'Basil',\n      'kale': 'Kale',\n      'spinach': 'Spinach'\n    };\n\n    const lowercaseTitle = title.toLowerCase();\n    \n    for (const [key, value] of Object.entries(cropMappings)) {\n      if (lowercaseTitle.includes(key)) {\n        return value;\n      }\n    }\n\n    // Default fallback\n    return 'Mixed Greens';\n  }\n\n  // Estimate plant count based on task type and step data\n  private static estimatePlantCount(taskType: string, stepData: any): number {\n    // Check if plant count was captured in steps\n    if (stepData.plantCount) return stepData.plantCount;\n    if (stepData.trayCount) return stepData.trayCount * 50; // Assume 50 plants per tray\n    \n    // Default estimates by crop type\n    if (taskType.includes('microgreen')) {\n      return 100; // Standard microgreen tray\n    } else if (taskType.includes('leafy')) {\n      return 24; // Standard leafy green tray\n    }\n    \n    return 50; // Default\n  }\n\n  // Get default system for crop category\n  private static getDefaultSystem(category: 'microgreens' | 'leafyGreens'): { systemId: string; spotIds: string[] } {\n    if (category === 'microgreens') {\n      return {\n        systemId: 'nursery-a',\n        spotIds: ['N1']\n      };\n    } else {\n      return {\n        systemId: 'ebb-flow-a',\n        spotIds: ['E1']\n      };\n    }\n  }\n\n  // Deduct inventory items used in seeding\n  static async deductSeedInventory(task: Task, stepData: any): Promise<void> {\n    const cropType = this.extractCropType(task.title);\n    \n    // Find matching inventory item (using product codes)\n    const productCodes: { [key: string]: string } = {\n      'Arugula': 'ARU',\n      'Broccoli Microgreens': 'BRO',\n      'Romaine Lettuce': 'ROM',\n      'Basil': 'BAS',\n      'Kale': 'KAL',\n      'Spinach': 'SPI'\n    };\n\n    const productCode = productCodes[cropType];\n    if (!productCode) return;\n\n    try {\n      // Find inventory item by product code\n      const inventoryResponse = await fetch('/api/inventory');\n      const inventoryItems: InventoryItem[] = await inventoryResponse.json();\n      \n      const seedItem = inventoryItems.find(item => \n        item.name.includes(cropType) && item.category === 'seeds'\n      );\n\n      if (seedItem) {\n        // Deduct seeds used (estimate based on plant count)\n        const seedsUsed = stepData.plantCount ? Math.ceil(stepData.plantCount / 10) : 1;\n        \n        await fetch(`/api/inventory/${seedItem.id}`, {\n          method: 'PATCH',\n          headers: { 'Content-Type': 'application/json' },\n          body: JSON.stringify({\n            quantity: Math.max(0, seedItem.quantity - seedsUsed)\n          })\n        });\n\n        console.log(`Deducted ${seedsUsed} units of ${seedItem.name}`);\n      }\n    } catch (error) {\n      console.error('Failed to deduct inventory:', error);\n    }\n  }\n}","path":null,"size_bytes":4877,"size_tokens":null},"client/src/components/ui/toast.tsx":{"content":"import * as React from \"react\"\nimport * as ToastPrimitives from \"@radix-ui/react-toast\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ToastProvider = ToastPrimitives.Provider\n\nconst ToastViewport = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Viewport>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Viewport>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Viewport\n    ref={ref}\n    className={cn(\n      \"fixed top-0 z-[100] flex max-h-screen w-full flex-col-reverse p-4 sm:bottom-0 sm:right-0 sm:top-auto sm:flex-col md:max-w-[420px]\",\n      className\n    )}\n    {...props}\n  />\n))\nToastViewport.displayName = ToastPrimitives.Viewport.displayName\n\nconst toastVariants = cva(\n  \"group pointer-events-auto relative flex w-full items-center justify-between space-x-4 overflow-hidden rounded-md border p-6 pr-8 shadow-lg transition-all data-[swipe=cancel]:translate-x-0 data-[swipe=end]:translate-x-[var(--radix-toast-swipe-end-x)] data-[swipe=move]:translate-x-[var(--radix-toast-swipe-move-x)] data-[swipe=move]:transition-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[swipe=end]:animate-out data-[state=closed]:fade-out-80 data-[state=closed]:slide-out-to-right-full data-[state=open]:slide-in-from-top-full data-[state=open]:sm:slide-in-from-bottom-full\",\n  {\n    variants: {\n      variant: {\n        default: \"border bg-background text-foreground\",\n        destructive:\n          \"destructive group border-destructive bg-destructive text-destructive-foreground\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nconst Toast = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Root>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Root> &\n    VariantProps<typeof toastVariants>\n>(({ className, variant, ...props }, ref) => {\n  return (\n    <ToastPrimitives.Root\n      ref={ref}\n      className={cn(toastVariants({ variant }), className)}\n      {...props}\n    />\n  )\n})\nToast.displayName = ToastPrimitives.Root.displayName\n\nconst ToastAction = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Action>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Action>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Action\n    ref={ref}\n    className={cn(\n      \"inline-flex h-8 shrink-0 items-center justify-center rounded-md border bg-transparent px-3 text-sm font-medium ring-offset-background transition-colors hover:bg-secondary focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 group-[.destructive]:border-muted/40 group-[.destructive]:hover:border-destructive/30 group-[.destructive]:hover:bg-destructive group-[.destructive]:hover:text-destructive-foreground group-[.destructive]:focus:ring-destructive\",\n      className\n    )}\n    {...props}\n  />\n))\nToastAction.displayName = ToastPrimitives.Action.displayName\n\nconst ToastClose = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Close>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Close>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Close\n    ref={ref}\n    className={cn(\n      \"absolute right-2 top-2 rounded-md p-1 text-foreground/50 opacity-0 transition-opacity hover:text-foreground focus:opacity-100 focus:outline-none focus:ring-2 group-hover:opacity-100 group-[.destructive]:text-red-300 group-[.destructive]:hover:text-red-50 group-[.destructive]:focus:ring-red-400 group-[.destructive]:focus:ring-offset-red-600\",\n      className\n    )}\n    toast-close=\"\"\n    {...props}\n  >\n    <X className=\"h-4 w-4\" />\n  </ToastPrimitives.Close>\n))\nToastClose.displayName = ToastPrimitives.Close.displayName\n\nconst ToastTitle = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Title>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Title>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Title\n    ref={ref}\n    className={cn(\"text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nToastTitle.displayName = ToastPrimitives.Title.displayName\n\nconst ToastDescription = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Description>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Description>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Description\n    ref={ref}\n    className={cn(\"text-sm opacity-90\", className)}\n    {...props}\n  />\n))\nToastDescription.displayName = ToastPrimitives.Description.displayName\n\ntype ToastProps = React.ComponentPropsWithoutRef<typeof Toast>\n\ntype ToastActionElement = React.ReactElement<typeof ToastAction>\n\nexport {\n  type ToastProps,\n  type ToastActionElement,\n  ToastProvider,\n  ToastViewport,\n  Toast,\n  ToastTitle,\n  ToastDescription,\n  ToastClose,\n  ToastAction,\n}\n","path":null,"size_bytes":4845,"size_tokens":null},"client/src/components/TaskModal.tsx":{"content":"import React from \"react\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle } from \"@/components/ui/dialog\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Clock, CheckSquare, Square } from \"lucide-react\";\nimport { Task, ChecklistItem } from \"@shared/schema\";\nimport { TaskType, TaskStatus } from \"@/types\";\nimport { useMutation, useQueryClient, useQuery } from \"@tanstack/react-query\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport confetti from \"canvas-confetti\";\nimport ChecklistExecution from \"./ChecklistExecution\";\n\ninterface TaskModalProps {\n  task: Task | null;\n  isOpen: boolean;\n  onClose: () => void;\n  onTaskAction: (taskId: number, action: 'start' | 'collaborate' | 'complete' | 'pause' | 'skip' | 'view', reason?: string) => void;\n}\n\nconst TaskModal: React.FC<TaskModalProps> = ({ task, isOpen, onClose, onTaskAction }) => {\n  const [checklist, setChecklist] = React.useState<ChecklistItem[]>([]);\n  const [timeStarted, setTimeStarted] = React.useState<Date | null>(null);\n  const [notes, setNotes] = React.useState<string>('');\n  const [showSkipReason, setShowSkipReason] = React.useState(false);\n  const [skipReason, setSkipReason] = React.useState('');\n  const queryClient = useQueryClient();\n  const { toast } = useToast();\n\n  React.useEffect(() => {\n    if (task) {\n      setChecklist(task.checklist || []);\n      setTimeStarted(task.startedAt ? new Date(task.startedAt) : null);\n      setNotes('');\n    }\n  }, [task]);\n\n  const updateTaskMutation = useMutation({\n    mutationFn: async (updates: Partial<Task>) => {\n      if (!task) {\n        console.error(\"No task found for update!\");\n        return null;\n      }\n      const response = await apiRequest(\"PATCH\", `/api/tasks/${task.id}`, updates);\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/tasks\"] });\n    },\n    onError: (error) => {\n      console.error(\"Error updating task:\", error);\n      toast({\n        title: \"Error\",\n        description: \"Failed to update task. Please try again.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const createTaskLogMutation = useMutation({\n    mutationFn: async (logData: { action: string; data?: any }) => {\n      if (!task) return;\n      const response = await apiRequest(\"POST\", `/api/tasks/${task.id}/logs`, {\n        userId: 1, // In a real app, get from auth context\n        ...logData,\n      });\n      return response.json();\n    },\n  });\n\n  // Fetch growing systems for ChecklistExecution\n  const { data: growingSystems = [] } = useQuery({\n    queryKey: ['/api/growing-systems'],\n    queryFn: async () => {\n      const response = await fetch('/api/growing-systems');\n      if (!response.ok) throw new Error('Failed to fetch growing systems');\n      return response.json();\n    },\n  });\n\n  const handleChecklistChange = (itemId: string, completed: boolean, dataValue?: any) => {\n    const currentChecklist = checklist.length > 0 ? checklist : task?.checklist || [];\n    const updatedChecklist = currentChecklist.map(item => {\n      if (item.id === itemId) {\n        const updated = { ...item, completed };\n        if (dataValue !== undefined && item.dataCollection) {\n          updated.dataCollection = { ...item.dataCollection, value: dataValue };\n        }\n        return updated;\n      }\n      return item;\n    });\n    \n    setChecklist(updatedChecklist);\n    \n    // Update progress based on completed items\n    const completedCount = updatedChecklist.filter(item => item.completed).length;\n    const progress = Math.round((completedCount / updatedChecklist.length) * 100);\n    \n    updateTaskMutation.mutate({\n      checklist: updatedChecklist,\n      progress,\n      data: { ...task?.data, checklistData: updatedChecklist },\n    });\n\n    // Log the action\n    createTaskLogMutation.mutate({\n      action: 'data_collected',\n      data: { itemId, completed, dataValue },\n    });\n  };\n\n  const handleStartTask = () => {\n    const now = new Date();\n    setTimeStarted(now);\n    \n    updateTaskMutation.mutate({\n      status: 'in_progress',\n      startedAt: now,\n    });\n\n    createTaskLogMutation.mutate({\n      action: 'started',\n    });\n  };\n\n  const handleCompleteTask = () => {\n    if (!task) {\n      console.error('No task available for completion');\n      return;\n    }\n\n    const now = new Date();\n    const actualTime = timeStarted \n      ? Math.round((now.getTime() - timeStarted.getTime()) / (1000 * 60))\n      : task.estimatedTime || 0;\n\n    console.log('Completing task with status change to completed');\n    console.log('Task ID:', task.id);\n    console.log('Completion data:', {\n      status: 'completed',\n      completedAt: now,\n      actualTime,\n      progress: 100,\n      data: { ...task.data, notes }\n    });\n\n    // Store task ID before closing modal\n    const taskId = task.id;\n    \n    updateTaskMutation.mutate({\n      status: 'completed',\n      completedAt: now.toISOString(),\n      actualTime,\n      progress: 100,\n      data: { ...task.data, notes }, // Store notes in task data\n    });\n\n    createTaskLogMutation.mutate({\n      action: 'completed',\n      data: { actualTime, notes },\n    });\n\n    // Show confetti celebration\n    confetti({\n      particleCount: 100,\n      spread: 70,\n      origin: { y: 0.6 }\n    });\n\n    // Don't close modal immediately - let the mutation complete first\n    // onClose will be called in the mutation success handler\n  };\n\n  if (!task) return null;\n\n  const getTaskEmoji = (type: TaskType): string => {\n    const emojis = {\n      seeding: \"üå±\",\n      moving: \"üåø\",\n      harvesting: \"ü•¨\",\n      packing: \"üì¶\",\n      cleaning: \"üßπ\",\n      inventory: \"üìã\"\n    };\n    return emojis[type] || \"üìã\";\n  };\n\n  const getStatusColor = (status: TaskStatus): string => {\n    const colors = {\n      pending: \"bg-gray-100 text-gray-800\",\n      in_progress: \"bg-blue-100 text-blue-800\",\n      completed: \"bg-green-100 text-green-800\",\n      approved: \"bg-green-100 text-green-800\",\n      paused: \"bg-yellow-100 text-yellow-800\",\n      skipped: \"bg-gray-100 text-gray-800\"\n    };\n    return colors[status] || \"bg-gray-100 text-gray-800\";\n  };\n\n  const formatTime = (minutes: number): string => {\n    const hours = Math.floor(minutes / 60);\n    const mins = minutes % 60;\n    if (hours > 0) {\n      return `${hours}h ${mins}m`;\n    }\n    return `${mins}m`;\n  };\n\n  const getElapsedTime = (): string => {\n    if (!timeStarted) return \"Not started\";\n    const now = new Date();\n    const elapsed = Math.round((now.getTime() - timeStarted.getTime()) / (1000 * 60));\n    return formatTime(elapsed);\n  };\n\n  const allChecklistCompleted = checklist.every(item => item.completed);\n\n  return (\n    <Dialog open={isOpen} onOpenChange={onClose}>\n      <DialogContent className=\"w-[95vw] max-w-2xl max-h-[85vh] overflow-y-auto overflow-x-hidden p-4 sm:p-6\">\n        <DialogHeader>\n          <DialogTitle className=\"flex items-center gap-3\">\n            <span className=\"text-2xl\">{getTaskEmoji(task.type as TaskType)}</span>\n            <div>\n              <h2 className=\"text-lg font-semibold text-[#203B17]\">{task.title}</h2>\n              <p className=\"text-sm text-gray-600 font-normal\">{task.location}</p>\n            </div>\n          </DialogTitle>\n        </DialogHeader>\n\n        <div className=\"space-y-6\">\n          {/* Status and Progress */}\n          <div className=\"flex items-center justify-between\">\n            <Badge className={`${getStatusColor(task.status as TaskStatus)} border-none`}>\n              {task.status.replace('_', ' ')}\n            </Badge>\n            <div className=\"text-sm text-gray-600\">\n              Progress: {task.progress}%\n            </div>\n          </div>\n\n          {task.status === 'in_progress' && (\n            <Progress value={task.progress} className=\"h-2\" />\n          )}\n\n          {/* Description */}\n          {task.description && (\n            <div className=\"bg-gray-50 rounded-lg p-4\">\n              <h4 className=\"font-medium text-[#203B17] mb-2\">Description</h4>\n              <p className=\"text-sm text-gray-600\">{task.description}</p>\n            </div>\n          )}\n\n          {/* Skip Reason */}\n          {task.status === 'skipped' && task.skipReason && (\n            <div className=\"bg-gray-50 rounded-lg p-4\">\n              <h4 className=\"font-medium text-[#203B17] mb-2\">Skip Reason</h4>\n              <p className=\"text-sm text-gray-600\">{task.skipReason}</p>\n            </div>\n          )}\n\n          {/* Advanced Checklist Execution - Keyed by task ID to force remount */}\n          {/* Show for in_progress OR pending tasks so users can preview checklist */}\n          {(checklist.length > 0 || (task.checklist && task.checklist.length > 0)) && (task.status === 'in_progress' || task.status === 'pending') && (\n            <div className=\"bg-gray-50 rounded-lg p-4\">\n              <h4 className=\"font-medium text-[#203B17] mb-4\">Task Checklist</h4>\n              <ChecklistExecution\n                key={task.id}\n                task={task}\n                checklist={{ steps: (checklist.length > 0 ? checklist : task.checklist || []).map(item => ({\n                  id: item.id,\n                  label: item.text,\n                  type: item.type || 'checkbox',\n                  config: item.config || {},\n                  required: item.required || false,\n                  completed: item.completed || false\n                })) }}\n                systems={growingSystems}\n                onComplete={(stepData) => {\n                  // Show completion message instead of auto-completing task\n                  toast({\n                    title: \"All checklist items completed!\",\n                    description: \"Please complete any remaining work, then click 'Complete Task' in the task modal.\",\n                  });\n                }}\n                onProgress={(progress) => {\n                  console.log('üìä Checklist progress update received:', progress);\n                  \n                  // Handle enhanced progress data structure\n                  const progressData = progress.stepData;\n                  \n                  // Update task with comprehensive checklist progress\n                  const completedSteps = progressData.completedSteps || 0;\n                  const totalSteps = progressData.totalSteps || checklist.length;\n                  const progressPercent = Math.round((completedSteps / totalSteps) * 100);\n                  \n                  console.log('üíæ Saving enhanced checklist progress:', {\n                    completedSteps,\n                    totalSteps,\n                    progressPercent,\n                    hasProgressData: !!progressData.checklistProgress\n                  });\n                  \n                  updateTaskMutation.mutate({\n                    progress: progressPercent,\n                    data: { \n                      ...task.data, \n                      checklistProgress: progressData.checklistProgress,\n                      checklistStepData: progressData.checklistStepData,\n                      currentStep: progressData.currentStep,\n                      lastUpdated: new Date().toISOString()\n                    },\n                  });\n                }}\n              />\n            </div>\n          )}\n\n          {/* Enhanced Checklist View for Completed/Skipped Tasks (not pending or in_progress) */}\n          {(checklist.length > 0 || (task.checklist && task.checklist.length > 0)) && task.status !== 'in_progress' && task.status !== 'pending' && (\n            <div className=\"bg-gray-50 rounded-lg p-4\">\n              <h4 className=\"font-medium text-[#203B17] mb-4\">\n                Checklist Details\n                {task.data?.checklistProgress && (\n                  <span className=\"ml-2 text-sm font-normal text-gray-600\">\n                    ({Object.keys(task.data.checklistProgress).length} completed)\n                  </span>\n                )}\n              </h4>\n              <div className=\"space-y-4\">\n                {(checklist.length > 0 ? checklist : task.checklist || []).map((item, index) => {\n                  const savedProgress = task.data?.checklistProgress?.[index];\n                  const isCompleted = savedProgress?.completed || item.completed;\n                  \n                  return (\n                    <div key={item.id} className=\"space-y-2\">\n                      <div className=\"flex items-start space-x-2\">\n                        <Checkbox\n                          checked={isCompleted}\n                          disabled={true}\n                          className=\"mt-0.5\"\n                        />\n                        <div className=\"flex-1\">\n                          <span className={`text-sm ${\n                            isCompleted ? 'line-through text-gray-500' : 'text-[#203B17]'\n                          }`}>\n                            {item.text}\n                          </span>\n                          \n                          {/* Show completion details if available */}\n                          {savedProgress?.completed && (\n                            <div className=\"mt-1 text-xs text-green-600\">\n                              ‚úì Completed on {new Date(savedProgress.completedAt).toLocaleString()}\n                            </div>\n                          )}\n                          \n                          {/* Show step data if available */}\n                          {savedProgress?.stepData && (\n                            <div className=\"mt-1 p-2 bg-gray-100 rounded text-xs\">\n                              <strong>Data collected:</strong>\n                              <pre className=\"mt-1 text-gray-700\">\n                                {JSON.stringify(savedProgress.stepData, null, 2)}\n                              </pre>\n                            </div>\n                          )}\n                        </div>\n                      </div>\n                    </div>\n                  );\n                })}\n              </div>\n              \n              {/* Show last updated timestamp if available */}\n              {task.data?.lastUpdated && (\n                <div className=\"mt-4 pt-3 border-t text-xs text-gray-500\">\n                  Last updated: {new Date(task.data.lastUpdated).toLocaleString()}\n                </div>\n              )}\n            </div>\n          )}\n\n          {/* Time Information */}\n          <div className=\"bg-gray-50 rounded-lg p-4\">\n            <h4 className=\"font-medium text-[#203B17] mb-2\">Time Information</h4>\n            <div className=\"grid grid-cols-2 gap-4 text-sm\">\n              <div>\n                <span className=\"text-gray-600\">Estimated: </span>\n                <span className=\"font-medium\">\n                  {task.estimatedTime ? formatTime(task.estimatedTime) : 'Not specified'}\n                </span>\n              </div>\n              <div>\n                <span className=\"text-gray-600\">Elapsed: </span>\n                <span className=\"font-medium\">{getElapsedTime()}</span>\n              </div>\n            </div>\n          </div>\n\n          {/* Notes Section */}\n          {task.status === 'in_progress' && (\n            <div className=\"bg-gray-50 rounded-lg p-4\">\n              <h4 className=\"font-medium text-[#203B17] mb-2\">Task Notes</h4>\n              <Textarea\n                placeholder=\"Add any notes about your progress, issues encountered, or observations...\"\n                value={notes}\n                onChange={(e) => setNotes(e.target.value)}\n                className=\"min-h-[100px] resize-none\"\n              />\n            </div>\n          )}\n\n          {/* Actions */}\n          <div className=\"flex flex-col sm:flex-row gap-3 pt-4\">\n            {!showSkipReason && (\n              <>\n                {/* Show action buttons only if in-progress */}\n                {task.status === 'in_progress' && (\n                  <>\n                    <Button\n                      onClick={() => onTaskAction(task.id, 'complete')}\n                      className=\"bg-green-600 hover:bg-green-700 text-white ml-auto\"\n                    >\n                      ‚úÖ Complete Task\n                    </Button>\n                    \n                    <Button\n                      onClick={() => onTaskAction(task.id, 'pause')}\n                      variant=\"outline\"\n                      className=\"border-amber-500 text-amber-600 hover:bg-amber-50\"\n                    >\n                      ‚è∏Ô∏è Pause Task\n                    </Button>\n                    \n                    <Button\n                      onClick={() => setShowSkipReason(true)}\n                      variant=\"outline\"\n                      className=\"border-red-500 text-red-600 hover:bg-red-50\"\n                    >\n                      ‚è≠Ô∏è Skip Task\n                    </Button>\n                  </>\n                )}\n                \n                {/* Show completion info if completed */}\n                {task.status === 'completed' && (\n                  <div className=\"bg-green-50 border border-green-200 rounded-lg p-4 w-full\">\n                    <p className=\"text-green-800 font-medium\">‚úÖ Task Completed</p>\n                    {task.completedAt && (\n                      <p className=\"text-sm text-green-600 mt-1\">\n                        Completed at: {new Date(task.completedAt).toLocaleString()}\n                      </p>\n                    )}\n                  </div>\n                )}\n\n                {/* Show pause info if paused */}\n                {task.status === 'paused' && (\n                  <div className=\"bg-yellow-50 border border-yellow-200 rounded-lg p-4 w-full\">\n                    <p className=\"text-yellow-800 font-medium\">‚è∏Ô∏è Task Paused</p>\n                    {task.pausedAt && (\n                      <p className=\"text-sm text-yellow-600 mt-1\">\n                        Paused at: {new Date(task.pausedAt).toLocaleString()}\n                      </p>\n                    )}\n                  </div>\n                )}\n\n                {/* Show skip info if skipped */}\n                {task.status === 'skipped' && (\n                  <div className=\"bg-gray-50 border border-gray-200 rounded-lg p-4 w-full\">\n                    <p className=\"text-gray-800 font-medium\">‚è≠Ô∏è Task Skipped</p>\n                    {task.skippedAt && (\n                      <p className=\"text-sm text-gray-600 mt-1\">\n                        Skipped at: {new Date(task.skippedAt).toLocaleString()}\n                      </p>\n                    )}\n                  </div>\n                )}\n                \n                <Button variant=\"outline\" onClick={onClose}>\n                  {task.status === 'completed' ? 'Close' : 'Cancel'}\n                </Button>\n              </>\n            )}\n            \n            {showSkipReason && (\n              <div className=\"w-full space-y-3\">\n                <Label className=\"text-sm font-medium text-[#203B17]\">\n                  Reason for skipping:\n                </Label>\n                <Textarea\n                  placeholder=\"Please provide a reason for skipping this task...\"\n                  value={skipReason}\n                  onChange={(e) => setSkipReason(e.target.value)}\n                  className=\"min-h-[80px]\"\n                />\n                <div className=\"flex gap-2\">\n                  <Button\n                    onClick={() => {\n                      if (skipReason.trim()) {\n                        onTaskAction(task.id, 'skip', skipReason);\n                        setShowSkipReason(false);\n                        setSkipReason('');\n                      }\n                    }}\n                    disabled={!skipReason.trim()}\n                    className=\"bg-red-600 hover:bg-red-700 text-white\"\n                  >\n                    Confirm Skip\n                  </Button>\n                  <Button\n                    onClick={() => {\n                      setShowSkipReason(false);\n                      setSkipReason('');\n                    }}\n                    variant=\"outline\"\n                  >\n                    Cancel\n                  </Button>\n                </div>\n              </div>\n            )}\n          </div>\n        </div>\n      </DialogContent>\n    </Dialog>\n  );\n};\n\nexport default TaskModal;\n","path":null,"size_bytes":20722,"size_tokens":null},"client/src/data/roleTaskMapping.ts":{"content":"// Direct mapping of task types to their corresponding roles\nexport const taskTypeToRoleMapping: Record<string, string> = {\n  'Seeding - Microgreens': 'Microgreens Seeder',\n  'Seeding - Leafy Greens': 'Leafy Greens Seeder',\n  'Harvest - Microgreens': 'Microgreens Harvester',\n  'Harvest - Leafy Greens': 'Leafy Greens Harvester',\n  'Blackout Tasks': 'Blackout Specialist',\n  'Moving': 'Moving Tech',\n  'Packing': 'Packing Tech',\n  'Cleaning': 'Cleaning Crew',\n  'Inventory': 'Inventory Tech',\n  'Equipment Maintenance': 'Equipment Tech',\n  'Other': 'All Staff' // Special case - assigns to everyone\n};\n\n// Get the primary role for a task type\nexport const getPrimaryRole = (taskType: string): string => {\n  return taskTypeToRoleMapping[taskType] || 'General Staff';\n};\n\n// Get all available roles from the mapping\nexport const getAllRoles = (): string[] => {\n  const roles = Array.from(new Set(Object.values(taskTypeToRoleMapping)));\n  // Add Manager role which can do everything\n  roles.push('Manager');\n  // Remove 'All Staff' as it's not a real role\n  return roles.filter(role => role !== 'All Staff').sort();\n};\n\n// Check if a role can handle a task type\nexport const canRoleHandleTaskType = (role: string, taskType: string): boolean => {\n  // Managers can handle all task types\n  if (role === 'Manager') return true;\n  \n  // Direct role match\n  const primaryRole = getPrimaryRole(taskType);\n  if (role === primaryRole) return true;\n  \n  // 'Other' tasks can be done by anyone\n  if (taskType === 'Other') return true;\n  \n  return false;\n};\n\n// Map legacy task types to new role-based types\nexport const taskTypeMapping: Record<string, string> = {\n  'seeding-microgreens': 'Seeding - Microgreens',\n  'seeding-leafy-greens': 'Seeding - Leafy Greens',\n  'harvest-microgreens': 'Harvest - Microgreens',\n  'harvest-leafy-greens': 'Harvest - Leafy Greens',\n  'blackout-tasks': 'Blackout Tasks',\n  'moving': 'Moving',\n  'packing': 'Packing',\n  'cleaning': 'Cleaning',\n  'inventory': 'Inventory',\n  'equipment-maintenance': 'Equipment Maintenance',\n  'other': 'Other'\n};\n\n// Convert legacy task type to new format\nexport const convertTaskType = (legacyType: string): string => {\n  return taskTypeMapping[legacyType] || legacyType;\n};\n\n// Get task type options for forms\nexport const getTaskTypeOptions = () => {\n  return Object.keys(taskTypeToRoleMapping).map(taskType => ({\n    value: taskType,\n    label: taskType,\n    primaryRole: getPrimaryRole(taskType)\n  }));\n};","path":null,"size_bytes":2464,"size_tokens":null},"client/src/services/taskAssignmentService.ts":{"content":"import { getPrimaryRole } from '../data/roleTaskMapping';\nimport { StaffMember } from './staffService';\n\nexport interface AssignmentOption {\n  value: string;\n  label: string;\n  type: 'role' | 'user' | 'special';\n  staffCount?: number;\n  staffIds?: string[];\n  userId?: string;\n  roles?: string[];\n  isPrimary?: boolean;\n  isCurrentUser?: boolean;\n  hasPrimaryRole?: boolean;\n}\n\nexport interface AssignmentOptions {\n  roles: AssignmentOption[];\n  users: AssignmentOption[];\n  special: AssignmentOption[];\n}\n\n// Get dynamic assignment options based on task type and current staff\nexport const getAssignmentOptions = async (currentUser: any, taskType: string): Promise<AssignmentOptions> => {\n  try {\n    // Fetch all staff\n    const response = await fetch('/api/staff');\n    const staff: StaffMember[] = await response.json();\n    \n    // Filter active staff only (case insensitive check) AND exclude deleted users\n    const activeStaff = staff.filter(s => \n      s.activeStatus?.toLowerCase() === 'active' && \n      !s.fullName?.startsWith('[DELETED]')\n    );\n    \n    // Get the primary role for this task type\n    const primaryRole = getPrimaryRole(taskType);\n    \n    // Build roles list with staff counts\n    const rolesWithStaff: Record<string, StaffMember[]> = {};\n    activeStaff.forEach(member => {\n      member.rolesAssigned.forEach(role => {\n        if (!rolesWithStaff[role]) {\n          rolesWithStaff[role] = [];\n        }\n        rolesWithStaff[role].push(member);\n      });\n    });\n    \n    // Build final assignment options\n    const assignmentOptions: AssignmentOptions = {\n      roles: [],\n      users: [],\n      special: []\n    };\n    \n    // For \"Other\" tasks, add \"All Staff\" as the primary option\n    if (taskType === 'Other') {\n      assignmentOptions.special.push({\n        value: 'all_staff',\n        label: 'üë• All Staff (Recommended)',\n        type: 'special',\n        staffCount: activeStaff.length,\n        isPrimary: true\n      });\n    }\n    \n    // Add the primary role first if it has staff\n    if (primaryRole && primaryRole !== 'All Staff' && rolesWithStaff[primaryRole]) {\n      assignmentOptions.roles.push({\n        value: `role_${primaryRole}`,\n        label: `üë§ ${primaryRole} (Recommended)`,\n        type: 'role',\n        staffCount: rolesWithStaff[primaryRole].length,\n        staffIds: rolesWithStaff[primaryRole].map(s => s.id),\n        isPrimary: true\n      });\n    }\n    \n    // Add Manager role if there are managers (they can do any task)\n    if (rolesWithStaff['Manager']) {\n      assignmentOptions.roles.push({\n        value: 'role_Manager',\n        label: 'üë§ Manager',\n        type: 'role',\n        staffCount: rolesWithStaff['Manager'].length,\n        staffIds: rolesWithStaff['Manager'].map(s => s.id),\n        isPrimary: false\n      });\n    }\n    \n    // Add all other roles (sorted alphabetically)\n    const otherRoles = Object.keys(rolesWithStaff)\n      .filter(role => \n        role !== primaryRole && \n        role !== 'Manager' &&\n        rolesWithStaff[role].length > 0\n      )\n      .sort();\n    \n    otherRoles.forEach(role => {\n      assignmentOptions.roles.push({\n        value: `role_${role}`,\n        label: `üë§ ${role}`,\n        type: 'role',\n        staffCount: rolesWithStaff[role].length,\n        staffIds: rolesWithStaff[role].map(s => s.id),\n        isPrimary: false\n      });\n    });\n    \n    // Add individual users (sorted by name)\n    const sortedStaff = [...activeStaff].sort((a, b) => \n      a.fullName.localeCompare(b.fullName)\n    );\n    \n    sortedStaff.forEach(member => {\n      // Check if this user has the primary role\n      const hasPrimaryRole = member.rolesAssigned.includes(primaryRole);\n      \n      assignmentOptions.users.push({\n        value: `user_${member.id}`,\n        label: member.fullName,\n        type: 'user',\n        userId: member.id,\n        roles: member.rolesAssigned,\n        isCurrentUser: member.id === currentUser?.id?.toString(),\n        hasPrimaryRole: hasPrimaryRole\n      });\n    });\n    \n    return assignmentOptions;\n    \n  } catch (error) {\n    console.error('Error fetching assignment options:', error);\n    return { roles: [], users: [], special: [] };\n  }\n};\n\n// Check if a task is assigned to a specific user\nexport const isTaskAssignedToUser = (task: any, currentUser: any, staff: StaffMember[]): boolean => {\n  if (!currentUser) return false;\n  \n  const userId = currentUser.id?.toString();\n  \n  // Check new assignTo field first\n  if (task.assignTo) {\n    // Direct user assignment\n    if (task.assignTo === `user_${userId}`) return true;\n    \n    // All staff assignment\n    if (task.assignTo === 'all_staff') return true;\n    \n    // Role assignment - check if user has the role\n    if (task.assignTo.startsWith('role_')) {\n      const roleName = task.assignTo.replace('role_', '');\n      const currentStaff = staff.find(s => s.id === userId);\n      return currentStaff?.rolesAssigned.includes(roleName) || false;\n    }\n  }\n  \n  // Fallback to legacy assignedTo field\n  if (task.assignedTo && task.assignedTo.toString() === userId) {\n    return true;\n  }\n  \n  return false;\n};\n\n// Get assignment display text for a task\nexport const getAssignmentText = (task: any, staff: StaffMember[]): string => {\n  // Debug logging - can be removed later\n  if (task.assignTo || task.assignedTo) {\n    console.log('getAssignmentText - Task:', task.id, 'assignTo:', task.assignTo, 'assignedTo:', task.assignedTo);\n  }\n  \n  // Check new assignTo field first\n  if (task.assignTo) {\n    if (task.assignTo.startsWith('user_')) {\n      const userId = task.assignTo.replace('user_', '');\n      console.log('Looking for user ID:', userId, 'Staff IDs:', staff.map(s => ({ id: s.id, name: s.fullName })));\n      \n      // Try both string and number comparison since ID types might vary\n      const assignedUser = staff.find(s => s.id === userId || s.id === parseInt(userId, 10).toString());\n      console.log('Found user:', assignedUser?.fullName || 'NOT FOUND');\n      return assignedUser?.fullName || `Unknown User (ID: ${userId})`;\n    }\n    \n    if (task.assignTo.startsWith('role_')) {\n      const roleName = task.assignTo.replace('role_', '');\n      return roleName; // Remove emoji since it's already in the dropdown\n    }\n    \n    if (task.assignTo === 'all_staff') {\n      return 'All Staff'; // Remove emoji since it's already in the dropdown\n    }\n    \n    // Handle malformed assignTo values\n    console.log('Malformed assignTo value:', task.assignTo);\n    return `Unknown Assignment: ${task.assignTo}`;\n  }\n  \n  // Fallback to legacy assignedTo field\n  if (task.assignedTo) {\n    console.log('Using legacy assignedTo:', task.assignedTo, typeof task.assignedTo);\n    \n    // Handle legacy role assignments (e.g., \"role_Blackout Specialist\")\n    if (typeof task.assignedTo === 'string' && task.assignedTo.startsWith('role_')) {\n      const roleName = task.assignedTo.replace('role_', '');\n      console.log('Legacy role assignment:', roleName);\n      return roleName; // Remove emoji since it's already in the dropdown\n    }\n    \n    // Handle legacy \"all_staff\" assignment\n    if (task.assignedTo === 'all_staff') {\n      console.log('Legacy all_staff assignment');\n      return 'All Staff'; // Remove emoji since it's already in the dropdown\n    }\n    \n    // Handle direct user ID assignment\n    const assignedUser = staff.find(s => \n      s.id === task.assignedTo.toString() || \n      s.id === parseInt(task.assignedTo.toString(), 10).toString()\n    );\n    \n    if (assignedUser) {\n      const result = assignedUser.fullName;\n      console.log('Legacy user assignment result:', result);\n      return result;\n    }\n    \n    // If it's a string that doesn't match a user, it might be a malformed assignment\n    console.log('Unknown legacy assignment:', task.assignedTo);\n    return `Unknown Assignment: ${task.assignedTo}`;\n  }\n  \n  return 'Unassigned';\n};\n\n// Get staff members who should see a task based on assignment\nexport const getAssignedStaffIds = (task: any, staff: StaffMember[]): string[] => {\n  const activeStaff = staff.filter(s => s.activeStatus?.toLowerCase() === 'active');\n  \n  // Check new assignTo field first\n  if (task.assignTo) {\n    if (task.assignTo.startsWith('user_')) {\n      const userId = task.assignTo.replace('user_', '');\n      return [userId];\n    }\n    \n    if (task.assignTo.startsWith('role_')) {\n      const roleName = task.assignTo.replace('role_', '');\n      return activeStaff\n        .filter(member => member.rolesAssigned.includes(roleName))\n        .map(member => member.id);\n    }\n    \n    if (task.assignTo === 'all_staff') {\n      return activeStaff.map(member => member.id);\n    }\n  }\n  \n  // Fallback to legacy assignedTo field\n  if (task.assignedTo) {\n    return [task.assignedTo.toString()];\n  }\n  \n  return [];\n};","path":null,"size_bytes":8787,"size_tokens":null},"client/src/components/SystemAssignment.tsx":{"content":"import React, { useState, useEffect } from 'react';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Button } from '@/components/ui/button';\nimport { Badge } from '@/components/ui/badge';\nimport { Progress } from '@/components/ui/progress';\nimport { GrowingSystem } from '../data/systemsData';\nimport { AvailableSpot, findAvailableSpots } from '../utils/systemAvailability';\nimport { Building, Sparkles, AlertTriangle } from 'lucide-react';\n\ninterface SystemAssignmentProps {\n  systems: GrowingSystem[];\n  systemType: string;\n  spotsNeeded: number;\n  plantType?: string;\n  onAssign: (systemId: string, spotIds: string[]) => void;\n  autoSuggest?: boolean;\n}\n\nexport const SystemAssignment: React.FC<SystemAssignmentProps> = ({\n  systems,\n  systemType,\n  spotsNeeded,\n  plantType,\n  onAssign,\n  autoSuggest = true\n}) => {\n  const [availableSpots, setAvailableSpots] = useState<AvailableSpot[]>([]);\n  const [selectedOption, setSelectedOption] = useState<number>(0);\n  \n  useEffect(() => {\n    const spots = findAvailableSpots(systems, systemType, spotsNeeded, plantType);\n    setAvailableSpots(spots);\n    \n    if (autoSuggest && spots.length > 0) {\n      setSelectedOption(0);\n    }\n  }, [systems, systemType, spotsNeeded, plantType, autoSuggest]);\n  \n  const handleAssign = () => {\n    if (availableSpots[selectedOption]) {\n      const selected = availableSpots[selectedOption];\n      onAssign(selected.systemId, selected.spotIds);\n    }\n  };\n  \n  if (availableSpots.length === 0) {\n    return (\n      <Card className=\"border-orange-200 bg-orange-50\">\n        <CardContent className=\"pt-6\">\n          <div className=\"flex items-center gap-3 text-orange-800\">\n            <AlertTriangle className=\"w-5 h-5\" />\n            <div>\n              <p className=\"font-medium\">No Available Spots</p>\n              <p className=\"text-sm text-orange-600\">\n                No available {systemType} spots for {spotsNeeded} plants\n              </p>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n    );\n  }\n  \n  return (\n    <Card>\n      <CardHeader>\n        <CardTitle className=\"flex items-center gap-2\">\n          <Building className=\"w-5 h-5\" />\n          Select System Assignment\n        </CardTitle>\n        \n        {autoSuggest && (\n          <div className=\"flex items-center gap-2 p-2 bg-yellow-50 rounded-lg\">\n            <Sparkles className=\"w-4 h-4 text-yellow-600\" />\n            <span className=\"text-sm text-yellow-800\">\n              Recommended based on availability\n            </span>\n          </div>\n        )}\n      </CardHeader>\n      \n      <CardContent className=\"space-y-4\">\n        <div className=\"space-y-3\">\n          {availableSpots.map((spot, index) => {\n            const system = systems.find(s => s.id === spot.systemId);\n            const utilizationRate = system ? \n              (system.currentOccupancy / system.configuration.totalCapacity) * 100 : 0;\n            \n            return (\n              <div\n                key={index}\n                className={`p-4 border rounded-lg cursor-pointer transition-all ${\n                  selectedOption === index \n                    ? 'border-green-500 bg-green-50' \n                    : 'border-gray-200 hover:border-gray-300'\n                }`}\n                onClick={() => setSelectedOption(index)}\n              >\n                <div className=\"flex items-center justify-between mb-2\">\n                  <div className=\"flex items-center gap-3\">\n                    <input\n                      type=\"radio\"\n                      checked={selectedOption === index}\n                      onChange={() => setSelectedOption(index)}\n                      className=\"text-green-600\"\n                    />\n                    <div>\n                      <span className=\"font-medium\">{spot.systemName}</span>\n                      {spot.section && (\n                        <Badge variant=\"outline\" className=\"ml-2\">\n                          {spot.section}\n                        </Badge>\n                      )}\n                    </div>\n                  </div>\n                  <div className=\"text-right\">\n                    <p className=\"text-sm text-green-600 font-medium\">\n                      {spot.spotIds.length} spots available\n                    </p>\n                    <p className=\"text-xs text-gray-500\">\n                      {utilizationRate.toFixed(0)}% utilized\n                    </p>\n                  </div>\n                </div>\n                \n                <Progress \n                  value={utilizationRate} \n                  className=\"h-2\"\n                />\n              </div>\n            );\n          })}\n        </div>\n        \n        <Button \n          onClick={handleAssign}\n          disabled={selectedOption === null}\n          className=\"w-full bg-green-600 hover:bg-green-700\"\n        >\n          Assign to {availableSpots[selectedOption]?.systemName}\n        </Button>\n      </CardContent>\n    </Card>\n  );\n};","path":null,"size_bytes":5011,"size_tokens":null},"server/vite.ts":{"content":"import express, { type Express } from \"express\";\nimport fs from \"fs\";\nimport path from \"path\";\nimport { createServer as createViteServer, createLogger } from \"vite\";\nimport { type Server } from \"http\";\nimport viteConfig from \"../vite.config\";\nimport { nanoid } from \"nanoid\";\n\nconst viteLogger = createLogger();\n\nexport function log(message: string, source = \"express\") {\n  const formattedTime = new Date().toLocaleTimeString(\"en-US\", {\n    hour: \"numeric\",\n    minute: \"2-digit\",\n    second: \"2-digit\",\n    hour12: true,\n  });\n\n  console.log(`${formattedTime} [${source}] ${message}`);\n}\n\nexport async function setupVite(app: Express, server: Server) {\n  const serverOptions = {\n    middlewareMode: true,\n    hmr: { server },\n    allowedHosts: true as const,\n  };\n\n  const vite = await createViteServer({\n    ...viteConfig,\n    configFile: false,\n    customLogger: {\n      ...viteLogger,\n      error: (msg, options) => {\n        viteLogger.error(msg, options);\n        process.exit(1);\n      },\n    },\n    server: serverOptions,\n    appType: \"custom\",\n  });\n\n  app.use(vite.middlewares);\n  app.use(\"*\", async (req, res, next) => {\n    const url = req.originalUrl;\n\n    try {\n      const clientTemplate = path.resolve(\n        import.meta.dirname,\n        \"..\",\n        \"client\",\n        \"index.html\",\n      );\n\n      // always reload the index.html file from disk incase it changes\n      let template = await fs.promises.readFile(clientTemplate, \"utf-8\");\n      template = template.replace(\n        `src=\"/src/main.tsx\"`,\n        `src=\"/src/main.tsx?v=${nanoid()}\"`,\n      );\n      const page = await vite.transformIndexHtml(url, template);\n      res.status(200).set({ \"Content-Type\": \"text/html\" }).end(page);\n    } catch (e) {\n      vite.ssrFixStacktrace(e as Error);\n      next(e);\n    }\n  });\n}\n\nexport function serveStatic(app: Express) {\n  const distPath = path.resolve(import.meta.dirname, \"public\");\n\n  if (!fs.existsSync(distPath)) {\n    throw new Error(\n      `Could not find the build directory: ${distPath}, make sure to build the client first`,\n    );\n  }\n\n  app.use(express.static(distPath));\n\n  // fall through to index.html if the file doesn't exist\n  app.use(\"*\", (_req, res) => {\n    res.sendFile(path.resolve(distPath, \"index.html\"));\n  });\n}\n","path":null,"size_bytes":2263,"size_tokens":null},"client/src/App-broken-backup.tsx":{"content":"import { useEffect, useState } from \"react\";\nimport { Switch, Route } from \"wouter\";\nimport { queryClient } from \"./lib/queryClient\";\nimport { QueryClientProvider } from \"@tanstack/react-query\";\nimport { Toaster } from \"@/components/ui/toaster\";\nimport { TooltipProvider } from \"@/components/ui/tooltip\";\nimport Layout from \"@/components/Layout\";\nimport ErrorBoundary from \"@/components/ErrorBoundary\";\nimport { MsalProvider, useIsAuthenticated, useMsal } from \"@azure/msal-react\";\nimport { PublicClientApplication } from \"@azure/msal-browser\";\nimport { msalConfig, isAuthorizedEmail } from './config/authConfig';\nimport { MicrosoftLogin } from './components/auth/MicrosoftLogin';\nimport { UserProvider } from './contexts/UserContext';\nimport Tasks from \"@/pages/Tasks\";\nimport Inventory from \"@/pages/Inventory\";\nimport Education from \"@/pages/Education\";\nimport Account from \"@/pages/Account\";\nimport RecurringTasks from \"@/pages/RecurringTasks\";\nimport TaskData from \"@/pages/TaskData\";\nimport StaffData from \"@/pages/StaffData\";\nimport ProductionData from \"@/pages/ProductionData\";\nimport TrayTracking from \"@/pages/TrayTracking\";\nimport NotFound from \"@/pages/not-found\";\nimport Confetti from \"@/components/Confetti\";\nimport { LocationProvider } from \"@/contexts/LocationContext\";\nimport { initializeProductionData } from \"@/data/initialData\";\nimport { initializeCleanState } from \"@/utils/dataCleanup\";\nimport { createStaffFromMicrosoftLogin, updateLastActive, initializeExpectedStaff } from \"@/services/staffService\";\nimport { useActivityTracking } from \"@/hooks/useActivityTracking\";\nimport { teamsAuthService } from \"./services/teamsAuthService\";\n\nconst msalInstance = new PublicClientApplication(msalConfig);\n\n// The staff service now handles user creation and role assignment automatically\n\nfunction ProtectedRoute({ children }: { children: React.ReactNode }) {\n  return (\n    <LocationProvider>\n      <Layout>{children}</Layout>\n    </LocationProvider>\n  );\n}\n\nfunction AppContent() {\n  const isAuthenticated = useIsAuthenticated();\n  const { accounts, instance } = useMsal();\n  const [isLoading, setIsLoading] = useState(true);\n  const [currentUser, setCurrentUser] = useState<any>(null);\n  const [teamsAuthAttempted, setTeamsAuthAttempted] = useState(false);\n  \n  // Activity tracking for the current user\n  useActivityTracking(currentUser?.id);\n\n  // Try Teams authentication first\n  useEffect(() => {\n    const attemptTeamsAuth = async () => {\n      if (teamsAuthAttempted) return;\n      \n      setTeamsAuthAttempted(true);\n      console.log(\"Attempting Teams authentication...\");\n      \n      try {\n        const teamsResult = await teamsAuthService.initialize();\n        \n        if (teamsResult.isInTeams && teamsResult.account) {\n          console.log(\"Running in Teams, auto-authenticating user:\", teamsResult.account.name);\n          \n          // Verify email domain\n          if (!isAuthorizedEmail(teamsResult.account.username)) {\n            console.error('Access denied. Only @growspace.farm emails are allowed.');\n            teamsAuthService.notifyFailure('Access denied. Only @growspace.farm emails are allowed.');\n            setIsLoading(false);\n            return;\n          }\n\n          // Process Teams user same as regular MSAL user\n          await processUserLogin(teamsResult.account);\n          teamsAuthService.notifySuccess();\n          return;\n        }\n      } catch (error) {\n        console.log(\"Teams authentication failed, falling back to regular MSAL:\", error);\n      }\n      \n      // If not in Teams or Teams auth failed, check regular MSAL\n      if (isAuthenticated && accounts[0]) {\n        await processUserLogin(accounts[0]);\n      } else {\n        setIsLoading(false);\n      }\n    };\n\n    attemptTeamsAuth();\n  }, [isAuthenticated, accounts, teamsAuthAttempted]);\n\n  const processUserLogin = async (account: any) => {\n    try {\n      // Create or update staff entry automatically\n      const staffMember = await createStaffFromMicrosoftLogin(\n        account.localAccountId || account.homeAccountId || '',\n        account.name || 'User',\n        account.username\n      );\n\n      // Determine role based on staff member\n      let role: 'Staff' | 'Manager' | 'Corporate' = 'Staff';\n      let isManager = false;\n      let isCorporateManager = false;\n\n      if (staffMember.rolesAssigned.includes('Corporate Manager')) {\n        role = 'Corporate';\n        isManager = true;\n        isCorporateManager = true;\n      } else if (staffMember.rolesAssigned.includes('Manager')) {\n        role = 'Manager';\n        isManager = true;\n      }\n\n      // Create user object for context\n      const user = {\n        id: staffMember.id,\n        name: staffMember.fullName,\n        email: staffMember.email,\n        role,\n        isManager,\n        isCorporateManager,\n        location: staffMember.location\n      };\n\n      console.log('Initialized user:', user.name, user.email, user.role);\n      setCurrentUser(user);\n\n      // Initialize expected staff members if current user is corporate\n      if (role === 'Corporate') {\n          try {\n            await initializeExpectedStaff();\n          } catch (error) {\n            console.error('Failed to initialize expected staff:', error);\n          }\n        }\n      }\n      setIsLoading(false);\n    };\n\n    initializeUser();\n  }, [isAuthenticated, accounts, instance]);\n\n  if (isLoading) {\n    return (\n      <div className=\"loading-screen\">\n        <h2>üå± Loading Grow Space...</h2>\n      </div>\n    );\n  }\n\n  if (!isAuthenticated) {\n    return <MicrosoftLogin />;\n  }\n\n  if (!currentUser) {\n    return <div className=\"loading-screen\">Setting up your account...</div>;\n  }\n\n  // Your existing app with UserProvider\n  return (\n    <UserProvider value={{ currentUser, setCurrentUser }}>\n      <Router />\n    </UserProvider>\n  );\n}\n\nfunction Router() {\n  return (\n    <Switch>\n      <Route path=\"/\">\n        <ProtectedRoute>\n          <Tasks />\n        </ProtectedRoute>\n      </Route>\n      <Route path=\"/inventory\">\n        <ProtectedRoute>\n          <Inventory />\n        </ProtectedRoute>\n      </Route>\n      <Route path=\"/education\">\n        <ProtectedRoute>\n          <Education />\n        </ProtectedRoute>\n      </Route>\n\n      <Route path=\"/account\">\n        <ProtectedRoute>\n          <Account />\n        </ProtectedRoute>\n      </Route>\n      <Route path=\"/recurring-tasks\">\n        <ProtectedRoute>\n          <RecurringTasks />\n        </ProtectedRoute>\n      </Route>\n      <Route path=\"/task-data\">\n        <ProtectedRoute>\n          <div className=\"min-h-screen flex items-center justify-center bg-gray-50\">\n            <div className=\"text-center p-8\">\n              <div className=\"text-6xl mb-4\">üöß</div>\n              <h2 className=\"text-2xl font-bold text-gray-900 mb-4\">Coming Soon</h2>\n              <p className=\"text-gray-600\">This feature is being developed and will be available soon.</p>\n            </div>\n          </div>\n        </ProtectedRoute>\n      </Route>\n      <Route path=\"/staff-data\">\n        <ProtectedRoute>\n          <StaffData />\n        </ProtectedRoute>\n      </Route>\n      <Route path=\"/production-data\">\n        <ProtectedRoute>\n          <div className=\"min-h-screen flex items-center justify-center bg-gray-50\">\n            <div className=\"text-center p-8\">\n              <div className=\"text-6xl mb-4\">üöß</div>\n              <h2 className=\"text-2xl font-bold text-gray-900 mb-4\">Coming Soon</h2>\n              <p className=\"text-gray-600\">This feature is being developed and will be available soon.</p>\n            </div>\n          </div>\n        </ProtectedRoute>\n      </Route>\n      <Route path=\"/tray-tracking\">\n        <ProtectedRoute>\n          <TrayTracking />\n        </ProtectedRoute>\n      </Route>\n      <Route component={NotFound} />\n    </Switch>\n  );\n}\n\nfunction App() {\n  // Initialize production data on app startup\n  useEffect(() => {\n    initializeProductionData();\n    initializeCleanState();\n  }, []);\n\n  return (\n    <ErrorBoundary>\n      <QueryClientProvider client={queryClient}>\n        <TooltipProvider>\n          <MsalProvider instance={msalInstance}>\n            <AppContent />\n          </MsalProvider>\n          <Toaster />\n          <Confetti />\n        </TooltipProvider>\n      </QueryClientProvider>\n    </ErrorBoundary>\n  );\n}\n\nexport default App;\n","path":null,"size_bytes":8329,"size_tokens":null},"client/src/components/SystemDetailsPanel.tsx":{"content":"import React, { useMemo } from 'react';\nimport { Dialog, DialogContent, DialogHeader, DialogTitle } from '@/components/ui/dialog';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Badge } from '@/components/ui/badge';\nimport { Button } from '@/components/ui/button';\nimport { Progress } from '@/components/ui/progress';\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';\nimport { X, Settings, Users, Clock, AlertCircle, TrendingUp, Droplets, Thermometer, Zap, CheckCircle, XCircle } from 'lucide-react';\nimport { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, BarChart, Bar } from 'recharts';\nimport { GrowingSystem } from '@shared/schema';\nimport { Tray } from '../data/trayTracking';\n\ninterface SystemDetailsPanelProps {\n  systemId: string;\n  systems: GrowingSystem[];\n  trays: Tray[];\n  onClose: () => void;\n}\n\nexport const SystemDetailsPanel: React.FC<SystemDetailsPanelProps> = ({\n  systemId,\n  systems,\n  trays,\n  onClose\n}) => {\n  const system = systems.find(s => s.id.toString() === systemId);\n  \n  if (!system) return null;\n\n  // Mock historical data for past trays\n  const pastTrays = useMemo(() => {\n    const samplePastTrays = [\n      { id: 'T-001', crop: 'Basil', plantedDate: '2025-07-10', harvestedDate: '2025-07-17', success: true, yield: 95 },\n      { id: 'T-002', crop: 'Lettuce', plantedDate: '2025-07-05', harvestedDate: '2025-07-15', success: true, yield: 88 },\n      { id: 'T-003', crop: 'Arugula', plantedDate: '2025-07-08', harvestedDate: '2025-07-16', success: false, yield: 45 },\n      { id: 'T-004', crop: 'Spinach', plantedDate: '2025-07-12', harvestedDate: '2025-07-18', success: true, yield: 92 },\n      { id: 'T-005', crop: 'Kale', plantedDate: '2025-07-06', harvestedDate: '2025-07-14', success: true, yield: 78 },\n    ];\n    return samplePastTrays;\n  }, []);\n\n  // Calculate success rate\n  const successRate = useMemo(() => {\n    if (pastTrays.length === 0) return 0;\n    const successful = pastTrays.filter(tray => tray.success).length;\n    return Math.round((successful / pastTrays.length) * 100);\n  }, [pastTrays]);\n\n  // Mock sensor data over time\n  const sensorData = useMemo(() => {\n    const data = [];\n    for (let i = 0; i < 24; i++) {\n      data.push({\n        time: `${i}:00`,\n        ph: 6.0 + Math.random() * 0.8,\n        ec: 1.5 + Math.random() * 0.8,\n        temperature: 70 + Math.random() * 5,\n      });\n    }\n    return data;\n  }, []);\n\n  // Current system stats\n  const currentStats = useMemo(() => {\n    const totalCapacity = system.configuration?.totalCapacity || 0;\n    const occupancyPercent = totalCapacity > 0 ? Math.round((system.currentOccupancy / totalCapacity) * 100) : 0;\n    \n    return {\n      totalCapacity,\n      occupancyPercent,\n      currentOccupancy: system.currentOccupancy,\n      avgYield: pastTrays.reduce((sum, tray) => sum + tray.yield, 0) / pastTrays.length || 0,\n      totalHarvests: pastTrays.length,\n      successfulHarvests: pastTrays.filter(tray => tray.success).length\n    };\n  }, [system, pastTrays]);\n\n  return (\n    <Dialog open={true} onOpenChange={onClose}>\n      <DialogContent className=\"max-w-6xl max-h-[90vh] overflow-y-auto\">\n        <DialogHeader>\n          <div className=\"flex items-center justify-between\">\n            <DialogTitle className=\"text-xl\">{system.name}</DialogTitle>\n            <Button variant=\"ghost\" size=\"sm\" onClick={onClose}>\n              <X className=\"h-4 w-4\" />\n            </Button>\n          </div>\n        </DialogHeader>\n\n        <div className=\"space-y-6\">\n          {/* System Overview Cards */}\n          <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n            <Card className=\"p-4\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <p className=\"text-sm font-medium text-gray-600\">Capacity</p>\n                  <p className=\"text-2xl font-bold text-gray-900\">{currentStats.currentOccupancy}/{currentStats.totalCapacity}</p>\n                </div>\n                <div className=\"p-2 bg-blue-50 rounded-lg\">\n                  <Settings className=\"w-5 h-5 text-blue-600\" />\n                </div>\n              </div>\n              <div className=\"mt-2\">\n                <Progress value={currentStats.occupancyPercent} className=\"h-2\" />\n                <p className=\"text-xs text-gray-500 mt-1\">{currentStats.occupancyPercent}% occupied</p>\n              </div>\n            </Card>\n\n            <Card className=\"p-4\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <p className=\"text-sm font-medium text-gray-600\">Success Rate</p>\n                  <p className=\"text-2xl font-bold text-green-600\">{successRate}%</p>\n                </div>\n                <div className=\"p-2 bg-green-50 rounded-lg\">\n                  <CheckCircle className=\"w-5 h-5 text-green-600\" />\n                </div>\n              </div>\n              <p className=\"text-xs text-gray-500 mt-1\">{currentStats.successfulHarvests}/{currentStats.totalHarvests} successful</p>\n            </Card>\n\n            <Card className=\"p-4\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <p className=\"text-sm font-medium text-gray-600\">Avg Yield</p>\n                  <p className=\"text-2xl font-bold text-orange-600\">{Math.round(currentStats.avgYield)}%</p>\n                </div>\n                <div className=\"p-2 bg-orange-50 rounded-lg\">\n                  <TrendingUp className=\"w-5 h-5 text-orange-600\" />\n                </div>\n              </div>\n              <p className=\"text-xs text-gray-500 mt-1\">Average harvest yield</p>\n            </Card>\n\n            <Card className=\"p-4\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <p className=\"text-sm font-medium text-gray-600\">Total Harvests</p>\n                  <p className=\"text-2xl font-bold text-purple-600\">{currentStats.totalHarvests}</p>\n                </div>\n                <div className=\"p-2 bg-purple-50 rounded-lg\">\n                  <Clock className=\"w-5 h-5 text-purple-600\" />\n                </div>\n              </div>\n              <p className=\"text-xs text-gray-500 mt-1\">Completed cycles</p>\n            </Card>\n          </div>\n\n          {/* Tabbed Content */}\n          <Tabs defaultValue=\"sensors\" className=\"w-full\">\n            <TabsList className=\"grid w-full grid-cols-3\">\n              <TabsTrigger value=\"sensors\">Sensor Data</TabsTrigger>\n              <TabsTrigger value=\"trays\">Past Trays</TabsTrigger>\n              <TabsTrigger value=\"performance\">Performance</TabsTrigger>\n            </TabsList>\n\n            <TabsContent value=\"sensors\" className=\"space-y-4\">\n              <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n                <Card className=\"p-4\">\n                  <div className=\"flex items-center space-x-2\">\n                    <Droplets className=\"w-5 h-5 text-blue-600\" />\n                    <div>\n                      <p className=\"text-sm font-medium text-gray-600\">pH Level</p>\n                      <p className=\"text-xl font-bold text-blue-600\">6.2</p>\n                      <p className=\"text-xs text-gray-500\">Optimal range: 5.5-6.5</p>\n                    </div>\n                  </div>\n                </Card>\n\n                <Card className=\"p-4\">\n                  <div className=\"flex items-center space-x-2\">\n                    <Zap className=\"w-5 h-5 text-yellow-600\" />\n                    <div>\n                      <p className=\"text-sm font-medium text-gray-600\">EC Level</p>\n                      <p className=\"text-xl font-bold text-yellow-600\">1.8</p>\n                      <p className=\"text-xs text-gray-500\">Optimal range: 1.2-2.0</p>\n                    </div>\n                  </div>\n                </Card>\n\n                <Card className=\"p-4\">\n                  <div className=\"flex items-center space-x-2\">\n                    <Thermometer className=\"w-5 h-5 text-red-600\" />\n                    <div>\n                      <p className=\"text-sm font-medium text-gray-600\">Temperature</p>\n                      <p className=\"text-xl font-bold text-red-600\">72.5¬∞F</p>\n                      <p className=\"text-xs text-gray-500\">Optimal range: 68-75¬∞F</p>\n                    </div>\n                  </div>\n                </Card>\n              </div>\n\n              <Card className=\"p-4\">\n                <CardHeader>\n                  <CardTitle>24-Hour Sensor Readings</CardTitle>\n                </CardHeader>\n                <CardContent>\n                  <div className=\"h-80\">\n                    <ResponsiveContainer width=\"100%\" height=\"100%\">\n                      <LineChart data={sensorData}>\n                        <CartesianGrid strokeDasharray=\"3 3\" />\n                        <XAxis dataKey=\"time\" />\n                        <YAxis />\n                        <Tooltip />\n                        <Line type=\"monotone\" dataKey=\"ph\" stroke=\"#2563eb\" strokeWidth={2} name=\"pH\" />\n                        <Line type=\"monotone\" dataKey=\"ec\" stroke=\"#dc2626\" strokeWidth={2} name=\"EC\" />\n                        <Line type=\"monotone\" dataKey=\"temperature\" stroke=\"#16a34a\" strokeWidth={2} name=\"Temperature\" />\n                      </LineChart>\n                    </ResponsiveContainer>\n                  </div>\n                </CardContent>\n              </Card>\n            </TabsContent>\n\n            <TabsContent value=\"trays\" className=\"space-y-4\">\n              <Card>\n                <CardHeader>\n                  <CardTitle>Recent Tray History</CardTitle>\n                </CardHeader>\n                <CardContent>\n                  <div className=\"space-y-3\">\n                    {pastTrays.map((tray) => (\n                      <div key={tray.id} className=\"flex items-center justify-between p-3 bg-gray-50 rounded-lg\">\n                        <div className=\"flex items-center space-x-3\">\n                          <div className={`p-2 rounded-full ${tray.success ? 'bg-green-100' : 'bg-red-100'}`}>\n                            {tray.success ? \n                              <CheckCircle className=\"w-4 h-4 text-green-600\" /> : \n                              <XCircle className=\"w-4 h-4 text-red-600\" />\n                            }\n                          </div>\n                          <div>\n                            <p className=\"font-medium\">{tray.id} - {tray.crop}</p>\n                            <p className=\"text-sm text-gray-600\">\n                              {tray.plantedDate} ‚Üí {tray.harvestedDate}\n                            </p>\n                          </div>\n                        </div>\n                        <div className=\"text-right\">\n                          <p className=\"font-medium\">{tray.yield}%</p>\n                          <p className=\"text-sm text-gray-600\">Yield</p>\n                        </div>\n                      </div>\n                    ))}\n                  </div>\n                </CardContent>\n              </Card>\n            </TabsContent>\n\n            <TabsContent value=\"performance\" className=\"space-y-4\">\n              <Card>\n                <CardHeader>\n                  <CardTitle>Yield Performance by Crop</CardTitle>\n                </CardHeader>\n                <CardContent>\n                  <div className=\"h-80\">\n                    <ResponsiveContainer width=\"100%\" height=\"100%\">\n                      <BarChart data={pastTrays}>\n                        <CartesianGrid strokeDasharray=\"3 3\" />\n                        <XAxis dataKey=\"crop\" />\n                        <YAxis />\n                        <Tooltip />\n                        <Bar dataKey=\"yield\" fill=\"#10b981\" />\n                      </BarChart>\n                    </ResponsiveContainer>\n                  </div>\n                </CardContent>\n              </Card>\n\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                <Card className=\"p-4\">\n                  <h3 className=\"font-medium mb-2\">Success Analysis</h3>\n                  <div className=\"space-y-2\">\n                    <div className=\"flex justify-between\">\n                      <span className=\"text-sm text-gray-600\">Successful Harvests</span>\n                      <span className=\"font-medium text-green-600\">{currentStats.successfulHarvests}</span>\n                    </div>\n                    <div className=\"flex justify-between\">\n                      <span className=\"text-sm text-gray-600\">Failed Harvests</span>\n                      <span className=\"font-medium text-red-600\">{currentStats.totalHarvests - currentStats.successfulHarvests}</span>\n                    </div>\n                    <div className=\"flex justify-between\">\n                      <span className=\"text-sm text-gray-600\">Success Rate</span>\n                      <span className=\"font-medium\">{successRate}%</span>\n                    </div>\n                  </div>\n                </Card>\n\n                <Card className=\"p-4\">\n                  <h3 className=\"font-medium mb-2\">Optimal Conditions</h3>\n                  <div className=\"space-y-2\">\n                    <div className=\"flex justify-between\">\n                      <span className=\"text-sm text-gray-600\">Best pH Range</span>\n                      <span className=\"font-medium\">5.8-6.4</span>\n                    </div>\n                    <div className=\"flex justify-between\">\n                      <span className=\"text-sm text-gray-600\">Best EC Range</span>\n                      <span className=\"font-medium\">1.6-2.0</span>\n                    </div>\n                    <div className=\"flex justify-between\">\n                      <span className=\"text-sm text-gray-600\">Best Temperature</span>\n                      <span className=\"font-medium\">70-74¬∞F</span>\n                    </div>\n                  </div>\n                </Card>\n              </div>\n            </TabsContent>\n          </Tabs>\n        </div>\n      </DialogContent>\n    </Dialog>\n  );\n};","path":null,"size_bytes":14106,"size_tokens":null},"server/db.ts":{"content":"import { neon, neonConfig } from '@neondatabase/serverless';\nimport { drizzle } from 'drizzle-orm/neon-http';\nimport * as schema from \"@shared/schema\";\n\n// Disable connection caching to prevent stale data issues\nneonConfig.fetchConnectionCache = false;\n\nif (!process.env.DATABASE_URL) {\n  throw new Error(\n    \"DATABASE_URL must be set. Did you forget to provision a database?\",\n  );\n}\n\n// Use HTTP client instead of WebSocket Pool to avoid connection termination issues\nconst sql = neon(process.env.DATABASE_URL);\nexport const db = drizzle(sql, { schema });","path":null,"size_bytes":558,"size_tokens":null},"client/src/components/ui/card.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Card = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\n      \"rounded-lg border bg-card text-card-foreground shadow-sm\",\n      className\n    )}\n    {...props}\n  />\n))\nCard.displayName = \"Card\"\n\nconst CardHeader = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex flex-col space-y-1.5 p-6\", className)}\n    {...props}\n  />\n))\nCardHeader.displayName = \"CardHeader\"\n\nconst CardTitle = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\n      \"text-2xl font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nCardTitle.displayName = \"CardTitle\"\n\nconst CardDescription = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nCardDescription.displayName = \"CardDescription\"\n\nconst CardContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"p-6 pt-0\", className)} {...props} />\n))\nCardContent.displayName = \"CardContent\"\n\nconst CardFooter = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex items-center p-6 pt-0\", className)}\n    {...props}\n  />\n))\nCardFooter.displayName = \"CardFooter\"\n\nexport { Card, CardHeader, CardFooter, CardTitle, CardDescription, CardContent }\n","path":null,"size_bytes":1858,"size_tokens":null},"server/seed.ts":{"content":"import { db } from \"./db\";\nimport { users, tasks, inventoryItems, trainingModules, userProgress, taskLogs } from \"@shared/schema\";\n\nasync function seedDatabase() {\n  console.log(\"Seeding database...\");\n\n  // Clear existing data\n  await db.delete(taskLogs);\n  await db.delete(userProgress);\n  await db.delete(tasks);\n  await db.delete(inventoryItems);\n  await db.delete(trainingModules);\n  await db.delete(users);\n\n  // Create test users\n  // Production launch - no test users, using Microsoft authentication\n\n  // Create sample tasks\n  const sampleTasks = [\n    {\n      title: \"Seed Lettuce Trays\",\n      description: \"Plant lettuce seeds in designated trays\",\n      type: \"seeding\",\n      status: \"in_progress\",\n      priority: \"medium\",\n      assignedTo: createdUsers[0].id,\n      createdBy: createdUsers[1].id,\n      location: \"Section A - Towers 1-5\",\n      estimatedTime: 180,\n      actualTime: null,\n      progress: 60,\n      checklist: [\n        { id: \"1\", text: \"Prepare seed trays\", completed: true },\n        { id: \"2\", text: \"Fill with growing medium\", completed: true },\n        { id: \"3\", text: \"Plant lettuce seeds\", completed: true },\n        { id: \"4\", text: \"Label trays with date\", completed: false },\n        { id: \"5\", text: \"Place in germination area\", completed: false }\n      ],\n      startedAt: new Date(Date.now() - 2 * 60 * 60 * 1000),\n      completedAt: null,\n      dueDate: new Date(Date.now() + 24 * 60 * 60 * 1000),\n      data: {}\n    },\n    {\n      title: \"Harvest Spinach\",\n      description: \"Harvest mature spinach plants\",\n      type: \"harvesting\",\n      status: \"pending\",\n      priority: \"high\",\n      assignedTo: createdUsers[0].id,\n      createdBy: createdUsers[1].id,\n      location: \"Section B - Towers 6-10\",\n      estimatedTime: 150,\n      actualTime: null,\n      progress: 0,\n      checklist: [\n        { id: \"1\", text: \"Check plant maturity\", completed: false },\n        { id: \"2\", text: \"Harvest plants\", completed: false, dataCollection: { type: \"number\", label: \"Weight (lbs)\" } },\n        { id: \"3\", text: \"Clean harvested area\", completed: false }\n      ],\n      startedAt: null,\n      completedAt: null,\n      dueDate: new Date(Date.now() + 24 * 60 * 60 * 1000),\n      data: {}\n    },\n    {\n      title: \"Clean Tower Systems\",\n      description: \"Full sanitization of tower systems\",\n      type: \"cleaning\",\n      status: \"completed\",\n      priority: \"medium\",\n      assignedTo: createdUsers[0].id,\n      createdBy: createdUsers[1].id,\n      location: \"Section C - Full sanitization\",\n      estimatedTime: 120,\n      actualTime: 105,\n      progress: 100,\n      checklist: [\n        { id: \"1\", text: \"Sanitize towers\", completed: true },\n        { id: \"2\", text: \"Clean water systems\", completed: true },\n        { id: \"3\", text: \"Replace filters\", completed: true }\n      ],\n      startedAt: new Date(Date.now() - 3 * 60 * 60 * 1000),\n      completedAt: new Date(Date.now() - 1 * 60 * 60 * 1000),\n      dueDate: new Date(Date.now() + 24 * 60 * 60 * 1000),\n      data: {}\n    },\n    {\n      title: \"Inventory Check - Nutrients\",\n      description: \"Check stock levels and quality of nutrient solutions\",\n      type: \"inventory\",\n      status: \"pending\",\n      priority: \"low\",\n      assignedTo: createdUsers[0].id,\n      createdBy: createdUsers[1].id,\n      location: \"Storage Room A\",\n      estimatedTime: 90,\n      actualTime: null,\n      progress: 0,\n      checklist: [\n        { id: \"1\", text: \"Check nutrient levels\", completed: false, dataCollection: { type: \"number\", label: \"Containers remaining\" } },\n        { id: \"2\", text: \"Inspect for damage\", completed: false },\n        { id: \"3\", text: \"Update inventory records\", completed: false }\n      ],\n      startedAt: null,\n      completedAt: null,\n      dueDate: new Date(Date.now() + 24 * 60 * 60 * 1000),\n      data: {}\n    }\n  ];\n\n  const createdTasks = await db.insert(tasks).values(sampleTasks).returning();\n  console.log(`Created ${createdTasks.length} tasks`);\n\n  // Create sample inventory items\n  const sampleInventory = [\n    { \n      name: \"Lettuce Seeds\", \n      category: \"seeds\", \n      currentStock: 150, \n      minimumStock: 50, \n      unit: \"packets\", \n      supplier: \"Green Thumb Seeds\",\n      lastRestocked: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000)\n    },\n    { \n      name: \"Spinach Seeds\", \n      category: \"seeds\", \n      currentStock: 25, \n      minimumStock: 30, \n      unit: \"packets\", \n      supplier: \"Green Thumb Seeds\",\n      lastRestocked: new Date(Date.now() - 14 * 24 * 60 * 60 * 1000)\n    },\n    { \n      name: \"Nutrient Solution A\", \n      category: \"nutrients\", \n      currentStock: 45, \n      minimumStock: 20, \n      unit: \"liters\", \n      supplier: \"Hydro Nutrients Co\",\n      lastRestocked: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000)\n    },\n    { \n      name: \"Growing Medium\", \n      category: \"supplies\", \n      currentStock: 80, \n      minimumStock: 40, \n      unit: \"kg\", \n      supplier: \"Farm Supply Plus\",\n      lastRestocked: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000)\n    }\n  ];\n\n  const createdInventory = await db.insert(inventoryItems).values(sampleInventory).returning();\n  console.log(`Created ${createdInventory.length} inventory items`);\n\n  // Create sample training modules\n  const sampleModules = [\n    {\n      title: \"Basic Seeding Techniques\",\n      description: \"Learn proper seeding procedures for various crops\",\n      category: \"operations\",\n      content: \"Comprehensive guide to seeding techniques...\",\n      duration: 45,\n      createdBy: createdUsers[2].id,\n      requiredForRole: \"technician\"\n    },\n    {\n      title: \"Safety Protocols\",\n      description: \"Essential safety procedures for farm operations\",\n      category: \"safety\",\n      content: \"Safety guidelines and protocols...\",\n      duration: 30,\n      createdBy: createdUsers[2].id,\n      requiredForRole: \"technician\"\n    },\n    {\n      title: \"Quality Control Standards\",\n      description: \"Maintaining high quality standards in production\",\n      category: \"quality\",\n      content: \"Quality control procedures...\",\n      duration: 60,\n      createdBy: createdUsers[2].id,\n      requiredForRole: \"manager\"\n    }\n  ];\n\n  const createdModules = await db.insert(trainingModules).values(sampleModules).returning();\n  console.log(`Created ${createdModules.length} training modules`);\n\n  console.log(\"Database seeding completed successfully!\");\n}\n\n// Run the seed function\nseedDatabase().catch(console.error);","path":null,"size_bytes":6460,"size_tokens":null},"client/src/App.tsx":{"content":"import { useEffect, useState } from \"react\";\nimport { Switch, Route } from \"wouter\";\nimport { queryClient } from \"./lib/queryClient\";\nimport { QueryClientProvider } from \"@tanstack/react-query\";\nimport { Toaster } from \"@/components/ui/toaster\";\nimport { TooltipProvider } from \"@/components/ui/tooltip\";\nimport Layout from \"@/components/Layout\";\nimport ErrorBoundary from \"@/components/ErrorBoundary\";\nimport { MsalProvider, useIsAuthenticated, useMsal } from \"@azure/msal-react\";\nimport { PublicClientApplication } from \"@azure/msal-browser\";\nimport { msalConfig, isAuthorizedEmail, debugLog, detectIOSEnvironment, testStorageAvailability } from './config/authConfig';\nimport { MicrosoftLogin } from './components/auth/MicrosoftLogin';\nimport { DevLogin } from './components/DevLogin';\nimport { UserProvider } from './contexts/UserContext';\nimport Tasks from \"@/pages/Tasks\";\nimport Inventory from \"@/pages/Inventory\";\nimport Education from \"@/pages/Education\";\nimport Account from \"@/pages/Account\";\nimport DevTools from \"@/pages/DevTools\";\nimport RecurringTasks from \"@/pages/RecurringTasks\";\nimport TaskData from \"@/pages/TaskData\";\nimport StaffData from \"@/pages/StaffData\";\nimport ProductionData from \"@/pages/ProductionData\";\nimport TrayTracking from \"@/pages/TrayTracking\";\nimport NotFound from \"@/pages/not-found\";\nimport Confetti from \"@/components/Confetti\";\nimport { LocationProvider } from \"@/contexts/LocationContext\";\nimport { CurrentUserProvider } from \"@/contexts/CurrentUserContext\";\nimport { initializeProductionData } from \"@/data/initialData\";\nimport { initializeCleanState } from \"@/utils/dataCleanup\";\nimport { createStaffFromMicrosoftLogin, updateLastActive, initializeExpectedStaff } from \"@/services/staffService\";\nimport { useActivityTracking } from \"@/hooks/useActivityTracking\";\nimport { teamsAuthService } from \"./services/teamsAuthService\";\nimport { useLocation } from \"wouter\";\nimport { setStoredAuth, getStoredAuth, clearStoredAuth } from \"@/lib/auth\";\n\nconst msalInstance = new PublicClientApplication(msalConfig);\n\nfunction ProtectedRoute({ children }: { children: React.ReactNode }) {\n  return (\n    <LocationProvider>\n      <CurrentUserProvider>\n        <Layout>{children}</Layout>\n      </CurrentUserProvider>\n    </LocationProvider>\n  );\n}\n\nfunction AppContent() {\n  const isAuthenticated = useIsAuthenticated();\n  const { accounts, instance } = useMsal();\n  const [isLoading, setIsLoading] = useState(true);\n  const [currentUser, setCurrentUser] = useState<any>(null);\n  const [teamsAuthAttempted, setTeamsAuthAttempted] = useState(false);\n  const [, setLocation] = useLocation();\n  \n  // Activity tracking for the current user\n  useActivityTracking(currentUser?.id);\n\n  // Keyboard shortcut for dev tools (Ctrl+Shift+D)\n  useEffect(() => {\n    const handleKeyPress = (e: KeyboardEvent) => {\n      if (e.ctrlKey && e.shiftKey && e.key === 'D' && currentUser?.role === 'Corporate') {\n        e.preventDefault();\n        setLocation('/dev');\n      }\n    };\n    \n    window.addEventListener('keydown', handleKeyPress);\n    return () => window.removeEventListener('keydown', handleKeyPress);\n  }, [setLocation, currentUser]);\n\n  // Window focus verification trigger - respects backend locking and timing\n  useEffect(() => {\n    if (!currentUser || !isAuthenticated) return;\n\n    let lastVerificationCall = 0;\n    const MIN_INTERVAL = 5 * 60 * 1000; // 5 minutes minimum between calls\n    \n    const handleWindowFocus = async () => {\n      const now = Date.now();\n      \n      // Client-side throttling - don't call more than once every 5 minutes\n      if (now - lastVerificationCall < MIN_INTERVAL) {\n        console.log(`‚è≥ Window focus verification skipped - last call was ${Math.round((now - lastVerificationCall) / 1000 / 60)} minutes ago`);\n        return;\n      }\n      \n      try {\n        lastVerificationCall = now;\n        console.log('üîÑ Window focus detected - triggering verification check...');\n        \n        const response = await fetch('/api/system/verify-tasks', {\n          method: 'POST',\n          headers: {\n            'Content-Type': 'application/json',\n          },\n          body: JSON.stringify({ userId: currentUser.id }),\n        });\n        \n        if (response.ok) {\n          const result = await response.json();\n          console.log('‚úÖ Window focus verification completed:', result.message);\n        } else {\n          console.log('‚ö†Ô∏è Window focus verification request failed:', response.status);\n        }\n      } catch (error) {\n        console.log('‚ùå Window focus verification error:', error);\n      }\n    };\n    \n    window.addEventListener('focus', handleWindowFocus);\n    return () => window.removeEventListener('focus', handleWindowFocus);\n  }, [currentUser, isAuthenticated]);\n\n  useEffect(() => {\n    const initializeUser = async () => {\n      // If we already have a user, don't re-initialize\n      if (currentUser) return;\n\n      // Try Teams authentication first if not already attempted\n      if (!teamsAuthAttempted) {\n        setTeamsAuthAttempted(true);\n        console.log(\"Attempting Teams authentication...\");\n        \n        try {\n          const teamsResult = await teamsAuthService.initialize();\n          \n          if (teamsResult.isInTeams && teamsResult.account) {\n            console.log(\"Running in Teams, auto-authenticating user:\", teamsResult.account.name);\n            \n            // Verify email domain\n            if (!isAuthorizedEmail(teamsResult.account.username)) {\n              console.error('Access denied. Only @growspace.farm emails are allowed.');\n              teamsAuthService.notifyFailure('Access denied. Only @growspace.farm emails are allowed.');\n              setIsLoading(false);\n              return;\n            }\n\n            // Process Teams user same as regular MSAL user\n            await processUserLogin(teamsResult.account);\n            teamsAuthService.notifySuccess();\n            return;\n          }\n        } catch (error) {\n          console.log(\"Teams authentication failed, falling back to regular MSAL:\", error);\n        }\n      }\n\n      // Regular MSAL authentication\n      if (isAuthenticated && accounts[0]) {\n        await processUserLogin(accounts[0]);\n      } else {\n        // Check for stored dev-login authentication\n        try {\n          const storedAuth = getStoredAuth();\n          if (storedAuth.isAuthenticated && storedAuth.user) {\n            console.log(\"Found stored dev-login authentication, restoring session...\");\n            await processDevUserLogin(storedAuth.user);\n            return;\n          }\n        } catch (error) {\n          console.error(\"Failed to restore stored authentication:\", error);\n        }\n        \n        setIsLoading(false);\n      }\n    };\n\n    const processDevUserLogin = async (storedUser: any) => {\n      try {\n        console.log('Processing dev-login user from localStorage:', storedUser.name, storedUser.businessEmail);\n        \n        // Create user object for context - convert from stored format\n        const user = {\n          id: storedUser.id.toString(),\n          name: storedUser.name,\n          email: storedUser.businessEmail || storedUser.username,\n          role: storedUser.role === 'corporate' ? 'Corporate' : storedUser.role === 'manager' ? 'Manager' : 'Staff',\n          isManager: storedUser.role === 'manager' || storedUser.role === 'corporate',\n          isCorporateManager: storedUser.role === 'corporate',\n          location: storedUser.location || 'Kenosha'\n        };\n\n        console.log('Initialized dev user:', user.name, user.email, user.role);\n        setCurrentUser(user);\n\n        // Initialize expected staff members if current user is corporate\n        if (user.role === 'Corporate') {\n          try {\n            await initializeExpectedStaff();\n          } catch (error) {\n            console.error('Failed to initialize expected staff:', error);\n          }\n        }\n\n        // Initialize data if needed (disabled to prevent October demo data pollution)\n        // Only initialize if explicitly enabled via environment variable\n        if (import.meta.env.VITE_ENABLE_DEV_SEED === 'true') {\n          try {\n            console.log('üå± Dev seeding enabled - initializing demo data...');\n            await initializeProductionData();\n            await initializeCleanState();\n          } catch (error) {\n            console.error('Failed to initialize production data:', error);\n          }\n        } else {\n          console.log('üö´ Dev seeding disabled - skipping demo data initialization');\n        }\n      } catch (error) {\n        console.error('Error processing dev user login:', error);\n        // Clear invalid stored auth and show login screen\n        clearStoredAuth();\n      } finally {\n        setIsLoading(false);\n      }\n    };\n\n    const processUserLogin = async (account: any) => {\n      try {\n        // Verify email domain for regular MSAL (Teams already verified above)\n        if (!isAuthorizedEmail(account.username)) {\n          alert('Access denied. Only @growspace.farm emails are allowed.');\n          if (instance) {\n            await instance.logoutPopup();\n          }\n          setIsLoading(false);\n          return;\n        }\n\n        // Create or update staff entry automatically\n        const staffMember = await createStaffFromMicrosoftLogin(\n          account.localAccountId || account.homeAccountId || '',\n          account.name || 'User',\n          account.username\n        );\n\n        // Determine role based on staff member\n        let role: 'Staff' | 'Manager' | 'Corporate' = 'Staff';\n        let isManager = false;\n        let isCorporateManager = false;\n\n        if (staffMember.rolesAssigned.includes('Corporate Manager')) {\n          role = 'Corporate';\n          isManager = true;\n          isCorporateManager = true;\n        } else if (staffMember.rolesAssigned.includes('Manager')) {\n          role = 'Manager';\n          isManager = true;\n        }\n\n        // Create user object for context\n        const user = {\n          id: staffMember.id,\n          name: staffMember.fullName,\n          email: staffMember.email,\n          role,\n          isManager,\n          isCorporateManager,\n          location: staffMember.location\n        };\n\n        console.log('Initialized user:', user.name, user.email, user.role);\n        setCurrentUser(user);\n        \n        // Store in localStorage for getStoredAuth()\n        setStoredAuth({\n          id: parseInt(staffMember.id),\n          username: staffMember.email,\n          password: '', // Not needed for client-side auth with SSO\n          name: staffMember.fullName,\n          role: role.toLowerCase() as 'staff' | 'manager' | 'corporate',\n          approved: true, // SSO users are pre-approved\n          location: staffMember.location,\n          payType: 'hourly',\n          payRate: 16.00,\n          businessEmail: staffMember.email,\n          personalEmail: null,\n          homePhone: null,\n          businessPhone: null,\n          mobilePhone: null,\n          emergencyContactName: null,\n          emergencyRelationship: null,\n          emergencyPhone: null,\n          lastActive: null,\n          createdAt: new Date()\n        });\n\n        // Initialize expected staff members if current user is corporate\n        if (role === 'Corporate') {\n          try {\n            await initializeExpectedStaff();\n          } catch (error) {\n            console.error('Failed to initialize expected staff:', error);\n          }\n        }\n\n        // Initialize data if needed (disabled to prevent October demo data pollution)\n        // Only initialize if explicitly enabled via environment variable\n        if (import.meta.env.VITE_ENABLE_DEV_SEED === 'true') {\n          try {\n            console.log('üå± Dev seeding enabled - initializing demo data...');\n            await initializeProductionData();\n            await initializeCleanState();\n          } catch (error) {\n            console.error('Failed to initialize production data:', error);\n          }\n        } else {\n          console.log('üö´ Dev seeding disabled - skipping demo data initialization');\n        }\n      } catch (error) {\n        console.error('Error processing user login:', error);\n      } finally {\n        setIsLoading(false);\n      }\n    };\n\n    initializeUser();\n  }, [isAuthenticated, accounts, instance, currentUser, teamsAuthAttempted]);\n\n  if (isLoading) {\n    return (\n      <div className=\"loading-screen\">\n        <h2>üå± Loading Grow Space...</h2>\n      </div>\n    );\n  }\n\n  if (!isAuthenticated && !currentUser) {\n    return (\n      <div className=\"min-h-screen bg-gradient-to-br from-green-50 to-blue-50 dark:from-gray-900 dark:to-gray-800 flex items-center justify-center p-4\">\n        <div className=\"space-y-6 w-full max-w-md\">\n          <div className=\"text-center space-y-2\">\n            <h1 className=\"text-3xl font-bold text-gray-900 dark:text-gray-100\">üå± Grow Space</h1>\n            <p className=\"text-gray-600 dark:text-gray-400\">Farm Management System</p>\n          </div>\n          \n          {/* Development Login - Show first for easier access */}\n          <DevLogin onSuccess={() => {}} />\n          \n          <div className=\"relative\">\n            <div className=\"absolute inset-0 flex items-center\">\n              <span className=\"w-full border-t\" />\n            </div>\n            <div className=\"relative flex justify-center text-xs uppercase\">\n              <span className=\"bg-background px-2 text-muted-foreground\">Or</span>\n            </div>\n          </div>\n          \n          {/* Microsoft Login */}\n          <div className=\"bg-white dark:bg-gray-800 rounded-lg p-6 shadow-lg\">\n            <h3 className=\"text-lg font-semibold mb-4 text-center\">Microsoft Authentication</h3>\n            <MicrosoftLogin />\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  if (!currentUser) {\n    return <div className=\"loading-screen\">Setting up your account...</div>;\n  }\n\n  return (\n    <UserProvider value={{ currentUser, setCurrentUser }}>\n      <Router />\n    </UserProvider>\n  );\n}\n\nfunction Router() {\n  return (\n    <Switch>\n      <Route path=\"/\">\n        <ProtectedRoute>\n          <Tasks />\n        </ProtectedRoute>\n      </Route>\n      <Route path=\"/tasks\">\n        <ProtectedRoute>\n          <Tasks />\n        </ProtectedRoute>\n      </Route>\n      <Route path=\"/inventory\">\n        <ProtectedRoute>\n          <Inventory />\n        </ProtectedRoute>\n      </Route>\n      <Route path=\"/education\">\n        <ProtectedRoute>\n          <Education />\n        </ProtectedRoute>\n      </Route>\n      <Route path=\"/account\">\n        <ProtectedRoute>\n          <Account />\n        </ProtectedRoute>\n      </Route>\n      <Route path=\"/recurring-tasks\">\n        <ProtectedRoute>\n          <RecurringTasks />\n        </ProtectedRoute>\n      </Route>\n      <Route path=\"/recurring\">\n        <ProtectedRoute>\n          <RecurringTasks />\n        </ProtectedRoute>\n      </Route>\n      <Route path=\"/task-data\">\n        <ProtectedRoute>\n          <TaskData />\n        </ProtectedRoute>\n      </Route>\n      <Route path=\"/staff-data\">\n        <ProtectedRoute>\n          <StaffData />\n        </ProtectedRoute>\n      </Route>\n      <Route path=\"/production-data\">\n        <ProtectedRoute>\n          <ProductionData />\n        </ProtectedRoute>\n      </Route>\n      <Route path=\"/tray-tracking\">\n        <ProtectedRoute>\n          <TrayTracking />\n        </ProtectedRoute>\n      </Route>\n      <Route path=\"/dev\">\n        <ProtectedRoute>\n          <DevTools />\n        </ProtectedRoute>\n      </Route>\n      <Route>\n        <ProtectedRoute>\n          <NotFound />\n        </ProtectedRoute>\n      </Route>\n    </Switch>\n  );\n}\n\nfunction App() {\n  return (\n    <MsalProvider instance={msalInstance}>\n      <QueryClientProvider client={queryClient}>\n        <TooltipProvider>\n          <ErrorBoundary>\n            <AppContent />\n            <Toaster />\n            <Confetti />\n          </ErrorBoundary>\n        </TooltipProvider>\n      </QueryClientProvider>\n    </MsalProvider>\n  );\n}\n\nexport default App;","path":null,"size_bytes":16070,"size_tokens":null},"client/src/components/LocationSelector.tsx":{"content":"import React, { useState } from 'react';\nimport { Button } from '@/components/ui/button';\nimport { Card, CardContent } from '@/components/ui/card';\nimport { Badge } from '@/components/ui/badge';\nimport { MapPin, ChevronDown, Check } from 'lucide-react';\nimport { useLocation } from '../contexts/LocationContext';\n\nexport const LocationSelector: React.FC = () => {\n  const { \n    currentLocation, \n    availableLocations, \n    switchLocation, \n    canSwitchLocations,\n    viewMode,\n    setViewMode,\n    isViewingAllLocations \n  } = useLocation();\n  \n  const [showLocationMenu, setShowLocationMenu] = useState(false);\n  \n  if (!canSwitchLocations) {\n    return (\n      <div className=\"flex items-center space-x-2 px-4 py-2 bg-gray-100 rounded-lg\">\n        <MapPin className=\"h-4 w-4 text-gray-500\" />\n        <span className=\"text-sm font-medium text-gray-700\">{currentLocation.name}</span>\n      </div>\n    );\n  }\n  \n  return (\n    <div className=\"relative\">\n      <Button\n        variant=\"outline\"\n        onClick={() => setShowLocationMenu(!showLocationMenu)}\n        className=\"flex items-center space-x-2 min-w-40 bg-white border-gray-300 hover:bg-gray-50\"\n      >\n        <MapPin className=\"h-4 w-4 text-green-600\" />\n        <span className=\"flex-1 text-left text-gray-700\">\n          {isViewingAllLocations ? 'All Locations' : currentLocation.name}\n        </span>\n        <ChevronDown className=\"h-4 w-4 text-gray-400\" />\n      </Button>\n      \n      {showLocationMenu && (\n        <Card className=\"absolute top-full mt-2 right-0 w-80 z-50 shadow-lg border border-gray-200\">\n          <CardContent className=\"p-0\">\n            <div className=\"p-4 border-b border-gray-200\">\n              <h4 className=\"font-semibold text-sm text-gray-900\">Select Location</h4>\n            </div>\n            \n            {/* View Mode Toggle for Corporate */}\n            <div className=\"p-4 border-b bg-gray-50\">\n              <div className=\"space-y-2\">\n                <label className=\"flex items-center space-x-2 cursor-pointer\">\n                  <input\n                    type=\"radio\"\n                    name=\"viewMode\"\n                    value=\"single\"\n                    checked={viewMode === 'single'}\n                    onChange={() => setViewMode('single')}\n                    className=\"text-green-600\"\n                  />\n                  <span className=\"text-sm\">Single Location</span>\n                </label>\n                <label className=\"flex items-center space-x-2 cursor-pointer\">\n                  <input\n                    type=\"radio\"\n                    name=\"viewMode\"\n                    value=\"all\"\n                    checked={viewMode === 'all'}\n                    onChange={() => {\n                      setViewMode('all');\n                      setShowLocationMenu(false);\n                    }}\n                    className=\"text-green-600\"\n                  />\n                  <span className=\"text-sm\">All Locations</span>\n                </label>\n              </div>\n            </div>\n            \n            {viewMode === 'single' && (\n              <div className=\"max-h-64 overflow-y-auto\">\n                {availableLocations.map(location => (\n                  <button\n                    key={location.id}\n                    className={`w-full p-4 text-left hover:bg-gray-50 flex items-center justify-between ${\n                      currentLocation.id === location.id ? 'bg-green-50' : ''\n                    }`}\n                    onClick={() => {\n                      switchLocation(location.id);\n                      setShowLocationMenu(false);\n                    }}\n                  >\n                    <div className=\"flex-1\">\n                      <div className=\"flex items-center space-x-2\">\n                        <span className=\"font-medium\">{location.name}</span>\n                        <Badge variant=\"outline\" className=\"text-xs\">\n                          {location.code}\n                        </Badge>\n                      </div>\n                      {location.address && (\n                        <p className=\"text-xs text-gray-500 mt-1\">{location.address}</p>\n                      )}\n                    </div>\n                    {currentLocation.id === location.id && (\n                      <Check className=\"h-4 w-4 text-green-600\" />\n                    )}\n                  </button>\n                ))}\n              </div>\n            )}\n          </CardContent>\n        </Card>\n      )}\n    </div>\n  );\n};","path":null,"size_bytes":4502,"size_tokens":null},"client/src/components/ChecklistBuilder.tsx":{"content":"import React, { useState } from 'react';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { Label } from '@/components/ui/label';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { Checkbox } from '@/components/ui/checkbox';\nimport { Textarea } from '@/components/ui/textarea';\nimport { Plus, Trash2, ChevronUp, ChevronDown, FileText, CheckSquare, Hash, Package, Building, BarChart3, Camera, Split, ArrowRight, Edit3, PlusCircle } from 'lucide-react';\nimport { GrowingSystem } from '@shared/schema';\n\ninterface ChecklistStep {\n  id: string;\n  type: string;\n  label: string;\n  required: boolean;\n  config: any;\n}\n\ninterface ChecklistTemplate {\n  steps: ChecklistStep[];\n}\n\ninterface ChecklistBuilderProps {\n  template: ChecklistTemplate | null;\n  systems: GrowingSystem[];\n  onChange: (steps: ChecklistStep[]) => void;\n}\n\nconst ChecklistBuilder: React.FC<ChecklistBuilderProps> = ({ template, systems, onChange }) => {\n  const [steps, setSteps] = useState<ChecklistStep[]>(template?.steps || []);\n  const [showAddStep, setShowAddStep] = useState(false);\n  const [availableSeeds, setAvailableSeeds] = useState<any[]>([]);\n\n  const stepTypes = [\n    { value: 'instruction', label: 'Text Instruction', icon: FileText, description: 'Display read-only information or instructions' },\n    { value: 'checkbox', label: 'Simple Checkbox', icon: CheckSquare, description: 'Simple yes/no or completion checkbox' },\n    { value: 'number-input', label: 'Number Input', icon: Hash, description: 'Numeric input with validation and units' },\n    { value: 'inventory-select', label: 'Inventory Selection', icon: Package, description: 'Select and track inventory usage' },\n    { value: 'system-assignment', label: 'System Assignment', icon: Building, description: 'Assign tasks to growing systems' },\n    { value: 'data-capture', label: 'Data Collection', icon: BarChart3, description: 'Collect measurements like pH, EC, temperature' },\n    { value: 'photo', label: 'Photo Upload', icon: Camera, description: 'Capture photos for documentation' },\n    { value: 'tray-split', label: 'Tray Split', icon: Split, description: 'Split trays into multiple new trays' },\n    { value: 'movement-trigger', label: 'Movement Trigger', icon: ArrowRight, description: 'Move trays between locations/systems' },\n    { value: 'edit-tray', label: 'Edit Tray', icon: Edit3, description: 'Update existing tray information' },\n    { value: 'create-tray', label: 'Create Tray', icon: PlusCircle, description: 'Create new trays with specifications' }\n  ];\n\n  // Load available seeds from inventory\n  React.useEffect(() => {\n    const loadSeeds = async () => {\n      try {\n        const response = await fetch('/api/inventory');\n        const inventory = await response.json();\n        \n        // Filter to only seed items\n        const seeds = inventory.filter((item: any) => \n          item.category === 'Seeds' || \n          item.category === 'seeds' || \n          (item.name && item.name.toLowerCase().includes('seed'))\n        );\n        \n        console.log('Available seeds loaded:', seeds);\n        setAvailableSeeds(seeds);\n      } catch (error) {\n        console.error('Failed to load seeds from inventory:', error);\n        // Fallback to localStorage if API fails\n        const localInventory = JSON.parse(localStorage.getItem('inventory') || '[]');\n        const seeds = localInventory.filter((item: any) => \n          item.category === 'Seeds' || \n          item.category === 'seeds' || \n          (item.name && item.name.toLowerCase().includes('seed'))\n        );\n        setAvailableSeeds(seeds);\n      }\n    };\n\n    loadSeeds();\n\n    // Listen for inventory updates\n    const handleInventoryUpdate = () => loadSeeds();\n    window.addEventListener('inventoryUpdated', handleInventoryUpdate);\n    \n    return () => {\n      window.removeEventListener('inventoryUpdated', handleInventoryUpdate);\n    };\n  }, []);\n\n  const getDefaultConfig = (type: string) => {\n    switch (type) {\n      case 'instruction':\n        return { text: '' };\n      case 'number-input':\n        return { min: 0, max: 100, unit: '', default: 0 };\n      case 'inventory-select':\n        return { \n          inventoryItemId: '', \n          inventoryItemName: '', \n          inventoryUnit: '', \n          customText: '', \n          defaultQuantity: '' \n        };\n      case 'system-assignment':\n        return { systemType: '', autoSuggest: true };\n      case 'data-capture':\n        return { dataType: 'number', calculation: '' };\n      case 'tray-split':\n        return { allowCustomSplit: true, defaultSplits: 2 };\n      case 'movement-trigger':\n        return { fromSystem: '', toSystem: '', automatic: false };\n      case 'edit-tray':\n        return { trayId: '', location: '', crop: '', seedDate: '', expectedHarvest: '', notes: '' };\n      case 'create-tray':\n        return { \n          numberOfTrays: 1, \n          defaultTrayType: 'LG',\n          defaultInstance: 1,\n          defaultGrowingMedium: '',\n          defaultTotalSlots: 0,\n          defaultVarieties: [],\n          instructions: ''\n        };\n      default:\n        return {};\n    }\n  };\n\n  const addStep = (type: string) => {\n    const newStep: ChecklistStep = {\n      id: Date.now().toString(),\n      type,\n      label: '',\n      required: true,\n      config: getDefaultConfig(type)\n    };\n    \n    const newSteps = [...steps, newStep];\n    setSteps(newSteps);\n    onChange(newSteps);\n    setShowAddStep(false);\n  };\n\n  const updateStep = (index: number, updatedStep: ChecklistStep) => {\n    const newSteps = [...steps];\n    newSteps[index] = updatedStep;\n    setSteps(newSteps);\n    onChange(newSteps);\n  };\n\n  const deleteStep = (index: number) => {\n    const newSteps = steps.filter((_, i) => i !== index);\n    setSteps(newSteps);\n    onChange(newSteps);\n  };\n\n  const moveStep = (index: number, direction: 'up' | 'down') => {\n    const newSteps = [...steps];\n    const targetIndex = direction === 'up' ? index - 1 : index + 1;\n    \n    if (targetIndex >= 0 && targetIndex < steps.length) {\n      [newSteps[index], newSteps[targetIndex]] = [newSteps[targetIndex], newSteps[index]];\n      setSteps(newSteps);\n      onChange(newSteps);\n    }\n  };\n\n  return (\n    <div className=\"space-y-4\">\n      <div className=\"flex items-center justify-between\">\n        <h3 className=\"text-lg font-semibold\">Checklist Steps</h3>\n        <span className=\"text-sm text-gray-500\">{steps.length} steps</span>\n      </div>\n\n      <div className=\"space-y-3\">\n        {steps.map((step, index) => (\n          <ChecklistStepEditor\n            key={step.id}\n            step={step}\n            index={index}\n            systems={systems}\n            availableSeeds={availableSeeds}\n            onUpdate={(updatedStep) => updateStep(index, updatedStep)}\n            onDelete={() => deleteStep(index)}\n            onMoveUp={index > 0 ? () => moveStep(index, 'up') : undefined}\n            onMoveDown={index < steps.length - 1 ? () => moveStep(index, 'down') : undefined}\n          />\n        ))}\n      </div>\n\n      {showAddStep ? (\n        <Card>\n          <CardHeader>\n            <CardTitle>Select Step Type</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3\">\n              {stepTypes.map(type => {\n                const Icon = type.icon;\n                return (\n                  <Button\n                    key={type.value}\n                    variant=\"outline\"\n                    className=\"h-auto p-4 flex flex-col items-center gap-2 hover:bg-gray-50\"\n                    onClick={() => addStep(type.value)}\n                  >\n                    <Icon className=\"w-6 h-6 text-gray-600\" />\n                    <div className=\"text-center\">\n                      <span className=\"text-sm font-medium\">{type.label}</span>\n                      <p className=\"text-xs text-gray-500 mt-1\">{type.description}</p>\n                    </div>\n                  </Button>\n                );\n              })}\n            </div>\n            <div className=\"flex justify-end mt-4\">\n              <Button variant=\"outline\" onClick={() => setShowAddStep(false)}>\n                Cancel\n              </Button>\n            </div>\n          </CardContent>\n        </Card>\n      ) : (\n        <Button\n          onClick={() => setShowAddStep(true)}\n          className=\"w-full border-2 border-dashed border-gray-300 hover:border-gray-400\"\n          variant=\"outline\"\n        >\n          <Plus className=\"w-4 h-4 mr-2\" />\n          Add Step\n        </Button>\n      )}\n    </div>\n  );\n};\n\ninterface ChecklistStepEditorProps {\n  step: ChecklistStep;\n  index: number;\n  systems: GrowingSystem[];\n  availableSeeds: any[];\n  onUpdate: (step: ChecklistStep) => void;\n  onDelete: () => void;\n  onMoveUp?: () => void;\n  onMoveDown?: () => void;\n}\n\nconst ChecklistStepEditor: React.FC<ChecklistStepEditorProps> = ({\n  step,\n  index,\n  systems,\n  availableSeeds,\n  onUpdate,\n  onDelete,\n  onMoveUp,\n  onMoveDown\n}) => {\n  const [expanded, setExpanded] = useState(true);\n\n  const getStepIcon = (type: string) => {\n    const icons = {\n      instruction: FileText,\n      checkbox: CheckSquare,\n      'number-input': Hash,\n      'inventory-select': Package,\n      'system-assignment': Building,\n      'data-capture': BarChart3,\n      photo: Camera,\n      'tray-split': Split,\n      'movement-trigger': ArrowRight,\n      'edit-tray': Edit3,\n      'create-tray': PlusCircle\n    };\n    return icons[type as keyof typeof icons] || FileText;\n  };\n\n  const getStepTypeInfo = (type: string) => {\n    const stepTypes = [\n      { value: 'instruction', label: 'Text Instruction', description: 'Display read-only information or instructions' },\n      { value: 'checkbox', label: 'Simple Checkbox', description: 'Simple yes/no or completion checkbox' },\n      { value: 'number-input', label: 'Number Input', description: 'Numeric input with validation and units' },\n      { value: 'inventory-select', label: 'Inventory Selection', description: 'Select and track inventory usage' },\n      { value: 'system-assignment', label: 'System Assignment', description: 'Assign tasks to growing systems' },\n      { value: 'data-capture', label: 'Data Collection', description: 'Collect measurements like pH, EC, temperature' },\n      { value: 'photo', label: 'Photo Upload', description: 'Capture photos for documentation' },\n      { value: 'tray-split', label: 'Tray Split', description: 'Split trays into multiple new trays' },\n      { value: 'movement-trigger', label: 'Movement Trigger', description: 'Move trays between locations/systems' },\n      { value: 'edit-tray', label: 'Edit Tray', description: 'Update existing tray information' },\n      { value: 'create-tray', label: 'Create Tray', description: 'Create new trays with specifications' }\n    ];\n    return stepTypes.find(t => t.value === type);\n  };\n\n  const StepIcon = getStepIcon(step.type);\n  const stepTypeInfo = getStepTypeInfo(step.type);\n\n  return (\n    <Card>\n      <CardHeader className=\"pb-3\">\n        <div className=\"flex items-center justify-between\">\n          <div className=\"flex items-center gap-3 flex-1\">\n            <div className=\"flex items-center justify-center w-8 h-8 bg-green-100 text-green-700 rounded-full text-sm font-medium\">\n              {index + 1}\n            </div>\n            <StepIcon className=\"w-5 h-5 text-gray-600\" />\n            <div className=\"flex-1\">\n              <div className=\"flex flex-col\">\n                <span className=\"text-sm font-medium text-gray-900\">\n                  {stepTypeInfo?.label || step.type}\n                </span>\n                <span className=\"text-xs text-gray-500\">{stepTypeInfo?.description}</span>\n              </div>\n            </div>\n            <Button\n              variant=\"ghost\"\n              size=\"sm\"\n              onClick={() => setExpanded(!expanded)}\n              className=\"text-gray-500\"\n            >\n              {expanded ? '‚ñº' : '‚ñ∂'}\n            </Button>\n          </div>\n          <div className=\"flex items-center gap-1\">\n            {onMoveUp && (\n              <Button variant=\"ghost\" size=\"sm\" onClick={onMoveUp}>\n                <ChevronUp className=\"w-4 h-4\" />\n              </Button>\n            )}\n            {onMoveDown && (\n              <Button variant=\"ghost\" size=\"sm\" onClick={onMoveDown}>\n                <ChevronDown className=\"w-4 h-4\" />\n              </Button>\n            )}\n            <Button\n              variant=\"ghost\"\n              size=\"sm\"\n              onClick={onDelete}\n              className=\"text-red-600 hover:text-red-700\"\n            >\n              <Trash2 className=\"w-4 h-4\" />\n            </Button>\n          </div>\n        </div>\n      </CardHeader>\n\n      {expanded && (\n        <CardContent className=\"pt-0\">\n          <div className=\"space-y-4\">\n            {/* Step Label Input */}\n            <div className=\"space-y-2\">\n              <Label className=\"text-sm font-medium\">Step Label</Label>\n              <Input\n                value={step.label}\n                onChange={(e) => onUpdate({ ...step, label: e.target.value })}\n                placeholder={`Enter ${step.type.replace('-', ' ')} label...`}\n              />\n            </div>\n\n            <div className=\"flex items-center space-x-2\">\n              <Checkbox\n                id={`required-${step.id}`}\n                checked={step.required}\n                onCheckedChange={(checked) => onUpdate({ ...step, required: !!checked })}\n              />\n              <Label htmlFor={`required-${step.id}`}>Required step</Label>\n            </div>\n\n            {/* Type-specific configuration */}\n            {step.type === 'instruction' && (\n              <div className=\"space-y-2\">\n                <Label className=\"text-sm font-medium\">Instruction Text</Label>\n                <Textarea\n                  value={step.config.text || ''}\n                  onChange={(e) => onUpdate({\n                    ...step,\n                    config: { ...step.config, text: e.target.value }\n                  })}\n                  placeholder=\"Enter detailed instructions...\"\n                  rows={3}\n                />\n              </div>\n            )}\n\n            {step.type === 'number-input' && (\n              <div className=\"space-y-3\">\n                <div className=\"grid grid-cols-3 gap-3\">\n                  <div>\n                    <Label>Min Value</Label>\n                    <Input\n                      type=\"number\"\n                      value={step.config.min || ''}\n                      onChange={(e) => onUpdate({\n                        ...step,\n                        config: { ...step.config, min: parseInt(e.target.value) || 0 }\n                      })}\n                    />\n                  </div>\n                  <div>\n                    <Label>Max Value</Label>\n                    <Input\n                      type=\"number\"\n                      value={step.config.max || ''}\n                      onChange={(e) => onUpdate({\n                        ...step,\n                        config: { ...step.config, max: parseInt(e.target.value) || 100 }\n                      })}\n                    />\n                  </div>\n                  <div>\n                    <Label>Unit</Label>\n                    <Input\n                      type=\"text\"\n                      value={step.config.unit || ''}\n                      onChange={(e) => onUpdate({\n                        ...step,\n                        config: { ...step.config, unit: e.target.value }\n                      })}\n                      placeholder=\"e.g., trays, oz, plants\"\n                    />\n                  </div>\n                </div>\n              </div>\n            )}\n\n            {step.type === 'inventory-select' && (\n              <div className=\"space-y-4\">\n                <div className=\"p-4 bg-blue-50 rounded-lg\">\n                  <h4 className=\"font-medium text-blue-900 mb-3\">Inventory Usage Step Configuration</h4>\n                  \n                  {/* Input 1: What inventory item */}\n                  <div className=\"space-y-2 mb-4\">\n                    <Label className=\"text-sm font-medium\">1. What inventory item will be used?</Label>\n                    <Select\n                      value={step.config.inventoryItemId || ''}\n                      onValueChange={(value) => {\n                        const inventoryItems = [\n                          { id: '1', name: 'RO Water', unit: 'gallons' },\n                          { id: '2', name: 'pH Down', unit: 'ml' },\n                          { id: '3', name: 'pH Up', unit: 'ml' },\n                          { id: '4', name: 'Nutrients Part A', unit: 'ml' },\n                          { id: '5', name: 'Nutrients Part B', unit: 'ml' },\n                          { id: '6', name: 'Rockwool Cubes', unit: 'cubes' },\n                          { id: '7', name: 'Romaine Seeds', unit: 'seeds' },\n                          { id: '8', name: 'Buttercrunch Seeds', unit: 'seeds' },\n                          { id: '9', name: 'Arugula Seeds', unit: 'seeds' },\n                          { id: '10', name: 'Basil Seeds', unit: 'seeds' }\n                        ];\n                        const item = inventoryItems.find(i => i.id === value);\n                        const updatedStep = {\n                          ...step,\n                          config: { \n                            ...step.config, \n                            inventoryItemId: value,\n                            inventoryItemName: item?.name || '',\n                            inventoryUnit: item?.unit || ''\n                          }\n                        };\n                        console.log('Updating inventory item:', item?.name, 'with config:', updatedStep.config);\n                        onUpdate(updatedStep);\n                      }}\n                    >\n                      <SelectTrigger>\n                        <SelectValue placeholder=\"Select inventory item...\" />\n                      </SelectTrigger>\n                      <SelectContent>\n                        <SelectItem value=\"1\">RO Water (gallons)</SelectItem>\n                        <SelectItem value=\"2\">pH Down (ml)</SelectItem>\n                        <SelectItem value=\"3\">pH Up (ml)</SelectItem>\n                        <SelectItem value=\"4\">Nutrients Part A (ml)</SelectItem>\n                        <SelectItem value=\"5\">Nutrients Part B (ml)</SelectItem>\n                        <SelectItem value=\"6\">Rockwool Cubes (cubes)</SelectItem>\n                        <SelectItem value=\"7\">Romaine Seeds (seeds)</SelectItem>\n                        <SelectItem value=\"8\">Buttercrunch Seeds (seeds)</SelectItem>\n                        <SelectItem value=\"9\">Arugula Seeds (seeds)</SelectItem>\n                        <SelectItem value=\"10\">Basil Seeds (seeds)</SelectItem>\n                      </SelectContent>\n                    </Select>\n                  </div>\n\n                  {/* Input 2: Custom text/question */}\n                  <div className=\"space-y-2 mb-4\">\n                    <Label className=\"text-sm font-medium\">2. What text should appear for this step?</Label>\n                    <Input\n                      type=\"text\"\n                      value={step.config.customText || ''}\n                      onChange={(e) => {\n                        const updatedStep = {\n                          ...step,\n                          config: { ...step.config, customText: e.target.value }\n                        };\n                        console.log('Updating custom text:', e.target.value);\n                        onUpdate(updatedStep);\n                      }}\n                      placeholder=\"e.g., How much RO water did you use?\"\n                    />\n                    <p className=\"text-xs text-gray-600\">This is what the user will see when completing the task</p>\n                  </div>\n\n                  {/* Input 3: Default quantity (optional) */}\n                  <div className=\"space-y-2\">\n                    <Label className=\"text-sm font-medium\">3. Default quantity (optional)</Label>\n                    <div className=\"flex items-center space-x-2\">\n                      <Input\n                        type=\"number\"\n                        value={step.config.defaultQuantity || ''}\n                        onChange={(e) => {\n                          const updatedStep = {\n                            ...step,\n                            config: { ...step.config, defaultQuantity: e.target.value }\n                          };\n                          console.log('Updating default quantity:', e.target.value);\n                          onUpdate(updatedStep);\n                        }}\n                        placeholder=\"e.g., 2.5\"\n                        step=\"0.1\"\n                        min=\"0\"\n                        className=\"w-32\"\n                      />\n                      {step.config.inventoryUnit && (\n                        <span className=\"text-sm text-gray-600\">{step.config.inventoryUnit}</span>\n                      )}\n                    </div>\n                    <p className=\"text-xs text-gray-600\">Pre-fills this amount to save time during task completion</p>\n                  </div>\n\n                  {step.config.inventoryItemName && (\n                    <div className=\"mt-3 p-2 bg-white rounded border\">\n                      <p className=\"text-sm text-gray-700\">\n                        <strong>Preview:</strong> {step.config.customText || step.label} \n                        <span className=\"text-gray-500\"> (tracking {step.config.inventoryItemName}\n                        {step.config.defaultQuantity && ` - default: ${step.config.defaultQuantity} ${step.config.inventoryUnit}`})</span>\n                      </p>\n                    </div>\n                  )}\n                </div>\n              </div>\n            )}\n\n            {step.type === 'data-capture' && (\n              <div className=\"space-y-3\">\n                <div>\n                  <Label>Data Type</Label>\n                  <Select\n                    value={step.config.dataType || 'number'}\n                    onValueChange={(value) => onUpdate({\n                      ...step,\n                      config: { ...step.config, dataType: value }\n                    })}\n                  >\n                    <SelectTrigger>\n                      <SelectValue />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"number\">Number</SelectItem>\n                      <SelectItem value=\"ph\">pH Level</SelectItem>\n                      <SelectItem value=\"ec\">EC Level</SelectItem>\n                      <SelectItem value=\"temperature\">Temperature</SelectItem>\n                      <SelectItem value=\"humidity\">Humidity</SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n              </div>\n            )}\n\n            {step.type === 'photo' && (\n              <div className=\"space-y-2\">\n                <Label className=\"text-sm font-medium\">Photo Requirements</Label>\n                <p className=\"text-sm text-gray-600\">Users will be able to capture photos using their device camera or upload from files.</p>\n                <div className=\"flex items-center space-x-2\">\n                  <Checkbox\n                    id={`multiple-photos-${step.id}`}\n                    checked={step.config.allowMultiple || false}\n                    onCheckedChange={(checked) => onUpdate({\n                      ...step,\n                      config: { ...step.config, allowMultiple: !!checked }\n                    })}\n                  />\n                  <Label htmlFor={`multiple-photos-${step.id}`}>Allow multiple photos</Label>\n                </div>\n              </div>\n            )}\n\n            {step.type === 'edit-tray' && (\n              <div className=\"space-y-3\">\n                <Label className=\"text-sm font-medium\">Edit Tray Configuration</Label>\n                <p className=\"text-sm text-gray-600\">Users will be able to update existing tray information including location, crop stage, and notes.</p>\n                <div className=\"grid grid-cols-2 gap-3\">\n                  <div className=\"flex items-center space-x-2\">\n                    <Checkbox\n                      id={`allow-location-${step.id}`}\n                      checked={step.config.allowLocation !== false}\n                      onCheckedChange={(checked) => onUpdate({\n                        ...step,\n                        config: { ...step.config, allowLocation: !!checked }\n                      })}\n                    />\n                    <Label htmlFor={`allow-location-${step.id}`}>Allow location change</Label>\n                  </div>\n                  <div className=\"flex items-center space-x-2\">\n                    <Checkbox\n                      id={`allow-notes-${step.id}`}\n                      checked={step.config.allowNotes !== false}\n                      onCheckedChange={(checked) => onUpdate({\n                        ...step,\n                        config: { ...step.config, allowNotes: !!checked }\n                      })}\n                    />\n                    <Label htmlFor={`allow-notes-${step.id}`}>Allow notes update</Label>\n                  </div>\n                </div>\n              </div>\n            )}\n\n            {step.type === 'create-tray' && (\n              <div className=\"space-y-3\">\n                <Label className=\"text-sm font-medium\">Create Tray Configuration</Label>\n                <div className=\"grid grid-cols-2 gap-3\">\n                  <div>\n                    <Label>Default Tray Type</Label>\n                    <Select\n                      value={step.config.defaultTrayType || 'LG'}\n                      onValueChange={(value) => onUpdate({\n                        ...step,\n                        config: { ...step.config, defaultTrayType: value }\n                      })}\n                    >\n                      <SelectTrigger>\n                        <SelectValue placeholder=\"Select tray type...\" />\n                      </SelectTrigger>\n                      <SelectContent>\n                        <SelectItem value=\"LG\">LG - Leafy Greens</SelectItem>\n                        <SelectItem value=\"MG\">MG - Microgreens</SelectItem>\n                        <SelectItem value=\"HB\">HB - Herbs</SelectItem>\n                      </SelectContent>\n                    </Select>\n                  </div>\n                  <div>\n                    <Label>Default Instance #</Label>\n                    <Input\n                      type=\"number\"\n                      value={step.config.defaultInstance || 1}\n                      onChange={(e) => onUpdate({\n                        ...step,\n                        config: { ...step.config, defaultInstance: parseInt(e.target.value) || 1 }\n                      })}\n                      min=\"1\"\n                      max=\"99\"\n                    />\n                  </div>\n                </div>\n                \n                <div className=\"grid grid-cols-2 gap-3\">\n                  <div>\n                    <Label>Default Growing Medium</Label>\n                    <Select\n                      value={step.config.defaultGrowingMedium || ''}\n                      onValueChange={(value) => onUpdate({\n                        ...step,\n                        config: { ...step.config, defaultGrowingMedium: value }\n                      })}\n                    >\n                      <SelectTrigger>\n                        <SelectValue placeholder=\"User selects...\" />\n                      </SelectTrigger>\n                      <SelectContent>\n                        <SelectItem value=\"user-selects\">User selects...</SelectItem>\n                        <SelectItem value=\"Oasis Cubes\">Oasis Cubes</SelectItem>\n                        <SelectItem value=\"Rockwool\">Rockwool</SelectItem>\n                        <SelectItem value=\"Hemp Mat\">Hemp Mat</SelectItem>\n                        <SelectItem value=\"Coco Mat\">Coco Mat</SelectItem>\n                      </SelectContent>\n                    </Select>\n                  </div>\n                  <div>\n                    <Label>Default Total Slots</Label>\n                    <Input\n                      type=\"number\"\n                      value={step.config.defaultTotalSlots || ''}\n                      onChange={(e) => onUpdate({\n                        ...step,\n                        config: { ...step.config, defaultTotalSlots: parseInt(e.target.value) || 0 }\n                      })}\n                      placeholder=\"e.g., 200\"\n                      min=\"1\"\n                    />\n                  </div>\n                </div>\n\n                {/* Default Crop Varieties Section */}\n                <div className=\"default-varieties-section p-4 bg-gray-50 rounded-lg border\">\n                  <Label className=\"text-sm font-medium mb-2 block\">Default Crop Varieties</Label>\n                  <p className=\"text-xs text-gray-600 mb-3\">Set default quantities for each crop type</p>\n                  \n                  {availableSeeds.length === 0 ? (\n                    <div className=\"no-seeds-message p-3 text-center text-gray-500 italic border rounded\">\n                      <p>No seeds found in inventory.</p>\n                      <p className=\"text-xs mt-1\">Please add seeds to inventory before creating tray defaults.</p>\n                    </div>\n                  ) : (!step.config.defaultVarieties || step.config.defaultVarieties.length === 0) ? (\n                    <div className=\"no-varieties-message p-3 text-center text-gray-500 italic\">\n                      No default varieties set. Click below to add.\n                    </div>\n                  ) : (\n                    <div className=\"varieties-list space-y-2\">\n                      {step.config.defaultVarieties.map((variety: any, index: number) => (\n                        <div key={index} className=\"default-variety-row grid grid-cols-6 gap-2 items-center p-2 bg-white rounded border\">\n                          <Select\n                            value={variety.seedId || ''}\n                            onValueChange={(value) => {\n                              const newVarieties = [...(step.config.defaultVarieties || [])];\n                              const seed = availableSeeds.find(s => s.id.toString() === value);\n                              newVarieties[index] = { \n                                ...variety, \n                                seedId: value,\n                                seedName: seed?.name || '',\n                                sku: seed?.sku || seed?.SKU || seed?.productCode || ''\n                              };\n                              onUpdate({\n                                ...step,\n                                config: { ...step.config, defaultVarieties: newVarieties }\n                              });\n                            }}\n                          >\n                            <SelectTrigger className=\"text-xs\">\n                              <SelectValue placeholder=\"Select seed...\" />\n                            </SelectTrigger>\n                            <SelectContent>\n                              {availableSeeds.length === 0 ? (\n                                <SelectItem value=\"no-seeds\" disabled>No seeds in inventory</SelectItem>\n                              ) : (\n                                availableSeeds.map(seed => {\n                                  const sku = seed.sku || seed.SKU || seed.productCode || '';\n                                  const displaySKU = sku ? `[${sku}]` : '[NO-SKU]';\n                                  return (\n                                    <SelectItem key={seed.id} value={seed.id.toString()}>\n                                      {displaySKU} {seed.name}\n                                    </SelectItem>\n                                  );\n                                })\n                              )}\n                            </SelectContent>\n                          </Select>\n                          \n                          <Input\n                            type=\"number\"\n                            value={variety.quantity || ''}\n                            onChange={(e) => {\n                              const newVarieties = [...(step.config.defaultVarieties || [])];\n                              newVarieties[index] = { ...variety, quantity: parseInt(e.target.value) || 0 };\n                              onUpdate({\n                                ...step,\n                                config: { ...step.config, defaultVarieties: newVarieties }\n                              });\n                            }}\n                            placeholder=\"Qty\"\n                            step=\"1\"\n                            min=\"0\"\n                            className=\"text-xs\"\n                          />\n                          \n                          <Input\n                            type=\"number\"\n                            value={variety.seedsOz || ''}\n                            onChange={(e) => {\n                              const newVarieties = [...(step.config.defaultVarieties || [])];\n                              // Round to 3 decimal places to avoid floating point precision issues\n                              const seedsOz = parseFloat(e.target.value) || 0;\n                              const rounded = Math.round(seedsOz * 1000) / 1000;\n                              newVarieties[index] = { ...variety, seedsOz: rounded };\n                              onUpdate({\n                                ...step,\n                                config: { ...step.config, defaultVarieties: newVarieties }\n                              });\n                            }}\n                            placeholder=\"0.000\"\n                            step=\"0.001\"\n                            min=\"0.001\"\n                            max=\"10\"\n                            className=\"text-xs\"\n                          />\n                          \n                          <Button \n                            type=\"button\"\n                            variant=\"destructive\"\n                            size=\"sm\"\n                            onClick={() => {\n                              const newVarieties = (step.config.defaultVarieties || []).filter((_: any, i: number) => i !== index);\n                              onUpdate({\n                                ...step,\n                                config: { ...step.config, defaultVarieties: newVarieties }\n                              });\n                            }}\n                            className=\"h-8 w-8 p-0\"\n                          >\n                            √ó\n                          </Button>\n                        </div>\n                      ))}\n                      \n                      {/* Show total plants count */}\n                      <div className=\"variety-total text-right p-2 bg-green-50 rounded font-medium text-sm\">\n                        Total Plants: {(step.config.defaultVarieties || []).reduce((sum: number, v: any) => sum + (parseInt(v.quantity) || 0), 0)}\n                        {step.config.defaultTotalSlots && (\n                          <span> / {step.config.defaultTotalSlots} slots</span>\n                        )}\n                      </div>\n                    </div>\n                  )}\n                  \n                  <Button \n                    type=\"button\"\n                    variant=\"outline\"\n                    size=\"sm\"\n                    onClick={() => {\n                      const newVarieties = [...(step.config.defaultVarieties || []), {\n                        seedId: '',\n                        seedName: '',\n                        sku: '',\n                        quantity: 0,\n                        seedsOz: 0\n                      }];\n                      onUpdate({\n                        ...step,\n                        config: { ...step.config, defaultVarieties: newVarieties }\n                      });\n                    }}\n                    className=\"mt-3\"\n                    disabled={availableSeeds.length === 0}\n                  >\n                    <Plus className=\"w-4 h-4 mr-1\" />\n                    Add Default Variety\n                  </Button>\n                  \n                  {availableSeeds.length === 0 && (\n                    <p className=\"text-xs text-gray-500 mt-2 text-center\">\n                      Add seeds to inventory first to enable variety configuration\n                    </p>\n                  )}\n                </div>\n\n                <div>\n                  <Label>Step Instructions</Label>\n                  <textarea\n                    value={step.config.instructions || ''}\n                    onChange={(e) => onUpdate({\n                      ...step,\n                      config: { ...step.config, instructions: e.target.value }\n                    })}\n                    placeholder=\"Additional instructions for this create tray step...\"\n                    rows={2}\n                    className=\"w-full p-2 border border-gray-300 rounded-md resize-none\"\n                  />\n                </div>\n              </div>\n            )}\n          </div>\n        </CardContent>\n      )}\n    </Card>\n  );\n};\n\nexport default ChecklistBuilder;","path":null,"size_bytes":37620,"size_tokens":null},"client/src/components/ui/scroll-area.tsx":{"content":"import * as React from \"react\"\nimport * as ScrollAreaPrimitive from \"@radix-ui/react-scroll-area\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ScrollArea = React.forwardRef<\n  React.ElementRef<typeof ScrollAreaPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.Root>\n>(({ className, children, ...props }, ref) => (\n  <ScrollAreaPrimitive.Root\n    ref={ref}\n    className={cn(\"relative overflow-hidden\", className)}\n    {...props}\n  >\n    <ScrollAreaPrimitive.Viewport className=\"h-full w-full rounded-[inherit]\">\n      {children}\n    </ScrollAreaPrimitive.Viewport>\n    <ScrollBar />\n    <ScrollAreaPrimitive.Corner />\n  </ScrollAreaPrimitive.Root>\n))\nScrollArea.displayName = ScrollAreaPrimitive.Root.displayName\n\nconst ScrollBar = React.forwardRef<\n  React.ElementRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>,\n  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>\n>(({ className, orientation = \"vertical\", ...props }, ref) => (\n  <ScrollAreaPrimitive.ScrollAreaScrollbar\n    ref={ref}\n    orientation={orientation}\n    className={cn(\n      \"flex touch-none select-none transition-colors\",\n      orientation === \"vertical\" &&\n        \"h-full w-2.5 border-l border-l-transparent p-[1px]\",\n      orientation === \"horizontal\" &&\n        \"h-2.5 flex-col border-t border-t-transparent p-[1px]\",\n      className\n    )}\n    {...props}\n  >\n    <ScrollAreaPrimitive.ScrollAreaThumb className=\"relative flex-1 rounded-full bg-border\" />\n  </ScrollAreaPrimitive.ScrollAreaScrollbar>\n))\nScrollBar.displayName = ScrollAreaPrimitive.ScrollAreaScrollbar.displayName\n\nexport { ScrollArea, ScrollBar }\n","path":null,"size_bytes":1642,"size_tokens":null},"client/src/App-broken.tsx":{"content":"import { useEffect, useState } from \"react\";\nimport { Switch, Route } from \"wouter\";\nimport { queryClient } from \"./lib/queryClient\";\nimport { QueryClientProvider } from \"@tanstack/react-query\";\nimport { Toaster } from \"@/components/ui/toaster\";\nimport { TooltipProvider } from \"@/components/ui/tooltip\";\nimport Layout from \"@/components/Layout\";\nimport ErrorBoundary from \"@/components/ErrorBoundary\";\nimport { MsalProvider, useIsAuthenticated, useMsal } from \"@azure/msal-react\";\nimport { PublicClientApplication } from \"@azure/msal-browser\";\nimport { msalConfig, isAuthorizedEmail } from './config/authConfig';\nimport { MicrosoftLogin } from './components/auth/MicrosoftLogin';\nimport { UserProvider } from './contexts/UserContext';\nimport Tasks from \"@/pages/Tasks\";\nimport Inventory from \"@/pages/Inventory\";\nimport Education from \"@/pages/Education\";\n\nimport Account from \"@/pages/Account\";\nimport RecurringTasks from \"@/pages/RecurringTasks\";\nimport TaskData from \"@/pages/TaskData\";\nimport StaffData from \"@/pages/StaffData\";\nimport ProductionData from \"@/pages/ProductionData\";\nimport TrayTracking from \"@/pages/TrayTracking\";\nimport NotFound from \"@/pages/not-found\";\nimport Confetti from \"@/components/Confetti\";\nimport { LocationProvider } from \"@/contexts/LocationContext\";\nimport { initializeProductionData } from \"@/data/initialData\";\nimport { initializeCleanState } from \"@/utils/dataCleanup\";\nimport { createStaffFromMicrosoftLogin, updateLastActive, initializeExpectedStaff } from \"@/services/staffService\";\nimport { useActivityTracking } from \"@/hooks/useActivityTracking\";\nimport { teamsAuthService } from \"./services/teamsAuthService\";\n\nconst msalInstance = new PublicClientApplication(msalConfig);\n\n// The staff service now handles user creation and role assignment automatically\n\nfunction ProtectedRoute({ children }: { children: React.ReactNode }) {\n  return (\n    <LocationProvider>\n      <Layout>{children}</Layout>\n    </LocationProvider>\n  );\n}\n\nfunction AppContent() {\n  const isAuthenticated = useIsAuthenticated();\n  const { accounts, instance } = useMsal();\n  const [isLoading, setIsLoading] = useState(true);\n  const [currentUser, setCurrentUser] = useState<any>(null);\n  const [teamsAuthAttempted, setTeamsAuthAttempted] = useState(false);\n  \n  // Activity tracking for the current user\n  useActivityTracking(currentUser?.id);\n\n  // Try Teams authentication first\n  useEffect(() => {\n    const attemptTeamsAuth = async () => {\n      if (teamsAuthAttempted) return;\n      \n      setTeamsAuthAttempted(true);\n      console.log(\"Attempting Teams authentication...\");\n      \n      try {\n        const teamsResult = await teamsAuthService.initialize();\n        \n        if (teamsResult.isInTeams && teamsResult.account) {\n          console.log(\"Running in Teams, auto-authenticating user:\", teamsResult.account.name);\n          \n          // Verify email domain\n          if (!isAuthorizedEmail(teamsResult.account.username)) {\n            console.error('Access denied. Only @growspace.farm emails are allowed.');\n            teamsAuthService.notifyFailure('Access denied. Only @growspace.farm emails are allowed.');\n            setIsLoading(false);\n            return;\n          }\n\n          // Process Teams user same as regular MSAL user\n          await processUserLogin(teamsResult.account);\n          teamsAuthService.notifySuccess();\n          return;\n        }\n      } catch (error) {\n        console.log(\"Teams authentication failed, falling back to regular MSAL:\", error);\n      }\n      \n      // If not in Teams or Teams auth failed, check regular MSAL\n      if (isAuthenticated && accounts[0]) {\n        await processUserLogin(accounts[0]);\n      } else {\n        setIsLoading(false);\n      }\n    };\n\n    attemptTeamsAuth();\n  }, [isAuthenticated, accounts, teamsAuthAttempted]);\n\n  const processUserLogin = async (account: any) => {\n    try {\n      // Create or update staff entry automatically\n      const staffMember = await createStaffFromMicrosoftLogin(\n        account.localAccountId || account.homeAccountId || '',\n        account.name || 'User',\n        account.username\n      );\n\n      // Determine role based on staff member\n      let role: 'Staff' | 'Manager' | 'Corporate' = 'Staff';\n      let isManager = false;\n      let isCorporateManager = false;\n\n      if (staffMember.rolesAssigned.includes('Corporate Manager')) {\n        role = 'Corporate';\n        isManager = true;\n        isCorporateManager = true;\n      } else if (staffMember.rolesAssigned.includes('Manager')) {\n        role = 'Manager';\n        isManager = true;\n      }\n\n      // Create user object for context\n      const user = {\n        id: staffMember.id,\n        name: staffMember.fullName,\n        email: staffMember.email,\n        role,\n        isManager,\n        isCorporateManager,\n        location: staffMember.location\n      };\n\n      console.log('Initialized user:', user.name, user.email, user.role);\n      setCurrentUser(user);\n\n      // Initialize expected staff members if current user is corporate\n      if (role === 'Corporate') {\n          try {\n            await initializeExpectedStaff();\n          } catch (error) {\n            console.error('Failed to initialize expected staff:', error);\n          }\n        }\n      }\n      setIsLoading(false);\n    };\n\n    initializeUser();\n  }, [isAuthenticated, accounts, instance]);\n\n  if (isLoading) {\n    return (\n      <div className=\"loading-screen\">\n        <h2>üå± Loading Grow Space...</h2>\n      </div>\n    );\n  }\n\n  if (!isAuthenticated) {\n    return <MicrosoftLogin />;\n  }\n\n  if (!currentUser) {\n    return <div className=\"loading-screen\">Setting up your account...</div>;\n  }\n\n  // Your existing app with UserProvider\n  return (\n    <UserProvider value={{ currentUser, setCurrentUser }}>\n      <Router />\n    </UserProvider>\n  );\n}\n\nfunction Router() {\n  return (\n    <Switch>\n      <Route path=\"/\">\n        <ProtectedRoute>\n          <Tasks />\n        </ProtectedRoute>\n      </Route>\n      <Route path=\"/inventory\">\n        <ProtectedRoute>\n          <Inventory />\n        </ProtectedRoute>\n      </Route>\n      <Route path=\"/education\">\n        <ProtectedRoute>\n          <Education />\n        </ProtectedRoute>\n      </Route>\n\n      <Route path=\"/account\">\n        <ProtectedRoute>\n          <Account />\n        </ProtectedRoute>\n      </Route>\n      <Route path=\"/recurring-tasks\">\n        <ProtectedRoute>\n          <RecurringTasks />\n        </ProtectedRoute>\n      </Route>\n      <Route path=\"/task-data\">\n        <ProtectedRoute>\n          <div className=\"min-h-screen flex items-center justify-center bg-gray-50\">\n            <div className=\"text-center p-8\">\n              <div className=\"text-6xl mb-4\">üöß</div>\n              <h2 className=\"text-2xl font-bold text-gray-900 mb-4\">Coming Soon</h2>\n              <p className=\"text-gray-600\">This feature is being developed and will be available soon.</p>\n            </div>\n          </div>\n        </ProtectedRoute>\n      </Route>\n      <Route path=\"/staff-data\">\n        <ProtectedRoute>\n          <StaffData />\n        </ProtectedRoute>\n      </Route>\n      <Route path=\"/production-data\">\n        <ProtectedRoute>\n          <div className=\"min-h-screen flex items-center justify-center bg-gray-50\">\n            <div className=\"text-center p-8\">\n              <div className=\"text-6xl mb-4\">üöß</div>\n              <h2 className=\"text-2xl font-bold text-gray-900 mb-4\">Coming Soon</h2>\n              <p className=\"text-gray-600\">This feature is being developed and will be available soon.</p>\n            </div>\n          </div>\n        </ProtectedRoute>\n      </Route>\n      <Route path=\"/tray-tracking\">\n        <ProtectedRoute>\n          <TrayTracking />\n        </ProtectedRoute>\n      </Route>\n      <Route component={NotFound} />\n    </Switch>\n  );\n}\n\nfunction App() {\n  // Initialize production data on app startup\n  useEffect(() => {\n    initializeProductionData();\n    initializeCleanState();\n  }, []);\n\n  return (\n    <ErrorBoundary>\n      <QueryClientProvider client={queryClient}>\n        <TooltipProvider>\n          <MsalProvider instance={msalInstance}>\n            <AppContent />\n          </MsalProvider>\n          <Toaster />\n          <Confetti />\n        </TooltipProvider>\n      </QueryClientProvider>\n    </ErrorBoundary>\n  );\n}\n\nexport default App;\n","path":null,"size_bytes":8330,"size_tokens":null},"client/src/components/GamifiedProgressBars.tsx":{"content":"import React, { useState, useEffect } from 'react';\nimport { getTodayString } from '../utils/dateUtils';\n\ninterface GamifiedProgressBarsProps {\n  tasks: any[];\n  currentUser: any;\n  selectedDate: string;\n}\n\nconst GamifiedProgressBars: React.FC<GamifiedProgressBarsProps> = ({ tasks, currentUser, selectedDate }) => {\n  const today = getTodayString(); // Use UTC-based date to match database storage\n  const [currentAffirmation, setCurrentAffirmation] = useState(0);\n  \n  // Affirmations pool - moved before useEffect to ensure consistent order\n  const affirmations = [\n    \"Keep crushing it! üí™\",\n    \"You're doing amazing!\",\n    \"Only {percent}% left to go!\",\n    \"Progress, not perfection!\",\n    \"Every task counts!\",\n    \"You've got this!\",\n    \"Momentum is building!\",\n    \"One task at a time!\",\n    \"Stay focused, stay strong!\",\n    \"Almost there!\",\n    \"Making it happen!\",\n    \"Productivity champion!\",\n    \"Keep the streak alive!\",\n    \"You're unstoppable!\",\n    \"Great progress today!\",\n    \"Winning the day!\",\n    \"Task master in action!\",\n    \"Building great habits!\",\n    \"Excellence in motion!\",\n    \"Today is your day!\",\n    \"Crushing those goals!\",\n    \"Keep pushing forward!\",\n    \"Success is a journey!\",\n    \"You're on fire! üî•\",\n    \"Making waves!\",\n    \"Champion mindset!\",\n    \"Consistency is key!\",\n    \"Progress over perfection!\",\n    \"Small wins add up!\",\n    \"You're making it happen!\"\n  ];\n  \n  // Rotate affirmations - ensure this is always called\n  useEffect(() => {\n    const interval = setInterval(() => {\n      setCurrentAffirmation((prev) => (prev + 1) % affirmations.length);\n    }, 3600000); // Change every hour (60 * 60 * 1000 ms)\n    \n    return () => clearInterval(interval);\n  }, [affirmations.length]);\n  \n  // Safety check - don't render if we don't have tasks or current user (after all hooks)\n  if (!tasks || !Array.isArray(tasks) || !currentUser) {\n    return null;\n  }\n  \n  // Only show for today view\n  if (selectedDate !== today) return null;\n  \n  // Use the pre-filtered tasks passed from the parent component\n  // These tasks are already filtered by the Tasks page to show only tasks visible on the selected date\n  const todayTasks = tasks;\n  \n  // Calculate task stats for today's tasks only - with error handling\n  const teamStats = {\n    overdue: todayTasks.filter(t => {\n      try {\n        const taskDate = t?.dueDate ? new Date(t.dueDate).toISOString().split('T')[0] : '';\n        return taskDate < today && t?.status === 'pending';\n      } catch (error) {\n        return false;\n      }\n    }).length,\n    pending: todayTasks.filter(t => {\n      try {\n        const taskDate = t?.dueDate ? new Date(t.dueDate).toISOString().split('T')[0] : '';\n        return t?.status === 'pending' && taskDate >= today;\n      } catch (error) {\n        return false;\n      }\n    }).length,\n    inProgress: todayTasks.filter(t => t?.status === 'in_progress').length,\n    paused: todayTasks.filter(t => t?.status === 'paused').length,\n    completed: todayTasks.filter(t => t?.status === 'completed').length,\n    skipped: todayTasks.filter(t => t?.status === 'skipped').length,\n  };\n  \n  // Calculate stats for user's tasks only - with error handling\n  const myTasks = todayTasks.filter(task => {\n    try {\n      if (!currentUser || !task) return false;\n      \n      // Check both assignTo and assignedTo fields\n      const assignment = task.assignTo || task.assignedTo;\n      if (!assignment) return false;\n      \n      if (assignment === `user_${currentUser.id}`) return true;\n      if (assignment === 'all_staff' && currentUser.id) return true;\n      \n      if (assignment.startsWith && assignment.startsWith('role_')) {\n        const roleName = assignment.replace('role_', '');\n        return currentUser.rolesAssigned?.includes(roleName) || false;\n      }\n      \n      return false;\n    } catch (error) {\n      console.warn('Error filtering task:', task, error);\n      return false;\n    }\n  });\n  \n  const myStats = {\n    overdue: myTasks.filter(t => {\n      try {\n        const taskDate = t?.dueDate ? new Date(t.dueDate).toISOString().split('T')[0] : '';\n        return taskDate < today && t?.status === 'pending';\n      } catch (error) {\n        return false;\n      }\n    }).length,\n    pending: myTasks.filter(t => {\n      try {\n        const taskDate = t?.dueDate ? new Date(t.dueDate).toISOString().split('T')[0] : '';\n        return t?.status === 'pending' && taskDate >= today;\n      } catch (error) {\n        return false;\n      }\n    }).length,\n    inProgress: myTasks.filter(t => t?.status === 'in_progress').length,\n    paused: myTasks.filter(t => t?.status === 'paused').length,\n    completed: myTasks.filter(t => t?.status === 'completed').length,\n    skipped: myTasks.filter(t => t?.status === 'skipped').length,\n  };\n  \n  const teamTotal = Object.values(teamStats).reduce((a, b) => a + b, 0);\n  const myTotal = Object.values(myStats).reduce((a, b) => a + b, 0);\n  \n  const teamCompletedPercent = teamTotal > 0 \n    ? Math.round(((teamStats.completed + teamStats.skipped) / teamTotal) * 100)\n    : 0;\n    \n  const myCompletedPercent = myTotal > 0\n    ? Math.round(((myStats.completed + myStats.skipped) / myTotal) * 100)\n    : 0;\n  \n  // Get affirmation with percent replaced\n  const getAffirmation = (percent: number) => {\n    let message = affirmations[currentAffirmation];\n    message = message.replace('{percent}', String(100 - percent));\n    return message;\n  };\n  \n  // Render progress bar\n  const renderProgressBar = (stats: typeof teamStats, total: number, label: string, isPersonal = false) => {\n    if (total === 0) {\n      return (\n        <div className=\"progress-bar-container\">\n          <div className=\"progress-label\">\n            <span>{label}</span>\n            <span className=\"progress-text\">No tasks today!</span>\n          </div>\n          <div className=\"progress-bar-empty\">\n            <div className=\"empty-message\">üéâ All clear!</div>\n          </div>\n        </div>\n      );\n    }\n    \n    return (\n      <div className=\"progress-bar-container\">\n        <div className=\"progress-label\">\n          <span>{label}</span>\n          <span className=\"progress-count\">{stats.completed + stats.skipped}/{total} tasks</span>\n        </div>\n        \n        <div className=\"progress-bar\">\n          {/* Overdue */}\n          {stats.overdue > 0 && (\n            <div \n              className=\"progress-segment overdue\"\n              style={{ width: `${(stats.overdue / total) * 100}%` }}\n              title={`${stats.overdue} overdue`}\n            />\n          )}\n          \n          {/* Pending */}\n          {stats.pending > 0 && (\n            <div \n              className=\"progress-segment pending\"\n              style={{ width: `${(stats.pending / total) * 100}%` }}\n              title={`${stats.pending} pending`}\n            />\n          )}\n          \n          {/* In Progress */}\n          {stats.inProgress > 0 && (\n            <div \n              className=\"progress-segment in-progress\"\n              style={{ width: `${(stats.inProgress / total) * 100}%` }}\n              title={`${stats.inProgress} in progress`}\n            />\n          )}\n          \n          {/* Paused */}\n          {stats.paused > 0 && (\n            <div \n              className=\"progress-segment paused\"\n              style={{ width: `${(stats.paused / total) * 100}%` }}\n              title={`${stats.paused} paused`}\n            />\n          )}\n          \n          {/* Completed */}\n          {stats.completed > 0 && (\n            <div \n              className=\"progress-segment completed\"\n              style={{ width: `${(stats.completed / total) * 100}%` }}\n              title={`${stats.completed} completed`}\n            />\n          )}\n          \n          {/* Skipped */}\n          {stats.skipped > 0 && (\n            <div \n              className=\"progress-segment skipped\"\n              style={{ width: `${(stats.skipped / total) * 100}%` }}\n              title={`${stats.skipped} skipped`}\n            />\n          )}\n        </div>\n        \n        <div className=\"progress-percentage\">\n          {isPersonal ? myCompletedPercent : teamCompletedPercent}% Complete\n        </div>\n      </div>\n    );\n  };\n  \n  return (\n    <div className=\"gamified-progress-container\">\n      <div className=\"affirmation-message\">\n        {getAffirmation(myTotal > 0 ? myCompletedPercent : teamCompletedPercent)}\n      </div>\n      \n      <div className=\"progress-bars-wrapper\">\n        {renderProgressBar(teamStats, teamTotal, \"üè¢ Team Progress\")}\n        {currentUser && renderProgressBar(myStats, myTotal, \"üë§ My Progress\", true)}\n      </div>\n      \n      <div className=\"progress-legend\">\n        <div className=\"legend-item\">\n          <span className=\"legend-color overdue\"></span>\n          <span>Overdue</span>\n        </div>\n        <div className=\"legend-item\">\n          <span className=\"legend-color pending\"></span>\n          <span>Pending</span>\n        </div>\n        <div className=\"legend-item\">\n          <span className=\"legend-color in-progress\"></span>\n          <span>In Progress</span>\n        </div>\n        <div className=\"legend-item\">\n          <span className=\"legend-color completed\"></span>\n          <span>Completed</span>\n        </div>\n      </div>\n    </div>\n  );\n};\n\nexport default GamifiedProgressBars;","path":null,"size_bytes":9308,"size_tokens":null},"client/src/components/auth/MicrosoftLogin.tsx":{"content":"import React, { useState, useEffect } from 'react';\nimport { useMsal } from \"@azure/msal-react\";\nimport { loginRequest, isAuthorizedEmail, detectIOSEnvironment, debugLog } from '../../config/authConfig';\n\nexport const MicrosoftLogin = () => {\n  const { instance, inProgress } = useMsal();\n  const [deviceInfo, setDeviceInfo] = useState<any>({});\n  const [showIOSFallback, setShowIOSFallback] = useState(false);\n  \n  useEffect(() => {\n    const info = detectIOSEnvironment();\n    setDeviceInfo(info);\n    debugLog('MicrosoftLogin component mounted', info);\n    \n    // Show iOS fallback after 3 seconds if on iOS and no accounts\n    if (info.isIOS) {\n      setTimeout(() => {\n        const hasAccounts = instance.getAllAccounts().length > 0;\n        if (!hasAccounts) {\n          debugLog('Showing iOS login fallback after timeout');\n          setShowIOSFallback(true);\n        }\n      }, 3000);\n    }\n  }, [instance]);\n\n  const handleLogin = async () => {\n    debugLog('Login attempt started', { \n      method: deviceInfo.isIOS ? 'redirect' : 'popup',\n      isIOS: deviceInfo.isIOS \n    });\n    \n    try {\n      let response;\n      \n      // Use redirect flow for iOS, popup for others\n      if (deviceInfo.isIOS || deviceInfo.isWebView) {\n        debugLog('Using redirect flow for iOS/WebView');\n        await instance.loginRedirect({\n          ...loginRequest,\n          prompt: \"select_account\",\n          redirectStartPage: window.location.href\n        });\n        return; // Redirect will handle the response\n      } else {\n        debugLog('Using popup flow for desktop');\n        response = await instance.loginPopup(loginRequest);\n      }\n      \n      if (response) {\n        debugLog('Login successful', { \n          username: response.account.username,\n          name: response.account.name \n        });\n        \n        // Check email domain\n        if (!isAuthorizedEmail(response.account.username)) {\n          debugLog('Email domain check failed', { email: response.account.username });\n          alert('Access denied. Only Grow Space employees can access this app.');\n          await instance.logoutPopup();\n        }\n      }\n    } catch (error) {\n      debugLog('Login failed', { \n        error: (error as any).message,\n        errorCode: (error as any).errorCode,\n        errorDesc: (error as any).errorDesc \n      });\n      console.error('Login failed:', error);\n    }\n  };\n\n  const handleRedirectResponse = async () => {\n    try {\n      debugLog('Handling redirect response');\n      const response = await instance.handleRedirectPromise();\n      if (response) {\n        debugLog('Redirect response received', { \n          username: response.account?.username \n        });\n        return response;\n      }\n    } catch (error) {\n      debugLog('Handle redirect failed', { error: (error as Error).message });\n    }\n  };\n  \n  // Handle redirect response on mount\n  useEffect(() => {\n    if (deviceInfo.isIOS) {\n      handleRedirectResponse();\n    }\n  }, [deviceInfo.isIOS]);\n\n  return (\n    <div className=\"login-page\">\n      <div className=\"login-container\">\n        <div className=\"logo-section\">\n          <h1>üå± Grow Space</h1>\n          <h2>Task Management System</h2>\n        </div>\n        \n        <div className=\"login-section\">\n          <p>Sign in with your Grow Space Microsoft account</p>\n          \n          {/* iOS Detection Info */}\n          {deviceInfo.isIOS && (\n            <div style={{\n              marginBottom: '10px',\n              padding: '8px',\n              backgroundColor: '#fff3cd',\n              border: '1px solid #ffeaa7',\n              borderRadius: '4px',\n              fontSize: '12px',\n              color: '#856404'\n            }}>\n              üì± iOS detected - using redirect authentication\n            </div>\n          )}\n          \n          <button \n            onClick={handleLogin} \n            className=\"microsoft-signin-btn\"\n            disabled={inProgress === \"login\"}\n            data-testid=\"microsoft-login-button\"\n          >\n            <svg width=\"21\" height=\"21\" viewBox=\"0 0 21 21\">\n              <rect x=\"1\" y=\"1\" width=\"9\" height=\"9\" fill=\"#f25022\"/>\n              <rect x=\"1\" y=\"11\" width=\"9\" height=\"9\" fill=\"#00a4ef\"/>\n              <rect x=\"11\" y=\"1\" width=\"9\" height=\"9\" fill=\"#7fba00\"/>\n              <rect x=\"11\" y=\"11\" width=\"9\" height=\"9\" fill=\"#ffb900\"/>\n            </svg>\n            {deviceInfo.isIOS ? 'Sign in (Redirect)' : 'Sign in with Microsoft'}\n          </button>\n          \n          {/* iOS Fallback Message */}\n          {showIOSFallback && deviceInfo.isIOS && (\n            <div style={{\n              marginTop: '15px',\n              padding: '12px',\n              backgroundColor: '#f8d7da',\n              border: '1px solid #f5c6cb',\n              borderRadius: '4px',\n              fontSize: '13px',\n              color: '#721c24'\n            }}>\n              <strong>Auto-login not available on this device</strong><br/>\n              Please tap the button above to sign in manually.\n            </div>\n          )}\n        </div>\n        \n        <div className=\"login-footer\">\n          <p className=\"security-note\">\n            üîí Secure login through Microsoft Azure AD\n          </p>\n        </div>\n      </div>\n    </div>\n  );\n};","path":null,"size_bytes":5252,"size_tokens":null},"client/src/components/checklist/TraySplitStep.tsx":{"content":"import React, { useState, useEffect } from 'react';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { Label } from '@/components/ui/label';\nimport { Badge } from '@/components/ui/badge';\nimport { Split, ArrowRight, Plus, Minus } from 'lucide-react';\nimport SearchableDropdown from '../common/SearchableDropdown';\nimport { Tray, TrayVariety } from '../../data/trayTracking';\nimport TrayDataService from '../../services/trayDataService';\n\ninterface TraySplitStepProps {\n  step: {\n    id: string;\n    label: string;\n    type: 'tray-split';\n    config?: {\n      maxSplits?: number;\n      minSplits?: number;\n      allowCustomSplit?: boolean;\n      defaultSplits?: number;\n    };\n  };\n  value?: {\n    trayId?: string;\n    count: number;\n    splits: Array<{\n      id: string;\n      parentId: string;\n      splitNumber?: number;\n      label: string;\n      cropType?: string;\n      cropName?: string;\n    }>;\n    originalTray?: Tray;\n  };\n  onChange: (value: any) => void;\n  trayId?: string;\n}\n\ninterface VarietySplit {\n  varietyId: string;\n  varietyName: string;\n  originalQuantity: number;\n  splits: Array<{\n    trayIndex: number;\n    quantity: number;\n  }>;\n}\n\nconst TraySplitStep: React.FC<TraySplitStepProps> = ({ \n  step, \n  value, \n  onChange, \n  trayId \n}) => {\n  const [activeTrays, setActiveTrays] = useState<Tray[]>([]);\n  const [selectedTray, setSelectedTray] = useState(value?.trayId || trayId || '');\n  const [splitCount, setSplitCount] = useState(value?.count || step.config?.defaultSplits || 3);\n  const [varietySplits, setVarietySplits] = useState<VarietySplit[]>([]);\n  const [splitMode, setSplitMode] = useState<'auto' | 'manual'>('auto');\n\n  useEffect(() => {\n    console.log('=== TRAY SPLIT DATA CHECK ===');\n    console.log('Using shared TrayDataService - SAME as TrayTracking page');\n    \n    // Load active trays from the shared service\n    const loadActiveTrays = () => {\n      const activeTrayData = TrayDataService.getActiveTrays();\n      console.log('TraySplitStep: Loaded', activeTrayData.length, 'active trays');\n      setActiveTrays(activeTrayData);\n    };\n    \n    loadActiveTrays();\n    \n    // Listen for tray data updates\n    const handleTrayUpdate = () => {\n      console.log('TraySplitStep: Received tray data update, reloading...');\n      loadActiveTrays();\n    };\n    \n    window.addEventListener('trayDataUpdated', handleTrayUpdate);\n    \n    console.log('‚úÖ SUCCESS: Using shared TrayDataService!');\n    console.log('=== END TRAY SPLIT DATA CHECK ===');\n    \n    return () => {\n      window.removeEventListener('trayDataUpdated', handleTrayUpdate);\n    };\n  }, []);\n\n  const handleTraySelect = (trayId: string) => {\n    setSelectedTray(trayId);\n    updateValue(trayId, splitCount);\n  };\n\n  const handleSplitCountChange = (count: number) => {\n    const minSplits = step.config?.minSplits || 2;\n    const maxSplits = step.config?.maxSplits || 10;\n    const newCount = Math.max(minSplits, Math.min(maxSplits, parseInt(count.toString()) || minSplits));\n    setSplitCount(newCount);\n    updateValue(selectedTray, newCount);\n  };\n\n  // Calculate smart variety distribution across child trays\n  const calculateVarietyDistribution = (tray: Tray, splitCount: number) => {\n    if (!tray.varieties || tray.varieties.length === 0) {\n      return [];\n    }\n\n    const splits: VarietySplit[] = tray.varieties.map(variety => {\n      const baseQuantityPerTray = Math.floor(variety.quantity / splitCount);\n      const remainder = variety.quantity % splitCount;\n      \n      const varietySplit: VarietySplit = {\n        varietyId: variety.seedId,\n        varietyName: variety.seedName,\n        originalQuantity: variety.quantity,\n        splits: []\n      };\n\n      // Distribute plants across trays\n      for (let i = 0; i < splitCount; i++) {\n        const quantity = baseQuantityPerTray + (i < remainder ? 1 : 0);\n        varietySplit.splits.push({\n          trayIndex: i,\n          quantity: quantity\n        });\n      }\n\n      return varietySplit;\n    });\n\n    return splits;\n  };\n\n  const updateValue = (trayId: string, count: number) => {\n    if (!trayId) return;\n\n    const tray = activeTrays.find(t => t.id === trayId);\n    if (!tray) return;\n\n    // Calculate variety distribution\n    const varietyDistribution = calculateVarietyDistribution(tray, count);\n    setVarietySplits(varietyDistribution);\n\n    // Generate split preview with variety information\n    const splits = [];\n    for (let i = 1; i <= count; i++) {\n      const trayVarieties = varietyDistribution.map(vs => ({\n        varietyName: vs.varietyName,\n        quantity: vs.splits[i - 1]?.quantity || 0\n      })).filter(v => v.quantity > 0);\n\n      splits.push({\n        id: `${trayId}-${i}`,\n        label: `Split ${i}`,\n        parentId: trayId,\n        splitNumber: i,\n        cropType: tray.cropType,\n        cropName: tray.cropType,\n        varieties: trayVarieties,\n        totalPlants: trayVarieties.reduce((sum, v) => sum + v.quantity, 0)\n      });\n    }\n\n    // When the step is completed, perform the actual split\n    const value = {\n      trayId: trayId,\n      count: count,\n      splits: splits,\n      originalTray: tray,\n      varietyDistribution: varietyDistribution,\n      // Add a method to execute the actual split\n      executeSplit: () => {\n        console.log('TraySplitStep: Executing multi-variety split operation');\n        const result = TrayDataService.splitTray(trayId, count);\n        console.log('TraySplitStep: Multi-variety split executed, result:', result);\n        return result;\n      }\n    };\n\n    onChange(value);\n  };\n\n  // Custom render for tray options - using TrayTracking format\n  const renderTrayOption = (tray: Tray) => (\n    <div className=\"tray-option\">\n      <span className=\"tray-id font-mono font-medium\">{tray.id}</span>\n      <span className=\"tray-details text-sm text-gray-600 block\">\n        {tray.cropType}\n        {tray.datePlanted && ` - Planted: ${tray.datePlanted.toLocaleDateString()}`}\n      </span>\n    </div>\n  );\n\n  const minSplits = step.config?.minSplits || 2;\n  const maxSplits = step.config?.maxSplits || 10;\n\n  return (\n    <div className=\"space-y-4\">\n      <div className=\"space-y-2\">\n        <Label className=\"text-base font-medium flex items-center\">\n          <Split className=\"w-4 h-4 mr-2\" />\n          {step.label || 'Select a tray to split into multiple portions'}\n        </Label>\n      </div>\n\n      <div className=\"space-y-4 p-4 bg-blue-50 rounded-lg border\">\n        <div className=\"space-y-2\">\n          <Label>Select Tray:</Label>\n          <SearchableDropdown\n            options={activeTrays}\n            value={selectedTray}\n            onChange={handleTraySelect}\n            placeholder=\"Search by tray ID or crop...\"\n            displayField=\"id\"\n            valueField=\"id\"\n            renderOption={renderTrayOption}\n          />\n        </div>\n\n        {selectedTray && (\n          <div className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"split-count\">Number of splits ({minSplits}-{maxSplits}):</Label>\n              <div className=\"flex items-center space-x-2\">\n                <Input\n                  id=\"split-count\"\n                  type=\"number\"\n                  min={minSplits}\n                  max={maxSplits}\n                  value={splitCount}\n                  onChange={(e) => handleSplitCountChange(parseInt(e.target.value) || minSplits)}\n                  className=\"w-24\"\n                />\n                <span className=\"text-sm text-gray-500\">({minSplits}-{maxSplits} splits allowed)</span>\n              </div>\n            </div>\n          </div>\n        )}\n      </div>\n\n      {selectedTray && value?.splits && (\n        <div className=\"space-y-3 p-4 bg-gray-50 rounded-lg border\">\n          <h4 className=\"font-medium text-gray-900\">\n            This will create {splitCount} new trays from {selectedTray}:\n          </h4>\n          \n          {/* Show variety distribution if available */}\n          {varietySplits.length > 0 && (\n            <div className=\"bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4\">\n              <h5 className=\"font-medium text-blue-800 mb-2\">üå± Variety Distribution</h5>\n              {varietySplits.map((variety, vIdx) => (\n                <div key={variety.varietyId} className=\"mb-2\">\n                  <div className=\"text-sm font-medium text-blue-700\">{variety.varietyName}:</div>\n                  <div className=\"flex gap-1 mt-1\">\n                    {variety.splits.map((split, sIdx) => (\n                      <div key={sIdx} className=\"bg-white px-2 py-1 rounded text-xs border\">\n                        T{sIdx + 1}: {split.quantity}\n                      </div>\n                    ))}\n                  </div>\n                </div>\n              ))}\n            </div>\n          )}\n          \n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-2\">\n            {value.splits.map((split: any, index: number) => (\n              <div key={split.id} className=\"p-3 bg-white border rounded\">\n                <div className=\"flex items-center space-x-2 mb-2\">\n                  <Badge variant=\"outline\" className=\"text-xs\">\n                    {index + 1}\n                  </Badge>\n                  <code className=\"text-sm font-mono text-blue-600\">{split.id}</code>\n                </div>\n                {split.varieties && split.varieties.length > 0 && (\n                  <div className=\"text-xs text-gray-600\">\n                    {split.varieties.map((v: any, i: number) => (\n                      <span key={i}>\n                        {v.quantity} {v.varietyName}\n                        {i < split.varieties.length - 1 ? ', ' : ''}\n                      </span>\n                    ))}\n                    <div className=\"mt-1 font-medium\">Total: {split.totalPlants} plants</div>\n                  </div>\n                )}\n              </div>\n            ))}\n          </div>\n          <p className=\"text-sm text-gray-500 italic mt-3\">\n            Original tray {selectedTray} will be marked as split and archived.\n          </p>\n        </div>\n      )}\n    </div>\n  );\n};\n\nexport default TraySplitStep;","path":null,"size_bytes":10169,"size_tokens":null},"client/src/components/ui/select.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as SelectPrimitive from \"@radix-ui/react-select\"\nimport { Check, ChevronDown, ChevronUp } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Select = SelectPrimitive.Root\n\nconst SelectGroup = SelectPrimitive.Group\n\nconst SelectValue = SelectPrimitive.Value\n\nconst SelectTrigger = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex h-10 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background data-[placeholder]:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <SelectPrimitive.Icon asChild>\n      <ChevronDown className=\"h-4 w-4 opacity-50\" />\n    </SelectPrimitive.Icon>\n  </SelectPrimitive.Trigger>\n))\nSelectTrigger.displayName = SelectPrimitive.Trigger.displayName\n\nconst SelectScrollUpButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollUpButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollUpButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollUpButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronUp className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollUpButton>\n))\nSelectScrollUpButton.displayName = SelectPrimitive.ScrollUpButton.displayName\n\nconst SelectScrollDownButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollDownButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollDownButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollDownButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronDown className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollDownButton>\n))\nSelectScrollDownButton.displayName =\n  SelectPrimitive.ScrollDownButton.displayName\n\nconst SelectContent = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Content>\n>(({ className, children, position = \"popper\", ...props }, ref) => (\n  <SelectPrimitive.Portal>\n    <SelectPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"relative z-50 max-h-[--radix-select-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-select-content-transform-origin]\",\n        position === \"popper\" &&\n          \"data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1\",\n        className\n      )}\n      position={position}\n      {...props}\n    >\n      <SelectScrollUpButton />\n      <SelectPrimitive.Viewport\n        className={cn(\n          \"p-1\",\n          position === \"popper\" &&\n            \"w-full min-w-[var(--radix-select-trigger-width)]\"\n        )}\n      >\n        {children}\n      </SelectPrimitive.Viewport>\n      <SelectScrollDownButton />\n    </SelectPrimitive.Content>\n  </SelectPrimitive.Portal>\n))\nSelectContent.displayName = SelectPrimitive.Content.displayName\n\nconst SelectLabel = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Label>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Label\n    ref={ref}\n    className={cn(\"py-1.5 pl-8 pr-2 text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nSelectLabel.displayName = SelectPrimitive.Label.displayName\n\nconst SelectItem = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Item>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <SelectPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </SelectPrimitive.ItemIndicator>\n    </span>\n\n    <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>\n  </SelectPrimitive.Item>\n))\nSelectItem.displayName = SelectPrimitive.Item.displayName\n\nconst SelectSeparator = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nSelectSeparator.displayName = SelectPrimitive.Separator.displayName\n\nexport {\n  Select,\n  SelectGroup,\n  SelectValue,\n  SelectTrigger,\n  SelectContent,\n  SelectLabel,\n  SelectItem,\n  SelectSeparator,\n  SelectScrollUpButton,\n  SelectScrollDownButton,\n}\n","path":null,"size_bytes":5703,"size_tokens":null},"server/storage.ts":{"content":"import { \n  users, tasks, inventoryItems, trainingModules, userProgress, taskLogs,\n  recurringTasks, growingSystems, trays, trayMovements, inventoryTransactions, courseAssignments, notifications, systemStatus, systemLocks,\n  type User, type InsertUser, type Task, type InsertTask, \n  type InventoryItem, type InsertInventoryItem, type TrainingModule,\n  type InsertTrainingModule, type UserProgress, type InsertUserProgress,\n  type TaskLog, type InsertTaskLog, type ChecklistItem, type RecurringTask,\n  type InsertRecurringTask, type GrowingSystem, type InsertGrowingSystem,\n  type Tray, type InsertTray, type TrayMovement, type InsertTrayMovement, type InventoryTransaction,\n  type InsertInventoryTransaction, type CourseAssignment, type InsertCourseAssignment,\n  type Notification, type InsertNotification, type SystemStatus, type InsertSystemStatus,\n  type SystemLock, type InsertSystemLock\n} from \"@shared/schema\";\nimport { db } from \"./db\";\nimport { eq, and, sql, or, gte, lte, isNull } from \"drizzle-orm\";\nimport { PersistenceManager } from './persistence';\n\n// Safe date handling utility to prevent TypeScript errors\nconst safeDate = (v: Date | string | number | null | undefined): Date | null => v == null ? null : new Date(v);\n\nexport interface IStorage {\n  // User methods\n  getUser(id: number): Promise<User | undefined>;\n  getUserByUsername(username: string): Promise<User | undefined>;\n  createUser(user: InsertUser): Promise<User>;\n  updateUser(id: number, updates: Partial<User>): Promise<User | undefined>;\n  getAllUsers(): Promise<User[]>;\n\n  // Task methods\n  getTask(id: number): Promise<Task | undefined>;\n  getTasksByUser(userId: number): Promise<Task[]>;\n  getAllTasks(): Promise<Task[]>;\n  getTasksByLocation(locationId: string): Promise<Task[]>;\n  createTask(task: InsertTask): Promise<Task>;\n  updateTask(id: number, updates: Partial<Task>): Promise<Task | undefined>;\n  deleteTask(id: number): Promise<boolean>;\n  resetTasks(): Promise<boolean>;\n  resetTaskSequence(): Promise<void>;\n\n  // Inventory methods\n  getInventoryItem(id: number): Promise<InventoryItem | undefined>;\n  getAllInventoryItems(): Promise<InventoryItem[]>;\n  getInventoryItemsByLocation(locationId: string): Promise<InventoryItem[]>;\n  createInventoryItem(item: InsertInventoryItem): Promise<InventoryItem>;\n  updateInventoryItem(id: number, updates: Partial<InventoryItem>): Promise<InventoryItem | undefined>;\n  deleteInventoryItem(id: number): Promise<boolean>;\n  getLowStockItems(): Promise<InventoryItem[]>;\n  getLowStockItemsByLocation(locationId: string): Promise<InventoryItem[]>;\n  addInventoryStock(data: { itemId: number; quantity: number; unitCost: number; supplier?: string; notes?: string }): Promise<InventoryItem>;\n\n  // Training methods\n  getTrainingModule(id: number): Promise<TrainingModule | undefined>;\n  getAllTrainingModules(): Promise<TrainingModule[]>;\n  createTrainingModule(module: InsertTrainingModule): Promise<TrainingModule>;\n  getUserProgress(userId: number): Promise<UserProgress[]>;\n  updateUserProgress(progress: InsertUserProgress): Promise<UserProgress>;\n\n  // Task logs\n  createTaskLog(log: InsertTaskLog): Promise<TaskLog>;\n  getTaskLogs(taskId: number): Promise<TaskLog[]>;\n\n  // Recurring tasks\n  getRecurringTask(id: number): Promise<RecurringTask | undefined>;\n  getAllRecurringTasks(): Promise<RecurringTask[]>;\n  getRecurringTasksByLocation(locationId: string): Promise<RecurringTask[]>;\n  createRecurringTask(task: InsertRecurringTask): Promise<RecurringTask>;\n  updateRecurringTask(id: number, updates: Partial<RecurringTask>, options?: { strategy?: 'update_all' | 'new_only'; userId?: number }): Promise<{ task: RecurringTask | null; report: any }>;\n  calculateUpdateImpact(id: number, changedFields: any[]): Promise<{ affectedCount: number; conflictCount: number; byStatus: Record<string, number>; byDate: Record<string, number> }>;\n  deleteRecurringTask(id: number): Promise<boolean>;\n  resetRecurringTasks(): Promise<boolean>;\n  regenerateAllTaskInstances(): Promise<{ totalTasksCreated: number; recurringTasksProcessed: number }>;\n  regenerateTaskInstances(recurringTaskId: number): Promise<boolean>;\n  verifyTaskIntegrity(): Promise<{\n    missingTasksCreated: number;\n    duplicatesRemoved: number;\n    errors: string[];\n    verificationReport: string[];\n  }>;\n\n  // Growing systems\n  getGrowingSystem(id: number): Promise<GrowingSystem | undefined>;\n  getAllGrowingSystems(): Promise<GrowingSystem[]>;\n  getGrowingSystemsByLocation(locationId: string): Promise<GrowingSystem[]>;\n  createGrowingSystem(system: InsertGrowingSystem): Promise<GrowingSystem>;\n  updateGrowingSystem(id: number, updates: Partial<GrowingSystem>): Promise<GrowingSystem | undefined>;\n  deleteGrowingSystem(id: number): Promise<boolean>;\n\n  // Trays\n  getTray(id: string): Promise<Tray | undefined>;\n  getAllTrays(): Promise<Tray[]>;\n  getTraysByLocation(locationId: string): Promise<Tray[]>;\n  createTray(tray: InsertTray): Promise<Tray>;\n  updateTray(id: string, updates: Partial<Tray>): Promise<Tray | undefined>;\n  deleteTray(id: string): Promise<boolean>;\n  splitTray(originalTrayId: string, splitData: { splitCount: number; newTrayIds: string[] }): Promise<Tray[]>;\n\n  // Tray movements\n  createTrayMovement(movement: InsertTrayMovement): Promise<TrayMovement>;\n  getTrayMovements(trayId: string): Promise<TrayMovement[]>;\n\n  // Course assignments\n  getCourseAssignment(id: number): Promise<CourseAssignment | undefined>;\n  getAllCourseAssignments(): Promise<CourseAssignment[]>;\n  getCourseAssignmentsByUser(userId: number): Promise<CourseAssignment[]>;\n  createCourseAssignment(assignment: InsertCourseAssignment): Promise<CourseAssignment>;\n  updateCourseAssignment(id: number, updates: Partial<CourseAssignment>): Promise<CourseAssignment | undefined>;\n  deleteCourseAssignment(id: number): Promise<boolean>;\n\n  // Notification methods\n  getNotification(id: number): Promise<Notification | undefined>;\n  getAllNotifications(): Promise<Notification[]>;\n  getNotificationsByUser(userId: number): Promise<Notification[]>;\n  createNotification(notification: InsertNotification): Promise<Notification>;\n  updateNotification(id: number, updates: Partial<Notification>): Promise<Notification | undefined>;\n  markNotificationAsRead(id: number): Promise<Notification | undefined>;\n  markAllNotificationsAsRead(userId: number): Promise<void>;\n  deleteNotification(id: number): Promise<boolean>;\n  \n  // Clear all data\n  clearAllData(): Promise<boolean>;\n  \n  // Task sequence management\n  resetTaskSequence(): Promise<void>;\n  \n  // System status and locks for task generation\n  getSystemStatus(id: string): Promise<SystemStatus | undefined>;\n  setSystemStatus(status: InsertSystemStatus): Promise<SystemStatus>;\n  acquireLock(lockId: string, userId: number, lockType: string, expirationMinutes?: number): Promise<SystemLock | null>;\n  releaseLock(lockId: string): Promise<boolean>;\n  checkLock(lockId: string): Promise<SystemLock | null>;\n}\n\nexport class MemStorage implements IStorage {\n  private users: Map<number, User> = new Map();\n  private tasks: Map<number, Task> = new Map();\n  private inventoryItems: Map<number, InventoryItem> = new Map();\n  private trainingModules: Map<number, TrainingModule> = new Map();\n  private userProgress: Map<string, UserProgress> = new Map(); // key: userId-moduleId\n  private taskLogs: Map<number, TaskLog> = new Map();\n  private recurringTasks: Map<number, RecurringTask> = new Map();\n  private growingSystems: Map<number, GrowingSystem> = new Map();\n  private trayMovements: Map<number, TrayMovement> = new Map();\n  // private crops: Map<number, Crop> = new Map(); // Disabled until Crop type is defined\n  private courseAssignments: Map<number, CourseAssignment> = new Map();\n  private notifications: Map<number, Notification> = new Map();\n  \n  private currentUserId = 1;\n  private currentTaskId = 1;\n  private currentInventoryId = 1;\n  private currentModuleId = 1;\n  private currentProgressId = 1;\n  private currentLogId = 1;\n  private currentRecurringTaskId = 1;\n  private currentGrowingSystemId = 1;\n  private currentTrayMovementId = 1;\n  // private currentCropId = 1; // Disabled until Crop type is defined\n  private currentAssignmentId = 1;\n  private currentNotificationId = 1;\n\n  private persistence = PersistenceManager.getInstance();\n\n  constructor() {\n    // Load persisted data asynchronously - this will either load from files or fall back to seed data\n    this.loadPersistedData().catch(console.error);\n  }\n\n  private async loadPersistedData() {\n    console.log('Loading persisted data...');\n    \n    // Skip persistence restore AND seeding when using real database to prevent demo data pollution\n    if (process.env.DATABASE_URL) {\n      console.log('üö´ Database detected - skipping both persistence file restore AND demo data seeding');\n      console.log('MemStorage will NOT seed October demo data - DatabaseStorage will handle task storage');\n      \n      // Only initialize growing systems (they're not persisted yet)\n      if (this.growingSystems.size === 0) {\n        console.log('Initializing growing systems...');\n        this.initializeGrowingSystems();\n      }\n      \n      return;\n    }\n    \n    const persistedData = await this.persistence.loadData();\n    \n    if (persistedData) {\n      // Restore tasks\n      persistedData.tasks.forEach(task => {\n        this.tasks.set(task.id, task);\n      });\n      \n      // Restore recurring tasks\n      persistedData.recurringTasks.forEach(recurringTask => {\n        this.recurringTasks.set(recurringTask.id, recurringTask);\n      });\n      \n      // Restore inventory items\n      persistedData.inventoryItems.forEach(item => {\n        this.inventoryItems.set(item.id, item);\n      });\n      \n      // Restore counters\n      this.currentTaskId = persistedData.counters.currentTaskId;\n      this.currentRecurringTaskId = persistedData.counters.currentRecurringTaskId; \n      this.currentInventoryId = persistedData.counters.currentInventoryId;\n      \n      // CRITICAL: Reset Postgres sequence to align with existing data\n      try {\n        // This is handled by the DatabaseStorage when using HybridStorage\n        console.log('‚úÖ Task sequence will be managed by DatabaseStorage');\n      } catch (error) {\n        console.log('‚ö†Ô∏è Failed to reset task sequence:', error);\n      }\n\n      console.log('Persistence restored:', {\n        tasks: persistedData.tasks.length,\n        recurringTasks: persistedData.recurringTasks.length,\n        inventoryItems: persistedData.inventoryItems.length\n      });\n\n      // CRITICAL: Reset in-memory sequence to align with existing data\n      try {\n        await this.resetTaskSequence();\n        console.log('‚úÖ Reset MemStorage task ID sequence');\n      } catch (error) {\n        console.log('‚ö†Ô∏è Failed to reset task sequence:', error);\n      }\n\n      // Initialize continuous verification system\n      this.setupContinuousVerification();\n      \n      // Migrate any \"weekly\" frequency to \"daily\" for UI compatibility\n      await this.migrateWeeklyFrequencies();\n      \n      // Use new verification system instead of legacy generation\n      console.log('üîÑ Starting continuous task verification system...');\n      await this.verifyAndHealTasks();\n      \n      // Initialize inventory if empty (even with persisted data)\n      if (this.inventoryItems.size === 0) {\n        console.log('Inventory is empty, initializing with seed inventory...');\n        this.initializeInventoryData();\n      }\n    } else {\n      console.log('No persisted data found, initializing with seed data');\n      this.seedInitialData();\n    }\n    \n    // Always ensure growing systems are initialized (they're not persisted yet)\n    if (this.growingSystems.size === 0) {\n      console.log('Initializing growing systems...');\n      this.initializeGrowingSystems();\n    }\n  }\n\n  // Migration function to convert \"weekly\" frequency to \"daily\" for UI compatibility\n  private async migrateWeeklyFrequencies() {\n    console.log('=== REVERSE MIGRATING DAILY BACK TO WEEKLY ===');\n    let migratedCount = 0;\n    \n    // Reverse migrate: Convert 'daily' back to 'weekly' if daysOfWeek is present\n    this.recurringTasks.forEach((recurringTask, id) => {\n      if (recurringTask.frequency === 'daily' && recurringTask.daysOfWeek && recurringTask.daysOfWeek.length > 0) {\n        recurringTask.frequency = 'weekly';\n        migratedCount++;\n        console.log(`Restored recurring task ${id} (${recurringTask.title}) from daily to weekly with days: ${recurringTask.daysOfWeek.join(', ')}`);\n      }\n    });\n    \n    // Don't migrate regular task instances - they should be regenerated correctly\n    \n    if (migratedCount > 0) {\n      console.log(`Reverse migration complete: ${migratedCount} recurring tasks restored to weekly`);\n      // Save the migrated data\n      await this.persistence.saveData({\n        tasks: Array.from(this.tasks.values()),\n        recurringTasks: Array.from(this.recurringTasks.values()),\n        inventoryItems: Array.from(this.inventoryItems.values()),\n        counters: {\n          currentTaskId: this.currentTaskId,\n          currentRecurringTaskId: this.currentRecurringTaskId,\n          currentInventoryId: this.currentInventoryId\n        }\n      });\n    } else {\n      console.log('No daily frequencies with daysOfWeek found to restore');\n    }\n  }\n\n  // BLUEPRINT: Advanced Task Generation System - Main generation function\n  private async generateTasksForDateRange(startDate: Date, endDate: Date, specificTemplate: RecurringTask | null = null): Promise<Task[]> {\n    console.log(`üîÑ GENERATING TASKS FOR DATE RANGE: ${this.formatDate(startDate)} to ${this.formatDate(endDate)}`);\n    \n    // Get templates to process\n    const templates = specificTemplate \n      ? [specificTemplate] \n      : Array.from(this.recurringTasks.values()).filter(rt => rt.isActive);\n      \n    const tasksCreated: Task[] = [];\n    const currentDate = new Date(startDate);\n    \n    while (currentDate <= endDate) {\n      for (const template of templates) {\n        const task = await this.shouldGenerateTask(template, currentDate);\n        if (task && !await this.taskExistsForDateComposite(template.id, currentDate)) {\n          // CRITICAL FIX: Use the same storage singleton that the API reads from\n          const createdTask = await storage.createTask(task);\n          tasksCreated.push(createdTask);\n          console.log(`‚úÖ Created task: ${task.title} for ${this.formatDate(currentDate)}`);\n        }\n      }\n      currentDate.setUTCDate(currentDate.getUTCDate() + 1);\n    }\n    \n    console.log(`üéâ Generated ${tasksCreated.length} tasks for date range`);\n    return tasksCreated;\n  }\n\n  // BLUEPRINT: Task Creation Logic - Determines when to generate tasks based on frequency\n  private async shouldGenerateTask(template: RecurringTask, checkDate: Date): Promise<InsertTask | null> {\n    const dayOfMonth = checkDate.getUTCDate();\n    const month = checkDate.getUTCMonth();\n    const year = checkDate.getUTCFullYear();\n    const dayName = checkDate.toLocaleDateString('en-US', { weekday: 'long', timeZone: 'UTC' }).toLowerCase();\n    \n    switch (template.frequency) {\n      case 'monthly':\n        if (dayOfMonth === 1) {\n          const lastDay = new Date(Date.UTC(year, month + 1, 0));\n          return this.buildTaskFromTemplate(template, {\n            id: `${template.id}-${year}-${String(month + 1).padStart(2, '0')}`,\n            visibleFromDate: new Date(Date.UTC(year, month, 1)),\n            dueDate: lastDay\n          });\n        }\n        break;\n        \n      case 'biweekly':\n        // Create first half task on day 1 (due on 14th)\n        if (dayOfMonth === 1) {\n          const visibleDate = new Date(Date.UTC(year, month, 1));\n          const dueDate = new Date(Date.UTC(year, month, 14));\n          return this.buildTaskFromTemplate(template, {\n            id: `${template.id}-${year}-${String(month + 1).padStart(2, '0')}-first`,\n            visibleFromDate: visibleDate,\n            dueDate: dueDate\n          });\n        }\n        // Create second half task on day 15 (due on last day of month)\n        if (dayOfMonth === 15) {\n          const visibleDate = new Date(Date.UTC(year, month, 15));\n          const dueDate = new Date(Date.UTC(year, month + 1, 0));\n          return this.buildTaskFromTemplate(template, {\n            id: `${template.id}-${year}-${String(month + 1).padStart(2, '0')}-second`,\n            visibleFromDate: visibleDate,\n            dueDate: dueDate\n          });\n        }\n        break;\n        \n      case 'weekly': // Weekly tasks - handle both string and array formats\n        const templateDays = Array.isArray(template.daysOfWeek) \n          ? template.daysOfWeek \n          : (template.daysOfWeek ? [template.daysOfWeek] : []);\n        \n        // FIXED: Only generate if specific days are configured AND current day matches\n        if (templateDays.length > 0 && templateDays.includes(dayName)) {\n          return this.buildTaskFromTemplate(template, {\n            id: `${template.id}-${this.formatDate(checkDate)}`,\n            visibleFromDate: checkDate,\n            dueDate: checkDate\n          });\n        }\n        // If no days specified, don't generate any tasks (instead of every day)\n        break;\n        \n      case 'daily': // Daily tasks - respect daysOfWeek for selective generation\n        const dailyTemplateDays = Array.isArray(template.daysOfWeek) \n          ? template.daysOfWeek \n          : (template.daysOfWeek ? [template.daysOfWeek] : []);\n        \n        // If no days specified, don't generate (empty means no days, not every day)\n        if (dailyTemplateDays.length === 0) {\n          return null;\n        }\n        \n        // Only generate if current day matches specified days\n        if (dailyTemplateDays.includes(dayName)) {\n          return this.buildTaskFromTemplate(template, {\n            id: `${template.id}-${this.formatDate(checkDate)}`,\n            visibleFromDate: checkDate,\n            dueDate: checkDate\n          });\n        }\n        \n        // Current day doesn't match specified days\n        return null;\n        \n      case 'quarterly':\n        const quarterStarts = [0, 3, 6, 9];\n        if (quarterStarts.includes(month) && dayOfMonth === 1) {\n          const quarterEnd = new Date(Date.UTC(year, month + 3, 0));\n          return this.buildTaskFromTemplate(template, {\n            id: `${template.id}-${year}-Q${Math.floor(month / 3) + 1}`,\n            visibleFromDate: checkDate,\n            dueDate: quarterEnd\n          });\n        }\n        break;\n    }\n    \n    return null;\n  }\n\n  // BLUEPRINT: Task Creation Helper (returns InsertTask without ID)\n  private async buildTaskFromTemplate(template: RecurringTask, dateInfo: { id: string; visibleFromDate: Date; dueDate: Date }): Promise<InsertTask> {\n    // Determine the correct frequency for the generated task\n    const isPeriodicTask = dateInfo.visibleFromDate.getTime() !== dateInfo.dueDate.getTime();\n    const taskFrequency = isPeriodicTask ? 'biweekly' : template.frequency;\n    \n    const newTask: InsertTask = {\n      title: template.title,\n      description: template.description || '',\n      type: template.type,\n      status: 'pending',\n      priority: 'medium',\n      frequency: taskFrequency, // Set correct frequency for filtering\n      assignedTo: null, // Legacy field - use assignTo instead\n      assignTo: template.assignTo || undefined,\n      createdBy: template.createdBy,\n      location: template.location,\n      estimatedTime: null,\n      actualTime: null,\n      progress: 0,\n      checklist: template.checklistTemplate?.steps?.map((step, index) => ({\n        id: `${index + 1}`,\n        text: step.label || step.text || '',\n        completed: false,\n        required: step.required || false,\n        type: step.type,\n        config: {\n          inventoryCategory: step.inventoryCategory,\n          min: step.min,\n          max: step.max,\n          default: step.default,\n          systemType: step.systemType,\n          autoSuggest: step.autoSuggest,\n          dataType: step.dataType,\n          calculation: step.calculation\n        },\n        dataCollection: step.type === 'data-capture' ? { \n          type: step.dataType || 'text', \n          label: step.label || '' \n        } : undefined\n      })) || [],\n      data: {},\n      taskDate: dateInfo.visibleFromDate, // Set taskDate for frontend filtering\n      dueDate: dateInfo.dueDate,\n      visibleFromDate: dateInfo.visibleFromDate,\n      startedAt: null,\n      completedAt: null,\n      pausedAt: null,\n      resumedAt: null,\n      skippedAt: null,\n      skipReason: null,\n      isRecurring: true,\n      recurringTaskId: template.id,\n      isFromDeletedRecurring: false,\n      deletedRecurringTaskTitle: null\n      // No createdAt - let database handle it\n    };\n    \n    return newTask;\n  }\n\n  // BLUEPRINT: Daily Maintenance System with Locking\n  async initializeGeneration(userId: number = 1): Promise<void> {\n    console.log('üöÄ INITIALIZING ADVANCED TASK GENERATION SYSTEM');\n    \n    const lock = await this.acquireLock('task-generation-lock', userId, 'task_generation', 10);\n    if (!lock) {\n      console.log('‚è≥ Another user is handling task generation');\n      return;\n    }\n    \n    try {\n      const status = await this.getSystemStatus('task-generation-status');\n      const today = new Date();\n      today.setUTCHours(0, 0, 0, 0);\n      \n      const todayStr = this.formatDate(today);\n      const lastRunDate = status?.lastGenerationDate;\n      \n      if (!status || !lastRunDate || lastRunDate < todayStr) {\n        console.log(`üîÑ Running generation - Last run: ${lastRunDate || 'never'}, Today: ${todayStr}`);\n        \n        // Start from beginning of current biweekly period to catch current tasks\n        const startDate = new Date(today);\n        startDate.setUTCDate(1); // Start from 1st of current month\n        startDate.setUTCHours(0, 0, 0, 0);\n        \n        const endDate = new Date(today);\n        endDate.setUTCDate(today.getUTCDate() + 31); // 31 days ahead\n        endDate.setUTCHours(23, 59, 59, 999);\n        \n        const generatedTasks = await this.generateTasksForDateRange(startDate, endDate);\n        \n        // Tasks are now written directly to DatabaseStorage via createTask()\n        if (generatedTasks.length > 0) {\n          console.log(`‚úÖ Successfully created ${generatedTasks.length} tasks in database`);\n        }\n        \n        await this.setSystemStatus({\n          id: 'task-generation-status',\n          lastGenerationDate: todayStr,\n          generatedThrough: this.formatDate(endDate),\n          lastUpdateBy: userId\n        });\n        \n        console.log('‚úÖ Task generation complete');\n      } else {\n        console.log(`‚úÖ Task generation up to date (last run: ${lastRunDate})`);\n      }\n    } finally {\n      await this.releaseLock('task-generation-lock');\n    }\n  }\n\n  // Helper methods for the new system\n  private formatDate(date: Date): string {\n    return `${date.getUTCFullYear()}-${String(date.getUTCMonth() + 1).padStart(2, '0')}-${String(date.getUTCDate()).padStart(2, '0')}`;\n  }\n\n  private async taskExists(taskId: string): Promise<boolean> {\n    // For string-based IDs from the new system, we need to check differently\n    return Array.from(this.tasks.values()).some(task => {\n      if (!task.dueDate) return false;\n      const dueDate = task.dueDate instanceof Date ? task.dueDate : new Date(task.dueDate);\n      return `${task.recurringTaskId}-${this.formatDate(dueDate)}` === taskId;\n    });\n  }\n\n  private async taskExistsForDateComposite(recurringTaskId: number, targetDate: Date): Promise<boolean> {\n    // Check if a task already exists for this recurring task ID and date\n    return Array.from(this.tasks.values()).some(task => {\n      if (!task.dueDate || task.recurringTaskId !== recurringTaskId) return false;\n      \n      const taskDate = task.dueDate instanceof Date ? task.dueDate : new Date(task.dueDate);\n      const checkDate = new Date(targetDate);\n      \n      // Use UTC comparison to avoid timezone issues\n      return taskDate.getUTCFullYear() === checkDate.getUTCFullYear() &&\n             taskDate.getUTCMonth() === checkDate.getUTCMonth() &&\n             taskDate.getUTCDate() === checkDate.getUTCDate();\n    });\n  }\n\n  private async saveTask(task: Task): Promise<void> {\n    console.log(`üîç SAVE TASK DEBUG: Adding task ${task.id} (${task.title}) to in-memory cache. Cache size before: ${this.tasks.size}`);\n    this.tasks.set(task.id, task);\n    console.log(`üîç SAVE TASK DEBUG: Cache size after: ${this.tasks.size}`);\n  }\n\n  // CONTINUOUS VERIFICATION SYSTEM - Self-healing task management\n  public async verifyAndHealTasks(): Promise<{ created: number; updated: number; errors: string[] }> {\n    console.log('=== TASK VERIFICATION STARTING ===');\n    \n    const today = new Date();\n    today.setUTCHours(0, 0, 0, 0);\n    \n    // Start from beginning of current biweekly period to catch current tasks\n    const startDate = new Date(today);\n    startDate.setUTCDate(1); // Start from 1st of current month\n    startDate.setUTCHours(0, 0, 0, 0);\n    \n    const endDate = new Date(today);\n    endDate.setUTCDate(today.getUTCDate() + 31); // 31 days ahead\n    endDate.setUTCHours(23, 59, 59, 999);\n    \n    const templates = Array.from(this.recurringTasks.values()).filter(t => t.isActive);\n    const existingTasks = Array.from(this.tasks.values());\n    \n    let created = 0;\n    let updated = 0;\n    const errors: string[] = [];\n    \n    console.log(`üîç Verifying tasks from ${this.formatDate(startDate)} to ${this.formatDate(endDate)}`);\n    console.log(`üîç Found ${templates.length} active templates, ${existingTasks.length} existing tasks`);\n    \n    // Check each day in our window - direct date iteration to avoid off-by-one\n    for (let checkDate = new Date(startDate); checkDate <= endDate; checkDate.setUTCDate(checkDate.getUTCDate() + 1)) {\n      checkDate = new Date(checkDate); // Create new instance for each iteration\n      \n      for (const template of templates) {\n        try {\n          const expectedTasks = this.getExpectedTasksForDate(template, checkDate);\n          \n          for (const expected of expectedTasks) {\n            const existingTask = existingTasks.find(t => \n              t.recurringTaskId === expected.recurringTaskId && \n              t.dueDate && \n              expected.dueDate &&\n              this.isSameDate(safeDate(t.dueDate)!, safeDate(expected.dueDate)!)\n            );\n            \n            // Check LIVE task state, not snapshot, to avoid repeated creations\n            const existingTaskLive = Array.from(this.tasks.values()).find(t => \n              t.recurringTaskId === expected.recurringTaskId && \n              t.dueDate && \n              expected.dueDate &&\n              this.isSameDate(safeDate(t.dueDate)!, safeDate(expected.dueDate)!)\n            );\n            \n            if (!existingTaskLive) {\n              try {\n                // Task is missing - create it using proper storage layer\n                // Remove ID to let database generate it\n                const { id, ...taskWithoutId } = expected;\n                const createdTask = await storage.createTask(taskWithoutId);\n                this.tasks.set(createdTask.id, createdTask);\n                created++;\n                console.log(`‚úÖ Created missing task: ${expected.title} for ${this.formatDate(checkDate)}`);\n              } catch (error) {\n                const errorMsg = `Failed to create task ${expected.title}: ${error}`;\n                errors.push(errorMsg);\n                console.log(`‚ùå ${errorMsg}`);\n              }\n            } else if (existingTaskLive.status === 'pending') {\n              // Task exists but might be outdated - verify it matches template\n              // IMPORTANT: Don't update tasks due today or in the past - users are working on them\n              const taskDueDate = new Date(existingTaskLive.dueDate!);\n              const isToday = this.isSameDate(taskDueDate, today);\n              const isPast = taskDueDate < today;\n              \n              if (!isToday && !isPast && this.taskNeedsUpdate(existingTaskLive, template)) {\n                try {\n                  // Only pass updateable fields to avoid date serialization issues\n                  const updateFields = this.extractTemplateFields(template);\n                  await storage.updateTask(existingTaskLive.id, updateFields);\n                  \n                  // Update in-memory cache with merged data\n                  const updatedTask = { ...existingTaskLive, ...updateFields };\n                  this.tasks.set(existingTaskLive.id, updatedTask);\n                  updated++;\n                  console.log(`üîÑ Updated outdated task: ${existingTaskLive.title}`);\n                } catch (error) {\n                  const errorMsg = `Failed to update task ${existingTaskLive.title}: ${error}`;\n                  errors.push(errorMsg);\n                  console.log(`‚ùå ${errorMsg}`);\n                }\n              } else if (isToday || isPast) {\n                console.log(`‚ö†Ô∏è Skipping update for current/past task: ${existingTaskLive.title} (due: ${this.formatDate(taskDueDate)})`);\n              }\n            }\n          }\n        } catch (error) {\n          const errorMsg = `Error processing template ${template.title} for ${this.formatDate(checkDate)}: ${error}`;\n          errors.push(errorMsg);\n          console.log(`‚ùå ${errorMsg}`);\n        }\n      }\n    }\n    \n    console.log(`üéâ Verification complete: Created ${created}, Updated ${updated}, Errors: ${errors.length}`);\n    if (errors.length > 0) {\n      console.log(`‚ùå Errors encountered:`, errors.slice(0, 5));\n    }\n    \n    return { created, updated, errors };\n  }\n\n  // Expected task calculator - determines what tasks SHOULD exist for any given date\n  private getExpectedTasksForDate(template: RecurringTask, checkDate: Date): Task[] {\n    const tasks: Task[] = [];\n    const dayOfMonth = checkDate.getUTCDate();\n    const month = checkDate.getUTCMonth();\n    const year = checkDate.getUTCFullYear();\n    const dayOfWeek = checkDate.getUTCDay(); // 0 = Sunday, 1 = Monday, etc.\n    const dayName = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'][dayOfWeek];\n    \n    // Daily tasks - check if should run on this day\n    if (template.frequency === 'daily') {\n      // For daily tasks, check if specific days are selected\n      const selectedDays = Array.isArray(template.daysOfWeek) \n        ? template.daysOfWeek \n        : (template.daysOfWeek ? [template.daysOfWeek] : []);\n        \n      if (selectedDays.length > 0) {\n        const shouldGenerate = selectedDays.includes(dayName);\n        if (shouldGenerate) {\n          tasks.push(this.createTaskFromTemplate(template, checkDate, checkDate));\n        }\n      } else {\n        // FIXED: No specific days selected means NO GENERATION (not every day)\n        console.log(`‚è≠Ô∏è Skipping daily task \"${template.title}\" - no days specified`);\n      }\n    }\n    \n    // Weekly tasks - only on specific days\n    else if (template.frequency === 'weekly') {\n      const daysOfWeek = Array.isArray(template.daysOfWeek) \n        ? template.daysOfWeek \n        : (template.daysOfWeek ? [template.daysOfWeek] : []);\n      \n      // Check if this day of week should have this task\n      const shouldGenerate = daysOfWeek.some(day => {\n        if (typeof day === 'string') {\n          return day.toLowerCase() === dayName;\n        } else if (typeof day === 'number') {\n          return day === dayOfWeek;\n        }\n        return false;\n      });\n      \n      if (shouldGenerate) {\n        tasks.push(this.createTaskFromTemplate(template, checkDate, checkDate));\n      }\n    }\n    \n    // Monthly: Should exist from 1st through end of month\n    else if (template.frequency === 'monthly') {\n      // If we're anywhere in the month, the monthly task should exist\n      if (dayOfMonth >= 1) {\n        const firstOfMonth = new Date(Date.UTC(year, month, 1, 12, 0, 0));\n        const lastOfMonth = new Date(Date.UTC(year, month + 1, 0, 12, 0, 0));\n        \n        tasks.push(this.createTaskFromTemplate(template, firstOfMonth, lastOfMonth));\n      }\n    }\n    \n    // Bi-Weekly: Two tasks per month\n    else if (template.frequency === 'biweekly') {\n      // First half task exists from 1st-14th\n      if (dayOfMonth >= 1 && dayOfMonth <= 14) {\n        const firstOfMonth = new Date(Date.UTC(year, month, 1, 12, 0, 0));\n        const midMonth = new Date(Date.UTC(year, month, 14, 12, 0, 0));\n        tasks.push(this.createTaskFromTemplate(template, firstOfMonth, midMonth));\n      }\n      \n      // Second half task exists from 15th-end\n      if (dayOfMonth >= 15) {\n        const midMonth = new Date(Date.UTC(year, month, 15, 12, 0, 0));\n        const lastDay = new Date(Date.UTC(year, month + 1, 0, 12, 0, 0));\n        tasks.push(this.createTaskFromTemplate(template, midMonth, lastDay));\n      }\n    }\n    \n    // Quarterly: Entire quarter\n    else if (template.frequency === 'quarterly') {\n      const currentQuarter = Math.floor(month / 3);\n      const quarterStart = new Date(Date.UTC(year, currentQuarter * 3, 1, 12, 0, 0));\n      const quarterEnd = new Date(Date.UTC(year, (currentQuarter + 1) * 3, 0, 12, 0, 0));\n      \n      // If we're in this quarter, task should exist\n      if (checkDate >= quarterStart && checkDate <= quarterEnd) {\n        tasks.push(this.createTaskFromTemplate(template, quarterStart, quarterEnd));\n      }\n    }\n    \n    return tasks;\n  }\n\n  // Helper to create a task from a template\n  private createTaskFromTemplate(template: RecurringTask, visibleDate: Date, dueDate: Date): Task {\n    // Don't assign ID here - let storage layer handle it to avoid conflicts\n    return {\n      id: 0, // Temporary ID, will be assigned by storage layer\n      title: template.title,\n      description: template.description || '',\n      type: template.type,\n      status: 'pending',\n      priority: 'medium',\n      assignedTo: null, // Legacy field - use assignTo instead\n      assignTo: template.assignTo,\n      createdBy: template.createdBy,\n      location: template.location,\n      estimatedTime: null,\n      actualTime: null,\n      progress: 0,\n      checklist: template.checklistTemplate?.steps?.map((step, index) => ({\n        id: `${index + 1}`,\n        text: step.label || step.text || '',\n        completed: false,\n        required: step.required || false,\n        type: step.type\n      })) || [],\n      data: {},\n      taskDate: visibleDate, // Add required taskDate field\n      dueDate: dueDate,\n      visibleFromDate: visibleDate,\n      startedAt: null,\n      completedAt: null,\n      pausedAt: null,\n      resumedAt: null,\n      skippedAt: null,\n      skipReason: null,\n      isRecurring: true,\n      recurringTaskId: template.id,\n      frequency: template.frequency, // Add required frequency field\n      isFromDeletedRecurring: false,\n      deletedRecurringTaskTitle: null,\n      // Update propagation tracking fields\n      templateVersion: template.versionNumber || 1,\n      isModifiedAfterCreation: false,\n      modifiedFromTemplateAt: null,\n      createdAt: new Date()\n    };\n  }\n\n  // Check if a task needs updating based on template changes\n  private taskNeedsUpdate(existingTask: Task, template: RecurringTask): boolean {\n    return (\n      existingTask.title !== template.title ||\n      existingTask.description !== template.description ||\n      existingTask.assignTo !== template.assignTo\n    );\n  }\n\n  // Extract fields from template for updating (safe date handling)\n  private extractTemplateFields(template: RecurringTask) {\n    return {\n      title: template.title,\n      description: template.description || '',\n      type: template.type,\n      assignTo: template.assignTo,\n      // Don't include dates in updates - preserve existing dates\n      // Don't include IDs - preserve existing IDs\n    };\n  }\n\n  // Utility to check if two dates are the same day\n  private isSameDate(date1: Date, date2: Date): boolean {\n    return date1.getUTCFullYear() === date2.getUTCFullYear() &&\n           date1.getUTCMonth() === date2.getUTCMonth() &&\n           date1.getUTCDate() === date2.getUTCDate();\n  }\n\n  // ===== CONTINUOUS VERIFICATION SYSTEM =====\n  \n  private verificationTimer: NodeJS.Timeout | null = null;\n  private verificationLock: Map<string, { userId: number; expiresAt: Date }> = new Map();\n\n  // Setup continuous verification with all features from user document\n  setupContinuousVerification() {\n    console.log('üîß Setting up continuous verification system...');\n    \n    // Run verification every 30 minutes as requested\n    this.verificationTimer = setInterval(async () => {\n      await this.initializeAppVerification();\n    }, 30 * 60 * 1000); // 30 minutes\n\n    // Run initial verification\n    setTimeout(() => this.initializeAppVerification(), 5000);\n    \n    console.log('‚úÖ Continuous verification system initialized');\n  }\n\n  // Initialize app verification with locking (from user document)\n  private async initializeAppVerification(userId: number = 1): Promise<void> {\n    // Check if verification is needed (from user document logic)\n    const lastRun = await this.getLastVerificationRun();\n    const now = new Date();\n    \n    // Run if never run or more than 30 minutes old\n    if (!lastRun || (now.getTime() - lastRun.getTime()) > 30 * 60 * 1000) {\n      // Acquire lock to prevent concurrent runs\n      const lockAcquired = await this.acquireVerificationLock(userId);\n      \n      if (lockAcquired) {\n        try {\n          console.log('üîÑ Running 30-minute verification check...');\n          await this.verifyAndHealTasks();\n          \n          // Update last run time\n          await this.setLastVerificationRun(now, userId);\n        } finally {\n          await this.releaseVerificationLock();\n        }\n      } else {\n        console.log('‚è≥ Another user is handling verification');\n      }\n    }\n  }\n\n  // Simple lock mechanism (from user document)\n  private async acquireVerificationLock(userId: number): Promise<boolean> {\n    const lockId = 'continuous-verification';\n    const now = new Date();\n    const existingLock = this.verificationLock.get(lockId);\n    \n    // Check if lock exists and hasn't expired\n    if (existingLock && existingLock.expiresAt > now) {\n      return false; // Lock is held by another user\n    }\n    \n    // Acquire lock with 5 minute expiry\n    const expiresAt = new Date(Date.now() + 5 * 60 * 1000);\n    this.verificationLock.set(lockId, { userId, expiresAt });\n    return true;\n  }\n\n  private async releaseVerificationLock(): Promise<void> {\n    this.verificationLock.delete('continuous-verification');\n  }\n\n  // Track last verification run\n  private lastVerificationRun: Date | null = null;\n  \n  private async getLastVerificationRun(): Promise<Date | null> {\n    return this.lastVerificationRun;\n  }\n  \n  private async setLastVerificationRun(date: Date, userId: number): Promise<void> {\n    this.lastVerificationRun = date;\n    console.log(`‚úÖ Verification completed by user ${userId} at ${date.toISOString()}`);\n  }\n\n  // Cleanup method\n  cleanup() {\n    if (this.verificationTimer) {\n      clearInterval(this.verificationTimer);\n      this.verificationTimer = null;\n    }\n  }\n\n  // BLUEPRINT: New Recurring Task Handling - Generate current period task immediately\n  async handleNewRecurringTask(template: RecurringTask): Promise<void> {\n    console.log(`üÜï HANDLING NEW RECURRING TASK: ${template.title}`);\n    \n    const today = new Date();\n    today.setHours(0, 0, 0, 0);\n    \n    let tasksCreated = 0;\n    \n    // Check if we need to generate current period task\n    const currentPeriodTask = await this.getCurrentPeriodTask(template, today);\n    if (currentPeriodTask) {\n      // CRITICAL FIX: Use the same storage singleton that the API reads from\n      await storage.createTask(currentPeriodTask);\n      tasksCreated++;\n      console.log(`‚úÖ Created current period task for: ${template.title}`);\n    }\n    \n    // Generate future tasks 31 days ahead\n    const tomorrow = new Date(today);\n    tomorrow.setDate(today.getDate() + 1);\n    const endDate = new Date(today);\n    endDate.setUTCDate(today.getUTCDate() + 31); // 31 days ahead\n    endDate.setUTCHours(23, 59, 59, 999);\n    \n    const futureTasks = await this.generateTasksForDateRange(tomorrow, endDate, template);\n    tasksCreated += futureTasks.length;\n    \n    // Tasks are now written directly to DatabaseStorage via createTask()\n    if (tasksCreated > 0) {\n      console.log(`‚úÖ Successfully created ${tasksCreated} tasks in database for: ${template.title}`);\n    }\n    \n    console.log(`‚úÖ Generated ${tasksCreated} tasks for: ${template.title}`);\n  }\n\n  // BLUEPRINT: Get Current Period Task\n  private async getCurrentPeriodTask(template: RecurringTask, today: Date): Promise<Task | null> {\n    const dayOfMonth = today.getDate();\n    const month = today.getMonth();\n    const year = today.getFullYear();\n    \n    switch (template.frequency) {\n      case 'monthly':\n        // If we're past the 1st, still create this month's task\n        const lastDay = new Date(Date.UTC(year, month + 1, 0));\n        return this.createTaskFromTemplate(template, new Date(Date.UTC(year, month, 1)), lastDay);\n        \n      case 'biweekly':\n        if (dayOfMonth <= 14) {\n          // First period\n          return this.createTaskFromTemplate(template, new Date(Date.UTC(year, month, 1)), new Date(Date.UTC(year, month, 14)));\n        } else {\n          // Second period\n          const lastDay = new Date(Date.UTC(year, month + 1, 0));\n          return this.createTaskFromTemplate(template, new Date(Date.UTC(year, month, 15)), lastDay);\n        }\n        \n      case 'daily':\n        const dayName = today.toLocaleDateString('en-US', { weekday: 'long' }).toLowerCase();\n        if (template.daysOfWeek?.includes(dayName)) {\n          return this.createTaskFromTemplate(template, today, today);\n        }\n        break;\n    }\n    \n    return null;\n  }\n\n  // Legacy method for compatibility - now delegates to new system\n  private async ensureRecurringTaskInstances() {\n    console.log('=== LEGACY COMPATIBILITY: Delegating to new generation system ===');\n    await this.initializeGeneration();\n  }\n\n  private async persistData() {\n    await this.persistence.saveData({\n      tasks: Array.from(this.tasks.values()),\n      recurringTasks: Array.from(this.recurringTasks.values()),\n      inventoryItems: Array.from(this.inventoryItems.values()),\n      counters: {\n        currentTaskId: this.currentTaskId,\n        currentRecurringTaskId: this.currentRecurringTaskId,\n        currentInventoryId: this.currentInventoryId\n      }\n    });\n  }\n\n  private seedInitialData() {\n    // Create test users for course assignment testing\n    const testUsers = [\n      {\n        username: \"alex_martinez\",\n        name: \"Alex Martinez\", \n        role: \"technician\" as const,\n        isApproved: true,\n        location: \"K\"\n      },\n      {\n        username: \"dan_wilson\",\n        name: \"Dan Wilson\",\n        role: \"manager\" as const, \n        isApproved: true,\n        location: \"R\"\n      },\n      {\n        username: \"matt_carlson\", \n        name: \"Matt Carlson\",\n        role: \"corporate\" as const,\n        isApproved: true,\n        location: \"MKE\"\n      }\n    ];\n\n    testUsers.forEach(userData => {\n      const user: User = {\n        id: this.currentUserId++,\n        ...userData,\n        password: \"test123\", // Default password for testing\n        approved: userData.isApproved,\n        createdAt: new Date(),\n        location: userData.location || null\n      };\n      delete (user as any).isApproved; // Remove the temporary property\n      this.users.set(user.id, user);\n    });\n\n    // Create some sample notifications for testing\n    this.createNotification({\n      userId: 1, // Alex Martinez\n      type: 'course_assigned',\n      title: 'New Training Course Assigned',\n      message: 'Dan Wilson assigned you \"Basic Safety & Orientation\" training',\n      relatedId: 1,\n      relatedType: 'course',\n      isRead: false\n    });\n\n    this.createNotification({\n      userId: 1, // Alex Martinez \n      type: 'task_overdue',\n      title: 'Task Overdue',\n      message: 'Seeding Task for Microgreens is now overdue',\n      relatedId: 1,\n      relatedType: 'task',\n      isRead: false\n    });\n\n    this.createNotification({\n      userId: 2, // Dan Wilson (Manager)\n      type: 'inventory_low',\n      title: 'Low Stock Alert',\n      message: 'Broccoli Seeds is running low (Current: 45 units)',\n      relatedId: 1,\n      relatedType: 'inventory',\n      isRead: false\n    });\n  }\n\n  private seedLocationData() {\n    // Create location-specific tasks\n    const today = new Date();\n    const tomorrow = new Date();\n    tomorrow.setDate(today.getDate() + 1);\n    const yesterday = new Date();\n    yesterday.setDate(today.getDate() - 1);\n\n    // Kenosha tasks\n    const kenoshaTasks = [\n      {\n        title: \"Seed Arugula Trays\",\n        description: \"Plant arugula seeds in designated trays for microgreens production\",\n        type: \"seeding-microgreens\",\n        status: \"in_progress\",\n        priority: \"high\",\n        assignedTo: 1,\n        createdBy: 2,\n        location: \"K\",\n        estimatedTime: 180,\n        actualTime: 135,\n        progress: 60,\n        checklist: [\n          { id: \"1\", text: \"Prepare seed trays\", completed: true },\n          { id: \"2\", text: \"Fill with growing medium\", completed: true },\n          { id: \"3\", text: \"Plant arugula seeds\", completed: true },\n          { id: \"4\", text: \"Label trays with date\", completed: false },\n          { id: \"5\", text: \"Place in germination area\", completed: false }\n        ] as ChecklistItem[],\n        startedAt: new Date(Date.now() - 2 * 60 * 60 * 1000),\n        completedAt: null,\n        dueDate: today\n      },\n      {\n        title: \"Remove Covers - Microgreens\",\n        description: \"Day 2 blackout removal for proper stem height\",\n        type: \"blackout-tasks\",\n        status: \"pending\",\n        priority: \"high\",\n        assignedTo: 1,\n        createdBy: 2,\n        location: \"K\",\n        estimatedTime: 45,\n        actualTime: null,\n        progress: 0,\n        checklist: [\n          { id: \"1\", text: \"Check seedling height\", completed: false },\n          { id: \"2\", text: \"Remove blackout covers\", completed: false },\n          { id: \"3\", text: \"Adjust lighting schedule\", completed: false }\n        ] as ChecklistItem[],\n        startedAt: null,\n        completedAt: null,\n        dueDate: yesterday\n      }\n    ];\n\n    // Racine tasks\n    const racineTasks = [\n      {\n        title: \"Harvest Spinach\",\n        description: \"Harvest mature spinach plants in leafy greens section\",\n        type: \"harvest-leafy-greens\",\n        status: \"pending\",\n        priority: \"medium\",\n        assignedTo: 1,\n        createdBy: 2,\n        location: \"R\",\n        estimatedTime: 150,\n        actualTime: null,\n        progress: 0,\n        checklist: [\n          { id: \"1\", text: \"Check plant maturity\", completed: false },\n          { id: \"2\", text: \"Harvest plants\", completed: false, dataCollection: { type: \"number\", label: \"Weight (lbs)\" } },\n          { id: \"3\", text: \"Clean harvested area\", completed: false }\n        ] as ChecklistItem[],\n        startedAt: null,\n        completedAt: null,\n        dueDate: tomorrow\n      },\n      {\n        title: \"Clean Tower Systems\",\n        description: \"Full sanitization of tower systems\",\n        type: \"cleaning\",\n        status: \"completed\",\n        priority: \"medium\",\n        assignedTo: 1,\n        createdBy: 2,\n        location: null,\n        estimatedTime: 120,\n        actualTime: 105,\n        progress: 100,\n        checklist: [\n          { id: \"1\", text: \"Sanitize towers\", completed: true },\n          { id: \"2\", text: \"Clean water systems\", completed: true },\n          { id: \"3\", text: \"Replace filters\", completed: true }\n        ] as ChecklistItem[],\n        completedAt: new Date(Date.now() - 1 * 60 * 60 * 1000), // 1 hour ago\n        dueDate: yesterday // Was due yesterday but completed\n      },\n      {\n        title: \"Check Nutrient Levels\",\n        description: \"Monitor and adjust nutrient solution pH and EC levels\",\n        type: \"nutrient-monitoring\",\n        status: \"pending\",\n        priority: \"high\",\n        assignedTo: 1,\n        createdBy: 2,\n        location: null,\n        estimatedTime: 60,\n        actualTime: null,\n        progress: 0,\n        checklist: [\n          { id: \"1\", text: \"Test pH levels\", completed: false },\n          { id: \"2\", text: \"Test EC levels\", completed: false },\n          { id: \"3\", text: \"Adjust if needed\", completed: false },\n          { id: \"4\", text: \"Record readings\", completed: false }\n        ] as ChecklistItem[],\n        startedAt: null,\n        completedAt: null,\n        dueDate: new Date(Date.now() - 2 * 60 * 60 * 1000) // 2 hours ago (OVERDUE)\n      },\n      {\n        title: \"Inventory Count - Seeds\",\n        description: \"Count and update seed inventory levels\",\n        type: \"inventory-count\",\n        status: \"pending\",\n        priority: \"medium\",\n        assignedTo: 1,\n        createdBy: 2,\n        location: null,\n        estimatedTime: 90,\n        actualTime: null,\n        progress: 0,\n        checklist: [\n          { id: \"1\", text: \"Count arugula seeds\", completed: false },\n          { id: \"2\", text: \"Count pea seeds\", completed: false },\n          { id: \"3\", text: \"Count radish seeds\", completed: false },\n          { id: \"4\", text: \"Update inventory system\", completed: false }\n        ] as ChecklistItem[],\n        startedAt: null,\n        completedAt: null,\n        dueDate: new Date(Date.now() - 4 * 60 * 60 * 1000) // 4 hours ago (OVERDUE)\n      },\n      {\n        title: \"Clean Tower Systems\",\n        description: \"Full sanitization of tower systems\",\n        type: \"cleaning\",\n        status: \"completed\",\n        priority: \"medium\",\n        assignedTo: 1,\n        createdBy: 2,\n        location: \"R\",\n        estimatedTime: 120,\n        actualTime: 105,\n        progress: 100,\n        checklist: [\n          { id: \"1\", text: \"Sanitize towers\", completed: true },\n          { id: \"2\", text: \"Clean water systems\", completed: true },\n          { id: \"3\", text: \"Replace filters\", completed: true }\n        ] as ChecklistItem[],\n        completedAt: new Date(Date.now() - 1 * 60 * 60 * 1000),\n        dueDate: yesterday\n      }\n    ];\n\n    // Create tasks for both locations\n    const allTasks = [...kenoshaTasks, ...racineTasks];\n    \n    allTasks.forEach(task => {\n      const newTask: Task = {\n        ...task,\n        id: this.currentTaskId++,\n        data: {},\n        dueDate: task.dueDate || new Date(Date.now() + 24 * 60 * 60 * 1000),\n        // Update propagation tracking fields\n        templateVersion: 1,\n        isModifiedAfterCreation: false,\n        modifiedFromTemplateAt: null,\n        createdAt: new Date(),\n        description: task.description || null,\n        estimatedTime: task.estimatedTime || null,\n        actualTime: task.actualTime || null,\n        progress: task.progress || 0,\n        checklist: task.checklist || null,\n        // Add missing required fields\n        assignTo: task.assignedTo ? `user_${task.assignedTo}` : null,\n        taskDate: task.dueDate || new Date(),\n        visibleFromDate: task.dueDate || new Date(),\n        pausedAt: null,\n        resumedAt: null,\n        skippedAt: null,\n        skipReason: null,\n        isRecurring: task.isRecurring || false,\n        recurringTaskId: task.recurringTaskId || null,\n        frequency: task.frequency || null,\n        isFromDeletedRecurring: false,\n        deletedRecurringTaskTitle: null,\n        startedAt: task.startedAt || null,\n        completedAt: task.completedAt || null,\n        assignedTo: task.assignedTo || null,\n        createdBy: task.createdBy || null,\n        priority: task.priority || null\n      };\n      this.tasks.set(newTask.id, newTask);\n    });\n\n    // Create location-based inventory items\n    const kenoshaInventory = [\n      { \n        name: \"Arugula Seeds\", \n        category: \"seeds\", \n        currentStock: 450, \n        minimumStock: 100, \n        unit: \"grams\", \n        supplier: \"Green Thumb Seeds\",\n        productCode: \"ARU\",\n        ozPerTray: 0.5,\n        cropId: 1,\n        location: \"K\"\n      },\n      { \n        name: \"Broccoli Microgreen Seeds\", \n        category: \"seeds\", \n        currentStock: 800, \n        minimumStock: 150, \n        unit: \"grams\", \n        supplier: \"Green Thumb Seeds\",\n        productCode: \"BROC\",\n        ozPerTray: 1.0,\n        cropId: 3,\n        location: \"K\"\n      },\n      { \n        name: \"Growing Medium\", \n        category: \"supplies\", \n        currentStock: 80, \n        minimumStock: 40, \n        unit: \"kg\", \n        supplier: \"Farm Supply Plus\",\n        productCode: \"GROW-MED\",\n        ozPerTray: null,\n        cropId: null,\n        location: \"K\"\n      }\n    ];\n\n    const racineInventory = [\n      { \n        name: \"Romaine Seeds\", \n        category: \"seeds\", \n        currentStock: 1200, \n        minimumStock: 200, \n        unit: \"grams\", \n        supplier: \"Green Thumb Seeds\",\n        productCode: \"ROM\",\n        ozPerTray: 0.75,\n        cropId: 2,\n        location: \"R\"\n      },\n      { \n        name: \"Spinach Seeds\", \n        category: \"seeds\", \n        currentStock: 25, \n        minimumStock: 30, \n        unit: \"grams\", \n        supplier: \"Green Thumb Seeds\",\n        productCode: \"SPI\",\n        ozPerTray: 0.6,\n        cropId: 5,\n        location: \"R\"\n      },\n      { \n        name: \"Nutrient Solution A\", \n        category: \"nutrients\", \n        currentStock: 45, \n        minimumStock: 20, \n        unit: \"liters\", \n        supplier: \"Hydro Nutrients Co\",\n        productCode: \"NUT-A\",\n        ozPerTray: null,\n        cropId: null,\n        location: \"R\"\n      }\n    ];\n\n    const allInventory = [...kenoshaInventory, ...racineInventory];\n\n    allInventory.forEach(item => {\n      const newItem: InventoryItem = {\n        ...item,\n        id: this.currentInventoryId++,\n        lastRestocked: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000), // 7 days ago\n        createdAt: new Date(),\n        currentStock: item.currentStock || null,\n        minimumStock: item.minimumStock || null,\n        supplier: item.supplier || null,\n        totalValue: null,\n        avgCostPerUnit: null\n      };\n      this.inventoryItems.set(newItem.id, newItem);\n    });\n\n    // Create location-based growing systems\n    const kenoshaGrowingSystems = [\n      {\n        name: 'Kenosha Microgreen Nursery A',\n        type: 'microgreen',\n        category: 'nursery',\n        capacity: 120,\n        currentOccupancy: 75,\n        systemData: {\n          sections: {\n            'A1': { capacity: 60, occupied: ['MG-001', 'MG-002', 'MG-003'] },\n            'A2': { capacity: 60, occupied: ['MG-004', 'MG-005'] }\n          }\n        },\n        isActive: true,\n        location: \"K\"\n      },\n      {\n        name: 'Kenosha Blackout System',\n        type: 'microgreen',\n        category: 'blackout',\n        capacity: 100,\n        currentOccupancy: 45,\n        systemData: {\n          sections: {\n            'B1': { capacity: 50, occupied: ['BL-001', 'BL-002'] },\n            'B2': { capacity: 50, occupied: ['BL-003'] }\n          }\n        },\n        isActive: true,\n        location: \"K\"\n      }\n    ];\n\n    const racineGrowingSystems = [\n      {\n        name: 'Racine Tower System B',\n        type: 'leafy-green',\n        category: 'final',\n        capacity: 176,\n        currentOccupancy: 88,\n        systemData: {\n          units: [\n            { id: 'B1', type: 'regular', totalPorts: 44, occupiedPorts: ['LG-001', 'LG-002'] },\n            { id: 'B2', type: 'regular', totalPorts: 44, occupiedPorts: ['LG-003', 'LG-004'] },\n            { id: 'B3', type: 'HD', totalPorts: 176, occupiedPorts: ['LG-005', 'LG-006'] }\n          ]\n        },\n        isActive: true,\n        location: \"R\"\n      },\n      {\n        name: 'Racine Ebb & Flow System C',\n        type: 'leafy-green',\n        category: 'staging',\n        capacity: 100,\n        currentOccupancy: 45,\n        systemData: {\n          channels: [\n            { id: 1, capacity: 20, crop: 'Romaine', occupied: ['ROM-001', 'ROM-002'] },\n            { id: 2, capacity: 20, crop: 'Spinach', occupied: ['SPI-001'] },\n            { id: 3, capacity: 20, crop: null, occupied: [] },\n            { id: 4, capacity: 20, crop: 'Basil', occupied: ['BAS-001', 'BAS-002'] },\n            { id: 5, capacity: 20, crop: null, occupied: [] }\n          ]\n        },\n        isActive: true,\n        location: \"R\"\n      }\n    ];\n\n    const allGrowingSystems = [...kenoshaGrowingSystems, ...racineGrowingSystems];\n\n    allGrowingSystems.forEach(system => {\n      const newSystem: GrowingSystem = {\n        ...system,\n        id: this.currentGrowingSystemId++,\n        createdAt: new Date()\n      };\n      this.growingSystems.set(newSystem.id, newSystem);\n    });\n\n    // Create sample training modules\n    const sampleModules = [\n      {\n        title: \"Basic Seeding Techniques\",\n        description: \"Learn proper seeding procedures for various crops\",\n        category: \"operations\",\n        content: \"Comprehensive guide to seeding best practices...\",\n        duration: 30,\n        requiredForRole: \"technician\",\n        createdBy: 3\n      },\n      {\n        title: \"Harvest Quality Control\",\n        description: \"Quality standards and harvest timing\",\n        category: \"quality\",\n        content: \"Quality control procedures for harvesting...\",\n        duration: 45,\n        requiredForRole: \"technician\",\n        createdBy: 3\n      }\n    ];\n\n    sampleModules.forEach(module => {\n      const newModule: TrainingModule = {\n        ...module,\n        id: this.currentModuleId++,\n        createdAt: new Date(),\n        duration: module.duration || null,\n        description: module.description || null,\n        createdBy: module.createdBy || null,\n        requiredForRole: module.requiredForRole || null\n      };\n      this.trainingModules.set(newModule.id, newModule);\n    });\n\n    // Create recurring tasks for each location\n    const kenoshaRecurringTasks = [\n      {\n        title: \"Daily Seed Propagation\",\n        description: \"Daily microgreen seeding tasks\",\n        type: \"seeding-microgreens\",\n        frequency: \"daily\",\n        daysOfWeek: [1, 2, 3, 4, 5],\n        assignedTo: 1,\n        createdBy: 2,\n        location: \"K\",\n        isActive: true,\n        estimatedTime: 120,\n        nextOccurrence: new Date(Date.now() + 24 * 60 * 60 * 1000)\n      }\n    ];\n\n    const racineRecurringTasks = [\n      {\n        title: \"Weekly Harvest Check\",\n        description: \"Check all leafy greens for harvest readiness\",\n        type: \"harvest-leafy-greens\",\n        frequency: \"weekly\",\n        daysOfWeek: [1, 3, 5],\n        assignedTo: 1,\n        createdBy: 2,\n        location: \"R\",\n        isActive: true,\n        estimatedTime: 90,\n        nextOccurrence: new Date(Date.now() + 24 * 60 * 60 * 1000)\n      }\n    ];\n\n    const allRecurringTasks = [...kenoshaRecurringTasks, ...racineRecurringTasks];\n\n    allRecurringTasks.forEach(task => {\n      const newRecurringTask: RecurringTask = {\n        ...task,\n        id: this.currentRecurringTaskId++,\n        createdAt: new Date(),\n        checklistTemplate: null,\n        dayOfMonth: null,\n        automation: null,\n        // Add missing required fields for updated schema\n        assignTo: task.assignedTo ? `user_${task.assignedTo}` : null,\n        versionNumber: 1,\n        lastModifiedDate: new Date(),\n        lastModifiedBy: task.createdBy || null\n      };\n      this.recurringTasks.set(newRecurringTask.id, newRecurringTask);\n    });\n\n    // Note: Crops functionality removed - using existing data sources only\n    \n    // Initialize growing systems (separated for clarity)\n    this.initializeGrowingSystems();\n  }\n  \n  private initializeInventoryData() {\n    // Create location-based inventory items\n    const kenoshaInventory = [\n      { \n        name: \"Arugula Seeds\", \n        category: \"seeds\", \n        currentStock: 450, \n        minimumStock: 100, \n        unit: \"grams\", \n        supplier: \"Green Thumb Seeds\",\n        productCode: \"ARU\",\n        ozPerTray: 0.5,\n        cropId: 1,\n        location: \"K\"\n      },\n      { \n        name: \"Broccoli Microgreen Seeds\", \n        category: \"seeds\", \n        currentStock: 800, \n        minimumStock: 150, \n        unit: \"grams\", \n        supplier: \"Green Thumb Seeds\",\n        productCode: \"BROC\",\n        ozPerTray: 1.0,\n        cropId: 3,\n        location: \"K\"\n      },\n      { \n        name: \"Growing Medium\", \n        category: \"supplies\", \n        currentStock: 80, \n        minimumStock: 40, \n        unit: \"kg\", \n        supplier: \"Farm Supply Plus\",\n        productCode: \"GROW-MED\",\n        ozPerTray: null,\n        cropId: null,\n        location: \"K\"\n      }\n    ];\n\n    const racineInventory = [\n      { \n        name: \"Romaine Seeds\", \n        category: \"seeds\", \n        currentStock: 1200, \n        minimumStock: 200, \n        unit: \"grams\", \n        supplier: \"Green Thumb Seeds\",\n        productCode: \"ROM\",\n        ozPerTray: 0.75,\n        cropId: 2,\n        location: \"R\"\n      },\n      { \n        name: \"Spinach Seeds\", \n        category: \"seeds\", \n        currentStock: 25, \n        minimumStock: 30, \n        unit: \"grams\", \n        supplier: \"Green Thumb Seeds\",\n        productCode: \"SPI\",\n        ozPerTray: 0.6,\n        cropId: 5,\n        location: \"R\"\n      },\n      { \n        name: \"Nutrient Solution A\", \n        category: \"nutrients\", \n        currentStock: 45, \n        minimumStock: 20, \n        unit: \"liters\", \n        supplier: \"Hydro Nutrients Co\",\n        productCode: \"NUT-A\",\n        ozPerTray: null,\n        cropId: null,\n        location: \"R\"\n      }\n    ];\n\n    const allInventory = [...kenoshaInventory, ...racineInventory];\n\n    allInventory.forEach(item => {\n      const newItem: InventoryItem = {\n        ...item,\n        id: this.currentInventoryId++,\n        lastRestocked: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000), // 7 days ago\n        createdAt: new Date(),\n        currentStock: item.currentStock || null,\n        minimumStock: item.minimumStock || null,\n        supplier: item.supplier || null,\n        totalValue: null,\n        avgCostPerUnit: null\n      };\n      this.inventoryItems.set(newItem.id, newItem);\n    });\n    \n    console.log(`Initialized ${allInventory.length} inventory items`);\n  }\n  \n  private initializeGrowingSystems() {\n    // Create location-based growing systems\n    const kenoshaGrowingSystems = [\n      {\n        name: 'Kenosha Microgreen Nursery A',\n        type: 'microgreen',\n        category: 'nursery',\n        capacity: 120,\n        currentOccupancy: 75,\n        systemData: {\n          sections: {\n            'A1': { capacity: 60, occupied: ['MG-001', 'MG-002', 'MG-003'] },\n            'A2': { capacity: 60, occupied: ['MG-004', 'MG-005'] }\n          }\n        },\n        isActive: true,\n        location: \"K\"\n      },\n      {\n        name: 'Kenosha Blackout System',\n        type: 'microgreen',\n        category: 'blackout',\n        capacity: 100,\n        currentOccupancy: 45,\n        systemData: {\n          sections: {\n            'B1': { capacity: 50, occupied: ['BL-001', 'BL-002'] },\n            'B2': { capacity: 50, occupied: ['BL-003'] }\n          }\n        },\n        isActive: true,\n        location: \"K\"\n      }\n    ];\n\n    const racineGrowingSystems = [\n      {\n        name: 'Racine Tower System B',\n        type: 'leafy-green',\n        category: 'final',\n        capacity: 176,\n        currentOccupancy: 88,\n        systemData: {\n          units: [\n            { id: 'B1', type: 'regular', totalPorts: 44, occupiedPorts: ['LG-001', 'LG-002'] },\n            { id: 'B2', type: 'regular', totalPorts: 44, occupiedPorts: ['LG-003', 'LG-004'] },\n            { id: 'B3', type: 'HD', totalPorts: 176, occupiedPorts: ['LG-005', 'LG-006'] }\n          ]\n        },\n        isActive: true,\n        location: \"R\"\n      },\n      {\n        name: 'Racine Ebb & Flow System C',\n        type: 'leafy-green',\n        category: 'staging',\n        capacity: 100,\n        currentOccupancy: 45,\n        systemData: {\n          channels: [\n            { id: 1, capacity: 20, crop: 'Romaine', occupied: ['ROM-001', 'ROM-002'] },\n            { id: 2, capacity: 20, crop: 'Spinach', occupied: ['SPI-001'] },\n            { id: 3, capacity: 20, crop: null, occupied: [] },\n            { id: 4, capacity: 20, crop: 'Basil', occupied: ['BAS-001', 'BAS-002'] },\n            { id: 5, capacity: 20, crop: null, occupied: [] }\n          ]\n        },\n        isActive: true,\n        location: \"R\"\n      }\n    ];\n\n    const allGrowingSystems = [...kenoshaGrowingSystems, ...racineGrowingSystems];\n\n    allGrowingSystems.forEach(system => {\n      const newSystem: GrowingSystem = {\n        ...system,\n        id: this.currentGrowingSystemId++,\n        createdAt: new Date()\n      };\n      this.growingSystems.set(newSystem.id, newSystem);\n    });\n    \n    console.log(`Initialized ${allGrowingSystems.length} growing systems`)\n  }\n\n  // Get user by ID\n  async getUser(id: number): Promise<User | undefined> {\n    return this.users.get(id);\n  }\n\n  // Create user with username\n  async createUser(userData: InsertUser): Promise<User> {\n    const newUser: User = {\n      ...userData,\n      id: this.currentUserId++,\n      createdAt: new Date(),\n      approved: userData.approved || null\n    };\n    this.users.set(newUser.id, newUser);\n    return newUser;\n  }\n\n  // Get user by username\n  async getUserByUsername(username: string): Promise<User | null> {\n    return Array.from(this.users.values()).find(user => user.username === username) || null;\n  }\n\n  // Get all users\n  async getAllUsers(): Promise<User[]> {\n    return Array.from(this.users.values());\n  }\n\n  // Update user\n  async updateUser(id: number, updates: Partial<User>): Promise<User | null> {\n    const user = this.users.get(id);\n    if (!user) return null;\n\n    const updatedUser = { ...user, ...updates };\n    this.users.set(id, updatedUser);\n    return updatedUser;\n  }\n\n  // Tasks methods\n  async getAllTasks(): Promise<Task[]> {\n    if (process.env.DATABASE_URL) {\n      console.error('üö® CRITICAL: MemStorage.getAllTasks() called despite DATABASE_URL being set!');\n      console.error('üö® This should NOT happen - all task operations should go through DatabaseStorage');\n      return [];\n    }\n    return Array.from(this.tasks.values());\n  }\n\n  async getTasksByLocation(location: string): Promise<Task[]> {\n    return Array.from(this.tasks.values()).filter(task => task.location === location);\n  }\n\n  async getTasksByUser(userId: number): Promise<Task[]> {\n    // Return tasks assigned to the user OR unassigned tasks (assignedTo is null)\n    return Array.from(this.tasks.values()).filter(task => \n      task.assignedTo === userId || task.assignedTo === null\n    );\n  }\n\n  async getTask(id: number): Promise<Task | null> {\n    return this.tasks.get(id) || null;\n  }\n\n  async createTask(taskData: InsertTask): Promise<Task> {\n    const newTask: Task = {\n      ...taskData,\n      id: this.currentTaskId++,\n      createdAt: new Date(),\n      data: taskData.data || {},\n      visibleFromDate: null,\n      pausedAt: null,\n      resumedAt: null,\n      skippedAt: null,\n      skipReason: null,\n      completedBy: null,\n      approvedBy: null\n    };\n    this.tasks.set(newTask.id, newTask);\n    await this.persistence.saveTasks(Array.from(this.tasks.values()));\n    await this.persistence.saveCounters({\n      currentTaskId: this.currentTaskId,\n      currentRecurringTaskId: this.currentRecurringTaskId,\n      currentInventoryId: this.currentInventoryId\n    });\n    return newTask;\n  }\n\n  async updateTask(id: number, updates: Partial<Task>): Promise<Task | null> {\n    const task = this.tasks.get(id);\n    if (!task) return null;\n\n    const updatedTask = { ...task, ...updates };\n    this.tasks.set(id, updatedTask);\n    await this.persistence.saveTasks(Array.from(this.tasks.values()));\n    return updatedTask;\n  }\n\n  async deleteTask(id: number): Promise<boolean> {\n    return this.tasks.delete(id);\n  }\n\n  async resetTasks(): Promise<boolean> {\n    this.tasks.clear();\n    this.currentTaskId = 1;\n    return true;\n  }\n\n  async resetTaskSequence(): Promise<void> {\n    // For MemStorage, just reset the counter\n    this.currentTaskId = Math.max(...Array.from(this.tasks.keys()), 0) + 1;\n  }\n\n  // Inventory methods\n  async getInventoryItem(id: number): Promise<InventoryItem | undefined> {\n    return this.inventoryItems.get(id);\n  }\n\n  async getAllInventoryItems(): Promise<InventoryItem[]> {\n    return Array.from(this.inventoryItems.values());\n  }\n\n  async getInventoryItemsByLocation(location: string): Promise<InventoryItem[]> {\n    return Array.from(this.inventoryItems.values()).filter(item => item.location === location);\n  }\n\n  async getLowStockItems(): Promise<InventoryItem[]> {\n    return Array.from(this.inventoryItems.values()).filter(item => \n      item.currentStock !== null && item.minimumStock !== null && item.currentStock <= item.minimumStock\n    );\n  }\n\n  async getLowStockItemsByLocation(location: string): Promise<InventoryItem[]> {\n    return Array.from(this.inventoryItems.values()).filter(item => \n      item.location === location &&\n      item.currentStock !== null && item.minimumStock !== null && item.currentStock <= item.minimumStock\n    );\n  }\n\n  async createInventoryItem(itemData: InsertInventoryItem): Promise<InventoryItem> {\n    const newItem: InventoryItem = {\n      ...itemData,\n      id: this.currentInventoryId++,\n      createdAt: new Date(),\n      totalValue: null,\n      avgCostPerUnit: null\n    };\n    this.inventoryItems.set(newItem.id, newItem);\n    return newItem;\n  }\n\n  async updateInventoryItem(id: number, updates: Partial<InventoryItem>): Promise<InventoryItem | null> {\n    const item = this.inventoryItems.get(id);\n    if (!item) return null;\n\n    const updatedItem = { ...item, ...updates };\n    this.inventoryItems.set(id, updatedItem);\n    await this.persistence.saveInventoryItems(Array.from(this.inventoryItems.values()));\n    return updatedItem;\n  }\n\n  async deleteInventoryItem(id: number): Promise<boolean> {\n    return this.inventoryItems.delete(id);\n  }\n\n  async addInventoryStock(data: { itemId: number; quantity: number; unitCost: number; supplier?: string; notes?: string }): Promise<InventoryItem> {\n    const item = this.inventoryItems.get(data.itemId);\n    if (!item) {\n      throw new Error(\"Inventory item not found\");\n    }\n\n    // Calculate weighted average cost\n    const currentStock = item.currentStock || 0;\n    const currentAvgCost = item.avgCostPerUnit || 0;\n    const currentTotalValue = currentStock * currentAvgCost;\n    \n    const addedTotalValue = data.quantity * data.unitCost;\n    const newTotalStock = currentStock + data.quantity;\n    const newAvgCost = newTotalStock > 0 ? (currentTotalValue + addedTotalValue) / newTotalStock : 0;\n    const newTotalValue = newTotalStock * newAvgCost;\n\n    // Create transaction record\n    const transaction = {\n      itemId: data.itemId,\n      type: \"purchase\" as const,\n      quantity: data.quantity,\n      totalCost: addedTotalValue,\n      costPerUnit: data.unitCost,\n      runningStock: newTotalStock,\n      addedBy: 1, // Default user for now\n      notes: data.notes || `Added ${data.quantity} ${item.unit} at $${data.unitCost}/${item.unit}${data.supplier ? ` from ${data.supplier}` : ''}`,\n      createdAt: new Date()\n    };\n\n    // Update the inventory item\n    const updatedItem: InventoryItem = {\n      ...item,\n      currentStock: newTotalStock,\n      avgCostPerUnit: newAvgCost,\n      totalValue: newTotalValue,\n      supplier: data.supplier || item.supplier,\n      lastRestocked: new Date()\n    };\n\n    this.inventoryItems.set(data.itemId, updatedItem);\n    \n    console.log(`Inventory updated: ${item.name}`, {\n      oldStock: currentStock,\n      addedQuantity: data.quantity,\n      newStock: newTotalStock,\n      oldAvgCost: currentAvgCost,\n      newAvgCost: newAvgCost,\n      unitCost: data.unitCost,\n      transaction: transaction\n    });\n\n    // Persist inventory changes\n    await this.persistence.saveInventoryItems(Array.from(this.inventoryItems.values()));\n\n    return updatedItem;\n  }\n\n  // Training methods\n  async getAllTrainingModules(): Promise<TrainingModule[]> {\n    return Array.from(this.trainingModules.values());\n  }\n\n  async getTrainingModule(id: number): Promise<TrainingModule | null> {\n    return this.trainingModules.get(id) || null;\n  }\n\n  async createTrainingModule(moduleData: InsertTrainingModule): Promise<TrainingModule> {\n    const newModule: TrainingModule = {\n      ...moduleData,\n      id: this.currentModuleId++,\n      createdAt: new Date()\n    };\n    this.trainingModules.set(newModule.id, newModule);\n    return newModule;\n  }\n\n  // User progress methods\n  async getUserProgress(userId: number): Promise<UserProgress[]> {\n    return Array.from(this.userProgress.values()).filter(progress => progress.userId === userId);\n  }\n\n  async createUserProgress(progressData: InsertUserProgress): Promise<UserProgress> {\n    const newProgress: UserProgress = {\n      ...progressData,\n      id: this.currentProgressId++,\n      createdAt: new Date()\n    };\n    this.userProgress.set(newProgress.id, newProgress);\n    return newProgress;\n  }\n\n  async updateUserProgress(progressData: InsertUserProgress): Promise<UserProgress> {\n    // Find existing progress for this user/module combination\n    const existingKey = `${progressData.userId}-${progressData.moduleId}`;\n    const existingProgress = Array.from(this.userProgress.values()).find(p => \n      p.userId === progressData.userId && p.moduleId === progressData.moduleId\n    );\n\n    if (existingProgress) {\n      // Update existing progress\n      const updatedProgress = { ...existingProgress, ...progressData };\n      this.userProgress.set(existingProgress.id, updatedProgress);\n      return updatedProgress;\n    } else {\n      // Create new progress\n      const newProgress: UserProgress = {\n        ...progressData,\n        id: this.currentProgressId++\n      };\n      this.userProgress.set(newProgress.id, newProgress);\n      return newProgress;\n    }\n  }\n\n  // Task logs methods\n  async getTaskLogs(taskId: number): Promise<TaskLog[]> {\n    return Array.from(this.taskLogs.values()).filter(log => log.taskId === taskId);\n  }\n\n  async createTaskLog(logData: InsertTaskLog): Promise<TaskLog> {\n    const newLog: TaskLog = {\n      ...logData,\n      id: this.currentLogId++,\n      createdAt: new Date()\n    };\n    this.taskLogs.set(newLog.id, newLog);\n    return newLog;\n  }\n\n  // Recurring tasks methods\n  async getAllRecurringTasks(): Promise<RecurringTask[]> {\n    return Array.from(this.recurringTasks.values());\n  }\n\n  async getRecurringTask(id: number): Promise<RecurringTask | undefined> {\n    return this.recurringTasks.get(id);\n  }\n\n  async getRecurringTasksByLocation(location: string): Promise<RecurringTask[]> {\n    return Array.from(this.recurringTasks.values()).filter(task => task.location === location);\n  }\n\n  async createRecurringTask(taskData: any): Promise<RecurringTask> {\n    const newTask: RecurringTask = {\n      ...taskData,\n      id: this.currentRecurringTaskId++,\n      createdAt: new Date()\n    };\n    this.recurringTasks.set(newTask.id, newTask);\n    \n    // BLUEPRINT: Use new recurring task handling system\n    await this.handleNewRecurringTask(newTask);\n    \n    // Persist data after generating task instances\n    await this.persistData();\n    \n    return newTask;\n  }\n\n  // COMPREHENSIVE UPDATE PROPAGATION SYSTEM\n  async updateRecurringTask(id: number, updates: Partial<RecurringTask>, options?: { strategy?: 'update_all' | 'new_only'; userId?: number }): Promise<{ task: RecurringTask | null; report: any }> {\n    const originalTask = this.recurringTasks.get(id);\n    if (!originalTask) return { task: null, report: { error: 'Task not found' } };\n\n    // Step 1: Track what fields changed for audit trail\n    const changedFields = this.identifyChangedFields(originalTask, updates);\n    console.log(`üîç [UPDATE PROPAGATION] Changes detected:`, changedFields.map(f => f.field));\n\n    // Step 2: Increment version number for tracking\n    const newVersionNumber = (originalTask.versionNumber || 1) + 1;\n    \n    // Step 3: Create updated task with version tracking\n    const updatedTask = { \n      ...originalTask, \n      ...updates,\n      versionNumber: newVersionNumber,\n      lastModifiedDate: new Date(),\n      lastModifiedBy: options?.userId || null\n    };\n    this.recurringTasks.set(id, updatedTask);\n\n    // Step 4: Determine update strategy based on changes\n    const shouldRegenerateInstances = changedFields.some(f => \n      ['frequency', 'daysOfWeek', 'isActive'].includes(f.field)\n    );\n    \n    let propagationReport: any = {\n      strategy: shouldRegenerateInstances ? 'regenerate' : 'update_existing',\n      changedFields: changedFields,\n      versionNumber: newVersionNumber,\n      timestamp: new Date().toISOString()\n    };\n\n    // Step 5: Execute propagation strategy\n    if (shouldRegenerateInstances) {\n      propagationReport = await this.regenerateTaskInstancesStrategy(id, updatedTask, propagationReport);\n    } else {\n      propagationReport = await this.updateExistingInstancesStrategy(id, updatedTask, changedFields, propagationReport);\n    }\n\n    // Step 6: Log changes to audit trail\n    await this.logRecurringTaskChange({\n      recurringTaskId: id,\n      changedFields: changedFields,\n      changeTimestamp: new Date(),\n      changedByUser: userId || null,\n      affectedInstanceCount: propagationReport.processedInstances || 0,\n      strategyUsed: propagationReport.strategy\n    });\n\n    // Step 7: Persist all changes\n    await this.persistData();\n    \n    console.log(`‚úÖ [UPDATE PROPAGATION] Completed for task \"${updatedTask.title}\" - ${propagationReport.processedInstances} instances affected`);\n    \n    return { task: updatedTask, report: propagationReport };\n  }\n\n  // FIELD-BY-FIELD CHANGE TRACKING\n  private identifyChangedFields(original: RecurringTask, updates: any): Array<{ field: string; oldValue: any; newValue: any; requiresNotification: boolean }> {\n    const changes: Array<{ field: string; oldValue: any; newValue: any; requiresNotification: boolean }> = [];\n    \n    // Fields that require user notification when changed\n    const notificationRequiredFields = ['title', 'description', 'checklistTemplate', 'estimatedTime', 'priority', 'assignTo'];\n    \n    // Fields that should NOT affect existing instances (only new ones)\n    const nonPropagatingFields = ['frequency', 'daysOfWeek', 'isActive', 'nextOccurrence'];\n    \n    Object.keys(updates).forEach(field => {\n      if (JSON.stringify(original[field as keyof RecurringTask]) !== JSON.stringify(updates[field])) {\n        changes.push({\n          field,\n          oldValue: original[field as keyof RecurringTask],\n          newValue: updates[field],\n          requiresNotification: notificationRequiredFields.includes(field)\n        });\n      }\n    });\n    \n    return changes;\n  }\n\n  // REGENERATE INSTANCES STRATEGY (for frequency/schedule changes)\n  private async regenerateTaskInstancesStrategy(recurringTaskId: number, updatedTask: RecurringTask, report: any): Promise<any> {\n    console.log(`üîÑ [REGENERATE STRATEGY] Regenerating instances for recurring task: ${updatedTask.title}`);\n    \n    // Delete ONLY future pending task instances (preserve completed/in-progress tasks)\n    const taskIdsToDelete = Array.from(this.tasks.keys()).filter(taskId => {\n      const task = this.tasks.get(taskId);\n      return task?.recurringTaskId === recurringTaskId && \n             task?.status === 'pending' && \n             task?.dueDate && new Date(task.dueDate) >= new Date();\n    });\n    \n    // Batch delete for performance\n    taskIdsToDelete.forEach(taskId => this.tasks.delete(taskId));\n    \n    // Generate new task instances with updated schedule\n    await this.generateTaskInstances(updatedTask);\n    \n    return {\n      ...report,\n      deletedInstances: taskIdsToDelete.length,\n      processedInstances: taskIdsToDelete.length,\n      details: 'Regenerated all future pending instances with new schedule'\n    };\n  }\n\n  // UPDATE EXISTING INSTANCES STRATEGY (for content changes)\n  private async updateExistingInstancesStrategy(recurringTaskId: number, updatedTask: RecurringTask, changedFields: any[], report: any): Promise<any> {\n    console.log(`üîÑ [UPDATE STRATEGY] Updating existing instances for recurring task: ${updatedTask.title}`);\n    \n    // Find all affected instances (pending + in-progress, preserve completed)\n    const affectedInstances = Array.from(this.tasks.values()).filter(t => \n      t.recurringTaskId === recurringTaskId && \n      (t.status === 'pending' || t.status === 'in_progress') && \n      t.dueDate && new Date(t.dueDate) >= new Date()\n    );\n    \n    let updatedCount = 0;\n    let conflictCount = 0;\n    const conflictDetails: any[] = [];\n    \n    // Process instances in batches for performance\n    const batchSize = 100;\n    for (let i = 0; i < affectedInstances.length; i += batchSize) {\n      const batch = affectedInstances.slice(i, i + batchSize);\n      \n      batch.forEach(instance => {\n        const updateResult = this.updateSingleTaskInstance(instance, updatedTask, changedFields);\n        \n        if (updateResult.hasConflict) {\n          conflictCount++;\n          conflictDetails.push({\n            taskId: instance.id,\n            taskTitle: instance.title,\n            status: instance.status,\n            conflicts: updateResult.conflicts\n          });\n        }\n        \n        // Apply the update with preserved user data\n        this.tasks.set(instance.id, updateResult.updatedInstance);\n        updatedCount++;\n      });\n      \n      // Log progress for large updates\n      if (affectedInstances.length > 100) {\n        const progress = Math.round(((i + batch.length) / affectedInstances.length) * 100);\n        console.log(`üìä [BULK UPDATE] Progress: ${progress}% (${i + batch.length}/${affectedInstances.length})`);\n      }\n    }\n    \n    return {\n      ...report,\n      processedInstances: updatedCount,\n      conflictCount: conflictCount,\n      conflictDetails: conflictDetails,\n      details: `Updated ${updatedCount} existing instances with ${conflictCount} conflicts detected`\n    };\n  }\n\n  // SMART SINGLE INSTANCE UPDATE WITH CONFLICT DETECTION\n  private updateSingleTaskInstance(instance: any, updatedTemplate: RecurringTask, changedFields: any[]): { updatedInstance: any; hasConflict: boolean; conflicts: string[] } {\n    let hasConflict = false;\n    const conflicts: string[] = [];\n    \n    // Start with current instance\n    let updatedInstance = { ...instance };\n    \n    // Update simple fields (preserve user modifications)\n    changedFields.forEach(change => {\n      switch (change.field) {\n        case 'title':\n          // Always update title unless user has manually modified it\n          if (!instance.isModifiedAfterCreation) {\n            updatedInstance.title = updatedTemplate.title;\n          } else {\n            hasConflict = true;\n            conflicts.push(`Title was manually modified: \"${instance.title}\"`);\n          }\n          break;\n          \n        case 'description':\n          if (!instance.isModifiedAfterCreation) {\n            updatedInstance.description = updatedTemplate.description;\n          }\n          break;\n          \n        case 'priority':\n          updatedInstance.priority = updatedTemplate.priority;\n          break;\n          \n        case 'assignTo':\n          updatedInstance.assignTo = updatedTemplate.assignTo;\n          break;\n          \n        case 'estimatedTime':\n          updatedInstance.estimatedTime = updatedTemplate.estimatedTime;\n          break;\n          \n        case 'checklistTemplate':\n          // Complex checklist merge with progress preservation\n          const mergeResult = this.mergeChecklistWithProgress(instance.checklist, updatedTemplate.checklistTemplate);\n          updatedInstance.checklist = mergeResult.mergedChecklist;\n          if (mergeResult.hasConflicts) {\n            hasConflict = true;\n            conflicts.push(...mergeResult.conflicts);\n          }\n          break;\n      }\n    });\n    \n    // Update tracking fields\n    updatedInstance.templateVersion = updatedTemplate.versionNumber;\n    updatedInstance.modifiedFromTemplateAt = new Date();\n    \n    // Flag if task is in-progress and has conflicts\n    if (instance.status === 'in_progress' && hasConflict) {\n      // Create notification for user about changes\n      this.createUpdateNotification(instance.id, conflicts);\n    }\n    \n    return { updatedInstance, hasConflict, conflicts };\n  }\n\n  // ADVANCED CHECKLIST MERGE WITH PROGRESS PRESERVATION\n  private mergeChecklistWithProgress(existingChecklist: any[], newTemplate: any): { mergedChecklist: any[]; hasConflicts: boolean; conflicts: string[] } {\n    if (!newTemplate?.steps) {\n      return { mergedChecklist: existingChecklist || [], hasConflicts: false, conflicts: [] };\n    }\n    \n    const conflicts: string[] = [];\n    let hasConflicts = false;\n    \n    const mergedChecklist = newTemplate.steps.map((newStep: any, index: number) => {\n      const existingStep = existingChecklist?.[index];\n      \n      // Preserve user progress and data\n      const mergedStep = {\n        id: newStep.id || `${index + 1}`,\n        text: newStep.label || newStep.text || '',\n        completed: existingStep?.completed || false, // NEVER lose completion status\n        required: newStep.required || false,\n        type: newStep.type,\n        config: newStep.config, // Always use latest config\n        dataCollection: newStep.type === 'data-capture' ? { \n          type: newStep.config?.dataType || 'text', \n          label: newStep.label || '' \n        } : undefined\n      };\n      \n      // Detect conflicts where user has entered data but step changed significantly\n      if (existingStep?.completed && existingStep.text !== mergedStep.text) {\n        hasConflicts = true;\n        conflicts.push(`Step ${index + 1}: Text changed but user had completed \"${existingStep.text}\"`);\n      }\n      \n      // Preserve user-entered data in data collection steps\n      if (existingStep?.data) {\n        mergedStep.data = existingStep.data;\n      }\n      \n      return mergedStep;\n    });\n    \n    // Handle removed steps (mark as removed but don't delete)\n    if (existingChecklist && existingChecklist.length > newTemplate.steps.length) {\n      const removedSteps = existingChecklist.slice(newTemplate.steps.length);\n      removedSteps.forEach((removedStep, removedIndex) => {\n        if (removedStep.completed) {\n          hasConflicts = true;\n          conflicts.push(`Step was removed but user had completed: \"${removedStep.text}\"`);\n          // Keep the removed step marked as legacy\n          mergedChecklist.push({\n            ...removedStep,\n            isLegacy: true,\n            removedInUpdate: true\n          });\n        }\n      });\n    }\n    \n    return { mergedChecklist, hasConflicts, conflicts };\n  }\n\n  // CHANGE AUDIT LOGGING\n  private async logRecurringTaskChange(changeData: any): Promise<void> {\n    const changeLog = {\n      id: this.currentChangeLogId++,\n      ...changeData,\n      createdAt: new Date()\n    };\n    \n    // Store in change audit log (using notifications table for now)\n    await this.createNotification({\n      userId: changeData.changedByUser || 1,\n      type: 'recurring_task_update',\n      title: 'Recurring Task Updated',\n      message: `Template \"${changeData.recurringTaskId}\" updated affecting ${changeData.affectedInstanceCount} instances`,\n      data: changeLog\n    });\n    \n    console.log(`üìù [AUDIT LOG] Logged change for recurring task ${changeData.recurringTaskId}`);\n  }\n\n  // USER NOTIFICATION SYSTEM\n  private async createUpdateNotification(taskId: number, conflicts: string[]): Promise<void> {\n    const task = this.tasks.get(taskId);\n    if (!task || !task.assignedTo) return;\n    \n    await this.createNotification({\n      userId: task.assignedTo,\n      type: 'task_updated',\n      title: 'Task Updated',\n      message: `Task \"${task.title}\" has been updated. ${conflicts.length} conflicts detected.`,\n      data: { taskId, conflicts }\n    });\n    \n    console.log(`üîî [NOTIFICATION] Created update notification for task ${taskId}`);\n  }\n\n  // CALCULATE UPDATE IMPACT WITHOUT MAKING CHANGES - MEMORY VERSION\n  async calculateUpdateImpact(id: number, changedFields: any[]): Promise<{ affectedCount: number; conflictCount: number; byStatus: Record<string, number>; byDate: Record<string, number> }> {\n    console.log(`üîç [MEM IMPACT CALCULATION] Calculating impact for recurring task ${id}`);\n    \n    // Find all affected instances (pending + in-progress, preserve completed)\n    const affectedInstances = Array.from(this.tasks.values()).filter(t => \n      t.recurringTaskId === id && \n      (t.status === 'pending' || t.status === 'in_progress') && \n      t.dueDate && new Date(t.dueDate) >= new Date()\n    );\n\n    // Group by status\n    const byStatus: Record<string, number> = {};\n    const byDate: Record<string, number> = {};\n    let conflictCount = 0;\n\n    for (const instance of affectedInstances) {\n      // Count by status\n      byStatus[instance.status] = (byStatus[instance.status] || 0) + 1;\n      \n      // Count by date (group by month for readability)\n      if (instance.dueDate) {\n        const monthKey = new Date(instance.dueDate).toISOString().substring(0, 7); // YYYY-MM\n        byDate[monthKey] = (byDate[monthKey] || 0) + 1;\n      }\n      \n      // Check for potential conflicts (simplified logic)\n      if (instance.status === 'in_progress' && changedFields.some(f => ['title', 'description', 'checklistTemplate'].includes(f.field))) {\n        conflictCount++;\n      }\n    }\n\n    const result = {\n      affectedCount: affectedInstances.length,\n      conflictCount,\n      byStatus,\n      byDate\n    };\n\n    console.log(`üìä [MEM IMPACT RESULT] ${result.affectedCount} tasks affected, ${result.conflictCount} conflicts`);\n    return result;\n  }\n\n  async deleteRecurringTask(id: number): Promise<boolean> {\n    console.log('Deleting recurring task with ghost task preservation:', id);\n    \n    const recurringTask = this.recurringTasks.get(id);\n    if (!recurringTask) {\n      console.log('Recurring task not found:', id);\n      return false;\n    }\n    \n    // Delete only future pending tasks (preserve completed and in-progress tasks)\n    const now = new Date();\n    now.setHours(0, 0, 0, 0);\n    \n    const taskIds = Array.from(this.tasks.keys()).filter(taskId => {\n      const task = this.tasks.get(taskId);\n      if (!task || task.recurringTaskId !== id) return false;\n      \n      // Keep completed tasks\n      if (task.status === 'completed') return false;\n      \n      // Keep in-progress tasks\n      if (task.status === 'in_progress' || task.startedAt) return false;\n      \n      // Delete future pending tasks\n      if (task.dueDate) {\n        const dueDate = new Date(task.dueDate);\n        dueDate.setHours(0, 0, 0, 0);\n        return dueDate >= now; // Delete if due today or in the future\n      }\n      \n      return false;\n    });\n    \n    // Delete the future tasks\n    const deletedCount = taskIds.length;\n    taskIds.forEach(taskId => this.tasks.delete(taskId));\n    console.log(`Deleted ${deletedCount} future tasks for recurring task: ${recurringTask.title}`);\n    \n    // Update remaining tasks to mark them as orphaned (for historical reference)\n    const remainingTaskIds = Array.from(this.tasks.keys()).filter(taskId => {\n      const task = this.tasks.get(taskId);\n      return task?.recurringTaskId === id;\n    });\n    \n    remainingTaskIds.forEach(taskId => {\n      const task = this.tasks.get(taskId);\n      if (task) {\n        task.recurringTaskId = null; // Orphan the task but keep it for history\n        task.isFromDeletedRecurring = true;\n        task.deletedRecurringTaskTitle = recurringTask.title;\n        this.tasks.set(taskId, task);\n      }\n    });\n    \n    console.log(`Orphaned ${remainingTaskIds.length} historical tasks from recurring task: ${recurringTask.title}`);\n    \n    // Delete the recurring task\n    const deleted = this.recurringTasks.delete(id);\n    \n    // Persist the changes\n    await this.persistData();\n    \n    return deleted;\n  }\n\n  async resetRecurringTasks(): Promise<boolean> {\n    this.recurringTasks.clear();\n    this.currentRecurringTaskId = 1;\n    \n    // Also clear all task instances that were generated from recurring tasks\n    const recurringTaskIds = Array.from(this.tasks.keys()).filter(taskId => {\n      const task = this.tasks.get(taskId);\n      return task?.isRecurring;\n    });\n    \n    recurringTaskIds.forEach(taskId => this.tasks.delete(taskId));\n    \n    // Persist the changes\n    await this.persistData();\n    \n    return true;\n  }\n\n  // Method to regenerate task instances (useful for fixing scheduling bugs)\n  async regenerateTaskInstances(id: number): Promise<boolean> {\n    const recurringTask = this.recurringTasks.get(id);\n    if (!recurringTask) return false;\n\n    console.log(`Regenerating task instances for recurring task: ${recurringTask.title}`);\n    \n    // Delete all future task instances for this recurring task\n    const taskIds = Array.from(this.tasks.keys()).filter(taskId => {\n      const task = this.tasks.get(taskId);\n      return task?.recurringTaskId === id && \n             task?.status === 'pending' && \n             task?.dueDate && new Date(task.dueDate) >= new Date();\n    });\n    \n    taskIds.forEach(taskId => this.tasks.delete(taskId));\n    console.log(`Deleted ${taskIds.length} future task instances`);\n    \n    // Generate new task instances with correct schedule\n    await this.generateTaskInstances(recurringTask);\n    \n    // Persist changes\n    await this.persistData();\n    \n    return true;\n  }\n\n  // Method to regenerate ALL task instances (complete fix)\n  async regenerateAllTaskInstances(): Promise<{ totalRecurringTasks: number, totalGenerated: number, totalDeleted: number }> {\n    console.log(`üîÑ REGENERATING ALL TASK INSTANCES WITH CORRECTED LOGIC`);\n    \n    const today = new Date();\n    let totalDeleted = 0;\n    let totalGenerated = 0;\n    \n    // Delete ALL future pending task instances from recurring tasks\n    const taskIdsToDelete = Array.from(this.tasks.keys()).filter(taskId => {\n      const task = this.tasks.get(taskId);\n      return task?.isRecurring === true && \n             task?.status === 'pending' && \n             task?.dueDate && new Date(task.dueDate) >= today;\n    });\n    \n    taskIdsToDelete.forEach(taskId => this.tasks.delete(taskId));\n    totalDeleted = taskIdsToDelete.length;\n    console.log(`üóëÔ∏è Deleted ${totalDeleted} future pending recurring task instances`);\n    \n    // Regenerate instances for ALL recurring tasks with the corrected logic\n    const recurringTasks = Array.from(this.recurringTasks.values());\n    console.log(`üìã Found ${recurringTasks.length} recurring tasks to regenerate`);\n    \n    for (const recurringTask of recurringTasks) {\n      if (recurringTask.isActive) {\n        const beforeCount = this.tasks.size;\n        await this.generateTaskInstances(recurringTask);\n        const afterCount = this.tasks.size;\n        const generatedForThisTask = afterCount - beforeCount;\n        totalGenerated += generatedForThisTask;\n        console.log(`‚úÖ Generated ${generatedForThisTask} instances for: ${recurringTask.title}`);\n      } else {\n        console.log(`‚è∏Ô∏è Skipped inactive task: ${recurringTask.title}`);\n      }\n    }\n    \n    // Persist all changes\n    await this.persistData();\n    \n    console.log(`üéâ REGENERATION COMPLETE: ${totalDeleted} deleted, ${totalGenerated} generated from ${recurringTasks.length} recurring tasks`);\n    \n    return {\n      totalRecurringTasks: recurringTasks.length,\n      totalGenerated,\n      totalDeleted\n    };\n  }\n\n  // Utility method to check if a task already exists for a specific date (UTC-aware)\n  private taskExistsForDate(recurringTaskId: number, targetDate: Date): boolean {\n    const existingTasks = Array.from(this.tasks.values()).filter(t => t.recurringTaskId === recurringTaskId);\n    \n    return existingTasks.some(task => {\n      if (!task.dueDate) return false;\n      \n      const taskDate = new Date(task.dueDate);\n      const checkDate = new Date(targetDate);\n      \n      // Use UTC comparison to avoid timezone issues\n      return taskDate.getUTCFullYear() === checkDate.getUTCFullYear() &&\n             taskDate.getUTCMonth() === checkDate.getUTCMonth() &&\n             taskDate.getUTCDate() === checkDate.getUTCDate();\n    });\n  }\n\n  // Generate task instances from recurring task pattern with proper UTC-aware date handling\n  private async generateTaskInstances(recurringTask: RecurringTask): Promise<void> {\n    console.log(`=== GENERATING TASK INSTANCES FOR: ${recurringTask.title} ===`);\n    \n    // Use UTC-aware date creation to avoid timezone issues\n    const today = new Date();\n    const todayUTC = new Date(Date.UTC(today.getUTCFullYear(), today.getUTCMonth(), today.getUTCDate()));\n    const instances: Task[] = [];\n    \n    if (recurringTask.frequency === 'monthly') {\n      // Monthly tasks: generate for current and next 2 months\n      for (let monthOffset = 0; monthOffset < 3; monthOffset++) {\n        const targetYear = today.getFullYear();\n        const targetMonth = today.getMonth() + monthOffset;\n        \n        // Handle year rollover\n        const actualYear = targetYear + Math.floor(targetMonth / 12);\n        const actualMonth = targetMonth % 12;\n        \n        // Monthly task due on last day of month\n        const lastDay = new Date(actualYear, actualMonth + 1, 0).getDate();\n        const dueDate = new Date(Date.UTC(actualYear, actualMonth, lastDay, 12, 0, 0));\n        const visibleDate = new Date(Date.UTC(actualYear, actualMonth, 1, 12, 0, 0));\n        \n        console.log(`Checking monthly task for ${actualYear}-${actualMonth + 1}: due ${dueDate.toISOString()}`);\n        \n        // FIXED: Generate for current period even if we're mid-period\n        if (!this.taskExistsForDate(recurringTask.id, dueDate)) {\n          // For monthly tasks, generate if we're IN the period (between visibleDate and dueDate)\n          const isInCurrentPeriod = todayUTC >= visibleDate && todayUTC <= dueDate;\n          const isFuturePeriod = dueDate > todayUTC;\n          \n          if (isInCurrentPeriod || isFuturePeriod) {\n            console.log(`‚úÖ CREATING - Monthly task for ${dueDate.toISOString()} (period: ${visibleDate.toISOString()} to ${dueDate.toISOString()})`);\n            const instance = await this.createTaskInstanceWithDates(recurringTask, visibleDate, dueDate);\n            instances.push(instance);\n            this.tasks.set(instance.id, instance);\n          } else {\n            console.log(`‚ùå SKIPPING - Past period (due: ${dueDate.toISOString()}, today: ${todayUTC.toISOString()})`);\n          }\n        } else {\n          console.log(`‚ùå SKIPPING - Task already exists`);\n        }\n      }\n    } else if (recurringTask.frequency === 'quarterly') {\n      // Quarterly tasks: generate for current and next 3 quarters\n      for (let quarterOffset = 0; quarterOffset < 4; quarterOffset++) {\n        const targetYear = today.getFullYear();\n        const currentQuarter = Math.floor(today.getMonth() / 3);\n        const targetQuarter = currentQuarter + quarterOffset;\n        \n        // Handle year rollover\n        const actualYear = targetYear + Math.floor(targetQuarter / 4);\n        const actualQuarter = targetQuarter % 4;\n        \n        // Quarter start months: Q1=0 (Jan), Q2=3 (Apr), Q3=6 (Jul), Q4=9 (Oct)\n        const quarterStartMonth = actualQuarter * 3;\n        const quarterEndMonth = quarterStartMonth + 2;\n        \n        // Quarterly task visible from first day of quarter, due on last day of quarter\n        const visibleDate = new Date(Date.UTC(actualYear, quarterStartMonth, 1, 12, 0, 0));\n        const lastDayOfQuarter = new Date(actualYear, quarterEndMonth + 1, 0).getDate();\n        const dueDate = new Date(Date.UTC(actualYear, quarterEndMonth, lastDayOfQuarter, 12, 0, 0));\n        \n        console.log(`Checking quarterly task for Q${actualQuarter + 1} ${actualYear}: due ${dueDate.toISOString()}`);\n        \n        // FIXED: Generate for current period even if we're mid-period\n        if (!this.taskExistsForDate(recurringTask.id, dueDate)) {\n          const isInCurrentPeriod = todayUTC >= visibleDate && todayUTC <= dueDate;\n          const isFuturePeriod = dueDate > todayUTC;\n          \n          if (isInCurrentPeriod || isFuturePeriod) {\n            console.log(`‚úÖ CREATING - Quarterly task for Q${actualQuarter + 1} ${actualYear}`);\n            const instance = await this.createTaskInstanceWithDates(recurringTask, visibleDate, dueDate);\n            instances.push(instance);\n            this.tasks.set(instance.id, instance);\n          } else {\n            console.log(`‚ùå SKIPPING - Past period`);\n          }\n        } else {\n          console.log(`‚ùå SKIPPING - Task already exists`);\n        }\n      }\n    } else if (recurringTask.frequency === 'bi-weekly') {\n      // Bi-weekly tasks: generate for current and next 2 months\n      for (let monthOffset = 0; monthOffset < 3; monthOffset++) {\n        const targetYear = today.getFullYear();\n        const targetMonth = today.getMonth() + monthOffset;\n        \n        // Handle year rollover\n        const actualYear = targetYear + Math.floor(targetMonth / 12);\n        const actualMonth = targetMonth % 12;\n        \n        // First bi-weekly task (due 14th of month)\n        const firstDueDate = new Date(Date.UTC(actualYear, actualMonth, 14, 12, 0, 0));\n        const firstVisibleDate = new Date(Date.UTC(actualYear, actualMonth, 1, 12, 0, 0));\n        \n        if (firstDueDate >= todayUTC && !this.taskExistsForDate(recurringTask.id, firstDueDate)) {\n          console.log(`‚úÖ CREATING - Bi-weekly first half for ${firstDueDate.toISOString()}`);\n          const instance1 = await this.createTaskInstanceWithDates(recurringTask, firstVisibleDate, firstDueDate);\n          instances.push(instance1);\n          this.tasks.set(instance1.id, instance1);\n        }\n        \n        // Second bi-weekly task (due last day of month)\n        const lastDay = new Date(actualYear, actualMonth + 1, 0).getDate();\n        const secondDueDate = new Date(Date.UTC(actualYear, actualMonth, lastDay, 12, 0, 0));\n        const secondVisibleDate = new Date(Date.UTC(actualYear, actualMonth, 15, 12, 0, 0));\n        \n        if (secondDueDate >= todayUTC && !this.taskExistsForDate(recurringTask.id, secondDueDate)) {\n          console.log(`‚úÖ CREATING - Bi-weekly second half for ${secondDueDate.toISOString()}`);\n          const instance2 = await this.createTaskInstanceWithDates(recurringTask, secondVisibleDate, secondDueDate);\n          instances.push(instance2);\n          this.tasks.set(instance2.id, instance2);\n        }\n      }\n    } else {\n      // Daily/weekly tasks - generate 31 days ahead\n      const endDate = new Date(todayUTC);\n      endDate.setUTCDate(todayUTC.getUTCDate() + 31); // 31 days ahead\n      endDate.setUTCHours(23, 59, 59, 999);\n      \n      let currentDate = new Date(todayUTC);\n      \n      while (currentDate <= endDate) {\n        let shouldCreate = false;\n        \n        if (recurringTask.frequency === 'daily') {\n          // For daily tasks, check if specific days are selected\n          // Handle both string and array formats for daysOfWeek\n          const selectedDays = Array.isArray(recurringTask.daysOfWeek) \n            ? recurringTask.daysOfWeek \n            : (recurringTask.daysOfWeek ? [recurringTask.daysOfWeek] : []);\n            \n          if (selectedDays.length > 0) {\n            const dayOfWeek = currentDate.getUTCDay();\n            const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];\n            const currentDayName = dayNames[dayOfWeek];\n            shouldCreate = selectedDays.includes(currentDayName);\n          } else {\n            // FIXED: No specific days selected means NO GENERATION (not every day)\n            shouldCreate = false; \n            console.log(`‚è≠Ô∏è Skipping weekly task \"${recurringTask.title}\" - no days specified`);\n          }\n        } else if (recurringTask.frequency === 'weekly') {\n          // Check if current day matches selected days\n          const dayOfWeek = currentDate.getUTCDay();\n          const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];\n          const currentDayName = dayNames[dayOfWeek];\n          \n          // Handle both string and array formats for daysOfWeek\n          const selectedDays = Array.isArray(recurringTask.daysOfWeek) \n            ? recurringTask.daysOfWeek \n            : (recurringTask.daysOfWeek ? [recurringTask.daysOfWeek] : []);\n          shouldCreate = selectedDays.includes(currentDayName);\n        }\n        \n        if (shouldCreate && currentDate >= todayUTC && !this.taskExistsForDate(recurringTask.id, currentDate)) {\n          console.log(`‚úÖ CREATING - Task for ${currentDate.toISOString()}`);\n          const taskDate = new Date(Date.UTC(currentDate.getUTCFullYear(), currentDate.getUTCMonth(), currentDate.getUTCDate(), 12, 0, 0));\n          const instance = await this.createTaskInstanceWithDates(recurringTask, taskDate, taskDate);\n          instances.push(instance);\n          this.tasks.set(instance.id, instance);\n        }\n        \n        // Move to next day using UTC\n        currentDate = new Date(currentDate.getTime() + 24 * 60 * 60 * 1000);\n      }\n    }\n    \n    console.log(`Generated ${instances.length} task instances for recurring task: ${recurringTask.title}`);\n  }\n\n  // Helper method to get last day of month - FIXED\n  private getLastDayOfMonth(date: Date): number {\n    // Create date for last day of the current month\n    // Month + 1 gives us next month, day 0 gives us last day of current month\n    const lastDay = new Date(date.getFullYear(), date.getMonth() + 1, 0);\n    return lastDay.getDate();\n  }\n\n  // Create individual task instance with specific visible and due dates\n  private async createTaskInstanceWithDates(recurringTask: RecurringTask, visibleDate: Date, dueDate: Date): Promise<Task> {\n    const newTask: Task = {\n      id: this.currentTaskId++,\n      title: recurringTask.title,\n      description: recurringTask.description,\n      type: recurringTask.type,\n      status: 'pending',\n      priority: 'medium',\n      assignedTo: (recurringTask.assignTo && recurringTask.assignTo !== 'no-assignment') ? recurringTask.assignTo : null,\n      createdBy: recurringTask.createdBy,\n      location: recurringTask.location,\n      estimatedTime: null,\n      actualTime: null,\n      progress: 0,\n      checklist: recurringTask.checklistTemplate?.steps?.map((step, index) => ({\n        id: step.id || `${index + 1}`,\n        text: step.label || '',\n        completed: false,\n        required: step.required || false,\n        type: step.type,\n        config: step.config,\n        dataCollection: step.type === 'data-capture' ? { \n          type: step.config?.dataType || 'text', \n          label: step.label || '' \n        } : undefined\n      })) || [],\n      data: {},\n      dueDate: dueDate,\n      visibleFromDate: visibleDate,\n      startedAt: null,\n      completedAt: null,\n      pausedAt: null,\n      resumedAt: null,\n      skippedAt: null,\n      skipReason: null,\n      isRecurring: true,\n      frequency: recurringTask.frequency,\n      recurringTaskId: recurringTask.id,\n      createdAt: new Date(),\n      // Update propagation tracking fields\n      templateVersion: 1,\n      isModifiedAfterCreation: false,\n      modifiedFromTemplateAt: null\n    };\n    \n    this.tasks.set(newTask.id, newTask);\n    // Note: Task instances are persisted in bulk after generateTaskInstances completes\n    return newTask;\n  }\n\n  // Growing systems methods\n  async getAllGrowingSystems(): Promise<GrowingSystem[]> {\n    return Array.from(this.growingSystems.values());\n  }\n\n  async getGrowingSystemsByLocation(location: string): Promise<GrowingSystem[]> {\n    return Array.from(this.growingSystems.values()).filter(system => system.location === location);\n  }\n\n  async createGrowingSystem(systemData: any): Promise<GrowingSystem> {\n    const newSystem: GrowingSystem = {\n      ...systemData,\n      id: this.currentGrowingSystemId++,\n      createdAt: new Date()\n    };\n    this.growingSystems.set(newSystem.id, newSystem);\n    return newSystem;\n  }\n\n  async updateGrowingSystem(id: number, updates: any): Promise<GrowingSystem | null> {\n    const system = this.growingSystems.get(id);\n    if (!system) return null;\n\n    const updatedSystem = { ...system, ...updates };\n    this.growingSystems.set(id, updatedSystem);\n    return updatedSystem;\n  }\n\n  async deleteGrowingSystem(id: number): Promise<boolean> {\n    return this.growingSystems.delete(id);\n  }\n\n  // Course assignment methods\n  async getAllCourseAssignments(): Promise<CourseAssignment[]> {\n    return Array.from(this.courseAssignments.values());\n  }\n\n  async getCourseAssignment(id: number): Promise<CourseAssignment | undefined> {\n    return this.courseAssignments.get(id);\n  }\n\n  async getCourseAssignmentsByUser(userId: number): Promise<CourseAssignment[]> {\n    return Array.from(this.courseAssignments.values()).filter(assignment => assignment.assignedToUserId === userId);\n  }\n\n  async createCourseAssignment(assignmentData: InsertCourseAssignment): Promise<CourseAssignment> {\n    const newAssignment: CourseAssignment = {\n      ...assignmentData,\n      id: this.currentAssignmentId++,\n      assignedDate: new Date(),\n      completed: false\n    };\n    this.courseAssignments.set(newAssignment.id, newAssignment);\n    return newAssignment;\n  }\n\n  async updateCourseAssignment(id: number, updates: Partial<CourseAssignment>): Promise<CourseAssignment | undefined> {\n    const assignment = this.courseAssignments.get(id);\n    if (!assignment) return undefined;\n\n    const updatedAssignment = { ...assignment, ...updates };\n    this.courseAssignments.set(id, updatedAssignment);\n    return updatedAssignment;\n  }\n\n  async deleteCourseAssignment(id: number): Promise<boolean> {\n    return this.courseAssignments.delete(id);\n  }\n\n  // Crop methods\n  async getAllCrops(): Promise<Crop[]> {\n    return Array.from(this.crops.values());\n  }\n\n  async getCropsByLocation(location: string): Promise<Crop[]> {\n    return Array.from(this.crops.values()).filter(crop => crop.location === location);\n  }\n\n  async createCrop(cropData: any): Promise<Crop> {\n    const newCrop: Crop = {\n      ...cropData,\n      id: this.currentCropId++,\n      createdAt: new Date()\n    };\n    this.crops.set(newCrop.id, newCrop);\n    return newCrop;\n  }\n\n  async updateCrop(id: number, updates: any): Promise<Crop | null> {\n    const crop = this.crops.get(id);\n    if (!crop) return null;\n\n    const updatedCrop = { ...crop, ...updates };\n    this.crops.set(id, updatedCrop);\n    return updatedCrop;\n  }\n\n  async deleteCrop(id: number): Promise<boolean> {\n    return this.crops.delete(id);\n  }\n\n  // Notification methods\n  async getNotification(id: number): Promise<Notification | undefined> {\n    return this.notifications.get(id);\n  }\n\n  async getAllNotifications(): Promise<Notification[]> {\n    return Array.from(this.notifications.values()).sort((a, b) => \n      new Date(b.createdAt!).getTime() - new Date(a.createdAt!).getTime()\n    );\n  }\n\n  async getNotificationsByUser(userId: number): Promise<Notification[]> {\n    return Array.from(this.notifications.values())\n      .filter(n => n.userId === userId)\n      .sort((a, b) => new Date(b.createdAt!).getTime() - new Date(a.createdAt!).getTime());\n  }\n\n  async createNotification(notification: InsertNotification): Promise<Notification> {\n    const newNotification: Notification = {\n      id: this.currentNotificationId++,\n      ...notification,\n      createdAt: new Date(),\n      readAt: null\n    };\n    this.notifications.set(newNotification.id, newNotification);\n    return newNotification;\n  }\n\n  async updateNotification(id: number, updates: Partial<Notification>): Promise<Notification | undefined> {\n    const notification = this.notifications.get(id);\n    if (!notification) return undefined;\n    \n    const updatedNotification = { ...notification, ...updates };\n    this.notifications.set(id, updatedNotification);\n    return updatedNotification;\n  }\n\n  async markNotificationAsRead(id: number): Promise<Notification | undefined> {\n    const notification = this.notifications.get(id);\n    if (!notification) return undefined;\n    \n    const updatedNotification = { \n      ...notification, \n      isRead: true, \n      readAt: new Date() \n    };\n    this.notifications.set(id, updatedNotification);\n    return updatedNotification;\n  }\n\n  async markAllNotificationsAsRead(userId: number): Promise<void> {\n    this.notifications.forEach((notification, id) => {\n      if (notification.userId === userId && !notification.isRead) {\n        this.notifications.set(id, {\n          ...notification,\n          isRead: true,\n          readAt: safeDate(new Date())\n        });\n      }\n    });\n  }\n\n  async deleteNotification(id: number): Promise<boolean> {\n    return this.notifications.delete(id);\n  }\n\n  // Clear all data method\n  async clearAllData(): Promise<boolean> {\n    try {\n      console.log('Clearing all data maps...');\n      this.users.clear();\n      this.tasks.clear();\n      this.inventoryItems.clear();\n      this.trainingModules.clear();\n      this.userProgress.clear();\n      this.taskLogs.clear();\n      this.recurringTasks.clear();\n      this.growingSystems.clear();\n      this.trayMovements.clear();\n      // this.crops.clear(); // Disabled until Crop type is defined\n      this.courseAssignments.clear();\n      this.notifications.clear();\n      \n      // Reset all counters\n      this.currentUserId = 1;\n      this.currentTaskId = 1;\n      this.currentInventoryId = 1;\n      this.currentModuleId = 1;\n      this.currentProgressId = 1;\n      this.currentLogId = 1;\n      this.currentRecurringTaskId = 1;\n      this.currentGrowingSystemId = 1;\n      this.currentTrayMovementId = 1;\n      // this.currentCropId = 1; // Disabled until Crop type is defined\n      this.currentAssignmentId = 1;\n      this.currentNotificationId = 1;\n      \n      // Clear persistent storage files\n      await this.persistence.clearAllFiles();\n      \n      console.log('All data cleared successfully');\n      return true;\n    } catch (error) {\n      console.error('Error clearing data:', error);\n      return false;\n    }\n  }\n\n  // Add missing methods for recurring task instance management\n  async regenerateAllTaskInstances(): Promise<{ totalTasksCreated: number; recurringTasksProcessed: number }> {\n    return this.regenerateTaskInstances();\n  }\n\n  async regenerateTaskInstances(recurringTaskId?: number): Promise<boolean | { totalTasksCreated: number; recurringTasksProcessed: number }> {\n    if (recurringTaskId) {\n      // Single recurring task regeneration\n      const recurringTask = this.recurringTasks.get(recurringTaskId);\n      if (!recurringTask) return false;\n      \n      await this.generateTaskInstances(recurringTask);\n      return true;\n    } else {\n      // All recurring tasks regeneration\n      const recurringTasks = Array.from(this.recurringTasks.values()).filter(t => t.isActive);\n      console.log(`üîÑ Regenerating task instances for ${recurringTasks.length} active recurring tasks`);\n      \n      let totalTasksCreated = 0;\n      for (const recurringTask of recurringTasks) {\n        try {\n          await this.generateTaskInstances(recurringTask);\n          console.log(`‚úÖ Generated instances for: ${recurringTask.title}`);\n          totalTasksCreated++;\n        } catch (error) {\n          console.error(`‚ùå Failed to generate instances for ${recurringTask.title}:`, error);\n        }\n      }\n      \n      return { totalTasksCreated, recurringTasksProcessed: recurringTasks.length };\n    }\n  }\n\n  // System status and locks - stub implementations for MemStorage\n  async getSystemStatus(id: string): Promise<SystemStatus | undefined> {\n    return undefined;\n  }\n\n  async setSystemStatus(status: InsertSystemStatus): Promise<SystemStatus> {\n    const systemStatus: SystemStatus = {\n      id: status.id,\n      lastGenerationDate: status.lastGenerationDate || null,\n      generatedThrough: status.generatedThrough || null,\n      lastUpdateBy: status.lastUpdateBy || null,\n      updatedAt: new Date(),\n    };\n    return systemStatus;\n  }\n\n  async acquireLock(lockId: string, userId: number, lockType: string, expirationMinutes = 10): Promise<SystemLock | null> {\n    try {\n      // First, clean up expired locks\n      await db.delete(systemLocks).where(\n        and(\n          eq(systemLocks.id, lockId),\n          lte(systemLocks.expiresAt, new Date())\n        )\n      );\n      \n      // Try to acquire the lock\n      const expiresAt = new Date(Date.now() + expirationMinutes * 60 * 1000);\n      const lockData = {\n        id: lockId,\n        lockedBy: userId,\n        lockType,\n        acquiredAt: new Date(),\n        expiresAt\n      };\n      \n      await db.insert(systemLocks).values(lockData);\n      \n      console.log(`üîí Lock acquired: ${lockId} by user ${userId} (expires: ${expiresAt.toISOString()})`);\n      return lockData;\n    } catch (error) {\n      console.log(`‚ö†Ô∏è Lock acquisition failed: ${lockId} - ${error instanceof Error ? error.message : 'Unknown error'}`);\n      return null;\n    }\n  }\n\n  async releaseLock(lockId: string): Promise<boolean> {\n    try {\n      await db.delete(systemLocks).where(eq(systemLocks.id, lockId));\n      console.log(`üîì Lock released: ${lockId}`);\n      return true;\n    } catch (error) {\n      console.log(`‚ö†Ô∏è Lock release failed: ${lockId} - ${error instanceof Error ? error.message : 'Unknown error'}`);\n      return false;\n    }\n  }\n\n  async checkLock(lockId: string): Promise<SystemLock | null> {\n    try {\n      const locks = await db.select().from(systemLocks)\n        .where(eq(systemLocks.id, lockId));\n      \n      if (locks.length === 0) return null;\n      \n      const lock = locks[0];\n      \n      // Check if lock has expired\n      if (lock.expiresAt && lock.expiresAt <= new Date()) {\n        // Clean up expired lock\n        await db.delete(systemLocks).where(eq(systemLocks.id, lockId));\n        console.log(`üïê Expired lock cleaned up: ${lockId}`);\n        return null;\n      }\n      \n      return lock;\n    } catch (error) {\n      console.log(`‚ö†Ô∏è Lock check failed: ${lockId} - ${error instanceof Error ? error.message : 'Unknown error'}`);\n      return null;\n    }\n  }\n\n  // Simple verification implementation for MemStorage (mostly for interface compliance)\n  async verifyTaskIntegrity(): Promise<{\n    missingTasksCreated: number;\n    duplicatesRemoved: number;\n    errors: string[];\n    verificationReport: string[];\n  }> {\n    return {\n      missingTasksCreated: 0,\n      duplicatesRemoved: 0,\n      errors: [],\n      verificationReport: ['MemStorage verification not implemented - use DatabaseStorage for full verification']\n    };\n  }\n}\n\n// Database Storage Implementation (switching from MemStorage to use database)\nclass DatabaseStorage implements IStorage {\n  async getUser(id: number): Promise<User | undefined> {\n    const [user] = await db.select().from(users).where(eq(users.id, id));\n    return user || undefined;\n  }\n\n  async getUserByUsername(username: string): Promise<User | undefined> {\n    const [user] = await db.select().from(users).where(eq(users.username, username));\n    return user || undefined;\n  }\n\n  async createUser(userData: InsertUser): Promise<User> {\n    const [user] = await db.insert(users).values(userData).returning();\n    return user;\n  }\n\n  async updateUser(id: number, updates: Partial<User>): Promise<User | undefined> {\n    const [user] = await db.update(users).set(updates).where(eq(users.id, id)).returning();\n    return user || undefined;\n  }\n\n  async getAllUsers(): Promise<User[]> {\n    return db.select().from(users);\n  }\n\n  // Task methods\n  async getTask(id: number): Promise<Task | undefined> {\n    const [task] = await db.select().from(tasks).where(eq(tasks.id, id));\n    return task || undefined;\n  }\n\n  async getTasksByUser(userId: number): Promise<Task[]> {\n    return db.select().from(tasks).where(eq(tasks.assignedTo, userId));\n  }\n\n  async getAllTasks(): Promise<Task[]> {\n    const allTasks = await db.select().from(tasks);\n    console.log(`üìä DatabaseStorage.getAllTasks() served ${allTasks.length} tasks`);\n    if (allTasks.length > 0) {\n      const firstTask = allTasks[0];\n      const lastTask = allTasks[allTasks.length - 1];\n      console.log(`üìÖ First task: ${firstTask.title} (taskDate: ${firstTask.taskDate}, dueDate: ${firstTask.dueDate})`);\n      console.log(`üìÖ Last task: ${lastTask.title} (taskDate: ${lastTask.taskDate}, dueDate: ${lastTask.dueDate})`);\n    }\n    return allTasks;\n  }\n\n  async getTasksByLocation(locationId: string): Promise<Task[]> {\n    return db.select().from(tasks).where(eq(tasks.location, locationId));\n  }\n\n  private async findDuplicateTask(title: string, taskDate: Date | string | null, location: string, recurringTaskId?: number | null): Promise<Task | null> {\n    const taskDateStr = taskDate ? new Date(taskDate).toISOString().split('T')[0] : null;\n    \n    const conditions = [\n      eq(tasks.title, title),\n      eq(tasks.location, location)\n    ];\n    \n    if (taskDateStr) {\n      conditions.push(sql`DATE(${tasks.taskDate}) = ${taskDateStr}`);\n    }\n    \n    if (recurringTaskId) {\n      conditions.push(eq(tasks.recurringTaskId, recurringTaskId));\n    }\n    \n    const [duplicate] = await db.select().from(tasks).where(and(...conditions)).limit(1);\n    return duplicate || null;\n  }\n\n  async createTask(taskData: InsertTask): Promise<Task> {\n    const safeTaskData = {\n      ...taskData,\n      taskDate: taskData.taskDate || taskData.visibleFromDate || null\n    };\n    \n    const duplicate = await this.findDuplicateTask(\n      safeTaskData.title,\n      safeTaskData.taskDate,\n      safeTaskData.location,\n      safeTaskData.recurringTaskId\n    );\n    \n    if (duplicate) {\n      console.log(`üîç Duplicate task found: \"${safeTaskData.title}\" on ${safeTaskData.taskDate} at ${safeTaskData.location} - updating existing task #${duplicate.id}`);\n      const updatedTask = await this.updateTask(duplicate.id, safeTaskData);\n      return updatedTask || duplicate;\n    }\n    \n    const [task] = await db.insert(tasks).values(safeTaskData).returning();\n    return task;\n  }\n\n  async updateTask(id: number, updates: Partial<Task>): Promise<Task | undefined> {\n    // Safe date serialization - only convert known date fields when they're Date instances\n    const safeUpdates = { ...updates };\n    const dateFields = ['dueDate', 'createdAt', 'startedAt', 'completedAt', 'pausedAt', 'resumedAt', 'visibleFromDate'];\n    \n    for (const field of dateFields) {\n      if (field in safeUpdates) {\n        const value = safeUpdates[field];\n        if (value instanceof Date) {\n          // Keep as Date - Drizzle will handle it\n          safeUpdates[field] = value;\n        } else if (typeof value === 'string') {\n          // Convert string to Date if valid\n          safeUpdates[field] = new Date(value);\n        }\n        // null/undefined pass through unchanged\n      }\n    }\n    \n    const [task] = await db.update(tasks).set(safeUpdates).where(eq(tasks.id, id)).returning();\n    return task || undefined;\n  }\n\n  async deleteTask(id: number): Promise<boolean> {\n    const result = await db.delete(tasks).where(eq(tasks.id, id));\n    return result.rowCount > 0;\n  }\n\n  async resetTasks(): Promise<boolean> {\n    await db.delete(tasks);\n    return true;\n  }\n\n  async resetTaskSequence(): Promise<void> {\n    // Reset PostgreSQL sequence to match current max ID\n    await db.execute(sql`SELECT setval(pg_get_serial_sequence('tasks','id'), COALESCE((SELECT MAX(id)+1 FROM tasks),1), false)`);\n  }\n\n  // Inventory methods (stub implementation - keeping interface)\n  async getInventoryItem(id: number): Promise<InventoryItem | undefined> {\n    const [item] = await db.select().from(inventoryItems).where(eq(inventoryItems.id, id));\n    return item || undefined;\n  }\n\n  async getAllInventoryItems(): Promise<InventoryItem[]> {\n    return db.select().from(inventoryItems);\n  }\n\n  async getInventoryItemsByLocation(locationId: string): Promise<InventoryItem[]> {\n    return db.select().from(inventoryItems).where(eq(inventoryItems.location, locationId));\n  }\n\n  async createInventoryItem(itemData: InsertInventoryItem): Promise<InventoryItem> {\n    const [item] = await db.insert(inventoryItems).values(itemData).returning();\n    return item;\n  }\n\n  async updateInventoryItem(id: number, updates: Partial<InventoryItem>): Promise<InventoryItem | undefined> {\n    const [item] = await db.update(inventoryItems).set(updates).where(eq(inventoryItems.id, id)).returning();\n    return item || undefined;\n  }\n\n  async deleteInventoryItem(id: number): Promise<boolean> {\n    const result = await db.delete(inventoryItems).where(eq(inventoryItems.id, id));\n    return result.rowCount > 0;\n  }\n\n  async getLowStockItems(): Promise<InventoryItem[]> {\n    return db.select().from(inventoryItems).where(sql`${inventoryItems.currentStock} <= ${inventoryItems.minimumStock}`);\n  }\n\n  async getLowStockItemsByLocation(locationId: string): Promise<InventoryItem[]> {\n    return db.select().from(inventoryItems).where(and(\n      eq(inventoryItems.location, locationId),\n      sql`${inventoryItems.currentStock} <= ${inventoryItems.minimumStock}`\n    ));\n  }\n\n  async addInventoryStock(data: { itemId: number; quantity: number; unitCost: number; supplier?: string; notes?: string }): Promise<InventoryItem> {\n    // Get current item\n    const [currentItem] = await db.select().from(inventoryItems).where(eq(inventoryItems.id, data.itemId));\n    if (!currentItem) throw new Error('Item not found');\n\n    // Calculate weighted average cost\n    const currentValue = (currentItem.currentStock || 0) * (currentItem.avgCostPerUnit || 0);\n    const newValue = data.quantity * data.unitCost;\n    const totalQuantity = (currentItem.currentStock || 0) + data.quantity;\n    const newAverageCost = totalQuantity > 0 ? (currentValue + newValue) / totalQuantity : 0;\n\n    // Update item\n    const [updatedItem] = await db.update(inventoryItems)\n      .set({\n        currentStock: totalQuantity,\n        avgCostPerUnit: newAverageCost,\n        totalValue: totalQuantity * newAverageCost,\n        lastRestocked: new Date()\n      })\n      .where(eq(inventoryItems.id, data.itemId))\n      .returning();\n\n    return updatedItem;\n  }\n\n  // Training methods (stub implementation)\n  async getTrainingModule(id: number): Promise<TrainingModule | undefined> {\n    const [module] = await db.select().from(trainingModules).where(eq(trainingModules.id, id));\n    return module || undefined;\n  }\n\n  async getAllTrainingModules(): Promise<TrainingModule[]> {\n    return db.select().from(trainingModules);\n  }\n\n  async createTrainingModule(moduleData: InsertTrainingModule): Promise<TrainingModule> {\n    const [module] = await db.insert(trainingModules).values(moduleData).returning();\n    return module;\n  }\n\n  async getUserProgress(userId: number): Promise<UserProgress[]> {\n    return db.select().from(userProgress).where(eq(userProgress.userId, userId));\n  }\n\n  async updateUserProgress(progressData: InsertUserProgress): Promise<UserProgress> {\n    const [progress] = await db.insert(userProgress).values(progressData)\n      .onConflictDoUpdate({\n        target: [userProgress.userId, userProgress.moduleId],\n        set: {\n          completed: progressData.completed,\n          completedAt: progressData.completedAt,\n          progress: progressData.progress\n        }\n      }).returning();\n    return progress;\n  }\n\n  // Task logs\n  async createTaskLog(logData: InsertTaskLog): Promise<TaskLog> {\n    const [log] = await db.insert(taskLogs).values(logData).returning();\n    return log;\n  }\n\n  async getTaskLogs(taskId: number): Promise<TaskLog[]> {\n    return db.select().from(taskLogs).where(eq(taskLogs.taskId, taskId));\n  }\n\n  // Recurring tasks - KEY METHODS FOR THE FIX\n  async getAllRecurringTasks(): Promise<RecurringTask[]> {\n    return db.select().from(recurringTasks);\n  }\n\n  async getRecurringTask(id: number): Promise<RecurringTask | undefined> {\n    const [task] = await db.select().from(recurringTasks).where(eq(recurringTasks.id, id));\n    return task || undefined;\n  }\n\n  async getRecurringTasksByLocation(locationId: string): Promise<RecurringTask[]> {\n    // Case-insensitive location matching to handle mixed case in database\n    return db.select().from(recurringTasks).where(sql`LOWER(${recurringTasks.location}) = LOWER(${locationId})`);\n  }\n\n  async createRecurringTask(taskData: InsertRecurringTask): Promise<RecurringTask> {\n    const [task] = await db.insert(recurringTasks).values(taskData).returning();\n    return task;\n  }\n\n  async updateRecurringTask(id: number, updates: Partial<RecurringTask>, options?: { strategy?: 'update_all' | 'new_only'; userId?: number }): Promise<{ task: RecurringTask | null; report: any }> {\n    try {\n      console.log(`üîç [DATABASE PROPAGATION] Starting update for recurring task ${id}`);\n      \n      // Step 1: Get original task\n      const [originalTask] = await db.select().from(recurringTasks).where(eq(recurringTasks.id, id));\n      if (!originalTask) {\n        return { task: null, report: { error: 'Task not found' } };\n      }\n\n      // Step 2: Track changed fields for audit trail\n      const changedFields = this.identifyChangedFields(originalTask, updates);\n      console.log(`üîç [UPDATE PROPAGATION] Changes detected:`, changedFields.map(f => f.field));\n\n      // Step 3: Increment version number for tracking\n      const newVersionNumber = (originalTask.versionNumber || 1) + 1;\n      \n      // Step 4: Create updated task with version tracking\n      const updateData = { \n        ...updates,\n        versionNumber: newVersionNumber,\n        lastModifiedDate: new Date(),\n        lastModifiedBy: options?.userId || null\n      };\n      \n      const [updatedTask] = await db.update(recurringTasks)\n        .set(updateData)\n        .where(eq(recurringTasks.id, id))\n        .returning();\n\n      // Step 5: Determine update strategy based on changes\n      const shouldRegenerateInstances = changedFields.some(f => \n        ['frequency', 'daysOfWeek', 'isActive'].includes(f.field)\n      );\n      \n      let propagationReport: any = {\n        strategy: shouldRegenerateInstances ? 'regenerate' : 'update_existing',\n        changedFields: changedFields,\n        versionNumber: newVersionNumber,\n        timestamp: new Date().toISOString()\n      };\n\n      // Step 6: Execute propagation strategy\n      if (shouldRegenerateInstances) {\n        propagationReport = await this.regenerateTaskInstancesStrategyDB(id, updatedTask, propagationReport);\n      } else {\n        propagationReport = await this.updateExistingInstancesStrategyDB(id, updatedTask, changedFields, propagationReport);\n      }\n\n      // Step 7: Log changes to audit trail\n      await this.logRecurringTaskChangeDB({\n        recurringTaskId: id,\n        changedFields: changedFields,\n        changeTimestamp: new Date(),\n        changedByUser: options?.userId || null,\n        affectedInstanceCount: propagationReport.processedInstances || 0,\n        strategyUsed: propagationReport.strategy\n      });\n      \n      console.log(`‚úÖ [DATABASE PROPAGATION] Completed for task \"${updatedTask.title}\" - ${propagationReport.processedInstances} instances affected`);\n      \n      return { task: updatedTask, report: propagationReport };\n    } catch (error) {\n      console.error('Error updating recurring task:', error);\n      throw error;\n    }\n  }\n\n  // FIELD-BY-FIELD CHANGE TRACKING FOR DATABASE STORAGE\n  private identifyChangedFields(original: RecurringTask, updates: any): Array<{ field: string; oldValue: any; newValue: any; requiresNotification: boolean }> {\n    const changes: Array<{ field: string; oldValue: any; newValue: any; requiresNotification: boolean }> = [];\n    \n    // Fields that require user notification when changed\n    const notificationRequiredFields = ['title', 'description', 'checklistTemplate', 'estimatedTime', 'priority', 'assignTo'];\n    \n    Object.keys(updates).forEach(field => {\n      if (JSON.stringify(original[field as keyof RecurringTask]) !== JSON.stringify(updates[field])) {\n        changes.push({\n          field,\n          oldValue: original[field as keyof RecurringTask],\n          newValue: updates[field],\n          requiresNotification: notificationRequiredFields.includes(field)\n        });\n      }\n    });\n    \n    return changes;\n  }\n\n  // REGENERATE INSTANCES STRATEGY (for frequency/schedule changes) - DATABASE VERSION\n  private async regenerateTaskInstancesStrategyDB(recurringTaskId: number, updatedTask: RecurringTask, report: any): Promise<any> {\n    console.log(`üîÑ [DB REGENERATE STRATEGY] Regenerating instances for recurring task: ${updatedTask.title}`);\n    \n    // Delete ONLY future pending task instances (preserve completed/in-progress tasks)\n    const deletedResult = await db.delete(tasks)\n      .where(and(\n        eq(tasks.recurringTaskId, recurringTaskId),\n        eq(tasks.status, 'pending'),\n        gte(tasks.dueDate, new Date())\n      ));\n    \n    const deletedCount = deletedResult.rowCount || 0;\n    \n    // Note: Task instance generation would need to be implemented here\n    // For now, returning the deletion count\n    \n    return {\n      ...report,\n      deletedInstances: deletedCount,\n      processedInstances: deletedCount,\n      details: 'Regenerated all future pending instances with new schedule'\n    };\n  }\n\n  // UPDATE EXISTING INSTANCES STRATEGY (for content changes) - DATABASE VERSION\n  private async updateExistingInstancesStrategyDB(recurringTaskId: number, updatedTask: RecurringTask, changedFields: any[], report: any): Promise<any> {\n    console.log(`üîÑ [DB UPDATE STRATEGY] Updating existing instances for recurring task: ${updatedTask.title}`);\n    \n    // Find all affected instances (pending + in-progress, preserve completed)\n    const affectedInstances = await db.select()\n      .from(tasks)\n      .where(and(\n        eq(tasks.recurringTaskId, recurringTaskId),\n        or(eq(tasks.status, 'pending'), eq(tasks.status, 'in_progress')),\n        gte(tasks.dueDate, new Date())\n      ));\n    \n    let updatedCount = 0;\n    let conflictCount = 0;\n    const conflictDetails: any[] = [];\n    \n    // Process instances in batches for performance\n    const batchSize = 100;\n    for (let i = 0; i < affectedInstances.length; i += batchSize) {\n      const batch = affectedInstances.slice(i, i + batchSize);\n      \n      // Prepare batch updates\n      const batchUpdates = batch.map(instance => {\n        const updateResult = this.updateSingleTaskInstanceDB(instance, updatedTask, changedFields);\n        \n        if (updateResult.hasConflict) {\n          conflictCount++;\n          conflictDetails.push({\n            taskId: instance.id,\n            taskTitle: instance.title,\n            status: instance.status,\n            conflicts: updateResult.conflicts\n          });\n        }\n        \n        return {\n          id: instance.id,\n          updates: updateResult.updateData\n        };\n      });\n      \n      // Execute batch updates\n      for (const { id, updates } of batchUpdates) {\n        await db.update(tasks).set(updates).where(eq(tasks.id, id));\n        updatedCount++;\n      }\n      \n      // Log progress for large updates\n      if (affectedInstances.length > 100) {\n        const progress = Math.round(((i + batch.length) / affectedInstances.length) * 100);\n        console.log(`üìä [DB BULK UPDATE] Progress: ${progress}% (${i + batch.length}/${affectedInstances.length})`);\n      }\n    }\n    \n    return {\n      ...report,\n      processedInstances: updatedCount,\n      conflictCount: conflictCount,\n      conflictDetails: conflictDetails,\n      details: `Updated ${updatedCount} existing instances with ${conflictCount} conflicts detected`\n    };\n  }\n\n  // SMART SINGLE INSTANCE UPDATE WITH CONFLICT DETECTION - DATABASE VERSION\n  private updateSingleTaskInstanceDB(instance: any, updatedTemplate: RecurringTask, changedFields: any[]): { updateData: any; hasConflict: boolean; conflicts: string[] } {\n    let hasConflict = false;\n    const conflicts: string[] = [];\n    \n    // Start with minimal update data\n    let updateData: any = {\n      templateVersion: updatedTemplate.versionNumber,\n      modifiedFromTemplateAt: new Date()\n    };\n    \n    // Update simple fields (preserve user modifications)\n    changedFields.forEach(change => {\n      switch (change.field) {\n        case 'title':\n          // Always update title unless user has manually modified it\n          if (!instance.isModifiedAfterCreation) {\n            updateData.title = updatedTemplate.title;\n          } else {\n            hasConflict = true;\n            conflicts.push(`Title was manually modified: \"${instance.title}\"`);\n          }\n          break;\n          \n        case 'description':\n          if (!instance.isModifiedAfterCreation) {\n            updateData.description = updatedTemplate.description;\n          }\n          break;\n          \n        case 'priority':\n          updateData.priority = updatedTemplate.priority;\n          break;\n          \n        case 'assignTo':\n          updateData.assignTo = updatedTemplate.assignTo;  // FIXED: Update correct field (assignTo, not assignedTo)\n          break;\n          \n        case 'estimatedTime':\n          updateData.estimatedTime = updatedTemplate.estimatedTime;\n          break;\n          \n        case 'checklistTemplate':\n          // Complex checklist merge with progress preservation\n          const mergeResult = this.mergeChecklistWithProgressDB(instance.checklist, updatedTemplate.checklistTemplate);\n          updateData.checklist = mergeResult.mergedChecklist;\n          if (mergeResult.hasConflicts) {\n            hasConflict = true;\n            conflicts.push(...mergeResult.conflicts);\n          }\n          break;\n      }\n    });\n    \n    return { updateData, hasConflict, conflicts };\n  }\n\n  // ADVANCED CHECKLIST MERGE WITH PROGRESS PRESERVATION - DATABASE VERSION\n  private mergeChecklistWithProgressDB(existingChecklist: any[], newTemplate: any): { mergedChecklist: any[]; hasConflicts: boolean; conflicts: string[] } {\n    if (!newTemplate?.steps) {\n      return { mergedChecklist: existingChecklist || [], hasConflicts: false, conflicts: [] };\n    }\n    \n    const conflicts: string[] = [];\n    let hasConflicts = false;\n    \n    const mergedChecklist = newTemplate.steps.map((newStep: any, index: number) => {\n      const existingStep = existingChecklist?.[index];\n      \n      // Preserve user progress and data\n      const mergedStep = {\n        id: newStep.id || `${index + 1}`,\n        text: newStep.label || newStep.text || '',\n        completed: existingStep?.completed || false, // NEVER lose completion status\n        required: newStep.required || false,\n        type: newStep.type,\n        config: newStep.config, // Always use latest config\n        dataCollection: newStep.type === 'data-capture' ? { \n          type: newStep.config?.dataType || 'text', \n          label: newStep.label || '' \n        } : undefined\n      };\n      \n      // Detect conflicts where user has entered data but step changed significantly\n      if (existingStep?.completed && existingStep.text !== mergedStep.text) {\n        hasConflicts = true;\n        conflicts.push(`Step ${index + 1}: Text changed but user had completed \"${existingStep.text}\"`);\n      }\n      \n      // Preserve user-entered data in data collection steps\n      if (existingStep?.data) {\n        mergedStep.data = existingStep.data;\n      }\n      \n      return mergedStep;\n    });\n    \n    // Handle removed steps (mark as removed but don't delete)\n    if (existingChecklist && existingChecklist.length > newTemplate.steps.length) {\n      const removedSteps = existingChecklist.slice(newTemplate.steps.length);\n      removedSteps.forEach((removedStep, removedIndex) => {\n        if (removedStep.completed) {\n          hasConflicts = true;\n          conflicts.push(`Step was removed but user had completed: \"${removedStep.text}\"`);\n          // Keep the removed step marked as legacy\n          mergedChecklist.push({\n            ...removedStep,\n            isLegacy: true,\n            removedInUpdate: true\n          });\n        }\n      });\n    }\n    \n    return { mergedChecklist, hasConflicts, conflicts };\n  }\n\n  // CHANGE AUDIT LOGGING - DATABASE VERSION\n  private async logRecurringTaskChangeDB(changeData: any): Promise<void> {\n    // Skip notification logging if no valid user ID (prevent foreign key constraint errors)\n    if (!changeData.changedByUser) {\n      console.log(`‚ö†Ô∏è [AUDIT LOG] Skipping notification - no valid user ID provided`);\n      return;\n    }\n\n    // Store in notifications table as audit log for now\n    await db.insert(notifications).values({\n      userId: changeData.changedByUser,\n      type: 'recurring_task_update',\n      title: 'Recurring Task Updated',\n      message: `Template \"${changeData.recurringTaskId}\" updated affecting ${changeData.affectedInstanceCount} instances`,\n      data: JSON.stringify(changeData),\n      createdAt: new Date(),\n      readAt: null\n    });\n    \n    console.log(`üìù [DB AUDIT LOG] Logged change for recurring task ${changeData.recurringTaskId}`);\n  }\n\n  // CALCULATE UPDATE IMPACT WITHOUT MAKING CHANGES - DATABASE VERSION\n  async calculateUpdateImpact(id: number, changedFields: any[]): Promise<{ affectedCount: number; conflictCount: number; byStatus: Record<string, number>; byDate: Record<string, number> }> {\n    console.log(`üîç [DB IMPACT CALCULATION] Calculating impact for recurring task ${id}`);\n    \n    // Find all affected instances (pending + in-progress, preserve completed)\n    const affectedInstances = await db.select()\n      .from(tasks)\n      .where(and(\n        eq(tasks.recurringTaskId, id),\n        or(eq(tasks.status, 'pending'), eq(tasks.status, 'in_progress')),\n        gte(tasks.dueDate, new Date())\n      ));\n\n    // Group by status\n    const byStatus: Record<string, number> = {};\n    const byDate: Record<string, number> = {};\n    let conflictCount = 0;\n\n    for (const instance of affectedInstances) {\n      // Count by status\n      byStatus[instance.status] = (byStatus[instance.status] || 0) + 1;\n      \n      // Count by date (group by month for readability)\n      if (instance.dueDate) {\n        const monthKey = new Date(instance.dueDate).toISOString().substring(0, 7); // YYYY-MM\n        byDate[monthKey] = (byDate[monthKey] || 0) + 1;\n      }\n      \n      // Check for potential conflicts (simplified logic)\n      if (instance.status === 'in_progress' && changedFields.some(f => ['title', 'description', 'checklistTemplate'].includes(f.field))) {\n        conflictCount++;\n      }\n    }\n\n    const result = {\n      affectedCount: affectedInstances.length,\n      conflictCount,\n      byStatus,\n      byDate\n    };\n\n    console.log(`üìä [DB IMPACT RESULT] ${result.affectedCount} tasks affected, ${result.conflictCount} conflicts`);\n    return result;\n  }\n\n  async deleteRecurringTask(id: number): Promise<boolean> {\n    console.log('üóëÔ∏è [DB DELETE] Deleting recurring task with associated tasks:', id);\n    \n    try {\n      // First, check if the recurring task exists\n      const recurringTask = await db.select().from(recurringTasks).where(eq(recurringTasks.id, id)).limit(1);\n      if (recurringTask.length === 0) {\n        console.log('üö´ [DB DELETE] Recurring task not found:', id);\n        return false;\n      }\n\n      // Delete associated future pending tasks (preserve completed and in-progress)\n      const now = new Date();\n      now.setHours(0, 0, 0, 0);\n      \n      const deletedTasks = await db.delete(tasks)\n        .where(\n          and(\n            eq(tasks.recurringTaskId, id),\n            eq(tasks.status, 'pending')\n            // Note: We delete ALL pending tasks regardless of date since we want to clean up all future instances\n          )\n        );\n      \n      console.log(`üóëÔ∏è [DB DELETE] Deleted ${deletedTasks.rowCount || 0} future pending tasks for recurring task ${id}`);\n\n      // Delete the recurring task\n      const result = await db.delete(recurringTasks).where(eq(recurringTasks.id, id));\n      \n      console.log(`üóëÔ∏è [DB DELETE] Successfully deleted recurring task ${id}`);\n      return result.rowCount > 0;\n    } catch (error) {\n      console.error('üö® [DB DELETE] Error deleting recurring task:', error);\n      throw error;\n    }\n  }\n\n  async resetRecurringTasks(): Promise<boolean> {\n    await db.delete(recurringTasks);\n    return true;\n  }\n\n  // Other stub implementations to satisfy interface\n  async getGrowingSystem(id: number): Promise<GrowingSystem | undefined> { return undefined; }\n  async getAllGrowingSystems(): Promise<GrowingSystem[]> { return []; }\n  async getGrowingSystemsByLocation(locationId: string): Promise<GrowingSystem[]> { return []; }\n  async createGrowingSystem(systemData: InsertGrowingSystem): Promise<GrowingSystem> { throw new Error('Not implemented'); }\n  async updateGrowingSystem(id: number, updates: Partial<GrowingSystem>): Promise<GrowingSystem | undefined> { return undefined; }\n  async deleteGrowingSystem(id: number): Promise<boolean> { return false; }\n  \n  async getTray(id: string): Promise<Tray | undefined> { return undefined; }\n  async getAllTrays(): Promise<Tray[]> { return []; }\n  async getTraysByLocation(locationId: string): Promise<Tray[]> { return []; }\n  async createTray(trayData: InsertTray): Promise<Tray> { throw new Error('Not implemented'); }\n  async updateTray(id: string, updates: Partial<Tray>): Promise<Tray | undefined> { return undefined; }\n  async deleteTray(id: string): Promise<boolean> { return false; }\n  \n  async createTrayMovement(movementData: InsertTrayMovement): Promise<TrayMovement> { throw new Error('Not implemented'); }\n  async getTrayMovements(trayId: string): Promise<TrayMovement[]> { return []; }\n  \n  async addInventoryTransaction(transactionData: InsertInventoryTransaction): Promise<InventoryTransaction> { throw new Error('Not implemented'); }\n  async getInventoryTransactions(itemId?: number): Promise<InventoryTransaction[]> { return []; }\n  \n  async createCourseAssignment(assignmentData: InsertCourseAssignment): Promise<CourseAssignment> { throw new Error('Not implemented'); }\n  async getCourseAssignments(userId?: number): Promise<CourseAssignment[]> { return []; }\n  async updateCourseAssignment(id: number, updates: Partial<CourseAssignment>): Promise<CourseAssignment | undefined> { return undefined; }\n  \n  // Course Assignment methods (matching routes.ts expectations)\n  async getCourseAssignment(id: number): Promise<CourseAssignment | undefined> { return undefined; }\n  async getAllCourseAssignments(): Promise<CourseAssignment[]> { return []; }\n  async getCourseAssignmentsByUser(userId: number): Promise<CourseAssignment[]> { return []; }\n  async deleteCourseAssignment(id: number): Promise<boolean> { return false; }\n  \n  // Notification methods (matching routes.ts expectations)\n  async getNotification(id: number): Promise<Notification | undefined> { return undefined; }\n  async getAllNotifications(): Promise<Notification[]> { return []; }\n  async getNotificationsByUser(userId: number): Promise<Notification[]> { return []; }\n  async createNotification(notificationData: InsertNotification): Promise<Notification> { throw new Error('Not implemented'); }\n  async updateNotification(id: number, updates: Partial<Notification>): Promise<Notification | undefined> { return undefined; }\n  async markNotificationAsRead(id: number): Promise<Notification | undefined> { return undefined; }\n  async markAllNotificationsAsRead(userId: number): Promise<void> { return; }\n  async deleteNotification(id: number): Promise<boolean> { return false; }\n  \n  // Training methods (matching interface)\n  async getTrainingModule(id: number): Promise<TrainingModule | undefined> { return undefined; }\n  async getAllTrainingModules(): Promise<TrainingModule[]> { return []; }\n  async createTrainingModule(moduleData: InsertTrainingModule): Promise<TrainingModule> { throw new Error('Not implemented'); }\n  async getUserProgress(userId: number): Promise<UserProgress[]> { return []; }\n  async updateUserProgress(progressData: InsertUserProgress): Promise<UserProgress> { throw new Error('Not implemented'); }\n  \n  // Task logs\n  async createTaskLog(logData: InsertTaskLog): Promise<TaskLog> { throw new Error('Not implemented'); }\n  async getTaskLogs(taskId: number): Promise<TaskLog[]> { return []; }\n  \n  // Task generation methods - generate DATABASE entries from recurring tasks\n  async regenerateAllTaskInstances(): Promise<{ totalTasksCreated: number; recurringTasksProcessed: number }> {\n    console.log('üîÑ DatabaseStorage.regenerateAllTaskInstances() - generating task instances from recurring tasks...');\n    \n    // Get all active recurring tasks\n    const activeRecurringTasks = await db.select().from(recurringTasks).where(eq(recurringTasks.isActive, true));\n    console.log(`üìã Found ${activeRecurringTasks.length} active recurring tasks to process`);\n    \n    let totalTasksCreated = 0;\n    let recurringTasksProcessed = 0;\n    \n    const now = new Date();\n    const currentDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());\n    \n    for (const recurringTask of activeRecurringTasks) {\n      try {\n        const tasksCreated = await this.generateTaskInstancesForRecurringTask(recurringTask, currentDate);\n        totalTasksCreated += tasksCreated;\n        recurringTasksProcessed++;\n        \n        if (tasksCreated > 0) {\n          console.log(`‚úÖ Generated ${tasksCreated} task instances for \"${recurringTask.title}\" (${recurringTask.frequency})`);\n        }\n      } catch (error) {\n        console.error(`‚ùå Error generating tasks for recurring task ${recurringTask.id}: ${error}`);\n      }\n    }\n    \n    console.log(`üéØ DatabaseStorage task generation complete: ${totalTasksCreated} tasks created from ${recurringTasksProcessed} recurring tasks`);\n    return { totalTasksCreated, recurringTasksProcessed };\n  }\n  async regenerateTaskInstances(recurringTaskId: number): Promise<boolean> {\n    // Get the specific recurring task\n    const [recurringTask] = await db.select().from(recurringTasks).where(eq(recurringTasks.id, recurringTaskId));\n    if (!recurringTask || !recurringTask.isActive) {\n      return false;\n    }\n    \n    const currentDate = new Date();\n    const tasksCreated = await this.generateTaskInstancesForRecurringTask(recurringTask, currentDate);\n    return tasksCreated > 0;\n  }\n\n  // Task verification system - checks for missing tasks and duplicates in 31-day window\n  async verifyTaskIntegrity(): Promise<{\n    missingTasksCreated: number;\n    duplicatesRemoved: number;\n    errors: string[];\n    verificationReport: string[];\n  }> {\n    const report: string[] = [];\n    const errors: string[] = [];\n    let missingTasksCreated = 0;\n    let duplicatesRemoved = 0;\n\n    try {\n      report.push(`üîç Starting task integrity verification at ${new Date().toISOString()}`);\n      \n      // Get all active recurring tasks\n      const activeRecurringTasks = await db.select().from(recurringTasks).where(eq(recurringTasks.isActive, true));\n      report.push(`üìã Found ${activeRecurringTasks.length} active recurring tasks to verify`);\n\n      const currentDate = new Date();\n      const endDate = new Date(currentDate);\n      endDate.setDate(currentDate.getDate() + 31); // 31-day window\n\n      for (const recurringTask of activeRecurringTasks) {\n        try {\n          // Check what tasks should exist for this recurring task in the 31-day window\n          const expectedTasks = await this.generateExpectedTaskDates(recurringTask, currentDate, endDate);\n          \n          \n          // Check what tasks actually exist\n          const existingTasks = await db.select().from(tasks).where(\n            and(\n              eq(tasks.title, recurringTask.title),\n              eq(tasks.location, recurringTask.location),\n              gte(tasks.taskDate, currentDate),\n              lte(tasks.taskDate, endDate)\n            )\n          );\n\n          // Find missing tasks\n          const existingTaskDates = new Set(existingTasks.map(t => t.taskDate?.toDateString()));\n          const missingDates = expectedTasks.filter(date => !existingTaskDates.has(date.toDateString()));\n          \n          \n          // Create missing tasks\n          for (const missingDate of missingDates) {\n            // Race condition protection: check if task already exists before creation\n            const existingTaskCheck = await db.select().from(tasks).where(\n              and(\n                eq(tasks.title, recurringTask.title),\n                eq(tasks.location, recurringTask.location),\n                sql`DATE(${tasks.taskDate}) = ${missingDate.toISOString().split('T')[0]}`\n              )\n            ).limit(1);\n            \n            if (existingTaskCheck.length > 0) {\n              // Task was created by another verification run, skip\n              continue;\n            }\n            \n            const dueDate = recurringTask.frequency === 'daily' ? new Date(missingDate) : new Date(missingDate.getTime() + (7 * 24 * 60 * 60 * 1000));\n            \n            try {\n              await db.insert(tasks).values({\n                title: recurringTask.title,\n                description: recurringTask.description,\n                type: recurringTask.type,\n                status: 'pending',\n              priority: 'medium',\n              assignedTo: null,\n              assignTo: recurringTask.assignTo,\n              createdBy: recurringTask.createdBy,\n              location: recurringTask.location,\n              taskDate: missingDate,\n              dueDate: dueDate,\n              frequency: recurringTask.frequency,\n              isRecurring: true,\n              recurringTaskId: recurringTask.id, // CRITICAL FIX: Add missing recurringTaskId field\n              estimatedTime: null,\n              actualTime: null,\n              progress: 0,\n              checklist: recurringTask.checklistTemplate?.steps || [],\n              data: {},\n              visibleFromDate: missingDate,\n              startedAt: null,\n              completedAt: null,\n              pausedAt: null,\n              resumedAt: null,\n              skippedAt: null,\n              deletedRecurringTaskId: null,\n              deletedRecurringTaskTitle: null\n            });\n              \n              missingTasksCreated++;\n              report.push(`‚úÖ Created missing task \"${recurringTask.title}\" for ${missingDate.toDateString()}`);\n            } catch (insertError) {\n              // Handle duplicate insertion errors (race condition)\n              if (insertError.code === '23505' || insertError.message?.includes('duplicate')) {\n                // Duplicate key violation - task was created by another process\n                continue;\n              }\n              // Re-throw other errors\n              throw insertError;\n            }\n          }\n\n          // Find and remove duplicates (same title, location, and taskDate)\n          const tasksByDate = new Map<string, typeof existingTasks>();\n          for (const task of existingTasks) {\n            const dateKey = task.taskDate?.toDateString();\n            if (dateKey) {\n              if (tasksByDate.has(dateKey)) {\n                // Found duplicate - remove the one with higher ID (newer)\n                const existing = tasksByDate.get(dateKey)!;\n                const duplicateTask = task.id > existing[0].id ? task : existing[0];\n                \n                await db.delete(tasks).where(eq(tasks.id, duplicateTask.id));\n                duplicatesRemoved++;\n                report.push(`üóëÔ∏è Removed duplicate task \"${recurringTask.title}\" (ID: ${duplicateTask.id}) for ${dateKey}`);\n                \n                // Keep the older task in the map\n                if (task.id < existing[0].id) {\n                  tasksByDate.set(dateKey, [task]);\n                }\n              } else {\n                tasksByDate.set(dateKey, [task]);\n              }\n            }\n          }\n\n        } catch (error) {\n          const errorMsg = `‚ùå Error verifying recurring task \"${recurringTask.title}\": ${error}`;\n          errors.push(errorMsg);\n          report.push(errorMsg);\n        }\n      }\n\n      report.push(`üéØ Verification complete: ${missingTasksCreated} missing tasks created, ${duplicatesRemoved} duplicates removed`);\n      \n    } catch (error) {\n      const errorMsg = `‚ùå Critical error during task verification: ${error}`;\n      errors.push(errorMsg);\n      report.push(errorMsg);\n    }\n\n    return {\n      missingTasksCreated,\n      duplicatesRemoved,\n      errors,\n      verificationReport: report\n    };\n  }\n\n  // CRITICAL DATA REPAIR: Fix orphaned task instances by linking them to proper recurring task templates\n  async repairOrphanedTaskLinkage(): Promise<{\n    orphanedTasksFound: number;\n    tasksLinked: number;\n    unmatchedTasks: number;\n    errors: string[];\n    repairReport: string[];\n  }> {\n    const report: string[] = [];\n    const errors: string[] = [];\n    let orphanedTasksFound = 0;\n    let tasksLinked = 0;\n    let unmatchedTasks = 0;\n\n    try {\n      report.push(`üîß Starting orphaned task linkage repair at ${new Date().toISOString()}`);\n      \n      // Find all orphaned tasks (those that should be recurring but lack proper linkage)\n      const orphanedTasks = await db.select().from(tasks).where(\n        and(\n          or(\n            isNull(tasks.recurringTaskId),\n            eq(tasks.recurringTaskId, 0)\n          ),\n          eq(tasks.isRecurring, false) // These are likely orphaned instances\n        )\n      );\n\n      orphanedTasksFound = orphanedTasks.length;\n      report.push(`üìã Found ${orphanedTasksFound} potentially orphaned tasks`);\n\n      if (orphanedTasksFound === 0) {\n        report.push(`‚úÖ No orphaned tasks found - all tasks properly linked`);\n        return {\n          orphanedTasksFound: 0,\n          tasksLinked: 0,\n          unmatchedTasks: 0,\n          errors,\n          repairReport: report\n        };\n      }\n\n      // Get all active recurring task templates for matching\n      const recurringTemplates = await db.select().from(recurringTasks).where(eq(recurringTasks.isActive, true));\n      report.push(`üéØ Using ${recurringTemplates.length} active recurring task templates for matching`);\n\n      // Create efficient lookup maps for matching\n      const templatesByExactMatch = new Map<string, typeof recurringTemplates[0]>();\n      const templatesByTitle = new Map<string, typeof recurringTemplates[0][]>();\n\n      for (const template of recurringTemplates) {\n        // Exact match key: title + location + type + frequency + assignment\n        const exactKey = `${template.title}|${template.location}|${template.type}|${template.frequency}|${template.assignTo || ''}`;\n        templatesByExactMatch.set(exactKey, template);\n\n        // Title-based lookup for fallback matching\n        const titleKey = template.title.toLowerCase().trim();\n        if (!templatesByTitle.has(titleKey)) {\n          templatesByTitle.set(titleKey, []);\n        }\n        templatesByTitle.get(titleKey)!.push(template);\n      }\n\n      // Process orphaned tasks in batches for efficiency\n      const batchSize = 50;\n      const batches = [];\n      for (let i = 0; i < orphanedTasks.length; i += batchSize) {\n        batches.push(orphanedTasks.slice(i, i + batchSize));\n      }\n\n      for (const batch of batches) {\n        for (const task of batch) {\n          try {\n            let matchedTemplate = null;\n\n            // Strategy 1: Exact match (highest confidence)\n            const exactKey = `${task.title}|${task.location}|${task.type}|${task.frequency}|${task.assignTo || ''}`;\n            matchedTemplate = templatesByExactMatch.get(exactKey);\n\n            // Strategy 2: Title + Location match (high confidence)\n            if (!matchedTemplate && task.title) {\n              const titleCandidates = templatesByTitle.get(task.title.toLowerCase().trim());\n              if (titleCandidates) {\n                matchedTemplate = titleCandidates.find(t => t.location === task.location);\n              }\n            }\n\n            // Strategy 3: Title-only match (medium confidence, prefer first match)\n            if (!matchedTemplate && task.title) {\n              const titleCandidates = templatesByTitle.get(task.title.toLowerCase().trim());\n              if (titleCandidates && titleCandidates.length === 1) {\n                // Only auto-match if there's exactly one template with this title\n                matchedTemplate = titleCandidates[0];\n              }\n            }\n\n            // Strategy 4: Fuzzy title matching for common variations\n            if (!matchedTemplate && task.title) {\n              const taskTitle = task.title.toLowerCase().trim();\n              for (const [templateTitle, candidates] of templatesByTitle.entries()) {\n                // Check for close title matches (accounting for minor variations)\n                if (this.isSimilarTitle(taskTitle, templateTitle)) {\n                  const locationMatch = candidates.find(t => t.location === task.location);\n                  if (locationMatch) {\n                    matchedTemplate = locationMatch;\n                    break;\n                  }\n                }\n              }\n            }\n\n            if (matchedTemplate) {\n              // Update the orphaned task with the correct recurringTaskId\n              await db.update(tasks)\n                .set({ \n                  recurringTaskId: matchedTemplate.id,\n                  isRecurring: true,\n                  // Fix any assignment discrepancies while we're at it\n                  assignTo: matchedTemplate.assignTo || task.assignTo\n                })\n                .where(eq(tasks.id, task.id));\n\n              tasksLinked++;\n              report.push(`‚úÖ Linked task \"${task.title}\" (ID: ${task.id}) to recurring template \"${matchedTemplate.title}\" (ID: ${matchedTemplate.id})`);\n            } else {\n              unmatchedTasks++;\n              report.push(`‚ö†Ô∏è Could not match orphaned task \"${task.title}\" (ID: ${task.id}, Location: ${task.location}, Type: ${task.type})`);\n            }\n\n          } catch (error) {\n            const errorMsg = `‚ùå Error linking task \"${task.title}\" (ID: ${task.id}): ${error}`;\n            errors.push(errorMsg);\n            report.push(errorMsg);\n          }\n        }\n      }\n\n      report.push(`üéØ Repair complete: ${tasksLinked} tasks linked, ${unmatchedTasks} unmatched, ${errors.length} errors`);\n      \n    } catch (error) {\n      const errorMsg = `‚ùå Critical error during orphaned task repair: ${error}`;\n      errors.push(errorMsg);\n      report.push(errorMsg);\n    }\n\n    return {\n      orphanedTasksFound,\n      tasksLinked,\n      unmatchedTasks,\n      errors,\n      repairReport: report\n    };\n  }\n\n  // Helper method to check if two titles are similar (handles minor variations)\n  private isSimilarTitle(title1: string, title2: string): boolean {\n    // Remove common variations and normalize\n    const normalize = (str: string) => {\n      return str\n        .toLowerCase()\n        .replace(/\\s+/g, ' ')\n        .replace(/[^\\w\\s]/g, '')\n        .trim();\n    };\n\n    const norm1 = normalize(title1);\n    const norm2 = normalize(title2);\n\n    // Exact match after normalization\n    if (norm1 === norm2) return true;\n\n    // Check if one title contains the other (handles shortened versions)\n    if (norm1.includes(norm2) || norm2.includes(norm1)) return true;\n\n    // Check for common word overlap (at least 70% of words match)\n    const words1 = norm1.split(' ');\n    const words2 = norm2.split(' ');\n    const commonWords = words1.filter(w => words2.includes(w));\n    const similarityRatio = commonWords.length / Math.max(words1.length, words2.length);\n    \n    return similarityRatio >= 0.7;\n  }\n\n  // Helper function to generate expected task dates for a recurring task\n  private async generateExpectedTaskDates(recurringTask: any, startDate: Date, endDate: Date): Promise<Date[]> {\n    const expectedDates: Date[] = [];\n    \n    switch (recurringTask.frequency) {\n      case 'daily': {\n        // Parse the daysOfWeek array\n        let selectedDays: string[] = [];\n        try {\n          if (typeof recurringTask.daysOfWeek === 'string') {\n            selectedDays = JSON.parse(recurringTask.daysOfWeek);\n          } else if (Array.isArray(recurringTask.daysOfWeek)) {\n            selectedDays = recurringTask.daysOfWeek;\n          }\n        } catch (error) {\n          return expectedDates; // Return empty if can't parse\n        }\n\n        if (!selectedDays || selectedDays.length === 0) {\n          return expectedDates; // Return empty if no days selected\n        }\n\n        const normalizedSelectedDays = selectedDays.map(day => day.toLowerCase());\n        const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];\n        \n        // Check each day in the date range\n        for (let dayOffset = 0; dayOffset <= Math.ceil((endDate.getTime() - startDate.getTime()) / (24 * 60 * 60 * 1000)); dayOffset++) {\n          const checkDate = new Date(startDate);\n          checkDate.setDate(startDate.getDate() + dayOffset);\n          \n          if (checkDate > endDate) break;\n          \n          const dayIndex = checkDate.getUTCDay();\n          const dayName = dayNames[dayIndex];\n          \n          if (normalizedSelectedDays.includes(dayName)) {\n            expectedDates.push(new Date(checkDate));\n          }\n        }\n        break;\n      }\n      \n      case 'weekly': {\n        // Similar logic for weekly tasks\n        let selectedDays: string[] = [];\n        try {\n          if (typeof recurringTask.daysOfWeek === 'string') {\n            selectedDays = JSON.parse(recurringTask.daysOfWeek);\n          } else if (Array.isArray(recurringTask.daysOfWeek)) {\n            selectedDays = recurringTask.daysOfWeek;\n          }\n        } catch (error) {\n          return expectedDates;\n        }\n\n        if (!selectedDays || selectedDays.length === 0) {\n          return expectedDates;\n        }\n\n        const normalizedSelectedDays = selectedDays.map(day => day.toLowerCase());\n        const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];\n        \n        // Check each day in the date range\n        for (let dayOffset = 0; dayOffset <= Math.ceil((endDate.getTime() - startDate.getTime()) / (24 * 60 * 60 * 1000)); dayOffset++) {\n          const checkDate = new Date(startDate);\n          checkDate.setDate(startDate.getDate() + dayOffset);\n          \n          if (checkDate > endDate) break;\n          \n          const dayIndex = checkDate.getUTCDay();\n          const dayName = dayNames[dayIndex];\n          \n          if (normalizedSelectedDays.includes(dayName)) {\n            expectedDates.push(new Date(checkDate));\n          }\n        }\n        break;\n      }\n      \n      case 'bi-weekly': {\n        // Generate bi-weekly instances\n        for (let period = 0; period < 4; period++) {\n          const taskDate = new Date(startDate);\n          taskDate.setDate(startDate.getDate() + (period * 14));\n          \n          if (taskDate <= endDate) {\n            expectedDates.push(taskDate);\n          }\n        }\n        break;\n      }\n    }\n    \n    return expectedDates;\n  }\n  \n  private async generateTaskInstancesForRecurringTask(recurringTask: any, baseDate: Date): Promise<number> {\n    let tasksCreated = 0;\n    const tasksToCreate: any[] = [];\n    \n    const endDate = new Date(baseDate);\n    endDate.setDate(endDate.getDate() + 31);\n    console.log(`üìÖ Generating from: ${baseDate.toISOString().split('T')[0]} to: ${endDate.toISOString().split('T')[0]} for \"${recurringTask.title}\"`);\n    \n    // Generate instances based on frequency\n    switch (recurringTask.frequency) {\n      case 'weekly': {\n        // Parse the daysOfWeek array - critical for weekly task filtering\n        let selectedDays: string[] = [];\n        try {\n          if (typeof recurringTask.daysOfWeek === 'string') {\n            selectedDays = JSON.parse(recurringTask.daysOfWeek);\n          } else if (Array.isArray(recurringTask.daysOfWeek)) {\n            selectedDays = recurringTask.daysOfWeek;\n          }\n        } catch (error) {\n          console.error(`‚ùå Failed to parse daysOfWeek for \"${recurringTask.title}\":`, error);\n          break; // Skip this task if daysOfWeek is invalid\n        }\n\n        if (!selectedDays || selectedDays.length === 0) {\n          console.log(`‚ö†Ô∏è No selectedDays for weekly task \"${recurringTask.title}\" - skipping`);\n          break; // Skip tasks with no selected days\n        }\n\n        // Normalize day names to lowercase for comparison\n        const normalizedSelectedDays = selectedDays.map(day => day.toLowerCase());\n        \n        // Generate for the next 31 days, checking each day\n        for (let dayOffset = 0; dayOffset < 31; dayOffset++) {\n          const taskDate = new Date(baseDate);\n          taskDate.setDate(taskDate.getDate() + dayOffset);\n          \n          // TIMEZONE FIX: Use UTC-based day calculation to match database storage\n          // This ensures day name calculation matches the UTC date stored in database\n          const utcDayIndex = taskDate.getUTCDay(); // 0 = Sunday, 1 = Monday, etc.\n          const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];\n          const dayName = dayNames[utcDayIndex];\n          \n          if (dayOffset === 0) {\n            console.log(`  üîç Loop day 0: baseDate=${baseDate.toISOString().split('T')[0]}, taskDate=${taskDate.toISOString().split('T')[0]}, dayName=${dayName}`);\n          }\n          \n          // CRITICAL: Only create task if this day matches selectedDays\n          if (!normalizedSelectedDays.includes(dayName)) {\n            continue; // Skip this day - not in selectedDays\n          }\n          \n          if (tasksToCreate.length === 0) {\n            console.log(`  ‚úÖ First match! dayOffset=${dayOffset}, taskDate=${taskDate.toISOString().split('T')[0]}, dayName=${dayName}`);\n          }\n          \n          const dueDate = new Date(taskDate);\n          dueDate.setDate(dueDate.getDate() + 6); // Due at end of week\n          \n          // Check if this task instance already exists\n          const [existing] = await db.select().from(tasks).where(\n            and(\n              eq(tasks.title, recurringTask.title),\n              eq(tasks.taskDate, taskDate),\n              eq(tasks.location, recurringTask.location)\n            )\n          );\n          \n          if (!existing) {\n            tasksToCreate.push({\n              title: recurringTask.title,\n              description: recurringTask.description,\n              type: recurringTask.type,\n              status: 'pending',\n              priority: 'medium',\n              assignedTo: null,\n              assignTo: recurringTask.assignTo,\n              createdBy: recurringTask.createdBy,\n              location: recurringTask.location,\n              taskDate: taskDate,\n              dueDate: dueDate,\n              frequency: recurringTask.frequency,\n              isRecurring: true,\n              recurringTaskId: recurringTask.id,\n              estimatedTime: null,\n              actualTime: null,\n              progress: 0,\n              checklist: recurringTask.checklistTemplate?.steps || [],\n              data: {},\n              visibleFromDate: taskDate,\n              startedAt: null,\n              completedAt: null,\n              pausedAt: null,\n              resumedAt: null,\n              skippedAt: null,\n              deletedRecurringTaskId: null,\n              deletedRecurringTaskTitle: null\n            });\n          }\n        }\n        break;\n      }\n      \n      case 'daily': {\n        // Parse the daysOfWeek array - critical for daily task filtering\n        let selectedDays: string[] = [];\n        try {\n          if (typeof recurringTask.daysOfWeek === 'string') {\n            selectedDays = JSON.parse(recurringTask.daysOfWeek);\n          } else if (Array.isArray(recurringTask.daysOfWeek)) {\n            selectedDays = recurringTask.daysOfWeek;\n          }\n        } catch (error) {\n          console.error(`‚ùå Failed to parse daysOfWeek for \"${recurringTask.title}\":`, error);\n          break; // Skip this task if daysOfWeek is invalid\n        }\n\n        if (!selectedDays || selectedDays.length === 0) {\n          console.log(`‚ö†Ô∏è No selectedDays for daily task \"${recurringTask.title}\" - skipping`);\n          break; // Skip tasks with no selected days\n        }\n\n        // Normalize day names to lowercase for comparison\n        const normalizedSelectedDays = selectedDays.map(day => day.toLowerCase());\n        \n        // Generate for the next 31 days, checking each day\n        for (let dayOffset = 0; dayOffset < 31; dayOffset++) {\n          const taskDate = new Date(baseDate);\n          taskDate.setDate(taskDate.getDate() + dayOffset);\n          \n          // TIMEZONE FIX: Use UTC-based day calculation to match database storage\n          // This ensures day name calculation matches the UTC date stored in database\n          const utcDayIndex = taskDate.getUTCDay(); // 0 = Sunday, 1 = Monday, etc.\n          const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];\n          const dayName = dayNames[utcDayIndex];\n          \n          // CRITICAL: Only create task if this day matches selectedDays\n          if (!normalizedSelectedDays.includes(dayName)) {\n            continue; // Skip this day - not in selectedDays\n          }\n          \n          // Daily tasks are due on the same day\n          const dueDate = new Date(taskDate);\n          \n          // Check if this task instance already exists\n          const [existing] = await db.select().from(tasks).where(\n            and(\n              eq(tasks.title, recurringTask.title),\n              eq(tasks.taskDate, taskDate),\n              eq(tasks.location, recurringTask.location)\n            )\n          );\n          \n          if (!existing) {\n            tasksToCreate.push({\n              title: recurringTask.title,\n              description: recurringTask.description,\n              type: recurringTask.type,\n              status: 'pending',\n              priority: 'medium',\n              assignedTo: null,\n              assignTo: recurringTask.assignTo,\n              createdBy: recurringTask.createdBy,\n              location: recurringTask.location,\n              taskDate: taskDate,\n              dueDate: dueDate,\n              frequency: recurringTask.frequency,\n              isRecurring: true,\n              recurringTaskId: recurringTask.id, // CRITICAL FIX: Add missing recurringTaskId field\n              estimatedTime: null,\n              actualTime: null,\n              progress: 0,\n              checklist: recurringTask.checklistTemplate?.steps || [],\n              data: {},\n              visibleFromDate: taskDate,\n              startedAt: null,\n              completedAt: null,\n              pausedAt: null,\n              resumedAt: null,\n              skippedAt: null,\n              deletedRecurringTaskId: null,\n              deletedRecurringTaskTitle: null\n            });\n            console.log(`‚úÖ Creating daily task \"${recurringTask.title}\" for ${dayName} (${taskDate.toDateString()})`);\n          }\n        }\n        break;\n      }\n      \n      case 'bi-weekly': {\n        // Generate for the next 8 weeks (4 bi-weekly instances)\n        for (let period = 0; period < 4; period++) {\n          const taskDate = new Date(baseDate);\n          taskDate.setDate(taskDate.getDate() + (period * 14));\n          \n          const dueDate = new Date(taskDate);\n          dueDate.setDate(dueDate.getDate() + 13); // Due at end of 2-week period\n          \n          const [existing] = await db.select().from(tasks).where(\n            and(\n              eq(tasks.title, recurringTask.title),\n              eq(tasks.taskDate, taskDate),\n              eq(tasks.location, recurringTask.location)\n            )\n          );\n          \n          if (!existing) {\n            tasksToCreate.push({\n              title: recurringTask.title,\n              description: recurringTask.description,\n              type: recurringTask.type,\n              status: 'pending',\n              priority: 'medium',\n              assignedTo: null,\n              assignTo: recurringTask.assignTo,\n              createdBy: recurringTask.createdBy,\n              location: recurringTask.location,\n              taskDate: taskDate,\n              dueDate: dueDate,\n              frequency: recurringTask.frequency,\n              isRecurring: true,\n              recurringTaskId: recurringTask.id, // CRITICAL FIX: Add missing recurringTaskId field\n              estimatedTime: null,\n              actualTime: null,\n              progress: 0,\n              checklist: recurringTask.checklistTemplate?.steps || [],\n              data: {},\n              visibleFromDate: taskDate,\n              startedAt: null,\n              completedAt: null,\n              pausedAt: null,\n              resumedAt: null,\n              skippedAt: null,\n              deletedRecurringTaskId: null,\n              deletedRecurringTaskTitle: null\n            });\n          }\n        }\n        break;\n      }\n      \n      case 'monthly': {\n        // Monthly tasks already exist, skip for now\n        break;\n      }\n    }\n    \n    // Insert all new tasks\n    if (tasksToCreate.length > 0) {\n      await db.insert(tasks).values(tasksToCreate);\n      tasksCreated = tasksToCreate.length;\n    }\n    \n    return tasksCreated;\n  }\n  \n  // Tray methods\n  async splitTray(originalTrayId: string, splitData: { splitCount: number; newTrayIds: string[] }): Promise<Tray[]> { return []; }\n  \n  async clearAllData(): Promise<boolean> { return false; }\n\n  // System status and locks - real database implementations\n  async getSystemStatus(id: string): Promise<SystemStatus | undefined> {\n    const [status] = await db.select().from(systemStatus).where(eq(systemStatus.id, id));\n    return status || undefined;\n  }\n\n  async setSystemStatus(status: InsertSystemStatus): Promise<SystemStatus> {\n    const [result] = await db.insert(systemStatus).values(status)\n      .onConflictDoUpdate({\n        target: systemStatus.id,\n        set: {\n          lastGenerationDate: status.lastGenerationDate,\n          generatedThrough: status.generatedThrough,\n          lastUpdateBy: status.lastUpdateBy,\n          updatedAt: sql`NOW()`\n        }\n      }).returning();\n    return result;\n  }\n\n  async acquireLock(lockId: string, userId: number, lockType: string, expirationMinutes = 10): Promise<SystemLock | null> {\n    try {\n      // First check if lock exists and is expired\n      const [existingLock] = await db.select().from(systemLocks).where(eq(systemLocks.id, lockId));\n      \n      if (existingLock && existingLock.expiresAt && new Date() > existingLock.expiresAt) {\n        // Lock expired, remove it\n        await db.delete(systemLocks).where(eq(systemLocks.id, lockId));\n      } else if (existingLock) {\n        // Lock still active\n        return null;\n      }\n\n      // Try to acquire lock\n      const expiresAt = new Date(Date.now() + expirationMinutes * 60 * 1000);\n      const [newLock] = await db.insert(systemLocks).values({\n        id: lockId,\n        lockedBy: userId,\n        lockType: lockType,\n        expiresAt: expiresAt\n      }).returning();\n      \n      return newLock;\n    } catch (error) {\n      // Lock acquisition failed (someone else got it)\n      console.error(`‚ùå Lock acquisition failed for ${lockId}:`, error);\n      return null;\n    }\n  }\n\n  async releaseLock(lockId: string): Promise<boolean> {\n    const result = await db.delete(systemLocks).where(eq(systemLocks.id, lockId));\n    return result.rowCount > 0;\n  }\n\n  async checkLock(lockId: string): Promise<SystemLock | null> {\n    const [lock] = await db.select().from(systemLocks).where(eq(systemLocks.id, lockId));\n    \n    if (!lock) return null;\n    \n    // Check if expired\n    if (lock.expiresAt && new Date() > lock.expiresAt) {\n      // Auto-remove expired lock\n      await db.delete(systemLocks).where(eq(systemLocks.id, lockId));\n      return null;\n    }\n    \n    return lock;\n  }\n\n  // Add missing initializeAppVerification method for automatic task generation\n  async initializeAppVerification(userId: number = 1): Promise<void> {\n    console.log(`üîÑ DatabaseStorage: Initializing app verification for user ${userId}`);\n    \n    try {\n      // Run the verification to generate missing tasks\n      const result = await this.verifyTaskIntegrity();\n      \n      if (result.missingTasksCreated > 0 || result.duplicatesRemoved > 0) {\n        console.log(`‚úÖ Verification completed: ${result.missingTasksCreated} tasks created, ${result.duplicatesRemoved} duplicates removed`);\n      } else {\n        console.log('‚úÖ Verification completed: No tasks needed generation');\n      }\n    } catch (error) {\n      console.error('‚ùå Error during task verification:', error);\n    }\n  }\n}\n\n// Hybrid Storage: Database for users/staff, Memory for other features\nclass HybridStorage implements IStorage {\n  private dbStorage = new DatabaseStorage();\n  private memStorage = new MemStorage();\n\n  // User methods - use DATABASE for persistence\n  async getUser(id: number): Promise<User | undefined> {\n    return this.dbStorage.getUser(id);\n  }\n\n  async getUserByUsername(username: string): Promise<User | undefined> {\n    return this.dbStorage.getUserByUsername(username);\n  }\n\n  async createUser(userData: InsertUser): Promise<User> {\n    return this.dbStorage.createUser(userData);\n  }\n\n  async updateUser(id: number, updates: Partial<User>): Promise<User | undefined> {\n    return this.dbStorage.updateUser(id, updates);\n  }\n\n  async getAllUsers(): Promise<User[]> {\n    return this.dbStorage.getAllUsers();\n  }\n\n  // Task methods - use DATABASE storage for persistence and assignment tracking\n  async getTask(id: number): Promise<Task | undefined> {\n    return this.dbStorage.getTask(id);\n  }\n\n  async getTasksByUser(userId: number): Promise<Task[]> {\n    return this.dbStorage.getTasksByUser(userId);\n  }\n\n  async getAllTasks(): Promise<Task[]> {\n    console.log('üîÑ HybridStorage.getAllTasks() - delegating to DatabaseStorage...');\n    const dbTasks = await this.dbStorage.getAllTasks();\n    console.log(`üîç HybridStorage received ${dbTasks.length} tasks from DatabaseStorage`);\n    if (dbTasks.length > 0) {\n      const firstTask = dbTasks[0];\n      const lastTask = dbTasks[dbTasks.length - 1]; \n      console.log(`üîç HybridStorage first task: ${firstTask.title} (dueDate: ${firstTask.dueDate})`);\n      console.log(`üîç HybridStorage last task: ${lastTask.title} (dueDate: ${lastTask.dueDate})`);\n    }\n    return dbTasks;\n  }\n\n  async getTasksByLocation(locationId: string): Promise<Task[]> {\n    return this.dbStorage.getTasksByLocation(locationId);\n  }\n\n  async createTask(taskData: InsertTask): Promise<Task> {\n    return this.dbStorage.createTask(taskData);\n  }\n\n  async updateTask(id: number, updates: Partial<Task>): Promise<Task | undefined> {\n    return this.dbStorage.updateTask(id, updates);\n  }\n\n  async deleteTask(id: number): Promise<boolean> {\n    return this.dbStorage.deleteTask(id);\n  }\n\n  async resetTasks(): Promise<boolean> {\n    return this.dbStorage.resetTasks();\n  }\n\n  async resetTaskSequence(): Promise<void> {\n    return this.dbStorage.resetTaskSequence();\n  }\n\n  async getInventoryItem(id: number): Promise<InventoryItem | undefined> {\n    return this.dbStorage.getInventoryItem(id);\n  }\n\n  async getAllInventoryItems(): Promise<InventoryItem[]> {\n    return this.dbStorage.getAllInventoryItems();\n  }\n\n  async getInventoryItemsByLocation(locationId: string): Promise<InventoryItem[]> {\n    return this.dbStorage.getInventoryItemsByLocation(locationId);\n  }\n\n  async createInventoryItem(itemData: InsertInventoryItem): Promise<InventoryItem> {\n    return this.dbStorage.createInventoryItem(itemData);\n  }\n\n  async updateInventoryItem(id: number, updates: Partial<InventoryItem>): Promise<InventoryItem | undefined> {\n    return this.dbStorage.updateInventoryItem(id, updates);\n  }\n\n  async deleteInventoryItem(id: number): Promise<boolean> {\n    return this.dbStorage.deleteInventoryItem(id);\n  }\n\n  async getLowStockItems(): Promise<InventoryItem[]> {\n    return this.dbStorage.getLowStockItems();\n  }\n\n  async getLowStockItemsByLocation(locationId: string): Promise<InventoryItem[]> {\n    return this.dbStorage.getLowStockItemsByLocation(locationId);\n  }\n\n  async addInventoryStock(data: { itemId: number; quantity: number; unitCost: number; supplier?: string; notes?: string }): Promise<InventoryItem> {\n    return this.dbStorage.addInventoryStock(data);\n  }\n\n  async getTrainingModule(id: number): Promise<TrainingModule | undefined> {\n    return this.memStorage.getTrainingModule(id);\n  }\n\n  async getAllTrainingModules(): Promise<TrainingModule[]> {\n    return this.memStorage.getAllTrainingModules();\n  }\n\n  async createTrainingModule(moduleData: InsertTrainingModule): Promise<TrainingModule> {\n    return this.memStorage.createTrainingModule(moduleData);\n  }\n\n  async getUserProgress(userId: number): Promise<UserProgress[]> {\n    return this.memStorage.getUserProgress(userId);\n  }\n\n  async updateUserProgress(progressData: InsertUserProgress): Promise<UserProgress> {\n    return this.memStorage.updateUserProgress(progressData);\n  }\n\n  async createTaskLog(logData: InsertTaskLog): Promise<TaskLog> {\n    return this.memStorage.createTaskLog(logData);\n  }\n\n  async getTaskLogs(taskId: number): Promise<TaskLog[]> {\n    return this.memStorage.getTaskLogs(taskId);\n  }\n\n  // FIXED: Use database storage for recurring tasks instead of memory storage\n  async getRecurringTask(id: number): Promise<RecurringTask | undefined> {\n    return this.dbStorage.getRecurringTask(id);\n  }\n\n  async getAllRecurringTasks(): Promise<RecurringTask[]> {\n    return this.dbStorage.getAllRecurringTasks();\n  }\n\n  async getRecurringTasksByLocation(locationId: string): Promise<RecurringTask[]> {\n    return this.dbStorage.getRecurringTasksByLocation(locationId);\n  }\n\n  async createRecurringTask(taskData: InsertRecurringTask): Promise<RecurringTask> {\n    return this.dbStorage.createRecurringTask(taskData);\n  }\n\n  async updateRecurringTask(id: number, updates: Partial<RecurringTask>, options?: { strategy?: 'update_all' | 'new_only'; userId?: number }): Promise<{ task: RecurringTask | null; report: any }> {\n    return this.dbStorage.updateRecurringTask(id, updates, options);\n  }\n\n  async calculateUpdateImpact(id: number, changedFields: any[]): Promise<{ affectedCount: number; conflictCount: number; byStatus: Record<string, number>; byDate: Record<string, number> }> {\n    return this.dbStorage.calculateUpdateImpact(id, changedFields);\n  }\n\n  async deleteRecurringTask(id: number): Promise<boolean> {\n    return this.dbStorage.deleteRecurringTask(id);\n  }\n\n  async resetRecurringTasks(): Promise<boolean> {\n    return this.dbStorage.resetRecurringTasks();\n  }\n\n  async getGrowingSystem(id: number): Promise<GrowingSystem | undefined> {\n    return this.memStorage.getGrowingSystem(id);\n  }\n\n  async getAllGrowingSystems(): Promise<GrowingSystem[]> {\n    return this.memStorage.getAllGrowingSystems();\n  }\n\n  async getGrowingSystemsByLocation(locationId: string): Promise<GrowingSystem[]> {\n    return this.memStorage.getGrowingSystemsByLocation(locationId);\n  }\n\n  async createGrowingSystem(systemData: InsertGrowingSystem): Promise<GrowingSystem> {\n    return this.memStorage.createGrowingSystem(systemData);\n  }\n\n  async updateGrowingSystem(id: number, updates: Partial<GrowingSystem>): Promise<GrowingSystem | undefined> {\n    return this.memStorage.updateGrowingSystem(id, updates);\n  }\n\n  async deleteGrowingSystem(id: number): Promise<boolean> {\n    return this.memStorage.deleteGrowingSystem(id);\n  }\n\n  async getTray(id: string): Promise<Tray | undefined> {\n    return this.memStorage.getTray(id);\n  }\n\n  async getAllTrays(): Promise<Tray[]> {\n    return this.memStorage.getAllTrays();\n  }\n\n  async getTraysByLocation(locationId: string): Promise<Tray[]> {\n    return this.memStorage.getTraysByLocation(locationId);\n  }\n\n  async createTray(trayData: InsertTray): Promise<Tray> {\n    return this.memStorage.createTray(trayData);\n  }\n\n  async updateTray(id: string, updates: Partial<Tray>): Promise<Tray | undefined> {\n    return this.memStorage.updateTray(id, updates);\n  }\n\n  async deleteTray(id: string): Promise<boolean> {\n    return this.memStorage.deleteTray(id);\n  }\n\n  async splitTray(originalTrayId: string, splitData: { splitCount: number; newTrayIds: string[] }): Promise<Tray[]> {\n    return this.memStorage.splitTray(originalTrayId, splitData);\n  }\n\n  async createTrayMovement(movementData: InsertTrayMovement): Promise<TrayMovement> {\n    return this.memStorage.createTrayMovement(movementData);\n  }\n\n  async getTrayMovements(trayId: string): Promise<TrayMovement[]> {\n    return this.memStorage.getTrayMovements(trayId);\n  }\n\n  async addInventoryTransaction(transactionData: InsertInventoryTransaction): Promise<InventoryTransaction> {\n    return this.memStorage.addInventoryTransaction(transactionData);\n  }\n\n  async getInventoryTransactions(itemId?: number): Promise<InventoryTransaction[]> {\n    return this.memStorage.getInventoryTransactions(itemId);\n  }\n\n  async getCourseAssignment(id: number): Promise<CourseAssignment | undefined> {\n    return this.memStorage.getCourseAssignment(id);\n  }\n\n  async getAllCourseAssignments(): Promise<CourseAssignment[]> {\n    return this.memStorage.getAllCourseAssignments();\n  }\n\n  async getCourseAssignmentsByUser(userId: number): Promise<CourseAssignment[]> {\n    return this.memStorage.getCourseAssignmentsByUser(userId);\n  }\n\n  async createCourseAssignment(assignmentData: InsertCourseAssignment): Promise<CourseAssignment> {\n    return this.memStorage.createCourseAssignment(assignmentData);\n  }\n\n  async updateCourseAssignment(id: number, updates: Partial<CourseAssignment>): Promise<CourseAssignment | undefined> {\n    return this.memStorage.updateCourseAssignment(id, updates);\n  }\n\n  async deleteCourseAssignment(id: number): Promise<boolean> {\n    return this.memStorage.deleteCourseAssignment(id);\n  }\n\n  async getNotification(id: number): Promise<Notification | undefined> {\n    return this.memStorage.getNotification(id);\n  }\n\n  async getAllNotifications(): Promise<Notification[]> {\n    return this.memStorage.getAllNotifications();\n  }\n\n  async getNotificationsByUser(userId: number): Promise<Notification[]> {\n    return this.memStorage.getNotificationsByUser(userId);\n  }\n\n  async createNotification(notificationData: InsertNotification): Promise<Notification> {\n    return this.memStorage.createNotification(notificationData);\n  }\n\n  async updateNotification(id: number, updates: Partial<Notification>): Promise<Notification | undefined> {\n    return this.memStorage.updateNotification(id, updates);\n  }\n\n  async markNotificationAsRead(id: number): Promise<Notification | undefined> {\n    return this.memStorage.markNotificationAsRead(id);\n  }\n\n  async markAllNotificationsAsRead(userId: number): Promise<void> {\n    return this.memStorage.markAllNotificationsAsRead(userId);\n  }\n\n  async deleteNotification(id: number): Promise<boolean> {\n    return this.memStorage.deleteNotification(id);\n  }\n\n  async clearAllData(): Promise<boolean> {\n    return this.memStorage.clearAllData();\n  }\n\n  // FIXED: Use DATABASE storage for task generation instead of memory storage\n  async regenerateAllTaskInstances(): Promise<{ totalTasksCreated: number; recurringTasksProcessed: number }> {\n    // Get recurring tasks from DATABASE, not memory\n    const recurringTasks = await this.dbStorage.getAllRecurringTasks();\n    console.log(`üîÑ Found ${recurringTasks.length} recurring templates in DATABASE for task generation`);\n    \n    if (recurringTasks.length === 0) {\n      console.log('‚ö†Ô∏è No recurring tasks found in database - checking if migration needed');\n      // Check if MemStorage has templates that need to be migrated\n      const memTasks = await this.memStorage.getAllRecurringTasks();\n      if (memTasks.length > 0) {\n        console.log(`üîÑ Migrating ${memTasks.length} recurring tasks from memory to database`);\n        for (const memTask of memTasks) {\n          try {\n            await this.dbStorage.createRecurringTask({\n              title: memTask.title,\n              description: memTask.description,\n              type: memTask.type,\n              frequency: memTask.frequency,\n              daysOfWeek: memTask.daysOfWeek,\n              dayOfMonth: memTask.dayOfMonth,\n              isActive: memTask.isActive,\n              location: memTask.location,\n              assignTo: memTask.assignTo,\n              createdBy: memTask.createdBy,\n              automation: memTask.automation,\n              checklistTemplate: memTask.checklistTemplate\n            });\n          } catch (error) {\n            console.error(`Failed to migrate recurring task ${memTask.id}:`, error);\n          }\n        }\n        console.log('‚úÖ Migration complete - refetching from database');\n        const migratedTasks = await this.dbStorage.getAllRecurringTasks();\n        console.log(`üìä After migration: ${migratedTasks.length} tasks in database`);\n      }\n      return { totalTasksCreated: 0, recurringTasksProcessed: 0 };\n    }\n    \n    // SIMPLE FIX: Clear database tasks, copy templates to memory, then use memory regeneration\n    console.log('üóëÔ∏è Clearing existing pending task instances from database...');\n    await this.dbStorage.resetTasks();\n    \n    // Copy DATABASE templates to MemStorage for generation\n    console.log('üì• Copying database templates to memory for generation...');\n    this.memStorage.recurringTasks.clear();\n    let memIdCounter = 1;\n    \n    for (const dbTask of recurringTasks) {\n      this.memStorage.recurringTasks.set(memIdCounter, {\n        id: memIdCounter,\n        title: dbTask.title,\n        description: dbTask.description,\n        type: dbTask.type,\n        frequency: dbTask.frequency,\n        daysOfWeek: dbTask.daysOfWeek,\n        dayOfMonth: dbTask.dayOfMonth,\n        isActive: dbTask.isActive,\n        location: dbTask.location,\n        assignTo: dbTask.assignTo,\n        createdBy: dbTask.createdBy,\n        automation: dbTask.automation,\n        checklistTemplate: dbTask.checklistTemplate\n      });\n      memIdCounter++;\n    }\n    \n    console.log(`üìã Copied ${memIdCounter - 1} templates to memory storage`);\n    \n    // Now use MemStorage regeneration which will save tasks to database via storage singleton\n    return this.memStorage.regenerateAllTaskInstances();\n  }\n\n  async regenerateTaskInstances(recurringTaskId: number): Promise<boolean> {\n    // Get the recurring task from DATABASE\n    const recurringTask = await this.dbStorage.getRecurringTask(recurringTaskId);\n    if (!recurringTask) {\n      console.log(`‚ùå Recurring task ${recurringTaskId} not found in database`);\n      return false;\n    }\n    \n    // Use memory storage's generation logic  \n    const result = await this.memStorage.regenerateTaskInstances(recurringTaskId);\n    return typeof result === 'boolean' ? result : false;\n  }\n\n  // System status and locks - use DATABASE for multi-user coordination\n  async getSystemStatus(id: string): Promise<SystemStatus | undefined> {\n    return this.dbStorage.getSystemStatus(id);\n  }\n\n  async setSystemStatus(status: InsertSystemStatus): Promise<SystemStatus> {\n    return this.dbStorage.setSystemStatus(status);\n  }\n\n  async acquireLock(lockId: string, userId: number, lockType: string, expirationMinutes?: number): Promise<SystemLock | null> {\n    return this.dbStorage.acquireLock(lockId, userId, lockType, expirationMinutes);\n  }\n\n  async releaseLock(lockId: string): Promise<boolean> {\n    return this.dbStorage.releaseLock(lockId);\n  }\n\n  async checkLock(lockId: string): Promise<SystemLock | null> {\n    return this.dbStorage.checkLock(lockId);\n  }\n\n  // Task verification system - delegate to MemStorage for verification logic\n  async initializeAppVerification(userId: number = 1): Promise<void> {\n    console.log('üîÑ HybridStorage delegating task verification to MemStorage...');\n    return this.memStorage.initializeAppVerification(userId);\n  }\n\n  // Verification system - delegate to DatabaseStorage for full verification\n  async verifyTaskIntegrity(): Promise<{\n    missingTasksCreated: number;\n    duplicatesRemoved: number;\n    errors: string[];\n    verificationReport: string[];\n  }> {\n    return this.dbStorage.verifyTaskIntegrity();\n  }\n}\n\n// Export the appropriate storage implementation based on environment\nexport const storage = process.env.DATABASE_URL ? new DatabaseStorage() : new MemStorage();\n","path":null,"size_bytes":197066,"size_tokens":null},"client/src/components/auth/LogoutButton.tsx":{"content":"import React from 'react';\nimport { useMsal } from \"@azure/msal-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { User } from \"lucide-react\";\n\nexport const LogoutButton = () => {\n  const { instance } = useMsal();\n\n  const handleLogout = async () => {\n    try {\n      await instance.logoutPopup();\n    } catch (error) {\n      console.error('Logout failed:', error);\n    }\n  };\n\n  return (\n    <Button\n      variant=\"ghost\"\n      onClick={handleLogout}\n      className=\"w-full justify-start text-gray-300 hover:text-white hover:bg-[#2D8028]/50\"\n    >\n      <User className=\"h-4 w-4 mr-2\" />\n      Sign Out\n    </Button>\n  );\n};","path":null,"size_bytes":641,"size_tokens":null},"client/src/contexts/CurrentUserContext.tsx":{"content":"import React, { createContext, useContext, useState, useEffect } from 'react';\nimport { getStoredAuth } from '@/lib/auth';\n\ninterface CurrentUser {\n  id: number | null;\n  email: string;\n  fullName: string;\n  rolesAssigned: string[];\n}\n\ninterface CurrentUserContextType {\n  currentUser: CurrentUser | null;\n  loading: boolean;\n  refresh: () => Promise<void>;\n}\n\nconst CurrentUserContext = createContext<CurrentUserContextType | null>(null);\n\nexport const useCurrentUser = () => {\n  const context = useContext(CurrentUserContext);\n  if (!context) {\n    throw new Error('useCurrentUser must be used within CurrentUserProvider');\n  }\n  return context;\n};\n\nexport const CurrentUserProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {\n  const [currentUser, setCurrentUser] = useState<CurrentUser | null>(null);\n  const [loading, setLoading] = useState(true);\n  \n  useEffect(() => {\n    loadCurrentUser();\n  }, []);\n  \n  const loadCurrentUser = async () => {\n    try {\n      setLoading(true);\n      \n      // Get the logged-in user from the auth system\n      const auth = getStoredAuth();\n      console.log('=== AUTH DEBUG ===');\n      console.log('Full auth object:', auth);\n      console.log('Auth user:', auth?.user);\n      console.log('Auth user email:', auth?.user?.businessEmail || auth?.user?.username);\n      \n      const userEmail = auth?.user?.businessEmail || auth?.user?.username;\n      if (!userEmail) {\n        console.warn('No authenticated user found - using fallback for Robert');\n        // For development/testing, use Robert's account as fallback\n        const staffResponse = await fetch('/api/staff');\n        const staffData = await staffResponse.json();\n        const robertStaff = staffData.find((s: any) => s.email === 'robert@growspace.farm');\n        \n        if (robertStaff) {\n          setCurrentUser({\n            id: parseInt(robertStaff.id),\n            email: robertStaff.email,\n            fullName: robertStaff.fullName,\n            rolesAssigned: robertStaff.rolesAssigned || []\n          });\n          console.log('‚úÖ Using Robert as fallback user:', robertStaff.fullName);\n        }\n        return;\n      }\n      \n      // Now find this user in staff data\n      const staffResponse = await fetch('/api/staff');\n      if (!staffResponse.ok) {\n        throw new Error('Failed to fetch staff data');\n      }\n      \n      const staffData = await staffResponse.json();\n      \n      // Find staff member by email (case-insensitive)\n      const staffMember = staffData.find((s: any) => \n        (s.businessEmail || s.email)?.toLowerCase() === userEmail?.toLowerCase()\n      );\n      \n      if (staffMember) {\n        setCurrentUser({\n          id: parseInt(staffMember.id),\n          email: staffMember.businessEmail || staffMember.email || userEmail,\n          fullName: staffMember.fullName,\n          rolesAssigned: staffMember.rolesAssigned || []\n        });\n        \n        console.log('Current user loaded from staff:', {\n          id: staffMember.id,\n          email: staffMember.email,\n          fullName: staffMember.fullName,\n          rolesAssigned: staffMember.rolesAssigned\n        });\n      } else {\n        console.warn('Current user not found in staff data:', userEmail);\n        // Create a basic user object for testing\n        setCurrentUser({\n          id: null,\n          email: userEmail,\n          fullName: auth?.user?.name || userEmail,\n          rolesAssigned: []\n        });\n      }\n    } catch (error) {\n      console.error('Error loading current user:', error);\n      setCurrentUser(null);\n    } finally {\n      setLoading(false);\n    }\n  };\n  \n  return (\n    <CurrentUserContext.Provider value={{ currentUser, loading, refresh: loadCurrentUser }}>\n      {children}\n    </CurrentUserContext.Provider>\n  );\n};","path":null,"size_bytes":3784,"size_tokens":null},"client/src/components/SystemConfiguration.tsx":{"content":"import React, { useState } from 'react';\nimport { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';\nimport { Button } from '@/components/ui/button';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Badge } from '@/components/ui/badge';\nimport { Plus, Edit, Trash2, Settings } from 'lucide-react';\nimport { useToast } from '@/hooks/use-toast';\nimport { apiRequest } from '@/lib/queryClient';\nimport { GrowingSystem } from '@shared/schema';\nimport { SystemEditModal } from './SystemEditModal';\n\ninterface SystemConfigurationProps {\n  isCorporateManager: boolean;\n}\n\nconst SystemConfiguration: React.FC<SystemConfigurationProps> = ({ isCorporateManager }) => {\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n  const [editingSystem, setEditingSystem] = useState<GrowingSystem | null>(null);\n  const [showAddSystem, setShowAddSystem] = useState(false);\n\n  const { data: systems = [], isLoading } = useQuery<GrowingSystem[]>({\n    queryKey: ['/api/growing-systems'],\n    queryFn: async () => {\n      const response = await fetch('/api/growing-systems');\n      if (!response.ok) throw new Error('Failed to fetch growing systems');\n      return response.json();\n    },\n  });\n\n  const deleteSystemMutation = useMutation({\n    mutationFn: async (id: number) => {\n      return await apiRequest('DELETE', `/api/growing-systems/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/growing-systems'] });\n      toast({\n        title: 'System Deleted',\n        description: 'Growing system has been deleted successfully.',\n      });\n    },\n  });\n\n  const updateSystemMutation = useMutation({\n    mutationFn: async (systemData: any) => {\n      if (systemData.id) {\n        return await apiRequest('PATCH', `/api/growing-systems/${systemData.id}`, systemData);\n      } else {\n        return await apiRequest('POST', '/api/growing-systems', systemData);\n      }\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/growing-systems'] });\n      toast({\n        title: 'System Updated',\n        description: 'Growing system has been updated successfully.',\n      });\n    },\n  });\n\n  if (!isCorporateManager) {\n    return (\n      <div className=\"bg-gray-50 p-6 rounded-lg border border-gray-200\">\n        <div className=\"text-center\">\n          <Settings className=\"w-12 h-12 mx-auto text-gray-400 mb-3\" />\n          <h3 className=\"text-lg font-semibold text-gray-900 mb-2\">Access Restricted</h3>\n          <p className=\"text-gray-600\">\n            System configuration is only available to corporate managers.\n          </p>\n        </div>\n      </div>\n    );\n  }\n\n  const microgreensystems = systems.filter(s => s.type === 'microgreen');\n  const leafyGreenSystems = systems.filter(s => s.type === 'leafy-green');\n\n  const handleSystemSave = (systemData: any) => {\n    updateSystemMutation.mutate(systemData);\n    setEditingSystem(null);\n    setShowAddSystem(false);\n  };\n\n  const SystemList = ({ systems, category }: { systems: GrowingSystem[], category: string }) => (\n    <div className=\"space-y-3\">\n      {systems.map((system) => (\n        <Card key={system.id} className=\"relative\">\n          <CardHeader className=\"pb-3\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <CardTitle className=\"text-lg\">{system.name}</CardTitle>\n                <div className=\"flex items-center gap-2 mt-1\">\n                  <Badge variant=\"secondary\">{system.category}</Badge>\n                  <Badge variant=\"outline\">\n                    {system.currentOccupancy}/{system.capacity || '‚àû'} occupied\n                  </Badge>\n                </div>\n              </div>\n              <div className=\"flex items-center gap-2\">\n                <Button\n                  variant=\"outline\"\n                  size=\"sm\"\n                  onClick={() => setEditingSystem(system)}\n                >\n                  <Edit className=\"w-4 h-4 mr-1\" />\n                  Edit\n                </Button>\n                <Button\n                  variant=\"outline\"\n                  size=\"sm\"\n                  onClick={() => deleteSystemMutation.mutate(system.id)}\n                  className=\"text-red-600 hover:text-red-700\"\n                >\n                  <Trash2 className=\"w-4 h-4 mr-1\" />\n                  Delete\n                </Button>\n              </div>\n            </div>\n          </CardHeader>\n          \n          <CardContent className=\"pt-0\">\n            <div className=\"text-sm text-gray-600\">\n              {system.systemData && (\n                <div className=\"space-y-1\">\n                  {system.systemData.sections && (\n                    <p>Sections: {Object.keys(system.systemData.sections).length}</p>\n                  )}\n                  {system.systemData.units && (\n                    <p>Units: {system.systemData.units.length}</p>\n                  )}\n                  {system.systemData.channels && (\n                    <p>Channels: {system.systemData.channels.length}</p>\n                  )}\n                </div>\n              )}\n            </div>\n          </CardContent>\n        </Card>\n      ))}\n    </div>\n  );\n\n  if (isLoading) {\n    return <div className=\"p-6\">Loading system configuration...</div>;\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex justify-between items-center\">\n        <div>\n          <h3 className=\"text-xl font-semibold text-gray-900\">üè≠ Growing System Configuration</h3>\n          <p className=\"text-gray-600\">Configure and manage growing systems for automated task generation</p>\n        </div>\n        <Button \n          onClick={() => setShowAddSystem(true)}\n          className=\"bg-[#2D8028] hover:bg-[#203B17]\"\n        >\n          <Plus className=\"w-4 h-4 mr-2\" />\n          Add System\n        </Button>\n      </div>\n\n      <div className=\"grid gap-6 md:grid-cols-2\">\n        <div className=\"space-y-4\">\n          <h4 className=\"text-lg font-medium text-gray-900\">üå± Microgreen Systems</h4>\n          <SystemList systems={microgreensystems} category=\"microgreens\" />\n        </div>\n\n        <div className=\"space-y-4\">\n          <h4 className=\"text-lg font-medium text-gray-900\">ü•¨ Leafy Green Systems</h4>\n          <SystemList systems={leafyGreenSystems} category=\"leafyGreens\" />\n        </div>\n      </div>\n\n      {systems.length === 0 && (\n        <div className=\"text-center py-12\">\n          <Settings className=\"w-16 h-16 mx-auto text-gray-400 mb-4\" />\n          <h3 className=\"text-lg font-semibold text-gray-900 mb-2\">No Systems Configured</h3>\n          <p className=\"text-gray-600 mb-4\">\n            Configure your first growing system to enable automated task generation.\n          </p>\n          <Button \n            onClick={() => setShowAddSystem(true)}\n            className=\"bg-[#2D8028] hover:bg-[#203B17]\"\n          >\n            <Plus className=\"w-4 h-4 mr-2\" />\n            Add System\n          </Button>\n        </div>\n      )}\n\n      {/* Add/Edit Modal */}\n      {(showAddSystem || editingSystem) && (\n        <SystemEditModal\n          system={editingSystem}\n          onSave={handleSystemSave}\n          onClose={() => {\n            setEditingSystem(null);\n            setShowAddSystem(false);\n          }}\n        />\n      )}\n    </div>\n  );\n};\n\nexport default SystemConfiguration;","path":null,"size_bytes":7394,"size_tokens":null},"client/src/components/GenerationStatusBadge.tsx":{"content":"import { useQuery } from \"@tanstack/react-query\";\nimport { CheckCircle2, Clock, AlertCircle } from \"lucide-react\";\n\ninterface GenerationStatus {\n  lastGeneration: string | null;\n  generatedThrough: string | null;\n  health: 'GREEN' | 'YELLOW' | 'RED';\n  message: string;\n  totalFutureTasks: number;\n}\n\nexport function GenerationStatusBadge() {\n  const { data: status } = useQuery<GenerationStatus>({\n    queryKey: ['/api/admin/generation-status'],\n    refetchInterval: 30000,\n    staleTime: 20000,\n  });\n\n  if (!status) return null;\n\n  const statusConfig = {\n    GREEN: {\n      icon: CheckCircle2,\n      bgClass: 'bg-green-100 dark:bg-green-900/20',\n      textClass: 'text-green-700 dark:text-green-400',\n      iconClass: 'text-green-600 dark:text-green-500',\n    },\n    YELLOW: {\n      icon: Clock,\n      bgClass: 'bg-yellow-100 dark:bg-yellow-900/20',\n      textClass: 'text-yellow-700 dark:text-yellow-400',\n      iconClass: 'text-yellow-600 dark:text-yellow-500',\n    },\n    RED: {\n      icon: AlertCircle,\n      bgClass: 'bg-red-100 dark:bg-red-900/20',\n      textClass: 'text-red-700 dark:text-red-400',\n      iconClass: 'text-red-600 dark:text-red-500',\n    },\n  };\n\n  const config = statusConfig[status.health];\n  const Icon = config.icon;\n\n  return (\n    <div \n      className={`inline-flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-medium ${config.bgClass} ${config.textClass}`}\n      title={`Last generation: ${status.lastGeneration || 'Never'}\\nGenerated through: ${status.generatedThrough || 'N/A'}\\n${status.totalFutureTasks} future tasks`}\n      data-testid=\"generation-status-badge\"\n    >\n      <Icon className={`h-3.5 w-3.5 ${config.iconClass}`} />\n      <span>Auto-Gen: {status.health}</span>\n    </div>\n  );\n}\n","path":null,"size_bytes":1743,"size_tokens":null},"date_system_analysis.md":{"content":"# CURRENT DATE SYSTEM ANALYSIS\n\n## Summary: Date System Analysis Complete\n\nBased on the comprehensive debug logging I added to the system, here are my findings:\n\n## 1. STORAGE FORMAT:\n- **Tasks store dates as**: ISO 8601 strings with UTC timezone\n- **Example dueDate**: \"2025-08-07T00:00:00.000Z\" (string)\n- **Example completedAt**: \"2025-08-07T20:40:08.075Z\" (string)\n- **Timezone**: All dates stored in UTC (Z suffix indicates UTC)\n\n## 2. INPUT HANDLING:\n- **Date picker provides**: \"YYYY-MM-DD\" format strings (e.g., \"2025-08-16\")\n- **Example input**: \"2025-08-16\" (string, no timezone info)\n- **User selection**: Plain date string in YYYY-MM-DD format\n\n## 3. FILTER COMPARISON:\n- **Filter uses**: String comparison after formatting both sides\n- **Conversion process**:\n  - Task date: \"2025-08-07T00:00:00.000Z\" ‚Üí \"2025-08-07\"\n  - Filter date: \"2025-08-16\" ‚Üí \"2025-08-16\"\n  - **Comparison**: \"2025-08-07\" === \"2025-08-16\" = false\n\n## 4. CURRENT BEHAVIOR:\n‚úÖ **System is working correctly!** \n- Tasks with dueDate \"2025-08-16T00:00:00.000Z\" show when filter is \"2025-08-16\"\n- Filter correctly extracts date portion from UTC timestamps\n- No timezone conversion issues found\n\n## 5. WHY SYSTEM APPEARS BROKEN:\nThe issue is NOT with date filtering logic, but with **USER EXPECTATIONS**:\n\n### Expected vs Actual Task Distribution:\n- **Today (2025-08-16)**: 14 tasks found and displayed correctly\n- **Past dates**: Tasks from August 7, 13, 20, 27 etc. don't appear when filtering for today\n- **This is CORRECT behavior** - tasks should only appear on their due dates\n\n## 6. COMPLETE DATE FLOW DIAGRAM:\n```\nUser selects \"2025-08-16\" in date picker\n  ‚Üì\nStored as: \"2025-08-16\" (string)\n  ‚Üì\nTask has dueDate: \"2025-08-16T00:00:00.000Z\" (UTC string)\n  ‚Üì\nFilter converts: \"2025-08-16T00:00:00.000Z\" ‚Üí \"2025-08-16\"\n  ‚Üì\nComparison: \"2025-08-16\" === \"2025-08-16\" = ‚úÖ MATCH\n```\n\n## 7. SPECIFIC EXAMPLE TRACED:\n**Task**: \"Opening\" \n- **Stored dueDate**: \"2025-08-13T12:00:00.000Z\"\n- **When filtered for \"2025-08-16\"**:\n  - Formatted task date: \"2025-08-13\"\n  - Formatted filter date: \"2025-08-16\"\n  - Match: false ‚ùå (CORRECT - task is not due today)\n\n## 8. ISSUES FOUND:\n**NO ISSUES WITH DATE SYSTEM** - The system is working exactly as designed:\n\n‚úÖ Correct UTC storage prevents timezone bugs\n‚úÖ Correct string comparison after normalization\n‚úÖ Correct filtering logic - tasks appear only on their due dates\n‚úÖ Correct date formatting and extraction from ISO strings\n\n## 9. WHY DATES MIGHT SEEM \"OFF BY ONE\":\n**This is likely a misconception**. The debug logs show:\n- User selects August 16, 2025\n- System shows 14 tasks due on August 16, 2025\n- System correctly excludes tasks due on other dates\n\nIf dates appear \"off by one\", it's likely because:\n1. **User expects different behavior** (e.g., wants to see overdue tasks)\n2. **Tasks are actually due on different dates** than user expects\n3. **User timezone confusion** (but system handles this correctly with UTC)\n\n## 10. RECOMMENDATION:\n**The date filtering system is working correctly and should NOT be changed.**\n\nIf the user believes dates are wrong, the issue is likely:\n1. Task creation with incorrect due dates\n2. User misunderstanding of which dates tasks are due\n3. Need for additional filter options (e.g., \"show overdue tasks\")\n\n**The core date comparison and filtering logic is robust and correct.**","path":null,"size_bytes":3373,"size_tokens":null},"postcss.config.js":{"content":"export default {\n  plugins: {\n    tailwindcss: {},\n    autoprefixer: {},\n  },\n}\n","path":null,"size_bytes":80,"size_tokens":null},"shared/schema.ts":{"content":"import { pgTable, text, serial, integer, boolean, timestamp, real, json } from \"drizzle-orm/pg-core\";\nimport { createInsertSchema } from \"drizzle-zod\";\nimport { z } from \"zod\";\n\nexport const users = pgTable(\"users\", {\n  id: serial(\"id\").primaryKey(),\n  username: text(\"username\").notNull().unique(),\n  password: text(\"password\").notNull(),\n  name: text(\"name\").notNull(),\n  role: text(\"role\").notNull(), // 'technician', 'manager', 'corporate'\n  approved: boolean(\"approved\").default(false),\n  location: text(\"location\").default('Kenosha'), // User's assigned location\n  payType: text(\"pay_type\").default('hourly'), // 'hourly', 'salary', 'unpaid'\n  payRate: real(\"pay_rate\").default(16.00), // Pay rate: hourly rate, annual salary, or 0 for unpaid\n  \n  // Contact Information\n  businessEmail: text(\"business_email\"), // Login email (Teams/Work account)\n  personalEmail: text(\"personal_email\"), // Personal email address\n  homePhone: text(\"home_phone\"), // Home phone number\n  businessPhone: text(\"business_phone\"), // Business phone number  \n  mobilePhone: text(\"mobile_phone\"), // Mobile phone (required for emergencies)\n  \n  // Emergency Contact\n  emergencyContactName: text(\"emergency_contact_name\"), // Emergency contact name\n  emergencyRelationship: text(\"emergency_relationship\"), // Relationship to emergency contact\n  emergencyPhone: text(\"emergency_phone\"), // Emergency contact phone\n  \n  lastActive: timestamp(\"last_active\"), // Track when user was last active\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const tasks = pgTable(\"tasks\", {\n  id: serial(\"id\").primaryKey(),\n  title: text(\"title\").notNull(),\n  description: text(\"description\"),\n  type: text(\"type\").notNull(), // 'seeding-microgreens', 'seeding-leafy-greens', 'harvest-microgreens', 'harvest-leafy-greens', 'blackout-tasks', 'moving', 'packing', 'cleaning', 'inventory', 'equipment-maintenance', 'other'\n  status: text(\"status\").notNull().default('pending'), // 'pending', 'in_progress', 'completed', 'approved', 'paused', 'skipped'\n  priority: text(\"priority\").default('medium'), // 'low', 'medium', 'high'\n  assignedTo: integer(\"assigned_to\").references(() => users.id), // Legacy single user assignment\n  assignTo: text(\"assign_to\"), // New dynamic assignment: 'user_123', 'role_Manager', 'all_staff'\n  createdBy: integer(\"created_by\").references(() => users.id),\n  location: text(\"location\"), // e.g., \"Section A - Towers 1-5\"\n  estimatedTime: integer(\"estimated_time\"), // in minutes\n  actualTime: integer(\"actual_time\"), // in minutes\n  progress: integer(\"progress\").default(0), // 0-100\n  checklist: json(\"checklist\").$type<ChecklistItem[]>(),\n  data: json(\"data\").$type<Record<string, any>>(), // for collected data\n  taskDate: timestamp(\"task_date\"), // Primary date for task filtering (usually same as visibleFromDate)\n  dueDate: timestamp(\"due_date\"),\n  visibleFromDate: timestamp(\"visible_from_date\"), // When task becomes visible\n  startedAt: timestamp(\"started_at\"),\n  completedAt: timestamp(\"completed_at\"),\n  pausedAt: timestamp(\"paused_at\"),\n  resumedAt: timestamp(\"resumed_at\"),\n  skippedAt: timestamp(\"skipped_at\"),\n  skipReason: text(\"skip_reason\"),\n  isRecurring: boolean(\"is_recurring\").default(false),\n  recurringTaskId: integer(\"recurring_task_id\").references(() => recurringTasks.id),\n  frequency: text(\"frequency\"), // Copied from parent recurring task: 'daily', 'weekly', 'biweekly', 'monthly', 'quarterly'\n  \n  // Fields for orphaned tasks from deleted recurring tasks\n  isFromDeletedRecurring: boolean(\"is_from_deleted_recurring\").default(false),\n  deletedRecurringTaskTitle: text(\"deleted_recurring_task_title\"),\n  \n  // Update propagation tracking\n  templateVersion: integer(\"template_version\").default(1), // Which template version was this created from\n  isModifiedAfterCreation: boolean(\"is_modified_after_creation\").default(false), // Flag if task was modified after creation\n  modifiedFromTemplateAt: timestamp(\"modified_from_template_at\"), // When template update was applied\n  \n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const recurringTasks = pgTable(\"recurring_tasks\", {\n  id: serial(\"id\").primaryKey(),\n  title: text(\"title\").notNull(),\n  description: text(\"description\"),\n  type: text(\"type\").notNull(),\n  frequency: text(\"frequency\").notNull(), // 'weekly', 'bi-weekly', 'biweekly', 'monthly', 'quarterly' - NO DAILY!\n  daysOfWeek: json(\"days_of_week\").$type<string[]>(), // ['monday', 'tuesday', etc.]\n  dayOfMonth: integer(\"day_of_month\"), // For monthly tasks\n  isActive: boolean(\"is_active\").default(true),\n  location: text(\"location\").notNull(), // Location code (K, R, MKE)\n  assignTo: text(\"assign_to\"), // Default assignment: 'user_123', 'role_Manager', 'all_staff'\n  createdBy: integer(\"created_by\").references(() => users.id),\n  \n  // Automation settings\n  automation: json(\"automation\").$type<{\n    enabled: boolean;\n    generateTrays: boolean;\n    trayCount: number;\n    cropType: string;\n    seedInventoryId?: number;\n    flow: {\n      type: 'microgreen' | 'leafy-green';\n      stages: {\n        name: string;\n        system: string;\n        duration: number;\n        autoMove: boolean;\n        splitRatio?: Record<string, number>;\n      }[];\n    };\n  }>(),\n  \n  // Dynamic checklist template\n  checklistTemplate: json(\"checklist_template\").$type<{\n    steps: {\n      type: 'instruction' | 'inventory-select' | 'number-input' | 'system-assignment' | 'data-capture' | 'photo';\n      text?: string;\n      label?: string;\n      inventoryCategory?: string;\n      min?: number;\n      max?: number;\n      default?: number;\n      systemType?: string;\n      autoSuggest?: boolean;\n      dataType?: string;\n      calculation?: string;\n      required?: boolean;\n    }[];\n  }>(),\n  \n  // Update propagation system fields\n  versionNumber: integer(\"version_number\").default(1), // Increment on template changes\n  lastModifiedDate: timestamp(\"last_modified_date\").defaultNow(),\n  lastModifiedBy: integer(\"last_modified_by\").references(() => users.id),\n  \n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\n// Change audit log for recurring task template updates\nexport const recurringTaskChanges = pgTable(\"recurring_task_changes\", {\n  id: serial(\"id\").primaryKey(),\n  recurringTaskId: integer(\"recurring_task_id\").notNull().references(() => recurringTasks.id),\n  changedFields: json(\"changed_fields\").$type<{\n    field: string;\n    oldValue: any;\n    newValue: any;\n  }[]>(), // Track which fields changed and their values\n  changeTimestamp: timestamp(\"change_timestamp\").defaultNow(),\n  changedByUser: integer(\"changed_by_user\").notNull().references(() => users.id),\n  affectedInstanceCount: integer(\"affected_instance_count\").default(0), // How many task instances were updated\n  updateStatus: text(\"update_status\").default('pending'), // 'pending', 'completed', 'failed', 'partial'\n  errorMessage: text(\"error_message\"), // If update failed, store error details\n  userConfirmed: boolean(\"user_confirmed\").default(false), // Did user confirm the changes\n  rollbackData: json(\"rollback_data\").$type<Record<string, any>>(), // Data needed for rollback\n});\n\nexport const growingSystems = pgTable(\"growing_systems\", {\n  id: serial(\"id\").primaryKey(),\n  name: text(\"name\").notNull(),\n  type: text(\"type\").notNull(), // 'microgreen', 'leafy-green'\n  category: text(\"category\").notNull(), // 'nursery', 'staging', 'final'\n  capacity: integer(\"capacity\"), // null for unlimited\n  currentOccupancy: integer(\"current_occupancy\").default(0),\n  systemData: json(\"system_data\").$type<{\n    sections?: Record<string, { capacity: number; occupied: string[] }>;\n    units?: {\n      id: string;\n      type: string;\n      totalPorts: number;\n      occupiedPorts: string[];\n    }[];\n    channels?: {\n      id: number;\n      capacity: number;\n      crop: string | null;\n      occupied: string[];\n    }[];\n  }>(),\n  isActive: boolean(\"is_active\").default(true),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const trays = pgTable(\"trays\", {\n  id: text(\"id\").primaryKey(), // e.g., \"K071725-MG-BROC-1A\"\n  barcode: text(\"barcode\"),\n  cropType: text(\"crop_type\").notNull(),\n  cropCategory: text(\"crop_category\").notNull(), // 'microgreens' | 'leafyGreens'\n  datePlanted: timestamp(\"date_planted\").notNull(),\n  expectedHarvest: timestamp(\"expected_harvest\").notNull(),\n  status: text(\"status\").notNull().default('seeded'), // 'seeded' | 'germinating' | 'growing' | 'ready' | 'harvested' | 'split' | 'discarded'\n  currentLocation: json(\"current_location\").$type<{\n    systemId: string;\n    systemType: string;\n    spotIds: string[];\n    movedDate: string;\n  }>().notNull(),\n  locationHistory: json(\"location_history\").$type<Array<{\n    systemId: string;\n    systemType: string;\n    spotIds: string[];\n    movedDate: string;\n    movedBy: string;\n    reason?: string;\n  }>>().notNull(),\n  parentTrayId: text(\"parent_tray_id\"), // For split trays\n  childTrayIds: json(\"child_tray_ids\").$type<string[]>(), // For parent trays that were split\n  plantCount: integer(\"plant_count\").notNull(),\n  varieties: json(\"varieties\").$type<Array<{\n    seedId: string;\n    seedName: string;\n    sku: string;\n    quantity: number;\n    seedsOz: number;\n  }>>(), // Multiple crop varieties in one tray\n  notes: text(\"notes\").default(''),\n  createdBy: text(\"created_by\").notNull(),\n  createdDate: timestamp(\"created_date\").defaultNow(),\n});\n\nexport const trayMovements = pgTable(\"tray_movements\", {\n  id: serial(\"id\").primaryKey(),\n  trayId: text(\"tray_id\").notNull().references(() => trays.id),\n  fromSystem: text(\"from_system\"),\n  toSystem: text(\"to_system\").notNull(),\n  fromLocation: text(\"from_location\"),\n  toLocation: text(\"to_location\").notNull(),\n  taskId: integer(\"task_id\").references(() => tasks.id),\n  movedBy: integer(\"moved_by\").references(() => users.id),\n  movedAt: timestamp(\"moved_at\").defaultNow(),\n  notes: text(\"notes\"),\n});\n\nexport const inventoryItems = pgTable(\"inventory_items\", {\n  id: serial(\"id\").primaryKey(),\n  name: text(\"name\").notNull(),\n  category: text(\"category\").notNull(), // 'seeds', 'nutrients', 'supplies', 'equipment'\n  sku: text(\"sku\").notNull().default('TEMP'), // 4-character SKU for tray ID generation (was productCode)\n  currentStock: integer(\"current_stock\").default(0),\n  minimumStock: integer(\"minimum_stock\").default(0),\n  unit: text(\"unit\").notNull(), // 'kg', 'lbs', 'pieces', 'liters', 'grams'\n  supplier: text(\"supplier\"),\n  ozPerTray: real(\"oz_per_tray\"), // Amount needed per tray for seeds\n  cropId: integer(\"crop_id\"), // Links to crop configuration\n  location: text(\"location\").notNull().default('K'), // Location code (K, R, MKE, etc.)\n  \n  // Cost tracking fields\n  totalValue: real(\"total_value\").default(0), // Total value of current stock\n  avgCostPerUnit: real(\"avg_cost_per_unit\").default(0), // Weighted average cost per unit\n  \n  lastRestocked: timestamp(\"last_restocked\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const inventoryTransactions = pgTable(\"inventory_transactions\", {\n  id: serial(\"id\").primaryKey(),\n  itemId: integer(\"item_id\").references(() => inventoryItems.id),\n  type: text(\"type\").notNull(), // 'purchase', 'usage', 'adjustment'\n  quantity: real(\"quantity\").notNull(),\n  totalCost: real(\"total_cost\"), // Cost for this transaction\n  costPerUnit: real(\"cost_per_unit\"), // Cost per unit for this transaction\n  runningStock: real(\"running_stock\").notNull(), // Stock level after this transaction\n  addedBy: integer(\"added_by\").references(() => users.id),\n  notes: text(\"notes\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const trainingModules = pgTable(\"training_modules\", {\n  id: serial(\"id\").primaryKey(),\n  title: text(\"title\").notNull(),\n  description: text(\"description\"),\n  category: text(\"category\").notNull(),\n  content: text(\"content\").notNull(),\n  duration: integer(\"duration\"), // in minutes\n  requiredForRole: text(\"required_for_role\"), // role this unlocks\n  createdBy: integer(\"created_by\").references(() => users.id),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const userProgress = pgTable(\"user_progress\", {\n  id: serial(\"id\").primaryKey(),\n  userId: integer(\"user_id\").references(() => users.id),\n  moduleId: integer(\"module_id\").references(() => trainingModules.id),\n  completed: boolean(\"completed\").default(false),\n  completedAt: timestamp(\"completed_at\"),\n  score: integer(\"score\"), // 0-100\n});\n\n// System status tracking for task generation\nexport const systemStatus = pgTable(\"system_status\", {\n  id: text(\"id\").primaryKey(), // 'task-generation-status'\n  lastGenerationDate: text(\"last_generation_date\"), // YYYY-MM-DD\n  generatedThrough: text(\"generated_through\"), // YYYY-MM-DD (31 days ahead)\n  lastUpdateBy: integer(\"last_update_by\"),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\n// System locks for multi-user safety\nexport const systemLocks = pgTable(\"system_locks\", {\n  id: text(\"id\").primaryKey(), // 'task-generation-lock'\n  lockedBy: integer(\"locked_by\").notNull().references(() => users.id),\n  lockType: text(\"lock_type\").notNull(), // 'task_generation', 'template_update'\n  acquiredAt: timestamp(\"acquired_at\").defaultNow(),\n  expiresAt: timestamp(\"expires_at\"), // Automatic lock expiration\n});\n\nexport const courseAssignments = pgTable(\"course_assignments\", {\n  id: serial(\"id\").primaryKey(),\n  courseId: integer(\"course_id\").notNull(), // Reference to course (stored in frontend)\n  assignedToUserId: integer(\"assigned_to_user_id\").references(() => users.id),\n  assignedByUserId: integer(\"assigned_by_user_id\").references(() => users.id),\n  assignedDate: timestamp(\"assigned_date\").defaultNow(),\n  dueDate: timestamp(\"due_date\"),\n  priority: text(\"priority\").default('normal'), // 'low', 'normal', 'high'\n  notes: text(\"notes\"),\n  completed: boolean(\"completed\").default(false),\n  completedAt: timestamp(\"completed_at\"),\n});\n\nexport const notifications = pgTable(\"notifications\", {\n  id: serial(\"id\").primaryKey(),\n  userId: integer(\"user_id\").references(() => users.id).notNull(),\n  type: text(\"type\").notNull(), // 'task_overdue', 'task_assigned', 'course_assigned', etc.\n  title: text(\"title\").notNull(),\n  message: text(\"message\").notNull(),\n  relatedId: integer(\"related_id\"), // Can reference task_id, course_id, etc.\n  relatedType: text(\"related_type\"), // 'task', 'course', 'harvest', etc.\n  isRead: boolean(\"is_read\").default(false),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  readAt: timestamp(\"read_at\"),\n});\n\n// Type exports\nexport type Task = typeof tasks.$inferSelect;\nexport type RecurringTask = typeof recurringTasks.$inferSelect;\nexport type GrowingSystem = typeof growingSystems.$inferSelect;\nexport type Tray = typeof trays.$inferSelect;\nexport type TrayMovement = typeof trayMovements.$inferSelect;\nexport type InventoryTransaction = typeof inventoryTransactions.$inferSelect;\n\nexport const insertRecurringTaskSchema = createInsertSchema(recurringTasks).omit({ \n  id: true, \n  createdAt: true, \n  versionNumber: true, \n  lastModifiedDate: true \n});\nexport const insertGrowingSystemSchema = createInsertSchema(growingSystems);\nexport const insertTraySchema = createInsertSchema(trays);\nexport const insertTrayMovementSchema = createInsertSchema(trayMovements);\nexport const insertInventoryTransactionSchema = createInsertSchema(inventoryTransactions);\n\nexport type InsertRecurringTask = z.infer<typeof insertRecurringTaskSchema>;\nexport type InsertGrowingSystem = z.infer<typeof insertGrowingSystemSchema>;\nexport type InsertTray = z.infer<typeof insertTraySchema>;\nexport type InsertTrayMovement = z.infer<typeof insertTrayMovementSchema>;\nexport type InsertInventoryTransaction = z.infer<typeof insertInventoryTransactionSchema>;\n\n// Recurring task changes schemas\nexport const insertRecurringTaskChangeSchema = createInsertSchema(recurringTaskChanges).omit({ \n  id: true, \n  changeTimestamp: true,\n  updateStatus: true,\n  userConfirmed: true\n});\nexport type InsertRecurringTaskChange = z.infer<typeof insertRecurringTaskChangeSchema>;\nexport type RecurringTaskChange = typeof recurringTaskChanges.$inferSelect;\n\nexport const taskLogs = pgTable(\"task_logs\", {\n  id: serial(\"id\").primaryKey(),\n  taskId: integer(\"task_id\").references(() => tasks.id),\n  userId: integer(\"user_id\").references(() => users.id),\n  action: text(\"action\").notNull(), // 'started', 'paused', 'resumed', 'completed', 'data_collected'\n  timestamp: timestamp(\"timestamp\").defaultNow(),\n  data: json(\"data\").$type<Record<string, any>>(),\n});\n\n// ChecklistItem type for task checklists\nexport interface ChecklistItem {\n  id: string;\n  text: string;\n  completed: boolean;\n  required?: boolean;\n  type?: string;\n  config?: Record<string, any>;\n  data?: Record<string, any>;\n  dataCollection?: {\n    type: 'number' | 'text' | 'select';\n    label: string;\n    options?: string[];\n    value?: any;\n  };\n}\n\n// Task status type\nexport type TaskStatus = 'pending' | 'in_progress' | 'completed' | 'approved' | 'paused' | 'skipped';\n\n// Task type\nexport type TaskType = 'seeding-microgreens' | 'seeding-leafy-greens' | 'harvest-microgreens' | 'harvest-leafy-greens' | 'blackout-tasks' | 'moving' | 'packing' | 'cleaning' | 'inventory' | 'equipment-maintenance' | 'other';\n\n// Insert schemas\nexport const insertUserSchema = createInsertSchema(users).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertTaskSchema = createInsertSchema(tasks).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertInventoryItemSchema = createInsertSchema(inventoryItems).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertTrainingModuleSchema = createInsertSchema(trainingModules).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertUserProgressSchema = createInsertSchema(userProgress).omit({\n  id: true,\n});\n\nexport const insertTaskLogSchema = createInsertSchema(taskLogs).omit({\n  id: true,\n  timestamp: true,\n});\n\n// Types\nexport type User = typeof users.$inferSelect;\nexport type InsertUser = z.infer<typeof insertUserSchema>;\nexport type InsertTask = z.infer<typeof insertTaskSchema>;\nexport type InventoryItem = typeof inventoryItems.$inferSelect;\nexport type InsertInventoryItem = z.infer<typeof insertInventoryItemSchema>;\nexport type TrainingModule = typeof trainingModules.$inferSelect;\nexport type InsertTrainingModule = z.infer<typeof insertTrainingModuleSchema>;\nexport type UserProgress = typeof userProgress.$inferSelect;\nexport type InsertUserProgress = z.infer<typeof insertUserProgressSchema>;\nexport type TaskLog = typeof taskLogs.$inferSelect;\nexport type InsertTaskLog = z.infer<typeof insertTaskLogSchema>;\nexport type CourseAssignment = typeof courseAssignments.$inferSelect;\nexport type Notification = typeof notifications.$inferSelect;\n\nexport const insertCourseAssignmentSchema = createInsertSchema(courseAssignments).omit({\n  id: true,\n  assignedDate: true,\n});\nexport type InsertCourseAssignment = z.infer<typeof insertCourseAssignmentSchema>;\n\nexport const insertNotificationSchema = createInsertSchema(notifications).omit({\n  id: true,\n  createdAt: true,\n});\nexport type InsertNotification = z.infer<typeof insertNotificationSchema>;\n\n// System status and locks types\nexport const insertSystemStatusSchema = createInsertSchema(systemStatus);\nexport type SystemStatus = typeof systemStatus.$inferSelect;\nexport type InsertSystemStatus = z.infer<typeof insertSystemStatusSchema>;\n\nexport const insertSystemLockSchema = createInsertSchema(systemLocks);\nexport type SystemLock = typeof systemLocks.$inferSelect;\nexport type InsertSystemLock = z.infer<typeof insertSystemLockSchema>;\n","path":null,"size_bytes":19554,"size_tokens":null},"client/src/components/SystemConfigurationModal.tsx":{"content":"import React, { useState } from 'react';\nimport { Dialog, DialogContent, DialogHeader, DialogTitle } from '@/components/ui/dialog';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { Label } from '@/components/ui/label';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { Textarea } from '@/components/ui/textarea';\nimport { GrowingSystem } from '@shared/schema';\n\ninterface SystemConfigurationModalProps {\n  system: GrowingSystem | null;\n  onSave: (system: GrowingSystem) => void;\n  onClose: () => void;\n}\n\nexport const SystemConfigurationModal: React.FC<SystemConfigurationModalProps> = ({\n  system,\n  onSave,\n  onClose\n}) => {\n  const [formData, setFormData] = useState({\n    name: system?.name || '',\n    type: system?.type || 'nursery',\n    category: system?.category || 'microgreens',\n    capacity: system?.capacity || 50,\n    currentOccupancy: system?.currentOccupancy || 0,\n    location: system?.location || '',\n    status: system?.status || 'active',\n    notes: system?.notes || ''\n  });\n\n  const handleSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    onSave({\n      id: system?.id || Date.now(),\n      ...formData\n    } as GrowingSystem);\n  };\n\n  return (\n    <Dialog open={true} onOpenChange={onClose}>\n      <DialogContent className=\"max-w-2xl\">\n        <DialogHeader>\n          <DialogTitle>\n            {system ? 'Edit System Configuration' : 'Add New Growing System'}\n          </DialogTitle>\n        </DialogHeader>\n        \n        <form onSubmit={handleSubmit} className=\"space-y-4\">\n          <div className=\"grid grid-cols-2 gap-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"name\">System Name</Label>\n              <Input\n                id=\"name\"\n                value={formData.name}\n                onChange={(e) => setFormData({ ...formData, name: e.target.value })}\n                placeholder=\"e.g., Microgreen Nursery A\"\n                required\n              />\n            </div>\n            \n            <div className=\"space-y-2\">\n              <Label htmlFor=\"type\">System Type</Label>\n              <Select value={formData.type} onValueChange={(value) => setFormData({ ...formData, type: value })}>\n                <SelectTrigger>\n                  <SelectValue placeholder=\"Select system type\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"nursery\">Nursery</SelectItem>\n                  <SelectItem value=\"blackout\">Blackout</SelectItem>\n                  <SelectItem value=\"ebbFlow\">Ebb & Flow</SelectItem>\n                  <SelectItem value=\"towers\">Towers</SelectItem>\n                  <SelectItem value=\"nft\">NFT</SelectItem>\n                  <SelectItem value=\"microgreens\">Microgreen Racks</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n          </div>\n\n          <div className=\"grid grid-cols-2 gap-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"category\">Category</Label>\n              <Select value={formData.category} onValueChange={(value) => setFormData({ ...formData, category: value })}>\n                <SelectTrigger>\n                  <SelectValue placeholder=\"Select category\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"microgreens\">Microgreens</SelectItem>\n                  <SelectItem value=\"leafyGreens\">Leafy Greens</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n            \n            <div className=\"space-y-2\">\n              <Label htmlFor=\"capacity\">Total Capacity</Label>\n              <Input\n                id=\"capacity\"\n                type=\"number\"\n                value={formData.capacity}\n                onChange={(e) => setFormData({ ...formData, capacity: parseInt(e.target.value) })}\n                min=\"1\"\n                required\n              />\n            </div>\n          </div>\n\n          <div className=\"grid grid-cols-2 gap-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"currentOccupancy\">Current Occupancy</Label>\n              <Input\n                id=\"currentOccupancy\"\n                type=\"number\"\n                value={formData.currentOccupancy}\n                onChange={(e) => setFormData({ ...formData, currentOccupancy: parseInt(e.target.value) })}\n                min=\"0\"\n                max={formData.capacity}\n              />\n            </div>\n            \n            <div className=\"space-y-2\">\n              <Label htmlFor=\"location\">Location</Label>\n              <Input\n                id=\"location\"\n                value={formData.location}\n                onChange={(e) => setFormData({ ...formData, location: e.target.value })}\n                placeholder=\"e.g., Room A, Bay 1\"\n              />\n            </div>\n          </div>\n\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"status\">Status</Label>\n            <Select value={formData.status} onValueChange={(value) => setFormData({ ...formData, status: value })}>\n              <SelectTrigger>\n                <SelectValue placeholder=\"Select status\" />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"active\">Active</SelectItem>\n                <SelectItem value=\"maintenance\">Maintenance</SelectItem>\n                <SelectItem value=\"inactive\">Inactive</SelectItem>\n              </SelectContent>\n            </Select>\n          </div>\n\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"notes\">Notes</Label>\n            <Textarea\n              id=\"notes\"\n              value={formData.notes}\n              onChange={(e) => setFormData({ ...formData, notes: e.target.value })}\n              placeholder=\"Additional notes about this system...\"\n              rows={3}\n            />\n          </div>\n\n          <div className=\"flex justify-end space-x-2 pt-4\">\n            <Button type=\"button\" variant=\"outline\" onClick={onClose}>\n              Cancel\n            </Button>\n            <Button type=\"submit\" className=\"bg-[#2D8028] hover:bg-[#203B17]\">\n              {system ? 'Update' : 'Create'} System\n            </Button>\n          </div>\n        </form>\n      </DialogContent>\n    </Dialog>\n  );\n};","path":null,"size_bytes":6375,"size_tokens":null},"client/src/data/initialData.ts":{"content":"// Initial production data for the farm management system\nimport { ProductionTray } from '../services/trayService';\n\nexport const initializeProductionData = (): void => {\n  const existingTrays = localStorage.getItem('productionTrays');\n  \n  // Check if we have fake test data and replace it with authentic data\n  let shouldInitialize = false;\n  \n  if (!existingTrays) {\n    shouldInitialize = true;\n    console.log('No production data found, initializing clean state for production');\n  } else {\n    try {\n      const trays = JSON.parse(existingTrays);\n      // Check for fake test data (IDs like TRAY-001, TRAY-002)\n      const hasFakeData = trays.some((tray: any) => tray.id && tray.id.startsWith('TRAY-'));\n      if (hasFakeData) {\n        shouldInitialize = true;\n        console.log('Found test data, clearing for clean production start');\n      }\n    } catch (error) {\n      shouldInitialize = true;\n      console.warn('Error parsing existing tray data, initializing clean production state');\n    }\n  }\n  \n  if (shouldInitialize) {\n    // Production launch - clean start with no initial tray data\n    const initialTrays: ProductionTray[] = [];\n    \n    localStorage.setItem('productionTrays', JSON.stringify(initialTrays));\n    console.log('Initialized production data with realistic starting trays:', initialTrays.length);\n  }\n};\n\n// Calculate expected harvest date based on crop type\nexport const calculateHarvestDate = (cropType: string, plantedDate: string = new Date().toISOString()): string => {\n  const planted = new Date(plantedDate);\n  let daysToHarvest = 35; // Default\n  \n  switch (cropType.toLowerCase()) {\n    case 'microgreen':\n      daysToHarvest = 7;\n      break;\n    case 'leafy-green':\n      daysToHarvest = 28;\n      break;\n    case 'herbs':\n      daysToHarvest = 42;\n      break;\n    default:\n      daysToHarvest = 35;\n  }\n  \n  const harvestDate = new Date(planted.getTime() + (daysToHarvest * 24 * 60 * 60 * 1000));\n  return harvestDate.toISOString().split('T')[0];\n};","path":null,"size_bytes":1995,"size_tokens":null},"client/src/components/ui/avatar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as AvatarPrimitive from \"@radix-ui/react-avatar\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Avatar = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full\",\n      className\n    )}\n    {...props}\n  />\n))\nAvatar.displayName = AvatarPrimitive.Root.displayName\n\nconst AvatarImage = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Image>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Image>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Image\n    ref={ref}\n    className={cn(\"aspect-square h-full w-full\", className)}\n    {...props}\n  />\n))\nAvatarImage.displayName = AvatarPrimitive.Image.displayName\n\nconst AvatarFallback = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Fallback>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Fallback>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Fallback\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full items-center justify-center rounded-full bg-muted\",\n      className\n    )}\n    {...props}\n  />\n))\nAvatarFallback.displayName = AvatarPrimitive.Fallback.displayName\n\nexport { Avatar, AvatarImage, AvatarFallback }\n","path":null,"size_bytes":1419,"size_tokens":null},"client/src/components/ui/badge.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst badgeVariants = cva(\n  \"inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2\",\n  {\n    variants: {\n      variant: {\n        default:\n          \"border-transparent bg-primary text-primary-foreground hover:bg-primary/80\",\n        secondary:\n          \"border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80\",\n        destructive:\n          \"border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80\",\n        outline: \"text-foreground\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nexport interface BadgeProps\n  extends React.HTMLAttributes<HTMLDivElement>,\n    VariantProps<typeof badgeVariants> {}\n\nfunction Badge({ className, variant, ...props }: BadgeProps) {\n  return (\n    <div className={cn(badgeVariants({ variant }), className)} {...props} />\n  )\n}\n\nexport { Badge, badgeVariants }\n","path":null,"size_bytes":1128,"size_tokens":null},"client/src/components/debug/DebugPanel.tsx":{"content":"import React, { useState, useEffect } from 'react';\nimport { detectIOSEnvironment, testStorageAvailability } from '../../config/authConfig';\n\ninterface DebugLog {\n  timestamp: string;\n  message: string;\n  data: any;\n  isIOS: boolean;\n  isTeamsApp: boolean;\n  isWebView: boolean;\n}\n\nexport const DebugPanel: React.FC = () => {\n  const [logs, setLogs] = useState<DebugLog[]>([]);\n  const [isVisible, setIsVisible] = useState(false);\n  const [deviceInfo, setDeviceInfo] = useState<any>({});\n  \n  useEffect(() => {\n    // Only show in development or if specifically enabled\n    const showDebug = process.env.NODE_ENV === 'development' || \n                     sessionStorage.getItem('enableDebug') === 'true';\n    \n    if (!showDebug) return;\n    \n    // Get device info\n    const { isIOS, isTeamsApp, isWebView, isSafari } = detectIOSEnvironment();\n    const storageInfo = testStorageAvailability();\n    \n    setDeviceInfo({\n      isIOS,\n      isTeamsApp, \n      isWebView,\n      isSafari,\n      userAgent: navigator.userAgent,\n      screen: `${window.screen.width}x${window.screen.height}`,\n      viewport: `${window.innerWidth}x${window.innerHeight}`,\n      cookies: navigator.cookieEnabled,\n      online: navigator.onLine,\n      storage: storageInfo,\n      language: navigator.language,\n      platform: navigator.platform\n    });\n    \n    // Load existing logs\n    const storedLogs = sessionStorage.getItem('authDebugLogs');\n    if (storedLogs) {\n      try {\n        setLogs(JSON.parse(storedLogs));\n      } catch (e) {\n        console.warn('Failed to parse debug logs:', e);\n      }\n    }\n    \n    // Update logs every 2 seconds\n    const interval = setInterval(() => {\n      const storedLogs = sessionStorage.getItem('authDebugLogs');\n      if (storedLogs) {\n        try {\n          setLogs(JSON.parse(storedLogs));\n        } catch (e) {\n          console.warn('Failed to parse debug logs:', e);\n        }\n      }\n    }, 2000);\n    \n    return () => clearInterval(interval);\n  }, []);\n  \n  // Don't render in production unless explicitly enabled\n  if (process.env.NODE_ENV === 'production' && \n      sessionStorage.getItem('enableDebug') !== 'true') {\n    return null;\n  }\n  \n  return (\n    <>\n      {/* Debug Toggle Button */}\n      <button\n        onClick={() => setIsVisible(!isVisible)}\n        style={{\n          position: 'fixed',\n          bottom: '10px',\n          right: '10px',\n          zIndex: 9999,\n          padding: '8px 12px',\n          backgroundColor: deviceInfo.isIOS ? '#ff6b6b' : '#4ecdc4',\n          color: 'white',\n          border: 'none',\n          borderRadius: '4px',\n          fontSize: '12px',\n          cursor: 'pointer'\n        }}\n        data-testid=\"debug-toggle\"\n      >\n        üêõ {deviceInfo.isIOS ? 'iOS' : 'Debug'}\n      </button>\n      \n      {/* Debug Panel */}\n      {isVisible && (\n        <div\n          style={{\n            position: 'fixed',\n            bottom: '50px',\n            right: '10px',\n            maxWidth: '400px',\n            maxHeight: '500px',\n            overflow: 'auto',\n            background: 'rgba(0,0,0,0.9)',\n            color: 'white',\n            fontSize: '11px',\n            padding: '15px',\n            borderRadius: '8px',\n            zIndex: 9998,\n            border: deviceInfo.isIOS ? '2px solid #ff6b6b' : '2px solid #4ecdc4'\n          }}\n          data-testid=\"debug-panel\"\n        >\n          {/* Device Info Section */}\n          <div style={{ marginBottom: '15px' }}>\n            <h4 style={{ margin: '0 0 8px 0', color: deviceInfo.isIOS ? '#ff6b6b' : '#4ecdc4' }}>\n              üì± Device Info {deviceInfo.isIOS && '(iOS DETECTED)'}\n            </h4>\n            <div style={{ fontSize: '10px', lineHeight: '1.3' }}>\n              <div><strong>Platform:</strong> {deviceInfo.platform}</div>\n              <div><strong>Screen:</strong> {deviceInfo.screen}</div>\n              <div><strong>Viewport:</strong> {deviceInfo.viewport}</div>\n              <div><strong>iOS:</strong> {deviceInfo.isIOS ? '‚úÖ' : '‚ùå'}</div>\n              <div><strong>Teams App:</strong> {deviceInfo.isTeamsApp ? '‚úÖ' : '‚ùå'}</div>\n              <div><strong>WebView:</strong> {deviceInfo.isWebView ? '‚úÖ' : '‚ùå'}</div>\n              <div><strong>Safari:</strong> {deviceInfo.isSafari ? '‚úÖ' : '‚ùå'}</div>\n              <div><strong>Cookies:</strong> {deviceInfo.cookies ? '‚úÖ' : '‚ùå'}</div>\n              <div><strong>Online:</strong> {deviceInfo.online ? '‚úÖ' : '‚ùå'}</div>\n              {deviceInfo.storage && (\n                <div>\n                  <strong>Storage:</strong> \n                  <span style={{ marginLeft: '4px' }}>\n                    Local:{deviceInfo.storage.localStorage ? '‚úÖ' : '‚ùå'} \n                    Session:{deviceInfo.storage.sessionStorage ? '‚úÖ' : '‚ùå'}\n                  </span>\n                </div>\n              )}\n            </div>\n          </div>\n          \n          {/* Auth Logs Section */}\n          <div>\n            <h4 style={{ margin: '0 0 8px 0', color: '#ffd93d' }}>\n              üîê Auth Debug Logs ({logs.length})\n            </h4>\n            <div style={{ maxHeight: '200px', overflowY: 'auto' }}>\n              {logs.length === 0 ? (\n                <div style={{ fontStyle: 'italic', color: '#999' }}>No logs yet...</div>\n              ) : (\n                logs.slice(-10).reverse().map((log, i) => (\n                  <div key={i} style={{ \n                    marginBottom: '6px', \n                    padding: '4px', \n                    backgroundColor: 'rgba(255,255,255,0.1)',\n                    borderRadius: '3px',\n                    borderLeft: log.isIOS ? '3px solid #ff6b6b' : '3px solid #4ecdc4'\n                  }}>\n                    <div style={{ fontSize: '9px', color: '#ccc' }}>\n                      {new Date(log.timestamp).toLocaleTimeString()}\n                    </div>\n                    <div style={{ fontSize: '10px', fontWeight: 'bold' }}>\n                      {log.message}\n                    </div>\n                    {log.data && (\n                      <div style={{ fontSize: '9px', color: '#aaa', marginTop: '2px' }}>\n                        {typeof log.data === 'object' ? JSON.stringify(log.data, null, 1) : log.data}\n                      </div>\n                    )}\n                  </div>\n                ))\n              )}\n            </div>\n          </div>\n          \n          {/* Clear Logs Button */}\n          <button\n            onClick={() => {\n              sessionStorage.removeItem('authDebugLogs');\n              setLogs([]);\n            }}\n            style={{\n              marginTop: '10px',\n              padding: '4px 8px',\n              backgroundColor: '#ff6b6b',\n              color: 'white',\n              border: 'none',\n              borderRadius: '3px',\n              fontSize: '10px',\n              cursor: 'pointer'\n            }}\n            data-testid=\"clear-logs-button\"\n          >\n            Clear Logs\n          </button>\n        </div>\n      )}\n    </>\n  );\n};\n\n// Hook to enable debug panel\nexport const useDebugPanel = () => {\n  useEffect(() => {\n    // Enable debug panel on iOS or in development\n    const { isIOS } = detectIOSEnvironment();\n    if (isIOS || process.env.NODE_ENV === 'development') {\n      sessionStorage.setItem('enableDebug', 'true');\n    }\n  }, []);\n};","path":null,"size_bytes":7306,"size_tokens":null},"client/src/lib/auth.ts":{"content":"import { User } from \"@shared/schema\";\n\nexport interface AuthState {\n  user: User | null;\n  isAuthenticated: boolean;\n}\n\nexport const getStoredAuth = (): AuthState => {\n  try {\n    const stored = localStorage.getItem(\"auth\");\n    if (stored) {\n      const parsed = JSON.parse(stored);\n      return {\n        user: parsed.user,\n        isAuthenticated: !!parsed.user\n      };\n    }\n  } catch (error) {\n    console.error(\"Failed to parse stored auth:\", error);\n  }\n  \n  return { user: null, isAuthenticated: false };\n};\n\nexport const setStoredAuth = (user: User | null) => {\n  try {\n    localStorage.setItem(\"auth\", JSON.stringify({ user }));\n  } catch (error) {\n    console.error(\"Failed to store auth:\", error);\n  }\n};\n\nexport const clearStoredAuth = () => {\n  try {\n    localStorage.removeItem(\"auth\");\n  } catch (error) {\n    console.error(\"Failed to clear auth:\", error);\n  }\n};\n","path":null,"size_bytes":882,"size_tokens":null},"client/src/components/ui/context-menu.tsx":{"content":"import * as React from \"react\"\nimport * as ContextMenuPrimitive from \"@radix-ui/react-context-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ContextMenu = ContextMenuPrimitive.Root\n\nconst ContextMenuTrigger = ContextMenuPrimitive.Trigger\n\nconst ContextMenuGroup = ContextMenuPrimitive.Group\n\nconst ContextMenuPortal = ContextMenuPrimitive.Portal\n\nconst ContextMenuSub = ContextMenuPrimitive.Sub\n\nconst ContextMenuRadioGroup = ContextMenuPrimitive.RadioGroup\n\nconst ContextMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <ContextMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </ContextMenuPrimitive.SubTrigger>\n))\nContextMenuSubTrigger.displayName = ContextMenuPrimitive.SubTrigger.displayName\n\nconst ContextMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuSubContent.displayName = ContextMenuPrimitive.SubContent.displayName\n\nconst ContextMenuContent = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.Portal>\n    <ContextMenuPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"z-50 max-h-[--radix-context-menu-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md animate-in fade-in-80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </ContextMenuPrimitive.Portal>\n))\nContextMenuContent.displayName = ContextMenuPrimitive.Content.displayName\n\nconst ContextMenuItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <ContextMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuItem.displayName = ContextMenuPrimitive.Item.displayName\n\nconst ContextMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <ContextMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <ContextMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </ContextMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </ContextMenuPrimitive.CheckboxItem>\n))\nContextMenuCheckboxItem.displayName =\n  ContextMenuPrimitive.CheckboxItem.displayName\n\nconst ContextMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <ContextMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <ContextMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </ContextMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </ContextMenuPrimitive.RadioItem>\n))\nContextMenuRadioItem.displayName = ContextMenuPrimitive.RadioItem.displayName\n\nconst ContextMenuLabel = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <ContextMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold text-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuLabel.displayName = ContextMenuPrimitive.Label.displayName\n\nconst ContextMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nContextMenuSeparator.displayName = ContextMenuPrimitive.Separator.displayName\n\nconst ContextMenuShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nContextMenuShortcut.displayName = \"ContextMenuShortcut\"\n\nexport {\n  ContextMenu,\n  ContextMenuTrigger,\n  ContextMenuContent,\n  ContextMenuItem,\n  ContextMenuCheckboxItem,\n  ContextMenuRadioItem,\n  ContextMenuLabel,\n  ContextMenuSeparator,\n  ContextMenuShortcut,\n  ContextMenuGroup,\n  ContextMenuPortal,\n  ContextMenuSub,\n  ContextMenuSubContent,\n  ContextMenuSubTrigger,\n  ContextMenuRadioGroup,\n}\n","path":null,"size_bytes":7428,"size_tokens":null},"client/src/components/ui/accordion.tsx":{"content":"import * as React from \"react\"\nimport * as AccordionPrimitive from \"@radix-ui/react-accordion\"\nimport { ChevronDown } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Accordion = AccordionPrimitive.Root\n\nconst AccordionItem = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Item>\n>(({ className, ...props }, ref) => (\n  <AccordionPrimitive.Item\n    ref={ref}\n    className={cn(\"border-b\", className)}\n    {...props}\n  />\n))\nAccordionItem.displayName = \"AccordionItem\"\n\nconst AccordionTrigger = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <AccordionPrimitive.Header className=\"flex\">\n    <AccordionPrimitive.Trigger\n      ref={ref}\n      className={cn(\n        \"flex flex-1 items-center justify-between py-4 font-medium transition-all hover:underline [&[data-state=open]>svg]:rotate-180\",\n        className\n      )}\n      {...props}\n    >\n      {children}\n      <ChevronDown className=\"h-4 w-4 shrink-0 transition-transform duration-200\" />\n    </AccordionPrimitive.Trigger>\n  </AccordionPrimitive.Header>\n))\nAccordionTrigger.displayName = AccordionPrimitive.Trigger.displayName\n\nconst AccordionContent = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <AccordionPrimitive.Content\n    ref={ref}\n    className=\"overflow-hidden text-sm transition-all data-[state=closed]:animate-accordion-up data-[state=open]:animate-accordion-down\"\n    {...props}\n  >\n    <div className={cn(\"pb-4 pt-0\", className)}>{children}</div>\n  </AccordionPrimitive.Content>\n))\n\nAccordionContent.displayName = AccordionPrimitive.Content.displayName\n\nexport { Accordion, AccordionItem, AccordionTrigger, AccordionContent }\n","path":null,"size_bytes":1977,"size_tokens":null},"client/src/components/CourseCreationModal.tsx":{"content":"import React, { useState, useEffect } from \"react\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle } from \"@/components/ui/dialog\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Label } from \"@/components/ui/label\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { X, Plus, Minus } from \"lucide-react\";\n\n// RequirementBuilder Component\nconst RequirementBuilder: React.FC<{ onAdd: (req: any) => void }> = ({ onAdd }) => {\n  const [showBuilder, setShowBuilder] = useState(false);\n  const [reqType, setReqType] = useState('age');\n  const [reqValue, setReqValue] = useState('');\n  const [customLabel, setCustomLabel] = useState('');\n\n  const requirementTypes = {\n    age: { label: 'Minimum Age', unit: 'years', valueType: 'number' },\n    tenure: { label: 'Employment Duration', unit: 'days', valueType: 'number' },\n    license: { label: 'License/Certification', options: ['drivers', 'forklift', 'hazmat', 'food-handler'] },\n    certification: { label: 'Special Certification', custom: true },\n    approval: { label: 'Manager Approval', noValue: true },\n    training: { label: 'External Training', custom: true },\n    physical: { label: 'Physical Requirement', custom: true }\n  };\n\n  const handleAddRequirement = () => {\n    // Validation\n    if (!requirementTypes[reqType].noValue && !reqValue) {\n      alert('Please enter a value');\n      return;\n    }\n    \n    if (requirementTypes[reqType].custom && !customLabel) {\n      alert('Please enter a description');\n      return;\n    }\n    \n    // Generate label based on type\n    let label = '';\n    \n    switch (reqType) {\n      case 'age':\n        label = `Must be ${reqValue} years or older`;\n        break;\n      case 'tenure':\n        const days = parseInt(reqValue);\n        if (days >= 365) {\n          const years = Math.floor(days / 365);\n          label = `Employed for at least ${years} year${years > 1 ? 's' : ''}`;\n        } else if (days >= 30) {\n          const months = Math.floor(days / 30);\n          label = `Employed for at least ${months} month${months > 1 ? 's' : ''}`;\n        } else {\n          label = `Employed for at least ${days} days`;\n        }\n        break;\n      case 'license':\n        const licenseLabels = {\n          'drivers': \"Valid driver's license\",\n          'forklift': 'Forklift operator certification',\n          'hazmat': 'HAZMAT certification',\n          'food-handler': \"Food handler's permit\"\n        };\n        label = licenseLabels[reqValue] || `${reqValue} license required`;\n        break;\n      case 'approval':\n        label = 'Requires manager approval';\n        break;\n      case 'certification':\n      case 'training':\n      case 'physical':\n        label = customLabel;\n        break;\n      default:\n        label = customLabel || `${requirementTypes[reqType].label} required`;\n    }\n    \n    const requirement = {\n      type: reqType,\n      value: requirementTypes[reqType].noValue ? null : reqValue,\n      label\n    };\n    \n    console.log('Adding requirement:', requirement);\n    onAdd(requirement);\n    \n    // Reset\n    setReqValue('');\n    setCustomLabel('');\n    setShowBuilder(false);\n  };\n\n  return (\n    <div>\n      {!showBuilder ? (\n        <Button\n          type=\"button\"\n          variant=\"outline\"\n          size=\"sm\"\n          onClick={() => setShowBuilder(true)}\n          className=\"w-full\"\n        >\n          <Plus className=\"h-4 w-4 mr-2\" />\n          Add Requirement\n        </Button>\n      ) : (\n        <div className=\"border rounded p-3 space-y-3\">\n          <div>\n            <Label className=\"text-xs\">Requirement Type</Label>\n            <select\n              value={reqType}\n              onChange={(e) => {\n                setReqType(e.target.value);\n                setReqValue('');\n                setCustomLabel('');\n              }}\n              className=\"w-full p-2 border rounded text-sm\"\n            >\n              {Object.entries(requirementTypes).map(([key, config]) => (\n                <option key={key} value={key}>{config.label}</option>\n              ))}\n            </select>\n          </div>\n          \n          {!requirementTypes[reqType].noValue && (\n            <>\n              {requirementTypes[reqType].options ? (\n                <div>\n                  <Label className=\"text-xs\">Select {requirementTypes[reqType].label}</Label>\n                  <select\n                    value={reqValue}\n                    onChange={(e) => setReqValue(e.target.value)}\n                    className=\"w-full p-2 border rounded text-sm\"\n                    required\n                  >\n                    <option value=\"\">Choose...</option>\n                    {requirementTypes[reqType].options.map(opt => (\n                      <option key={opt} value={opt}>\n                        {opt.charAt(0).toUpperCase() + opt.slice(1).replace('-', ' ')}\n                      </option>\n                    ))}\n                  </select>\n                </div>\n              ) : requirementTypes[reqType].custom ? (\n                <div>\n                  <Label className=\"text-xs\">Requirement Description</Label>\n                  <Input\n                    value={customLabel}\n                    onChange={(e) => setCustomLabel(e.target.value)}\n                    placeholder=\"e.g., Must be able to lift 50 lbs\"\n                    className=\"text-sm\"\n                    required\n                  />\n                </div>\n              ) : (\n                <div>\n                  <Label className=\"text-xs\">{requirementTypes[reqType].label} ({requirementTypes[reqType].unit})</Label>\n                  <Input\n                    type=\"number\"\n                    value={reqValue}\n                    onChange={(e) => setReqValue(e.target.value)}\n                    placeholder={`Enter ${requirementTypes[reqType].unit}`}\n                    min=\"0\"\n                    className=\"text-sm\"\n                    required\n                  />\n                </div>\n              )}\n            </>\n          )}\n          \n          <div className=\"flex space-x-2\">\n            <Button\n              type=\"button\"\n              size=\"sm\"\n              onClick={handleAddRequirement}\n              className=\"flex-1\"\n            >\n              Add Requirement\n            </Button>\n            <Button\n              type=\"button\"\n              variant=\"outline\"\n              size=\"sm\"\n              onClick={() => setShowBuilder(false)}\n              className=\"flex-1\"\n            >\n              Cancel\n            </Button>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n};\n\ninterface Course {\n  id: number;\n  title: string;\n  description: string;\n  roleAwarded: string;\n  sections: number;\n  estimatedTime: string;\n  status: 'not-started' | 'in-progress' | 'completed';\n  progress: number;\n  completedDate?: string;\n  icon: string;\n  requiresApproval?: boolean;\n  prerequisites?: {\n    courses: number[];\n    requirements: {\n      type: 'age' | 'tenure' | 'license' | 'certification';\n      value: number | string;\n      label: string;\n    }[];\n  };\n}\n\ninterface CourseCreationModalProps {\n  isOpen: boolean;\n  onClose: () => void;\n  onSave: (course: Omit<Course, 'id' | 'status' | 'progress'>) => void;\n  onDelete?: (courseId: number) => void;\n  allCourses: Course[];\n  editingCourse?: Course | null;\n}\n\ninterface CourseSection {\n  title: string;\n  type: 'text' | 'video' | 'image' | 'rich-text' | 'quiz' | 'checklist';\n  content: string;\n  caption?: string;\n}\n\nconst CourseCreationModal: React.FC<CourseCreationModalProps> = ({ \n  isOpen, \n  onClose, \n  onSave, \n  onDelete,\n  allCourses,\n  editingCourse = null\n}) => {\n  const [courseData, setCourseData] = useState({\n    title: editingCourse?.title || '',\n    description: editingCourse?.description || '',\n    roleAwarded: editingCourse?.roleAwarded || '',\n    estimatedTime: editingCourse?.estimatedTime || '',\n    icon: editingCourse?.icon || 'üìö',\n    prerequisites: editingCourse?.prerequisites || { courses: [], requirements: [] },\n    requiresApproval: editingCourse?.requiresApproval || false\n  });\n\n  const [sections, setSections] = useState<CourseSection[]>([\n    { title: '', type: 'text' as const, content: '' }\n  ]);\n\n  // Update form when editing course changes\n  useEffect(() => {\n    if (editingCourse) {\n      setCourseData({\n        title: editingCourse.title,\n        description: editingCourse.description,\n        roleAwarded: editingCourse.roleAwarded,\n        estimatedTime: editingCourse.estimatedTime,\n        icon: editingCourse.icon,\n        prerequisites: editingCourse.prerequisites || { courses: [], requirements: [] },\n        requiresApproval: editingCourse.requiresApproval || false\n      });\n    } else {\n      setCourseData({\n        title: '',\n        description: '',\n        roleAwarded: '',\n        estimatedTime: '',\n        icon: 'üìö',\n        prerequisites: { courses: [], requirements: [] },\n        requiresApproval: false\n      });\n    }\n  }, [editingCourse]);\n\n  const availableIcons = ['üìö', 'üå±', 'üåæ', 'üßπ', 'üîß', 'ü¶∫', 'üìä', 'üåø', 'üëî', '‚öôÔ∏è', 'üéØ', 'üìã'];\n\n  // Helper functions for video URLs\n  const isYouTubeUrl = (url: string) => {\n    return url.includes('youtube.com/watch') || url.includes('youtu.be/');\n  };\n\n  const getYouTubeEmbedUrl = (url: string) => {\n    let videoId = '';\n    if (url.includes('youtube.com/watch')) {\n      videoId = url.split('v=')[1]?.split('&')[0];\n    } else if (url.includes('youtu.be/')) {\n      videoId = url.split('youtu.be/')[1]?.split('?')[0];\n    }\n    return `https://www.youtube.com/embed/${videoId}`;\n  };\n\n  const isVimeoUrl = (url: string) => {\n    return url.includes('vimeo.com/');\n  };\n\n  const getVimeoEmbedUrl = (url: string) => {\n    const videoId = url.split('vimeo.com/')[1]?.split('?')[0];\n    return `https://player.vimeo.com/video/${videoId}`;\n  };\n\n  // Render rich text content with embedded media\n  const renderRichContent = (content: string) => {\n    if (!content) return null;\n    \n    // Split content by media tags\n    const parts = content.split(/(\\[\\[IMAGE:.*?\\]\\]|\\[\\[VIDEO:.*?\\]\\])/);\n    \n    return parts.map((part, index) => {\n      if (part.startsWith('[[IMAGE:')) {\n        const url = part.match(/\\[\\[IMAGE:(.*?)\\]\\]/)?.[1];\n        return url ? (\n          <img \n            key={index} \n            src={url} \n            alt=\"Embedded\" \n            className=\"max-w-full h-auto my-3 rounded\"\n            onError={(e) => {\n              (e.target as HTMLImageElement).src = 'https://via.placeholder.com/400x300?text=Image+Not+Found';\n            }}\n          />\n        ) : null;\n      } else if (part.startsWith('[[VIDEO:')) {\n        const url = part.match(/\\[\\[VIDEO:(.*?)\\]\\]/)?.[1];\n        if (!url) return null;\n        \n        if (isYouTubeUrl(url)) {\n          return (\n            <iframe\n              key={index}\n              src={getYouTubeEmbedUrl(url)}\n              className=\"w-full h-96 my-3 rounded\"\n              frameBorder=\"0\"\n              allowFullScreen\n            />\n          );\n        } else if (isVimeoUrl(url)) {\n          return (\n            <iframe\n              key={index}\n              src={getVimeoEmbedUrl(url)}\n              className=\"w-full h-96 my-3 rounded\"\n              frameBorder=\"0\"\n              allowFullScreen\n            />\n          );\n        } else {\n          return (\n            <video key={index} controls className=\"w-full my-3 rounded\">\n              <source src={url} />\n            </video>\n          );\n        }\n      } else {\n        return <p key={index}>{part}</p>;\n      }\n    });\n  };\n\n  const renderSectionContent = (section: CourseSection, index: number) => {\n    switch (section.type) {\n      case 'video':\n        return (\n          <div className=\"space-y-3\">\n            <Input\n              type=\"url\"\n              placeholder=\"Video URL (YouTube, Vimeo, or direct video link)\"\n              value={section.content}\n              onChange={(e) => handleSectionChange(index, 'content', e.target.value)}\n              className=\"w-full\"\n            />\n            {section.content && (\n              <div className=\"border rounded-lg overflow-hidden\">\n                <div className=\"bg-gray-50 px-3 py-2 text-sm font-medium\">Preview:</div>\n                <div className=\"p-3\">\n                  {isYouTubeUrl(section.content) ? (\n                    <iframe\n                      src={getYouTubeEmbedUrl(section.content)}\n                      className=\"w-full h-48\"\n                      frameBorder=\"0\"\n                      allowFullScreen\n                    />\n                  ) : isVimeoUrl(section.content) ? (\n                    <iframe\n                      src={getVimeoEmbedUrl(section.content)}\n                      className=\"w-full h-48\"\n                      frameBorder=\"0\"\n                      allowFullScreen\n                    />\n                  ) : (\n                    <video className=\"w-full h-48\" controls>\n                      <source src={section.content} />\n                      Your browser does not support video.\n                    </video>\n                  )}\n                </div>\n              </div>\n            )}\n          </div>\n        );\n        \n      case 'image':\n        return (\n          <div className=\"space-y-3\">\n            <Input\n              type=\"url\"\n              placeholder=\"Image URL (jpg, png, gif)\"\n              value={section.content}\n              onChange={(e) => handleSectionChange(index, 'content', e.target.value)}\n              className=\"w-full\"\n            />\n            <Textarea\n              placeholder=\"Image caption (optional)\"\n              value={section.caption || ''}\n              onChange={(e) => handleSectionChange(index, 'caption', e.target.value)}\n              rows={2}\n              className=\"w-full\"\n            />\n            {section.content && (\n              <div className=\"border rounded-lg overflow-hidden\">\n                <div className=\"bg-gray-50 px-3 py-2 text-sm font-medium\">Preview:</div>\n                <div className=\"p-3\">\n                  <img \n                    src={section.content} \n                    alt=\"Preview\" \n                    className=\"max-w-full h-auto rounded\"\n                    onError={(e) => {\n                      (e.target as HTMLImageElement).src = 'https://via.placeholder.com/400x300?text=Invalid+Image+URL';\n                    }}\n                  />\n                  {section.caption && (\n                    <p className=\"text-center italic text-gray-600 mt-2\">{section.caption}</p>\n                  )}\n                </div>\n              </div>\n            )}\n          </div>\n        );\n        \n      case 'rich-text':\n        return (\n          <div className=\"space-y-3\">\n            <p className=\"text-xs text-gray-500\">You can embed images and videos using URLs in your text</p>\n            <Textarea\n              placeholder=\"Enter your content. Use [[IMAGE:url]] for images or [[VIDEO:url]] for videos\"\n              value={section.content}\n              onChange={(e) => handleSectionChange(index, 'content', e.target.value)}\n              rows={6}\n              className=\"w-full\"\n            />\n            {section.content && (\n              <div className=\"border rounded-lg overflow-hidden\">\n                <div className=\"bg-gray-50 px-3 py-2 text-sm font-medium\">Preview:</div>\n                <div className=\"p-3 bg-white rounded\">\n                  {renderRichContent(section.content)}\n                </div>\n              </div>\n            )}\n          </div>\n        );\n        \n      case 'quiz':\n        return (\n          <div className=\"space-y-3\">\n            <Input\n              placeholder=\"Quiz question\"\n              value={section.content}\n              onChange={(e) => handleSectionChange(index, 'content', e.target.value)}\n              className=\"w-full\"\n            />\n            <div className=\"grid grid-cols-2 gap-2\">\n              <Input\n                placeholder=\"Option A\"\n                value={(section as any).optionA || ''}\n                onChange={(e) => handleSectionChange(index, 'optionA' as keyof CourseSection, e.target.value)}\n              />\n              <Input\n                placeholder=\"Option B\"\n                value={(section as any).optionB || ''}\n                onChange={(e) => handleSectionChange(index, 'optionB' as keyof CourseSection, e.target.value)}\n              />\n              <Input\n                placeholder=\"Option C\"\n                value={(section as any).optionC || ''}\n                onChange={(e) => handleSectionChange(index, 'optionC' as keyof CourseSection, e.target.value)}\n              />\n              <Input\n                placeholder=\"Option D\"\n                value={(section as any).optionD || ''}\n                onChange={(e) => handleSectionChange(index, 'optionD' as keyof CourseSection, e.target.value)}\n              />\n            </div>\n            <select\n              value={(section as any).correctAnswer || 'A'}\n              onChange={(e) => handleSectionChange(index, 'correctAnswer' as keyof CourseSection, e.target.value)}\n              className=\"w-full p-2 border rounded\"\n            >\n              <option value=\"A\">Correct Answer: A</option>\n              <option value=\"B\">Correct Answer: B</option>\n              <option value=\"C\">Correct Answer: C</option>\n              <option value=\"D\">Correct Answer: D</option>\n            </select>\n          </div>\n        );\n        \n      case 'checklist':\n        return (\n          <div className=\"space-y-3\">\n            <Textarea\n              placeholder=\"Enter checklist items (one per line)\"\n              value={section.content}\n              onChange={(e) => handleSectionChange(index, 'content', e.target.value)}\n              rows={4}\n              className=\"w-full\"\n            />\n            {section.content && (\n              <div className=\"border rounded-lg overflow-hidden\">\n                <div className=\"bg-gray-50 px-3 py-2 text-sm font-medium\">Preview:</div>\n                <div className=\"p-3\">\n                  {section.content.split('\\n').filter(item => item.trim()).map((item, idx) => (\n                    <div key={idx} className=\"flex items-center py-1\">\n                      <input type=\"checkbox\" className=\"mr-2\" />\n                      <span>{item.replace(/^‚òê\\s*/, '')}</span>\n                    </div>\n                  ))}\n                </div>\n              </div>\n            )}\n          </div>\n        );\n        \n      default: // text\n        return (\n          <Textarea\n            placeholder=\"Section content/instructions...\"\n            value={section.content}\n            onChange={(e) => handleSectionChange(index, 'content', e.target.value)}\n            rows={4}\n            className=\"w-full\"\n          />\n        );\n    }\n  };\n\n  const handleAddSection = () => {\n    setSections([...sections, { title: '', type: 'text', content: '' }]);\n  };\n\n  const handleRemoveSection = (index: number) => {\n    if (sections.length > 1) {\n      setSections(sections.filter((_, i) => i !== index));\n    }\n  };\n\n  const handleSectionChange = (index: number, field: keyof CourseSection, value: string) => {\n    const newSections = [...sections];\n    newSections[index] = { ...newSections[index], [field]: value };\n    setSections(newSections);\n  };\n\n  const handlePrerequisiteToggle = (courseId: number, checked: boolean) => {\n    if (checked) {\n      setCourseData({\n        ...courseData,\n        prerequisites: {\n          ...courseData.prerequisites,\n          courses: [...courseData.prerequisites.courses, courseId]\n        }\n      });\n    } else {\n      setCourseData({\n        ...courseData,\n        prerequisites: {\n          ...courseData.prerequisites,\n          courses: courseData.prerequisites.courses.filter(id => id !== courseId)\n        }\n      });\n    }\n  };\n\n  const handleAddRequirement = (requirement: { type: string; value: number | string; label: string }) => {\n    console.log('Received requirement:', requirement);\n    \n    setCourseData(prevData => ({\n      ...prevData,\n      prerequisites: {\n        ...prevData.prerequisites,\n        requirements: [...prevData.prerequisites.requirements, requirement]\n      }\n    }));\n  };\n\n  const handleRemoveRequirement = (index: number) => {\n    setCourseData(prevData => ({\n      ...prevData,\n      prerequisites: {\n        ...prevData.prerequisites,\n        requirements: prevData.prerequisites.requirements.filter((_, i) => i !== index)\n      }\n    }));\n  };\n\n  const handleSave = () => {\n    console.log('Saving course with prerequisites:', courseData.prerequisites);\n    \n    if (!courseData.title || !courseData.roleAwarded || !courseData.estimatedTime) {\n      alert('Please fill in all required fields');\n      return;\n    }\n\n    const newCourse = {\n      ...courseData,\n      id: editingCourse?.id || Date.now(),\n      status: editingCourse?.status || 'not-started',\n      progress: editingCourse?.progress || 0,\n      sections: sections.length,\n      sectionDetails: sections,\n      completedDate: editingCourse?.completedDate || undefined,\n      createdBy: editingCourse?.createdBy || 'Current User',\n      createdAt: editingCourse?.createdAt || new Date().toISOString()\n    };\n\n    console.log('Final course object:', newCourse);\n    onSave(newCourse);\n    \n    // Reset form only if creating new course\n    if (!editingCourse) {\n      setCourseData({\n        title: '',\n        description: '',\n        roleAwarded: '',\n        estimatedTime: '',\n        icon: 'üìö',\n        prerequisites: { courses: [], requirements: [] },\n        requiresApproval: false\n      });\n      setSections([{ title: '', type: 'text', content: '' }]);\n    }\n  };\n\n  const handleDelete = () => {\n    if (!editingCourse || !onDelete) return;\n    \n    const confirmMessage = `Are you sure you want to delete \"${courseData.title}\"?\\n\\nThis will permanently remove the course and cannot be undone.`;\n    \n    if (confirm(confirmMessage)) {\n      onDelete(editingCourse.id);\n      onClose();\n    }\n  };\n\n  return (\n    <Dialog open={isOpen} onOpenChange={onClose}>\n      <DialogContent className=\"max-w-4xl max-h-[90vh] overflow-y-auto\">\n        <DialogHeader>\n          <DialogTitle className=\"text-xl font-bold text-[#203B17]\">\n            {editingCourse ? 'Edit Course' : 'Create New Course'}\n          </DialogTitle>\n        </DialogHeader>\n\n        <div className=\"space-y-6\">\n          {/* Basic Information */}\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n            <div>\n              <Label htmlFor=\"title\">Course Title *</Label>\n              <Input\n                id=\"title\"\n                value={courseData.title}\n                onChange={(e) => setCourseData({ ...courseData, title: e.target.value })}\n                placeholder=\"e.g., Advanced Hydroponics Training\"\n                className=\"mt-1\"\n              />\n            </div>\n\n            <div>\n              <Label htmlFor=\"roleAwarded\">Role Awarded *</Label>\n              <Input\n                id=\"roleAwarded\"\n                value={courseData.roleAwarded}\n                onChange={(e) => setCourseData({ ...courseData, roleAwarded: e.target.value })}\n                placeholder=\"e.g., Senior Technician\"\n                className=\"mt-1\"\n              />\n            </div>\n\n            <div>\n              <Label htmlFor=\"estimatedTime\">Estimated Time *</Label>\n              <Input\n                id=\"estimatedTime\"\n                value={courseData.estimatedTime}\n                onChange={(e) => setCourseData({ ...courseData, estimatedTime: e.target.value })}\n                placeholder=\"e.g., 2 hours\"\n                className=\"mt-1\"\n              />\n            </div>\n\n            <div>\n              <Label>Course Icon</Label>\n              <div className=\"flex flex-wrap gap-2 mt-2\">\n                {availableIcons.map(icon => (\n                  <Button\n                    key={icon}\n                    type=\"button\"\n                    variant={courseData.icon === icon ? \"default\" : \"outline\"}\n                    size=\"sm\"\n                    onClick={() => setCourseData({ ...courseData, icon })}\n                    className=\"text-lg\"\n                  >\n                    {icon}\n                  </Button>\n                ))}\n              </div>\n            </div>\n          </div>\n\n          {/* Description */}\n          <div>\n            <Label htmlFor=\"description\">Description</Label>\n            <Textarea\n              id=\"description\"\n              value={courseData.description}\n              onChange={(e) => setCourseData({ ...courseData, description: e.target.value })}\n              placeholder=\"Brief description of what students will learn...\"\n              rows={3}\n              className=\"mt-1\"\n            />\n          </div>\n\n          {/* Prerequisites */}\n          <div>\n            <Label>Course Prerequisites</Label>\n            <div className=\"mt-2 space-y-2 max-h-32 overflow-y-auto\">\n              {allCourses\n                .filter(course => course.id !== editingCourse?.id)\n                .map(course => (\n                <div key={course.id} className=\"flex items-center space-x-2\">\n                  <Checkbox\n                    id={`prereq-${course.id}`}\n                    checked={courseData.prerequisites.courses.includes(course.id)}\n                    onCheckedChange={(checked) => \n                      handlePrerequisiteToggle(course.id, checked as boolean)\n                    }\n                  />\n                  <Label htmlFor={`prereq-${course.id}`} className=\"text-sm\">\n                    {course.icon} {course.title}\n                  </Label>\n                </div>\n              ))}\n            </div>\n          </div>\n\n          {/* Additional Requirements */}\n          <div>\n            <Label>Additional Requirements</Label>\n            <div className=\"mt-2 space-y-2\">\n              {courseData.prerequisites.requirements.map((req, index) => (\n                <div key={index} className=\"flex items-center justify-between bg-gray-50 p-2 rounded\">\n                  <span className=\"text-sm\">{req.label}</span>\n                  <Button\n                    type=\"button\"\n                    variant=\"ghost\"\n                    size=\"sm\"\n                    onClick={() => handleRemoveRequirement(index)}\n                    className=\"h-6 w-6 p-0 text-red-500 hover:text-red-700\"\n                  >\n                    <X className=\"h-4 w-4\" />\n                  </Button>\n                </div>\n              ))}\n              <RequirementBuilder onAdd={handleAddRequirement} />\n            </div>\n          </div>\n\n          {/* Manager Approval */}\n          <div className=\"flex items-center space-x-2\">\n            <Checkbox\n              id=\"requiresApproval\"\n              checked={courseData.requiresApproval}\n              onCheckedChange={(checked) => \n                setCourseData({ ...courseData, requiresApproval: checked as boolean })\n              }\n            />\n            <Label htmlFor=\"requiresApproval\">Requires Manager Approval</Label>\n          </div>\n\n          {/* Sections */}\n          <div>\n            <div className=\"flex items-center justify-between mb-4\">\n              <Label className=\"text-lg font-semibold\">Course Sections</Label>\n              <Button\n                type=\"button\"\n                variant=\"outline\"\n                size=\"sm\"\n                onClick={handleAddSection}\n              >\n                <Plus className=\"h-4 w-4 mr-2\" />\n                Add Section\n              </Button>\n            </div>\n\n            <div className=\"space-y-4\">\n              {sections.map((section, index) => (\n                <div key={index} className=\"border rounded-lg p-4 space-y-3\">\n                  <div className=\"flex items-center justify-between\">\n                    <h4 className=\"font-medium\">Section {index + 1}</h4>\n                    {sections.length > 1 && (\n                      <Button\n                        type=\"button\"\n                        variant=\"ghost\"\n                        size=\"sm\"\n                        onClick={() => handleRemoveSection(index)}\n                      >\n                        <Minus className=\"h-4 w-4\" />\n                      </Button>\n                    )}\n                  </div>\n\n                  <div className=\"grid grid-cols-1 md:grid-cols-2 gap-3\">\n                    <div>\n                      <Label>Section Title</Label>\n                      <Input\n                        value={section.title}\n                        onChange={(e) => handleSectionChange(index, 'title', e.target.value)}\n                        placeholder=\"e.g., Introduction to Hydroponics\"\n                        className=\"mt-1\"\n                      />\n                    </div>\n\n                    <div>\n                      <Label>Content Type</Label>\n                      <select\n                        value={section.type}\n                        onChange={(e) => handleSectionChange(index, 'type', e.target.value)}\n                        className=\"w-full mt-1 p-2 border rounded-md\"\n                      >\n                        <option value=\"text\">üìù Text Content</option>\n                        <option value=\"rich-text\">üìÑ Rich Text (with media)</option>\n                        <option value=\"video\">üé• Video Only</option>\n                        <option value=\"image\">üñºÔ∏è Image Only</option>\n                        <option value=\"quiz\">‚ùì Quiz</option>\n                        <option value=\"checklist\">‚úÖ Checklist</option>\n                      </select>\n                    </div>\n                  </div>\n\n                  <div>\n                    <Label>Content</Label>\n                    {renderSectionContent(section, index)}\n                  </div>\n                </div>\n              ))}\n            </div>\n          </div>\n        </div>\n\n        {/* Actions */}\n        <div className=\"flex justify-between items-center pt-4 border-t\">\n          <div className=\"flex-1\">\n            {editingCourse && onDelete && (\n              <Button \n                variant=\"destructive\" \n                onClick={handleDelete}\n                className=\"bg-red-600 hover:bg-red-700 text-white\"\n              >\n                üóëÔ∏è Delete Course\n              </Button>\n            )}\n          </div>\n          <div className=\"flex space-x-3\">\n            <Button variant=\"outline\" onClick={onClose}>\n              Cancel\n            </Button>\n            <Button onClick={handleSave} className=\"bg-[#2D8028] hover:bg-[#203B17]\">\n              {editingCourse ? 'Save Changes' : 'Create Course'}\n            </Button>\n          </div>\n        </div>\n      </DialogContent>\n    </Dialog>\n  );\n};\n\nexport default CourseCreationModal;","path":null,"size_bytes":30897,"size_tokens":null},"client/src/pages/TrayTracking.tsx":{"content":"import React, { useState, useEffect } from 'react';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { Badge } from '@/components/ui/badge';\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from '@/components/ui/dialog';\nimport { Package, MapPin, Clock, Users, Split, ArrowRight, Search, Filter, Calendar } from 'lucide-react';\nimport { Tray, TrayMovement } from '../data/trayTracking';\nimport { GrowingSystem } from '../data/systemsData';\nimport { TrayMovementService } from '../services/trayMovement';\nimport { TraySplitInterface } from '../components/TraySplitInterface';\nimport { useQuery } from '@tanstack/react-query';\nimport TrayDataService from '../services/trayDataService';\n\nconst TrayTracking: React.FC = () => {\n  const [searchTerm, setSearchTerm] = useState('');\n  const [statusFilter, setStatusFilter] = useState('all');\n  const [cropFilter, setCropFilter] = useState('all');\n  const [selectedTray, setSelectedTray] = useState<Tray | null>(null);\n  const [showSplitModal, setShowSplitModal] = useState(false);\n  const [trays, setTrays] = useState<Tray[]>([]);\n  const [movements, setMovements] = useState<TrayMovement[]>([]);\n\n  const { data: systems = [] } = useQuery<GrowingSystem[]>({\n    queryKey: ['/api/growing-systems']\n  });\n\n  // Load trays on component mount\n  useEffect(() => {\n    const loadTrays = () => {\n      const loadedTrays = TrayDataService.loadTrays();\n      console.log('TrayTracking: Loaded', loadedTrays.length, 'trays');\n      setTrays(loadedTrays);\n    };\n    \n    loadTrays();\n    \n    // Listen for tray data updates\n    const handleTrayUpdate = (event: any) => {\n      console.log('TrayTracking: Received tray data update event');\n      loadTrays();\n    };\n    \n    window.addEventListener('trayDataUpdated', handleTrayUpdate);\n    \n    return () => {\n      window.removeEventListener('trayDataUpdated', handleTrayUpdate);\n    };\n  }, []);\n\n  useEffect(() => {\n    // Check for automatic movements\n    const automaticMovements = TrayMovementService.checkAutomaticMovements(trays, systems);\n    setMovements(automaticMovements);\n  }, [trays, systems]);\n\n  const filteredTrays = trays.filter(tray => {\n    const matchesSearch = tray.id.toLowerCase().includes(searchTerm.toLowerCase()) ||\n                         tray.cropType.toLowerCase().includes(searchTerm.toLowerCase());\n    const matchesStatus = statusFilter === 'all' || tray.status === statusFilter;\n    const matchesCrop = cropFilter === 'all' || tray.cropCategory === cropFilter;\n    \n    return matchesSearch && matchesStatus && matchesCrop;\n  });\n\n  const getStatusColor = (status: string) => {\n    switch (status) {\n      case 'seeded': return 'bg-yellow-100 text-yellow-800';\n      case 'germinating': return 'bg-orange-100 text-orange-800';\n      case 'growing': return 'bg-green-100 text-green-800';\n      case 'ready': return 'bg-blue-100 text-blue-800';\n      case 'harvested': return 'bg-gray-100 text-gray-800';\n      case 'split': return 'bg-purple-100 text-purple-800';\n      case 'discarded': return 'bg-red-100 text-red-800';\n      default: return 'bg-gray-100 text-gray-800';\n    }\n  };\n\n  const getSystemIcon = (systemType: string) => {\n    switch (systemType) {\n      case 'nursery': return 'üå±';\n      case 'blackout': return 'üåë';\n      case 'microgreens': return 'üåø';\n      case 'towers': return 'üèóÔ∏è';\n      case 'nft': return 'üíß';\n      case 'ebbFlow': return 'üåä';\n      default: return 'üì¶';\n    }\n  };\n\n  const handleSplitTray = (splits: Array<{\n    systemId: string;\n    systemType: string;\n    spotIds: string[];\n    plantCount: number;\n  }>) => {\n    if (!selectedTray) return;\n\n    console.log('TrayTracking: Handling split for tray', selectedTray.id);\n    \n    // Use the shared TrayDataService for splitting\n    const { originalTray, splitTrays } = TrayDataService.splitTray(\n      selectedTray.id,\n      splits.length\n    );\n\n    console.log('TrayTracking: Split completed, reloading trays');\n    \n    // Reload trays from service (this will trigger re-render)\n    const updatedTrays = TrayDataService.loadTrays();\n    setTrays(updatedTrays);\n\n    setShowSplitModal(false);\n    setSelectedTray(null);\n  };\n\n  const handleMoveTray = (tray: Tray, toSystemId: string, toSystemType: string) => {\n    const updatedTray = TrayMovementService.moveTray(\n      tray,\n      toSystemId,\n      toSystemType,\n      [], // Would need to select specific spots\n      'Current User',\n      'Manual movement'\n    );\n\n    setTrays(prevTrays => prevTrays.map(t => t.id === tray.id ? updatedTray : t));\n  };\n\n  const getDaysInSystem = (tray: Tray) => {\n    const daysSinceMoved = Math.floor(\n      (Date.now() - tray.currentLocation.movedDate.getTime()) / (1000 * 60 * 60 * 24)\n    );\n    return daysSinceMoved;\n  };\n\n  const getDaysUntilHarvest = (tray: Tray) => {\n    const daysUntilHarvest = Math.floor(\n      (tray.expectedHarvest.getTime() - Date.now()) / (1000 * 60 * 60 * 24)\n    );\n    return daysUntilHarvest;\n  };\n\n  // Helper function to render plant information with variety names\n  const renderPlantInfo = (tray: Tray): string => {\n    if (!tray.varieties || tray.varieties.length === 0) {\n      return `${tray.plantCount || 0} ${tray.cropType || 'Unknown'}`;\n    }\n    \n    if (tray.varieties.length === 1) {\n      // Single variety: \"5 Arugula\"\n      return `${tray.varieties[0].quantity} ${tray.varieties[0].seedName}`;\n    }\n    \n    // Multiple varieties: \"Mixed: 3 Arugula, 2 Basil\"\n    const varietyList = tray.varieties\n      .map(v => `${v.quantity} ${v.seedName}`)\n      .join(', ');\n    return `Mixed: ${varietyList}`;\n  };\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-2xl font-bold\">Tray Tracking</h1>\n          <p className=\"text-gray-600\">Monitor tray locations and movement throughout the growing process</p>\n        </div>\n        <div className=\"flex items-center gap-2\">\n          <Badge variant=\"outline\" className=\"flex items-center gap-1\">\n            <Package className=\"w-4 h-4\" />\n            {trays.length} Total Trays\n          </Badge>\n          <Badge variant=\"outline\" className=\"flex items-center gap-1\">\n            <ArrowRight className=\"w-4 h-4\" />\n            {movements.length} Pending Movements\n          </Badge>\n          {/* Debug button for testing splits */}\n          <Button\n            variant=\"outline\"\n            size=\"sm\"\n            onClick={() => {\n              console.log('=== TESTING SPLIT FUNCTIONALITY ===');\n              const firstTray = trays.find(t => t.status === 'growing');\n              if (firstTray) {\n                console.log('Testing split for tray:', firstTray.id);\n                const result = TrayDataService.splitTray(firstTray.id, 2);\n                console.log('Split test result:', result);\n                // Reload trays to see changes\n                const updatedTrays = TrayDataService.loadTrays();\n                setTrays(updatedTrays);\n              } else {\n                console.log('No growing trays found for split test');\n              }\n            }}\n          >\n            üß™ Test Split\n          </Button>\n        </div>\n      </div>\n\n      <Tabs defaultValue=\"trays\" className=\"w-full\">\n        <TabsList className=\"grid w-full grid-cols-3\">\n          <TabsTrigger value=\"trays\">Active Trays</TabsTrigger>\n          <TabsTrigger value=\"movements\">Pending Movements</TabsTrigger>\n          <TabsTrigger value=\"history\">Location History</TabsTrigger>\n        </TabsList>\n\n        <TabsContent value=\"trays\" className=\"space-y-4\">\n          {/* Filters */}\n          <div className=\"flex flex-wrap gap-4 p-4 bg-gray-50 rounded-lg\">\n            <div className=\"flex items-center gap-2 flex-1 min-w-64\">\n              <Search className=\"w-4 h-4 text-gray-500\" />\n              <Input\n                placeholder=\"Search by tray ID or crop type...\"\n                value={searchTerm}\n                onChange={(e) => setSearchTerm(e.target.value)}\n                className=\"flex-1\"\n              />\n            </div>\n            <Select value={statusFilter} onValueChange={setStatusFilter}>\n              <SelectTrigger className=\"w-48\">\n                <SelectValue placeholder=\"Filter by status\" />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"all\">All Statuses</SelectItem>\n                <SelectItem value=\"seeded\">Seeded</SelectItem>\n                <SelectItem value=\"germinating\">Germinating</SelectItem>\n                <SelectItem value=\"growing\">Growing</SelectItem>\n                <SelectItem value=\"ready\">Ready</SelectItem>\n                <SelectItem value=\"split\">Split</SelectItem>\n                <SelectItem value=\"harvested\">Harvested</SelectItem>\n              </SelectContent>\n            </Select>\n            <Select value={cropFilter} onValueChange={setCropFilter}>\n              <SelectTrigger className=\"w-48\">\n                <SelectValue placeholder=\"Filter by crop type\" />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"all\">All Crops</SelectItem>\n                <SelectItem value=\"microgreens\">Microgreens</SelectItem>\n                <SelectItem value=\"leafyGreens\">Leafy Greens</SelectItem>\n              </SelectContent>\n            </Select>\n          </div>\n\n          {/* Tray Grid */}\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n            {filteredTrays.map((tray) => (\n              <Card key={tray.id} className=\"hover:shadow-md transition-shadow\">\n                <CardHeader className=\"pb-3\">\n                  <div className=\"flex items-center justify-between\">\n                    <CardTitle className=\"text-lg\">{tray.id}</CardTitle>\n                    <Badge className={getStatusColor(tray.status)}>\n                      {tray.status}\n                    </Badge>\n                  </div>\n                  <p className=\"text-sm text-gray-600\">{tray.cropType}</p>\n                  {tray.varieties && tray.varieties.length > 0 && (\n                    <div className=\"text-xs text-gray-500 mt-1\">\n                      üå± {tray.varieties.map(v => `${v.quantity} ${v.seedName}`).join(', ')}\n                    </div>\n                  )}\n                </CardHeader>\n                <CardContent className=\"space-y-3\">\n                  <div className=\"flex items-center gap-2 text-sm\">\n                    <span className=\"text-2xl\">{getSystemIcon(tray.currentLocation.systemType)}</span>\n                    <div>\n                      <p className=\"font-medium\">{tray.currentLocation.systemId}</p>\n                      <p className=\"text-gray-500\">{tray.currentLocation.systemType}</p>\n                    </div>\n                  </div>\n                  \n                  <div className=\"grid grid-cols-2 gap-2 text-sm\">\n                    <div>\n                      <p className=\"text-gray-500\">Plants</p>\n                      <p className=\"font-medium\">{renderPlantInfo(tray)}</p>\n                    </div>\n                    <div>\n                      <p className=\"text-gray-500\">Days in System</p>\n                      <p className=\"font-medium\">{getDaysInSystem(tray)}</p>\n                    </div>\n                    <div>\n                      <p className=\"text-gray-500\">Days to Harvest</p>\n                      <p className={`font-medium ${getDaysUntilHarvest(tray) <= 2 ? 'text-orange-600' : ''}`}>\n                        {getDaysUntilHarvest(tray)}\n                      </p>\n                    </div>\n                    <div>\n                      <p className=\"text-gray-500\">Created By</p>\n                      <p className=\"font-medium\">{tray.createdBy}</p>\n                    </div>\n                  </div>\n\n                  <div className=\"flex gap-2 pt-2\">\n                    <Dialog>\n                      <DialogTrigger asChild>\n                        <Button variant=\"outline\" size=\"sm\" className=\"flex-1\">\n                          View Details\n                        </Button>\n                      </DialogTrigger>\n                      <DialogContent className=\"max-w-2xl\">\n                        <DialogHeader>\n                          <DialogTitle>Tray Details: {tray.id}</DialogTitle>\n                        </DialogHeader>\n                        <div className=\"space-y-4\">\n                          <div className=\"grid grid-cols-2 gap-4\">\n                            <div>\n                              <p className=\"font-medium\">Crop Information</p>\n                              <p className=\"text-sm text-gray-600\">{tray.cropType}</p>\n                              <p className=\"text-sm text-gray-600\">{tray.cropCategory}</p>\n                              {tray.varieties && tray.varieties.length > 0 && (\n                                <div className=\"mt-2\">\n                                  <p className=\"text-sm font-medium text-green-800\">üå± Varieties:</p>\n                                  {tray.varieties.map((variety, idx) => (\n                                    <p key={idx} className=\"text-xs text-gray-600\">\n                                      ‚Ä¢ {variety.quantity} plants of {variety.seedName}\n                                      {variety.sku && ` (${variety.sku})`}\n                                    </p>\n                                  ))}\n                                </div>\n                              )}\n                            </div>\n                            <div>\n                              <p className=\"font-medium\">Timeline</p>\n                              <p className=\"text-sm text-gray-600\">\n                                Planted: {tray.datePlanted.toLocaleDateString()}\n                              </p>\n                              <p className=\"text-sm text-gray-600\">\n                                Expected Harvest: {tray.expectedHarvest.toLocaleDateString()}\n                              </p>\n                            </div>\n                          </div>\n                          \n                          <div>\n                            <p className=\"font-medium mb-2\">Location History</p>\n                            <div className=\"space-y-2 max-h-48 overflow-y-auto\">\n                              {tray.locationHistory.map((location, index) => (\n                                <div key={index} className=\"flex items-center gap-2 text-sm p-2 bg-gray-50 rounded\">\n                                  <span className=\"text-lg\">{getSystemIcon(location.systemType)}</span>\n                                  <div className=\"flex-1\">\n                                    <p className=\"font-medium\">{location.systemId}</p>\n                                    <p className=\"text-gray-500\">{location.reason}</p>\n                                  </div>\n                                  <div className=\"text-right\">\n                                    <p className=\"text-gray-500\">{location.movedDate.toLocaleDateString()}</p>\n                                    <p className=\"text-gray-500\">{location.movedBy}</p>\n                                  </div>\n                                </div>\n                              ))}\n                            </div>\n                          </div>\n                        </div>\n                      </DialogContent>\n                    </Dialog>\n                    \n                    {tray.cropCategory === 'leafyGreens' && tray.status === 'growing' && (\n                      <Button \n                        variant=\"outline\" \n                        size=\"sm\"\n                        onClick={() => {\n                          setSelectedTray(tray);\n                          setShowSplitModal(true);\n                        }}\n                      >\n                        <Split className=\"w-4 h-4\" />\n                      </Button>\n                    )}\n                  </div>\n                </CardContent>\n              </Card>\n            ))}\n          </div>\n        </TabsContent>\n\n        <TabsContent value=\"movements\" className=\"space-y-4\">\n          <Card>\n            <CardHeader>\n              <CardTitle>Pending Automatic Movements</CardTitle>\n              <p className=\"text-sm text-gray-600\">\n                System-triggered movements based on growth stages\n              </p>\n            </CardHeader>\n            <CardContent>\n              {movements.length === 0 ? (\n                <p className=\"text-center text-gray-500 py-8\">No pending movements</p>\n              ) : (\n                <div className=\"space-y-3\">\n                  {movements.map((movement) => (\n                    <div key={movement.id} className=\"flex items-center justify-between p-3 bg-yellow-50 rounded-lg\">\n                      <div className=\"flex items-center gap-3\">\n                        <ArrowRight className=\"w-5 h-5 text-yellow-600\" />\n                        <div>\n                          <p className=\"font-medium\">{movement.trayId}</p>\n                          <p className=\"text-sm text-gray-600\">{movement.reason}</p>\n                        </div>\n                      </div>\n                      <div className=\"flex items-center gap-2\">\n                        <Badge variant=\"outline\">\n                          {movement.fromSystem} ‚Üí {movement.toSystem}\n                        </Badge>\n                        <Button size=\"sm\" variant=\"outline\">\n                          Execute\n                        </Button>\n                      </div>\n                    </div>\n                  ))}\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        <TabsContent value=\"history\" className=\"space-y-4\">\n          <Card>\n            <CardHeader>\n              <CardTitle>Recent Location Changes</CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"space-y-3\">\n                {trays.flatMap(tray => \n                  tray.locationHistory.slice(-1).map(location => ({\n                    ...location,\n                    trayId: tray.id,\n                    cropType: tray.cropType\n                  }))\n                ).sort((a, b) => b.movedDate.getTime() - a.movedDate.getTime()).slice(0, 10).map((entry, index) => (\n                  <div key={index} className=\"flex items-center justify-between p-3 border rounded-lg\">\n                    <div className=\"flex items-center gap-3\">\n                      <span className=\"text-2xl\">{getSystemIcon(entry.systemType)}</span>\n                      <div>\n                        <p className=\"font-medium\">{entry.trayId}</p>\n                        <p className=\"text-sm text-gray-600\">{entry.cropType}</p>\n                      </div>\n                    </div>\n                    <div className=\"text-right\">\n                      <p className=\"font-medium\">{entry.systemId}</p>\n                      <p className=\"text-sm text-gray-600\">{entry.movedDate.toLocaleDateString()}</p>\n                      <p className=\"text-sm text-gray-500\">{entry.movedBy}</p>\n                    </div>\n                  </div>\n                ))}\n              </div>\n            </CardContent>\n          </Card>\n        </TabsContent>\n      </Tabs>\n\n      {/* Split Modal */}\n      {showSplitModal && selectedTray && (\n        <Dialog open={showSplitModal} onOpenChange={setShowSplitModal}>\n          <DialogContent className=\"max-w-4xl\">\n            <DialogHeader>\n              <DialogTitle>Split Tray</DialogTitle>\n            </DialogHeader>\n            <TraySplitInterface\n              tray={selectedTray}\n              systems={systems}\n              onSplit={handleSplitTray}\n              onCancel={() => setShowSplitModal(false)}\n            />\n          </DialogContent>\n        </Dialog>\n      )}\n    </div>\n  );\n};\n\nexport default TrayTracking;","path":null,"size_bytes":20212,"size_tokens":null},"client/src/components/Confetti.tsx":{"content":"import React from \"react\";\n\n// Confetti component that can be triggered programmatically\nconst Confetti: React.FC = () => {\n  React.useEffect(() => {\n    // Load confetti library from CDN\n    const script = document.createElement('script');\n    script.src = 'https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js';\n    script.async = true;\n    document.head.appendChild(script);\n\n    return () => {\n      document.head.removeChild(script);\n    };\n  }, []);\n\n  return null;\n};\n\nexport default Confetti;\n","path":null,"size_bytes":528,"size_tokens":null},"client/src/components/TaskCard.tsx":{"content":"import React from \"react\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { Clock, CheckCircle, Info, Users, AlertTriangle } from \"lucide-react\";\nimport { Task } from \"@shared/schema\";\nimport { TaskType, TaskStatus } from \"@/types\";\nimport { isMyTask } from \"../utils/taskHelpers\";\nimport { useCurrentUser } from \"../contexts/CurrentUserContext\";\nimport { StaffMember } from \"../services/staffService\";\nimport { getAssignmentDisplay } from \"../utils/taskAssignment\";\nimport { isTaskOverdue, getDaysOverdue, getOverdueSeverity, getDueDateDisplay, wasCompletedLate } from \"../utils/dateUtils\";\n\ninterface TaskCardProps {\n  task: Task;\n  onTaskAction: (taskId: number, action: 'start' | 'collaborate' | 'complete' | 'pause' | 'skip' | 'view' | 'resume') => void;\n  onEditTemplate?: (taskId: number) => void;\n  staff?: StaffMember[];\n}\n\nconst TaskCard: React.FC<TaskCardProps> = ({ task, onTaskAction, onEditTemplate, staff = [] }) => {\n  const { currentUser } = useCurrentUser();\n  // Safety check for task object\n  if (!task) {\n    return (\n      <Card className=\"task-card relative shadow-sm border-red-200\">\n        <CardContent className=\"p-6\">\n          <div className=\"text-red-600\">Error: Task data is missing</div>\n        </CardContent>\n      </Card>\n    );\n  }\n  const getTaskEmoji = (type: string): string => {\n    const emojis: Record<string, string> = {\n      \"seeding-microgreens\": \"üå±\",\n      \"seeding-leafy-greens\": \"üåø\", \n      \"harvest-microgreens\": \"üåæ\",\n      \"harvest-leafy-greens\": \"ü•¨\",\n      \"blackout-tasks\": \"üåë\",\n      \"moving\": \"üì¶\",\n      \"packing\": \"üì¶\",\n      \"cleaning\": \"üßπ\",\n      \"inventory\": \"üìä\",\n      \"equipment-maintenance\": \"üîß\",\n      \"other\": \"üìù\"\n    };\n    return emojis[type] || \"üìã\";\n  };\n\n  const formatTime = (minutes: number | null | undefined): string => {\n    if (!minutes || minutes <= 0) return '0m';\n    const hours = Math.floor(minutes / 60);\n    const mins = minutes % 60;\n    if (hours > 0) {\n      return `${hours}h ${mins}m`;\n    }\n    return `${mins}m`;\n  };\n\n  // FIXED: Get day abbreviation using UTC to avoid timezone issues\n  const getDayAbbreviation = (dateString: string): string => {\n    // Parse YYYY-MM-DD format directly to avoid timezone conversion\n    const [year, month, day] = dateString.split('T')[0].split('-').map(Number);\n    const date = new Date(Date.UTC(year, month - 1, day, 12, 0, 0)); // Use UTC with noon\n    \n    const days = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];\n    return days[date.getUTCDay()]; // Use getUTCDay() instead of getDay()\n  };\n\n  const getFrequencyLabel = (frequency: string): string => {\n    switch (frequency) {\n      case 'daily':\n        return 'DAILY';\n      case 'weekly':\n        return 'WEEKLY';\n      case 'biweekly':\n      case 'bi-weekly':\n        return 'BI-WEEKLY';\n      case 'monthly': \n        return 'MONTHLY';\n      case 'quarterly':\n        return 'QUARTERLY';\n      default:\n        return frequency ? frequency.toUpperCase() : '';\n    }\n  };\n\n  const getTaskDayDisplay = (task: Task) => {\n    // Safety check for task object\n    if (!task) {\n      return { text: 'NO DATA', color: '#6b7280' }; // Gray\n    }\n    \n    // For recurring tasks OR tasks with recurring frequencies, show frequency with day\n    // FIXED: Weekly tasks generated from recurring templates should show RECURRING ribbon\n    const isRecurringTask = task.isRecurring || (task.frequency && ['daily', 'weekly', 'biweekly', 'bi-weekly', 'monthly', 'quarterly'].includes(task.frequency));\n    \n    if (isRecurringTask && task.frequency) {\n      const frequencyLabel = getFrequencyLabel(task.frequency);\n      \n      if (!task.dueDate) {\n        return { \n          text: frequencyLabel, \n          color: task.frequency === 'daily' ? '#059669' : // Green\n                 task.frequency === 'weekly' ? '#059669' : // Green  \n                 task.frequency === 'biweekly' || task.frequency === 'bi-weekly' ? '#0891b2' : // Cyan\n                 task.frequency === 'monthly' ? '#7c3aed' : // Purple\n                 task.frequency === 'quarterly' ? '#ea580c' : // Orange\n                 '#6b7280' // Gray\n        };\n      }\n      \n      try {\n        // TIMEZONE FIX: Always use taskDate when available (shows actual assignment day), fallback to dueDate\n        const dateToUse = task.taskDate ? \n          (typeof task.taskDate === 'string' ? task.taskDate : task.taskDate?.toISOString() || '') :\n          (typeof task.dueDate === 'string' ? task.dueDate : task.dueDate?.toISOString() || '');\n        const dayName = getDayAbbreviation(dateToUse);\n        return { \n          text: `${frequencyLabel} ‚Ä¢ ${dayName}`,\n          color: task.frequency === 'daily' ? '#059669' : // Green\n                 task.frequency === 'weekly' ? '#059669' : // Green\n                 task.frequency === 'biweekly' || task.frequency === 'bi-weekly' ? '#0891b2' : // Cyan  \n                 task.frequency === 'monthly' ? '#7c3aed' : // Purple\n                 task.frequency === 'quarterly' ? '#ea580c' : // Orange\n                 '#6b7280' // Gray\n        };\n      } catch (error) {\n        return { text: frequencyLabel, color: '#ef4444' }; // Red\n      }\n    }\n    \n    // For one-time tasks, show the day only\n    if (!task.dueDate) {\n      return { text: 'NO DATE', color: '#6b7280' }; // Gray\n    }\n    \n    try {\n      // TIMEZONE FIX: Use taskDate for better accuracy if available, fallback to dueDate\n      const dateToUse = task.taskDate ? \n        (typeof task.taskDate === 'string' ? task.taskDate : task.taskDate?.toISOString() || '') :\n        (typeof task.dueDate === 'string' ? task.dueDate : task.dueDate?.toISOString() || '');\n      const dayName = getDayAbbreviation(dateToUse);\n      return { text: dayName, color: '#059669' }; // Green\n    } catch (error) {\n      return { text: 'INVALID DATE', color: '#ef4444' }; // Red\n    }\n  };\n\n  const formatDueDate = (dateInput: string | Date | null): string => {\n    if (!dateInput) return '';\n    \n    let dateString: string;\n    \n    // Handle both Date objects and strings\n    if (dateInput instanceof Date) {\n      // Convert Date to YYYY-MM-DD format without timezone issues\n      const year = dateInput.getFullYear();\n      const month = String(dateInput.getMonth() + 1).padStart(2, '0');\n      const day = String(dateInput.getDate()).padStart(2, '0');\n      dateString = `${year}-${month}-${day}`;\n    } else {\n      // Handle ISO string format by extracting date part\n      dateString = dateInput.split('T')[0];\n    }\n    \n    // Parse the date string without timezone conversion\n    const [year, month, day] = dateString.split('-');\n    \n    // Create month names array\n    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', \n                    'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];\n    \n    // Return formatted date (e.g., \"Jan 18, 2025\")\n    return `${months[parseInt(month) - 1]} ${parseInt(day)}, ${year}`;\n  };\n\n  const isCompleted = task.status === 'completed' || task.status === 'approved';\n  const isInProgress = task.status === 'in_progress';\n  const isPending = task.status === 'pending' || !task.status; // Include tasks with no status\n  const isPaused = task.status === 'paused';\n  const isSkipped = task.status === 'skipped';\n  \n  // Use new overdue utility functions\n  const isCurrentlyOverdue = isTaskOverdue(task);\n  const daysOverdue = getDaysOverdue(task);\n  const overdueSeverity = getOverdueSeverity(task);\n  const dueDateDisplayText = getDueDateDisplay(task);\n  const isCompletedLate = wasCompletedLate(task);\n  const dayDisplay = getTaskDayDisplay(task);\n\n  // Check if task is assigned to current user\n  const assignedToMe = isMyTask(task, currentUser);\n\n  // Build overdue class based on severity\n  const getOverdueClass = (): string => {\n    if (!isCurrentlyOverdue) return '';\n    switch (overdueSeverity) {\n      case 'critical': return 'task-overdue task-critical-overdue';\n      case 'warning': return 'task-overdue task-warning-overdue';\n      case 'mild': return 'task-overdue task-mild-overdue';\n      default: return 'task-overdue';\n    }\n  };\n\n  return (\n    <Card className={`task-card relative shadow-sm hover:shadow-md transition-shadow ${\n      assignedToMe ? 'assigned-to-me' : ''\n    } ${\n      isInProgress ? 'bg-blue-50 border-l-4 border-l-blue-500' : ''\n    } ${isCompleted ? 'opacity-75' : ''} ${\n      isPaused ? 'bg-yellow-50 border-l-4 border-l-yellow-500' : ''\n    } ${\n      isSkipped ? 'bg-gray-50 border-l-4 border-l-gray-500' : ''\n    } ${\n      getOverdueClass()\n    }`} data-status={task.status} data-overdue={isCurrentlyOverdue ? daysOverdue : undefined}>\n      <CardContent className=\"p-6\">\n        {/* Badge Container - Modular system handles 2-4 badges flexibly */}\n        <div className=\"flex flex-wrap items-center gap-1 mb-3\">\n          {/* RECURRING Badge - For recurring tasks OR tasks with recurring frequencies */}\n          {(task.recurringTaskId || (task.frequency && ['daily', 'weekly', 'biweekly', 'bi-weekly', 'monthly', 'quarterly'].includes(task.frequency))) && (\n            <span className=\"inline-flex px-2 py-1 rounded text-xs font-bold uppercase bg-blue-600 text-white\">\n              RECURRING\n            </span>\n          )}\n          \n          {/* Day Badge - Frequency-aware day display */}\n          <span className=\"inline-flex px-2 py-1 rounded text-xs font-bold uppercase bg-teal-500 text-white\">\n            {(() => {\n              // Use frequency-aware logic: taskDate for weekly/daily, dueDate for others\n              if (task.frequency && ['daily', 'weekly'].includes(task.frequency) && task.taskDate) {\n                const dateStr = typeof task.taskDate === 'string' ? task.taskDate : task.taskDate.toISOString();\n                return getDayAbbreviation(dateStr);\n              } else if (task.dueDate) {\n                const dateStr = typeof task.dueDate === 'string' ? task.dueDate : task.dueDate.toISOString();\n                return getDayAbbreviation(dateStr);\n              } else if (task.taskDate) {\n                const dateStr = typeof task.taskDate === 'string' ? task.taskDate : task.taskDate.toISOString();\n                return getDayAbbreviation(dateStr);\n              } else {\n                return 'NO DATE';\n              }\n            })()}\n          </span>\n          \n          {/* Priority Badge - Show when priority exists */}\n          {task.priority && (\n            <span className={`inline-flex px-2 py-1 rounded text-xs font-bold uppercase text-white\n              ${task.priority === 'high' ? 'bg-red-500' : \n                task.priority === 'medium' ? 'bg-yellow-500' : \n                'bg-green-500'}\n            `}>\n              {task.priority}\n            </span>\n          )}\n          \n          {/* Frequency Badge - For recurring tasks OR tasks with recurring frequencies */}\n          {(task.recurringTaskId || (task.frequency && ['daily', 'weekly', 'biweekly', 'bi-weekly', 'monthly', 'quarterly'].includes(task.frequency))) && task.frequency && (\n            <span className={`inline-flex px-2 py-1 rounded text-xs font-bold uppercase text-white\n              ${task.frequency === 'daily' ? 'bg-green-600' : \n                task.frequency === 'weekly' ? 'bg-green-600' :\n                task.frequency === 'biweekly' || task.frequency === 'bi-weekly' ? 'bg-cyan-600' : \n                task.frequency === 'monthly' ? 'bg-purple-600' : \n                task.frequency === 'quarterly' ? 'bg-orange-600' : \n                'bg-gray-600'}\n            `}>\n              {task.frequency === 'daily' ? 'DAILY' :\n               task.frequency === 'weekly' ? 'WEEKLY' :\n               task.frequency === 'biweekly' || task.frequency === 'bi-weekly' ? 'BI-WK' :\n               task.frequency === 'monthly' ? 'MONTHLY' :\n               task.frequency === 'quarterly' ? 'QTLY' : \n               'CUSTOM'}\n            </span>\n          )}\n          \n          {/* Your Task indicator (only when assigned) */}\n          {assignedToMe && (\n            <span className=\"inline-flex px-2 py-1 rounded text-xs font-bold bg-green-100 text-green-800\">\n              üìå YOUR TASK\n            </span>\n          )}\n        </div>\n        \n        {/* Title Section */}\n        <div className=\"task-header mb-4\">\n          <h3 className=\"task-title text-lg font-semibold text-gray-800 mb-2\">\n            {getTaskEmoji(task.type || 'other')} {task.title || 'Untitled Task'}\n          </h3>\n          \n          {/* Task type */}\n          <p className=\"text-sm text-gray-600 mb-2\">\n            {task.type ? task.type.replace(/[-_]/g, ' ').replace(/\\b\\w/g, l => l.toUpperCase()) : 'Unknown Type'}\n          </p>\n        </div>\n        \n        {/* Task Details - clean single display */}\n        <div className=\"task-details mb-4\">\n          {/* Overdue warning with severity badge */}\n          {isCurrentlyOverdue && !isCompleted && (\n            <div className=\"flex items-center gap-2 mb-2\">\n              <span className={`overdue-badge ${overdueSeverity}`} data-testid=\"overdue-badge\">\n                <AlertTriangle className=\"h-3 w-3\" />\n                {daysOverdue === 1 ? '1 DAY OVERDUE' : `${daysOverdue} DAYS OVERDUE`}\n              </span>\n            </div>\n          )}\n          \n          {/* Completed late indicator */}\n          {isCompleted && isCompletedLate && (\n            <div className=\"flex items-center gap-2 mb-2\">\n              <span className=\"completed-late-badge\" data-testid=\"completed-late-badge\">\n                ‚è∞ Completed Late\n              </span>\n            </div>\n          )}\n          \n          {/* Single task info row - due date and assignment */}\n          <div className=\"task-info-row flex flex-wrap gap-4 text-sm text-gray-600 mb-2\">\n            {/* Due date with relative display */}\n            {task.dueDate && (\n              <span className={`due-date ${isCurrentlyOverdue ? 'text-red-600 font-medium' : ''}`} data-testid=\"due-date-display\">\n                üìÖ {dueDateDisplayText}\n              </span>\n            )}\n            \n            {/* Time estimate */}\n            {task.estimatedTime && (\n              <span className=\"time-estimate\">\n                ‚è±Ô∏è {formatTime(task.estimatedTime)}\n              </span>\n            )}\n          </div>\n          \n          {/* Assignment information - simplified */}\n          <div className=\"assignment-info text-sm text-gray-600 mb-1 flex items-center\">\n            <Users className=\"h-4 w-4 mr-1\" />\n            <span>{getAssignmentDisplay(task.assignTo || task.assignedTo)}</span>\n          </div>\n        </div>\n\n        {/* Progress Bar (for in-progress tasks) */}\n        {isInProgress && (\n          <div className=\"mb-4\">\n            <div className=\"flex justify-between items-center mb-2\">\n              <span className=\"text-sm text-gray-600\">Progress</span>\n              <span className=\"text-sm font-medium text-[#203B17]\">\n                {task.progress}%\n              </span>\n            </div>\n            <Progress value={task.progress} className=\"h-2\" />\n          </div>\n        )}\n\n        {/* Checklist info if available */}\n        {task.checklist && task.checklist.length > 0 && (\n          <div className=\"text-sm text-gray-600 mb-3\">\n            <div className=\"flex items-center\">\n              <CheckCircle className=\"h-4 w-4 mr-1\" />\n              <span>\n                {(() => {\n                  // Use the actual progress data from ChecklistExecution if available\n                  if (task.data?.checklistProgress) {\n                    const completedSteps = Object.values(task.data.checklistProgress).filter(\n                      (step: any) => step.completed === true\n                    ).length;\n                    return `‚úì ${completedSteps}/${task.checklist.length} checklist items`;\n                  }\n                  \n                  // Fallback to checking individual item completion status\n                  const completedFromItems = task.checklist.filter(item => \n                    item.completed === true\n                  ).length;\n                  return `‚úì ${completedFromItems}/${task.checklist.length} checklist items`;\n                })()}\n              </span>\n            </div>\n          </div>\n        )}\n\n        {/* Description if available */}\n        {task.description && (\n          <div className=\"text-sm text-gray-600 mb-3\">\n            <div className=\"flex items-center\">\n              <Info className=\"h-4 w-4 mr-1\" />\n              <span>{task.description}</span>\n            </div>\n          </div>\n        )}\n\n        {/* Task Status Info - Shows only completion/skip status, not duplicate due dates */}\n        {(task.status === 'completed' || task.status === 'skipped') && (\n          <div className=\"task-status-info text-xs text-gray-500 mb-3 text-center bg-gray-50 rounded p-2\">\n            {(() => {\n              if (task.status === 'completed' && task.completedAt) {\n                const completedDate = new Date(task.completedAt);\n                return `‚úÖ Completed ${completedDate.toLocaleDateString()}`;\n              }\n              \n              if (task.status === 'skipped' && task.skippedAt) {\n                const skippedDate = new Date(task.skippedAt);\n                return `‚è≠Ô∏è Skipped ${skippedDate.toLocaleDateString()}`;\n              }\n              \n              return '';\n            })()}\n          </div>\n        )}\n\n        {/* Action button - centered */}\n        <div className=\"task-actions flex justify-center mt-4\">\n          {/* TYPE SAFETY: Prevent instance-only actions from appearing on recurring task templates */}\n          {task.isTemplate ? (\n            /* Template actions - for recurring task templates only */\n            <Button \n              onClick={() => onEditTemplate?.(task.id)}\n              variant=\"outline\"\n              className=\"btn-action px-6 py-2 rounded-md font-medium border-blue-500 text-blue-600 hover:bg-blue-50\"\n              data-testid=\"button-edit-template\"\n            >\n              üìù Edit Template\n            </Button>\n          ) : (\n            /* Instance actions - for regular task instances only */\n            <>\n              {isPending && (\n                <Button \n                  onClick={() => onTaskAction(task.id, 'start')}\n                  className=\"btn-action bg-[#2D8028] hover:bg-[#236020] text-white px-6 py-2 rounded-md font-medium\"\n                  data-testid=\"button-start-task\"\n                >\n                  Start Task\n                </Button>\n              )}\n              {isInProgress && (\n                <Button \n                  onClick={() => onTaskAction(task.id, 'collaborate')}\n                  className=\"btn-action bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-md font-medium\"\n                  data-testid=\"button-continue-task\"\n                >\n                  üë• Collaborate/Continue\n                </Button>\n              )}\n              {isPaused && (\n                <Button \n                  onClick={() => onTaskAction(task.id, 'resume')}\n                  className=\"btn-action bg-yellow-600 hover:bg-yellow-700 text-white px-6 py-2 rounded-md font-medium\"\n                  data-testid=\"button-resume-task\"\n                >\n                  Resume Task\n                </Button>\n              )}\n              {(isCompleted || isSkipped) && (\n                <Button \n                  onClick={() => onTaskAction(task.id, 'view')}\n                  variant=\"outline\"\n                  className=\"btn-action px-6 py-2 rounded-md font-medium\"\n                  data-testid=\"button-view-details\"\n                >\n                  View Details\n                </Button>\n              )}\n              {/* Fallback for tasks that don't match any status */}\n              {!isPending && !isInProgress && !isPaused && !isCompleted && !isSkipped && (\n                <Button \n                  onClick={() => onTaskAction(task.id, 'start')}\n                  className=\"btn-action bg-[#2D8028] hover:bg-[#236020] text-white px-6 py-2 rounded-md font-medium\"\n                  data-testid=\"button-start-task-fallback\"\n                >\n                  Start Task\n                </Button>\n              )}\n            </>\n          )}\n        </div>\n      </CardContent>\n    </Card>\n  );\n};\n\nexport default TaskCard;","path":null,"size_bytes":20439,"size_tokens":null},"client/src/components/CourseAssignmentModal.tsx":{"content":"import React, { useState } from \"react\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from \"@/components/ui/dialog\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { Search, Target, Calendar, AlertCircle, Users } from \"lucide-react\";\nimport { User } from \"@shared/schema\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest } from \"@/lib/queryClient\";\n\ninterface Course {\n  id: number;\n  title: string;\n  description: string;\n  roleAwarded: string;\n  sections: number;\n  estimatedTime: string;\n  icon: string;\n}\n\ninterface CourseAssignmentModalProps {\n  isOpen: boolean;\n  onClose: () => void;\n  course: Course | null;\n  assignedBy: User;\n}\n\nconst CourseAssignmentModal: React.FC<CourseAssignmentModalProps> = ({\n  isOpen,\n  onClose,\n  course,\n  assignedBy\n}) => {\n  const [searchTerm, setSearchTerm] = useState(\"\");\n  const [selectedUsers, setSelectedUsers] = useState<number[]>([]);\n  const [dueDate, setDueDate] = useState(\"\");\n  const [priority, setPriority] = useState<'low' | 'normal' | 'high'>('normal');\n  const [notes, setNotes] = useState(\"\");\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n\n  const { data: users = [] } = useQuery<User[]>({\n    queryKey: ['/api/users'],\n    enabled: isOpen\n  });\n\n  const assignCourseMutation = useMutation({\n    mutationFn: async (assignmentData: any) => {\n      return apiRequest('POST', '/api/course-assignments', assignmentData);\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Course Assigned\",\n        description: `Successfully assigned \"${course?.title}\" to ${selectedUsers.length} user(s)`,\n      });\n      queryClient.invalidateQueries({ queryKey: ['/api/course-assignments'] });\n      handleClose();\n    },\n    onError: () => {\n      toast({\n        title: \"Assignment Failed\",\n        description: \"Could not assign course. Please try again.\",\n        variant: \"destructive\",\n      });\n    }\n  });\n\n  const filteredUsers = users.filter(user =>\n    user.name.toLowerCase().includes(searchTerm.toLowerCase()) ||\n    user.username.toLowerCase().includes(searchTerm.toLowerCase())\n  );\n\n  const handleUserToggle = (userId: number) => {\n    setSelectedUsers(prev =>\n      prev.includes(userId)\n        ? prev.filter(id => id !== userId)\n        : [...prev, userId]\n    );\n  };\n\n  const handleSelectAll = () => {\n    if (selectedUsers.length === filteredUsers.length) {\n      setSelectedUsers([]);\n    } else {\n      setSelectedUsers(filteredUsers.map(user => user.id));\n    }\n  };\n\n  const handleAssign = () => {\n    if (!course || selectedUsers.length === 0) return;\n\n    const assignments = selectedUsers.map(userId => ({\n      courseId: course.id,\n      assignedToUserId: userId,\n      assignedByUserId: assignedBy.id,\n      dueDate: dueDate || null,\n      priority,\n      notes: notes || null\n    }));\n\n    console.log(\"Creating assignments:\", assignments);\n\n    // Create all assignments\n    Promise.all(\n      assignments.map(assignment =>\n        apiRequest('POST', '/api/course-assignments', assignment)\n      )\n    ).then(() => {\n      toast({\n        title: \"Course Assigned\",\n        description: `Successfully assigned \"${course.title}\" to ${selectedUsers.length} user(s)`,\n      });\n      queryClient.invalidateQueries({ queryKey: ['/api/course-assignments'] });\n      handleClose();\n    }).catch((error) => {\n      console.error(\"Assignment error:\", error);\n      toast({\n        title: \"Assignment Failed\",\n        description: \"Could not assign course. Please try again.\",\n        variant: \"destructive\",\n      });\n    });\n  };\n\n  const handleClose = () => {\n    setSearchTerm(\"\");\n    setSelectedUsers([]);\n    setDueDate(\"\");\n    setPriority('normal');\n    setNotes(\"\");\n    onClose();\n  };\n\n  if (!course) return null;\n\n  return (\n    <Dialog open={isOpen} onOpenChange={handleClose}>\n      <DialogContent className=\"max-w-md\">\n        <DialogHeader>\n          <DialogTitle className=\"flex items-center gap-2\">\n            <Target className=\"h-5 w-5 text-green-600\" />\n            Assign Course\n          </DialogTitle>\n        </DialogHeader>\n\n        <div className=\"space-y-4\">\n          {/* Course Info */}\n          <div className=\"p-3 bg-gray-50 rounded-lg\">\n            <div className=\"flex items-center gap-2 mb-1\">\n              <span className=\"text-lg\">{course.icon}</span>\n              <h4 className=\"font-medium text-gray-900\">{course.title}</h4>\n            </div>\n            <p className=\"text-sm text-gray-600\">{course.estimatedTime} ‚Ä¢ {course.sections} sections</p>\n          </div>\n\n          {/* User Search */}\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"user-search\">Select Users</Label>\n            <div className=\"relative\">\n              <Search className=\"absolute left-3 top-3 h-4 w-4 text-gray-400\" />\n              <Input\n                id=\"user-search\"\n                type=\"text\"\n                placeholder=\"Search users...\"\n                value={searchTerm}\n                onChange={(e) => setSearchTerm(e.target.value)}\n                className=\"pl-10\"\n              />\n            </div>\n          </div>\n\n          {/* Select All Checkbox */}\n          <div className=\"flex items-center space-x-2\">\n            <Checkbox\n              id=\"select-all\"\n              checked={selectedUsers.length === filteredUsers.length && filteredUsers.length > 0}\n              onCheckedChange={handleSelectAll}\n            />\n            <Label htmlFor=\"select-all\" className=\"text-sm font-medium\">\n              Select All ({filteredUsers.length} users)\n            </Label>\n          </div>\n\n          {/* User List */}\n          <div className=\"max-h-48 overflow-y-auto border rounded-lg\">\n            {filteredUsers.length === 0 ? (\n              <div className=\"p-4 text-center text-gray-500\">\n                <Users className=\"h-8 w-8 mx-auto mb-2 text-gray-400\" />\n                No users found\n              </div>\n            ) : (\n              <div className=\"p-2 space-y-1\">\n                {filteredUsers.map(user => (\n                  <div key={user.id} className=\"flex items-center space-x-2 p-2 hover:bg-gray-50 rounded\">\n                    <Checkbox\n                      id={`user-${user.id}`}\n                      checked={selectedUsers.includes(user.id)}\n                      onCheckedChange={() => handleUserToggle(user.id)}\n                    />\n                    <Label htmlFor={`user-${user.id}`} className=\"flex-1 cursor-pointer\">\n                      <div className=\"flex items-center justify-between\">\n                        <span className=\"font-medium\">{user.name}</span>\n                        <span className=\"text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded\">\n                          {user.role}\n                        </span>\n                      </div>\n                    </Label>\n                  </div>\n                ))}\n              </div>\n            )}\n          </div>\n\n          {/* Assignment Options */}\n          <div className=\"grid grid-cols-2 gap-3\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"due-date\">Due Date (Optional)</Label>\n              <div className=\"relative\">\n                <Calendar className=\"absolute left-3 top-3 h-4 w-4 text-gray-400\" />\n                <Input\n                  id=\"due-date\"\n                  type=\"date\"\n                  value={dueDate}\n                  onChange={(e) => setDueDate(e.target.value)}\n                  className=\"pl-10\"\n                />\n              </div>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"priority\">Priority</Label>\n              <Select value={priority} onValueChange={(value: 'low' | 'normal' | 'high') => setPriority(value)}>\n                <SelectTrigger>\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"low\">Low</SelectItem>\n                  <SelectItem value=\"normal\">Normal</SelectItem>\n                  <SelectItem value=\"high\">High</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n          </div>\n\n          {/* Notes */}\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"notes\">Notes (Optional)</Label>\n            <Textarea\n              id=\"notes\"\n              placeholder=\"Add assignment notes or instructions...\"\n              value={notes}\n              onChange={(e) => setNotes(e.target.value)}\n              rows={3}\n            />\n          </div>\n\n          {/* Selected Count */}\n          {selectedUsers.length > 0 && (\n            <div className=\"flex items-center gap-2 p-3 bg-green-50 border border-green-200 rounded-lg\">\n              <AlertCircle className=\"h-4 w-4 text-green-600\" />\n              <span className=\"text-sm text-green-800\">\n                {selectedUsers.length} user(s) selected for assignment\n              </span>\n            </div>\n          )}\n        </div>\n\n        <DialogFooter>\n          <Button variant=\"outline\" onClick={handleClose}>\n            Cancel\n          </Button>\n          <Button\n            onClick={handleAssign}\n            disabled={selectedUsers.length === 0 || assignCourseMutation.isPending}\n            className=\"bg-green-600 hover:bg-green-700\"\n          >\n            {assignCourseMutation.isPending ? \"Assigning...\" : `Assign to ${selectedUsers.length} User(s)`}\n          </Button>\n        </DialogFooter>\n      </DialogContent>\n    </Dialog>\n  );\n};\n\nexport default CourseAssignmentModal;","path":null,"size_bytes":9928,"size_tokens":null},"client/src/index.css":{"content":"@tailwind base;\n@tailwind components;\n@tailwind utilities;\n\n/* CRITICAL: Green border must appear on ALL assigned tasks at ALL times */\n.task-card.assigned-to-me {\n  border-left: 6px solid #2D8028 !important;\n  border-color: #2D8028 !important;\n  box-shadow: -2px 0 0 #2D8028 inset !important;\n}\n\n/* Hover effect for assigned tasks */\n.task-card.assigned-to-me:hover {\n  box-shadow: 0 4px 8px rgba(45, 128, 40, 0.15) !important;\n  border-left-color: #236622 !important;\n}\n\n/* Task badges row layout */\n.task-badges-row {\n  min-height: 28px; /* Ensure consistent height */\n}\n\n.left-badges {\n  display: flex;\n  gap: 8px;\n  align-items: center;\n}\n\n.your-task-badge {\n  background: #2D8028;\n  color: white;\n  padding: 4px 10px;\n  border-radius: 12px;\n  font-size: 11px;\n  font-weight: 600;\n  flex-shrink: 0;\n  white-space: nowrap;\n}\n\n.task-badges-row {\n  display: flex;\n  justify-content: space-between;\n  margin-bottom: 12px;\n}\n\n.right-badges {\n  display: flex;\n  gap: 4px;\n}\n\n/* Badge styling improvements */\n.day-badge, .priority-badge {\n  font-family: system-ui, -apple-system, sans-serif;\n  letter-spacing: 0.025em;\n  min-width: 60px;\n  text-align: center;\n}\n\n/* Mobile responsive adjustments */\n@media (max-width: 640px) {\n  .your-task-badge {\n    font-size: 10px;\n    padding: 2px 6px;\n  }\n  \n  .left-badges {\n    gap: 4px;\n  }\n  \n  .day-badge, .priority-badge {\n    min-width: 50px;\n    font-size: 10px;\n    padding: 2px 6px;\n  }\n  \n  .task-card.assigned-to-me {\n    border-left-width: 3px !important;\n  }\n}\n\n/* Mobile Task Modal Improvements */\n@media (max-width: 480px) {\n  /* Prevent horizontal scrolling in modals */\n  [role=\"dialog\"] {\n    max-width: 100vw !important;\n    overflow-x: hidden !important;\n  }\n  \n  [role=\"dialog\"] * {\n    max-width: 100%;\n    box-sizing: border-box;\n  }\n  \n  /* Better touch targets for buttons */\n  [role=\"dialog\"] button {\n    min-height: 44px;\n    font-size: 14px;\n  }\n  \n  /* Prevent iOS zoom on input focus */\n  [role=\"dialog\"] input,\n  [role=\"dialog\"] textarea,\n  [role=\"dialog\"] select {\n    font-size: 16px;\n  }\n  \n  /* Checklist items wrap properly */\n  .checklist-step {\n    word-wrap: break-word;\n    overflow-wrap: break-word;\n  }\n}\n\n/* Enhanced Task Card States */\n.task-card.completed {\n  opacity: 0.8;\n  background: linear-gradient(to right, rgba(34, 197, 94, 0.05) 0%, transparent 100%) !important;\n}\n\n.task-card.skipped {\n  opacity: 0.7;\n  background: linear-gradient(to right, rgba(245, 158, 11, 0.05) 0%, transparent 100%) !important;\n}\n\n/* ========================================\n   OVERDUE TASK STYLING SYSTEM\n   ======================================== */\n\n/* Base overdue styling - border indicator */\n.task-card.task-overdue {\n  border-left: 4px solid #FFA500 !important;\n}\n\n/* Mild overdue (1-2 days) - Light yellow background */\n.task-card.task-mild-overdue {\n  background-color: #FFF9E6 !important;\n  border-left-color: #FFC107 !important;\n}\n\n/* Warning overdue (3-6 days) - Light orange background */\n.task-card.task-warning-overdue {\n  background-color: #FFF0E0 !important;\n  border-left-color: #FF6B00 !important;\n}\n\n/* Critical overdue (7+ days) - Light red background */\n.task-card.task-critical-overdue {\n  background-color: #FFE6E6 !important;\n  border-left-color: #DC143C !important;\n}\n\n/* Overdue badge styles */\n.overdue-badge {\n  display: inline-flex;\n  align-items: center;\n  gap: 4px;\n  padding: 2px 8px;\n  border-radius: 12px;\n  font-size: 11px;\n  font-weight: 600;\n  white-space: nowrap;\n}\n\n.overdue-badge.mild {\n  background-color: #FFC107;\n  color: #000;\n}\n\n.overdue-badge.warning {\n  background-color: #FF6B00;\n  color: #FFF;\n}\n\n.overdue-badge.critical {\n  background-color: #DC143C;\n  color: #FFF;\n  animation: pulse-critical 2s ease-in-out infinite;\n}\n\n@keyframes pulse-critical {\n  0%, 100% { opacity: 1; }\n  50% { opacity: 0.8; }\n}\n\n/* Completed Late badge */\n.completed-late-badge {\n  display: inline-flex;\n  align-items: center;\n  gap: 4px;\n  padding: 2px 8px;\n  border-radius: 12px;\n  font-size: 11px;\n  font-weight: 600;\n  background-color: #FEF3C7;\n  color: #92400E;\n}\n\n/* Overdue Summary Section */\n.overdue-summary {\n  background: linear-gradient(135deg, #FFF5F5 0%, #FED7D7 100%);\n  border: 1px solid #FC8181;\n  border-radius: 12px;\n  padding: 16px;\n  margin-bottom: 16px;\n}\n\n.overdue-summary h3 {\n  font-weight: 600;\n  color: #C53030;\n  margin-bottom: 8px;\n  display: flex;\n  align-items: center;\n  gap: 8px;\n}\n\n.overdue-summary .overdue-counts {\n  display: flex;\n  flex-wrap: wrap;\n  gap: 12px;\n}\n\n.overdue-summary .count-item {\n  display: flex;\n  align-items: center;\n  gap: 6px;\n  font-size: 14px;\n}\n\n.overdue-summary .count-item.critical {\n  color: #DC143C;\n  font-weight: 600;\n}\n\n.overdue-summary .count-item.warning {\n  color: #FF6B00;\n  font-weight: 500;\n}\n\n.overdue-summary .count-item.mild {\n  color: #B45309;\n}\n\n/* Gamified Progress Container */\n.gamified-progress-container {\n  background: white;\n  border-radius: 12px;\n  padding: 20px;\n  margin-bottom: 24px;\n  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);\n  position: relative;\n  overflow: hidden;\n}\n\n/* Affirmation Message */\n.affirmation-message {\n  text-align: center;\n  font-size: 18px;\n  font-weight: 600;\n  color: #1f2937;\n  margin-bottom: 20px;\n  animation: fadeIn 0.5s ease-in;\n}\n\n@keyframes fadeIn {\n  from { opacity: 0; transform: translateY(-5px); }\n  to { opacity: 1; transform: translateY(0); }\n}\n\n/* Progress Bars Wrapper */\n.progress-bars-wrapper {\n  display: flex;\n  flex-direction: column;\n  gap: 20px;\n  margin-bottom: 16px;\n}\n\n/* Progress Bar Container */\n.progress-bar-container {\n  position: relative;\n}\n\n.progress-label {\n  display: flex;\n  justify-content: space-between;\n  align-items: center;\n  margin-bottom: 8px;\n  font-size: 14px;\n  font-weight: 500;\n  color: #4b5563;\n}\n\n.progress-count, .progress-text {\n  font-size: 12px;\n  color: #6b7280;\n}\n\n/* Progress Bar */\n.progress-bar {\n  height: 32px;\n  background: #f3f4f6;\n  border-radius: 16px;\n  overflow: hidden;\n  display: flex;\n  position: relative;\n  box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.06);\n}\n\n.progress-bar-empty {\n  height: 32px;\n  background: #f3f4f6;\n  border-radius: 16px;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  color: #9ca3af;\n  font-size: 14px;\n}\n\n.empty-message {\n  font-size: 14px;\n  color: #10b981;\n}\n\n/* Progress Segments */\n.progress-segment {\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  color: white;\n  font-size: 12px;\n  font-weight: 600;\n  transition: all 0.3s ease;\n  position: relative;\n}\n\n.progress-segment span {\n  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);\n}\n\n/* Segment Colors */\n.progress-segment.overdue {\n  background: #ef4444;\n  background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);\n}\n\n.progress-segment.pending {\n  background: #3b82f6;\n  background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);\n}\n\n.progress-segment.in-progress {\n  background: #f59e0b;\n  background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);\n}\n\n.progress-segment.paused {\n  background: #8b5cf6;\n  background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);\n}\n\n.progress-segment.completed {\n  background: #10b981;\n  background: linear-gradient(135deg, #10b981 0%, #059669 100%);\n}\n\n.progress-segment.skipped {\n  background: #6b7280;\n  background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);\n}\n\n/* Progress Percentage */\n.progress-percentage {\n  position: absolute;\n  right: 0;\n  top: -20px;\n  font-size: 12px;\n  font-weight: 600;\n  color: #10b981;\n}\n\n/* Legend */\n.progress-legend {\n  display: flex;\n  justify-content: center;\n  gap: 16px;\n  flex-wrap: wrap;\n  margin-top: 12px;\n  padding-top: 12px;\n  border-top: 1px solid #e5e7eb;\n}\n\n.legend-item {\n  display: flex;\n  align-items: center;\n  gap: 6px;\n  font-size: 12px;\n  color: #6b7280;\n}\n\n.legend-color {\n  width: 12px;\n  height: 12px;\n  border-radius: 3px;\n}\n\n.legend-color.overdue { background: #ef4444; }\n.legend-color.pending { background: #3b82f6; }\n.legend-color.in-progress { background: #f59e0b; }\n.legend-color.completed { background: #10b981; }\n\n/* Responsive Filter Bar Improvements */\n.filters-container {\n  position: relative;\n}\n\n.filters-scroll-wrapper {\n  position: relative;\n  overflow: hidden;\n}\n\n.filters-scroll-content {\n  display: flex;\n  gap: 8px;\n  overflow-x: auto;\n  scrollbar-width: none;\n  -ms-overflow-style: none;\n  padding: 4px 0;\n}\n\n.filters-scroll-content::-webkit-scrollbar {\n  display: none;\n}\n\n.scroll-indicator {\n  position: absolute;\n  top: 50%;\n  transform: translateY(-50%);\n  width: 24px;\n  height: 24px;\n  background: white;\n  border: 1px solid #e5e7eb;\n  border-radius: 50%;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  cursor: pointer;\n  z-index: 10;\n  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);\n  transition: all 0.2s ease;\n}\n\n.scroll-indicator:hover {\n  background: #f9fafb;\n  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);\n}\n\n.scroll-indicator.left {\n  left: -12px;\n}\n\n.scroll-indicator.right {\n  right: -12px;\n}\n\n.scroll-indicator svg {\n  width: 14px;\n  height: 14px;\n  color: #6b7280;\n}\n\n/* Mobile Responsive */\n@media (max-width: 640px) {\n  .gamified-progress-container {\n    padding: 16px;\n    margin-bottom: 16px;\n  }\n  \n  .affirmation-message {\n    font-size: 16px;\n    margin-bottom: 16px;\n  }\n  \n  .progress-bar {\n    height: 28px;\n  }\n  \n  .progress-segment span {\n    font-size: 10px;\n  }\n  \n  /* Hide numbers on small segments on mobile */\n  .progress-segment {\n    min-width: 0;\n  }\n  \n  .progress-segment span {\n    display: none;\n  }\n  \n  /* Simplified legend on mobile */\n  .progress-legend {\n    gap: 12px;\n  }\n  \n  .legend-item {\n    font-size: 11px;\n  }\n  \n  .legend-color {\n    width: 10px;\n    height: 10px;\n  }\n  \n  /* Stack percentage below bar on mobile */\n  .progress-percentage {\n    position: static;\n    text-align: right;\n    margin-top: 4px;\n  }\n  \n  /* Filter improvements on mobile */\n  .filters-scroll-content {\n    gap: 6px;\n  }\n  \n  .scroll-indicator {\n    width: 20px;\n    height: 20px;\n  }\n  \n  .scroll-indicator svg {\n    width: 12px;\n    height: 12px;\n  }\n}\n\n/* Animations */\n.progress-segment {\n  animation: slideIn 0.5s ease-out;\n}\n\n@keyframes slideIn {\n  from { transform: scaleX(0); }\n  to { transform: scaleX(1); }\n}\n\n/* Hover Effects */\n.progress-segment:hover {\n  opacity: 0.9;\n  transform: scaleY(1.1);\n}\n\n/* Task date info styling */\n.task-date-info {\n  font-size: 12px;\n  color: #6b7280;\n  margin-top: 8px;\n  padding: 4px 8px;\n  background: rgba(0, 0, 0, 0.02);\n  border-radius: 4px;\n  text-align: center;\n}\n\n/* Responsive Filter Container */\n.responsive-filter-container {\n  display: flex;\n  flex-wrap: wrap;\n  gap: 12px;\n  padding: 16px;\n  background: white;\n  border-radius: 8px;\n  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);\n  margin-bottom: 20px;\n}\n\n/* Filter Group Wrapper */\n.filter-group-wrapper {\n  display: flex;\n  gap: 8px;\n  flex-wrap: wrap;\n  align-items: center;\n}\n\n/* Base Filter Select */\n.filter-select {\n  padding: 8px 12px;\n  border: 1px solid #e5e7eb;\n  border-radius: 6px;\n  background: white;\n  font-size: 14px;\n  height: 38px;\n  cursor: pointer;\n  flex-shrink: 0;\n}\n\n/* Dynamic widths for different selects */\n.filter-category {\n  min-width: 180px;\n  max-width: 250px;\n}\n\n.filter-status,\n.filter-priority {\n  min-width: 120px;\n  max-width: 150px;\n}\n\n/* Toggle Container */\n.toggle-container {\n  display: inline-flex;\n  align-items: center;\n  gap: 8px;\n  cursor: pointer;\n  user-select: none;\n  white-space: nowrap;\n  padding: 0 8px;\n}\n\n.toggle-input {\n  display: none;\n}\n\n.toggle-slider {\n  width: 40px;\n  height: 22px;\n  background: #e5e7eb;\n  border-radius: 11px;\n  position: relative;\n  transition: background 0.2s;\n  flex-shrink: 0;\n}\n\n.toggle-slider::after {\n  content: '';\n  position: absolute;\n  width: 18px;\n  height: 18px;\n  background: white;\n  border-radius: 50%;\n  top: 2px;\n  left: 2px;\n  transition: transform 0.2s;\n  box-shadow: 0 2px 4px rgba(0,0,0,0.15);\n}\n\n.toggle-input:checked + .toggle-slider {\n  background: #2D8028;\n}\n\n.toggle-input:checked + .toggle-slider::after {\n  transform: translateX(18px);\n}\n\n.toggle-label {\n  font-size: 14px;\n  font-weight: 500;\n  color: #374151;\n}\n\n/* Date Input */\n.filter-date-input {\n  padding: 8px 12px;\n  border: 1px solid #e5e7eb;\n  border-radius: 6px;\n  font-size: 14px;\n  height: 38px;\n  min-width: 140px;\n}\n\n/* Today Button */\n.filter-today-btn {\n  padding: 8px 16px;\n  background: #f3f4f6;\n  border: 1px solid #e5e7eb;\n  border-radius: 6px;\n  font-weight: 500;\n  height: 38px;\n  cursor: pointer;\n  transition: all 0.2s;\n  white-space: nowrap;\n}\n\n.filter-today-btn:hover {\n  background: #e5e7eb;\n}\n\n.filter-today-btn.active {\n  background: #2D8028;\n  color: white;\n  border-color: #2D8028;\n}\n\n/* Search Input */\n.filter-search-input {\n  flex: 1;\n  min-width: 200px;\n  max-width: 400px;\n  padding: 8px 12px;\n  border: 1px solid #e5e7eb;\n  border-radius: 6px;\n  font-size: 14px;\n  height: 38px;\n}\n\n/* Clear Button */\n.filter-clear-btn {\n  padding: 8px 20px;\n  background: white;\n  border: 1px solid #e5e7eb;\n  border-radius: 6px;\n  color: #6b7280;\n  font-weight: 500;\n  height: 38px;\n  cursor: pointer;\n  transition: all 0.2s;\n  white-space: nowrap;\n}\n\n.filter-clear-btn:hover {\n  background: #fee2e2;\n  border-color: #fecaca;\n  color: #dc2626;\n}\n\n/* Responsive Breakpoints */\n@media (max-width: 1200px) {\n  .filter-group-wrapper {\n    flex: 1 1 auto;\n    min-width: 250px;\n  }\n}\n\n@media (max-width: 768px) {\n  .responsive-filter-container {\n    gap: 8px;\n  }\n  \n  .filter-group-wrapper {\n    width: 100%;\n  }\n  \n  .filter-category,\n  .filter-search-input {\n    max-width: none;\n    width: 100%;\n  }\n  \n  .filter-status,\n  .filter-priority {\n    flex: 1;\n  }\n}\n\n@media (max-width: 480px) {\n  .filter-select,\n  .filter-date-input,\n  .filter-today-btn,\n  .filter-clear-btn {\n    width: 100%;\n  }\n  \n  .toggle-container {\n    width: 100%;\n    justify-content: center;\n    padding: 8px;\n  }\n}\n\n/* Login Page Styles */\n.login-page {\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  min-height: 100vh;\n  background-color: #f5f5f5;\n  padding: 20px;\n}\n\n.login-container {\n  background: white;\n  border-radius: 12px;\n  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);\n  padding: 48px;\n  max-width: 400px;\n  width: 100%;\n  text-align: center;\n}\n\n.logo-section h1 {\n  color: #203B17;\n  font-size: 36px;\n  margin: 0;\n}\n\n.logo-section h2 {\n  color: #666;\n  font-size: 18px;\n  font-weight: normal;\n  margin: 8px 0 32px;\n}\n\n.login-section p {\n  color: #666;\n  margin-bottom: 24px;\n}\n\n.microsoft-signin-btn {\n  display: inline-flex;\n  align-items: center;\n  gap: 12px;\n  background: white;\n  border: 1px solid #8c8c8c;\n  padding: 12px 24px;\n  font-size: 16px;\n  font-family: 'Segoe UI', system-ui, sans-serif;\n  cursor: pointer;\n  transition: all 0.2s;\n  border-radius: 2px;\n}\n\n.microsoft-signin-btn:hover {\n  border-color: #666;\n  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);\n}\n\n.microsoft-signin-btn:disabled {\n  opacity: 0.6;\n  cursor: not-allowed;\n}\n\n.security-note {\n  color: #666;\n  font-size: 14px;\n  margin-top: 32px;\n}\n\n.loading-screen {\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  min-height: 100vh;\n  color: #203B17;\n}\n\n:root {\n  --background: hsl(0, 0%, 96%);\n  --foreground: hsl(20, 14.3%, 4.1%);\n  --muted: hsl(60, 4.8%, 95.9%);\n  --muted-foreground: hsl(25, 5.3%, 44.7%);\n  --popover: hsl(0, 0%, 100%);\n  --popover-foreground: hsl(20, 14.3%, 4.1%);\n  --card: hsl(0, 0%, 100%);\n  --card-foreground: hsl(20, 14.3%, 4.1%);\n  --border: hsl(20, 5.9%, 90%);\n  --input: hsl(20, 5.9%, 90%);\n  --primary: hsl(93, 50%, 33%);\n  --primary-foreground: hsl(0, 0%, 100%);\n  --secondary: hsl(60, 4.8%, 95.9%);\n  --secondary-foreground: hsl(24, 9.8%, 10%);\n  --accent: hsl(60, 4.8%, 95.9%);\n  --accent-foreground: hsl(24, 9.8%, 10%);\n  --destructive: hsl(0, 84.2%, 60.2%);\n  --destructive-foreground: hsl(60, 9.1%, 97.8%);\n  --ring: hsl(20, 14.3%, 4.1%);\n  --radius: 0.5rem;\n  \n  /* Custom colors for Grow Space */\n  --grow-bg: hsl(0, 0%, 96%);\n  --grow-card: hsl(0, 0%, 100%);\n  --grow-accent: hsl(93, 50%, 16%);\n  --grow-primary: hsl(93, 50%, 33%);\n  --grow-secondary: hsl(93, 60%, 60%);\n  --grow-gray: hsl(220, 9%, 46%);\n  \n  /* Spacing Scale */\n  --space-xs: 4px;\n  --space-sm: 8px;\n  --space-md: 16px;\n  --space-lg: 24px;\n  --space-xl: 32px;\n  --space-2xl: 48px;\n  --space-3xl: 64px;\n  \n  /* Component Spacing */\n  --page-padding: 32px;\n  --section-gap: 32px;\n  --card-padding: 24px;\n  --input-padding: 12px 16px;\n  --button-padding: 12px 24px;\n  --tab-padding: 12px 20px;\n}\n\n/* Smooth scrolling for inventory page */\n.inventory-scroll {\n  scroll-behavior: smooth;\n  scrollbar-width: thin;\n  scrollbar-color: #9ca3af #f3f4f6;\n}\n\n.inventory-scroll::-webkit-scrollbar {\n  width: 8px;\n}\n\n.inventory-scroll::-webkit-scrollbar-track {\n  background: #f3f4f6;\n}\n\n.inventory-scroll::-webkit-scrollbar-thumb {\n  background: #9ca3af;\n  border-radius: 4px;\n}\n\n.inventory-scroll::-webkit-scrollbar-thumb:hover {\n  background: #6b7280;\n}\n\n/* Late task completion indicators */\n.task-card.completed-late {\n  border-left: 4px solid #f59e0b !important; /* Amber border */\n}\n\n.late-indicator {\n  background: #fef3c7;\n  color: #92400e;\n  padding: 2px 8px;\n  border-radius: 4px;\n  font-size: 12px;\n  font-weight: 600;\n  margin-left: 8px;\n}\n\n.completed-time.late {\n  color: #dc2626; /* Red text for late completion time */\n}\n\n.late-duration {\n  font-weight: 600;\n  color: #b91c1c;\n}\n\n.status-badge.completed.late {\n  background: #fef3c7;\n  color: #92400e;\n  border: 1px solid #fbbf24;\n}\n\n/* Overdue tasks (not yet completed) */\n.task-card.overdue {\n  border-left: 4px solid #dc2626; /* Red border */\n}\n\n.overdue-indicator {\n  background: #fee2e2;\n  color: #991b1b;\n  padding: 2px 8px;\n  border-radius: 4px;\n  font-size: 12px;\n  font-weight: 600;\n}\n\n.dark {\n  --background: hsl(240, 10%, 3.9%);\n  --foreground: hsl(0, 0%, 98%);\n  --muted: hsl(240, 3.7%, 15.9%);\n  --muted-foreground: hsl(240, 5%, 64.9%);\n  --popover: hsl(240, 10%, 3.9%);\n  --popover-foreground: hsl(0, 0%, 98%);\n  --card: hsl(240, 10%, 3.9%);\n  --card-foreground: hsl(0, 0%, 98%);\n  --border: hsl(240, 3.7%, 15.9%);\n  --input: hsl(240, 3.7%, 15.9%);\n  --primary: hsl(93, 50%, 33%);\n  --primary-foreground: hsl(0, 0%, 100%);\n  --secondary: hsl(240, 3.7%, 15.9%);\n  --secondary-foreground: hsl(0, 0%, 98%);\n  --accent: hsl(240, 3.7%, 15.9%);\n  --accent-foreground: hsl(0, 0%, 98%);\n  --destructive: hsl(0, 62.8%, 30.6%);\n  --destructive-foreground: hsl(0, 0%, 98%);\n  --ring: hsl(240, 4.9%, 83.9%);\n  --radius: 0.5rem;\n}\n\n@layer base {\n  * {\n    @apply border-border;\n    box-sizing: border-box;\n  }\n\n  html, body {\n    margin: 0;\n    padding: 0;\n    overflow-x: hidden; /* Prevent horizontal scroll on body */\n    width: 100%;\n  }\n\n  body {\n    @apply font-sans antialiased bg-background text-foreground;\n  }\n\n  #root {\n    width: 100%;\n    overflow-x: hidden;\n  }\n}\n\n@layer utilities {\n  .line-clamp-2 {\n    overflow: hidden;\n    display: -webkit-box;\n    -webkit-box-orient: vertical;\n    -webkit-line-clamp: 2;\n  }\n}\n\n/* Task Manager Cleanup */\n.task-manager {\n  height: 100%;\n  display: flex;\n  flex-direction: column;\n  width: 100%;\n  max-width: 100%; /* Ensure it doesn't exceed parent */\n}\n\n/* Filter Bar with Horizontal Scroll */\n.task-filters-wrapper {\n  margin-bottom: 24px;\n  position: relative;\n  background: white;\n  border-radius: 8px;\n  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);\n  overflow: hidden;\n}\n\n.task-filters {\n  display: flex;\n  align-items: center;\n  gap: 12px;\n  padding: 16px;\n  overflow-x: auto;\n  overflow-y: hidden;\n  min-height: 56px;\n  white-space: nowrap;\n  -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */\n  \n  /* Show thin scrollbar for better UX */\n  -ms-overflow-style: auto;\n  scrollbar-width: thin;\n}\n\n.task-filters::-webkit-scrollbar {\n  height: 6px;\n}\n\n.task-filters::-webkit-scrollbar-track {\n  background: #f1f1f1;\n  border-radius: 3px;\n}\n\n.task-filters::-webkit-scrollbar-thumb {\n  background: #888;\n  border-radius: 3px;\n}\n\n.task-filters::-webkit-scrollbar-thumb:hover {\n  background: #555;\n}\n\n/* Prevent flex items from shrinking */\n.task-filters > * {\n  flex-shrink: 0;\n}\n\n/* Filter Buttons and Selects */\n.btn-filter {\n  padding: 8px 16px;\n  background: #f3f4f6;\n  border: 1px solid #e5e7eb;\n  border-radius: 6px;\n  cursor: pointer;\n  font-size: 14px;\n  font-weight: 500;\n  color: #374151;\n  white-space: nowrap;\n  transition: all 0.2s;\n}\n\n.btn-filter:hover {\n  background: #e5e7eb;\n  border-color: #d1d5db;\n}\n\n.btn-filter.all-tasks {\n  background: #2D8028;\n  color: white;\n  border-color: #2D8028;\n}\n\n.filter-select {\n  height: 38px;\n  padding: 0 12px;\n  background: white;\n  border: 1px solid #d1d5db;\n  border-radius: 6px;\n  font-size: 14px;\n  color: #374151;\n  cursor: pointer;\n  width: 110px;\n  box-sizing: border-box;\n}\n\n.date-input {\n  height: 38px;\n  padding: 0 12px;\n  background: white;\n  border: 1px solid #d1d5db;\n  border-radius: 6px;\n  font-size: 14px;\n  color: #374151;\n  width: 140px;\n  box-sizing: border-box;\n}\n\n.btn-clear-filters {\n  display: flex;\n  align-items: center;\n  gap: 6px;\n  height: 38px;\n  padding: 0 12px;\n  background: white;\n  border: 1px solid #d1d5db;\n  border-radius: 6px;\n  color: #6b7280;\n  cursor: pointer;\n  font-size: 14px;\n  white-space: nowrap;\n  box-sizing: border-box;\n}\n\n.btn-clear-filters:hover {\n  background: #f3f4f6;\n  color: #374151;\n}\n\n/* Search Box */\n.search-box {\n  display: flex;\n  align-items: center;\n  gap: 8px;\n  height: 38px;\n  padding: 0 12px;\n  background: #f3f4f6;\n  border: 1px solid #e5e7eb;\n  border-radius: 6px;\n  width: 180px;\n  margin-left: auto; /* Push to right */\n  box-sizing: border-box;\n}\n\n.search-box svg {\n  color: #6b7280;\n}\n\n.search-input {\n  background: none;\n  border: none;\n  outline: none;\n  font-size: 14px;\n  color: #374151;\n  width: 100%;\n}\n\n.search-input::placeholder {\n  color: #9ca3af;\n}\n\n/* New Task Button */\n.btn-new-task {\n  display: flex;\n  align-items: center;\n  gap: 6px;\n  height: 38px;\n  padding: 0 16px;\n  background: #2D8028;\n  color: white;\n  border: none;\n  border-radius: 6px;\n  cursor: pointer;\n  font-size: 14px;\n  font-weight: 500;\n  white-space: nowrap;\n  transition: all 0.2s;\n  box-sizing: border-box;\n}\n\n.btn-new-task:hover {\n  background: #236020;\n}\n\n/* Today Button */\n.btn-today {\n  height: 38px;\n  padding: 0 12px;\n  background: white;\n  border: 1px solid #d1d5db;\n  border-radius: 6px;\n  color: #374151;\n  cursor: pointer;\n  font-size: 14px;\n  white-space: nowrap;\n  transition: all 0.2s;\n  box-sizing: border-box;\n}\n\n.btn-today:hover {\n  background: #f3f4f6;\n  border-color: #9ca3af;\n}\n\n/* Standardize all filter button widths */\n.btn-today {\n  width: 70px;\n}\n\n.btn-clear-filters {\n  width: 120px;\n}\n\n.btn-new-task {\n  width: 110px;\n}\n\n.btn-refresh {\n  width: 140px;\n}\n\n/* Task Content */\n.task-content {\n  flex: 1;\n  overflow-y: auto;\n}\n\n/* No Tasks State */\n.no-tasks {\n  display: flex;\n  flex-direction: column;\n  align-items: center;\n  justify-content: center;\n  height: 400px;\n  color: #6b7280;\n}\n\n.no-tasks h3 {\n  margin: 0 0 8px 0;\n  font-size: 20px;\n  color: #374151;\n}\n\n.no-tasks p {\n  margin: 0;\n  font-size: 16px;\n}\n\n/* Mobile Responsive */\n@media (max-width: 768px) {\n  .sidebar {\n    position: fixed;\n    left: -230px; /* Hide by default on mobile */\n    z-index: 100;\n    height: 100%;\n    transition: left 0.3s ease;\n  }\n  \n  .sidebar.open {\n    left: 0;\n  }\n  \n  .main-content {\n    margin-left: 0;\n  }\n  \n  .app-header {\n    padding: 8px 16px; /* Even smaller on mobile */\n  }\n  \n  .user-info {\n    max-width: 120px; /* Shorter on mobile */\n  }\n  \n  .location-badge {\n    display: none; /* Hide location on mobile to save space */\n  }\n  \n  .page-content {\n    padding: 16px;\n  }\n  \n  .task-filters-wrapper {\n    margin: 0 -16px 16px -16px;\n    border-radius: 0;\n  }\n  \n  .task-filters {\n    padding: 12px 16px;\n  }\n  \n  .search-box {\n    min-width: 150px;\n  }\n}\n\n/* Scroll Indicators */\n.task-filters-wrapper.can-scroll-left::before,\n.task-filters-wrapper.can-scroll-right::after {\n  content: '';\n  position: absolute;\n  top: 0;\n  bottom: 0;\n  width: 20px;\n  pointer-events: none;\n  z-index: 1;\n}\n\n.task-filters-wrapper.can-scroll-left::before {\n  left: 0;\n  background: linear-gradient(to right, white, transparent);\n}\n\n.task-filters-wrapper.can-scroll-right::after {\n  right: 0;\n  background: linear-gradient(to left, white, transparent);\n}\n\n/* Header Layout Improvements */\n.app-header {\n  display: flex;\n  align-items: center;\n  justify-content: space-between;\n  padding: 1rem 1.5rem;\n  background: white;\n  border-bottom: 1px solid #e5e7eb;\n  position: sticky;\n  top: 0;\n  z-index: 10;\n}\n\n.header-left {\n  flex: 1;\n  min-width: 0;\n}\n\n.header-right {\n  flex: 1;\n  display: flex;\n  justify-content: flex-end;\n  align-items: center;\n  gap: 1rem;\n  min-width: 0;\n}\n\n.user-info {\n  display: flex;\n  align-items: center;\n  gap: 8px;\n  min-width: 200px;\n  white-space: nowrap;\n}\n\n.user-name {\n  font-weight: 500;\n  color: #333;\n  overflow: hidden;\n  text-overflow: ellipsis;\n  max-width: 300px;\n}\n\n/* Main App Container */\n.app-container {\n  display: flex;\n  height: 100vh;\n  width: 100%;\n  overflow: hidden; /* Prevent any overflow */\n}\n\n/* Sidebar */\n.sidebar {\n  width: 230px; /* Slightly narrower */\n  background: #203B17;\n  color: white;\n  display: flex;\n  flex-direction: column;\n  flex-shrink: 0; /* Prevent sidebar from shrinking */\n  overflow-y: auto;\n  overflow-x: hidden;\n}\n\n/* Main Content Area */\n.main-content {\n  flex: 1;\n  display: flex;\n  flex-direction: column;\n  height: 100vh;\n  overflow: auto; /* Enable scrolling for main content */\n  min-width: 0; /* Allow flex item to shrink below content size */\n}\n\n/* Header */\n.app-header {\n  background: white;\n  border-bottom: 1px solid #e5e7eb;\n  padding: 12px 20px; /* Reduced padding */\n  display: flex;\n  justify-content: space-between;\n  align-items: center;\n  flex-shrink: 0;\n  min-height: 56px; /* Fixed height */\n}\n\n.header-left {\n  display: flex;\n  align-items: center;\n  gap: 16px;\n  min-width: 0; /* Allow shrinking */\n}\n\n.page-title {\n  font-size: 18px;\n  font-weight: 600;\n  color: #1f2937;\n  display: flex;\n  align-items: center;\n  gap: 8px;\n}\n\n/* Hide old duplicate elements */\n.page-tabs,\n.tab-button,\n.location-badge,\n.notification-bell,\n.header-corporate-badge {\n  display: none !important;\n}\n\n/* Header Right - User Info */\n.header-right {\n  display: flex;\n  align-items: center;\n  gap: 12px; /* Reduced gap */\n  margin-left: auto;\n  flex-shrink: 0;\n}\n\n.location-badge {\n  display: flex;\n  align-items: center;\n  gap: 6px;\n  padding: 6px 12px; /* Smaller padding */\n  background: #f3f4f6;\n  border-radius: 6px;\n  font-size: 13px; /* Smaller font */\n  color: #374151;\n}\n\n.user-info {\n  display: flex;\n  align-items: center;\n  gap: 8px;\n  padding: 8px 16px;\n  background: #f9fafb;\n  border-radius: 8px;\n  font-size: 14px;\n  color: #374151;\n  max-width: 200px;\n}\n\n.user-name {\n  overflow: hidden;\n  text-overflow: ellipsis;\n  white-space: nowrap;\n}\n\n/* Page Content */\n.page-content {\n  flex: 1;\n  overflow-y: auto;\n  overflow-x: hidden; /* No horizontal scroll */\n  padding: 24px;\n}\n\n/* Utility Classes */\n.truncate {\n  overflow: hidden;\n  text-overflow: ellipsis;\n  white-space: nowrap;\n}\n\n/* Ensure all containers respect boundaries */\n.container,\n.section,\n.card {\n  max-width: 100%;\n  overflow-x: hidden;\n}\n\n/* Tables should be scrollable if needed */\n.table-wrapper {\n  width: 100%;\n  overflow-x: auto;\n}\n\ntable {\n  min-width: 600px; /* Set minimum width */\n}\n\n/* Prevent images from breaking layout */\nimg {\n  max-width: 100%;\n  height: auto;\n}\n\n/* Component-specific overflow prevention */\n.chart-container,\n.metrics-grid,\n.form-container {\n  width: 100%;\n  max-width: 100%;\n  overflow-x: hidden;\n}\n\n/* For any flex containers */\n.flex-container {\n  display: flex;\n  flex-wrap: wrap; /* Allow wrapping instead of overflow */\n  gap: 16px;\n}\n\n/* Grid containers should be responsive */\n.grid-container {\n  display: grid;\n  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));\n  gap: 16px;\n  width: 100%;\n}\n\n/* Page Layout Updates - Clean Headers */\n.page-content {\n  padding: 24px;\n  height: 100%;\n}\n\n/* Each page should start with its main content */\n.task-manager,\n.account-page,\n.inventory-page,\n.education-page,\n.recurring-tasks-page,\n.task-data-page,\n.staff-data-page,\n.production-data-page {\n  height: 100%;\n  display: flex;\n  flex-direction: column;\n}\n\n/* Remove any .page-header styles as they're no longer needed */\n.page-header {\n  display: none; /* Remove entirely */\n}\n\n/* Ensure first element has no top margin */\n.page-content > *:first-child {\n  margin-top: 0;\n}\n\n/* Consistent sub-tab styling */\n.tab-navigation {\n  display: flex;\n  gap: 8px;\n  padding: 4px;\n  background: #f3f4f6;\n  border-radius: 8px;\n  margin-bottom: 24px;\n}\n\n.tab-navigation button {\n  padding: 10px 20px;\n  background: transparent;\n  border: none;\n  border-radius: 6px;\n  cursor: pointer;\n  font-size: 14px;\n  font-weight: 500;\n  color: #6b7280;\n  transition: all 0.2s;\n}\n\n.tab-navigation button.active {\n  background: white;\n  color: #2D8028;\n  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);\n}\n\n/* Location Selector Styles */\n.sidebar-location-selector .relative > button {\n  @apply bg-[#2D8028] border-[#2D8028] text-white hover:bg-[#2D8028]/80;\n}\n\n.sidebar-location-selector .relative > button svg {\n  @apply text-white;\n}\n\n.location-selector-mobile {\n  position: fixed;\n  top: 0;\n  left: 0;\n  right: 0;\n  bottom: 0;\n  background: rgba(0, 0, 0, 0.5);\n  z-index: 60;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  padding: 20px;\n}\n\n.location-selector-mobile .card {\n  max-width: 400px;\n  width: 100%;\n  max-height: 80vh;\n  overflow-y: auto;\n}\n\n/* Staff Data Page Styles */\n.staff-data-page {\n  padding: 20px;\n  max-width: 1600px;\n  margin: 0 auto;\n}\n\n.page-header {\n  display: flex;\n  justify-content: space-between;\n  align-items: center;\n  margin-bottom: 24px;\n}\n\n.btn-export {\n  background: #2D8028;\n  color: white;\n  padding: 10px 20px;\n  border: none;\n  border-radius: 6px;\n  cursor: pointer;\n  font-size: 14px;\n  font-weight: 500;\n  transition: background-color 0.2s;\n}\n\n.btn-export:hover {\n  background: #1a4f15;\n}\n\n.tab-navigation {\n  display: flex;\n  gap: 12px;\n  margin-bottom: 24px;\n  border-bottom: 2px solid #e5e7eb;\n}\n\n.tab {\n  padding: 12px 24px;\n  background: none;\n  border: none;\n  cursor: pointer;\n  font-size: 16px;\n  color: #6b7280;\n  border-bottom: 2px solid transparent;\n  margin-bottom: -2px;\n  transition: all 0.2s;\n}\n\n.tab:hover {\n  color: #374151;\n}\n\n.tab.active {\n  color: #203B17;\n  border-bottom-color: #203B17;\n  font-weight: 600;\n}\n\n.tab-content {\n  background: white;\n  padding: 24px;\n  border-radius: 8px;\n  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);\n  min-height: 400px;\n}\n\n.access-denied {\n  text-align: center;\n  padding: 60px 20px;\n  color: #6b7280;\n}\n\n.access-denied h2 {\n  color: #374151;\n  margin-bottom: 12px;\n}\n\n.staff-summary, .analytics-summary {\n  background: #f9fafb;\n  padding: 20px;\n  border-radius: 8px;\n  margin-top: 20px;\n}\n\n.staff-summary h3, .analytics-summary h3 {\n  color: #203B17;\n  margin-bottom: 16px;\n  font-size: 18px;\n  font-weight: 600;\n}\n\n.staff-summary p, .analytics-summary p {\n  margin-bottom: 8px;\n  color: #374151;\n}\n\n/* Mobile Responsive */\n@media (max-width: 768px) {\n  .staff-data-page {\n    padding: 16px;\n  }\n  \n  .page-header {\n    flex-direction: column;\n    gap: 16px;\n    align-items: stretch;\n  }\n  \n  .tab-navigation {\n    overflow-x: auto;\n    white-space: nowrap;\n  }\n  \n  .tab {\n    min-width: 120px;\n  }\n  \n  .tab-content {\n    padding: 16px;\n  }\n}\n\n/* Staff Edit View Styles */\n.staff-edit-view {\n  width: 100%;\n}\n\n/* Toolbar */\n.staff-toolbar {\n  display: flex;\n  gap: 16px;\n  margin-bottom: 24px;\n  align-items: center;\n}\n\n.search-input {\n  flex: 1;\n  max-width: 400px;\n  padding: 10px 16px;\n  border: 1px solid #d1d5db;\n  border-radius: 6px;\n  font-size: 14px;\n}\n\n.search-input:focus {\n  outline: none;\n  border-color: #2D8028;\n  box-shadow: 0 0 0 3px rgba(45, 128, 40, 0.1);\n}\n\n.sort-select {\n  padding: 10px 16px;\n  border: 1px solid #d1d5db;\n  border-radius: 6px;\n  background: white;\n  font-size: 14px;\n  cursor: pointer;\n}\n\n.sort-select:focus {\n  outline: none;\n  border-color: #2D8028;\n}\n\n.btn-add-staff {\n  background: #2D8028;\n  color: white;\n  padding: 10px 20px;\n  border: none;\n  border-radius: 6px;\n  cursor: pointer;\n  font-size: 14px;\n  font-weight: 500;\n  transition: background-color 0.2s;\n}\n\n.btn-add-staff:hover {\n  background: #1a4f15;\n}\n\n/* Table */\n.staff-table-container {\n  background: white;\n  border-radius: 8px;\n  overflow-x: auto;\n  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);\n  border: 1px solid #e5e7eb;\n}\n\n.staff-table {\n  width: 100%;\n  border-collapse: collapse;\n  min-width: 900px;\n}\n\n.staff-table th {\n  background: #f3f4f6;\n  padding: 12px;\n  text-align: left;\n  font-weight: 600;\n  font-size: 14px;\n  color: #374151;\n  border-bottom: 1px solid #e5e7eb;\n}\n\n.staff-table td {\n  padding: 12px;\n  border-bottom: 1px solid #e5e7eb;\n  font-size: 14px;\n}\n\n.staff-table tr:hover {\n  background: #f9fafb;\n}\n\n.staff-table tr:last-child td {\n  border-bottom: none;\n}\n\n.inactive-row {\n  opacity: 0.6;\n  background: #f9fafb !important;\n}\n\n/* Table cells */\n.staff-name {\n  font-weight: 500;\n  display: flex;\n  align-items: center;\n  gap: 8px;\n  color: #1f2937;\n}\n\n.ms-connected {\n  font-size: 12px;\n  opacity: 0.7;\n}\n\n.contact-info .email {\n  font-size: 14px;\n  color: #1f2937;\n}\n\n.contact-info .phone {\n  color: #6b7280;\n  font-size: 13px;\n  margin-top: 2px;\n}\n\n.roles-list {\n  display: flex;\n  flex-wrap: wrap;\n  gap: 4px;\n}\n\n.role-badge {\n  display: inline-flex;\n  align-items: center;\n  gap: 4px;\n  padding: 4px 10px;\n  border-radius: 12px;\n  font-size: 11px;\n  font-weight: 500;\n  white-space: nowrap;\n  background: #dbeafe;\n  color: #1e40af;\n}\n\n/* Color coding for different role types */\n.role-microgreens-seeder,\n.role-leafy-greens-seeder {\n  background: #d1fae5;\n  color: #065f46;\n}\n\n.role-microgreens-harvester,\n.role-leafy-greens-harvester {\n  background: #fed7aa;\n  color: #9a3412;\n}\n\n.role-blackout-specialist {\n  background: #e0e7ff;\n  color: #3730a3;\n}\n\n.role-moving-tech,\n.role-packing-tech {\n  background: #fce7f3;\n  color: #831843;\n}\n\n.role-cleaning-crew {\n  background: #ccfbf1;\n  color: #134e4a;\n}\n\n.role-inventory-tech {\n  background: #ede9fe;\n  color: #5b21b6;\n}\n\n.role-equipment-tech {\n  background: #fee2e2;\n  color: #991b1b;\n}\n\n.role-manager {\n  background: #fef3c7;\n  color: #78350f;\n}\n\n.role-general-staff {\n  background: #f3f4f6;\n  color: #374151;\n}\n\n.no-roles {\n  color: #9ca3af;\n  font-style: italic;\n  font-size: 13px;\n}\n\n.pay-rate {\n  font-weight: 600;\n  color: #059669;\n}\n\n.training-status {\n  display: flex;\n  gap: 8px;\n  font-size: 13px;\n}\n\n.training-status .completed {\n  color: #059669;\n  font-weight: 500;\n}\n\n.training-status .in-progress {\n  color: #f59e0b;\n  font-weight: 500;\n}\n\n.status-badge {\n  padding: 4px 12px;\n  border-radius: 16px;\n  font-size: 12px;\n  font-weight: 500;\n  text-transform: capitalize;\n}\n\n.status-active {\n  background: #d1fae5;\n  color: #065f46;\n}\n\n.status-on-leave {\n  background: #fef3c7;\n  color: #92400e;\n}\n\n.status-inactive {\n  background: #f3f4f6;\n  color: #6b7280;\n}\n\n.last-active {\n  color: #6b7280;\n  font-size: 14px;\n}\n\n.btn-edit {\n  background: #e5e7eb;\n  color: #374151;\n  padding: 6px 16px;\n  border: none;\n  border-radius: 4px;\n  cursor: pointer;\n  font-size: 14px;\n  font-weight: 500;\n  transition: background-color 0.2s;\n}\n\n.btn-edit:hover {\n  background: #d1d5db;\n}\n\n/* Modal styles */\n.modal-overlay {\n  position: fixed;\n  top: 0;\n  left: 0;\n  right: 0;\n  bottom: 0;\n  background: rgba(0, 0, 0, 0.5);\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  z-index: 1000;\n  padding: 20px;\n}\n\n.modal-content {\n  background: white;\n  border-radius: 8px;\n  box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);\n  max-height: 90vh;\n  overflow-y: auto;\n}\n\n.large-modal {\n  width: 90%;\n  max-width: 900px;\n}\n\n.modal-header {\n  display: flex;\n  justify-content: space-between;\n  align-items: center;\n  padding: 24px;\n  border-bottom: 1px solid #e5e7eb;\n}\n\n.modal-header h2 {\n  margin: 0;\n  font-size: 24px;\n  color: #1f2937;\n}\n\n.close-btn {\n  background: none;\n  border: none;\n  font-size: 24px;\n  color: #6b7280;\n  cursor: pointer;\n  padding: 4px;\n}\n\n.close-btn:hover {\n  color: #374151;\n}\n\n/* Form Styles */\n.staff-form {\n  padding: 24px;\n}\n\n.form-grid {\n  display: grid;\n  grid-template-columns: 1fr 1fr;\n  gap: 24px;\n}\n\n.form-section {\n  background: #f9fafb;\n  padding: 20px;\n  border-radius: 8px;\n}\n\n.form-section.full-width {\n  grid-column: 1 / -1;\n}\n\n.form-section h3 {\n  margin: 0 0 16px 0;\n  font-size: 18px;\n  color: #1f2937;\n}\n\n.form-section label {\n  display: block;\n  margin-bottom: 16px;\n  font-weight: 500;\n  color: #374151;\n}\n\n.form-section input,\n.form-section select,\n.form-section textarea {\n  width: 100%;\n  padding: 8px 12px;\n  margin-top: 4px;\n  border: 1px solid #d1d5db;\n  border-radius: 4px;\n  font-size: 14px;\n}\n\n.form-section input:focus,\n.form-section select:focus,\n.form-section textarea:focus {\n  outline: none;\n  border-color: #2D8028;\n}\n\n/* Pay Rate Field */\n.input-with-note {\n  position: relative;\n}\n\n.field-note {\n  position: absolute;\n  right: 12px;\n  top: 50%;\n  transform: translateY(-50%);\n  font-size: 12px;\n  color: #6b7280;\n}\n\n/* Checkbox Group */\n/* Roles grid in edit modal */\n.checkbox-group {\n  display: grid;\n  grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));\n  gap: 12px;\n  padding: 12px;\n  background: #f9fafb;\n  border-radius: 8px;\n  max-height: 300px;\n  overflow-y: auto;\n}\n\n.checkbox-label {\n  display: flex;\n  align-items: center;\n  gap: 8px;\n  padding: 8px;\n  border-radius: 6px;\n  cursor: pointer;\n  transition: background 0.2s;\n  font-size: 14px;\n  font-weight: normal;\n}\n\n.checkbox-label:hover {\n  background: #e5e7eb;\n}\n\n.checkbox-label input[type=\"checkbox\"] {\n  width: 18px;\n  height: 18px;\n  cursor: pointer;\n  margin: 0;\n}\n\n/* Error States */\nlabel.error input,\nlabel.error select {\n  border-color: #ef4444;\n}\n\n.error-text {\n  color: #ef4444;\n  font-size: 12px;\n  margin-top: 4px;\n  display: block;\n}\n\n/* Info Section */\n.info-section {\n  background: #f3f4f6;\n}\n\n.info-grid {\n  display: grid;\n  grid-template-columns: 1fr 1fr;\n  gap: 24px;\n}\n\n.info-grid ul {\n  margin: 8px 0;\n  padding-left: 20px;\n}\n\n.info-grid li {\n  margin: 4px 0;\n  color: #6b7280;\n}\n\n/* Modal Actions */\n.modal-actions {\n  display: flex;\n  justify-content: space-between;\n  align-items: center;\n  padding: 24px;\n  border-top: 1px solid #e5e7eb;\n}\n\n.modal-actions-right {\n  display: flex;\n  gap: 12px;\n}\n\n.btn-save {\n  background: #2D8028;\n  color: white;\n  padding: 10px 24px;\n  border: none;\n  border-radius: 6px;\n  cursor: pointer;\n  font-weight: 500;\n  transition: all 0.2s;\n}\n\n.btn-save:hover {\n  background: #236622;\n}\n\n.btn-save:disabled {\n  opacity: 0.6;\n  cursor: not-allowed;\n}\n\n.btn-cancel {\n  background: #e5e7eb;\n  color: #374151;\n  padding: 10px 24px;\n  border: none;\n  border-radius: 6px;\n  cursor: pointer;\n  transition: all 0.2s;\n}\n\n.btn-cancel:hover {\n  background: #d1d5db;\n}\n\n.btn-cancel:disabled {\n  opacity: 0.6;\n  cursor: not-allowed;\n}\n\n/* Delete button styling */\n.btn-delete {\n  background: #dc3545;\n  color: white;\n  padding: 10px 20px;\n  border: none;\n  border-radius: 6px;\n  cursor: pointer;\n  font-weight: 500;\n  transition: all 0.2s;\n}\n\n.btn-delete:hover {\n  background: #c82333;\n}\n\n.btn-delete.confirm {\n  background: #ff6b6b;\n  animation: pulse 0.5s ease-in-out;\n}\n\n.btn-delete:disabled {\n  opacity: 0.6;\n  cursor: not-allowed;\n}\n\n@keyframes pulse {\n  0% { transform: scale(1); }\n  50% { transform: scale(1.05); }\n  100% { transform: scale(1); }\n}\n\n/* Mobile responsive */\n@media (max-width: 768px) {\n  .staff-toolbar {\n    flex-direction: column;\n    align-items: stretch;\n  }\n  \n  .search-input {\n    max-width: none;\n  }\n  \n  .staff-table {\n    min-width: 600px;\n  }\n  \n  .staff-table th,\n  .staff-table td {\n    padding: 8px;\n    font-size: 13px;\n  }\n  \n  .roles-list {\n    flex-direction: column;\n    gap: 2px;\n  }\n  \n  .role-badge {\n    font-size: 11px;\n  }\n  \n  /* Modal Mobile */\n  .form-grid {\n    grid-template-columns: 1fr;\n  }\n  \n  .modal-content {\n    width: 100%;\n    margin: 20px;\n  }\n  \n  .modal-header {\n    padding: 16px;\n  }\n  \n  .staff-form {\n    padding: 16px;\n  }\n  \n  .form-section {\n    padding: 16px;\n  }\n  \n  .info-grid {\n    grid-template-columns: 1fr;\n  }\n  \n  .modal-actions {\n    flex-direction: column;\n    gap: 12px;\n    padding: 16px;\n  }\n  \n  .btn-delete {\n    width: 100%;\n    order: 3; /* Put delete at bottom on mobile */\n  }\n  \n  .modal-actions-right {\n    width: 100%;\n    flex-direction: column;\n  }\n  \n  .modal-actions-right button {\n    width: 100%;\n  }\n}\n\n/* Staff Analytics View */\n.staff-analytics-view {\n  padding: 20px;\n}\n\n.analytics-toolbar {\n  display: flex;\n  gap: 16px;\n  margin-bottom: 24px;\n}\n\n.date-range-select,\n.metric-select {\n  padding: 8px 16px;\n  border: 1px solid #d1d5db;\n  border-radius: 6px;\n  background: white;\n  font-size: 14px;\n  cursor: pointer;\n}\n\n.date-range-select:focus,\n.metric-select:focus {\n  outline: none;\n  border-color: #2D8028;\n}\n\n/* Analytics Cards */\n.analytics-cards {\n  display: grid;\n  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));\n  gap: 20px;\n  margin-bottom: 32px;\n}\n\n.analytics-card {\n  background: white;\n  padding: 20px;\n  border-radius: 8px;\n  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);\n  display: flex;\n  gap: 16px;\n  border: 1px solid #e5e7eb;\n}\n\n.analytics-card .card-icon {\n  font-size: 32px;\n}\n\n.analytics-card .card-content h3 {\n  margin: 0 0 8px 0;\n  font-size: 14px;\n  color: #6b7280;\n  font-weight: 500;\n}\n\n.analytics-card .metric {\n  font-size: 28px;\n  font-weight: 700;\n  color: #203B17;\n}\n\n.analytics-card .sub-metric {\n  font-size: 14px;\n  color: #6b7280;\n  margin-top: 4px;\n}\n\n/* Performance Section */\n.performance-section {\n  background: white;\n  padding: 24px;\n  border-radius: 8px;\n  margin-bottom: 24px;\n  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);\n  border: 1px solid #e5e7eb;\n}\n\n.performance-section h3 {\n  margin: 0 0 20px 0;\n  color: #1f2937;\n  font-size: 18px;\n}\n\n.rankings-list {\n  display: flex;\n  flex-direction: column;\n  gap: 12px;\n}\n\n.ranking-row {\n  display: flex;\n  align-items: center;\n  gap: 16px;\n  padding: 12px;\n  background: #f9fafb;\n  border-radius: 6px;\n  transition: background-color 0.2s;\n}\n\n.ranking-row:hover {\n  background: #f3f4f6;\n}\n\n.ranking-row .rank {\n  font-size: 20px;\n  font-weight: 600;\n  width: 40px;\n  text-align: center;\n}\n\n.ranking-row .person-info {\n  flex: 1;\n  display: flex;\n  flex-direction: column;\n}\n\n.ranking-row .person-info .name {\n  font-weight: 500;\n  color: #1f2937;\n  margin-bottom: 2px;\n}\n\n.ranking-row .person-info .roles {\n  font-size: 13px;\n  color: #6b7280;\n}\n\n.ranking-row .metric-value {\n  font-weight: 600;\n  color: #059669;\n  font-size: 16px;\n}\n\n/* Individual Performance */\n.individual-performance {\n  margin-top: 32px;\n}\n\n.individual-performance h3 {\n  margin-bottom: 20px;\n  color: #1f2937;\n  font-size: 18px;\n}\n\n.performance-grid {\n  display: grid;\n  grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));\n  gap: 20px;\n}\n\n.performance-card {\n  background: white;\n  padding: 20px;\n  border-radius: 8px;\n  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);\n  border: 1px solid #e5e7eb;\n}\n\n.performance-card .card-header {\n  display: flex;\n  justify-content: space-between;\n  align-items: center;\n  margin-bottom: 16px;\n}\n\n.performance-card .card-header h4 {\n  margin: 0;\n  color: #1f2937;\n  font-size: 18px;\n}\n\n.performance-card .status-indicator {\n  font-size: 12px;\n  padding: 4px 8px;\n  border-radius: 12px;\n  font-weight: 500;\n  text-transform: capitalize;\n}\n\n.performance-card .status-indicator.active {\n  background: #d1fae5;\n  color: #065f46;\n}\n\n.performance-card .status-indicator.on-leave {\n  background: #fef3c7;\n  color: #92400e;\n}\n\n.performance-card .status-indicator.inactive {\n  background: #f3f4f6;\n  color: #6b7280;\n}\n\n.performance-metrics {\n  margin-bottom: 16px;\n}\n\n.performance-metrics .metric-row {\n  display: flex;\n  justify-content: space-between;\n  padding: 6px 0;\n  font-size: 14px;\n}\n\n.performance-metrics .metric-row .label {\n  color: #6b7280;\n}\n\n.performance-metrics .metric-row .value {\n  font-weight: 500;\n  color: #1f2937;\n}\n\n.performance-metrics .metric-row .value.good {\n  color: #059669;\n}\n\n.performance-metrics .metric-row .value.warning {\n  color: #f59e0b;\n}\n\n.performance-metrics .metric-row .value.poor {\n  color: #dc2626;\n}\n\n/* Task Breakdown */\n.task-breakdown {\n  margin-top: 16px;\n  padding-top: 16px;\n  border-top: 1px solid #e5e7eb;\n}\n\n.task-breakdown h5 {\n  margin: 0 0 12px 0;\n  font-size: 14px;\n  color: #6b7280;\n  font-weight: 500;\n}\n\n.breakdown-bars {\n  display: flex;\n  flex-direction: column;\n  gap: 8px;\n}\n\n.breakdown-item {\n  display: grid;\n  grid-template-columns: 80px 1fr 40px;\n  align-items: center;\n  gap: 8px;\n  font-size: 13px;\n}\n\n.breakdown-item .type-label {\n  color: #6b7280;\n  font-weight: 500;\n}\n\n.breakdown-item .bar-container {\n  background: #e5e7eb;\n  height: 20px;\n  border-radius: 4px;\n  overflow: hidden;\n}\n\n.breakdown-item .bar {\n  height: 100%;\n  background: #2D8028;\n  transition: width 0.3s ease;\n}\n\n.breakdown-item .count {\n  color: #1f2937;\n  font-weight: 500;\n  text-align: right;\n}\n\n/* Training Overview */\n.training-overview {\n  margin-top: 32px;\n  background: white;\n  padding: 24px;\n  border-radius: 8px;\n  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);\n  border: 1px solid #e5e7eb;\n}\n\n.training-overview h3 {\n  margin: 0 0 20px 0;\n  color: #1f2937;\n  font-size: 18px;\n}\n\n.training-matrix {\n  overflow-x: auto;\n  margin-bottom: 20px;\n}\n\n.training-matrix table {\n  width: 100%;\n  border-collapse: collapse;\n  min-width: 600px;\n}\n\n.training-matrix th,\n.training-matrix td {\n  padding: 8px;\n  text-align: center;\n  border: 1px solid #e5e7eb;\n  font-size: 14px;\n}\n\n.training-matrix th {\n  background: #f3f4f6;\n  font-weight: 600;\n  color: #374151;\n}\n\n.training-matrix .course-header {\n  writing-mode: vertical-lr;\n  text-orientation: mixed;\n  font-size: 12px;\n  min-width: 40px;\n}\n\n.training-matrix .staff-name-cell {\n  text-align: left !important;\n  font-weight: 500;\n  color: #1f2937;\n  min-width: 150px;\n}\n\n.training-matrix .status-cell .completed {\n  color: #059669;\n  font-size: 16px;\n}\n\n.training-matrix .status-cell .in-progress {\n  color: #f59e0b;\n  font-size: 16px;\n}\n\n.training-matrix .status-cell .not-started {\n  color: #d1d5db;\n  font-size: 16px;\n}\n\n.course-legend {\n  background: #f9fafb;\n  padding: 16px;\n  border-radius: 6px;\n}\n\n.course-legend h4 {\n  margin: 0 0 8px 0;\n  font-size: 14px;\n  color: #1f2937;\n}\n\n.course-legend ul {\n  list-style: none;\n  padding: 0;\n  margin: 0;\n  font-size: 13px;\n  display: grid;\n  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));\n  gap: 8px;\n}\n\n.course-legend li {\n  margin: 4px 0;\n  color: #6b7280;\n}\n\n.course-legend li strong {\n  color: #1f2937;\n}\n\n/* Mobile Analytics */\n@media (max-width: 768px) {\n  .analytics-toolbar {\n    flex-direction: column;\n    gap: 12px;\n  }\n  \n  .analytics-cards {\n    grid-template-columns: 1fr;\n  }\n  \n  .performance-grid {\n    grid-template-columns: 1fr;\n  }\n  \n  .ranking-row {\n    flex-direction: column;\n    align-items: stretch;\n    gap: 8px;\n  }\n  \n  .ranking-row .rank {\n    width: auto;\n    text-align: left;\n  }\n  \n  .breakdown-item {\n    grid-template-columns: 1fr;\n    gap: 4px;\n  }\n  \n  .breakdown-item .bar-container {\n    order: 2;\n  }\n  \n  .breakdown-item .count {\n    order: 3;\n    text-align: left;\n  }\n  \n  .training-matrix {\n    font-size: 12px;\n  }\n  \n  .course-legend ul {\n    grid-template-columns: 1fr;\n  }\n}\n\n/* Custom animations for task completion */\n@keyframes celebrate {\n  0% { transform: scale(1); }\n  50% { transform: scale(1.1); }\n  100% { transform: scale(1); }\n}\n\n.celebrate {\n  animation: celebrate 0.5s ease-in-out;\n}\n\n/* Smooth transitions */\n.transition-all {\n  transition: all 0.3s ease;\n}\n\n/* Custom scrollbar */\n::-webkit-scrollbar {\n  width: 8px;\n}\n\n::-webkit-scrollbar-track {\n  background: #f1f1f1;\n}\n\n::-webkit-scrollbar-thumb {\n  background: #c1c1c1;\n  border-radius: 4px;\n}\n\n::-webkit-scrollbar-thumb:hover {\n  background: #a8a8a8;\n}\n\n/* ========== SEARCHABLE ASSIGNMENT SELECT ========== */\n\n/* Searchable Select Component */\n.searchable-select {\n  position: relative;\n  width: 100%;\n  max-width: 400px; /* Limit the width */\n}\n\n.select-input {\n  display: flex;\n  justify-content: space-between;\n  align-items: center;\n  padding: 10px 12px;\n  border: 1px solid #e5e7eb;\n  border-radius: 6px;\n  background: white;\n  cursor: pointer;\n  transition: border-color 0.2s;\n}\n\n.select-input:hover {\n  border-color: #d1d5db;\n}\n\n.select-input:focus-within {\n  border-color: #2D8028;\n  outline: none;\n  box-shadow: 0 0 0 3px rgba(45, 128, 40, 0.1);\n}\n\n.select-input.disabled {\n  background: #f9fafb;\n  color: #9ca3af;\n  cursor: not-allowed;\n  border-color: #e5e7eb;\n}\n\n.select-value {\n  flex: 1;\n  color: #374151;\n  font-size: 14px;\n  overflow: hidden;\n  text-overflow: ellipsis;\n  white-space: nowrap;\n}\n\n.select-arrow {\n  color: #6b7280;\n  font-size: 12px;\n  margin-left: 8px;\n}\n\n.select-dropdown {\n  position: absolute;\n  top: calc(100% + 4px);\n  left: 0;\n  right: 0;\n  background: white;\n  border: 1px solid #e5e7eb;\n  border-radius: 6px;\n  box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);\n  z-index: 1000;\n  max-height: 400px;\n  overflow: hidden;\n  display: flex;\n  flex-direction: column;\n}\n\n.search-box {\n  padding: 8px;\n  border-bottom: 1px solid #e5e7eb;\n  background: #f9fafb;\n}\n\n.search-input {\n  width: 100%;\n  padding: 8px 12px;\n  border: 1px solid #e5e7eb;\n  border-radius: 4px;\n  font-size: 14px;\n  outline: none;\n}\n\n.search-input:focus {\n  border-color: #2D8028;\n  box-shadow: 0 0 0 2px rgba(45, 128, 40, 0.1);\n}\n\n.options-list {\n  flex: 1;\n  overflow-y: auto;\n  max-height: 300px;\n}\n\n.option-group-header {\n  padding: 8px 12px;\n  font-size: 12px;\n  font-weight: 600;\n  color: #6b7280;\n  background: #f9fafb;\n  border-top: 1px solid #e5e7eb;\n  border-bottom: 1px solid #e5e7eb;\n  text-transform: uppercase;\n  letter-spacing: 0.05em;\n}\n\n.option {\n  padding: 10px 12px;\n  cursor: pointer;\n  transition: background-color 0.1s;\n  font-size: 14px;\n  color: #374151;\n  display: flex;\n  justify-content: space-between;\n  align-items: center;\n}\n\n.option:hover {\n  background: #f3f4f6;\n}\n\n.option.highlighted {\n  background: #e0f2fe;\n}\n\n.option-roles {\n  font-size: 12px;\n  color: #6b7280;\n  margin-left: 8px;\n}\n\n.no-results {\n  padding: 20px;\n  text-align: center;\n  color: #6b7280;\n  font-size: 14px;\n}\n\n/* Make sure the dropdown appears above other elements */\n.modal-content {\n  position: relative;\n  z-index: 1;\n}\n\n/* Mobile responsiveness */\n@media (max-width: 640px) {\n  .searchable-select {\n    max-width: 100%;\n  }\n  \n  .select-dropdown {\n    max-height: 300px;\n  }\n  \n  .options-list {\n    max-height: 200px;\n  }\n}\n\n/* Prevent horizontal scrolling on mobile */\n@media (max-width: 768px) {\n  html, body {\n    overflow-x: hidden;\n    max-width: 100%;\n  }\n  \n  /* Education page specific mobile optimizations */\n  .education-page {\n    padding: 12px;\n    width: 100%;\n    max-width: 100%;\n    overflow-x: hidden;\n  }\n  \n  /* Ensure all containers don't exceed viewport width */\n  .education-page > * {\n    max-width: 100%;\n    overflow-x: hidden;\n    box-sizing: border-box;\n  }\n  \n  .education-header {\n    flex-direction: column;\n    align-items: stretch;\n    gap: 12px;\n    margin-bottom: 16px;\n  }\n  \n  .education-header h1 {\n    font-size: 24px;\n    margin: 0;\n  }\n  \n  .education-header-stats {\n    flex-direction: column;\n    gap: 8px;\n    width: 100%;\n  }\n  \n  .education-header-stats > div {\n    display: flex;\n    flex-direction: column;\n    gap: 8px;\n    background: #f3f4f6;\n    padding: 12px;\n    border-radius: 8px;\n    font-size: 14px;\n  }\n  \n  .education-header-stats span {\n    text-align: center;\n    white-space: nowrap;\n    overflow: hidden;\n    text-overflow: ellipsis;\n  }\n  \n  .btn-create-course {\n    width: 100%;\n    padding: 12px;\n    font-size: 16px;\n  }\n  \n  /* Mobile dropdown filter styling */\n  .mobile-filter-dropdown {\n    width: 100%;\n  }\n  \n  .mobile-filter-dropdown button {\n    width: 100%;\n    justify-content: space-between;\n    padding: 12px 16px;\n    font-size: 14px;\n  }\n  \n  /* Course grid single column on mobile */\n  .courses-grid {\n    grid-template-columns: 1fr !important;\n    gap: 12px;\n    width: 100%;\n    max-width: 100%;\n  }\n  \n  /* Course card mobile optimizations */\n  .course-card-mobile {\n    padding: 16px;\n    position: relative;\n  }\n  \n  .course-card-mobile .course-icon {\n    font-size: 36px;\n    position: absolute;\n    top: 16px;\n    right: 16px;\n  }\n  \n  .course-card-mobile .course-header {\n    margin-right: 60px;\n  }\n  \n  .course-card-mobile .course-header h3 {\n    font-size: 18px;\n  }\n  \n  .course-card-mobile .course-description {\n    font-size: 14px;\n    margin-bottom: 12px;\n  }\n  \n  .course-card-mobile .course-meta {\n    font-size: 13px;\n  }\n  \n  /* Admin buttons mobile positioning */\n  .card-admin-actions-mobile {\n    position: absolute;\n    top: 50px;\n    right: 16px;\n    display: flex;\n    flex-direction: column;\n    gap: 4px;\n  }\n  \n  .card-admin-actions-mobile button {\n    width: 32px;\n    height: 32px;\n    padding: 4px;\n    font-size: 14px;\n  }\n  \n  /* Progress section mobile */\n  .progress-section-mobile {\n    margin: 12px 0;\n  }\n  \n  .progress-section-mobile .progress-text {\n    font-size: 13px;\n  }\n  \n  /* Prerequisites mobile */\n  .prerequisites-section-mobile {\n    margin-top: 12px;\n    padding: 8px;\n    font-size: 13px;\n  }\n  \n  .prerequisites-section-mobile .prereq-list {\n    font-size: 12px;\n  }\n  \n  /* Course action buttons mobile */\n  .course-actions-mobile {\n    margin-top: 12px;\n  }\n}\n\n/* ========== STAFF DATA CONTACT FIELDS IMPROVEMENTS ========== */\n\n/* Form row for side-by-side fields */\n.form-row {\n  display: grid;\n  grid-template-columns: 1fr 1fr;\n  gap: 16px;\n  margin-bottom: 16px;\n}\n\n/* Contact details in expanded view */\n.expanded-row {\n  background-color: #f9fafb;\n}\n\n.contact-details {\n  display: grid;\n  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));\n  gap: 24px;\n  padding: 16px;\n}\n\n.contact-section h4 {\n  margin: 0 0 8px 0;\n  color: #374151;\n  font-size: 14px;\n}\n\n.contact-section p {\n  margin: 4px 0;\n  color: #6b7280;\n}\n\n/* Personal email styling in table */\n.personal-email {\n  font-size: 0.85em;\n  color: #6b7280;\n  font-style: italic;\n}\n\n/* Small helper text in forms */\n.form-section small {\n  display: block;\n  font-size: 12px;\n  color: #6b7280;\n  margin-top: 4px;\n  font-style: italic;\n}\n\n/* Mobile responsive */\n@media (max-width: 640px) {\n  .form-row {\n    grid-template-columns: 1fr;\n  }\n  \n  .course-actions-mobile button {\n    width: 100%;\n    padding: 12px;\n    font-size: 15px;\n  }\n  \n  /* Learning Progress Card */\n  .learning-progress-card {\n    background: white;\n    padding: 16px;\n    border-radius: 8px;\n    margin-bottom: 16px;\n    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);\n    width: 100%;\n    max-width: 100%;\n    overflow: hidden;\n  }\n  \n  .learning-progress-card h2 {\n    font-size: 18px;\n    margin-bottom: 16px;\n    display: flex;\n    align-items: center;\n    gap: 8px;\n    white-space: nowrap;\n    overflow: hidden;\n    text-overflow: ellipsis;\n  }\n  \n  .progress-summary {\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n    margin-bottom: 8px;\n    gap: 8px;\n  }\n  \n  .progress-summary span {\n    font-size: 14px;\n    white-space: nowrap;\n  }\n  \n  .progress-bar-container {\n    background: #e5e7eb;\n    height: 20px;\n    border-radius: 10px;\n    overflow: hidden;\n    margin-bottom: 8px;\n    width: 100%;\n  }\n  \n  .progress-bar-fill {\n    background: #2D8028;\n    height: 100%;\n    transition: width 0.3s ease;\n  }\n  \n  .progress-details {\n    display: flex;\n    justify-content: space-between;\n    font-size: 12px;\n    color: #6b7280;\n    gap: 8px;\n  }\n  \n  .progress-details span {\n    white-space: nowrap;\n    overflow: hidden;\n    text-overflow: ellipsis;\n  }\n}\n\n/* Modal optimizations for mobile */\n@media (max-width: 768px) {\n  .modal-overlay {\n    padding: 0;\n  }\n  \n  .modal-content {\n    max-width: 100%;\n    width: 100%;\n    height: 100vh;\n    max-height: 100vh;\n    margin: 0;\n    border-radius: 0;\n    padding: 16px;\n  }\n  \n  .form-grid {\n    grid-template-columns: 1fr;\n  }\n  \n  .sections-builder {\n    max-height: 300px;\n    overflow-y: auto;\n  }\n  \n  .section-builder {\n    padding: 12px;\n  }\n  \n  /* Stack modal action buttons on mobile */\n  .modal-actions {\n    flex-direction: column;\n    gap: 12px;\n  }\n  \n  .modal-actions > div {\n    width: 100%;\n  }\n  \n  .modal-actions button {\n    width: 100%;\n  }\n}\n\n/* System Management Styles */\n.system-assignment {\n  background: white;\n  padding: 20px;\n  border-radius: 8px;\n  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);\n}\n\n.system-assignment h4 {\n  margin: 0 0 16px 0;\n  color: #1f2937;\n}\n\n.auto-suggest-badge {\n  background: #fef3c7;\n  color: #92400e;\n  padding: 8px 12px;\n  border-radius: 4px;\n  font-size: 14px;\n  margin-bottom: 16px;\n}\n\n.available-options {\n  display: flex;\n  flex-direction: column;\n  gap: 12px;\n  margin-bottom: 16px;\n}\n\n.system-option {\n  border: 1px solid #e5e7eb;\n  border-radius: 6px;\n  padding: 12px;\n  cursor: pointer;\n  transition: all 0.2s;\n}\n\n.system-option:hover {\n  border-color: #d1d5db;\n}\n\n.system-option.selected {\n  border-color: #10b981;\n  background-color: #f0fdf4;\n}\n\n.option-header {\n  display: flex;\n  align-items: center;\n  gap: 8px;\n  margin-bottom: 8px;\n}\n\n.system-name {\n  font-weight: 500;\n  color: #1f2937;\n}\n\n.section-badge {\n  background: #f3f4f6;\n  color: #6b7280;\n  padding: 2px 8px;\n  border-radius: 4px;\n  font-size: 12px;\n}\n\n.option-details {\n  display: flex;\n  align-items: center;\n  justify-content: space-between;\n  font-size: 14px;\n  color: #6b7280;\n}\n\n.capacity-bar {\n  width: 100px;\n  height: 4px;\n  background: #f3f4f6;\n  border-radius: 2px;\n  overflow: hidden;\n}\n\n.capacity-fill {\n  height: 100%;\n  background: #10b981;\n  transition: width 0.3s;\n}\n\n.btn-assign {\n  background: #10b981;\n  color: white;\n  border: none;\n  padding: 8px 16px;\n  border-radius: 6px;\n  cursor: pointer;\n  font-weight: 500;\n  transition: background-color 0.2s;\n}\n\n.btn-assign:hover {\n  background: #059669;\n}\n\n.btn-assign:disabled {\n  background: #d1d5db;\n  cursor: not-allowed;\n}\n\n.system-assignment-empty {\n  text-align: center;\n  padding: 24px;\n  color: #f59e0b;\n}\n\n/* Horizontal Scrolling Tabs */\n.scrollbar-hide {\n  -ms-overflow-style: none;  /* IE and Edge */\n  scrollbar-width: none;  /* Firefox */\n}\n\n.scrollbar-hide::-webkit-scrollbar {\n  display: none;  /* Chrome, Safari and Opera */\n}\n\n.tab-navigation-wrapper {\n  position: relative;\n  margin-bottom: 1rem;\n}\n\n.tab-navigation-wrapper > div {\n  scroll-behavior: smooth;\n}\n\n\n/* Sub-tab Navigation - Matching Production Data */\n.sub-tab-navigation {\n  display: flex;\n  gap: 8px;\n  margin-bottom: 24px;\n  overflow-x: auto;\n  overflow-y: hidden;\n  padding-bottom: 4px;\n  \n  /* Hide scrollbar but keep functionality */\n  -ms-overflow-style: none;\n  scrollbar-width: none;\n}\n\n.sub-tab-navigation::-webkit-scrollbar {\n  display: none;\n}\n\n.sub-tab-btn {\n  display: flex;\n  align-items: center;\n  gap: 6px;\n  padding: 10px 20px;\n  background: #f3f4f6;\n  border: none;\n  border-radius: 8px;\n  cursor: pointer;\n  font-size: 14px;\n  font-weight: 500;\n  color: #6b7280;\n  white-space: nowrap;\n  transition: all 0.2s;\n  flex-shrink: 0;\n}\n\n.sub-tab-btn:hover {\n  background: #e5e7eb;\n  color: #374151;\n}\n\n.sub-tab-btn.active {\n  background: #2D8028;\n  color: white;\n}\n\n/* Remove old inconsistent styles */\n.analytics-nav,\n.task-data-tabs,\n.staff-data-tabs {\n  display: none; /* Remove these old styles */\n}\n\n/* ========== EDUCATION PAGE STYLES ========== */\n\n/* Education Page */\n.education-page {\n  padding: 24px;\n  max-width: 1400px;\n  margin: 0 auto;\n}\n\n/* Page Actions */\n.page-actions {\n  display: flex;\n  justify-content: flex-end;\n  margin-bottom: 24px;\n}\n\n.btn-create-course {\n  display: flex;\n  align-items: center;\n  gap: 6px;\n  padding: 10px 20px;\n  background: #2D8028;\n  color: white;\n  border: none;\n  border-radius: 6px;\n  cursor: pointer;\n  font-size: 14px;\n  font-weight: 500;\n  transition: all 0.2s;\n}\n\n.btn-create-course:hover {\n  background: #236020;\n  transform: translateY(-1px);\n  box-shadow: 0 4px 12px rgba(45, 128, 40, 0.2);\n}\n\n/* Learning Progress Card */\n.learning-progress-card {\n  background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);\n  border: 2px solid #10b981;\n  border-radius: 12px;\n  padding: 24px;\n  margin-bottom: 32px;\n  display: flex;\n  align-items: center;\n  gap: 24px;\n  box-shadow: 0 4px 12px rgba(16, 185, 129, 0.1);\n}\n\n.progress-icon {\n  font-size: 48px;\n  opacity: 0.8;\n}\n\n.progress-content {\n  flex: 1;\n}\n\n.progress-content h3 {\n  margin: 0 0 12px 0;\n  font-size: 20px;\n  color: #065f46;\n}\n\n.progress-stats {\n  display: flex;\n  align-items: center;\n  gap: 12px;\n  margin-bottom: 16px;\n  font-size: 14px;\n  color: #047857;\n}\n\n.progress-stats .separator {\n  color: #10b981;\n}\n\n.progress-bar {\n  height: 8px;\n  background: rgba(255, 255, 255, 0.5);\n  border-radius: 4px;\n  overflow: hidden;\n  margin-bottom: 8px;\n}\n\n.progress-fill {\n  height: 100%;\n  background: #10b981;\n  transition: width 0.3s ease;\n}\n\n.progress-text {\n  font-size: 13px;\n  color: #059669;\n  font-weight: 600;\n}\n\n/* Course Filter Tabs - Matching Production Data Style */\n.course-filter-tabs {\n  display: flex;\n  gap: 8px;\n  margin-bottom: 32px;\n  overflow-x: auto;\n  padding-bottom: 4px;\n  \n  -ms-overflow-style: none;\n  scrollbar-width: none;\n}\n\n.course-filter-tabs::-webkit-scrollbar {\n  display: none;\n}\n\n.filter-tab {\n  display: flex;\n  align-items: center;\n  gap: 6px;\n  padding: 10px 20px;\n  background: #f3f4f6;\n  border: none;\n  border-radius: 8px;\n  cursor: pointer;\n  font-size: 14px;\n  font-weight: 500;\n  color: #6b7280;\n  white-space: nowrap;\n  transition: all 0.2s;\n  flex-shrink: 0;\n}\n\n.filter-tab:hover {\n  background: #e5e7eb;\n  color: #374151;\n}\n\n.filter-tab.active {\n  background: #2D8028;\n  color: white;\n}\n\n/* Courses Grid */\n.courses-grid {\n  display: grid;\n  grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));\n  gap: 24px;\n}\n\n/* Course Card */\n.course-card {\n  background: white;\n  border-radius: 12px;\n  padding: 24px;\n  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);\n  transition: all 0.3s ease;\n  position: relative;\n  overflow: hidden;\n}\n\n.course-card::before {\n  content: '';\n  position: absolute;\n  top: 0;\n  left: 0;\n  right: 0;\n  height: 4px;\n  background: #e5e7eb;\n}\n\n.course-card.completed::before {\n  background: #10b981;\n}\n\n.course-card.in-progress::before {\n  background: #f59e0b;\n}\n\n.course-card.locked {\n  opacity: 0.7;\n}\n\n.course-card:hover {\n  transform: translateY(-2px);\n  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);\n}\n\n.course-header {\n  display: flex;\n  justify-content: space-between;\n  align-items: flex-start;\n  margin-bottom: 16px;\n}\n\n.course-icon {\n  font-size: 36px;\n}\n\n.status-badge {\n  padding: 4px 12px;\n  border-radius: 6px;\n  font-size: 12px;\n  font-weight: 600;\n}\n\n.status-badge.completed {\n  background: #d1fae5;\n  color: #065f46;\n}\n\n.status-badge.in-progress {\n  background: #fef3c7;\n  color: #92400e;\n}\n\n.status-badge.not-started {\n  background: #f3f4f6;\n  color: #6b7280;\n}\n\n.status-badge.locked {\n  background: #fee2e2;\n  color: #991b1b;\n}\n\n.course-title {\n  margin: 0 0 8px 0;\n  font-size: 18px;\n  color: #1f2937;\n}\n\n.course-description {\n  margin: 0 0 16px 0;\n  font-size: 14px;\n  color: #6b7280;\n  line-height: 1.5;\n}\n\n.course-meta {\n  display: flex;\n  gap: 16px;\n  margin-bottom: 16px;\n}\n\n.meta-item {\n  display: flex;\n  align-items: center;\n  gap: 4px;\n  font-size: 13px;\n  color: #6b7280;\n}\n\n.course-awards {\n  margin-bottom: 16px;\n  padding: 12px;\n  background: #f9fafb;\n  border-radius: 6px;\n  font-size: 13px;\n}\n\n.award-label {\n  margin-right: 8px;\n  font-weight: 500;\n}\n\n.award-badge {\n  display: inline-block;\n  padding: 2px 8px;\n  background: #e0e7ff;\n  color: #3730a3;\n  border-radius: 4px;\n  font-size: 12px;\n}\n\n.completion-info {\n  margin-bottom: 16px;\n  font-size: 13px;\n  color: #059669;\n}\n\n.course-progress {\n  margin-bottom: 16px;\n}\n\n.progress-bar-small {\n  height: 6px;\n  background: #e5e7eb;\n  border-radius: 3px;\n  overflow: hidden;\n  margin-bottom: 4px;\n}\n\n.requirements-met {\n  margin-bottom: 16px;\n  padding: 8px 12px;\n  background: #d1fae5;\n  color: #065f46;\n  border-radius: 6px;\n  font-size: 13px;\n  font-weight: 500;\n  text-align: center;\n}\n\n/* Course Action Buttons */\n.course-actions {\n  margin-top: auto;\n}\n\n.btn-course {\n  width: 100%;\n  padding: 12px;\n  border: none;\n  border-radius: 6px;\n  font-size: 15px;\n  font-weight: 600;\n  cursor: pointer;\n  transition: all 0.2s;\n}\n\n.btn-course.start {\n  background: #2D8028;\n  color: white;\n}\n\n.btn-course.start:hover {\n  background: #236020;\n}\n\n.btn-course.resume {\n  background: #f59e0b;\n  color: white;\n}\n\n.btn-course.resume:hover {\n  background: #d97706;\n}\n\n.btn-course.completed {\n  background: #e5e7eb;\n  color: #6b7280;\n  cursor: default;\n}\n\n.btn-course.locked {\n  background: #f3f4f6;\n  color: #9ca3af;\n  cursor: not-allowed;\n}\n\n/* Mobile Responsive for Education */\n@media (max-width: 768px) {\n  .courses-grid {\n    grid-template-columns: 1fr;\n  }\n  \n  .learning-progress-card {\n    flex-direction: column;\n    text-align: center;\n  }\n  \n  .progress-stats {\n    justify-content: center;\n    flex-wrap: wrap;\n  }\n}\n\n/* ========== GLOBAL SPACING IMPROVEMENTS ========== */\n\n/* Page Layout Spacing */\n.page-content {\n  padding: var(--page-padding);\n}\n\n.page-section {\n  margin-bottom: var(--section-gap);\n}\n\n.page-section:last-child {\n  margin-bottom: 0;\n}\n\n/* Headers and Titles */\nh1, h2, h3, h4, h5, h6 {\n  margin-top: 0;\n  margin-bottom: var(--space-md);\n  line-height: 1.4;\n}\n\n/* Paragraphs and Text */\np {\n  margin-bottom: var(--space-md);\n  line-height: 1.6;\n}\n\np:last-child {\n  margin-bottom: 0;\n}\n\n/* Enhanced Sub-tab Navigation */\n.sub-tab-navigation {\n  display: flex;\n  gap: var(--space-sm);\n  margin-bottom: var(--space-xl);\n  padding: 6px;\n  background: #f3f4f6;\n  border-radius: 10px;\n}\n\n.sub-tab-btn {\n  padding: var(--tab-padding);\n  border-radius: 8px;\n  font-size: 15px;\n  font-weight: 500;\n}\n\n/* Cards and Containers */\n.card,\n.metric-card,\n.chart-card,\n.course-card {\n  padding: var(--card-padding);\n  margin-bottom: var(--space-lg);\n  border-radius: 12px;\n  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);\n}\n\n/* Forms and Inputs */\n.form-group {\n  margin-bottom: var(--space-lg);\n}\n\n.form-group label {\n  display: block;\n  margin-bottom: var(--space-sm);\n  font-weight: 500;\n  color: #374151;\n}\n\ninput,\nselect,\ntextarea {\n  padding: var(--input-padding);\n  border-radius: 8px;\n  border: 1px solid #e5e7eb;\n  font-size: 15px;\n  width: 100%;\n}\n\n/* Enhanced Buttons */\n.btn,\nbutton {\n  padding: var(--button-padding);\n  border-radius: 8px;\n  font-size: 15px;\n  font-weight: 500;\n  min-height: 44px;\n}\n\n/* Button Groups */\n.button-group {\n  display: flex;\n  gap: var(--space-md);\n  margin-top: var(--space-lg);\n}\n\n/* Navigation with Actions Container */\n.nav-with-actions {\n  display: flex;\n  justify-content: space-between;\n  align-items: center;\n  margin-bottom: var(--space-xl);\n  gap: var(--space-lg);\n}\n\n/* Sub-navigation stays on left */\n.sub-tab-navigation {\n  display: flex;\n  gap: var(--space-sm);\n  margin-bottom: 0; /* Remove bottom margin since parent handles it */\n  padding: 6px;\n  background: #f3f4f6;\n  border-radius: 10px;\n  flex: 1;\n  overflow-x: auto;\n  \n  -ms-overflow-style: none;\n  scrollbar-width: none;\n}\n\n.sub-tab-navigation::-webkit-scrollbar {\n  display: none;\n}\n\n/* Actions stay on right */\n.nav-actions {\n  display: flex;\n  gap: var(--space-md);\n  flex-shrink: 0;\n}\n\n/* Export/Action Buttons */\n.page-actions {\n  display: flex;\n  justify-content: flex-end;\n  margin-bottom: var(--space-xl);\n  gap: var(--space-md);\n}\n\n.btn-export,\n.btn-create,\n.page-actions button {\n  padding: var(--button-padding);\n  min-width: 160px;\n}\n\n/* Export button styling */\n.btn-export {\n  display: flex;\n  align-items: center;\n  gap: 8px;\n  padding: 12px 24px;\n  background: #2D8028;\n  color: white;\n  border: none;\n  border-radius: 8px;\n  font-size: 15px;\n  font-weight: 500;\n  cursor: pointer;\n  transition: all 0.2s;\n  white-space: nowrap;\n}\n\n.btn-export:hover {\n  background: #236020;\n  transform: translateY(-1px);\n  box-shadow: 0 4px 12px rgba(45, 128, 40, 0.2);\n}\n\n/* Tasks Page Filter Buttons Fix - Compact Version */\n.tasks-filter-container {\n  display: flex;\n  align-items: center;\n  gap: 6px;\n  margin-bottom: 20px;\n  padding: 12px 16px;\n  overflow-x: auto;\n  overflow-y: hidden;\n  white-space: nowrap;\n}\n\n.task-filter-btn {\n  height: 32px;\n  padding: 0 12px;\n  border: 1px solid #ddd;\n  background-color: #f5f5f5;\n  border-radius: 4px;\n  cursor: pointer;\n  font-size: 13px;\n  white-space: nowrap;\n  transition: all 0.2s;\n  min-width: auto;\n}\n\n.task-filter-btn:hover {\n  background-color: #e9e9e9;\n  border-color: #ccc;\n}\n\n.task-filter-btn.active {\n  background-color: #2D8028;\n  color: white;\n  border-color: #2D8028;\n}\n\n/* ULTIMATE OVERRIDE: Force exact same styling for ALL filter elements */\n.task-filters .filter-select,\n.task-filters .date-input,  \n.task-filters .search-box,\n.task-filters .search-input,\n.task-filters .btn-clear-filters,\n.task-filters .btn-new-task,\n.task-filters .btn-today,\n.task-filters .btn-refresh,\n.tasks-filter-container .filter-select,\n.tasks-filter-container .date-input,\n.tasks-filter-container .search-input,\n.tasks-filter-container .btn-clear-filters,\n.tasks-filter-container .btn-new-task,\n.tasks-filter-container .btn-today,\n.tasks-filter-container .btn-refresh {\n  height: 38px !important;\n  box-sizing: border-box !important;\n  line-height: 36px !important;\n  padding-top: 0 !important;\n  padding-bottom: 0 !important;\n  border-width: 1px !important;\n  border-style: solid !important;\n  display: inline-flex !important;\n  align-items: center !important;\n  justify-content: center !important;\n}\n\n/* Refresh Tasks Button */\n.btn-refresh {\n  display: flex;\n  align-items: center;\n  gap: 6px;\n  height: 38px;\n  padding: 0 16px;\n  background: #3b82f6;\n  color: white;\n  border: none;\n  border-radius: 6px;\n  cursor: pointer;\n  font-size: 14px;\n  font-weight: 500;\n  white-space: nowrap;\n  transition: all 0.2s;\n  box-sizing: border-box;\n}\n\n.btn-refresh:hover {\n  background: #2563eb;\n}\n\n.btn-refresh:disabled {\n  background: #9ca3af;\n  cursor: not-allowed;\n}\n\n/* Mobile compact filters */\n@media (max-width: 480px) {\n  .filter-select {\n    min-width: 70px;\n    max-width: 100px;\n    font-size: 12px;\n  }\n  \n  .search-input {\n    width: 100px;\n  }\n  \n  .task-filter-btn,\n  .btn-clear-filters,\n  .btn-new-task {\n    padding: 0 8px;\n    font-size: 12px;\n  }\n  \n  .date-input {\n    width: 85px;\n    font-size: 12px;\n  }\n}\n\n/* Task Data Page Improvements */\n.task-overview {\n  padding-top: 0;\n}\n\n.task-overview > h2:first-child,\n.staff-edit > h2:first-child {\n  display: none;\n}\n\n/* Controls and Selectors */\n.overview-controls,\n.dashboard-controls {\n  margin-bottom: var(--space-xl);\n}\n\n.date-range-selector {\n  display: flex;\n  gap: var(--space-xs);\n  padding: 6px;\n  background: #f3f4f6;\n  border-radius: 8px;\n}\n\n/* Metrics Grid */\n.metrics-grid {\n  display: grid;\n  grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));\n  gap: var(--space-lg);\n  margin-bottom: var(--space-2xl);\n}\n\n/* Charts Grid */\n.charts-grid,\n.production-charts {\n  display: grid;\n  grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));\n  gap: var(--space-lg);\n  margin-bottom: var(--space-2xl);\n}\n\n/* Staff Data Table */\n.staff-table-container {\n  background: white;\n  border-radius: 12px;\n  padding: var(--space-lg);\n  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);\n}\n\n.search-controls {\n  display: flex;\n  gap: var(--space-lg);\n  margin-bottom: var(--space-lg);\n}\n\n/* Enhanced Table Spacing */\ntable {\n  width: 100%;\n  border-collapse: separate;\n  border-spacing: 0;\n}\n\nth {\n  padding: var(--space-md);\n  text-align: left;\n  font-weight: 600;\n  background: #f9fafb;\n  border-bottom: 2px solid #e5e7eb;\n}\n\ntd {\n  padding: var(--space-md);\n  border-bottom: 1px solid #f3f4f6;\n}\n\n/* Production Data Stats */\n.production-metrics .metric-card {\n  padding: var(--space-lg);\n  display: flex;\n  flex-direction: column;\n  gap: var(--space-sm);\n  text-align: center;\n}\n\n.metric-value {\n  font-size: 36px;\n  font-weight: 700;\n  line-height: 1.2;\n  margin-bottom: var(--space-xs);\n}\n\n.metric-label {\n  font-size: 14px;\n  color: #6b7280;\n}\n\n/* Navigation Items */\n.sidebar {\n  padding: var(--space-lg) 0;\n}\n\n.nav-item {\n  padding: var(--space-md) var(--space-lg);\n  margin-bottom: var(--space-xs);\n  transition: all 0.2s;\n}\n\n.nav-section {\n  margin-top: var(--space-xl);\n  padding-top: var(--space-xl);\n  border-top: 1px solid rgba(255, 255, 255, 0.1);\n}\n\n/* Visual Hierarchy Improvements */\n.section-header {\n  margin-bottom: var(--space-lg);\n}\n\n.section-content {\n  margin-bottom: var(--space-2xl);\n}\n\n/* Better spacing for lists */\nul, ol {\n  margin-bottom: var(--space-lg);\n  padding-left: var(--space-lg);\n}\n\nli {\n  margin-bottom: var(--space-sm);\n}\n\n/* Card shadows for depth */\n.elevated-card {\n  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), \n              0 2px 4px -1px rgba(0, 0, 0, 0.06);\n}\n\n.elevated-card:hover {\n  box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), \n              0 4px 6px -2px rgba(0, 0, 0, 0.05);\n}\n\n/* Better focus states */\nbutton:focus,\ninput:focus,\nselect:focus,\ntextarea:focus {\n  outline: 2px solid #2D8028;\n  outline-offset: 2px;\n}\n\n/* Consistent border radius */\n.rounded-sm { border-radius: 4px; }\n.rounded { border-radius: 8px; }\n.rounded-lg { border-radius: 12px; }\n.rounded-xl { border-radius: 16px; }\n\n/* Mobile Responsive Spacing */\n@media (max-width: 768px) {\n  :root {\n    --page-padding: 20px;\n    --section-gap: 24px;\n    --card-padding: 20px;\n  }\n  \n  .metrics-grid,\n  .charts-grid {\n    grid-template-columns: 1fr;\n    gap: var(--space-md);\n  }\n  \n  .button-group {\n    flex-direction: column;\n  }\n  \n  .page-actions {\n    justify-content: stretch;\n  }\n  \n  .page-actions button {\n    width: 100%;\n  }\n  \n  /* Mobile: Stack navigation and actions */\n  .nav-with-actions {\n    flex-direction: column;\n    align-items: stretch;\n    gap: var(--space-md);\n  }\n  \n  .sub-tab-navigation {\n    width: 100%;\n  }\n  \n  .nav-actions {\n    justify-content: flex-end;\n  }\n  \n  .btn-export {\n    flex: 1;\n    justify-content: center;\n  }\n  \n  /* Mobile: Simplified header */\n  .app-header {\n    padding: 8px 16px;\n  }\n  \n  .page-title {\n    font-size: 16px;\n  }\n  \n  .user-info {\n    padding: 6px 12px;\n  }\n  \n  .user-name {\n    max-width: 120px;\n  }\n  \n  /* Hide welcome text on very small screens */\n  @media (max-width: 480px) {\n    .user-name {\n      max-width: 80px;\n    }\n  }\n}\n\n/* Tablet: Keep inline but reduce button text */\n@media (max-width: 1024px) {\n  .btn-export {\n    padding: 10px 16px;\n    font-size: 14px;\n  }\n}\n\n/* Admin Button Styles */\n.btn-admin {\n  background: #f97316;\n  color: white;\n  padding: 6px 12px;\n  border-radius: 6px;\n  border: none;\n  cursor: pointer;\n  font-weight: 500;\n  font-size: 12px;\n  transition: background-color 0.2s;\n}\n\n.btn-admin:hover {\n  background: #ea580c;\n}\n\n.btn-admin:disabled {\n  opacity: 0.5;\n  cursor: not-allowed;\n}\n\n/* Searchable Dropdown Styles */\n.searchable-dropdown {\n  position: relative;\n  width: 100%;\n}\n\n.dropdown-header {\n  display: flex;\n  justify-content: space-between;\n  align-items: center;\n  padding: 10px 12px;\n  border: 1px solid #d1d5db;\n  border-radius: 6px;\n  background: white;\n  cursor: pointer;\n  min-height: 42px;\n}\n\n.dropdown-header:hover {\n  border-color: #9ca3af;\n}\n\n.selected-value {\n  flex: 1;\n  overflow: hidden;\n  text-overflow: ellipsis;\n  white-space: nowrap;\n}\n\n.dropdown-arrow {\n  margin-left: 8px;\n  color: #6b7280;\n  font-size: 12px;\n}\n\n.dropdown-content {\n  position: absolute;\n  top: 100%;\n  left: 0;\n  right: 0;\n  margin-top: 4px;\n  background: white;\n  border: 1px solid #d1d5db;\n  border-radius: 6px;\n  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);\n  z-index: 1000;\n  max-height: 300px;\n  overflow: hidden;\n  display: flex;\n  flex-direction: column;\n}\n\n.dropdown-search {\n  padding: 10px 12px;\n  border: none;\n  border-bottom: 1px solid #e5e7eb;\n  outline: none;\n  font-size: 14px;\n}\n\n.dropdown-options {\n  flex: 1;\n  overflow-y: auto;\n}\n\n.dropdown-option {\n  padding: 10px 12px;\n  cursor: pointer;\n  transition: background 0.2s;\n}\n\n.dropdown-option:hover {\n  background: #f3f4f6;\n}\n\n.dropdown-option.selected {\n  background: #e0f2fe;\n  font-weight: 500;\n}\n\n.no-options {\n  padding: 20px;\n  text-align: center;\n  color: #6b7280;\n}\n\n/* Tray Option Display */\n.tray-option {\n  display: flex;\n  flex-direction: column;\n  gap: 2px;\n}\n\n.tray-id {\n  font-weight: 500;\n  font-family: monospace;\n  font-size: 14px;\n}\n\n.tray-details {\n  font-size: 12px;\n  color: #6b7280;\n}\n","path":null,"size_bytes":76671,"size_tokens":null},"client/src/components/ui/skeleton.tsx":{"content":"import { cn } from \"@/lib/utils\"\n\nfunction Skeleton({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) {\n  return (\n    <div\n      className={cn(\"animate-pulse rounded-md bg-muted\", className)}\n      {...props}\n    />\n  )\n}\n\nexport { Skeleton }\n","path":null,"size_bytes":261,"size_tokens":null},"client/src/components/ui/input-otp.tsx":{"content":"import * as React from \"react\"\nimport { OTPInput, OTPInputContext } from \"input-otp\"\nimport { Dot } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst InputOTP = React.forwardRef<\n  React.ElementRef<typeof OTPInput>,\n  React.ComponentPropsWithoutRef<typeof OTPInput>\n>(({ className, containerClassName, ...props }, ref) => (\n  <OTPInput\n    ref={ref}\n    containerClassName={cn(\n      \"flex items-center gap-2 has-[:disabled]:opacity-50\",\n      containerClassName\n    )}\n    className={cn(\"disabled:cursor-not-allowed\", className)}\n    {...props}\n  />\n))\nInputOTP.displayName = \"InputOTP\"\n\nconst InputOTPGroup = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\">\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"flex items-center\", className)} {...props} />\n))\nInputOTPGroup.displayName = \"InputOTPGroup\"\n\nconst InputOTPSlot = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\"> & { index: number }\n>(({ index, className, ...props }, ref) => {\n  const inputOTPContext = React.useContext(OTPInputContext)\n  const { char, hasFakeCaret, isActive } = inputOTPContext.slots[index]\n\n  return (\n    <div\n      ref={ref}\n      className={cn(\n        \"relative flex h-10 w-10 items-center justify-center border-y border-r border-input text-sm transition-all first:rounded-l-md first:border-l last:rounded-r-md\",\n        isActive && \"z-10 ring-2 ring-ring ring-offset-background\",\n        className\n      )}\n      {...props}\n    >\n      {char}\n      {hasFakeCaret && (\n        <div className=\"pointer-events-none absolute inset-0 flex items-center justify-center\">\n          <div className=\"h-4 w-px animate-caret-blink bg-foreground duration-1000\" />\n        </div>\n      )}\n    </div>\n  )\n})\nInputOTPSlot.displayName = \"InputOTPSlot\"\n\nconst InputOTPSeparator = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\">\n>(({ ...props }, ref) => (\n  <div ref={ref} role=\"separator\" {...props}>\n    <Dot />\n  </div>\n))\nInputOTPSeparator.displayName = \"InputOTPSeparator\"\n\nexport { InputOTP, InputOTPGroup, InputOTPSlot, InputOTPSeparator }\n","path":null,"size_bytes":2154,"size_tokens":null},"client/src/components/ui/chart.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as RechartsPrimitive from \"recharts\"\n\nimport { cn } from \"@/lib/utils\"\n\n// Format: { THEME_NAME: CSS_SELECTOR }\nconst THEMES = { light: \"\", dark: \".dark\" } as const\n\nexport type ChartConfig = {\n  [k in string]: {\n    label?: React.ReactNode\n    icon?: React.ComponentType\n  } & (\n    | { color?: string; theme?: never }\n    | { color?: never; theme: Record<keyof typeof THEMES, string> }\n  )\n}\n\ntype ChartContextProps = {\n  config: ChartConfig\n}\n\nconst ChartContext = React.createContext<ChartContextProps | null>(null)\n\nfunction useChart() {\n  const context = React.useContext(ChartContext)\n\n  if (!context) {\n    throw new Error(\"useChart must be used within a <ChartContainer />\")\n  }\n\n  return context\n}\n\nconst ChartContainer = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & {\n    config: ChartConfig\n    children: React.ComponentProps<\n      typeof RechartsPrimitive.ResponsiveContainer\n    >[\"children\"]\n  }\n>(({ id, className, children, config, ...props }, ref) => {\n  const uniqueId = React.useId()\n  const chartId = `chart-${id || uniqueId.replace(/:/g, \"\")}`\n\n  return (\n    <ChartContext.Provider value={{ config }}>\n      <div\n        data-chart={chartId}\n        ref={ref}\n        className={cn(\n          \"flex aspect-video justify-center text-xs [&_.recharts-cartesian-axis-tick_text]:fill-muted-foreground [&_.recharts-cartesian-grid_line[stroke='#ccc']]:stroke-border/50 [&_.recharts-curve.recharts-tooltip-cursor]:stroke-border [&_.recharts-dot[stroke='#fff']]:stroke-transparent [&_.recharts-layer]:outline-none [&_.recharts-polar-grid_[stroke='#ccc']]:stroke-border [&_.recharts-radial-bar-background-sector]:fill-muted [&_.recharts-rectangle.recharts-tooltip-cursor]:fill-muted [&_.recharts-reference-line_[stroke='#ccc']]:stroke-border [&_.recharts-sector[stroke='#fff']]:stroke-transparent [&_.recharts-sector]:outline-none [&_.recharts-surface]:outline-none\",\n          className\n        )}\n        {...props}\n      >\n        <ChartStyle id={chartId} config={config} />\n        <RechartsPrimitive.ResponsiveContainer>\n          {children}\n        </RechartsPrimitive.ResponsiveContainer>\n      </div>\n    </ChartContext.Provider>\n  )\n})\nChartContainer.displayName = \"Chart\"\n\nconst ChartStyle = ({ id, config }: { id: string; config: ChartConfig }) => {\n  const colorConfig = Object.entries(config).filter(\n    ([, config]) => config.theme || config.color\n  )\n\n  if (!colorConfig.length) {\n    return null\n  }\n\n  return (\n    <style\n      dangerouslySetInnerHTML={{\n        __html: Object.entries(THEMES)\n          .map(\n            ([theme, prefix]) => `\n${prefix} [data-chart=${id}] {\n${colorConfig\n  .map(([key, itemConfig]) => {\n    const color =\n      itemConfig.theme?.[theme as keyof typeof itemConfig.theme] ||\n      itemConfig.color\n    return color ? `  --color-${key}: ${color};` : null\n  })\n  .join(\"\\n\")}\n}\n`\n          )\n          .join(\"\\n\"),\n      }}\n    />\n  )\n}\n\nconst ChartTooltip = RechartsPrimitive.Tooltip\n\nconst ChartTooltipContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<typeof RechartsPrimitive.Tooltip> &\n    React.ComponentProps<\"div\"> & {\n      hideLabel?: boolean\n      hideIndicator?: boolean\n      indicator?: \"line\" | \"dot\" | \"dashed\"\n      nameKey?: string\n      labelKey?: string\n    }\n>(\n  (\n    {\n      active,\n      payload,\n      className,\n      indicator = \"dot\",\n      hideLabel = false,\n      hideIndicator = false,\n      label,\n      labelFormatter,\n      labelClassName,\n      formatter,\n      color,\n      nameKey,\n      labelKey,\n    },\n    ref\n  ) => {\n    const { config } = useChart()\n\n    const tooltipLabel = React.useMemo(() => {\n      if (hideLabel || !payload?.length) {\n        return null\n      }\n\n      const [item] = payload\n      const key = `${labelKey || item?.dataKey || item?.name || \"value\"}`\n      const itemConfig = getPayloadConfigFromPayload(config, item, key)\n      const value =\n        !labelKey && typeof label === \"string\"\n          ? config[label as keyof typeof config]?.label || label\n          : itemConfig?.label\n\n      if (labelFormatter) {\n        return (\n          <div className={cn(\"font-medium\", labelClassName)}>\n            {labelFormatter(value, payload)}\n          </div>\n        )\n      }\n\n      if (!value) {\n        return null\n      }\n\n      return <div className={cn(\"font-medium\", labelClassName)}>{value}</div>\n    }, [\n      label,\n      labelFormatter,\n      payload,\n      hideLabel,\n      labelClassName,\n      config,\n      labelKey,\n    ])\n\n    if (!active || !payload?.length) {\n      return null\n    }\n\n    const nestLabel = payload.length === 1 && indicator !== \"dot\"\n\n    return (\n      <div\n        ref={ref}\n        className={cn(\n          \"grid min-w-[8rem] items-start gap-1.5 rounded-lg border border-border/50 bg-background px-2.5 py-1.5 text-xs shadow-xl\",\n          className\n        )}\n      >\n        {!nestLabel ? tooltipLabel : null}\n        <div className=\"grid gap-1.5\">\n          {payload.map((item, index) => {\n            const key = `${nameKey || item.name || item.dataKey || \"value\"}`\n            const itemConfig = getPayloadConfigFromPayload(config, item, key)\n            const indicatorColor = color || item.payload.fill || item.color\n\n            return (\n              <div\n                key={item.dataKey}\n                className={cn(\n                  \"flex w-full flex-wrap items-stretch gap-2 [&>svg]:h-2.5 [&>svg]:w-2.5 [&>svg]:text-muted-foreground\",\n                  indicator === \"dot\" && \"items-center\"\n                )}\n              >\n                {formatter && item?.value !== undefined && item.name ? (\n                  formatter(item.value, item.name, item, index, item.payload)\n                ) : (\n                  <>\n                    {itemConfig?.icon ? (\n                      <itemConfig.icon />\n                    ) : (\n                      !hideIndicator && (\n                        <div\n                          className={cn(\n                            \"shrink-0 rounded-[2px] border-[--color-border] bg-[--color-bg]\",\n                            {\n                              \"h-2.5 w-2.5\": indicator === \"dot\",\n                              \"w-1\": indicator === \"line\",\n                              \"w-0 border-[1.5px] border-dashed bg-transparent\":\n                                indicator === \"dashed\",\n                              \"my-0.5\": nestLabel && indicator === \"dashed\",\n                            }\n                          )}\n                          style={\n                            {\n                              \"--color-bg\": indicatorColor,\n                              \"--color-border\": indicatorColor,\n                            } as React.CSSProperties\n                          }\n                        />\n                      )\n                    )}\n                    <div\n                      className={cn(\n                        \"flex flex-1 justify-between leading-none\",\n                        nestLabel ? \"items-end\" : \"items-center\"\n                      )}\n                    >\n                      <div className=\"grid gap-1.5\">\n                        {nestLabel ? tooltipLabel : null}\n                        <span className=\"text-muted-foreground\">\n                          {itemConfig?.label || item.name}\n                        </span>\n                      </div>\n                      {item.value && (\n                        <span className=\"font-mono font-medium tabular-nums text-foreground\">\n                          {item.value.toLocaleString()}\n                        </span>\n                      )}\n                    </div>\n                  </>\n                )}\n              </div>\n            )\n          })}\n        </div>\n      </div>\n    )\n  }\n)\nChartTooltipContent.displayName = \"ChartTooltip\"\n\nconst ChartLegend = RechartsPrimitive.Legend\n\nconst ChartLegendContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> &\n    Pick<RechartsPrimitive.LegendProps, \"payload\" | \"verticalAlign\"> & {\n      hideIcon?: boolean\n      nameKey?: string\n    }\n>(\n  (\n    { className, hideIcon = false, payload, verticalAlign = \"bottom\", nameKey },\n    ref\n  ) => {\n    const { config } = useChart()\n\n    if (!payload?.length) {\n      return null\n    }\n\n    return (\n      <div\n        ref={ref}\n        className={cn(\n          \"flex items-center justify-center gap-4\",\n          verticalAlign === \"top\" ? \"pb-3\" : \"pt-3\",\n          className\n        )}\n      >\n        {payload.map((item) => {\n          const key = `${nameKey || item.dataKey || \"value\"}`\n          const itemConfig = getPayloadConfigFromPayload(config, item, key)\n\n          return (\n            <div\n              key={item.value}\n              className={cn(\n                \"flex items-center gap-1.5 [&>svg]:h-3 [&>svg]:w-3 [&>svg]:text-muted-foreground\"\n              )}\n            >\n              {itemConfig?.icon && !hideIcon ? (\n                <itemConfig.icon />\n              ) : (\n                <div\n                  className=\"h-2 w-2 shrink-0 rounded-[2px]\"\n                  style={{\n                    backgroundColor: item.color,\n                  }}\n                />\n              )}\n              {itemConfig?.label}\n            </div>\n          )\n        })}\n      </div>\n    )\n  }\n)\nChartLegendContent.displayName = \"ChartLegend\"\n\n// Helper to extract item config from a payload.\nfunction getPayloadConfigFromPayload(\n  config: ChartConfig,\n  payload: unknown,\n  key: string\n) {\n  if (typeof payload !== \"object\" || payload === null) {\n    return undefined\n  }\n\n  const payloadPayload =\n    \"payload\" in payload &&\n    typeof payload.payload === \"object\" &&\n    payload.payload !== null\n      ? payload.payload\n      : undefined\n\n  let configLabelKey: string = key\n\n  if (\n    key in payload &&\n    typeof payload[key as keyof typeof payload] === \"string\"\n  ) {\n    configLabelKey = payload[key as keyof typeof payload] as string\n  } else if (\n    payloadPayload &&\n    key in payloadPayload &&\n    typeof payloadPayload[key as keyof typeof payloadPayload] === \"string\"\n  ) {\n    configLabelKey = payloadPayload[\n      key as keyof typeof payloadPayload\n    ] as string\n  }\n\n  return configLabelKey in config\n    ? config[configLabelKey]\n    : config[key as keyof typeof config]\n}\n\nexport {\n  ChartContainer,\n  ChartTooltip,\n  ChartTooltipContent,\n  ChartLegend,\n  ChartLegendContent,\n  ChartStyle,\n}\n","path":null,"size_bytes":10481,"size_tokens":null},"PROJECT_BRIEF.md":{"content":"# Grow Space Task App 2.0\n\n## Overview\nTask management system for Grow Space Vertical Farms replacing Power Apps solution.\n\n## Users\n- Farm Technicians: Complete daily tasks (seeding, harvesting, cleaning)\n- Managers: Oversee operations, view analytics\n- Corporate: Create training, manage multiple locations\n\n## Key Features\n1. **Task Manager**: Daily tasks with checklists, timing, and data collection\n2. **Inventory**: Track supplies, automated reorder alerts  \n3. **Education**: Training modules that unlock roles\n4. **Analytics**: Performance tracking and insights\n\n## Design System\n- Colors: #F5F5F5 (bg), #FFFFFF (cards), #203B17 (accent), #2D8028 (buttons)\n- Style: Clean, modern, mobile-first, slightly playful\n- Use emojis: üå± for seeding, üåø for growing, ü•¨ for harvest\n- Add micro-celebrations (confetti on task completion)\n\n## Technical Requirements\n- React + TypeScript\n- Mobile responsive\n- Mock auth for development (3 test users)\n- Eventually: Teams SSO, QuickBooks sync\n\n## Task Types\n- Seeding (plant new trays)\n- Moving (relocate plants between systems)\n- Harvesting (collect mature plants, track weights)\n- Packing (prepare orders)\n- Cleaning (sanitation tasks)\n- Inventory (monthly audits)\n\n## Special Features\n- Tasks can include checklists with data collection steps\n- Recurring tasks auto-generate daily tasks\n- Time tracking on all tasks\n- Manager approval required for new staff\n","path":null,"size_bytes":1412,"size_tokens":null},"client/src/components/RecurringTaskModal.tsx":{"content":"import React, { useState } from 'react';\nimport { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle } from '@/components/ui/dialog';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { Label } from '@/components/ui/label';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { Textarea } from '@/components/ui/textarea';\nimport { Checkbox } from '@/components/ui/checkbox';\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Badge } from '@/components/ui/badge';\nimport { useQuery } from '@tanstack/react-query';\nimport { RecurringTask, GrowingSystem } from '@shared/schema';\nimport ChecklistBuilder from './ChecklistBuilder';\nimport SearchableAssignmentSelect from './SearchableAssignmentSelect';\nimport { Calendar, Clock, Settings, CheckSquare, Building2, Repeat } from 'lucide-react';\nimport { useLocation } from '@/contexts/LocationContext';\nimport UpdatePropagationWarningDialog from './UpdatePropagationWarningDialog';\n\ninterface RecurringTaskModalProps {\n  task: RecurringTask | null;\n  isOpen: boolean;\n  onClose: () => void;\n  onSave: (taskData: any) => void;\n}\n\nconst RecurringTaskModal: React.FC<RecurringTaskModalProps> = ({ task, isOpen, onClose, onSave }) => {\n  const [activeTab, setActiveTab] = useState('basic');\n  const { currentLocation } = useLocation();\n  const [originalData, setOriginalData] = useState<any>(null);\n  const [hasChanges, setHasChanges] = useState(false);\n  const [isSaving, setIsSaving] = useState(false);\n  const [showWarningDialog, setShowWarningDialog] = useState(false);\n  const [affectedInstanceCount, setAffectedInstanceCount] = useState(0);\n  const [changedFields, setChangedFields] = useState<Array<{ field: string; oldValue: any; newValue: any; requiresNotification: boolean }>>([]);\n  const [isProcessingUpdate, setIsProcessingUpdate] = useState(false);\n  const [processingProgress, setProcessingProgress] = useState<{ current: number; total: number; stage: string } | undefined>();\n  const [assignmentOptions, setAssignmentOptions] = useState<{\n    roles: { value: string; label: string; staffCount: number }[];\n    users: { value: string; label: string; roles: string[] }[];\n    special: { value: string; label: string; staffCount: number }[];\n  }>({\n    roles: [],\n    users: [],\n    special: []\n  });\n  const [loadingAssignments, setLoadingAssignments] = useState(false);\n  const [formData, setFormData] = useState<{\n    title: string;\n    description: string;\n    type: string;\n    frequency: string;\n    daysOfWeek: string[];\n    isActive: boolean;\n    assignTo: string;\n    automation: {\n      enabled: boolean;\n      generateTrays: boolean;\n      trayCount: number;\n      cropType: string;\n      flow: {\n        type: string;\n        stages: any[];\n      };\n    };\n    checklistTemplate: { steps: any[] };\n  }>({\n    title: '',\n    description: '',\n    type: 'seeding-microgreens',\n    frequency: 'weekly',\n    daysOfWeek: [] as string[],\n    isActive: true,\n    assignTo: '',\n    automation: {\n      enabled: false,\n      generateTrays: false,\n      trayCount: 1,\n      cropType: 'microgreen',\n      flow: {\n        type: 'microgreen',\n        stages: []\n      }\n    },\n    checklistTemplate: { steps: [] }\n  });\n\n  // HARD RESET: Clear all state when task changes or modal opens\n  React.useEffect(() => {\n    console.log('üîÑ HARD RESET - RecurringTaskModal task changed:', task?.id || 'new task');\n    \n    // Reset all state to clean slate\n    setActiveTab('basic');\n    setShowWarningDialog(false);\n    setAffectedInstanceCount(0);\n    setChangedFields([]);\n    setIsProcessingUpdate(false);\n    setProcessingProgress(undefined);\n    \n    if (task) {\n      const taskData = {\n        title: task.title || '',\n        description: task.description || '',\n        type: task.type || 'seeding-microgreens',\n        frequency: task.frequency || 'weekly',\n        daysOfWeek: task.daysOfWeek || [],\n        isActive: task.isActive ?? true,\n        assignTo: task.assignTo || 'no-assignment',\n        automation: task.automation || {\n          enabled: false,\n          generateTrays: false,\n          trayCount: 1,\n          cropType: 'microgreen',\n          flow: {\n            type: 'microgreen',\n            stages: []\n          }\n        },\n        checklistTemplate: task.checklistTemplate || { steps: [] }\n      };\n      setFormData(taskData);\n      setOriginalData(taskData);\n      setHasChanges(false);\n    } else {\n      // Reset form for new task - ensure completely clean state\n      const newTaskData = {\n        title: '',\n        description: '',\n        type: 'seeding-microgreens',\n        frequency: 'weekly',\n        daysOfWeek: [],\n        isActive: true,\n        assignTo: 'no-assignment',\n        automation: {\n          enabled: false,\n          generateTrays: false,\n          trayCount: 1,\n          cropType: 'microgreen',\n          flow: {\n            type: 'microgreen',\n            stages: []\n          }\n        },\n        checklistTemplate: { steps: [] }\n      };\n      setFormData(newTaskData);\n      setOriginalData(newTaskData);\n      setHasChanges(false);\n    }\n    setIsSaving(false);\n    console.log('‚úÖ HARD RESET complete - Clean state initialized');\n  }, [task?.id]);\n\n  // Load assignment options when modal opens\n  React.useEffect(() => {\n    if (isOpen) {\n      loadAssignmentOptions();\n    }\n  }, [isOpen]);\n\n  // Function to load staff and build assignment options\n  const loadAssignmentOptions = async () => {\n    setLoadingAssignments(true);\n    \n    try {\n      // Fetch staff data\n      const response = await fetch('/api/staff');\n      const staff = await response.json();\n      \n      // Filter active staff only\n      const activeStaff = staff.filter((s: any) => s.activeStatus === 'Active');\n      \n      // Build roles with staff counts\n      const rolesMap: Record<string, any[]> = {};\n      activeStaff.forEach((member: any) => {\n        (member.rolesAssigned || []).forEach((role: string) => {\n          if (!rolesMap[role]) {\n            rolesMap[role] = [];\n          }\n          rolesMap[role].push(member);\n        });\n      });\n      \n      // Format options\n      const options = {\n        special: [{\n          value: 'all_staff',\n          label: 'üë• All Staff',\n          staffCount: activeStaff.length\n        }],\n        roles: Object.entries(rolesMap).map(([role, members]) => ({\n          value: `role_${role}`,\n          label: `üë§ ${role}`,\n          staffCount: members.length\n        })),\n        users: activeStaff.map((member: any) => ({\n          value: `user_${member.id}`,\n          label: member.fullName,\n          roles: member.rolesAssigned\n        }))\n      };\n      \n      setAssignmentOptions(options);\n    } catch (error) {\n      console.error('Error loading assignment options:', error);\n    }\n    \n    setLoadingAssignments(false);\n  };\n\n  // Warn if user tries to leave with unsaved changes\n  React.useEffect(() => {\n    const handleBeforeUnload = (e: BeforeUnloadEvent) => {\n      if (hasChanges && isOpen) {\n        e.preventDefault();\n        e.returnValue = '';\n      }\n    };\n    \n    window.addEventListener('beforeunload', handleBeforeUnload);\n    return () => window.removeEventListener('beforeunload', handleBeforeUnload);\n  }, [hasChanges, isOpen]);\n\n  const { data: systems = [] } = useQuery<GrowingSystem[]>({\n    queryKey: ['/api/growing-systems'],\n    queryFn: async () => {\n      const response = await fetch('/api/growing-systems');\n      if (!response.ok) throw new Error('Failed to fetch growing systems');\n      return response.json();\n    },\n  });\n\n  const taskTypes = [\n    { value: 'seeding-microgreens', label: 'üå± Seeding - Microgreens' },\n    { value: 'seeding-leafy-greens', label: 'ü•¨ Seeding - Leafy Greens' },\n    { value: 'harvest-microgreens', label: '‚úÇÔ∏è Harvest - Microgreens' },\n    { value: 'harvest-leafy-greens', label: 'ü•ó Harvest - Leafy Greens' },\n    { value: 'blackout-tasks', label: 'üåë Blackout Tasks' },\n    { value: 'moving', label: 'üì¶ Moving' },\n    { value: 'cleaning', label: 'üßπ Cleaning' },\n    { value: 'equipment-maintenance', label: 'üîß Equipment Maintenance' },\n    { value: 'inventory', label: 'üìä Inventory' },\n    { value: 'other', label: 'üìã Other' }\n  ];\n\n  const frequencies = [\n    { value: 'weekly', label: 'Weekly' },\n    { value: 'bi-weekly', label: 'Bi-Weekly (1st & 15th)' },\n    { value: 'monthly', label: 'Monthly (Last Day)' },\n    { value: 'quarterly', label: 'Quarterly' }\n  ];\n\n  const daysOfWeek = [\n    { value: 'monday', label: 'Monday' },\n    { value: 'tuesday', label: 'Tuesday' },\n    { value: 'wednesday', label: 'Wednesday' },\n    { value: 'thursday', label: 'Thursday' },\n    { value: 'friday', label: 'Friday' },\n    { value: 'saturday', label: 'Saturday' },\n    { value: 'sunday', label: 'Sunday' }\n  ];\n\n  // Helper function to update form data and track changes\n  const updateFormData = (updates: any) => {\n    setFormData(prev => ({ ...prev, ...updates }));\n    setHasChanges(true);\n  };\n\n  const handleDayToggle = (day: string) => {\n    const newDays = formData.daysOfWeek.includes(day)\n      ? formData.daysOfWeek.filter(d => d !== day)\n      : [...formData.daysOfWeek, day];\n    \n    updateFormData({ daysOfWeek: newDays });\n  };\n\n  const handleChecklistChange = (steps: any[]) => {\n    updateFormData({\n      checklistTemplate: { steps }\n    });\n  };\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault();\n    if (!hasChanges && task) {\n      onClose();\n      return;\n    }\n    \n    // For existing tasks, check for impact and show warning dialog\n    if (task && hasChanges) {\n      try {\n        // Calculate changed fields\n        const changes = identifyChangedFields(originalData, formData);\n        setChangedFields(changes);\n        \n        // Fetch affected instance count\n        const response = await fetch(`/api/tasks?recurringTaskId=${task.id}`);\n        const allTasks = await response.json();\n        const futureInstances = allTasks.filter((t: any) => \n          t.recurringTaskId === task.id && \n          (t.status === 'pending' || t.status === 'in_progress') &&\n          new Date(t.dueDate) >= new Date()\n        );\n        \n        setAffectedInstanceCount(futureInstances.length);\n        \n        // Show warning dialog if there are changes and affected instances\n        if (changes.length > 0 && futureInstances.length > 0) {\n          setShowWarningDialog(true);\n          return;\n        }\n      } catch (error) {\n        console.error('Error checking task impact:', error);\n      }\n    }\n    \n    // Proceed with save for new tasks or tasks with no instances\n    await performSave('update_all');\n  };\n  \n  const performSave = async (strategy: 'update_all' | 'new_only') => {\n    setIsSaving(true);\n    setIsProcessingUpdate(true);\n    \n    try {\n      // Simulate progress tracking for large updates\n      if (affectedInstanceCount > 50) {\n        const intervals = Math.min(10, Math.floor(affectedInstanceCount / 10));\n        for (let i = 1; i <= intervals; i++) {\n          setProcessingProgress({\n            current: Math.floor((i / intervals) * affectedInstanceCount),\n            total: affectedInstanceCount,\n            stage: i === intervals ? 'Finalizing changes...' : 'Updating task instances...'\n          });\n          await new Promise(resolve => setTimeout(resolve, 200));\n        }\n      }\n      \n      await onSave({\n        ...formData,\n        id: task?.id,\n        location: currentLocation.name,\n        strategy: strategy\n      });\n      \n      // Show completion state briefly\n      setProcessingProgress(undefined);\n      await new Promise(resolve => setTimeout(resolve, 1500));\n      \n      // onClose will be called by the parent component on successful save\n    } catch (error) {\n      console.error('Failed to save recurring task:', error);\n      setIsSaving(false);\n      setIsProcessingUpdate(false);\n      setProcessingProgress(undefined);\n    }\n  };\n  \n  // Helper function to identify changed fields\n  const identifyChangedFields = (original: any, current: any): Array<{ field: string; oldValue: any; newValue: any; requiresNotification: boolean }> => {\n    const changes: Array<{ field: string; oldValue: any; newValue: any; requiresNotification: boolean }> = [];\n    const notificationRequiredFields = ['title', 'description', 'checklistTemplate', 'estimatedTime', 'priority', 'assignTo'];\n    \n    Object.keys(current).forEach(field => {\n      if (JSON.stringify(original[field]) !== JSON.stringify(current[field])) {\n        changes.push({\n          field,\n          oldValue: original[field],\n          newValue: current[field],\n          requiresNotification: notificationRequiredFields.includes(field)\n        });\n      }\n    });\n    \n    return changes;\n  };\n  \n  const handleWarningConfirm = (strategy: 'update_all' | 'new_only') => {\n    setShowWarningDialog(false);\n    performSave(strategy);\n  };\n  \n  const handleWarningCancel = () => {\n    setShowWarningDialog(false);\n  };\n\n  const handleCancel = () => {\n    if (hasChanges) {\n      if (confirm('You have unsaved changes. Are you sure you want to cancel?')) {\n        setHasChanges(false);\n        onClose();\n      }\n    } else {\n      onClose();\n    }\n  };\n\n  const addFlowStage = () => {\n    const newStage = {\n      name: '',\n      system: '',\n      duration: 1,\n      autoMove: false\n    };\n    \n    updateFormData({\n      automation: {\n        ...formData.automation,\n        flow: {\n          ...formData.automation.flow,\n          stages: [...formData.automation.flow.stages, newStage]\n        }\n      }\n    });\n  };\n\n  const updateFlowStage = (index: number, field: string, value: any) => {\n    const stages = [...formData.automation.flow.stages];\n    stages[index] = { ...stages[index], [field]: value };\n    \n    updateFormData({\n      automation: {\n        ...formData.automation,\n        flow: {\n          ...formData.automation.flow,\n          stages\n        }\n      }\n    });\n  };\n\n  const removeFlowStage = (index: number) => {\n    const stages = formData.automation.flow.stages.filter((_, i) => i !== index);\n    updateFormData({\n      automation: {\n        ...formData.automation,\n        flow: {\n          ...formData.automation.flow,\n          stages\n        }\n      }\n    });\n  };\n\n  return (\n    <Dialog open={isOpen} onOpenChange={onClose}>\n      <DialogContent className=\"max-w-4xl max-h-[90vh] overflow-y-auto\">\n        <DialogHeader>\n          <DialogTitle>\n            {task ? 'Edit Recurring Task' : 'Create Recurring Task'}\n          </DialogTitle>\n          <DialogDescription>\n            {task ? 'Modify the recurring task settings and checklist.' : 'Create a new recurring task with custom scheduling and automation.'}\n          </DialogDescription>\n        </DialogHeader>\n\n        <form onSubmit={handleSubmit}>\n          <Tabs value={activeTab} onValueChange={setActiveTab}>\n            <TabsList className=\"grid w-full grid-cols-4\">\n              <TabsTrigger value=\"basic\" className=\"flex items-center gap-2\">\n                <Calendar className=\"w-4 h-4\" />\n                Basic\n              </TabsTrigger>\n              <TabsTrigger value=\"schedule\" className=\"flex items-center gap-2\">\n                <Clock className=\"w-4 h-4\" />\n                Schedule\n              </TabsTrigger>\n              <TabsTrigger value=\"automation\" className=\"flex items-center gap-2\">\n                <Settings className=\"w-4 h-4\" />\n                Automation\n              </TabsTrigger>\n              <TabsTrigger value=\"checklist\" className=\"flex items-center gap-2\">\n                <CheckSquare className=\"w-4 h-4\" />\n                Checklist\n              </TabsTrigger>\n            </TabsList>\n\n            <TabsContent value=\"basic\" className=\"space-y-4\">\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"title\">Task Title</Label>\n                  <Input\n                    id=\"title\"\n                    value={formData.title}\n                    onChange={(e) => updateFormData({ title: e.target.value })}\n                    placeholder=\"Enter task title\"\n                    required\n                  />\n                </div>\n                \n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"type\">Task Type</Label>\n                  <Select\n                    value={formData.type}\n                    onValueChange={(value) => updateFormData({ type: value })}\n                  >\n                    <SelectTrigger>\n                      <SelectValue />\n                    </SelectTrigger>\n                    <SelectContent>\n                      {taskTypes.map(type => (\n                        <SelectItem key={type.value} value={type.value}>\n                          {type.label}\n                        </SelectItem>\n                      ))}\n                    </SelectContent>\n                  </Select>\n                </div>\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"description\">Description</Label>\n                <Textarea\n                  id=\"description\"\n                  value={formData.description}\n                  onChange={(e) => updateFormData({ description: e.target.value })}\n                  placeholder=\"Enter task description\"\n                  rows={3}\n                />\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"assignTo\">Default Assignment</Label>\n                <SearchableAssignmentSelect\n                  value={formData.assignTo || ''}\n                  onChange={(value) => updateFormData({ assignTo: value })}\n                  assignmentOptions={assignmentOptions}\n                  disabled={loadingAssignments}\n                  placeholder={loadingAssignments ? \"Loading assignments...\" : \"Search or select assignment...\"}\n                />\n                <p className=\"text-sm text-gray-600\">\n                  When this recurring task generates daily tasks, they will be automatically assigned to this selection\n                </p>\n              </div>\n\n              <div className=\"flex items-center space-x-2\">\n                <Checkbox\n                  id=\"isActive\"\n                  checked={formData.isActive}\n                  onCheckedChange={(checked) => updateFormData({ isActive: !!checked })}\n                />\n                <Label htmlFor=\"isActive\">Active task (will generate instances)</Label>\n              </div>\n            </TabsContent>\n\n            <TabsContent value=\"schedule\" className=\"space-y-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"frequency\">Frequency</Label>\n                <Select\n                  value={formData.frequency}\n                  onValueChange={(value) => updateFormData({ frequency: value })}\n                >\n                  <SelectTrigger>\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {frequencies.map(freq => (\n                      <SelectItem key={freq.value} value={freq.value}>\n                        {freq.label}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n\n              {/* Show day selection only for weekly frequency */}\n              {formData.frequency === 'weekly' && (\n                <div className=\"space-y-2\">\n                  <Label>Days of Week</Label>\n                  <div className=\"grid grid-cols-4 gap-2\">\n                    {daysOfWeek.map(day => (\n                      <div key={day.value} className=\"flex items-center space-x-2\">\n                        <Checkbox\n                          id={day.value}\n                          checked={formData.daysOfWeek.includes(day.value)}\n                          onCheckedChange={() => handleDayToggle(day.value)}\n                        />\n                        <Label htmlFor={day.value} className=\"text-sm\">\n                          {day.label}\n                        </Label>\n                      </div>\n                    ))}\n                  </div>\n                </div>\n              )}\n\n              {/* Show explanation for bi-weekly tasks */}\n              {formData.frequency === 'bi-weekly' && (\n                <div className=\"bg-blue-50 border border-blue-200 rounded-lg p-4 space-y-2\">\n                  <h4 className=\"font-medium text-blue-900\">üìÖ Bi-Weekly Schedule</h4>\n                  <ul className=\"text-sm text-blue-800 space-y-1\">\n                    <li>‚Ä¢ Task appears on <strong>1st of month</strong> ‚Üí Due on <strong>14th</strong></li>\n                    <li>‚Ä¢ Task appears on <strong>15th of month</strong> ‚Üí Due on <strong>last day</strong></li>\n                  </ul>\n                  <p className=\"text-xs text-blue-600 mt-2\">\n                    Two tasks per month with ample time to complete each one.\n                  </p>\n                </div>\n              )}\n\n              {/* Show explanation for monthly tasks */}\n              {formData.frequency === 'monthly' && (\n                <div className=\"bg-green-50 border border-green-200 rounded-lg p-4 space-y-2\">\n                  <h4 className=\"font-medium text-green-900\">üìÖ Monthly Schedule</h4>\n                  <p className=\"text-sm text-green-800\">\n                    Task appears on the <strong>1st of each month</strong> and is due on the <strong>last day of the month</strong>.\n                  </p>\n                  <p className=\"text-xs text-green-600 mt-2\">\n                    Full month to complete the task with early visibility.\n                  </p>\n                </div>\n              )}\n\n              {/* Show explanation for quarterly tasks */}\n              {formData.frequency === 'quarterly' && (\n                <div className=\"bg-purple-50 border border-purple-200 rounded-lg p-4 space-y-2\">\n                  <h4 className=\"font-medium text-purple-900\">üìÖ Quarterly Schedule</h4>\n                  <ul className=\"text-sm text-purple-800 space-y-1\">\n                    <li>‚Ä¢ <strong>Q1:</strong> Appears Jan 1st ‚Üí Due Mar 31st</li>\n                    <li>‚Ä¢ <strong>Q2:</strong> Appears Apr 1st ‚Üí Due Jun 30th</li>\n                    <li>‚Ä¢ <strong>Q3:</strong> Appears Jul 1st ‚Üí Due Sep 30th</li>\n                    <li>‚Ä¢ <strong>Q4:</strong> Appears Oct 1st ‚Üí Due Dec 31st</li>\n                  </ul>\n                  <p className=\"text-xs text-purple-600 mt-2\">\n                    Full quarter (3 months) to complete each task with maximum planning time.\n                  </p>\n                </div>\n              )}\n            </TabsContent>\n\n            <TabsContent value=\"automation\" className=\"space-y-4\">\n              <div className=\"flex items-center space-x-2\">\n                <Checkbox\n                  id=\"automationEnabled\"\n                  checked={formData.automation.enabled}\n                  onCheckedChange={(checked) => updateFormData({\n                    automation: { ...formData.automation, enabled: !!checked }\n                  })}\n                />\n                <Label htmlFor=\"automationEnabled\">Enable automation features</Label>\n              </div>\n\n              {formData.automation.enabled && (\n                <div className=\"space-y-4\">\n                  <div className=\"flex items-center space-x-2\">\n                    <Checkbox\n                      id=\"generateTrays\"\n                      checked={formData.automation.generateTrays}\n                      onCheckedChange={(checked) => updateFormData({\n                        automation: { ...formData.automation, generateTrays: !!checked }\n                      })}\n                    />\n                    <Label htmlFor=\"generateTrays\">Auto-generate trays</Label>\n                  </div>\n\n                  {formData.automation.generateTrays && (\n                    <div className=\"grid grid-cols-2 gap-4\">\n                      <div className=\"space-y-2\">\n                        <Label htmlFor=\"trayCount\">Tray Count</Label>\n                        <Input\n                          id=\"trayCount\"\n                          type=\"number\"\n                          value={formData.automation.trayCount}\n                          onChange={(e) => updateFormData({\n                            automation: { \n                              ...formData.automation, \n                              trayCount: parseInt(e.target.value) || 1 \n                            }\n                          })}\n                          min=\"1\"\n                          max=\"50\"\n                        />\n                      </div>\n\n                      <div className=\"space-y-2\">\n                        <Label htmlFor=\"cropType\">Crop Type</Label>\n                        <Select\n                          value={formData.automation.cropType}\n                          onValueChange={(value) => updateFormData({\n                            automation: { ...formData.automation, cropType: value }\n                          })}\n                        >\n                          <SelectTrigger>\n                            <SelectValue />\n                          </SelectTrigger>\n                          <SelectContent>\n                            <SelectItem value=\"microgreen\">Microgreen</SelectItem>\n                            <SelectItem value=\"leafy-green\">Leafy Green</SelectItem>\n                            <SelectItem value=\"herb\">Herb</SelectItem>\n                          </SelectContent>\n                        </Select>\n                      </div>\n                    </div>\n                  )}\n\n                  <Card>\n                    <CardHeader>\n                      <CardTitle className=\"flex items-center gap-2\">\n                        <Repeat className=\"w-5 h-5\" />\n                        Production Flow\n                      </CardTitle>\n                    </CardHeader>\n                    <CardContent className=\"space-y-4\">\n                      {formData.automation.flow.stages.map((stage, index) => (\n                        <div key={index} className=\"flex items-center gap-3 p-3 border rounded-lg\">\n                          <div className=\"flex-1 grid grid-cols-3 gap-2\">\n                            <Input\n                              placeholder=\"Stage name\"\n                              value={stage.name}\n                              onChange={(e) => updateFlowStage(index, 'name', e.target.value)}\n                            />\n                            <Select\n                              value={stage.system}\n                              onValueChange={(value) => updateFlowStage(index, 'system', value)}\n                            >\n                              <SelectTrigger>\n                                <SelectValue placeholder=\"Select system\" />\n                              </SelectTrigger>\n                              <SelectContent>\n                                {systems.map(system => (\n                                  <SelectItem key={system.id} value={system.name}>\n                                    {system.name}\n                                  </SelectItem>\n                                ))}\n                              </SelectContent>\n                            </Select>\n                            <Input\n                              type=\"number\"\n                              placeholder=\"Duration (days)\"\n                              value={stage.duration}\n                              onChange={(e) => updateFlowStage(index, 'duration', parseInt(e.target.value) || 1)}\n                              min=\"1\"\n                              max=\"365\"\n                            />\n                          </div>\n                          <div className=\"flex items-center space-x-2\">\n                            <Checkbox\n                              checked={stage.autoMove}\n                              onCheckedChange={(checked) => updateFlowStage(index, 'autoMove', !!checked)}\n                            />\n                            <Label className=\"text-sm\">Auto-move</Label>\n                          </div>\n                          <Button\n                            type=\"button\"\n                            variant=\"outline\"\n                            size=\"sm\"\n                            onClick={() => removeFlowStage(index)}\n                            className=\"text-red-600\"\n                          >\n                            Remove\n                          </Button>\n                        </div>\n                      ))}\n                      <Button\n                        type=\"button\"\n                        variant=\"outline\"\n                        onClick={addFlowStage}\n                        className=\"w-full\"\n                      >\n                        + Add Stage\n                      </Button>\n                    </CardContent>\n                  </Card>\n                </div>\n              )}\n            </TabsContent>\n\n            <TabsContent value=\"checklist\" className=\"space-y-4\">\n              <ChecklistBuilder\n                template={formData.checklistTemplate}\n                systems={systems}\n                onChange={handleChecklistChange}\n              />\n              {formData.checklistTemplate.steps.length > 0 && (\n                <div className=\"mt-4 p-3 bg-gray-50 rounded border\">\n                  <p className=\"text-sm text-gray-600\">\n                    <strong>Checklist Preview:</strong> {formData.checklistTemplate.steps.length} step(s) configured\n                  </p>\n                  {formData.checklistTemplate.steps.map((step, index) => (\n                    <div key={step.id} className=\"text-xs text-gray-500 mt-1\">\n                      {index + 1}. {step.type} - {step.config?.inventoryItemName || step.config?.text || step.label || 'Untitled step'}\n                    </div>\n                  ))}\n                </div>\n              )}\n            </TabsContent>\n          </Tabs>\n\n          <div className=\"flex justify-end gap-2 mt-6\">\n            <Button type=\"button\" variant=\"outline\" onClick={handleCancel} disabled={isSaving}>\n              Cancel\n            </Button>\n            <Button \n              type=\"submit\" \n              className=\"bg-[#2D8028] hover:bg-[#203B17]\"\n              disabled={isSaving || (!hasChanges && task)}\n            >\n              {isSaving ? 'Saving...' : (task ? 'Update Task' : 'Create Task')}\n            </Button>\n            {hasChanges && (\n              <span className=\"ml-2 text-orange-600 text-sm\">\n                ‚Ä¢ Unsaved changes\n              </span>\n            )}\n          </div>\n        </form>\n      </DialogContent>\n      \n      {/* Update Propagation Warning Dialog */}\n      <UpdatePropagationWarningDialog\n        isOpen={showWarningDialog}\n        onClose={handleWarningCancel}\n        onConfirm={handleWarningConfirm}\n        changedFields={changedFields}\n        affectedInstanceCount={affectedInstanceCount}\n        conflictCount={0} // TODO: Calculate conflicts from backend\n        taskTitle={formData.title || 'Untitled Task'}\n        isProcessing={isProcessingUpdate}\n        processingProgress={processingProgress}\n      />\n    </Dialog>\n  );\n};\n\nexport default RecurringTaskModal;","path":null,"size_bytes":31571,"size_tokens":null},"client/src/pages/Account.tsx":{"content":"import React from \"react\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { getStoredAuth } from \"@/lib/auth\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Task } from \"@shared/schema\";\n\nconst Account: React.FC = () => {\n  const auth = getStoredAuth();\n  \n  const { data: tasks = [] } = useQuery<Task[]>({\n    queryKey: [\"/api/tasks\"],\n    enabled: auth.isAuthenticated,\n  });\n\n  // Calculate real stats from tasks\n  const userTasks = tasks.filter(task => task.assignedTo === auth.user?.id);\n  const completedTasks = userTasks.filter(t => t.status === 'completed');\n  const activeTasks = userTasks.filter(t => t.status === 'in_progress' || t.status === 'paused');\n  \n  const thisWeekCompleted = completedTasks.filter(t => {\n    if (!t.completedAt) return false;\n    const completedDate = new Date(t.completedAt);\n    const weekAgo = new Date();\n    weekAgo.setDate(weekAgo.getDate() - 7);\n    return completedDate > weekAgo;\n  }).length;\n\n  const onTimeCompletionRate = completedTasks.length > 0 \n    ? Math.round((completedTasks.filter(t => {\n        if (!t.completedAt || !t.dueDate) return true;\n        return new Date(t.completedAt) <= new Date(t.dueDate);\n      }).length / completedTasks.length) * 100)\n    : 100;\n\n  // Get recent tasks (last 5 completed or modified tasks)\n  const recentTasks = userTasks\n    .filter(t => t.completedAt || t.startedAt)\n    .sort((a, b) => {\n      const aDate = new Date(a.completedAt || a.startedAt || 0);\n      const bDate = new Date(b.completedAt || b.startedAt || 0);\n      return bDate.getTime() - aDate.getTime();\n    })\n    .slice(0, 5);\n\n  const formatRelativeTime = (date: string) => {\n    const now = new Date();\n    const taskDate = new Date(date);\n    const diffInHours = Math.floor((now.getTime() - taskDate.getTime()) / (1000 * 60 * 60));\n    \n    if (diffInHours < 1) return \"Just now\";\n    if (diffInHours < 24) return `${diffInHours} hours ago`;\n    if (diffInHours < 48) return \"Yesterday\";\n    return `${Math.floor(diffInHours / 24)} days ago`;\n  };\n\n  const getTaskIcon = (status: string) => {\n    switch (status) {\n      case 'completed': return '‚úÖ';\n      case 'in_progress': return 'üîÑ';\n      case 'paused': return '‚è∏Ô∏è';\n      case 'skipped': return '‚è≠Ô∏è';\n      default: return 'üìã';\n    }\n  };\n\n  const getRoleTrainingData = (role: string) => {\n    switch (role) {\n      case 'manager':\n        return {\n          badges: ['Manager', 'Harvest Tech', 'Seeding Tech'],\n          completedCourses: 4,\n          totalCourses: 5,\n          progressPercent: 80\n        };\n      case 'technician':\n        return {\n          badges: ['Farm Technician', 'Safety Certified'],\n          completedCourses: 3,\n          totalCourses: 4,\n          progressPercent: 75\n        };\n      default:\n        return {\n          badges: ['General Staff'],\n          completedCourses: 2,\n          totalCourses: 3,\n          progressPercent: 67\n        };\n    }\n  };\n\n  const trainingData = getRoleTrainingData(auth.user?.role || '');\n\n  const getAssignedLocation = (user: any) => {\n    // Corporate users see \"Grow Space Vertical Farms\"\n    if (user?.role === 'corporate') {\n      return 'Grow Space Vertical Farms';\n    }\n    \n    // All other users see their actual location\n    return user?.location || 'Kenosha';\n  };\n\n  const getStaffId = (user: any) => {\n    if (!user) return 'N/A';\n    \n    // Get location code\n    let locationCode = 'K'; // Default to Kenosha\n    if (user.role === 'corporate') {\n      locationCode = 'C';\n    } else if (user.location === 'Racine') {\n      locationCode = 'R';\n    } else if (user.location === 'Lake Geneva') {\n      locationCode = 'LG';\n    }\n    \n    return `${locationCode}${String(user.id).padStart(3, '0')}`;\n  };\n\n  return (\n    <div className=\"space-y-6 max-w-6xl mx-auto\" style={{ paddingTop: '40px' }}>\n      <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\n        {/* Personal Information */}\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <span>üë§</span>\n              Personal Information\n            </CardTitle>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            <div>\n              <label className=\"text-sm font-medium text-gray-500 uppercase tracking-wide\">Full Name</label>\n              <p className=\"text-lg text-[#203B17] font-medium\">{auth.user?.name}</p>\n            </div>\n            <div>\n              <label className=\"text-sm font-medium text-gray-500 uppercase tracking-wide\">Email</label>\n              <p className=\"text-lg text-[#203B17] font-medium\">{auth.user?.username}@growspace.farm</p>\n            </div>\n            <div>\n              <label className=\"text-sm font-medium text-gray-500 uppercase tracking-wide\">Staff ID</label>\n              <p className=\"text-lg text-[#203B17] font-medium\">{getStaffId(auth.user)}</p>\n            </div>\n          </CardContent>\n        </Card>\n\n        {/* Work Information */}\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <span>üè¢</span>\n              Work Information\n            </CardTitle>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            <div>\n              <label className=\"text-sm font-medium text-gray-500 uppercase tracking-wide\">Current Role</label>\n              <p className=\"text-lg text-[#203B17] font-medium capitalize\">{auth.user?.role}</p>\n            </div>\n            <div>\n              <label className=\"text-sm font-medium text-gray-500 uppercase tracking-wide\">Assigned Location</label>\n              <p className=\"text-lg text-[#203B17] font-medium\">{getAssignedLocation(auth.user)}</p>\n            </div>\n            <div>\n              <label className=\"text-sm font-medium text-gray-500 uppercase tracking-wide\">Trained Roles</label>\n              <div className=\"flex flex-wrap gap-2 mt-2\">\n                {trainingData.badges.map((badge, index) => (\n                  <span key={index} className=\"px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm\">\n                    {badge}\n                  </span>\n                ))}\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        {/* Training Status */}\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <span>üéì</span>\n              Training Status\n            </CardTitle>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            <div>\n              <label className=\"text-sm font-medium text-gray-500 uppercase tracking-wide\">Progress</label>\n              <div className=\"mt-2\">\n                <div className=\"w-full bg-gray-200 rounded-full h-2\">\n                  <div \n                    className=\"bg-[#2D8028] h-2 rounded-full transition-all duration-300\"\n                    style={{ width: `${trainingData.progressPercent}%` }}\n                  ></div>\n                </div>\n                <p className=\"text-sm text-gray-600 mt-1\">\n                  {trainingData.completedCourses} of {trainingData.totalCourses} required courses completed\n                </p>\n              </div>\n            </div>\n            <div>\n              <label className=\"text-sm font-medium text-gray-500 uppercase tracking-wide\">Completion Rate</label>\n              <p className=\"text-lg text-[#203B17] font-medium\">{trainingData.progressPercent}%</p>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Task Summary */}\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <span>üìä</span>\n            Task Summary\n          </CardTitle>\n        </CardHeader>\n        <CardContent>\n          <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4\">\n            <div className=\"bg-gray-50 p-4 rounded-lg text-center\">\n              <div className=\"text-2xl font-bold text-[#203B17]\">{thisWeekCompleted}</div>\n              <div className=\"text-sm text-gray-600\">Tasks Completed This Week</div>\n            </div>\n            <div className=\"bg-gray-50 p-4 rounded-lg text-center\">\n              <div className=\"text-2xl font-bold text-[#203B17]\">{completedTasks.length}</div>\n              <div className=\"text-sm text-gray-600\">Total Tasks Completed</div>\n            </div>\n            <div className=\"bg-gray-50 p-4 rounded-lg text-center\">\n              <div className=\"text-2xl font-bold text-[#203B17]\">{onTimeCompletionRate}%</div>\n              <div className=\"text-sm text-gray-600\">On-Time Completion Rate</div>\n            </div>\n            <div className=\"bg-gray-50 p-4 rounded-lg text-center\">\n              <div className=\"text-2xl font-bold text-[#203B17]\">{activeTasks.length}</div>\n              <div className=\"text-sm text-gray-600\">Active Tasks</div>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Recent Activity */}\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <span>üïí</span>\n            Recent Activity\n          </CardTitle>\n        </CardHeader>\n        <CardContent>\n          <div className=\"space-y-3\">\n            {recentTasks.length > 0 ? (\n              recentTasks.map((task, index) => (\n                <div key={index} className=\"flex items-center gap-3 p-3 bg-gray-50 rounded-lg\">\n                  <span className=\"text-lg\">{getTaskIcon(task.status)}</span>\n                  <div className=\"flex-1\">\n                    <span className=\"font-medium text-[#203B17]\">{task.title}</span>\n                    <div className=\"text-sm text-gray-600 capitalize\">{task.type.replace('-', ' ')}</div>\n                  </div>\n                  <span className=\"text-sm text-gray-500\">\n                    {formatRelativeTime(task.completedAt || task.startedAt || '')}\n                  </span>\n                </div>\n              ))\n            ) : (\n              <div className=\"text-center py-8 text-gray-500\">\n                <p>No recent activity</p>\n                <p className=\"text-sm\">Complete some tasks to see your activity here</p>\n              </div>\n            )}\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n};\n\nexport default Account;","path":null,"size_bytes":10343,"size_tokens":null},"client/src/components/ErrorBoundary.tsx":{"content":"import React from 'react';\n\ninterface ErrorBoundaryState {\n  hasError: boolean;\n  error?: Error;\n}\n\nclass ErrorBoundary extends React.Component<\n  { children: React.ReactNode },\n  ErrorBoundaryState\n> {\n  constructor(props: { children: React.ReactNode }) {\n    super(props);\n    this.state = { hasError: false };\n  }\n\n  static getDerivedStateFromError(error: Error): ErrorBoundaryState {\n    return { hasError: true, error };\n  }\n\n  componentDidCatch(error: Error, errorInfo: React.ErrorInfo) {\n    console.error('ErrorBoundary caught an error:', error, errorInfo);\n  }\n\n  render() {\n    if (this.state.hasError) {\n      return (\n        <div className=\"min-h-screen flex items-center justify-center bg-gray-50\">\n          <div className=\"max-w-md mx-auto text-center p-8\">\n            <div className=\"text-6xl mb-4\">üöß</div>\n            <h2 className=\"text-2xl font-bold text-gray-900 mb-4\">\n              Something went wrong\n            </h2>\n            <p className=\"text-gray-600 mb-6\">\n              We're sorry, but something unexpected happened. Please refresh the page or contact Matt if the problem persists.\n            </p>\n            <div className=\"space-y-3\">\n              <button\n                onClick={() => window.location.reload()}\n                className=\"w-full bg-[#2D8028] text-white px-4 py-2 rounded-lg font-medium hover:bg-[#203B17] transition-colors\"\n              >\n                Refresh Page\n              </button>\n              <button\n                onClick={() => this.setState({ hasError: false })}\n                className=\"w-full bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-medium hover:bg-gray-300 transition-colors\"\n              >\n                Try Again\n              </button>\n            </div>\n            {process.env.NODE_ENV === 'development' && this.state.error && (\n              <details className=\"mt-6 text-left\">\n                <summary className=\"cursor-pointer text-sm text-gray-500\">\n                  Error Details (Development)\n                </summary>\n                <pre className=\"mt-2 text-xs bg-gray-100 p-2 rounded overflow-auto max-h-32\">\n                  {this.state.error.stack}\n                </pre>\n              </details>\n            )}\n          </div>\n        </div>\n      );\n    }\n\n    return this.props.children;\n  }\n}\n\nexport default ErrorBoundary;","path":null,"size_bytes":2352,"size_tokens":null},"client/src/components/ui/tooltip.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as TooltipPrimitive from \"@radix-ui/react-tooltip\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst TooltipProvider = TooltipPrimitive.Provider\n\nconst Tooltip = TooltipPrimitive.Root\n\nconst TooltipTrigger = TooltipPrimitive.Trigger\n\nconst TooltipContent = React.forwardRef<\n  React.ElementRef<typeof TooltipPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof TooltipPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <TooltipPrimitive.Content\n    ref={ref}\n    sideOffset={sideOffset}\n    className={cn(\n      \"z-50 overflow-hidden rounded-md border bg-popover px-3 py-1.5 text-sm text-popover-foreground shadow-md animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-tooltip-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nTooltipContent.displayName = TooltipPrimitive.Content.displayName\n\nexport { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider }\n","path":null,"size_bytes":1209,"size_tokens":null},"client/src/App-backup.tsx":{"content":"// Backup of current broken App.tsx - will restore working version","path":null,"size_bytes":66,"size_tokens":null},"client/src/utils/dataCleanup.ts":{"content":"import React from 'react';\n\n// Production launch - data cleanup utilities retained for maintenance\n\nexport const clearAllTestData = () => {\n  const confirmClear = confirm(\n    'This will clear ALL test data including tasks, inventory, courses, and staff records. ' +\n    'This action cannot be undone. Are you sure you want to proceed?'\n  );\n  \n  if (!confirmClear) return false;\n  \n  // Clear all localStorage data\n  const keysToRemove = [\n    'tasks',\n    'taskHistory', \n    'completedTasks',\n    'recurringTasks',\n    'inventory',\n    'inventoryItems',\n    'courses',\n    'courseProgress',\n    'userCourses',\n    'staffData',\n    'hasVisitedBeta'\n  ];\n  \n  keysToRemove.forEach(key => {\n    localStorage.removeItem(key);\n  });\n  \n  // Clear all application state\n  console.log('All test data cleared successfully');\n  alert('All test data has been cleared. The page will now refresh to initialize clean state.');\n  \n  // Refresh to initialize clean state\n  window.location.reload();\n  \n  return true;\n};\n\nexport const initializeCleanState = () => {\n  // Check if this is first run after cleanup\n  const isCleanInstall = !localStorage.getItem('appInitialized');\n  \n  if (isCleanInstall) {\n    // Set up clean initial state\n    localStorage.setItem('appInitialized', 'true');\n    \n    // Initialize empty data structures\n    const emptyData = JSON.stringify([]);\n    localStorage.setItem('tasks', emptyData);\n    localStorage.setItem('inventory', emptyData);\n    localStorage.setItem('courses', emptyData);\n    localStorage.setItem('recurringTasks', emptyData);\n    \n    console.log('Clean application state initialized');\n  }\n};\n\n// Admin-only data reset component\nexport const AdminResetButton: React.FC<{ currentUser: any }> = ({ currentUser }) => {\n  // Only show for Corporate users\n  if (!currentUser || currentUser.role !== 'corporate') {\n    return null;\n  }\n  \n  const handleReset = () => {\n    clearAllTestData();\n  };\n  \n  return React.createElement(\n    'button',\n    {\n      onClick: handleReset,\n      className: \"fixed bottom-4 right-4 opacity-30 hover:opacity-100 transition-opacity bg-red-600 text-white px-3 py-2 rounded text-xs\",\n      title: \"Admin: Clear All Data\"\n    },\n    'Reset Data'\n  );\n};","path":null,"size_bytes":2219,"size_tokens":null},"client/src/components/ui/checkbox.tsx":{"content":"import * as React from \"react\"\nimport * as CheckboxPrimitive from \"@radix-ui/react-checkbox\"\nimport { Check } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Checkbox = React.forwardRef<\n  React.ElementRef<typeof CheckboxPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof CheckboxPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <CheckboxPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"peer h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground\",\n      className\n    )}\n    {...props}\n  >\n    <CheckboxPrimitive.Indicator\n      className={cn(\"flex items-center justify-center text-current\")}\n    >\n      <Check className=\"h-4 w-4\" />\n    </CheckboxPrimitive.Indicator>\n  </CheckboxPrimitive.Root>\n))\nCheckbox.displayName = CheckboxPrimitive.Root.displayName\n\nexport { Checkbox }\n","path":null,"size_bytes":1056,"size_tokens":null},"attached_assets/content-1766171254453.md":{"content":"# üå± Grow Space\n\nFarm Management System\n\nDevelopment Login\n\nChoose a user to log in as, or enter an email manually\n\n#### Quick Login\n\nRobert Carlson\n\nrobert@growspace.farm - Corporate Manager\n\nSimone Birriel\n\nSimone@growspace.farm - Staff\n\n#### Custom Email\n\nLogin\n\nThis is a development-only login bypass. In production, Microsoft authentication would be required.\n\nOr\n\n### Microsoft Authentication\n\n# üå± Grow Space\n\n## Task Management System\n\nSign in with your Grow Space Microsoft account\n\nSign in with Microsoft\n\nüîí Secure login through Microsoft Azure AD","path":null,"size_bytes":565,"size_tokens":null}},"version":2}